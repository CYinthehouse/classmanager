<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Scheduler | KoreanLearnin</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans', sans-serif; 
            background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/sky.png?v=1750990355') repeat;
            background-size: auto;
            min-height: 100vh; 
            padding: 20px; 
            color: #fff; 
            font-size: 13px; 
        }
        
        /* Light/Dark Mode Toggle */
        /* From Uiverse.io by andrew-demchenk0 */
        .switch {
            font-size: 17px;
            position: relative;
            display: inline-block;
            width: 64px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #73C0FC;
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            border-radius: 20px;
            left: 2px;
            bottom: 2px;
            z-index: 2;
            background-color: #e8e8e8;
            transition: .4s;
        }
        .sun svg {
            position: absolute;
            top: 6px;
            left: 36px;
            z-index: 1;
            width: 24px;
            height: 24px;
        }
        .moon svg {
            fill: #73C0FC;
            position: absolute;
            top: 5px;
            left: 5px;
            z-index: 1;
            width: 24px;
            height: 24px;
        }
        .sun svg {
            animation: rotate 15s linear infinite;
        }
        @keyframes rotate {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }
        .moon svg {
            animation: tilt 5s linear infinite;
        }
        @keyframes tilt {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }
        .switch input:checked + .slider {
            background-color: #183153;
        }
        .switch input:focus + .slider {
            box-shadow: 0 0 1px #183153;
        }
        .switch input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        /* Light mode styles */
        body.light-mode {
            background: #5dd0ff;
        }
        body.light-mode .header {
            background: linear-gradient(135deg, #4a90c2 0%, #3a7ab0 100%);
            border-color: #2a6090;
        }
        body.light-mode .nav-tabs {
            background: rgba(255,255,255,0.3);
            border-color: #4a90c2;
        }
        body.light-mode .nav-tab {
            background: rgba(255,255,255,0.5);
            color: #2a6090;
            border-color: #4a90c2;
        }
        body.light-mode .nav-tab:hover {
            background: rgba(255,255,255,0.7);
        }
        body.light-mode .nav-tab.active {
            background: #4a90c2;
            color: #fff;
        }
        body.light-mode .card {
            background: rgba(255,255,255,0.9);
            border-color: #4a90c2;
            color: #1a1a2e;
        }
        body.light-mode .card h3 {
            color: #2a6090;
            border-bottom-color: #4a90c2;
        }
        body.light-mode .stat-card {
            background: linear-gradient(135deg, rgba(74,144,194,0.3), rgba(58,122,176,0.3));
            color: #1a1a2e;
        }
        body.light-mode input,
        body.light-mode select,
        body.light-mode textarea {
            background: rgba(255,255,255,0.9);
            color: #1a1a2e;
            border-color: #4a90c2;
        }
        body.light-mode label {
            color: #2a6090;
        }
        body.light-mode th {
            background: rgba(74,144,194,0.5);
            color: #1a1a2e;
        }
        body.light-mode td {
            color: #1a1a2e;
        }
        body.light-mode tr:hover {
            background: rgba(74,144,194,0.1);
        }
        body.light-mode .class-card {
            background: rgba(255,255,255,0.8);
            color: #1a1a2e;
        }
        body.light-mode .teacher-card {
            background: rgba(255,255,255,0.8);
            color: #1a1a2e;
        }
        body.light-mode #loginSection {
            background: rgba(255,255,255,0.95);
            border-color: #4a90c2;
        }
        body.light-mode #loginSection h2 {
            color: #2a6090;
        }
        body.light-mode .role-tab {
            background: rgba(74,144,194,0.2);
            color: #2a6090;
            border-color: #4a90c2;
        }
        body.light-mode .role-tab.active {
            background: #4a90c2;
            color: #fff;
        }
        body.light-mode .modal {
            background: #f0f8ff;
            border-color: #4a90c2;
        }
        body.light-mode .modal-title {
            color: #2a6090;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .header { margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 10px; border: 3px solid #00ffff; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 0 20px rgba(0,255,255,0.3); }
        .header h1 { font-size: 20px; color: #00ffff; text-shadow: 0 0 10px #00ffff; }
        .user-info { font-size: 12px; color: #39ff14; }
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; border: 2px solid #ff00ff; }
        .nav-tab { padding: 12px 18px; background: rgba(255,0,255,0.2); color: #ff00ff; border: 2px solid #ff00ff; border-radius: 5px; cursor: pointer; font-family: 'Noto Sans', sans-serif; font-size: 12px; transition: all 0.3s; }
        .nav-tab:hover { background: rgba(255,0,255,0.4); box-shadow: 0 0 15px rgba(255,0,255,0.5); }
        .nav-tab.active { background: #ff00ff; color: #000; box-shadow: 0 0 20px #ff00ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .card { background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; border: 3px solid #00ffff; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,255,255,0.2); }
        .card h3 { font-size: 12px; margin-bottom: 15px; color: #00ffff; border-bottom: 2px solid #00ffff; padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, rgba(255,0,255,0.3), rgba(0,255,255,0.3)); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #fff; }
        .stat-card.green { border-color: #39ff14; }
        .stat-card.cyan { border-color: #00ffff; }
        .stat-card.pink { border-color: #ff00ff; }
        .stat-card.yellow { border-color: #ffff00; }
        .stat-card.orange { border-color: #ff6600; }
        .stat-number { font-size: 24px; margin-bottom: 10px; }
        .stat-label { font-size: 11px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #ffff00; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ff00ff; border-radius: 5px; font-family: 'Noto Sans', sans-serif; font-size: 14px; background: rgba(0,0,0,0.5); color: #fff; }
        input:focus, select:focus { outline: none; border-color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.3); }
        select option { background: #1a1a2e; }
        .btn { padding: 12px 20px; border: 2px solid; border-radius: 5px; cursor: pointer; font-family: 'Noto Sans', sans-serif; font-size: 12px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, #ff00ff, #cc00cc); color: #fff; border-color: #ff00ff; }
        .btn-success { background: linear-gradient(135deg, #39ff14, #2ecc40); color: #000; border-color: #39ff14; }
        .btn-info { background: linear-gradient(135deg, #00ffff, #00cccc); color: #000; border-color: #00ffff; }
        .btn-warning { background: linear-gradient(135deg, #ffff00, #cccc00); color: #000; border-color: #ffff00; }
        .btn-danger { background: linear-gradient(135deg, #ff3366, #cc0033); color: #fff; border-color: #ff3366; }
        .btn-sm { padding: 6px 12px; font-size: 11px; }
        .btn-block { width: 100%; }
        .completed-filter-btn { background: transparent; border: 1px solid #444; color: #888; transition: all 0.2s; }
        .completed-filter-btn:hover { border-color: #00ffff; color: #00ffff; }
        .completed-filter-btn.active { background: rgba(0,255,255,0.2); border-color: #00ffff; color: #00ffff; }
        .admin-completed-filter-btn { background: transparent; border: 1px solid #444; color: #888; transition: all 0.2s; }
        .admin-completed-filter-btn:hover { border-color: #ff00ff; color: #ff00ff; }
        .admin-completed-filter-btn.active { background: rgba(255,0,255,0.2); border-color: #ff00ff; color: #ff00ff; }
        .admin-teacher-view-tab { background: transparent; border: 1px solid #444; color: #888; transition: all 0.2s; }
        .admin-teacher-view-tab:hover { border-color: #00ffff; color: #00ffff; }
        .admin-teacher-view-tab.active { background: rgba(0,255,255,0.2); border-color: #00ffff; color: #00ffff; }
        .teacher-select-btn { background: transparent; border: 2px solid #39ff14; color: #39ff14; padding: 8px 15px; cursor: pointer; transition: all 0.2s; }
        .teacher-select-btn:hover { background: rgba(57,255,20,0.2); }
        .teacher-select-btn.active { background: #39ff14; color: #000; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 10px; text-align: left; border: 1px solid #333; }
        th { background: rgba(255,0,255,0.3); color: #ff00ff; }
        tr:hover { background: rgba(0,255,255,0.1); }
        .level-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 2px solid; }
        .level-absolute { border-color: #ff00ff; color: #ff00ff; background: rgba(255,0,255,0.2); }
        .level-novice { border-color: #00ffff; color: #00ffff; background: rgba(0,255,255,0.2); }
        .level-beginner { border-color: #39ff14; color: #39ff14; background: rgba(57,255,20,0.2); }
        .level-advanced { border-color: #ffff00; color: #ffff00; background: rgba(255,255,0,0.2); }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .status-pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .status-assigned { background: rgba(57,255,20,0.2); color: #39ff14; }
        .status-limbo { background: rgba(255,51,102,0.2); color: #ff3366; }
        .status-proposed { background: rgba(0,255,255,0.2); color: #00ffff; }
        .availability-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .day-column { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; padding: 15px; }
        .day-title { text-align: center; color: #39ff14; font-size: 14px; margin-bottom: 15px; }
        .time-slot { background: rgba(255,255,255,0.05); border: 2px solid #444; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; text-align: center; font-size: 12px; position: relative; }
        .time-slot:hover { border-color: #00ffff; }
        .time-slot.selected-1 { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .time-slot.selected-2 { border-color: #ffff00; background: rgba(255,255,0,0.2); }
        .time-slot.selected-3 { border-color: #ff6600; background: rgba(255,102,0,0.2); }
        .rank-badge { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #000; }
        .time-slot.selected-1 .rank-badge { background: #39ff14; }
        .time-slot.selected-2 .rank-badge { background: #ffff00; }
        .time-slot.selected-3 .rank-badge { background: #ff6600; }
        .local-time { font-size: 11px; color: #888; margin-top: 5px; }
        .selection-legend { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .legend-color { width: 20px; height: 20px; border: 2px solid; border-radius: 4px; }
        .legend-color.ideal { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .legend-color.second { border-color: #ffff00; background: rgba(255,255,0,0.2); }
        .legend-color.doable { border-color: #ff6600; background: rgba(255,102,0,0.2); }
        .class-card { background: rgba(0,0,0,0.5); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .class-card.today-class { border-color: #39ff14; box-shadow: 0 0 15px rgba(57,255,20,0.3); }
        .class-card.completed-class { border-color: #888; opacity: 0.8; }
        .class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .class-time { color: #39ff14; font-size: 14px; }
        .class-day { color: #ffff00; font-size: 12px; }
        .class-week-tracker { display: flex; gap: 4px; margin: 15px 0; flex-wrap: wrap; }
        .class-week-box { flex: 1; min-width: 80px; padding: 8px 5px; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 5px; text-align: center; font-size: 10px; color: #555; }
        .class-week-box.completed { border-color: #39ff14; color: #39ff14; background: rgba(57,255,20,0.1); }
        .class-week-box.completed::before { content: 'âœ“ '; }
        .class-week-box.current { border-color: #ffff00; color: #ffff00; background: rgba(255,255,0,0.15); box-shadow: 0 0 8px rgba(255,255,0,0.3); }
        .class-week-box.future { border-color: #333; color: #444; }
        .class-week-box .week-label { font-weight: bold; font-size: 11px; display: block; margin-bottom: 3px; }
        .class-week-box .week-dates { font-size: 9px; color: inherit; opacity: 0.8; }
        .academy-status { display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 4px; font-size: 10px; }
        .academy-status.yes { background: rgba(57,255,20,0.2); border: 1px solid #39ff14; color: #39ff14; }
        .academy-status.no { background: rgba(255,51,102,0.2); border: 1px solid #ff3366; color: #ff3366; }
        .academy-status.pending { background: rgba(255,255,0,0.2); border: 1px solid #ffff00; color: #ffff00; }
        .student-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .student-chip { background: rgba(255,0,255,0.2); border: 1px solid #ff00ff; padding: 5px 10px; border-radius: 15px; font-size: 11px; display: flex; align-items: center; gap: 5px; }
        .rank-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .rank-dot.rank-1 { background: #39ff14; }
        .rank-dot.rank-2 { background: #ffff00; }
        .rank-dot.rank-3 { background: #ff6600; }
        .limbo-section { background: rgba(255,51,102,0.1); border: 2px dashed #ff3366; border-radius: 8px; padding: 20px; min-height: 100px; }
        .limbo-student { background: rgba(0,0,0,0.5); border: 2px solid #ff3366; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: grab; }
        .drop-zone { border: 2px dashed #00ffff; border-radius: 8px; padding: 15px; text-align: center; margin-top: 10px; opacity: 0; transition: opacity 0.2s; font-size: 12px; color: #00ffff; }
        .drop-zone.active { opacity: 1; background: rgba(0,255,255,0.1); }
        .week-tracker { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .week-btn { padding: 10px 15px; background: rgba(0,0,0,0.3); border: 2px solid #444; border-radius: 5px; color: #888; font-family: 'Noto Sans', sans-serif; font-size: 12px; cursor: pointer; }
        .week-btn.current { border-color: #39ff14; color: #39ff14; box-shadow: 0 0 10px rgba(57,255,20,0.3); }
        .week-btn.completed { border-color: #ff00ff; color: #ff00ff; }
        .attendance-btn { padding: 8px 12px; border: 2px solid; border-radius: 5px; background: transparent; font-family: 'Noto Sans', sans-serif; font-size: 11px; cursor: pointer; }
        .attendance-btn.present { border-color: #39ff14; color: #39ff14; }
        .attendance-btn.present.active { background: #39ff14; color: #000; }
        .attendance-btn.late { border-color: #ffff00; color: #ffff00; }
        .attendance-btn.late.active { background: #ffff00; color: #000; }
        .attendance-btn.absent { border-color: #ff3366; color: #ff3366; }
        .attendance-btn.absent.active { background: #ff3366; color: #fff; }
        .teacher-card { background: rgba(0,0,0,0.5); border: 2px solid #39ff14; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .teacher-name { color: #39ff14; font-size: 14px; margin-bottom: 8px; }
        .teacher-classes { font-size: 11px; color: #888; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; border: 3px solid #ff00ff; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #ff3366; font-size: 20px; cursor: pointer; font-family: 'Noto Sans', sans-serif; }
        .modal-title { color: #00ffff; font-size: 12px; margin-bottom: 20px; }
        #loginSection { max-width: 450px; margin: 50px auto; background: rgba(0,0,0,0.8); padding: 30px; border-radius: 10px; border: 3px solid #ff00ff; }
        #loginSection h2 { font-size: 14px; margin-bottom: 25px; color: #00ffff; text-align: center; }
        #mainPanel { display: none; }
        .role-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .role-tab { flex: 1; padding: 15px; background: rgba(255,0,255,0.2); border: 2px solid #ff00ff; border-radius: 5px; color: #ff00ff; font-family: 'Noto Sans', sans-serif; font-size: 12px; cursor: pointer; text-align: center; }
        .role-tab.active { background: #ff00ff; color: #000; }
        .message { padding: 12px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; }
        .message.success { background: rgba(57,255,20,0.2); border: 2px solid #39ff14; color: #39ff14; }
        .message.error { background: rgba(255,51,102,0.2); border: 2px solid #ff3366; color: #ff3366; }
        .success-screen { text-align: center; padding: 40px; }
        .success-icon { font-size: 60px; margin-bottom: 20px; }
        .assign-btn { padding: 6px 10px; background: transparent; border: 2px solid #39ff14; border-radius: 4px; color: #39ff14; font-family: 'Noto Sans', sans-serif; font-size: 11px; cursor: pointer; }
        .assign-btn:hover { background: #39ff14; color: #000; }
        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; }
        .checkbox-label input { width: 18px; height: 18px; }
        .settings-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .settings-label { color: #ffff00; font-size: 12px; min-width: 180px; }
        .settings-input { width: 100px; text-align: center; }
        .material-block { background: rgba(0,0,0,0.3); border: 2px solid #444; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: grab; transition: all 0.2s; }
        .material-block:hover { border-color: #666; }
        .material-block.dragging { opacity: 0.5; }
        .material-block .drag-handle { font-size: 14px; color: #555; }
        .material-block:hover .drag-handle { color: #00ffff; }
        .material-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .material-type { font-size: 11px; color: #ff00ff; text-transform: uppercase; }
        .material-content { font-size: 13px; line-height: 1.6; }
        .material-content img { max-width: 100%; border-radius: 5px; }
        .material-content a { color: #00ffff; }
        .history-present { color: #39ff14; }
        .history-late { color: #ffff00; }
        .history-absent { color: #ff3366; }
        
        /* Rich Text Editor Styles */
        .rich-text-toolbar { display: flex; flex-wrap: wrap; gap: 5px; padding: 8px; background: #1a1a2e; border: 2px solid #333; border-bottom: none; border-radius: 8px 8px 0 0; }
        .rich-text-toolbar button { background: #333; border: 1px solid #555; color: #fff; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: 'Noto Sans', sans-serif; min-width: 32px; }
        .rich-text-toolbar button:hover { background: #444; border-color: #00ffff; }
        .rich-text-toolbar button.active { background: #00ffff; color: #000; }
        .rich-text-toolbar input[type="color"] { width: 32px; height: 28px; border: 1px solid #555; border-radius: 4px; cursor: pointer; background: #333; padding: 2px; }
        .rich-text-toolbar .toolbar-divider { width: 1px; background: #555; margin: 0 5px; }
        .rich-text-editor { min-height: 200px; padding: 15px; background: #0a0a15; border: 2px solid #333; border-radius: 0 0 8px 8px; color: #fff; font-family: 'Noto Sans', sans-serif; font-size: 14px; line-height: 1.8; outline: none; overflow-y: auto; }
        .rich-text-editor:focus { border-color: #00ffff; }
        .rich-text-editor ul, .rich-text-editor ol { margin: 10px 0; padding-left: 25px; }
        .rich-text-editor li { margin: 5px 0; }
        
        /* Presentation Mode Styles */
        .presentation-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 10000; display: flex; flex-direction: column; }
        .presentation-toolbar { display: flex; gap: 10px; padding: 10px 20px; background: #1a1a2e; border-bottom: 2px solid #333; align-items: center; flex-wrap: wrap; justify-content: center; }
        .presentation-toolbar button { background: #333; border: 2px solid #555; color: #fff; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: 'Noto Sans', sans-serif; transition: all 0.2s; }
        .presentation-toolbar button:hover { border-color: #00ffff; background: #444; }
        .presentation-toolbar button.active { background: #00ffff; color: #000; border-color: #00ffff; }
        .presentation-toolbar .tool-group { display: flex; gap: 5px; padding: 0 10px; border-right: 1px solid #555; align-items: center; }
        .presentation-toolbar .tool-group:last-child { border-right: none; }
        .presentation-toolbar input[type="range"] { width: 100px; cursor: pointer; }
        .presentation-toolbar input[type="color"] { width: 35px; height: 35px; border: 2px solid #555; border-radius: 4px; cursor: pointer; }
        .presentation-content { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; }
        .presentation-wrapper { position: relative; display: flex; align-items: center; justify-content: center; }
        .presentation-image { display: block; max-width: 95vw; max-height: calc(100vh - 80px); object-fit: contain; user-select: none; -webkit-user-drag: none; }
        .presentation-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; pointer-events: auto; }
        .presentation-close { position: fixed; top: 70px; right: 20px; background: #ff3366; border: none; color: #fff; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-family: 'Noto Sans', sans-serif; font-size: 14px; z-index: 10001; }
        .presentation-close:hover { background: #ff1744; }
        .clickable-media { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .clickable-media:hover { border-color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.5); }
        
        /* Rainbow cursor animation */
        @keyframes rainbow-cursor { 0% { background: #ff0000; } 16% { background: #ff8800; } 33% { background: #ffff00; } 50% { background: #00ff00; } 66% { background: #0088ff; } 83% { background: #8800ff; } 100% { background: #ff0000; } }
        .rainbow-draw { animation: rainbow-cursor 2s linear infinite; }
        
        /* Schedule Calendar Styles */
        .schedule-grid { display: grid; grid-template-columns: 100px repeat(2, 1fr); gap: 2px; background: #333; border: 2px solid #00ffff; border-radius: 8px; overflow: hidden; }
        .schedule-header { background: linear-gradient(135deg, #ff00ff, #cc00cc); color: #fff; padding: 12px 8px; text-align: center; font-size: 13px; font-weight: bold; }
        .schedule-time { background: rgba(0,255,255,0.2); color: #00ffff; padding: 10px 8px; text-align: center; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .schedule-cell { background: rgba(0,0,0,0.6); padding: 8px; min-height: 80px; transition: all 0.2s; position: relative; }
        .schedule-cell:hover { background: rgba(0,255,255,0.1); }
        .schedule-cell.has-class { border-left: 3px solid #39ff14; }
        .schedule-cell.empty { border-left: 3px solid #666; }
        .schedule-cell.needs-teacher { border-left: 3px solid #ffff00; }
        .schedule-cell.full { border-left: 3px solid #ff3366; }
        .schedule-class-block { background: rgba(57,255,20,0.15); border: 1px solid #39ff14; border-radius: 5px; padding: 8px; margin-bottom: 5px; }
        .schedule-class-block.no-teacher { background: rgba(255,255,0,0.15); border-color: #ffff00; }
        .schedule-class-block.full { background: rgba(255,51,102,0.15); border-color: #ff3366; }
        .schedule-class-level { font-size: 11px; color: #ff00ff; margin-bottom: 4px; }
        .schedule-class-info { font-size: 11px; color: #888; }
        .schedule-class-teacher { font-size: 11px; color: #39ff14; margin-top: 4px; }
        .schedule-class-students { font-size: 12px; color: #00ffff; font-weight: bold; }
        .schedule-legend { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .legend-bar { width: 4px; height: 20px; border-radius: 2px; }
        .legend-bar.active { background: #39ff14; }
        .legend-bar.needs-teacher { background: #ffff00; }
        .legend-bar.full { background: #ff3366; }
        .legend-bar.empty { background: #666; }
        .schedule-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .summary-box { background: rgba(0,0,0,0.5); border: 2px solid; border-radius: 8px; padding: 15px; text-align: center; }
        .summary-box.total { border-color: #00ffff; }
        .summary-box.active { border-color: #39ff14; }
        .summary-box.needs-teacher { border-color: #ffff00; }
        .summary-box.full { border-color: #ff3366; }
        .summary-box.empty { border-color: #666; }
        .summary-box.available { border-color: #ff00ff; }
        .summary-number { font-size: 20px; margin-bottom: 5px; }
        .summary-label { font-size: 11px; color: #888; }
        
        /* Class Details Modal Styles */
        .student-detail-row { background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .student-detail-row.absent-student { border-color: #ff3366; background: rgba(255,51,102,0.1); }
        .student-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 10px; }
        .student-detail-name { color: #00ffff; font-size: 14px; }
        .student-detail-info { font-size: 12px; color: #888; margin-bottom: 5px; }
        .student-detail-phone { font-size: 13px; color: #39ff14; margin: 8px 0; padding: 8px; background: rgba(57,255,20,0.1); border-radius: 5px; display: none; }
        .student-detail-phone.visible { display: block; }
        .student-detail-phone a { color: #39ff14; text-decoration: none; }
        .student-detail-attendance { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
        .attendance-week { padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 1px solid #333; }
        .attendance-week.present { background: rgba(57,255,20,0.2); color: #39ff14; border-color: #39ff14; }
        .attendance-week.late { background: rgba(255,255,0,0.2); color: #ffff00; border-color: #ffff00; }
        .attendance-week.absent { background: rgba(255,51,102,0.2); color: #ff3366; border-color: #ff3366; }
        .contacted-row { margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: none; }
        .contacted-row.visible { display: flex; align-items: center; gap: 10px; }
        .contacted-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; }
        .contacted-checkbox input { width: 18px; height: 18px; accent-color: #39ff14; }
        .absence-reason-display { font-size: 12px; color: #ff9900; margin-top: 5px; padding: 5px; background: rgba(255,153,0,0.1); border-radius: 4px; }
        
        /* Absence List Styles */
        .absence-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid; transition: all 0.2s; }
        .absence-item:hover { transform: translateX(5px); }
        .absence-item.contacted { background: rgba(57,255,20,0.1); border-color: #39ff14; }
        .absence-item.not-contacted { background: rgba(255,51,102,0.1); border-color: #ff3366; }
        .absence-item-info { flex: 1; }
        .absence-item-name { color: #00ffff; font-size: 14px; margin-bottom: 5px; }
        .absence-item-details { font-size: 12px; color: #888; }
        .absence-item-class { font-size: 12px; color: #ffff00; margin-top: 3px; }
        .absence-item-reason { font-size: 12px; color: #ff9900; margin-top: 5px; padding: 5px 8px; background: rgba(255,153,0,0.1); border-radius: 4px; display: inline-block; }
        .absence-item-phone { font-size: 13px; margin-top: 5px; }
        .absence-item-phone a { color: #39ff14; text-decoration: none; }
        .absence-item-status { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .absence-status-badge { padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .absence-status-badge.contacted { background: rgba(57,255,20,0.3); color: #39ff14; }
        .absence-status-badge.not-contacted { background: rgba(255,51,102,0.3); color: #ff3366; }
        .absence-week-badge { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px; font-size: 11px; color: #888; }
        
        /* Limbo Student Availability Tags */
        .limbo-availability { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .avail-tag { padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 2px solid; }
        .avail-tag.pref-1 { background: rgba(57,255,20,0.2); border-color: #39ff14; color: #39ff14; }
        .avail-tag.pref-2 { background: rgba(255,255,0,0.2); border-color: #ffff00; color: #ffff00; }
        .avail-tag.pref-3 { background: rgba(255,102,0,0.2); border-color: #ff6600; color: #ff6600; }
        
        /* Clickable schedule cell */
        .schedule-class-block.clickable { cursor: pointer; transition: all 0.2s; }
        .schedule-class-block.clickable:hover { transform: scale(1.02); box-shadow: 0 0 10px rgba(0,255,255,0.3); }
        
        /* Course Calendar Styles */
        .week-date-card { background: rgba(0,0,0,0.4); border: 2px solid #444; border-radius: 8px; padding: 12px; text-align: center; transition: all 0.2s; }
        .week-date-card:hover { border-color: #00ffff; }
        .week-date-card.current { border-color: #39ff14; background: rgba(57,255,20,0.1); }
        .week-date-card.past { opacity: 0.5; }
        .week-date-card.future { border-color: #666; }
        .week-date-number { font-size: 14px; color: #00ffff; margin-bottom: 5px; }
        .week-date-card.current .week-date-number { color: #39ff14; }
        .week-date-range { font-size: 12px; color: #ffff00; margin-bottom: 5px; }
        .week-date-status { font-size: 11px; color: #888; }
        .week-date-card.current .week-date-status { color: #39ff14; }
        .course-dates-summary { background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .course-date-item { text-align: center; }
        .course-date-label { font-size: 11px; color: #888; margin-bottom: 5px; }
        .course-date-value { font-size: 14px; color: #00ffff; }
        .course-date-value.end { color: #ff00ff; }
        
        /* Monthly Calendar */
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-header { background: rgba(0,0,0,0.5); color: #00ffff; padding: 10px 5px; text-align: center; font-size: 12px; }
        .calendar-day { background: rgba(0,0,0,0.3); border: 1px solid #333; min-height: 80px; padding: 5px; position: relative; transition: all 0.2s; }
        .calendar-day:hover { border-color: #00ffff; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.today { border-color: #00ffff; box-shadow: 0 0 10px rgba(0,255,255,0.3); }
        .calendar-day.course-start, .calendar-day.course-end { border-color: #ff00ff; }
        .calendar-day-number { font-size: 14px; color: #fff; margin-bottom: 5px; }
        .calendar-day.today .calendar-day-number { color: #00ffff; font-weight: bold; }
        .calendar-day.has-class { background: rgba(57,255,20,0.1); }
        .calendar-class-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin: 1px; cursor: pointer; }
        .calendar-class-info { font-size: 10px; color: #888; margin-top: 3px; }
        .calendar-week-label { position: absolute; top: 5px; right: 5px; font-size: 10px; color: #666; }
        .calendar-day.has-class { cursor: pointer; }
        .calendar-day.has-class:hover { background: rgba(57,255,20,0.2); }
        
        /* Date Option Buttons */
        .date-option { padding: 12px; border: 2px solid #333; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; background: rgba(0,0,0,0.3); }
        .date-option:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .date-option.selected { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .date-option-day { font-size: 14px; color: #00ffff; margin-bottom: 3px; }
        .date-option-date { font-size: 12px; color: #ffff00; }
        .date-option-end { font-size: 11px; color: #888; margin-top: 5px; }
        
        /* Completed Students */
        .completed-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid; }
        .completed-item.joined { background: rgba(57,255,20,0.1); border-color: #39ff14; }
        .completed-item.not-interested { background: rgba(255,51,102,0.1); border-color: #ff3366; }
        .completed-item.pending { background: rgba(255,255,0,0.1); border-color: #ffff00; }
        .completed-item-info { flex: 1; }
        .completed-item-name { color: #00ffff; font-size: 14px; margin-bottom: 5px; }
        .completed-item-details { font-size: 12px; color: #888; }
        .completed-item-class { font-size: 12px; color: #ffff00; margin-top: 3px; }
        .completed-item-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .community-btn { padding: 8px 12px; border-radius: 5px; font-size: 12px; font-family: 'Noto Sans', sans-serif; cursor: pointer; border: none; transition: all 0.2s; }
        .community-btn.join { background: #39ff14; color: #000; }
        .community-btn.not-interested { background: #ff3366; color: #fff; }
        .community-btn:hover { transform: scale(1.05); }
        .community-status { padding: 5px 10px; border-radius: 5px; font-size: 12px; }
        .community-status.joined { background: rgba(57,255,20,0.3); color: #39ff14; }
        .community-status.not-interested { background: rgba(255,51,102,0.3); color: #ff3366; }
        
        /* Move Student Modal */
        .move-student-class { padding: 10px; margin: 5px 0; border: 2px solid #333; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .move-student-class:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .move-student-class.selected { border-color: #39ff14; background: rgba(57,255,20,0.1); }
        
        /* Calendar Class Picker */
        .calendar-class-option:hover { border-color: #39ff14 !important; background: rgba(57,255,20,0.2) !important; transform: scale(1.02); }
        
        /* Video Recording */
        .recording-section { background: rgba(0,0,0,0.3); border: 2px solid #ff3366; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .recording-section.recording { border-color: #ff0000; animation: pulse-border 1s infinite; }
        @keyframes pulse-border { 0%, 100% { border-color: #ff0000; } 50% { border-color: #ff6666; } }
        .record-btn { padding: 15px 25px; font-size: 14px; border-radius: 50px; cursor: pointer; transition: all 0.2s; font-family: 'Noto Sans', sans-serif; }
        .record-btn.start { background: #ff3366; color: #fff; border: none; }
        .record-btn.start:hover { background: #ff0044; transform: scale(1.05); }
        .record-btn.recording { background: #ff0000; color: #fff; border: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .video-preview { width: 100%; max-width: 400px; border-radius: 8px; background: #000; margin: 10px auto; display: block; }
        .korean-passage { background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 15px; margin: 10px 0; font-size: 12px; line-height: 1.8; color: #fff; }
        
        /* Priority Buttons */
        .priority-btn { padding: 10px 15px; font-size: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-family: 'Noto Sans', sans-serif; background: #1a1a2e; color: #888; border: 2px solid #333; }
        .priority-btn:hover { border-color: #666; }
        .priority-btn.selected { transform: scale(1.05); }
        .priority-btn.selected#priorityHigh { background: rgba(255,0,0,0.2); border-color: #ff0000; color: #ff0000; }
        .priority-btn.selected#priorityMid { background: rgba(255,255,0,0.2); border-color: #ffff00; color: #ffff00; }
        .priority-btn.selected#priorityLow { background: rgba(57,255,20,0.2); border-color: #39ff14; color: #39ff14; }
        
        /* Suggestion Cards */
        .suggestion-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .suggestion-card.priority-high { border-left: 4px solid #ff0000; }
        .suggestion-card.priority-mid { border-left: 4px solid #ffff00; }
        .suggestion-card.priority-low { border-left: 4px solid #39ff14; }
        .suggestion-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .suggestion-title { color: #00ffff; font-size: 14px; flex: 1; }
        .suggestion-priority { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .suggestion-priority.high { background: rgba(255,0,0,0.3); color: #ff0000; }
        .suggestion-priority.mid { background: rgba(255,255,0,0.3); color: #ffff00; }
        .suggestion-priority.low { background: rgba(57,255,20,0.3); color: #39ff14; }
        .suggestion-body { font-size: 12px; color: #ccc; margin-bottom: 10px; line-height: 1.6; }
        .suggestion-meta { font-size: 11px; color: #666; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-status { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .suggestion-status.pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .suggestion-status.approved { background: rgba(57,255,20,0.2); color: #39ff14; }
        .suggestion-status.declined { background: rgba(255,51,102,0.2); color: #ff3366; }
        .suggestion-actions { display: flex; gap: 8px; margin-top: 10px; }
        
        /* Proposals Layout */
        .proposals-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .proposals-left, .proposals-right { min-width: 0; }
        @media (max-width: 1024px) { .proposals-layout { grid-template-columns: 1fr; } }
        
        /* Proposal Card */
        .proposal-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .proposal-card.status-draft { border-left: 4px solid #888; }
        .proposal-card.status-sent { border-left: 4px solid #ffff00; }
        .proposal-card.status-all_agreed { border-left: 4px solid #39ff14; }
        .proposal-card.status-has_rejections { border-left: 4px solid #ff3366; }
        .proposal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .proposal-info { flex: 1; }
        .proposal-day { color: #00ffff; font-size: 12px; }
        .proposal-time { color: #888; font-size: 13px; }
        .proposal-status { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .proposal-status.draft { background: rgba(136,136,136,0.3); color: #888; }
        .proposal-status.sent { background: rgba(255,255,0,0.3); color: #ffff00; }
        .proposal-status.all_agreed { background: rgba(57,255,20,0.3); color: #39ff14; }
        .proposal-status.has_rejections { background: rgba(255,51,102,0.3); color: #ff3366; }
        .proposal-students { margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; min-height: 60px; }
        .proposal-students.drag-over { border: 2px dashed #00ffff; background: rgba(0,255,255,0.1); }
        .proposal-student { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px; border: 1px solid #333; }
        .proposal-student-name { font-size: 12px; color: #fff; }
        .proposal-student-response { font-size: 11px; padding: 2px 6px; border-radius: 3px; }
        .proposal-student-response.pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .proposal-student-response.agreed { background: rgba(57,255,20,0.2); color: #39ff14; }
        .proposal-student-response.rejected { background: rgba(255,51,102,0.2); color: #ff3366; }
        .proposal-date-picker { margin: 10px 0; padding: 10px; background: rgba(255,255,0,0.1); border: 1px solid #ffff00; border-radius: 5px; }
        .proposal-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        
        /* Available Students for Drag */
        .available-student { padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; cursor: grab; transition: all 0.2s; }
        .available-student:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .available-student.dragging { opacity: 0.5; cursor: grabbing; }
        .available-student.rainbow-fit { animation: rainbow-border 2s linear infinite; }
        @keyframes rainbow-border {
            0% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
            17% { border-color: #ff9900; box-shadow: 0 0 10px #ff9900; }
            33% { border-color: #ffff00; box-shadow: 0 0 10px #ffff00; }
            50% { border-color: #39ff14; box-shadow: 0 0 10px #39ff14; }
            67% { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; }
            83% { border-color: #ff00ff; box-shadow: 0 0 10px #ff00ff; }
            100% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        }
        .available-student-name { font-size: 13px; color: #fff; margin-bottom: 3px; }
        .available-student-info { font-size: 11px; color: #888; }
        
        /* Date Picker Modal */
        .date-picker-modal { text-align: center; }
        .date-picker-modal input[type="date"] { font-family: 'Noto Sans', sans-serif; font-size: 14px; padding: 10px; background: #1a1a2e; color: #00ffff; border: 2px solid #00ffff; border-radius: 5px; }
        
        /* Class Preview Cards */
        .class-preview-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .class-preview-card.has-date { border-color: #39ff14; }
        .class-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .class-preview-info { color: #00ffff; font-size: 11px; }
        .class-preview-students { display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
        .class-preview-student { padding: 5px 10px; background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 15px; font-size: 11px; color: #fff; }
        .class-preview-date { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; }
        .class-preview-date label { font-size: 12px; color: #ffff00; }
        .class-preview-date input[type="date"] { font-family: 'Noto Sans', sans-serif; font-size: 12px; padding: 8px; background: #1a1a2e; color: #00ffff; border: 2px solid #00ffff; border-radius: 5px; flex: 1; }
        .class-preview-date.selected input { border-color: #39ff14; color: #39ff14; }
        .saturday-quick-btns { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .saturday-quick-btn { padding: 5px 8px; font-size: 10px; background: rgba(255,255,0,0.1); border: 1px solid #ffff00; color: #ffff00; border-radius: 4px; cursor: pointer; font-family: 'Noto Sans', sans-serif; }
        .saturday-quick-btn:hover { background: rgba(255,255,0,0.3); }
        .saturday-quick-btn.selected { background: rgba(57,255,20,0.3); border-color: #39ff14; color: #39ff14; }
        
        /* ==================== SALES CHAT MODAL STYLES ==================== */
        .sales-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; }
        .sales-modal-overlay.active { display: flex; }
        
        .sales-modal { width: 100%; height: 100vh; max-height: 100vh; display: flex; background: #050512; overflow: hidden; }
        
        /* Sales Sidebar */
        .sales-sidebar { width: 280px; min-width: 280px; height: 100%; max-height: 100vh; display: flex; flex-direction: column; background: rgba(8,10,25,0.95); border-right: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        .sales-sidebar-header { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .sales-sidebar-title { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .sales-sidebar-title h2 { font-size: 15px; font-weight: 800; color: #fff; }
        .sales-sidebar-title h2 span { color: #ffd682; }
        .sales-close-btn { width: 32px; height: 32px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #aeb8de; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .sales-close-btn:hover { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #fca5a5; }
        .sales-new-chat-btn { width: 100%; padding: 8px 12px; border-radius: 10px; border: 1px dashed rgba(255,214,130,0.3); background: rgba(255,214,130,0.08); color: #ffd682; cursor: pointer; font-size: 12px; font-weight: 600; }
        .sales-new-chat-btn:hover { background: rgba(255,214,130,0.15); border-color: rgba(255,214,130,0.5); }
        
        /* Google Voice Panel */
        .sales-voice-panel { width: 300px; min-width: 300px; height: 100%; max-height: 100vh; display: flex; flex-direction: column; background: rgba(8,10,25,0.95); border-left: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        .sales-voice-panel.collapsed { width: 0; min-width: 0; overflow: hidden; border: none; }
        .sales-voice-header { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .sales-voice-header h3 { font-size: 14px; font-weight: 700; color: #4285f4; display: flex; align-items: center; gap: 8px; }
        .sales-voice-toggle { padding: 6px 12px; border-radius: 8px; border: 1px solid rgba(66,133,244,0.3); background: rgba(66,133,244,0.1); color: #4285f4; font-size: 11px; cursor: pointer; }
        .sales-voice-toggle:hover { background: rgba(66,133,244,0.2); }
        .sales-voice-frame { flex: 1; width: 100%; border: none; background: #fff; }
        .sales-voice-notice { padding: 20px; text-align: center; color: #aeb8de; font-size: 12px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .sales-voice-notice a { color: #4285f4; text-decoration: none; }
        .sales-voice-notice a:hover { text-decoration: underline; }
        
        /* Voice Toggle Button (when panel is collapsed) */
        .sales-voice-expand-btn { position: absolute; right: 0; top: 50%; transform: translateY(-50%); padding: 12px 8px; background: rgba(66,133,244,0.2); border: 1px solid rgba(66,133,244,0.3); border-right: none; border-radius: 8px 0 0 8px; color: #4285f4; cursor: pointer; font-size: 14px; z-index: 10; }
        .sales-voice-expand-btn:hover { background: rgba(66,133,244,0.3); }
        
        /* Filter Tabs */
        .sales-filter-tabs { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; flex-shrink: 0; }
        .sales-filter-tab { padding: 4px 8px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aeb8de; font-size: 10px; font-weight: 600; cursor: pointer; }
        .sales-filter-tab:hover { background: rgba(255,255,255,0.05); }
        .sales-filter-tab.active { background: rgba(255,214,130,0.15); border-color: rgba(255,214,130,0.3); color: #ffd682; }
        .sales-filter-tab .count { display: inline-flex; min-width: 14px; height: 14px; padding: 0 3px; border-radius: 7px; background: rgba(255,255,255,0.1); font-size: 9px; margin-left: 3px; align-items: center; justify-content: center; }
        
        /* Chat List */
        .sales-chat-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; min-height: 0; }
        .sales-chat-list::-webkit-scrollbar { width: 6px; }
        .sales-chat-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        
        .sales-chat-card { position: relative; border-radius: 10px; padding: 10px; background: linear-gradient(180deg, rgba(10,16,42,0.68), rgba(10,16,42,0.92)); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 0.15s; flex-shrink: 0; }
        .sales-chat-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); }
        .sales-chat-card.active { border-color: rgba(255,214,130,0.5); box-shadow: 0 0 15px rgba(255,214,130,0.2); }
        .sales-chat-card.urgency-red { border-color: rgba(239,68,68,0.6); box-shadow: 0 0 15px rgba(239,68,68,0.3); }
        .sales-chat-card.urgency-yellow { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 15px rgba(251,191,36,0.3); }
        .sales-chat-card.urgency-grey { border-color: rgba(156,163,175,0.4); opacity: 0.7; }
        .sales-chat-card-top { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .sales-chat-card-avatar { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,255,255,0.5)); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 11px; color: rgba(12,14,30,0.9); flex-shrink: 0; }
        .sales-chat-card-info { flex: 1; min-width: 0; }
        .sales-chat-card-name { font-size: 12px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sales-chat-card-slot { font-size: 9px; color: #ff9800; margin-top: 2px; }
        .sales-chat-card-preview { font-size: 10px; color: #aeb8de; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .sales-chat-card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 9px; color: #666; }
        .sales-urgency-badge { padding: 2px 5px; border-radius: 8px; font-size: 8px; font-weight: 700; }
        .sales-urgency-badge.red { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .sales-urgency-badge.yellow { background: rgba(251,191,36,0.2); color: #fde68a; }
        .sales-urgency-badge.grey { background: rgba(156,163,175,0.2); color: #d1d5db; }
        
        /* Main Chat Area */
        .sales-main-area { flex: 1; display: flex; flex-direction: column; background: linear-gradient(180deg, #050512, #07102a); min-width: 0; height: 100%; max-height: 100vh; overflow: hidden; }
        .sales-empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; color: #aeb8de; overflow-y: auto; }
        .sales-empty-state-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.6; }
        .sales-empty-state h3 { font-size: 16px; color: #fff; margin-bottom: 6px; }
        .sales-empty-state p { font-size: 12px; max-width: 280px; }
        
        /* Active Chat */
        .sales-chat-header { padding: 12px 16px; background: rgba(8,10,25,0.9); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; flex-wrap: wrap; gap: 8px; }
        .sales-chat-header-left { display: flex; align-items: center; gap: 10px; }
        .sales-chat-header-avatar { width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,255,255,0.5)); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; color: rgba(12,14,30,0.9); flex-shrink: 0; }
        .sales-chat-header-info { }
        .sales-chat-header-name { font-size: 14px; font-weight: 700; color: #fff; }
        .sales-chat-header-details { display: flex; gap: 10px; margin-top: 3px; font-size: 10px; color: #aeb8de; flex-wrap: wrap; }
        .sales-chat-header-actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .sales-header-btn { padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #aeb8de; font-size: 10px; cursor: pointer; white-space: nowrap; }
        .sales-header-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .sales-header-btn.danger { border-color: rgba(239,68,68,0.3); color: #fca5a5; }
        .sales-header-btn.danger:hover { background: rgba(239,68,68,0.2); }
        .sales-header-btn.success { border-color: rgba(57,255,20,0.3); color: #39ff14; background: rgba(57,255,20,0.1); }
        .sales-header-btn.success:hover { background: rgba(57,255,20,0.2); }
        
        /* Messages */
        .sales-messages-container { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; min-height: 0; }
        .sales-messages-container::-webkit-scrollbar { width: 6px; }
        .sales-messages-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        
        .sales-message { max-width: 85%; animation: salesMsgSlide 0.2s ease; }
        @keyframes salesMsgSlide { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .sales-message.customer { align-self: flex-start; }
        .sales-message.admin { align-self: flex-end; }
        .sales-message.ai { align-self: flex-end; }
        .sales-message-label { font-size: 9px; color: #666; margin-bottom: 3px; padding: 0 10px; }
        .sales-message.admin .sales-message-label, .sales-message.ai .sales-message-label { text-align: right; }
        .sales-message-bubble { padding: 10px 14px; border-radius: 14px; font-size: 12px; line-height: 1.4; }
        .sales-message.customer .sales-message-bubble { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-bottom-left-radius: 4px; color: #eef2ff; }
        .sales-message.admin .sales-message-bubble { background: linear-gradient(135deg, rgba(99,102,241,0.25), rgba(99,102,241,0.15)); border: 1px solid rgba(99,102,241,0.3); border-bottom-right-radius: 4px; color: #eef2ff; }
        .sales-message.ai .sales-message-bubble { background: linear-gradient(135deg, rgba(255,214,130,0.2), rgba(255,214,130,0.1)); border: 1px solid rgba(255,214,130,0.25); border-bottom-right-radius: 4px; color: #eef2ff; cursor: pointer; }
        .sales-message.ai .sales-message-bubble:hover { background: linear-gradient(135deg, rgba(255,214,130,0.3), rgba(255,214,130,0.2)); }
        .sales-message-time { font-size: 8px; color: rgba(174,184,222,0.5); margin-top: 3px; padding: 0 10px; }
        .sales-message.admin .sales-message-time, .sales-message.ai .sales-message-time { text-align: right; }
        
        /* Typing Indicator */
        .sales-typing-indicator { display: flex; gap: 4px; padding: 10px 14px; background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.1)); border: 1px solid rgba(139,92,246,0.25); border-radius: 14px; width: fit-content; align-self: flex-end; }
        .sales-typing-indicator span { width: 5px; height: 5px; background: #c4b5fd; border-radius: 50%; animation: salesTypingBounce 1.4s ease-in-out infinite; }
        .sales-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .sales-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes salesTypingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        
        /* Input Area */
        .sales-input-area { padding: 12px 16px; background: rgba(8,10,25,0.95); border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .sales-input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
        .sales-input-container { flex: 1; min-width: 0; }
        .sales-input-label { font-size: 10px; color: #aeb8de; margin-bottom: 4px; }
        .sales-message-input { width: 100%; padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.15); background: rgba(10,16,42,0.8); color: #eef2ff; font-size: 12px; font-family: inherit; resize: none; min-height: 42px; max-height: 100px; box-sizing: border-box; }
        .sales-message-input:focus { outline: none; border-color: rgba(255,214,130,0.5); }
        .sales-message-input::placeholder { color: rgba(174,184,222,0.5); }
        .sales-send-btn { padding: 10px 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,244,200,0.7)); color: rgba(12,14,30,0.95); font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        .sales-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(255,214,130,0.3); }
        .sales-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* Context Recommendations Below Input */
        .sales-context-recommendations { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .sales-context-label { font-size: 10px; color: #39ff14; font-weight: 600; white-space: nowrap; }
        .sales-context-buttons { display: flex; gap: 6px; flex-wrap: wrap; flex: 1; }
        .sales-context-btn { padding: 5px 10px; border-radius: 15px; border: 1px solid rgba(57,255,20,0.4); background: rgba(57,255,20,0.1); color: #39ff14; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
        .sales-context-btn:hover { background: rgba(57,255,20,0.25); transform: translateY(-1px); }
        .sales-context-btn.objection { border-color: rgba(245,158,11,0.4); background: rgba(245,158,11,0.1); color: #f59e0b; }
        .sales-context-btn.objection:hover { background: rgba(245,158,11,0.25); }
        .sales-context-btn.template { border-color: rgba(139,92,246,0.4); background: rgba(139,92,246,0.1); color: #a78bfa; }
        .sales-context-btn.template:hover { background: rgba(139,92,246,0.25); }
        .sales-context-btn.closing { border-color: rgba(16,185,129,0.4); background: rgba(16,185,129,0.1); color: #10b981; }
        .sales-context-btn.closing:hover { background: rgba(16,185,129,0.25); }
        
        /* Suggestions Sidebar */
        .sales-suggestions-sidebar { width: 240px; min-width: 240px; height: 100%; max-height: 100vh; background: rgba(8,10,25,0.95); border-left: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .sales-suggestions-header { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .sales-suggestions-header h3 { font-size: 13px; font-weight: 700; color: #ffd682; display: flex; align-items: center; gap: 6px; }
        .sales-suggestions-content { flex: 1; overflow-y: auto; padding: 10px; min-height: 0; }
        .sales-suggestion-section { margin-bottom: 14px; }
        .sales-suggestion-title { font-size: 9px; font-weight: 700; color: #aeb8de; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px; }
        .sales-suggestion-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 10px; margin-bottom: 6px; cursor: pointer; transition: all 0.15s; position: relative; }
        .sales-suggestion-card:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,214,130,0.3); }
        .sales-suggestion-card.objection { border-left: 3px solid #f59e0b; }
        .sales-suggestion-card.template { border-left: 3px solid #8b5cf6; }
        .sales-suggestion-card.closing { border-left: 3px solid #10b981; }
        .sales-suggestion-card.highlighted { border-color: #39ff14; box-shadow: 0 0 10px rgba(57,255,20,0.3); }
        .sales-suggestion-card.copied { background: rgba(57,255,20,0.2); }
        .sales-suggestion-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 3px; }
        .sales-suggestion-card-title { font-size: 10px; font-weight: 700; color: #fff; flex: 1; }
        .sales-suggestion-card-meta { display: flex; gap: 4px; align-items: center; }
        .sales-suggestion-card-uses { font-size: 8px; color: #888; background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 8px; }
        .sales-suggestion-card-fav { background: none; border: none; cursor: pointer; font-size: 12px; padding: 0; opacity: 0.5; }
        .sales-suggestion-card-fav:hover { opacity: 1; }
        .sales-suggestion-card-fav.active { opacity: 1; }
        .sales-suggestion-card-preview { font-size: 9px; color: #aeb8de; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .sales-suggestion-card-tags { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .sales-suggestion-card-tag { font-size: 8px; padding: 1px 5px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #aeb8de; }
        .sales-suggestion-card-actions { display: flex; gap: 4px; margin-top: 6px; }
        .sales-suggestion-edit-btn { padding: 3px 6px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #aeb8de; font-size: 9px; cursor: pointer; }
        .sales-suggestion-edit-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .sales-suggestion-ai-btn { padding: 3px 6px; border-radius: 4px; border: 1px solid rgba(255,214,130,0.3); background: rgba(255,214,130,0.1); color: #ffd682; font-size: 9px; cursor: pointer; }
        .sales-suggestion-ai-btn:hover { background: rgba(255,214,130,0.2); }
        .sales-suggestion-personalize-btn { padding: 3px 6px; border-radius: 4px; border: 1px solid rgba(57,255,20,0.3); background: rgba(57,255,20,0.1); color: #39ff14; font-size: 9px; cursor: pointer; }
        .sales-suggestion-personalize-btn:hover { background: rgba(57,255,20,0.2); }
        
        /* Suggestions Header */
        .sales-suggestions-header { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .sales-suggestion-add-btn { width: 28px; height: 28px; border-radius: 8px; border: 1px dashed rgba(255,214,130,0.3); background: transparent; color: #ffd682; font-size: 14px; cursor: pointer; }
        .sales-suggestion-add-btn:hover { background: rgba(255,214,130,0.1); }
        
        /* Search Bar */
        .sales-suggestions-search { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sales-suggestions-search input { width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #eef2ff; font-size: 11px; }
        .sales-suggestions-search input::placeholder { color: rgba(174,184,222,0.5); }
        .sales-suggestions-search input:focus { outline: none; border-color: rgba(255,214,130,0.3); }
        
        /* Filter Chips */
        .sales-suggestions-filters { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); flex-wrap: wrap; }
        .sales-filter-chip { padding: 4px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aeb8de; font-size: 10px; cursor: pointer; }
        .sales-filter-chip:hover { background: rgba(255,255,255,0.05); }
        .sales-filter-chip.active { background: rgba(255,214,130,0.15); border-color: rgba(255,214,130,0.3); color: #ffd682; }
        
        /* Quick Links */
        .sales-quick-links { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sales-quick-link-btn { flex: 1; padding: 5px 4px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: #aeb8de; font-size: 9px; cursor: pointer; text-align: center; }
        .sales-quick-link-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
        
        /* Section Add Button */
        .sales-section-add-btn { background: none; border: none; color: #ffd682; font-size: 12px; cursor: pointer; margin-left: 5px; opacity: 0.6; }
        .sales-section-add-btn:hover { opacity: 1; }
        
        /* Fox Downsell Notification */
        .sales-fox-badge { position: absolute; top: -6px; right: -6px; width: 24px; height: 24px; border-radius: 50%; overflow: hidden; border: 2px solid #ff9800; box-shadow: 0 0 10px rgba(255,152,0,0.5); animation: salesFoxPulse 2s ease-in-out infinite; }
        .sales-fox-badge img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes salesFoxPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,152,0,0.5); } 50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255,152,0,0.8); } }
        .sales-chat-card.downsell-ready { border-color: rgba(255,152,0,0.8); box-shadow: 0 0 20px rgba(255,152,0,0.4); }
        .sales-downsell-timer { font-size: 8px; color: #ff9800; margin-top: 3px; display: flex; align-items: center; gap: 3px; }
        
        /* Slot Context Banner */
        .sales-slot-context { padding: 10px 14px; background: linear-gradient(135deg, rgba(255,152,0,0.15), rgba(255,152,0,0.05)); border-bottom: 1px solid rgba(255,152,0,0.3); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .sales-slot-context-icon { font-size: 20px; }
        .sales-slot-context-info { flex: 1; }
        .sales-slot-context-title { font-size: 12px; font-weight: 700; color: #ff9800; }
        .sales-slot-context-details { font-size: 10px; color: #aeb8de; margin-top: 2px; }
        .sales-slot-context-seats { display: flex; gap: 3px; align-items: center; }
        .sales-seat-dot { width: 10px; height: 10px; border-radius: 2px; }
        .sales-seat-dot.filled { background: #ff9800; }
        .sales-seat-dot.empty { background: rgba(57,255,20,0.3); border: 1px solid #39ff14; }
        
        /* Slot Students Modal */
        .sales-students-list { margin: 15px 0; max-height: 300px; overflow-y: auto; }
        .sales-student-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(10,16,42,0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 8px; }
        .sales-student-item-info { flex: 1; }
        .sales-student-item-name { font-size: 13px; font-weight: 600; color: #fff; }
        .sales-student-item-meta { font-size: 11px; color: #aeb8de; margin-top: 2px; }
        .sales-student-item-actions { display: flex; gap: 8px; }
        .sales-student-chat-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,214,130,0.3); background: rgba(255,214,130,0.1); color: #ffd682; font-size: 10px; cursor: pointer; }
        .sales-student-chat-btn:hover { background: rgba(255,214,130,0.2); }
        .sales-student-remove-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(239,68,68,0.3); background: rgba(239,68,68,0.1); color: #fca5a5; font-size: 10px; cursor: pointer; }
        .sales-student-remove-btn:hover { background: rgba(239,68,68,0.2); }
        
        /* Sales Settings Tabs */
        .sales-settings-tabs { display: flex; gap: 4px; padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; }
        .sales-settings-tab { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aeb8de; font-size: 11px; font-weight: 600; cursor: pointer; }
        .sales-settings-tab:hover { background: rgba(255,255,255,0.05); }
        .sales-settings-tab.active { background: rgba(255,214,130,0.15); border-color: rgba(255,214,130,0.3); color: #ffd682; }
        .sales-settings-panel { display: none; }
        .sales-settings-panel.active { display: block; }
        
        /* Sales Sound Upload */
        .sales-sound-upload { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .sales-sound-preview { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; }
        .sales-sound-preview span { font-size: 12px; color: #aeb8de; }
        
        /* Sales Settings List Items */
        .sales-settings-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 8px; }
        .sales-settings-item:hover { background: rgba(255,255,255,0.05); }
        .sales-settings-item-content { flex: 1; min-width: 0; }
        .sales-settings-item-title { font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .sales-settings-item-text { font-size: 11px; color: #aeb8de; line-height: 1.4; word-wrap: break-word; }
        .sales-settings-item-actions { display: flex; gap: 6px; margin-left: 10px; flex-shrink: 0; }
        .sales-settings-item-btn { padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aeb8de; font-size: 10px; cursor: pointer; }
        .sales-settings-item-btn:hover { background: rgba(255,255,255,0.1); }
        .sales-settings-item-btn.delete { border-color: rgba(239,68,68,0.3); color: #fca5a5; }
        .sales-settings-item-btn.delete:hover { background: rgba(239,68,68,0.2); }
        
        /* Sales Feedback Panel */
        .sales-feedback-panel { position: fixed; right: -400px; top: 0; width: 400px; height: 100vh; background: rgba(8,10,25,0.98); border-left: 1px solid rgba(255,255,255,0.1); z-index: 2500; transition: right 0.3s; display: flex; flex-direction: column; }
        .sales-feedback-panel.open { right: 0; }
        .sales-feedback-header { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .sales-feedback-header h2 { font-size: 16px; color: #fff; margin: 0; }
        .sales-feedback-header button { background: none; border: none; color: #aeb8de; font-size: 20px; cursor: pointer; }
        .sales-feedback-content { flex: 1; overflow-y: auto; padding: 16px; }
        .sales-feedback-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 12px; }
        .sales-feedback-card h4 { font-size: 13px; color: #ffd682; margin-bottom: 8px; }
        .sales-feedback-card p { font-size: 12px; color: #aeb8de; line-height: 1.5; }
        .sales-feedback-card ul { margin: 8px 0 0 0; padding-left: 20px; }
        .sales-feedback-card li { font-size: 11px; color: #aeb8de; margin-bottom: 4px; }
        
        /* Sales Drag Overlay */
        .sales-drag-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; flex-direction: column; padding: 30px; }
        .sales-drag-overlay.active { display: flex; }
        .sales-drag-overlay-header { text-align: center; margin-bottom: 20px; position: relative; }
        .sales-drag-overlay-header h2 { font-size: 24px; color: #fff; margin-bottom: 8px; }
        .sales-drag-overlay-header p { font-size: 14px; color: #aeb8de; }
        .sales-drag-overlay-close { position: absolute; right: 0; top: 0; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 20px; cursor: pointer; }
        .sales-drag-overlay-close:hover { background: rgba(239,68,68,0.3); }
        .sales-drag-overlay-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .sales-drag-stat { padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; }
        .sales-drag-stat.hot { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .sales-drag-stat.warm { background: rgba(251,191,36,0.2); color: #fde68a; }
        .sales-drag-stat.cold { background: rgba(156,163,175,0.2); color: #d1d5db; }
        .sales-drag-overlay-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; }
        .sales-drag-overlay-card { padding: 15px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .sales-drag-overlay-card:hover { transform: translateY(-3px); border-color: rgba(255,214,130,0.5); }
        .sales-drag-overlay-card.urgency-red { border-color: rgba(239,68,68,0.6); }
        .sales-drag-overlay-card.urgency-yellow { border-color: rgba(251,191,36,0.6); }
        .sales-drag-overlay-card.urgency-grey { border-color: rgba(156,163,175,0.4); opacity: 0.7; }
        .sales-drag-overlay-avatar { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,255,255,0.5)); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; color: rgba(12,14,30,0.9); margin-bottom: 10px; }
        .sales-drag-overlay-name { font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .sales-drag-overlay-meta { font-size: 11px; color: #aeb8de; }
        
        /* Sales Chat Responsive */
        @media (max-width: 1400px) { .sales-voice-panel { width: 280px; min-width: 280px; } }
        @media (max-width: 1200px) { .sales-suggestions-sidebar { display: none; } .sales-voice-panel { display: none; } }
        @media (max-width: 900px) { 
            .sales-modal { flex-direction: column; } 
            .sales-sidebar { width: 100%; min-width: 100%; height: auto; max-height: 30vh; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); } 
            .sales-main-area { flex: 1; min-height: 0; }
            .sales-chat-header { padding: 10px 12px; }
            .sales-chat-header-actions { display: none; }
            .sales-messages-container { padding: 12px; }
            .sales-input-area { padding: 10px 12px; }
        }
        
        @media (max-width: 768px) { .header h1 { font-size: 12px; } .grid-2 { grid-template-columns: 1fr; } .availability-grid { grid-template-columns: 1fr; } .schedule-grid { grid-template-columns: 60px repeat(2, 1fr); } .schedule-header, .schedule-time { font-size: 11px; padding: 8px 4px; } #courseCalendarGrid { grid-template-columns: repeat(2, 1fr); } .monthly-calendar { grid-template-columns: repeat(7, 1fr); } .calendar-day { min-height: 50px; } }
        
        @media (max-width: 768px) { .header h1 { font-size: 12px; } .grid-2 { grid-template-columns: 1fr; } .availability-grid { grid-template-columns: 1fr; } .schedule-grid { grid-template-columns: 60px repeat(2, 1fr); } .schedule-header, .schedule-time { font-size: 11px; padding: 8px 4px; } #courseCalendarGrid { grid-template-columns: repeat(2, 1fr); } .monthly-calendar { grid-template-columns: repeat(7, 1fr); } .calendar-day { min-height: 50px; } }
    </style>
</head>
<body>
    <!-- Theme Toggle Switch - Fixed position top right -->
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection">
            <h2>ðŸŽ® CLASS SCHEDULER</h2>
            <div class="role-tabs">
                <button class="role-tab active" onclick="switchRole('admin')">âš™ï¸ ADMIN</button>
                <button class="role-tab" onclick="switchRole('support')">ðŸ›Ÿ SUPPORT</button>
                <button class="role-tab" onclick="switchRole('teacher')">ðŸ‘¨â€ðŸ« TEACHER</button>
            </div>

            <!-- Admin Login -->
            <div id="adminLoginForm">
                <div id="adminLoginMessage"></div>
                <div class="form-group"><label>Admin Email</label><input type="email" id="adminEmail" placeholder="Enter admin email"></div>
                <div class="form-group"><label>Password</label><input type="password" id="adminPassword" placeholder="Enter password"></div>
                <button class="btn btn-primary btn-block" onclick="adminLogin()">ðŸ”“ LOGIN AS ADMIN</button>
            </div>

            <!-- Support Login -->
            <div id="supportLoginForm" style="display: none;">
                <div id="supportLoginMessage"></div>
                <div class="form-group"><label>Support Email</label><input type="email" id="supportEmail" placeholder="Enter support email"></div>
                <div class="form-group"><label>Password</label><input type="password" id="supportPassword" placeholder="Enter password"></div>
                <button class="btn btn-block" style="background: #9c27b0; border-color: #9c27b0;" onclick="supportLogin()">ðŸ”“ LOGIN AS SUPPORT</button>
            </div>

            <!-- Teacher Login -->
            <div id="teacherLoginForm" style="display: none;">
                <div id="teacherLoginMessage"></div>
                <div class="form-group"><label>Teacher Email</label><input type="email" id="teacherEmail" placeholder="Enter teacher email"></div>
                <div class="form-group"><label>Password</label><input type="password" id="teacherPassword" placeholder="Enter password"></div>
                <button class="btn btn-success btn-block" onclick="teacherLogin()">ðŸ”“ LOGIN AS TEACHER</button>
            </div>
        </div>

        <!-- Main Panel -->
        <div id="mainPanel">
            <div class="header">
                <h1>ðŸŽ® CLASS SCHEDULER</h1>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="user-info" id="userInfoDisplay"></span>
                    <button class="btn btn-danger btn-sm" onclick="logout()">LOGOUT</button>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" style="display: none;">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showAdminTab('dashboard')">ðŸ“Š Dashboard</button>
                    <button class="nav-tab" onclick="showAdminTab('calendar')">ðŸ—“ï¸ Calendar</button>
                    <button class="nav-tab" onclick="showAdminTab('schedule')">ðŸ“… Schedule</button>
                    <button class="nav-tab" onclick="showAdminTab('students')">ðŸ“‹ Students</button>
                    <button class="nav-tab" onclick="showAdminTab('proposals')">ðŸ“ Proposals</button>
                    <button class="nav-tab" onclick="showAdminTab('classes')">ðŸ“š Classes</button>
                    <button class="nav-tab" onclick="showAdminTab('attendance')">ðŸ“Š Attendance</button>
                    <button class="nav-tab" onclick="showAdminTab('absences')">ðŸš« Absences</button>
                    <button class="nav-tab" onclick="showAdminTab('completed')">ðŸŽ“ Completed</button>
                    <button class="nav-tab" onclick="showAdminTab('teachers')">ðŸ‘¨â€ðŸ« Teachers</button>
                    <button class="nav-tab" onclick="showAdminTab('materials')">ðŸ“– Materials</button>
                    <button class="nav-tab" onclick="showAdminTab('slotmanager')">ðŸ“… Slot Manager</button>
                    <button class="nav-tab" onclick="showAdminTab('suggestions')">ðŸ’¡ Suggestions</button>
                    <button class="nav-tab" onclick="showAdminTab('ready')">âœ… Ready</button>
                    <button class="nav-tab" onclick="showAdminTab('accounts')">ðŸ‘¤ Account Creation</button>
                    <button class="nav-tab" onclick="showAdminTab('settings')">âš™ï¸ Settings</button>
                </div>

                <div id="adminTabDashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card cyan"><div class="stat-number" id="statTotalStudents">0</div><div class="stat-label">TOTAL STUDENTS</div></div>
                        <div class="stat-card green"><div class="stat-number" id="statAssignedStudents">0</div><div class="stat-label">ASSIGNED</div></div>
                        <div class="stat-card yellow"><div class="stat-number" id="statPendingStudents">0</div><div class="stat-label">PENDING LEVEL</div></div>
                        <div class="stat-card orange"><div class="stat-number" id="statLimboStudents">0</div><div class="stat-label">IN LIMBO</div></div>
                        <div class="stat-card pink"><div class="stat-number" id="statTotalClasses">0</div><div class="stat-label">CLASSES</div></div>
                    </div>
                    <div class="card"><h3>ðŸ“… Current Week</h3><div class="week-tracker" id="dashboardWeekTracker"></div></div>
                    
                    <!-- Teacher Classes View -->
                    <div class="card" style="margin-top: 20px;">
                        <h3>ðŸ‘¨â€ðŸ« View Teacher's Classes</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Click a teacher to view their Today and My Classes view (useful for covering classes)</p>
                        <div id="teacherButtonsContainer" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <!-- Teacher buttons will be populated here -->
                        </div>
                        <div id="adminTeacherViewContainer" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 8px;">
                                <span style="color: #00ffff; font-size: 13px;">Viewing classes for: <strong id="adminViewingTeacherName"></strong></span>
                                <button class="btn btn-sm btn-secondary" onclick="closeAdminTeacherView()">âœ• Close</button>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button class="btn btn-sm admin-teacher-view-tab active" onclick="switchAdminTeacherViewTab('today')" data-tab="today">ðŸ“… Today</button>
                                <button class="btn btn-sm admin-teacher-view-tab" onclick="switchAdminTeacherViewTab('classes')" data-tab="classes">ðŸ“š My Classes</button>
                            </div>
                            <div id="adminTeacherTodayView"></div>
                            <div id="adminTeacherClassesView" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div id="adminTabCalendar" class="tab-content">
                    <div class="card">
                        <h3>ðŸ—“ï¸ Monthly Calendar</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <button class="btn btn-info" onclick="changeCalendarMonth(-1)">â—€ Prev</button>
                            <span id="calendarMonthLabel" style="font-size: 12px; color: #00ffff;"></span>
                            <button class="btn btn-info" onclick="changeCalendarMonth(1)">Next â–¶</button>
                        </div>
                        <div class="monthly-calendar" id="monthlyCalendarGrid"></div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-top: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Class Day</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #00ffff;"></div><span>Today</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff00ff;"></div><span>Course Start/End</span></div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Tab -->
                <div id="adminTabSchedule" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“… Weekly Schedule Overview</h3>
                        
                        <!-- Summary Stats -->
                        <div class="schedule-summary" id="adminScheduleSummary">
                            <div class="summary-box total"><div class="summary-number" id="schedTotalSlots">16</div><div class="summary-label">TOTAL SLOTS</div></div>
                            <div class="summary-box active"><div class="summary-number" id="schedActiveClasses">0</div><div class="summary-label">ACTIVE CLASSES</div></div>
                            <div class="summary-box needs-teacher"><div class="summary-number" id="schedNeedsTeacher">0</div><div class="summary-label">NEED TEACHER</div></div>
                            <div class="summary-box full"><div class="summary-number" id="schedFullClasses">0</div><div class="summary-label">FULL CLASSES</div></div>
                            <div class="summary-box empty"><div class="summary-number" id="schedEmptySlots">16</div><div class="summary-label">EMPTY SLOTS</div></div>
                            <div class="summary-box available"><div class="summary-number" id="schedAvailableSpots">0</div><div class="summary-label">SPOTS AVAILABLE</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend">
                            <div class="legend-item"><div class="legend-bar active"></div><span>Active (has teacher)</span></div>
                            <div class="legend-item"><div class="legend-bar needs-teacher"></div><span>Needs Teacher</span></div>
                            <div class="legend-item"><div class="legend-bar full"></div><span>Full (max students)</span></div>
                            <div class="legend-item"><div class="legend-bar empty"></div><span>Empty Slot</span></div>
                        </div>
                        
                        <!-- Schedule Grid -->
                        <div class="schedule-grid" id="adminScheduleGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div id="adminTabStudents" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“‹ Registered Students</h3>
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="loadAllStudents()">ðŸ”„ Refresh Students</button>
                            <button class="btn btn-success" onclick="autoGenerateClasses()">ðŸ¤– Auto-Generate Classes</button>
                            <button class="btn btn-warning" onclick="openExistingStudentSearch()">ðŸ” Add Existing Student</button>
                        </div>
                        <div style="overflow-x: auto;"><table><thead><tr><th>Name</th><th>Email</th><th>Location</th><th>Timezone</th><th>Availability</th><th>Video</th><th>Class</th><th>Status</th><th>Actions</th></tr></thead><tbody id="studentsTableBody"><tr><td colspan="9" style="text-align: center; color: #888;">Loading...</td></tr></tbody></table></div>
                    </div>
                </div>

                <!-- Proposals Tab -->
                <div id="adminTabProposals" class="tab-content">
                    <div class="proposals-layout">
                        <!-- Left Side - Proposed Classes -->
                        <div class="proposals-left">
                            <div class="card">
                                <h3>ðŸ“ Proposed Classes</h3>
                                <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Review and manage class proposals before finalizing.</p>
                                <div id="proposalsContainer"><p style="color: #888; font-size: 12px;">No proposals yet. Use "Auto-Generate Classes" to create proposals.</p></div>
                            </div>
                        </div>
                        
                        <!-- Right Side - Available Students -->
                        <div class="proposals-right">
                            <div class="card">
                                <h3>ðŸ‘¥ Available Students</h3>
                                <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Drag students into proposed classes. <span style="color: #ff00ff;">ðŸŒˆ Rainbow = good fit</span></p>
                                <div id="availableStudentsForProposals"><p style="color: #888; font-size: 12px;">No available students.</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="adminTabClasses" class="tab-content">
                    <!-- Class Management Buttons -->
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <h3 style="margin: 0;">ðŸŽ“ Class Management</h3>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #ff00ff, #cc00cc); border-color: #ff00ff;" onclick="openAddClassTypeModal()">âž• Add Class Type</button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #00ffff, #00cccc); border-color: #00ffff; color: #000;" onclick="openAddClassModal()">âž• Add Class</button>
                            </div>
                        </div>
                        <p style="font-size: 11px; color: #888; margin-top: 10px;">Class Types: <span id="classTypesDisplay">Loading...</span></p>
                    </div>
                    
                    <div class="card"><h3>ðŸ“… Week Tracker</h3><div class="week-tracker" id="classesWeekTracker"></div></div>
                    <div class="grid-2">
                        <div class="card"><h3>ðŸ“š Generated Classes</h3><div id="classesContainer"><p style="color: #888; font-size: 12px;">No classes yet.</p></div></div>
                        <div class="card"><h3 style="color: #ff3366; border-color: #ff3366;">âš ï¸ Limbo Students</h3><div class="limbo-section" id="limboContainer"><p style="color: #888; font-size: 12px;">No students in limbo.</p></div></div>
                    </div>
                </div>

                <!-- Admin Attendance Tab -->
                <div id="adminTabAttendance" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“Š Attendance Overview</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">View and manage attendance for all classes.</p>
                        
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-info" onclick="loadAdminAttendance()">ðŸ”„ Refresh</button>
                            <div class="form-group" style="margin: 0;">
                                <select id="adminAttendanceClassFilter" onchange="loadAdminAttendance()" style="padding: 8px; font-size: 12px;">
                                    <option value="all">All Classes</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Attendance Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="adminAttendancePresent" style="color: #39ff14;">0</div><div class="summary-label">PRESENT</div></div>
                            <div class="summary-box" style="border-color: #ffff00;"><div class="summary-number" id="adminAttendanceLate" style="color: #ffff00;">0</div><div class="summary-label">LATE</div></div>
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="adminAttendanceAbsent" style="color: #ff3366;">0</div><div class="summary-label">ABSENT</div></div>
                            <div class="summary-box" style="border-color: #888;"><div class="summary-number" id="adminAttendanceNotMarked" style="color: #888;">0</div><div class="summary-label">NOT MARKED</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Present</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ffff00;"></div><span>Late</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>Absent</span></div>
                        </div>
                        
                        <!-- Attendance List -->
                        <div id="adminAttendanceContainer">
                            <p style="color: #888; font-size: 12px;">Click refresh to load attendance...</p>
                        </div>
                    </div>
                </div>

                <!-- Absences Tab -->
                <div id="adminTabAbsences" class="tab-content">
                    <div class="card">
                        <h3>ðŸš« Student Absences</h3>
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-info" onclick="loadAbsencesList()">ðŸ”„ Refresh</button>
                            <div class="form-group" style="margin: 0;">
                                <select id="absenceWeekFilter" onchange="loadAbsencesList()" style="padding: 8px; font-size: 12px;">
                                    <option value="all">All Weeks</option>
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <select id="absenceContactFilter" onchange="filterAbsencesList()" style="padding: 8px; font-size: 12px;">
                                    <option value="all">All Status</option>
                                    <option value="not-contacted">Not Contacted Only</option>
                                    <option value="contacted">Contacted Only</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Absence Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="absenceTotalCount" style="color: #ff3366;">0</div><div class="summary-label">TOTAL ABSENCES</div></div>
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="absenceContactedCount" style="color: #39ff14;">0</div><div class="summary-label">CONTACTED</div></div>
                            <div class="summary-box" style="border-color: #ff6600;"><div class="summary-number" id="absenceNotContactedCount" style="color: #ff6600;">0</div><div class="summary-label">NOT CONTACTED</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Contacted</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>Not Contacted</span></div>
                        </div>
                        
                        <!-- Absences List -->
                        <div id="absencesListContainer">
                            <p style="color: #888; font-size: 12px;">Click refresh to load absences...</p>
                        </div>
                    </div>
                </div>

                <!-- Completed Tab -->
                <div id="adminTabCompleted" class="tab-content">
                    <div class="card">
                        <h3>ðŸŽ“ Completed Classes</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">View all completed classes and track 1-Year Academy enrollment status.</p>
                        
                        <!-- Date Filter -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; color: #888; margin-bottom: 5px; display: block;">Filter by completion date:</label>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('all')" data-days="all">All time</button>
                                <button class="btn btn-sm admin-completed-filter-btn active" onclick="filterAdminCompletedClasses('7')" data-days="7">Last 7 days</button>
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('14')" data-days="14">Last 14 days</button>
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('28')" data-days="28">Last 28 days</button>
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('90')" data-days="90">Last 3 months</button>
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('180')" data-days="180">Last 6 months</button>
                            </div>
                        </div>
                        
                        <!-- Completed Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #ff00ff;"><div class="summary-number" id="completedTotalCount" style="color: #ff00ff;">0</div><div class="summary-label">TOTAL STUDENTS</div></div>
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="completedJoinedCount" style="color: #39ff14;">0</div><div class="summary-label">JOINED (YES)</div></div>
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="completedNotInterestedCount" style="color: #ff3366;">0</div><div class="summary-label">DECLINED (NO)</div></div>
                            <div class="summary-box" style="border-color: #ffff00;"><div class="summary-number" id="completedPendingCount" style="color: #ffff00;">0</div><div class="summary-label">PENDING</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Yes - Joined Academy</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>No - Declined</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ffff00;"></div><span>Pending Decision</span></div>
                        </div>
                        
                        <!-- Completed Classes List -->
                        <div id="adminCompletedClassesContainer">
                            <p style="color: #888; font-size: 12px;">Loading completed classes...</p>
                        </div>
                    </div>
                </div>

                <div id="adminTabTeachers" class="tab-content">
                    <div class="grid-2">
                        <div class="card">
                            <h3>âž• Add New Teacher</h3>
                            <div id="addTeacherMessage"></div>
                            <div class="form-group"><label>Teacher Name</label><input type="text" id="newTeacherName" placeholder="Enter name"></div>
                            <div class="form-group"><label>Teacher Email</label><input type="email" id="newTeacherEmail" placeholder="Enter email"></div>
                            <div class="form-group"><label>Password</label><input type="password" id="newTeacherPassword" placeholder="Create password"></div>
                            <div class="form-group"><label>Available Days</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDaySat" checked> Saturday</label>
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDaySun" checked> Sunday</label>
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDayThu"> Thursday</label>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="addNewTeacher()">âž• Add Teacher</button>
                        </div>
                        <div class="card"><h3>ðŸ‘¨â€ðŸ« Teacher List</h3><div id="teachersListContainer"><p style="color: #888;">Loading...</p></div></div>
                    </div>
                </div>

                <div id="adminTabMaterials" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“– Teaching Materials</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Select Level</label>
                                <select id="materialLevelSelect" onchange="loadMaterialsForLevel()" data-level-select>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Select Week</label>
                                <select id="materialWeekSelect" onchange="loadMaterialsForLevel()">
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-sm btn-primary" onclick="addMaterialBlock('text')">ðŸ“ Text</button>
                            <button class="btn btn-sm btn-info" onclick="addMaterialBlock('link')">ðŸ”— Link</button>
                            <button class="btn btn-sm btn-success" onclick="addMaterialBlock('image')">ðŸ–¼ï¸ Image</button>
                            <button class="btn btn-sm btn-warning" onclick="addMaterialBlock('file')">ðŸ“ File</button>
                            <button class="btn btn-sm" style="background: linear-gradient(135deg, #9c27b0, #673ab7); border-color: #9c27b0; color: #fff;" onclick="addMaterialBlock('permutation-game')">ðŸŒŸ Yodafy Game</button>
                        </div>
                        <div id="materialsContainer"><p style="color: #888; font-size: 14px; font-family: 'Noto Sans', sans-serif;">No materials yet.</p></div>
                    </div>
                </div>

                <div id="adminTabSuggestions" class="tab-content">
                    <div class="card">
                        <h3>ðŸ’¡ Teacher Suggestions</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Review and respond to suggestions from teachers.</p>
                        <div id="adminSuggestionsContainer"><p style="color: #888; font-size: 12px;">No suggestions yet.</p></div>
                    </div>
                </div>

                <!-- Ready Tab -->
                <div id="adminTabReady" class="tab-content">
                    <div class="card">
                        <h3>âœ… Ready for Account</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Students who have completed Lesson 3 and requested their account. Check off students after creating their account.</p>
                        
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="loadReadyRequests()">ðŸ”„ Refresh Requests</button>
                        </div>
                        
                        <!-- Dashboard Stats -->
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                            <div style="background: rgba(0,255,255,0.2); border: 2px solid #00ffff; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #00ffff; font-weight: bold;" id="statTotalReady">0</div>
                                <div style="font-size: 11px; color: #888;">TOTAL REQUESTS</div>
                            </div>
                            <div style="background: rgba(255,152,0,0.2); border: 2px solid #ff9800; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #ff9800; font-weight: bold;" id="statPendingReady">0</div>
                                <div style="font-size: 11px; color: #888;">PENDING</div>
                            </div>
                            <div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #39ff14; font-weight: bold;" id="statCompletedReady">0</div>
                                <div style="font-size: 11px; color: #888;">COMPLETED</div>
                            </div>
                        </div>
                        
                        <!-- Filter -->
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <input type="text" id="readySearch" placeholder="ðŸ” Search by name or email..." oninput="filterReadyRequests()" style="width: 100%;">
                                </div>
                                <div>
                                    <select id="readyFilter" onchange="filterReadyRequests()">
                                        <option value="all">All Requests</option>
                                        <option value="pending">Pending Only</option>
                                        <option value="completed">Completed Only</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ready List -->
                        <div id="readyRequestsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">
                            <p style="color: #888; font-size: 12px;">Click "Refresh Requests" to load student requests...</p>
                        </div>
                    </div>
                </div>

                <!-- Slot Manager Tab -->
                <div id="adminTabSlotmanager" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“… Class Slot Manager</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">View slot availability, generate student materials, and create Shopify listings.</p>
                        
                        <!-- Controls -->
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: center;">
                            <div>
                                <label style="font-size: 12px; color: #888;">Select Teacher:</label>
                                <select id="slotManagerTeacher" onchange="renderSlotGrid()" style="margin-left: 5px;">
                                    <option value="">-- All Teachers --</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #888;">View:</label>
                                <select id="slotManagerView" onchange="renderSlotGrid()" style="margin-left: 5px;">
                                    <option value="4">Next 4 Weeks</option>
                                    <option value="8" selected>Next 8 Weeks</option>
                                    <option value="12">Next 12 Weeks</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 12px;">
                            <span><span style="display: inline-block; width: 15px; height: 15px; background: #39ff14; border-radius: 3px; vertical-align: middle;"></span> Available</span>
                            <span><span style="display: inline-block; width: 15px; height: 15px; background: #ffff00; border-radius: 3px; vertical-align: middle;"></span> Ending Soon (Weeks 5-6)</span>
                            <span><span style="display: inline-block; width: 15px; height: 15px; background: #ff3366; border-radius: 3px; vertical-align: middle;"></span> Mid-Session</span>
                            <span><span style="display: inline-block; width: 15px; height: 15px; background: #888; border-radius: 3px; vertical-align: middle;"></span> No Teacher Available</span>
                        </div>
                        
                        <!-- Slot Grid -->
                        <div id="slotGridContainer" style="margin-bottom: 30px;">
                            <p style="color: #888; font-size: 12px;">Loading slot availability...</p>
                        </div>
                        
                        <!-- Forecast Section -->
                        <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #00ffff; margin-bottom: 10px;">ðŸ“Š Upcoming Availability Forecast</h4>
                            <div id="slotForecast" style="font-size: 13px;">
                                <p style="color: #888;">Loading forecast...</p>
                            </div>
                        </div>
                        
                        <!-- Teacher Workload -->
                        <div style="background: rgba(255,0,255,0.1); border: 2px solid #ff00ff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #ff00ff; margin-bottom: 10px;">ðŸ‘¨â€ðŸ« Teacher Workload</h4>
                            <div id="teacherWorkload" style="font-size: 13px;">
                                <p style="color: #888;">Loading workload...</p>
                            </div>
                        </div>
                        
                        <!-- Analytics Section -->
                        <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px; padding: 15px;">
                            <h4 style="color: #39ff14; margin-bottom: 10px;">ðŸ“ˆ Slot Analytics (Based on Attendance)</h4>
                            <div id="slotAnalytics" style="font-size: 13px;">
                                <p style="color: #888;">Loading analytics...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Class Templates Section -->
                    <div class="card" style="margin-top: 20px;">
                        <h3>ðŸ“„ Class Templates</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Pre-load video links, preparation instructions, and images for each class type. These will be used when generating materials and sending emails to students.</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <div class="form-group">
                                    <label>Class Type *</label>
                                    <select id="templateClassType" data-level-select onchange="loadClassTemplate()">
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Class Link (Zoom/Google Meet) *</label>
                                    <input type="text" id="templateClassLink" placeholder="https://zoom.us/j/...">
                                </div>
                                <div class="form-group">
                                    <label>Preparation Instructions for Students</label>
                                    <textarea id="templatePreparation" rows="6" placeholder="What students should do before class..."></textarea>
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label>Upload Images (optional)</label>
                                    <input type="file" id="templateImages" multiple accept="image/*" onchange="handleTemplateImageUpload(event)">
                                    <div id="templateImagePreview" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; min-height: 100px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
                                        <p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>
                                    </div>
                                </div>
                                <div style="background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 8px; padding: 10px; margin-top: 10px;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 5px;">Template Status:</div>
                                    <div id="templateStatus" style="color: #ffff00; font-size: 12px;">No template loaded</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" onclick="saveClassTemplate()">ðŸ’¾ Save Template</button>
                            <button class="btn btn-info" onclick="previewClassTemplate()">ðŸ‘ï¸ Preview</button>
                            <button class="btn btn-danger" onclick="deleteClassTemplate()" style="margin-left: auto;">ðŸ—‘ï¸ Delete Template</button>
                        </div>
                    </div>
                </div>

                <!-- Account Creation Tab -->
                <div id="adminTabAccounts" class="tab-content">
                    <div class="card">
                        <h3>ðŸ‘¤ Account Creation</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Create Firebase accounts for Shopify customers. Customers need accounts to log in and access their materials.</p>
                        
                        <!-- Initial Load Controls -->
                        <div id="accountLoadControls" style="margin-bottom: 15px; padding: 15px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px;">
                            <p style="font-size: 13px; color: #00ffff; margin-bottom: 10px;">âš¡ Select a date range to load customers faster:</p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <select id="accountLoadRange" style="padding: 8px 12px;">
                                    <option value="7">Last 7 Days</option>
                                    <option value="14" selected>Last 14 Days</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                    <option value="all">All Time (Slow)</option>
                                </select>
                                <button class="btn btn-success" onclick="loadShopifyCustomersForAccounts()">ðŸ“¥ Load Customers</button>
                                <span id="accountCacheStatus" style="font-size: 12px; color: #888;"></span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="refreshShopifyCustomersForAccounts()" id="accountRefreshBtn" style="display: none;">ðŸ”„ Refresh</button>
                            <span id="accountLastLoaded" style="font-size: 12px; color: #888; align-self: center;"></span>
                        </div>
                        
                        <!-- Dashboard Stats -->
                        <div id="accountCreationDashboard" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                            <div style="background: rgba(0,255,255,0.2); border: 2px solid #00ffff; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #00ffff; font-weight: bold;" id="statTotalCustomers">0</div>
                                <div style="font-size: 11px; color: #888;">TOTAL CUSTOMERS</div>
                            </div>
                            <div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #39ff14; font-weight: bold;" id="statWithAccount">0</div>
                                <div style="font-size: 11px; color: #888;">WITH ACCOUNT</div>
                            </div>
                            <div style="background: rgba(255,152,0,0.2); border: 2px solid #ff9800; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #ff9800; font-weight: bold;" id="statWithoutAccount">0</div>
                                <div style="font-size: 11px; color: #888;">WITHOUT ACCOUNT</div>
                            </div>
                        </div>
                        
                        <!-- Filters -->
                        <div id="accountControls" style="display: none; margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <input type="text" id="accountSearch" placeholder="ðŸ” Search by name or email..." oninput="filterShopifyCustomersForAccounts()" style="width: 100%;">
                                </div>
                                <div>
                                    <select id="accountFilter" onchange="filterShopifyCustomersForAccounts()">
                                        <option value="all">All Customers</option>
                                        <option value="no-account">Without Account</option>
                                        <option value="has-account">With Account</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="accountStatusFilter" onchange="filterShopifyCustomersForAccounts()">
                                        <option value="all">All Statuses</option>
                                        <option value="active">Active</option>
                                        <option value="paused">Paused</option>
                                        <option value="failed">Failed Payment</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="accountTagFilter" onchange="filterShopifyCustomersForAccounts()">
                                        <option value="all">All Tags</option>
                                        <option value="PRONUNCIATION">Pronunciation</option>
                                        <option value="KPOP">Kpop</option>
                                        <option value="KDRAMA">Kdrama</option>
                                        <option value="SURVIVAL">Survival Phrase</option>
                                        <option value="VOCABULARY">Vocabulary</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="accountDateFilter" onchange="filterShopifyCustomersForAccounts()">
                                        <option value="all">All Time</option>
                                        <option value="7">Last 7 Days</option>
                                        <option value="14">Last 14 Days</option>
                                        <option value="30">Last 30 Days</option>
                                        <option value="90">Last 3 Months</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="accountPerPage" onchange="changeAccountPerPage()">
                                        <option value="10">10 per page</option>
                                        <option value="25" selected>25 per page</option>
                                        <option value="50">50 per page</option>
                                        <option value="100">100 per page</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customers List -->
                        <div id="accountCustomersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                            <p style="color: #888; font-size: 12px;">Click "Refresh Customers" to load Shopify customers...</p>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="accountPagination" style="display: none; margin-top: 20px; text-align: center;">
                            <button class="btn btn-info btn-sm" id="accountPrevBtn" onclick="accountPrevPage()">â—€ Prev</button>
                            <span id="accountPageInfo" style="margin: 0 15px; font-size: 13px;"></span>
                            <button class="btn btn-info btn-sm" id="accountNextBtn" onclick="accountNextPage()">Next â–¶</button>
                        </div>
                    </div>
                </div>

                <div id="adminTabSettings" class="tab-content">
                    <!-- Appearance Settings -->
                    <div class="card">
                        <h3>ðŸŽ¨ Appearance</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 20px;">Customize the look and feel of the application.</p>
                        
                        <div class="settings-row">
                            <span class="settings-label">Theme Mode:</span>
                            <label class="switch" style="margin: 0;">
                                <input type="checkbox" id="themeToggle" checked onchange="toggleLightMode()">
                                <span class="slider">
                                    <span class="sun">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f9d71c">
                                            <circle cx="12" cy="12" r="5"></circle>
                                            <line x1="12" y1="1" x2="12" y2="3" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                                            <line x1="12" y1="21" x2="12" y2="23" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                                            <line x1="1" y1="12" x2="3" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                                            <line x1="21" y1="12" x2="23" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                                        </svg>
                                    </span>
                                    <span class="moon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                        </svg>
                                    </span>
                                </span>
                            </label>
                            <span style="font-size: 11px; color: #888; margin-left: 10px;">Toggle between dark and light mode</span>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3>âš™ï¸ Class Generation Settings</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 20px;">These settings control how classes are generated in the ðŸ“‹ Students section.</p>
                        <div id="settingsMessage"></div>
                        <div class="settings-row">
                            <span class="settings-label">Min Students/Class:</span>
                            <input type="number" class="settings-input" id="settingMinStudents" value="5" min="1" max="20">
                            <span style="font-size: 11px; color: #888; margin-left: 10px;">Minimum students needed to form a class</span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Max Students/Class:</span>
                            <input type="number" class="settings-input" id="settingMaxStudents" value="10" min="1" max="20">
                            <span style="font-size: 11px; color: #888; margin-left: 10px;">Maximum students allowed per class</span>
                        </div>
                        <button class="btn btn-success" onclick="saveSettings()">ðŸ’¾ Save Settings</button>
                        
                        <!-- Current Settings Display -->
                        <div style="margin-top: 20px; padding: 15px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px;">
                            <h4 style="color: #00ffff; font-size: 12px; margin-bottom: 10px;">ðŸ“Š Current Settings</h4>
                            <p style="font-size: 12px; color: #fff; margin: 5px 0;">â€¢ Classes need at least <strong id="displayMinStudents" style="color: #39ff14;">5</strong> students to be generated</p>
                            <p style="font-size: 12px; color: #fff; margin: 5px 0;">â€¢ Classes can have up to <strong id="displayMaxStudents" style="color: #39ff14;">10</strong> students maximum</p>
                        </div>
                    </div>
                    
                    <!-- Hidden fields to maintain compatibility -->
                    <input type="hidden" id="settingCurrentWeek" value="1">
                    <input type="hidden" id="settingStartDate" value="">
                    <div id="courseCalendarPreview" style="display: none;"><div id="courseCalendarGrid"></div></div>
                    
                    <!-- Database Cleanup Section -->
                    <div class="card" style="margin-top: 20px; border-color: #ff3366;">
                        <h3 style="color: #ff3366;">ðŸ§¹ Database Cleanup</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Remove orphan records and fix inconsistent data.</p>
                        <div id="cleanupMessage"></div>
                        <div id="cleanupPreview" style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; display: none;">
                            <p style="font-size: 12px; color: #ffff00; margin-bottom: 10px;">ðŸ“‹ Issues Found:</p>
                            <div id="cleanupIssuesList"></div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="scanForIssues()">ðŸ” Scan for Issues</button>
                            <button class="btn btn-warning" onclick="cleanOrphanRecords()" id="cleanOrphansBtn" disabled>ðŸ§¹ Clean Orphan Records</button>
                            <button class="btn btn-danger admin-delete-btn" onclick="resetAllData()" id="resetAllDataBtn">âš ï¸ Reset ALL Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teacher Dashboard -->
            <div id="teacherDashboard" style="display: none;">
                <div class="nav-tabs">
                    <button class="nav-tab" onclick="showTeacherTab('today')">ðŸ“… Today</button>
                    <button class="nav-tab active" onclick="showTeacherTab('myClasses')">ðŸ“š My Classes</button>
                    <button class="nav-tab" onclick="showTeacherTab('calendar')">ðŸ—“ï¸ Calendar</button>
                    <button class="nav-tab" onclick="showTeacherTab('schedule')">ðŸ“… Schedule</button>
                    <button class="nav-tab" onclick="showTeacherTab('attendance')">ðŸ“Š Attendance</button>
                    <button class="nav-tab" onclick="showTeacherTab('completed')">âœ… Completed</button>
                    <button class="nav-tab" onclick="showTeacherTab('materials')">ðŸ“– Materials</button>
                    <button class="nav-tab" onclick="showTeacherTab('suggestions')">ðŸ’¡ Suggestions</button>
                </div>
                
                <!-- Today Tab -->
                <div id="teacherTabToday" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“… Today's Classes</h3>
                        <div id="todayClassesContainer"><p style="color: #888;">Loading...</p></div>
                    </div>
                </div>
                
                <!-- My Classes Tab -->
                <div id="teacherTabMyClasses" class="tab-content active">
                    <div class="card">
                        <h3>ðŸ“š My Classes</h3>
                        <div id="teacherClassesContainer"><p style="color: #888;">Loading...</p></div>
                    </div>
                </div>
                
                <!-- Teacher Calendar Tab -->
                <div id="teacherTabCalendar" class="tab-content">
                    <div class="card">
                        <h3>ðŸ—“ï¸ Monthly Calendar</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <button class="btn btn-info" onclick="changeCalendarMonth(-1)">â—€ Prev</button>
                            <span id="teacherCalendarMonthLabel" style="font-size: 12px; color: #00ffff;"></span>
                            <button class="btn btn-info" onclick="changeCalendarMonth(1)">Next â–¶</button>
                        </div>
                        <div class="monthly-calendar" id="teacherMonthlyCalendarGrid"></div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-top: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Class Day</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #00ffff;"></div><span>Today</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff00ff;"></div><span>Course Start/End</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Teacher Schedule Tab -->
                <div id="teacherTabSchedule" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“… My Weekly Schedule</h3>
                        
                        <!-- Summary Stats for Teacher -->
                        <div class="schedule-summary" id="teacherScheduleSummary">
                            <div class="summary-box active"><div class="summary-number" id="teacherTotalClasses">0</div><div class="summary-label">MY CLASSES</div></div>
                            <div class="summary-box cyan"><div class="summary-number" id="teacherTotalStudents">0</div><div class="summary-label">TOTAL STUDENTS</div></div>
                            <div class="summary-box full"><div class="summary-number" id="teacherFullClasses">0</div><div class="summary-label">FULL CLASSES</div></div>
                            <div class="summary-box available"><div class="summary-number" id="teacherAvailableSpots">0</div><div class="summary-label">SPOTS AVAILABLE</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend">
                            <div class="legend-item"><div class="legend-bar active"></div><span>My Class</span></div>
                            <div class="legend-item"><div class="legend-bar full"></div><span>Full</span></div>
                            <div class="legend-item"><div class="legend-bar empty"></div><span>Not Assigned</span></div>
                        </div>
                        
                        <!-- Schedule Grid -->
                        <div class="schedule-grid" id="teacherScheduleGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <div id="teacherTabAttendance" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“Š Attendance History</h3>
                        <div class="form-group"><label>Select Class</label><select id="attendanceClassSelect" onchange="loadAttendanceHistory()"><option value="">-- Select --</option></select></div>
                        <div style="overflow-x: auto;"><table><thead><tr><th>Student</th><th>W1</th><th>W2</th><th>W3</th><th>W4</th><th>W5</th><th>W6</th></tr></thead><tbody id="attendanceHistoryBody"><tr><td colspan="7" style="text-align: center; color: #888;">Select a class</td></tr></tbody></table></div>
                    </div>
                </div>
                
                <!-- Completed Classes Tab -->
                <div id="teacherTabCompleted" class="tab-content">
                    <div class="card">
                        <h3>âœ… Completed Classes</h3>
                        <p style="color: #888; font-size: 12px; margin-bottom: 15px;">Track 1-Year Academy enrollment for graduated students</p>
                        
                        <!-- Date Filter -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; color: #888; margin-bottom: 5px; display: block;">Filter by completion date:</label>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-sm completed-filter-btn active" onclick="filterCompletedClasses('7')" data-days="7">Last 7 days</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('14')" data-days="14">Last 14 days</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('28')" data-days="28">Last 28 days</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('90')" data-days="90">Last 3 months</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('180')" data-days="180">Last 6 months</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('all')" data-days="all">All time</button>
                            </div>
                        </div>
                        
                        <div id="teacherCompletedClassesContainer"><p style="color: #888; font-size: 12px;">No completed classes yet.</p></div>
                    </div>
                </div>
                
                <div id="teacherTabMaterials" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“– Teaching Materials</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Select Level</label>
                                <select id="teacherMaterialLevel" onchange="loadTeacherMaterials()" data-level-select>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Select Week</label>
                                <select id="teacherMaterialWeek" onchange="loadTeacherMaterials()">
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                </select>
                            </div>
                        </div>
                        <div id="teacherMaterialsDisplay"><p style="color: #888; font-size: 14px; font-family: 'Noto Sans', sans-serif;">Select a level and week to view materials.</p></div>
                    </div>
                </div>
                
                <div id="teacherTabSuggestions" class="tab-content">
                    <div class="card">
                        <h3>ðŸ’¡ Submit a Suggestion</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Share your ideas to help improve our classes and system.</p>
                        <div id="suggestionFormMessage"></div>
                        <div class="form-group">
                            <label>Suggestion Title</label>
                            <input type="text" id="suggestionTitle" placeholder="Brief title for your suggestion">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="suggestionDescription" rows="4" placeholder="Describe your suggestion in detail..." style="width: 100%; font-family: 'Noto Sans', sans-serif; font-size: 12px; padding: 10px; background: #1a1a2e; color: #fff; border: 2px solid #333; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Priority Level</label>
                            <div style="display: flex; gap: 10px; margin-top: 8px;">
                                <button type="button" class="priority-btn" id="priorityHigh" onclick="selectPriority('high')">ðŸ”´ High</button>
                                <button type="button" class="priority-btn" id="priorityMid" onclick="selectPriority('mid')">ðŸŸ¡ Mid</button>
                                <button type="button" class="priority-btn" id="priorityLow" onclick="selectPriority('low')">ðŸŸ¢ Low</button>
                            </div>
                            <input type="hidden" id="suggestionPriority" value="">
                        </div>
                        <button class="btn btn-success" onclick="submitSuggestion()">ðŸ“¤ Submit Suggestion</button>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3>ðŸ“‹ My Previous Suggestions</h3>
                        <div id="teacherSuggestionsContainer"><p style="color: #888; font-size: 12px;">No suggestions submitted yet.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Level Modal -->
    <div class="modal-overlay" id="levelModal">
        <div class="modal">
            <button class="modal-close" onclick="closeLevelModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“ Assign Class</h3>
            <p style="font-size: 13px; margin-bottom: 15px;">Student: <span id="modalStudentName" style="color: #00ffff;"></span></p>
            <div id="levelModalMessage"></div>
            <div class="form-group"><label>Select Class</label>
                <select id="levelSelect" data-level-select><!-- Populated dynamically --></select>
            </div>
            <input type="hidden" id="modalStudentId">
            <button class="btn btn-success" onclick="assignStudentLevel()">âœ“ Assign</button>
        </div>
    </div>

    <!-- Material Modal -->
    <div class="modal-overlay" id="materialModal">
        <div class="modal">
            <button class="modal-close" onclick="closeMaterialModal()">âœ•</button>
            <h3 class="modal-title" id="materialModalTitle">Add Material</h3>
            <div id="materialModalMessage"></div>
            <div id="materialFormContainer"></div>
            <input type="hidden" id="editingMaterialId">
            <input type="hidden" id="editingMaterialType">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveMaterial()">ðŸ’¾ Save</button>
                <button class="btn btn-info" id="testYodafyBtn" onclick="testYodafyFromMaterial()" style="display: none;">ðŸ§ª Test</button>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div class="modal-overlay" id="warningModal">
        <div class="modal">
            <button class="modal-close" onclick="closeWarningModal()">âœ•</button>
            <h3 class="modal-title" style="color: #ffff00;">âš ï¸ Warning</h3>
            <p id="warningMessage" style="font-size: 13px; margin-bottom: 20px;"></p>
            <button class="btn btn-success" onclick="confirmWarningAction()">Proceed</button>
            <button class="btn btn-secondary" onclick="closeWarningModal()">Cancel</button>
        </div>
    </div>

    <!-- Absence Reason Modal -->
    <div class="modal-overlay" id="absenceModal">
        <div class="modal">
            <button class="modal-close" onclick="closeAbsenceModal()">âœ•</button>
            <h3 class="modal-title" style="color: #ff3366;">ðŸ“ Absence Reason</h3>
            <p style="font-size: 13px; margin-bottom: 15px;">Student: <span id="absenceStudentName" style="color: #00ffff;"></span></p>
            <p style="font-size: 13px; margin-bottom: 20px;">Did the student give a reason for their absence?</p>
            <input type="hidden" id="absenceClassId">
            <input type="hidden" id="absenceStudentId">
            <div id="absenceReasonForm" style="display: none; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Reason for Absence</label>
                    <textarea id="absenceReasonText" rows="3" placeholder="Enter the reason..."></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="showAbsenceReasonForm()">âœ“ Yes, has reason</button>
                <button class="btn btn-danger" onclick="markAbsentNoReason()">âœ— No reason given</button>
            </div>
            <div id="absenceSubmitBtn" style="display: none; margin-top: 15px;">
                <button class="btn btn-primary" onclick="submitAbsenceWithReason()">ðŸ’¾ Save Absence with Reason</button>
            </div>
        </div>
    </div>

    <!-- Edit Start Date Modal -->
    <div class="modal-overlay" id="editStartDateModal">
        <div class="modal" style="max-width: 400px;">
            <button class="modal-close" onclick="closeEditStartDateModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“… Edit Class Start Date</h3>
            <div id="editStartDateClassInfo" style="margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;"></div>
            <input type="hidden" id="editStartDateClassId">
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="editStartDateInput" style="width: 100%;">
            </div>
            <div id="editStartDateMessage" style="margin-bottom: 15px;"></div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveClassStartDate()" style="flex: 1;">ðŸ’¾ Save</button>
                <button class="btn btn-secondary" onclick="closeEditStartDateModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Class Details Modal -->
    <div class="modal-overlay" id="classDetailsModal">
        <div class="modal" style="max-width: 700px;">
            <button class="modal-close" onclick="closeClassDetailsModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“š Class Details</h3>
            <div id="classDetailsHeader" style="margin-bottom: 20px;"></div>
            <div id="classDetailsMessage"></div>
            <h4 style="color: #ffff00; font-size: 14px; margin-bottom: 15px;">ðŸ‘¥ Students in this Class</h4>
            <div id="classStudentsList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Course Start Date Modal -->
    <div class="modal-overlay" id="startDateModal">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="cancelStartDateModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“… Preview & Set Class Start Dates</h3>
            <p style="font-size: 13px; margin-bottom: 15px; color: #888;">Select a teacher first (their availability will be considered), then review class groupings.</p>
            
            <!-- Teacher Selection -->
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px;">
                <h4 style="color: #00ffff; font-size: 14px; margin-bottom: 10px;">ðŸ‘¨â€ðŸ« Select Teacher for Auto-Generation</h4>
                <p style="font-size: 11px; color: #888; margin-bottom: 10px;">Classes will only be generated for times when this teacher is available.</p>
                <div id="teacherSelectionButtons" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <!-- Teacher buttons will be inserted here -->
                </div>
                <div id="selectedTeacherInfo" style="display: none; margin-top: 10px; padding: 10px; background: rgba(57,255,20,0.1); border-radius: 5px;">
                    <span style="color: #39ff14; font-size: 12px;">âœ“ Selected: <strong id="selectedTeacherName"></strong></span>
                    <span id="selectedTeacherDays" style="color: #888; font-size: 11px; margin-left: 10px;"></span>
                </div>
            </div>
            
            <div id="classPreviewContainer" style="margin-bottom: 20px;">
                <p style="color: #888; font-size: 12px;">Select a teacher above to generate class previews...</p>
            </div>
            
            <div id="limboPreviewContainer" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(255,51,102,0.1); border: 2px solid #ff3366; border-radius: 8px;">
                <h4 style="color: #ff3366; font-size: 14px; margin-bottom: 10px;">âš ï¸ Students Without Enough Classmates (Limbo)</h4>
                <p style="font-size: 11px; color: #888; margin-bottom: 10px;">These students don't have enough classmates with matching availability. They will be marked as "limbo".</p>
                <div id="limboStudentsList"></div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; padding-top: 15px; border-top: 2px solid #333;">
                <button class="btn btn-success" onclick="confirmAutoGenerate()" id="generateProposalsBtn" disabled>âœ“ Generate Proposals</button>
                <button class="btn btn-secondary" onclick="cancelStartDateModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Move Student Modal -->
    <div class="modal-overlay" id="moveStudentModal">
        <div class="modal" style="max-width: 600px;">
            <button class="modal-close" onclick="closeMoveStudentModal()">âœ•</button>
            <h3 class="modal-title">ðŸ”„ Move Student</h3>
            <p style="font-size: 13px; margin-bottom: 15px;">Student: <span id="moveStudentName" style="color: #00ffff;"></span></p>
            <input type="hidden" id="moveStudentId">
            <input type="hidden" id="moveFromClassId">
            <div style="margin-bottom: 15px;">
                <label class="checkbox-label">
                    <input type="checkbox" id="returnToPoolCheckbox" onchange="toggleMoveOptions()">
                    <span style="font-size: 12px;">Return to student pool (schedule changed, needs reassignment)</span>
                </label>
            </div>
            <div id="moveToClassSection">
                <h4 style="color: #ffff00; font-size: 14px; margin-bottom: 10px;">Select destination class:</h4>
                <div id="moveClassOptions" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="confirmMoveStudent()">âœ“ Confirm Move</button>
                <button class="btn btn-secondary" onclick="closeMoveStudentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal-overlay" id="studentDetailsModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeStudentDetailsModal()">âœ•</button>
            <h3 class="modal-title">ðŸ‘¤ Student Details</h3>
            <div id="studentDetailsContent" style="padding: 15px 0;">
                <p style="color: #888; font-size: 12px;">Loading...</p>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeStudentDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Student Analytics Menu Popup -->
    <div class="modal-overlay" id="studentAnalyticsMenuModal">
        <div class="modal" style="max-width: 400px;">
            <button class="modal-close" onclick="closeStudentAnalyticsMenu()">âœ•</button>
            <h3 class="modal-title">ðŸ“Š <span id="analyticsStudentName">Student</span> Analytics</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 20px; text-align: center;">Select an analytics category to view</p>
            <div style="display: grid; gap: 12px;">
                <button class="btn" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 14px;" onclick="openAnalyticsDatePicker('pronunciation')">
                    ðŸŽ¤ Pronunciation Analytics
                </button>
                <button class="btn" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); font-size: 14px;" onclick="openAnalyticsDatePicker('grammar')">
                    ðŸ“– Grammar Analytics
                </button>
                <button class="btn" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); font-size: 14px;" onclick="openAnalyticsDatePicker('vocabulary')">
                    ðŸ“š Vocabulary Analytics
                </button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeStudentAnalyticsMenu()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Analytics Date Picker Modal -->
    <div class="modal-overlay" id="analyticsDatePickerModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeAnalyticsDatePicker()">âœ•</button>
            <h3 class="modal-title" id="analyticsDatePickerTitle">ðŸ“Š Select Date</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px; text-align: center;">Select a date to view analytics</p>
            <div id="analyticsDatesList" style="max-height: 400px; overflow-y: auto;">
                <p style="color: #888; font-size: 12px; text-align: center;">Loading dates...</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAnalyticsDatePicker()">Back</button>
            </div>
        </div>
    </div>

    <!-- Analytics Display Modal -->
    <div class="modal-overlay" id="analyticsDisplayModal">
        <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeAnalyticsDisplay()">âœ•</button>
            <h3 class="modal-title" id="analyticsDisplayTitle">ðŸ“Š Analytics</h3>
            <div id="analyticsDisplayContent" style="padding: 15px 0;">
                <p style="color: #888; font-size: 12px; text-align: center;">Loading analytics...</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAnalyticsDisplay()">Close</button>
            </div>
        </div>
    </div>

    <!-- Existing Student Search Modal -->
    <div class="modal-overlay" id="existingStudentSearchModal">
        <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeExistingStudentSearch()">âœ•</button>
            <h3 class="modal-title">ðŸ” Add Existing Student</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Search for students who already have an account in the evaluation system.</p>
            
            <div class="form-group">
                <label>Search by Name or Email</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="existingStudentSearchInput" placeholder="Enter name or email..." oninput="searchExistingStudents()" style="flex: 1;">
                    <button class="btn btn-info" onclick="searchExistingStudents()">ðŸ” Search</button>
                </div>
            </div>
            
            <div id="existingStudentSearchResults" style="margin-top: 20px;">
                <p style="color: #888; font-size: 12px; text-align: center;">Enter a name or email to search...</p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeExistingStudentSearch()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Existing Student Form Modal -->
    <div class="modal-overlay" id="addExistingStudentFormModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeAddExistingStudentForm()">âœ•</button>
            <h3 class="modal-title">âž• Add to Registered Students</h3>
            
            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="font-size: 14px; color: #00ffff; margin: 0 0 5px 0;" id="addExistingStudentName">Student Name</p>
                <p style="font-size: 12px; color: #888; margin: 0;" id="addExistingStudentEmail">student@email.com</p>
            </div>
            
            <input type="hidden" id="addExistingStudentUid">
            
            <div class="form-group">
                <label>Phone Number <span style="color: #888; font-size: 11px;">(Optional)</span></label>
                <input type="tel" id="addExistingStudentPhone" placeholder="Phone number">
            </div>
            
            <div class="form-group">
                <label>Discord Username <span style="color: #888; font-size: 11px;">(Optional)</span></label>
                <input type="text" id="addExistingStudentDiscord" placeholder="Discord username">
            </div>
            
            <div class="form-group">
                <label>Country</label>
                <select id="addExistingStudentCountry">
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="GB">United Kingdom</option>
                    <option value="AU">Australia</option>
                    <option value="KR">South Korea</option>
                    <option value="JP">Japan</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Timezone</label>
                <select id="addExistingStudentTimezone">
                    <option value="America/New_York">Eastern Time (ET)</option>
                    <option value="America/Chicago">Central Time (CT)</option>
                    <option value="America/Denver">Mountain Time (MT)</option>
                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    <option value="America/Anchorage">Alaska Time (AKT)</option>
                    <option value="Pacific/Honolulu">Hawaii Time (HST)</option>
                    <option value="Europe/London">London (GMT/BST)</option>
                    <option value="Europe/Paris">Paris/Berlin (CET)</option>
                    <option value="Asia/Seoul">Seoul (KST)</option>
                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                    <option value="Australia/Sydney">Sydney (AEST)</option>
                    <option value="Australia/Perth">Perth (AWST)</option>
                </select>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-success" onclick="confirmAddExistingStudent()">âœ… Add Student</button>
                <button class="btn btn-secondary" onclick="closeAddExistingStudentForm()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Community Reminder Modal (for teachers on Week 6) -->
    <div class="modal-overlay" id="communityReminderModal">
        <div class="modal" style="text-align: center; max-width: 600px;">
            <button class="modal-close" onclick="closeCommunityReminderModal()">âœ•</button>
            <h3 class="modal-title" style="color: #ff00ff;">ðŸŽ‰ Final Week Reminder!</h3>
            <div style="font-size: 50px; margin: 20px 0;">ðŸŽ“</div>
            <p style="font-size: 14px; color: #ffff00; margin-bottom: 15px;">This is the LAST WEEK of the 6-week course!</p>
            <p style="font-size: 13px; color: #888; margin-bottom: 20px;">Please remind your students about the <strong style="color: #00ffff;">KoreanLearnin Community</strong> programs!</p>
            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                <p style="font-size: 13px; color: #00ffff; margin-bottom: 10px;">ðŸ—£ï¸ Suggested script:</p>
                <p style="font-size: 12px; color: #fff; font-style: italic; margin-bottom: 10px;">"Congratulations on finishing the course! If you'd like to continue learning and get conversational in Korean within 1 year, consider joining our programs!"</p>
            </div>
            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left;">
                <p style="font-size: 14px; color: #39ff14; margin-bottom: 10px; text-align: center;">ðŸ’° Pricing Options</p>
                <p style="font-size: 12px; color: #fff; margin-bottom: 8px;"><strong style="color: #ffff00;">ðŸŒŸ 1-Year Mastery Program:</strong> $500/year</p>
                <p style="font-size: 11px; color: #888; margin-bottom: 10px; padding-left: 20px;">â†’ Since you paid $200 for this course, it's only <strong style="color: #39ff14;">$300</strong> to upgrade!</p>
                <p style="font-size: 11px; color: #ff9900; margin-bottom: 10px; padding-left: 20px;">âš¡ Sign up THIS WEEK to get a $200 discount code!</p>
                <p style="font-size: 12px; color: #fff;"><strong style="color: #00ffff;">ðŸ“… Monthly Program:</strong> $89/month</p>
            </div>
            <button class="btn btn-success" onclick="closeCommunityReminderModal()">Got it! ðŸ‘</button>
        </div>
    </div>

    <!-- Class Attendance Complete Modal (for teachers after marking all students in Week 6) -->
    <div class="modal-overlay" id="classCompleteReminderModal">
        <div class="modal" style="text-align: center; max-width: 600px;">
            <button class="modal-close" onclick="closeClassCompleteReminderModal()">âœ•</button>
            <h3 class="modal-title" style="color: #ff00ff;">ðŸŽ‰ All Students Marked!</h3>
            <div style="font-size: 50px; margin: 20px 0;">âœ…</div>
            <p style="font-size: 14px; color: #ffff00; margin-bottom: 15px;">You've marked attendance for all students in the final week!</p>
            <p style="font-size: 13px; color: #888; margin-bottom: 20px;">Don't forget to ask them about continuing their Korean journey!</p>
            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left;">
                <p style="font-size: 14px; color: #39ff14; margin-bottom: 12px; text-align: center;">ðŸ’¬ Remind your students:</p>
                <p style="font-size: 12px; color: #fff; margin-bottom: 10px;"><strong style="color: #ffff00;">ðŸŒŸ 1-Year Mastery Program:</strong> Get conversational in Korean within 1 year!</p>
                <p style="font-size: 12px; color: #fff; margin-bottom: 5px; padding-left: 15px;">â€¢ Regular price: $500/year</p>
                <p style="font-size: 12px; color: #39ff14; margin-bottom: 5px; padding-left: 15px;">â€¢ Your class fee ($200) rolls into it = <strong>Only $300!</strong></p>
                <p style="font-size: 12px; color: #ff9900; margin-bottom: 15px; padding-left: 15px;">âš¡ Must sign up THIS WEEK to get the $200 discount code!</p>
                <p style="font-size: 12px; color: #fff;"><strong style="color: #00ffff;">ðŸ“… Monthly Program:</strong> $89/month - no commitment!</p>
            </div>
            <button class="btn btn-success" onclick="closeClassCompleteReminderModal()">Got it! ðŸ‘</button>
        </div>
    </div>

    <!-- Calendar Class Picker Modal -->
    <div class="modal-overlay" id="calendarClassPickerModal">
        <div class="modal" style="max-width: 400px;">
            <button class="modal-close" onclick="closeCalendarClassPicker()">âœ•</button>
            <h3 class="modal-title">ðŸ“… Classes on this Day</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Click a class to view details:</p>
            <div id="calendarClassPickerList" style="display: grid; gap: 10px;"></div>
        </div>
    </div>

    <!-- Shopify Listing Generator Modal -->
    <div class="modal-overlay" id="shopifyListingModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('shopifyListingModal')">âœ•</button>
            <h3 class="modal-title">ðŸ›’ Shopify Listing Generator</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Generate copy-paste ready text for Shopify product listings.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <div class="form-group">
                        <label>Class Type *</label>
                        <select id="shopifyClassType" data-level-select onchange="generateShopifyListing()">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Day *</label>
                        <select id="shopifyClassDay" onchange="updateShopifyDateOptions(); generateShopifyListing()" disabled>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Time (EST) *</label>
                        <select id="shopifyClassTime" onchange="generateShopifyListing()" disabled>
                            <option value="6:30 PM">6:30 PM EST</option>
                            <option value="7:10 PM">7:10 PM EST</option>
                            <option value="7:50 PM">7:50 PM EST</option>
                            <option value="8:30 PM">8:30 PM EST</option>
                            <option value="9:10 PM">9:10 PM EST</option>
                            <option value="9:50 PM">9:50 PM EST</option>
                            <option value="10:30 PM">10:30 PM EST</option>
                            <option value="11:10 PM">11:10 PM EST</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Date *</label>
                        <div id="shopifyDateOptions" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
                        <input type="hidden" id="shopifyStartDate">
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <select id="shopifyDuration" onchange="generateShopifyListing()">
                            <option value="6">6 Weeks</option>
                            <option value="4">4 Weeks</option>
                            <option value="8">8 Weeks</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Additional Text (optional)</label>
                        <textarea id="shopifyAdditionalText" rows="4" placeholder="Any additional information to include..." onchange="generateShopifyListing()"></textarea>
                    </div>
                    <div class="form-group">
                        <label>What Students Will Learn (optional)</label>
                        <textarea id="shopifyWhatLearn" rows="4" placeholder="â€¢ Conversational Korean phrases&#10;â€¢ Pronunciation practice&#10;â€¢ Cultural context" onchange="generateShopifyListing()"></textarea>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.5); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="color: #00ffff; font-weight: bold;">Generated Listing:</label>
                    <button class="btn btn-success btn-sm" onclick="copyShopifyListing()">ðŸ“‹ Copy to Clipboard</button>
                </div>
                <pre id="shopifyListingOutput" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; white-space: pre-wrap; font-size: 12px; max-height: 300px; overflow-y: auto; color: #e2e8f0;"></pre>
            </div>
            
            <button class="btn btn-secondary" onclick="closeModal('shopifyListingModal')" style="width: 100%;">Close</button>
        </div>
    </div>

    <!-- Slot Details Modal -->
    <div class="modal-overlay" id="slotDetailsModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('slotDetailsModal')">âœ•</button>
            <h3 class="modal-title" id="slotDetailsTitle">ðŸ“… Slot Details</h3>
            <div id="slotDetailsContent" style="margin: 15px 0;">
                <p style="color: #888;">Loading...</p>
            </div>
            
            <!-- Student Roster (shown for occupied slots) -->
            <div id="slotStudentRoster" style="display: none; margin: 15px 0;">
                <h4 style="color: #00ffff; margin-bottom: 10px;">ðŸ‘¥ Student Roster</h4>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 8px;">Name</th>
                                <th style="text-align: left; padding: 8px;">Phone</th>
                                <th style="text-align: left; padding: 8px;">Discord</th>
                                <th style="text-align: left; padding: 8px;">Email</th>
                            </tr>
                        </thead>
                        <tbody id="slotStudentRosterBody"></tbody>
                    </table>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-sm btn-info" onclick="copyStudentEmails()">ðŸ“‹ Copy Emails</button>
                    <button class="btn btn-sm btn-success" onclick="copyClassInfoEmail()">ðŸ“§ Copy Class Info Email</button>
                </div>
            </div>
            
            <!-- Date Selection (for scheduling) -->
            <div id="slotDateSelection" style="display: none; margin: 15px 0; padding: 15px; background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px;">
                <h4 style="color: #39ff14; margin-bottom: 10px;">ðŸ“… Schedule Next Session</h4>
                <p style="font-size: 11px; color: #888; margin-bottom: 10px;">Select a start date (3-week buffer included):</p>
                <div id="slotDateOptions" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                
                <div id="prescheduleForm" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #39ff14;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 11px;">Class Type *</label>
                            <select id="prescheduleClassType" data-level-select style="font-size: 12px;"></select>
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 11px;">Teacher *</label>
                            <select id="prescheduleTeacher" style="font-size: 12px;"></select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="confirmPreschedule()" style="width: 100%;">âœ“ Pre-schedule This Slot</button>
                </div>
            </div>
            
            <!-- Pre-scheduled Info (for X slots) -->
            <div id="slotPrescheduleInfo" style="display: none; margin: 15px 0; padding: 15px; background: rgba(255,152,0,0.1); border: 2px solid #ff9800; border-radius: 8px;">
                <h4 style="color: #ff9800; margin-bottom: 10px;">â³ Pre-scheduled</h4>
                <div id="prescheduleDetails"></div>
                <button class="btn btn-danger btn-sm" onclick="cancelPreschedule()" style="margin-top: 10px;">âŒ Cancel Pre-schedule</button>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
                <button class="btn btn-info" onclick="useSlotForShopify()">ðŸ›’ Shopify Listing</button>
                <button class="btn btn-secondary" onclick="closeModal('slotDetailsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div class="modal-overlay" id="pdfPreviewModal">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('pdfPreviewModal')">âœ•</button>
            <h3 class="modal-title">ðŸ‘ï¸ PDF Preview</h3>
            <div id="pdfPreviewContent" style="background: #fff; color: #000; padding: 30px; border-radius: 8px; margin: 15px 0;">
                <!-- PDF preview will be rendered here -->
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="generateStudentPdf()">ðŸ“„ Generate PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('pdfPreviewModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Account Modal -->
    <div class="modal-overlay" id="createAccountModal">
        <div class="modal" style="max-width: 450px;">
            <button class="modal-close" onclick="closeCreateAccountModal()">âœ•</button>
            <h3 class="modal-title">ðŸ‘¤ Create Customer Account</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Create a Firebase account for this Shopify customer so they can log in.</p>
            
            <div id="createAccountMessage"></div>
            
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="createAcctName" readonly style="background: rgba(255,255,255,0.1);">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="createAcctEmail" readonly style="background: rgba(255,255,255,0.1);">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="createAcctPhone" readonly style="background: rgba(255,255,255,0.1);">
            </div>
            <div class="form-group">
                <label>Location</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="createAcctCity" readonly style="background: rgba(255,255,255,0.1); flex: 1;" placeholder="City">
                    <input type="text" id="createAcctState" readonly style="background: rgba(255,255,255,0.1); width: 80px;" placeholder="State">
                </div>
            </div>
            <div class="form-group">
                <label>Tags</label>
                <input type="text" id="createAcctTags" readonly style="background: rgba(255,255,255,0.1); font-size: 11px;">
            </div>
            <input type="hidden" id="createAcctShopifyId">
            <div class="form-group">
                <label>Password *</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="createAcctPassword" placeholder="Min 6 characters" style="flex: 1;">
                    <button type="button" class="btn btn-info btn-sm" onclick="generatePassword()" style="white-space: nowrap;">ðŸ”‘ PW Gen</button>
                </div>
            </div>
            <div class="form-group">
                <label>Confirm Password *</label>
                <input type="text" id="createAcctPasswordConfirm" placeholder="Re-enter password">
            </div>
            
            <button class="btn btn-success btn-block" id="submitCreateAcctBtn" onclick="submitCreateCustomerAccount()">
                âœ… CREATE ACCOUNT
            </button>
        </div>
    </div>

    <!-- Add Class Type Modal -->
    <div class="modal-overlay" id="addClassTypeModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeModal('addClassTypeModal')">âœ•</button>
            <h3 class="modal-title">âž• Add New Class Type</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Create a new class type (e.g., Kdrama Phrase Class, Kpop Phrase Class)</p>
            
            <div class="form-group">
                <label>Class Type ID (lowercase, no spaces) *</label>
                <input type="text" id="classTypeId" placeholder="e.g., kdrama, kpop, topik" oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9]/g, '')">
            </div>
            <div class="form-group">
                <label>Display Name *</label>
                <input type="text" id="classTypeName" placeholder="e.g., Kdrama Phrase Class">
            </div>
            <div class="form-group">
                <label>Color (for badges)</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#ff00ff" checked> <span style="color: #ff00ff;">â— Magenta</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#00ffff"> <span style="color: #00ffff;">â— Cyan</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#39ff14"> <span style="color: #39ff14;">â— Green</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#ffff00"> <span style="color: #ffff00;">â— Yellow</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#ff6600"> <span style="color: #ff6600;">â— Orange</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#ff3366"> <span style="color: #ff3366;">â— Pink</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#9966ff"> <span style="color: #9966ff;">â— Purple</span></label>
                </div>
            </div>
            <div class="form-group">
                <label>Number of Weeks</label>
                <input type="number" id="classTypeWeeks" value="6" min="1" max="52">
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <textarea id="classTypeDescription" placeholder="Brief description of this class type..." style="height: 60px;"></textarea>
            </div>
            
            <button class="btn btn-success btn-block" onclick="saveClassType()">âœ… Create Class Type</button>
            
            <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <h4 style="color: #ff3366; font-size: 13px; margin-bottom: 10px;">Existing Class Types</h4>
                <div id="existingClassTypesList" style="font-size: 12px; color: #888;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div class="modal-overlay" id="addClassModal">
        <div class="modal" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModal('addClassModal')">âœ•</button>
            <h3 class="modal-title">âž• Add New Class</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Manually create a class for any class type</p>
            
            <div class="form-group">
                <label>Class Type *</label>
                <select id="addClassType">
                    <option value="">-- Select Class Type --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Day *</label>
                <select id="addClassDay">
                    <option value="">-- Select Day --</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                </select>
            </div>
            <div class="form-group">
                <label>Time (EST) *</label>
                <select id="addClassTime">
                    <option value="">-- Select Time --</option>
                    <option value="6:30 PM">6:30 PM</option>
                    <option value="7:10 PM">7:10 PM</option>
                    <option value="7:50 PM">7:50 PM</option>
                    <option value="8:30 PM">8:30 PM</option>
                    <option value="9:10 PM">9:10 PM</option>
                    <option value="9:50 PM">9:50 PM</option>
                    <option value="10:30 PM">10:30 PM</option>
                    <option value="11:10 PM">11:10 PM</option>
                </select>
            </div>
            <div class="form-group">
                <label>Start Date *</label>
                <input type="date" id="addClassStartDate">
            </div>
            <div class="form-group">
                <label>Assign Teacher (optional)</label>
                <select id="addClassTeacher">
                    <option value="">-- No Teacher --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Max Students</label>
                <input type="number" id="addClassMaxStudents" value="10" min="1" max="50">
            </div>
            
            <button class="btn btn-success btn-block" onclick="saveNewClass()">âœ… Create Class</button>
        </div>
    </div>

    <!-- Sales Chat Modal (Full Screen) -->
    <div class="sales-modal-overlay" id="salesChatModal">
        <div class="sales-modal">
            <!-- Left Sidebar: Chat List -->
            <aside class="sales-sidebar" id="salesSidebar">
                <div class="sales-sidebar-header">
                    <div class="sales-sidebar-title">
                        <h2>ðŸ’¬ <span>Sales</span> Chat</h2>
                        <div style="display: flex; gap: 6px;">
                            <button class="sales-close-btn" onclick="openSalesDragOverlay()" title="Grid View">ðŸ“‹</button>
                            <button class="sales-close-btn" onclick="openSalesFeedbackPanel()" title="AI Feedback">ðŸ’¬</button>
                            <button class="sales-close-btn" onclick="openSalesSettingsModal()" title="Settings">âš™ï¸</button>
                            <button class="sales-close-btn" onclick="closeSalesChatModal()">Ã—</button>
                        </div>
                    </div>
                    <button class="sales-new-chat-btn" onclick="startNewSalesChat()">+ New Conversation</button>
                </div>
                
                <div class="sales-filter-tabs">
                    <button class="sales-filter-tab active" data-filter="all" onclick="filterSalesChats('all')">All <span class="count" id="salesCountAll">0</span></button>
                    <button class="sales-filter-tab" data-filter="red" onclick="filterSalesChats('red')">ðŸ”¥ Hot <span class="count" id="salesCountRed">0</span></button>
                    <button class="sales-filter-tab" data-filter="yellow" onclick="filterSalesChats('yellow')">ðŸ’› Warm <span class="count" id="salesCountYellow">0</span></button>
                    <button class="sales-filter-tab" data-filter="grey" onclick="filterSalesChats('grey')">â„ï¸ Cold <span class="count" id="salesCountGrey">0</span></button>
                    <button class="sales-filter-tab" data-filter="downsell" onclick="filterSalesChats('downsell')">ðŸ¦Š Ready <span class="count" id="salesCountDownsell">0</span></button>
                </div>
                
                <div class="sales-chat-list" id="salesChatList">
                    <!-- Chat cards rendered here -->
                </div>
            </aside>
            
            <!-- Main Chat Area -->
            <main class="sales-main-area" id="salesMainArea">
                <!-- Slot Context Banner (shown when slot is selected) -->
                <div class="sales-slot-context" id="salesSlotContext" style="display: none; flex-shrink: 0;">
                    <div class="sales-slot-context-icon">ðŸ“…</div>
                    <div class="sales-slot-context-info">
                        <div class="sales-slot-context-title" id="salesSlotTitle">Saturday @ 8:30 PM EST</div>
                        <div class="sales-slot-context-details" id="salesSlotDetails">Beginner â€¢ Calvin â€¢ Starts Jan 18</div>
                    </div>
                    <div class="sales-slot-context-seats" id="salesSlotSeats"></div>
                </div>
                
                <!-- Empty State -->
                <div class="sales-empty-state" id="salesEmptyState" style="flex: 1; min-height: 0; overflow-y: auto;">
                    <div class="sales-empty-state-icon">ðŸ’¬</div>
                    <h3>Start a Conversation</h3>
                    <p>Paste the customer's first message below to begin a sales conversation for this slot.</p>
                    
                    <div style="width: 100%; max-width: 500px; margin-top: 24px;">
                        <textarea class="sales-message-input" id="salesNewChatInput" placeholder="Paste customer's message here..." rows="4" style="width: 100%; min-height: 100px;" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); createSalesChatFromMessage(); }"></textarea>
                        <button class="sales-send-btn" style="width: 100%; margin-top: 12px;" onclick="createSalesChatFromMessage()">âœ¨ Create Chat & Get AI Response</button>
                        <p style="font-size: 10px; color: #666; margin-top: 8px; text-align: center;">Press Enter to send â€¢ Shift+Enter for new line</p>
                    </div>
                </div>
                
                <!-- Active Chat View -->
                <div id="salesActiveChat" style="display: none; flex: 1; flex-direction: column; min-height: 0; overflow: hidden;">
                    <div class="sales-chat-header">
                        <div class="sales-chat-header-left">
                            <div class="sales-chat-header-avatar" id="salesChatAvatar">?</div>
                            <div class="sales-chat-header-info">
                                <div class="sales-chat-header-name" id="salesChatName">Customer Name</div>
                                <div class="sales-chat-header-details" id="salesChatDetails">
                                    <span>ðŸ“ Unknown</span>
                                    <span>ðŸŽ¯ Unknown</span>
                                </div>
                            </div>
                        </div>
                        <div class="sales-chat-header-actions">
                            <button class="sales-header-btn" onclick="openSalesAddResponseModal()">ðŸ“¤ Add Sent</button>
                            <button class="sales-header-btn" onclick="generateSalesSummary()">ðŸ“‹ Summary</button>
                            <button class="sales-header-btn success" id="salesAddStudentBtn" onclick="addStudentToSlotFromChat()" style="display: none;">âœ… Add to Slot</button>
                            <button class="sales-header-btn danger" onclick="deleteSalesChat()">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                    
                    <div class="sales-messages-container" id="salesMessagesContainer" style="flex: 1; min-height: 0; overflow-y: auto;">
                        <!-- Messages rendered here -->
                    </div>
                    
                    <div class="sales-input-area" style="flex-shrink: 0;">
                        <div class="sales-input-wrapper">
                            <div class="sales-input-container">
                                <div class="sales-input-label">ðŸ“¥ Paste customer's reply: <span style="font-size: 10px; color: #666;">(Enter to send)</span></div>
                                <textarea class="sales-message-input" id="salesMessageInput" placeholder="Paste what the customer replied..." rows="2" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendSalesMessage(); }"></textarea>
                            </div>
                            <button class="sales-send-btn" id="salesSendBtn" onclick="sendSalesMessage()">âœ¨ Get AI Response</button>
                        </div>
                        <!-- Context-Aware Quick Suggestions -->
                        <div class="sales-context-recommendations" id="salesContextRecommendations" style="display: none;">
                            <span class="sales-context-label">ðŸŽ¯ Recommended:</span>
                            <div class="sales-context-buttons" id="salesContextButtons"></div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Suggestions Sidebar -->
            <aside class="sales-suggestions-sidebar" id="salesSuggestionsSidebar">
                <div class="sales-suggestions-header">
                    <h3>ðŸ’¡ Smart Suggestions</h3>
                    <button class="sales-suggestion-add-btn" onclick="quickAddSuggestion()" title="Quick Add">âž•</button>
                </div>
                
                <!-- Search Bar -->
                <div class="sales-suggestions-search">
                    <input type="text" id="salesSuggestionSearch" placeholder="ðŸ” Search suggestions..." oninput="filterSalesSuggestions()">
                </div>
                
                <!-- Filter Tags -->
                <div class="sales-suggestions-filters">
                    <button class="sales-filter-chip active" data-filter="all" onclick="filterSuggestionsByTag('all')">All</button>
                    <button class="sales-filter-chip" data-filter="favorite" onclick="filterSuggestionsByTag('favorite')">â­</button>
                    <button class="sales-filter-chip" data-filter="objection" onclick="filterSuggestionsByTag('objection')">ðŸš§</button>
                    <button class="sales-filter-chip" data-filter="template" onclick="filterSuggestionsByTag('template')">ðŸ“</button>
                    <button class="sales-filter-chip" data-filter="closing" onclick="filterSuggestionsByTag('closing')">ðŸŽ¯</button>
                </div>
                
                <!-- Quick Links -->
                <div class="sales-quick-links">
                    <button class="sales-quick-link-btn" onclick="insertQuickLink('registration')" title="Insert Registration Link">ðŸ”— Registration</button>
                    <button class="sales-quick-link-btn" onclick="insertQuickLink('discord')" title="Insert Discord Link">ðŸ’¬ Discord</button>
                    <button class="sales-quick-link-btn" onclick="insertQuickLink('promo')" title="Insert Promo Link">ðŸŽ Promo</button>
                </div>
                
                <div class="sales-suggestions-content" id="salesSuggestionsContent">
                    <!-- Favorites Section -->
                    <div class="sales-suggestion-section" id="salesFavoritesSection" style="display: none;">
                        <div class="sales-suggestion-title">â­ Favorites</div>
                        <div id="salesFavoritesList"></div>
                    </div>
                    
                    <!-- Objection Handlers -->
                    <div class="sales-suggestion-section" data-category="objection">
                        <div class="sales-suggestion-title">ðŸš§ Objection Handlers <button class="sales-section-add-btn" onclick="quickAddSuggestion('objection')">+</button></div>
                        <div id="salesObjectionHandlersList"></div>
                    </div>
                    
                    <!-- Templates -->
                    <div class="sales-suggestion-section" data-category="template">
                        <div class="sales-suggestion-title">ðŸ“ Templates <button class="sales-section-add-btn" onclick="quickAddSuggestion('template')">+</button></div>
                        <div id="salesTemplatesList2"></div>
                    </div>
                    
                    <!-- Closing Scripts -->
                    <div class="sales-suggestion-section" data-category="closing">
                        <div class="sales-suggestion-title">ðŸŽ¯ Closing Scripts <button class="sales-section-add-btn" onclick="quickAddSuggestion('closing')">+</button></div>
                        <div id="salesClosingScriptsList"></div>
                    </div>
                </div>
            </aside>
            
            <!-- Suggestion Edit Modal -->
            <div class="modal-overlay" id="suggestionEditModal">
                <div class="modal" style="max-width: 500px;">
                    <button class="modal-close" onclick="closeModal('suggestionEditModal')">âœ•</button>
                    <h3 class="modal-title" id="suggestionEditTitle">âœï¸ Edit Suggestion</h3>
                    <input type="hidden" id="suggestionEditId">
                    <input type="hidden" id="suggestionEditType">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="suggestionEditTitleInput" placeholder="e.g., Too Expensive">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="suggestionEditCategory">
                            <option value="objection">ðŸš§ Objection Handler</option>
                            <option value="template">ðŸ“ Template</option>
                            <option value="closing">ðŸŽ¯ Closing Script</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="suggestionEditTags" placeholder="price, budget, money">
                    </div>
                    <div class="form-group">
                        <label>Message Content</label>
                        <textarea id="suggestionEditContent" rows="6" placeholder="Your message here..."></textarea>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-info" onclick="aiRewriteInModal()" style="flex: 1; font-size: 11px;">âœ¨ AI Rewrite</button>
                            <button class="btn btn-secondary" onclick="copyModalContent()" style="flex: 1; font-size: 11px;">ðŸ“‹ Copy</button>
                        </div>
                    </div>
                    
                    <!-- AI Personality Options -->
                    <div class="form-group" id="suggestionAIOptions" style="background: rgba(255,214,130,0.1); border: 1px solid rgba(255,214,130,0.3); border-radius: 8px; padding: 12px; display: none;">
                        <label style="color: #ffd682;">âœ¨ AI Rewrite Options</label>
                        <select id="suggestionAIStyle" style="margin-bottom: 8px;">
                            <option value="friendly">ðŸ˜Š Friendly & Warm</option>
                            <option value="professional">ðŸ’¼ Professional</option>
                            <option value="casual">ðŸ˜Ž Casual & Fun</option>
                            <option value="urgent">ðŸ”¥ Add Urgency</option>
                            <option value="shorter">ðŸ“ Make Shorter</option>
                            <option value="longer">ðŸ“– Add More Detail</option>
                            <option value="custom">ðŸŽ¯ Custom Instructions</option>
                        </select>
                        <input type="text" id="suggestionAICustom" placeholder="Custom instructions..." style="display: none;">
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-success" onclick="generateAIRewrite()" style="flex: 1;">âœ¨ Generate</button>
                            <button class="btn btn-secondary" onclick="hideAIOptions()" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-danger" id="suggestionDeleteBtn" onclick="deleteSuggestionFromModal()" style="display: none;">ðŸ—‘ï¸ Delete</button>
                        <div style="flex: 1;"></div>
                        <button class="btn btn-secondary" onclick="closeModal('suggestionEditModal')">Cancel</button>
                        <button class="btn btn-success" onclick="saveSuggestionEdit()">ðŸ’¾ Save</button>
                    </div>
                </div>
            </div>
            
            <!-- Google Voice Panel -->
            <aside class="sales-voice-panel" id="salesVoicePanel">
                <div class="sales-voice-header">
                    <h3>ðŸ“ž Google Voice</h3>
                    <button class="sales-voice-toggle" onclick="toggleGoogleVoicePanel()">Hide</button>
                </div>
                <div class="sales-voice-notice" id="salesVoiceNotice" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ðŸ“ž</div>
                    <h3 style="color: #fff; margin-bottom: 10px;">Google Voice</h3>
                    <p style="margin-bottom: 20px; color: #aeb8de; text-align: center; max-width: 280px;">Open Google Voice in a new window to message customers.</p>
                    
                    <button onclick="openGoogleVoiceWindow()" style="padding: 16px 32px; background: linear-gradient(135deg, #4285f4, #34a853); border: none; border-radius: 12px; color: #fff; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(66,133,244,0.4);">
                        ðŸ“ž Open Google Voice
                    </button>
                    
                    <p style="font-size: 11px; color: #666; text-align: center;">Tip: Snap both windows side-by-side<br>for easy copy/paste</p>
                </div>
            </aside>
            
            <!-- Expand button when Voice panel is collapsed -->
            <button class="sales-voice-expand-btn" id="salesVoiceExpandBtn" onclick="toggleGoogleVoicePanel()" style="display: none;">ðŸ“ž</button>
        </div>
    </div>
    
    <!-- Sales Add Response Modal -->
    <div class="modal-overlay" id="salesAddResponseModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeSalesAddResponseModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“¤ Add Your Sent Message</h3>
            <p style="font-size: 12px; color: #888; margin: 10px 0;">Paste the message you sent to the customer (for record keeping).</p>
            <div class="form-group">
                <label>Your message:</label>
                <textarea id="salesAdminResponseInput" rows="4" placeholder="Paste what you sent..."></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeSalesAddResponseModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveSalesAdminResponse()">Save Message</button>
            </div>
        </div>
    </div>
    
    <!-- Sales Summary Modal -->
    <div class="modal-overlay" id="salesSummaryModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeModal('salesSummaryModal')">âœ•</button>
            <h3 class="modal-title">ðŸ“‹ Customer Summary</h3>
            <div id="salesSummaryContent" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin: 15px 0; font-size: 12px; white-space: pre-wrap; color: #eef2ff;"></div>
            <button class="btn btn-info" onclick="copySalesSummary()" style="width: 100%;">ðŸ“‹ Copy to Clipboard</button>
        </div>
    </div>
    
    <!-- Slot Enrolled Students Modal -->
    <div class="modal-overlay" id="slotStudentsModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeModal('slotStudentsModal')">âœ•</button>
            <h3 class="modal-title" id="slotStudentsTitle">ðŸ‘¥ Enrolled Students</h3>
            
            <div style="margin: 15px 0; padding: 15px; background: rgba(255,152,0,0.1); border: 2px solid #ff9800; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #ff9800; font-weight: bold;" id="slotStudentsSlotInfo">Saturday @ 8:30 PM</span>
                    <span style="font-size: 12px; color: #888;" id="slotStudentsCapacity">0/5 seats</span>
                </div>
                <div class="sales-slot-context-seats" id="slotStudentsSeatsVisual" style="margin-top: 8px;"></div>
            </div>
            
            <div class="sales-students-list" id="slotStudentsList">
                <p style="color: #888; font-size: 12px; text-align: center;">No students enrolled yet.</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-info" onclick="openSalesChatForSlot()">ðŸ’¬ Open Sales Chat</button>
                <button class="btn btn-secondary" onclick="closeModal('slotStudentsModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Sales Chat Settings Modal (Comprehensive) -->
    <div class="modal-overlay" id="salesSettingsModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <button class="modal-close" onclick="closeModal('salesSettingsModal')">âœ•</button>
            <h3 class="modal-title">âš™ï¸ Sales Chat Settings</h3>
            
            <!-- Settings Tabs -->
            <div class="sales-settings-tabs">
                <button class="sales-settings-tab active" onclick="switchSalesSettingsTab('general')">ðŸ”§ General</button>
                <button class="sales-settings-tab" onclick="switchSalesSettingsTab('personality')">ðŸŽ­ AI Personality</button>
                <button class="sales-settings-tab" onclick="switchSalesSettingsTab('business')">ðŸ’¼ Business</button>
                <button class="sales-settings-tab" onclick="switchSalesSettingsTab('templates')">ðŸ“ Templates</button>
                <button class="sales-settings-tab" onclick="switchSalesSettingsTab('objections')">ðŸš§ Objections</button>
                <button class="sales-settings-tab" onclick="switchSalesSettingsTab('knowledge')">ðŸ“š Knowledge</button>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- General Tab -->
                <div class="sales-settings-panel active" id="salesSettingsGeneral">
                    <div class="form-group">
                        <label>First Message Template</label>
                        <textarea id="salesSettingTemplate" rows="4" placeholder="Use {customerName}, {teacherName}, {day}, {time}, {seatsMessage}, {classType}, {startDate}"></textarea>
                        <div style="font-size: 10px; color: #888; margin-top: 4px;">Variables: {customerName}, {teacherName}, {day}, {time}, {seatsMessage}, {classType}, {startDate}</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Default Max Seats Per Slot</label>
                        <input type="number" id="salesSettingMaxSeats" min="1" max="20" value="5">
                    </div>
                    
                    <!-- Notification Sound -->
                    <div style="background: rgba(139,92,246,0.1); border: 2px solid #8b5cf6; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <h4 style="color: #8b5cf6; margin-bottom: 12px; font-size: 14px;">ðŸ”” Notification Sound</h4>
                        <div class="sales-sound-upload">
                            <input type="file" id="salesSoundUpload" accept="audio/*" style="display: none;" onchange="handleSalesSoundUpload(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('salesSoundUpload').click()" style="font-size: 12px;">
                                ðŸ“ Upload Sound
                            </button>
                            <div class="sales-sound-preview" id="salesSoundPreview" style="display: none;">
                                <span id="salesSoundFileName">notification.mp3</span>
                                <button class="btn btn-info" onclick="playSalesNotificationSound()" style="padding: 4px 8px; font-size: 11px;">â–¶ï¸ Test</button>
                                <button class="btn btn-danger" onclick="removeSalesSound()" style="padding: 4px 8px; font-size: 11px;">âœ•</button>
                            </div>
                        </div>
                        <audio id="salesNotificationAudio" preload="auto"></audio>
                    </div>
                    
                    <!-- Downsell -->
                    <div style="background: rgba(255,152,0,0.1); border: 2px solid #ff9800; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <h4 style="color: #ff9800; margin-bottom: 12px; font-size: 14px;">ðŸ¦Š Auto-Downsell Message</h4>
                        <div class="form-group">
                            <label>Send Downsell After (minutes)</label>
                            <select id="salesSettingDownsellMinutes">
                                <option value="0">Disabled</option>
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Downsell Message Template</label>
                            <textarea id="salesSettingDownsellMessage" rows="2" placeholder="Hey {customerName}! Just checking in..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Post-Sell -->
                    <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <h4 style="color: #39ff14; margin-bottom: 12px; font-size: 14px;">ðŸŽ‰ Post-Sell Message</h4>
                        <div class="form-group">
                            <label>Post-Sell Message Template</label>
                            <textarea id="salesSettingPostSellMessage" rows="3" placeholder="ðŸŽ‰ Awesome {customerName}! You're all set..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Cold Timer -->
                    <div style="background: rgba(156,163,175,0.1); border: 2px solid #9ca3af; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <h4 style="color: #9ca3af; margin-bottom: 12px; font-size: 14px;">â±ï¸ Lead Cold Timer</h4>
                        <p style="font-size: 11px; color: #aeb8de; margin-bottom: 12px;">Automatically degrade lead urgency if no response.</p>
                        <div class="form-group">
                            <label>Degrade Urgency After (minutes)</label>
                            <select id="salesSettingColdTimer">
                                <option value="0">Disabled</option>
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Auto-Delete Closed Chats After</label>
                        <select id="salesSettingAutoDelete">
                            <option value="0">Never</option>
                            <option value="7">7 days</option>
                            <option value="14">14 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="60">60 days</option>
                        </select>
                    </div>
                </div>
                
                <!-- AI Personality Tab -->
                <div class="sales-settings-panel" id="salesSettingsPersonality">
                    <div class="form-group">
                        <label>Agent Name</label>
                        <input type="text" id="salesSettingAgentName" placeholder="Calvin">
                    </div>
                    <div class="form-group">
                        <label>Agent Role</label>
                        <input type="text" id="salesSettingAgentRole" placeholder="Korean Teacher from TikTok">
                    </div>
                    <div class="form-group">
                        <label>Personality Tone</label>
                        <select id="salesSettingTone">
                            <option value="friendly">ðŸ˜Š Friendly & Warm</option>
                            <option value="professional">ðŸ’¼ Professional</option>
                            <option value="casual">ðŸ˜Ž Casual & Fun</option>
                            <option value="enthusiastic">ðŸŽ‰ Enthusiastic</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Emoji Level</label>
                        <select id="salesSettingEmojiLevel">
                            <option value="none">None</option>
                            <option value="minimal">Minimal (1-2 per message)</option>
                            <option value="moderate">Moderate (2-4 per message)</option>
                            <option value="heavy">Heavy (lots of emojis! ðŸŽ‰ðŸ”¥âœ¨)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Response Length</label>
                        <select id="salesSettingResponseLength">
                            <option value="short">Short (1-2 sentences)</option>
                            <option value="balanced">Balanced (2-4 sentences)</option>
                            <option value="detailed">Detailed (4-6 sentences)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Custom Personality Instructions</label>
                        <textarea id="salesSettingCustomPersonality" rows="3" placeholder="Additional instructions for the AI..."></textarea>
                    </div>
                    
                    <!-- Lead Scoring Keywords -->
                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <h4 style="color: #fff; margin-bottom: 12px; font-size: 14px;">ðŸ”¥ Lead Scoring Keywords</h4>
                        <div class="form-group">
                            <label style="color: #ef4444;">ðŸ”´ Hot Keywords (ready to buy)</label>
                            <input type="text" id="salesSettingHotKeywords" placeholder="sign up, register, enroll, buy, ready">
                        </div>
                        <div class="form-group">
                            <label style="color: #fbbf24;">ðŸŸ¡ Warm Keywords (interested)</label>
                            <input type="text" id="salesSettingWarmKeywords" placeholder="price, cost, schedule, interested">
                        </div>
                        <div class="form-group">
                            <label style="color: #9ca3af;">âšª Cold Keywords (not interested)</label>
                            <input type="text" id="salesSettingColdKeywords" placeholder="not interested, too expensive, maybe later">
                        </div>
                    </div>
                </div>
                
                <!-- Business Tab -->
                <div class="sales-settings-panel" id="salesSettingsBusiness">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="salesSettingBusinessName" placeholder="KoreanLearnin">
                    </div>
                    <div class="form-group">
                        <label>Website URL</label>
                        <input type="text" id="salesSettingWebsite" placeholder="https://koreanlearnin.com">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="salesSettingEmail" placeholder="contact@koreanlearnin.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" id="salesSettingPhone" placeholder="(555) 123-4567">
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <h4 style="color: #fff; margin-bottom: 12px; font-size: 14px;">ðŸ’° Pricing</h4>
                        <div class="form-group">
                            <label>Intro Course Price</label>
                            <input type="text" id="salesSettingIntroPrice" placeholder="$100">
                        </div>
                        <div class="form-group">
                            <label>Advanced Program Price</label>
                            <input type="text" id="salesSettingAdvancedPrice" placeholder="$250/month">
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,214,130,0.1); border: 2px solid #ffd682; border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <h4 style="color: #ffd682; margin-bottom: 12px; font-size: 14px;">ðŸŽ Current Promotion</h4>
                        <div class="form-group">
                            <label>Promotion Text</label>
                            <input type="text" id="salesSettingPromotion" placeholder="New Year Special - 20% off!">
                        </div>
                        <div class="form-group">
                            <label>Promotion Link</label>
                            <input type="text" id="salesSettingPromoLink" placeholder="https://koreanlearnin.com/promo">
                        </div>
                    </div>
                </div>
                
                <!-- Templates Tab -->
                <div class="sales-settings-panel" id="salesSettingsTemplates">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #fff; margin: 0;">ðŸ“ Message Templates</h4>
                        <button class="btn btn-success" onclick="addSalesTemplate()" style="font-size: 12px;">+ Add Template</button>
                    </div>
                    <div id="salesTemplatesList" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: #888; font-size: 12px; text-align: center;">Loading templates...</p>
                    </div>
                </div>
                
                <!-- Objections Tab -->
                <div class="sales-settings-panel" id="salesSettingsObjections">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #fff; margin: 0;">ðŸš§ Objection Handlers</h4>
                        <button class="btn btn-success" onclick="addSalesObjection()" style="font-size: 12px;">+ Add Handler</button>
                    </div>
                    <div id="salesObjectionsList" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: #888; font-size: 12px; text-align: center;">Loading objection handlers...</p>
                    </div>
                </div>
                
                <!-- Knowledge Tab -->
                <div class="sales-settings-panel" id="salesSettingsKnowledge">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #fff; margin: 0;">ðŸ“š Knowledge Base</h4>
                        <button class="btn btn-success" onclick="addSalesKnowledge()" style="font-size: 12px;">+ Add Entry</button>
                    </div>
                    <p style="font-size: 11px; color: #aeb8de; margin-bottom: 15px;">Add custom information for the AI to reference when answering questions.</p>
                    <div id="salesKnowledgeList" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: #888; font-size: 12px; text-align: center;">Loading knowledge base...</p>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn-secondary" onclick="closeModal('salesSettingsModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveSalesChatSettings()">ðŸ’¾ Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Sales Feedback Panel -->
    <div class="sales-feedback-panel" id="salesFeedbackPanel">
        <div class="sales-feedback-header">
            <h2>ðŸ’¬ AI Feedback</h2>
            <button onclick="closeSalesFeedbackPanel()">âœ•</button>
        </div>
        <div class="sales-feedback-content">
            <div class="form-group">
                <label>Select Conversation</label>
                <select id="salesFeedbackChatSelect" onchange="loadSalesFeedbackChat()">
                    <option value="">-- Select a chat --</option>
                </select>
            </div>
            <button class="btn btn-info" onclick="analyzeSalesConversation()" style="width: 100%; margin: 15px 0;">ðŸ” Analyze Conversation</button>
            <div id="salesFeedbackResults"></div>
        </div>
    </div>
    
    <!-- Sales Drag Overlay -->
    <div class="sales-drag-overlay" id="salesDragOverlay">
        <div class="sales-drag-overlay-header">
            <h2>ðŸ“‹ Quick Chat Switch</h2>
            <p>Click a chat to switch to it</p>
            <button class="sales-drag-overlay-close" onclick="closeSalesDragOverlay()">âœ•</button>
        </div>
        <div class="sales-drag-overlay-stats">
            <div class="sales-drag-stat hot"><span id="salesDragHotCount">0</span> Hot</div>
            <div class="sales-drag-stat warm"><span id="salesDragWarmCount">0</span> Warm</div>
            <div class="sales-drag-stat cold"><span id="salesDragColdCount">0</span> Cold</div>
        </div>
        <div class="sales-drag-overlay-grid" id="salesDragGrid"></div>
    </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        console.log('Script starting...');

        // ==================== EST TIMEZONE HELPERS ====================
        // All date/time operations should use these functions to ensure consistent EST behavior
        
        // Get current date/time in EST timezone
        function getESTDate() {
            const now = new Date();
            // Convert to EST by using toLocaleString with America/New_York timezone
            const estString = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
            return new Date(estString);
        }
        
        // Get current day name in EST (e.g., "Saturday", "Sunday")
        function getESTDayName() {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return dayNames[getESTDate().getDay()];
        }
        
        // Get current month (0-11) in EST
        function getESTMonth() {
            return getESTDate().getMonth();
        }
        
        // Get current year in EST
        function getESTYear() {
            return getESTDate().getFullYear();
        }
        
        // Parse a date string (YYYY-MM-DD) as EST midnight
        function parseESTDate(dateString) {
            if (!dateString) return null;
            // Parse as EST by appending EST timezone offset
            // Create date at midnight EST
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(dateString + 'T00:00:00-05:00'); // EST is UTC-5
            return date;
        }
        
        // Get start of today in EST (midnight)
        function getESTToday() {
            const est = getESTDate();
            est.setHours(0, 0, 0, 0);
            return est;
        }
        
        // Compare two dates (ignoring time) - returns true if date1 >= date2
        function isDateOnOrAfter(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);
            return d1 >= d2;
        }
        
        // Get the number of days between two dates
        function getDaysBetween(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);
            return Math.floor((d1 - d2) / (1000 * 60 * 60 * 24));
        }
        
        // ==================== END EST TIMEZONE HELPERS ====================

        // Check if Firebase SDK is loaded
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded!');
            alert('Firebase SDK failed to load. Please check your internet connection and refresh the page.');
        } else {
            console.log('Firebase SDK loaded');
        }

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDzI1_B49onrKJriy3er88O1KOJTLBzbYY",
            authDomain: "korean-ta-evaluator.firebaseapp.com",
            projectId: "korean-ta-evaluator",
            storageBucket: "korean-ta-evaluator.firebasestorage.app",
            messagingSenderId: "386010826708",
            appId: "1:386010826708:web:d06d6fbdadce561b36b841",
            measurementId: "G-FGT8J0D64J"
        };
        
        console.log('Initializing Firebase...');
        // Initialize Firebase
        let auth, db, storage, secondaryAuth;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            
            // Secondary app for creating accounts without logging out admin
            const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
            secondaryAuth = secondaryApp.auth();
            
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize Firebase: " + error.message);
        }

        // Yodafy Game Firebase functions (called from iframe)
        async function saveYodafyGame(jsonData) {
            try {
                const gameData = JSON.parse(jsonData);
                await db.collection('yodafy_games').add(gameData);
                return { success: true };
            } catch (error) {
                console.error('Save Yodafy game error:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function loadYodafyGames() {
            try {
                const snap = await db.collection('yodafy_games').orderBy('createdAt', 'desc').limit(20).get();
                const games = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                return { success: true, games: games };
            } catch (error) {
                console.error('Load Yodafy games error:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function loadYodafyGameById(gameId) {
            try {
                const doc = await db.collection('yodafy_games').doc(gameId).get();
                if (!doc.exists) {
                    return { success: false, error: 'Game not found' };
                }
                return { success: true, game: doc.data() };
            } catch (error) {
                console.error('Load Yodafy game error:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function deleteYodafyGame(gameId) {
            try {
                await db.collection('yodafy_games').doc(gameId).delete();
                return { success: true };
            } catch (error) {
                console.error('Delete Yodafy game error:', error);
                return { success: false, error: error.message };
            }
        }

        // Constants
        const TIME_SLOTS = ['6:30 PM', '7:10 PM', '7:50 PM', '8:30 PM', '9:10 PM', '9:50 PM', '10:30 PM', '11:10 PM'];
        const DAYS = ['Saturday', 'Sunday'];
        
        // Default levels (will be merged with custom class types from Firestore)
        const DEFAULT_LEVELS = { absolute: 'Absolute Beginner', novice: 'Novice', beginner: 'Beginner', advanced: 'Advanced Beginner' };
        let LEVELS = { ...DEFAULT_LEVELS };
        let LEVEL_PRIORITY = ['absolute', 'novice', 'beginner', 'advanced'];
        let CLASS_TYPE_COLORS = { absolute: '#ff00ff', novice: '#00ffff', beginner: '#39ff14', advanced: '#ffff00' };
        let CLASS_TYPE_WEEKS = { absolute: 6, novice: 6, beginner: 6, advanced: 6 };
        let allClassTypes = []; // Custom class types from Firestore

        // State
        let currentUser = null;
        let selectedSlots = { 1: null, 2: null, 3: null };
        let allStudents = [];
        let allClasses = [];
        let allTeachers = [];
        let allProposals = [];
        let allPrescheduledSlots = []; // Pre-scheduled class slots
        let schedulerSettings = { minStudents: 5, maxStudents: 10, currentWeek: 1, startDate: null };
        let pendingDropAction = null;
        let draggedStudentId = null;
        let draggedProposalStudentId = null;

        // Helper: get student availability (supports both classTime and legacy availabilities)
        function getStudentAvailabilities(student) {
            if (student.availabilities && (student.availabilities[1] || student.availabilities[2] || student.availabilities[3])) {
                return student.availabilities;
            }
            if (student.classTime) {
                return { 1: student.classTime, 2: null, 3: null };
            }
            return {};
        }

        // Timezone Map
        // US States with their default timezones
        const US_STATES = {
            'Alabama': 'America/Chicago',
            'Alaska': 'America/Anchorage', // Split timezone
            'Arizona': 'America/Phoenix',
            'Arkansas': 'America/Chicago',
            'California': 'America/Los_Angeles',
            'Colorado': 'America/Denver',
            'Connecticut': 'America/New_York',
            'Delaware': 'America/New_York',
            'Florida': 'America/New_York', // Split timezone
            'Georgia': 'America/New_York',
            'Hawaii': 'Pacific/Honolulu',
            'Idaho': 'America/Boise', // Split timezone
            'Illinois': 'America/Chicago',
            'Indiana': 'America/Indiana/Indianapolis', // Split timezone
            'Iowa': 'America/Chicago',
            'Kansas': 'America/Chicago', // Split timezone
            'Kentucky': 'America/Kentucky/Louisville', // Split timezone
            'Louisiana': 'America/Chicago',
            'Maine': 'America/New_York',
            'Maryland': 'America/New_York',
            'Massachusetts': 'America/New_York',
            'Michigan': 'America/Detroit', // Split timezone
            'Minnesota': 'America/Chicago',
            'Mississippi': 'America/Chicago',
            'Missouri': 'America/Chicago',
            'Montana': 'America/Denver',
            'Nebraska': 'America/Chicago', // Split timezone
            'Nevada': 'America/Los_Angeles', // Split timezone
            'New Hampshire': 'America/New_York',
            'New Jersey': 'America/New_York',
            'New Mexico': 'America/Denver',
            'New York': 'America/New_York',
            'North Carolina': 'America/New_York',
            'North Dakota': 'America/Chicago', // Split timezone
            'Ohio': 'America/New_York',
            'Oklahoma': 'America/Chicago',
            'Oregon': 'America/Los_Angeles', // Split timezone
            'Pennsylvania': 'America/New_York',
            'Rhode Island': 'America/New_York',
            'South Carolina': 'America/New_York',
            'South Dakota': 'America/Chicago', // Split timezone
            'Tennessee': 'America/Chicago', // Split timezone
            'Texas': 'America/Chicago', // Split timezone
            'Utah': 'America/Denver',
            'Vermont': 'America/New_York',
            'Virginia': 'America/New_York',
            'Washington': 'America/Los_Angeles',
            'West Virginia': 'America/New_York',
            'Wisconsin': 'America/Chicago',
            'Wyoming': 'America/Denver',
            'District of Columbia': 'America/New_York'
        };
        
        // Canadian Provinces with their default timezones
        const CA_PROVINCES = {
            'Alberta': 'America/Edmonton',
            'British Columbia': 'America/Vancouver',
            'Manitoba': 'America/Winnipeg',
            'New Brunswick': 'America/Moncton',
            'Newfoundland and Labrador': 'America/St_Johns',
            'Northwest Territories': 'America/Yellowknife',
            'Nova Scotia': 'America/Halifax',
            'Nunavut': 'America/Iqaluit',
            'Ontario': 'America/Toronto',
            'Prince Edward Island': 'America/Halifax',
            'Quebec': 'America/Montreal',
            'Saskatchewan': 'America/Regina',
            'Yukon': 'America/Whitehorse'
        };
        
        // Split timezone states with their options
        const SPLIT_TIMEZONE_STATES = {
            'Alaska': [
                { value: 'America/Anchorage', label: 'Alaska Time (most of Alaska)' },
                { value: 'America/Adak', label: 'Hawaii-Aleutian Time (Aleutian Islands)' }
            ],
            'Florida': [
                { value: 'America/New_York', label: 'Eastern Time (most of Florida)' },
                { value: 'America/Chicago', label: 'Central Time (western panhandle - Pensacola, Panama City)' }
            ],
            'Idaho': [
                { value: 'America/Boise', label: 'Mountain Time (southern Idaho)' },
                { value: 'America/Los_Angeles', label: 'Pacific Time (northern panhandle)' }
            ],
            'Indiana': [
                { value: 'America/Indiana/Indianapolis', label: 'Eastern Time (most of Indiana)' },
                { value: 'America/Chicago', label: 'Central Time (northwest & southwest corners)' }
            ],
            'Kansas': [
                { value: 'America/Chicago', label: 'Central Time (most of Kansas)' },
                { value: 'America/Denver', label: 'Mountain Time (western counties)' }
            ],
            'Kentucky': [
                { value: 'America/Kentucky/Louisville', label: 'Eastern Time (eastern Kentucky)' },
                { value: 'America/Chicago', label: 'Central Time (western Kentucky)' }
            ],
            'Michigan': [
                { value: 'America/Detroit', label: 'Eastern Time (most of Michigan)' },
                { value: 'America/Chicago', label: 'Central Time (western Upper Peninsula)' }
            ],
            'Nebraska': [
                { value: 'America/Chicago', label: 'Central Time (most of Nebraska)' },
                { value: 'America/Denver', label: 'Mountain Time (western panhandle)' }
            ],
            'Nevada': [
                { value: 'America/Los_Angeles', label: 'Pacific Time (most of Nevada)' },
                { value: 'America/Denver', label: 'Mountain Time (West Wendover area)' }
            ],
            'North Dakota': [
                { value: 'America/Chicago', label: 'Central Time (most of North Dakota)' },
                { value: 'America/Denver', label: 'Mountain Time (southwest corner)' }
            ],
            'Oregon': [
                { value: 'America/Los_Angeles', label: 'Pacific Time (most of Oregon)' },
                { value: 'America/Boise', label: 'Mountain Time (Malheur County)' }
            ],
            'South Dakota': [
                { value: 'America/Chicago', label: 'Central Time (eastern South Dakota)' },
                { value: 'America/Denver', label: 'Mountain Time (western South Dakota)' }
            ],
            'Tennessee': [
                { value: 'America/Chicago', label: 'Central Time (western & middle Tennessee)' },
                { value: 'America/New_York', label: 'Eastern Time (eastern Tennessee)' }
            ],
            'Texas': [
                { value: 'America/Chicago', label: 'Central Time (most of Texas)' },
                { value: 'America/Denver', label: 'Mountain Time (El Paso & Hudspeth County)' }
            ]
        };
        
        // Country timezone defaults
        const COUNTRY_TIMEZONES = {
            'US': 'America/New_York',
            'CA': 'America/Toronto',
            'GB': 'Europe/London',
            'AU': 'Australia/Sydney',
            'KR': 'Asia/Seoul',
            'JP': 'Asia/Tokyo',
            'DE': 'Europe/Berlin',
            'FR': 'Europe/Paris'
        };

        // Utility Functions
        function showMessage(id, msg, type) {
            const el = document.getElementById(id);
            if (el) { el.innerHTML = `<div class="message ${type}">${msg}</div>`; setTimeout(() => el.innerHTML = '', 5000); }
        }
        
        // Email validation
        function validateEmail() {
            const email = document.getElementById('studentEmail').value.trim();
            const errorEl = document.getElementById('emailError');
            
            if (!email) {
                errorEl.style.display = 'none';
                return false;
            }
            
            // Check for @ symbol
            if (!email.includes('@')) {
                errorEl.textContent = 'Email must contain @ symbol';
                errorEl.style.display = 'block';
                return false;
            }
            
            // Check for valid format
            const emailRegex = /^[^\s@]+@[^\s@]+\.(com|org|edu|net|gov|co|io|me|info|biz|us|ca|uk|au|de|fr|kr|jp)$/i;
            if (!emailRegex.test(email)) {
                errorEl.textContent = 'Please enter a valid email address';
                errorEl.style.display = 'block';
                return false;
            }
            
            errorEl.style.display = 'none';
            return true;
        }
        
        // Country change handler
        function onCountryChange() {
            const country = document.getElementById('studentCountry').value;
            const locationFields = document.getElementById('locationFields');
            const stateGroup = document.getElementById('stateGroup');
            const cityGroup = document.getElementById('cityGroup');
            const timezoneGroup = document.getElementById('timezoneGroup');
            const splitTimezoneGroup = document.getElementById('splitTimezoneGroup');
            const stateList = document.getElementById('stateList');
            const stateLabel = document.getElementById('stateLabel');
            
            // Reset fields
            document.getElementById('studentState').value = '';
            document.getElementById('studentCity').value = '';
            splitTimezoneGroup.style.display = 'none';
            
            if (country === 'GB') {
                // UK - no state/city needed
                locationFields.style.display = 'none';
                timezoneGroup.style.display = 'none';
            } else if (country === 'US') {
                // US - show state autocomplete
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
                stateLabel.textContent = 'State';
                stateList.innerHTML = Object.keys(US_STATES).map(s => `<option value="${s}">`).join('');
            } else if (country === 'CA') {
                // Canada - show province autocomplete
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
                stateLabel.textContent = 'Province';
                stateList.innerHTML = Object.keys(CA_PROVINCES).map(s => `<option value="${s}">`).join('');
            } else if (country === 'OTHER') {
                // Other - show timezone picker
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                stateLabel.textContent = 'State/Province';
                stateList.innerHTML = '';
                timezoneGroup.style.display = 'block';
            } else if (country) {
                // Other known countries - just city
                locationFields.style.display = 'block';
                stateGroup.style.display = 'none';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
            } else {
                locationFields.style.display = 'none';
                timezoneGroup.style.display = 'none';
            }
            
            renderAvailabilityGrid();
        }
        
        // State change handler
        function onStateChange() {
            const country = document.getElementById('studentCountry').value;
            const state = document.getElementById('studentState').value;
            const splitTimezoneGroup = document.getElementById('splitTimezoneGroup');
            const splitTimezoneSelect = document.getElementById('splitTimezoneSelect');
            const splitTimezoneLabel = document.getElementById('splitTimezoneLabel');
            
            // Check if this is a split timezone state
            if (country === 'US' && SPLIT_TIMEZONE_STATES[state]) {
                const options = SPLIT_TIMEZONE_STATES[state];
                splitTimezoneLabel.textContent = `${state} Timezone`;
                splitTimezoneSelect.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
                splitTimezoneGroup.style.display = 'block';
            } else {
                splitTimezoneGroup.style.display = 'none';
            }
            
            renderAvailabilityGrid();
        }

        function getTimezone(country, state) {
            if (!country) return 'America/New_York';
            
            // UK
            if (country === 'GB') return 'Europe/London';
            
            // US
            if (country === 'US' && state) {
                // Check for split timezone state with user selection
                if (SPLIT_TIMEZONE_STATES[state]) {
                    const splitSelect = document.getElementById('splitTimezoneSelect');
                    if (splitSelect && splitSelect.value) {
                        return splitSelect.value;
                    }
                }
                // Use default for state
                if (US_STATES[state]) return US_STATES[state];
            }
            
            // Canada
            if (country === 'CA' && state) {
                if (CA_PROVINCES[state]) return CA_PROVINCES[state];
            }
            
            // Other countries with manual timezone
            if (country === 'OTHER') {
                return document.getElementById('studentTimezone').value;
            }
            
            // Default for country
            return COUNTRY_TIMEZONES[country] || 'America/New_York';
        }

        function convertESTToLocal(estTime, tz) {
            try {
                const [time, period] = estTime.split(' ');
                let [h, m] = time.split(':').map(Number);
                if (period === 'PM' && h !== 12) h += 12;
                if (period === 'AM' && h === 12) h = 0;
                const d = new Date(); d.setHours(h, m, 0, 0);
                return d.toLocaleString('en-US', { timeZone: tz, hour: 'numeric', minute: '2-digit', hour12: true });
            } catch (e) { return estTime; }
        }

        // Role Switching
        function switchRole(role) {
            document.querySelectorAll('.role-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('adminLoginForm').style.display = role === 'admin' ? 'block' : 'none';
            document.getElementById('supportLoginForm').style.display = role === 'support' ? 'block' : 'none';
            document.getElementById('teacherLoginForm').style.display = role === 'teacher' ? 'block' : 'none';
        }

        // Student Registration
        function renderAvailabilityGrid() {
            const grid = document.getElementById('availabilityGrid');
            const countryEl = document.getElementById('studentCountry');
            const stateEl = document.getElementById('studentState');
            if (!grid || !countryEl) return; // Exit if elements don't exist yet
            const country = countryEl.value;
            const state = stateEl?.value || '';
            const tz = getTimezone(country, state);

            grid.innerHTML = DAYS.map(day => `
                <div class="day-column">
                    <div class="day-title">${day}</div>
                    ${TIME_SLOTS.map(time => {
                        const local = convertESTToLocal(time, tz);
                        const slotId = `${day}-${time}`;
                        const rank = Object.entries(selectedSlots).find(([r, s]) => s === slotId)?.[0];
                        return `<div class="time-slot ${rank ? 'selected-' + rank : ''}" onclick="selectSlot('${day}', '${time}')">${time} EST<div class="local-time">Your time: ${local}</div>${rank ? `<div class="rank-badge">${rank}</div>` : ''}</div>`;
                    }).join('')}
                </div>
            `).join('');
        }

        function selectSlot(day, time) {
            const slotId = `${day}-${time}`;
            const existing = Object.entries(selectedSlots).find(([r, s]) => s === slotId)?.[0];
            if (existing) { selectedSlots[existing] = null; }
            else { for (let i = 1; i <= 3; i++) { if (!selectedSlots[i]) { selectedSlots[i] = slotId; break; } } }
            renderAvailabilityGrid();
        }

        async function submitStudentRegistration() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            const discord = document.getElementById('studentDiscord').value.trim();
            const country = document.getElementById('studentCountry').value;
            const videoUrl = document.getElementById('studentVideoUrl').value;
            
            // UK doesn't need city/state
            const city = country === 'GB' ? 'United Kingdom' : document.getElementById('studentCity').value.trim();
            const state = country === 'GB' ? '' : document.getElementById('studentState').value.trim();

            // Validation
            if (!name) { showMessage('studentRegMessage', 'Please enter your name', 'error'); return; }
            if (!email) { showMessage('studentRegMessage', 'Please enter your email', 'error'); return; }
            if (!validateEmail()) { showMessage('studentRegMessage', 'Please enter a valid email address', 'error'); return; }
            if (!country) { showMessage('studentRegMessage', 'Please select your country', 'error'); return; }
            
            // Country-specific validation
            if (country === 'US') {
                if (!state || !US_STATES[state]) { showMessage('studentRegMessage', 'Please select a valid US state', 'error'); return; }
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
                // Check if split timezone state needs selection
                if (SPLIT_TIMEZONE_STATES[state] && !document.getElementById('splitTimezoneSelect').value) {
                    showMessage('studentRegMessage', 'Please select your timezone', 'error'); return;
                }
            } else if (country === 'CA') {
                if (!state || !CA_PROVINCES[state]) { showMessage('studentRegMessage', 'Please select a valid Canadian province', 'error'); return; }
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            } else if (country !== 'GB' && country !== 'OTHER') {
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            } else if (country === 'OTHER') {
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            }
            
            if (!selectedSlots[1] || !selectedSlots[2] || !selectedSlots[3]) { showMessage('studentRegMessage', 'Please select 3 availability preferences', 'error'); return; }
            if (!videoUrl) { showMessage('studentRegMessage', 'Please record your pronunciation video', 'error'); return; }

            const tz = getTimezone(country, state);

            try {
                await db.collection('scheduler_students').add({
                    name, email, phone, discord, city, state, country, timezone: tz,
                    availabilities: { ...selectedSlots },
                    videoUrl: videoUrl,
                    level: null, status: 'pending', classId: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('studentLoginForm').style.display = 'none';
                document.getElementById('studentSuccessScreen').style.display = 'block';
            } catch (e) { showMessage('studentRegMessage', 'Error: ' + e.message, 'error'); }
        }

        function resetStudentForm() {
            selectedSlots = { 1: null, 2: null, 3: null };
            ['studentName', 'studentEmail', 'studentPhone', 'studentDiscord', 'studentCity', 'studentState', 'studentCountry'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('studentVideoUrl').value = '';
            document.getElementById('videoPlayback').style.display = 'none';
            document.getElementById('videoPlayback').src = '';
            document.getElementById('recordingStatus').textContent = '';
            document.getElementById('recordingTimer').style.display = 'none';
            document.getElementById('locationFields').style.display = 'none';
            document.getElementById('timezoneGroup').style.display = 'none';
            document.getElementById('splitTimezoneGroup').style.display = 'none';
            document.getElementById('emailError').style.display = 'none';
            const btn = document.getElementById('recordBtn');
            btn.className = 'record-btn start';
            btn.textContent = 'ðŸŽ¤ HOLD TO RECORD';
            document.getElementById('studentLoginForm').style.display = 'block';
            document.getElementById('studentSuccessScreen').style.display = 'none';
            renderAvailabilityGrid();
        }

        // Admin Login
        async function adminLogin() {
            if (!auth || !db) { showMessage('adminLoginMessage', 'Firebase not ready. Please refresh the page.', 'error'); return; }
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            if (!email || !password) { showMessage('adminLoginMessage', 'Enter email and password', 'error'); return; }

            console.log('Attempting admin login with:', email);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Authentication successful:', userCredential.user.uid);
                
                // Check users collection for admin role
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                console.log('User doc exists:', userDoc.exists);
                
                if (!userDoc.exists) {
                    await auth.signOut();
                    showMessage('adminLoginMessage', 'User not found in database', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                console.log('User data:', userData);
                
                if (userData.role !== 'admin') {
                    await auth.signOut();
                    showMessage('adminLoginMessage', 'Access denied. Admin only.', 'error');
                    return;
                }
                
                currentUser = { ...userData, uid: userCredential.user.uid, role: 'admin' };
                showMessage('adminLoginMessage', 'Login successful!', 'success');
                setTimeout(() => showAdminDashboard(), 500);
            } catch (e) { 
                console.error('Login error:', e);
                showMessage('adminLoginMessage', 'Login failed: ' + e.message, 'error'); 
            }
        }

        // Support Login
        async function supportLogin() {
            if (!auth || !db) { showMessage('supportLoginMessage', 'Firebase not ready. Please refresh the page.', 'error'); return; }
            const email = document.getElementById('supportEmail').value.trim();
            const password = document.getElementById('supportPassword').value;
            if (!email || !password) { showMessage('supportLoginMessage', 'Enter email and password', 'error'); return; }

            console.log('Attempting support login with:', email);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Authentication successful:', userCredential.user.uid);
                
                // Check users collection for support role
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                console.log('User doc exists:', userDoc.exists);
                
                if (!userDoc.exists) {
                    await auth.signOut();
                    showMessage('supportLoginMessage', 'User not found in database', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                console.log('User data:', userData);
                
                if (userData.role !== 'support') {
                    await auth.signOut();
                    showMessage('supportLoginMessage', 'Access denied. Support role only.', 'error');
                    return;
                }
                
                currentUser = { ...userData, uid: userCredential.user.uid, role: 'support' };
                showMessage('supportLoginMessage', 'Login successful!', 'success');
                setTimeout(() => showAdminDashboard(), 500);
            } catch (e) { 
                console.error('Login error:', e);
                showMessage('supportLoginMessage', 'Login failed: ' + e.message, 'error'); 
            }
        }

        // Teacher Login
        async function teacherLogin() {
            if (!auth || !db) { showMessage('teacherLoginMessage', 'Firebase not ready. Please refresh the page.', 'error'); return; }
            const email = document.getElementById('teacherEmail').value.trim();
            const password = document.getElementById('teacherPassword').value;
            if (!email || !password) { showMessage('teacherLoginMessage', 'Enter email and password', 'error'); return; }

            console.log('Attempting teacher login with:', email);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Authentication successful:', userCredential.user.uid);
                
                // Check scheduler_teachers collection
                const q = await db.collection('scheduler_teachers').where('email', '==', email).get();
                
                if (q.empty) { 
                    await auth.signOut(); 
                    showMessage('teacherLoginMessage', 'Not registered as a scheduler teacher', 'error'); 
                    return; 
                }
                
                currentUser = { ...q.docs[0].data(), odId: q.docs[0].id, uid: userCredential.user.uid, role: 'teacher' };
                showMessage('teacherLoginMessage', 'Login successful!', 'success');
                setTimeout(() => showTeacherDashboard(), 500);
            } catch (e) { 
                console.error('Login error:', e);
                showMessage('teacherLoginMessage', 'Login failed: ' + e.message, 'error'); 
            }
        }

        async function logout() {
            await auth.signOut();
            currentUser = null;
            document.getElementById('mainPanel').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('teacherDashboard').style.display = 'none';
        }

        // Admin Dashboard
        function showAdminDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('teacherDashboard').style.display = 'none';
            const roleLabel = currentUser.role === 'support' ? 'Support' : 'Admin';
            document.getElementById('userInfoDisplay').textContent = `${roleLabel}: ${currentUser.email || currentUser.name}`;
            loadSchedulerSettings(); loadAllStudents(); 
            loadAllTeachers().then(() => loadTeacherButtonsForAdmin()); 
            loadClassTypes().then(() => loadAllClasses()); // Load class types first, then classes
            loadProposals();
            
            // Hide delete buttons and reset button for support role
            if (currentUser.role === 'support') {
                const resetBtn = document.getElementById('resetAllDataBtn');
                if (resetBtn) resetBtn.style.display = 'none';
            }
        }
        
        // Helper function to check if user can delete
        function canDelete() {
            return currentUser && currentUser.role === 'admin';
        }

        function showAdminTab(tab, clickedElement) {
            document.querySelectorAll('#adminDashboard .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#adminDashboard .nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            
            // Handle both click events and programmatic calls
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Programmatic call - find and activate the correct tab button
                const tabBtn = document.querySelector(`#adminDashboard .nav-tab[onclick*="${tab}"]`);
                if (tabBtn) tabBtn.classList.add('active');
            }
            
            if (tab === 'materials') loadMaterialsForLevel();
            if (tab === 'schedule') renderAdminSchedule();
            if (tab === 'absences') loadAbsencesList();
            if (tab === 'calendar') renderMonthlyCalendar();
            if (tab === 'completed') loadAdminCompletedClasses();
            if (tab === 'attendance') loadAdminAttendance();
            if (tab === 'suggestions') loadAdminSuggestions();
            if (tab === 'proposals') { loadProposals(); renderAvailableStudentsForProposals(); }
            if (tab === 'ready') loadReadyRequests();
            if (tab === 'dashboard') loadTeacherButtonsForAdmin();
            if (tab === 'slotmanager') initSlotManager();
            if (tab === 'accounts') {
                // Smart loading - use cache if available, otherwise show load controls
                if (shopifyCustomersCache && shopifyCustomersCacheTime) {
                    loadShopifyCustomersForAccounts(); // Will use cache
                }
                // If no cache, just show the load controls (don't auto-load)
            }
        }

        // Teacher Dashboard
        function showTeacherDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('teacherDashboard').style.display = 'block';
            document.getElementById('userInfoDisplay').textContent = `Teacher: ${currentUser.name}`;
            
            // Load class types first, then settings and classes
            loadClassTypes().then(() => {
                // Load settings FIRST, then load classes (so currentWeek is correct)
                loadSchedulerSettings().then(() => {
                    checkWeek6Reminder();
                    loadTeacherClasses(); 
                    loadAllClassesForTeacher();
                    loadAllTeachers(); // Load teachers so names show in class details
                });
            });
        }

        function showTeacherTab(tab) {
            document.querySelectorAll('#teacherDashboard .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#teacherDashboard .nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`teacherTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            event.target.classList.add('active');
            if (tab === 'materials') loadTeacherMaterials();
            if (tab === 'schedule') renderTeacherSchedule();
            if (tab === 'calendar') renderTeacherCalendar();
            if (tab === 'suggestions') loadTeacherSuggestions();
            if (tab === 'today') loadTodayClasses();
            if (tab === 'completed') loadTeacherCompletedClasses();
        }
        
        function renderTeacherCalendar() {
            const grid = document.getElementById('teacherMonthlyCalendarGrid');
            const label = document.getElementById('teacherCalendarMonthLabel');
            if (!grid || !label) return;
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[calendarMonth]} ${calendarYear} (EST)`;
            
            const today = getESTToday();
            
            let courseStart = null, courseEnd = null;
            if (schedulerSettings.startDate) {
                courseStart = parseESTDate(schedulerSettings.startDate);
                courseEnd = getCourseEndDate();
            }
            
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Build class schedule map - only for teacher's classes
            const myClasses = allClassesForTeacher.filter(c => c.teacherId === currentUser?.odId && c.status !== 'completed');
            const classDays = {};
            
            // Clear and rebuild teacher calendar class map
            teacherCalendarClassMap = {};
            
            // Helper to get week dates for a specific class based on its start date
            function getClassWeekDates(cls, weekNum) {
                if (!cls.startDate) return null;
                const classStart = parseESTDate(cls.startDate);
                const weekStart = new Date(classStart);
                weekStart.setDate(classStart.getDate() + (weekNum - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                return { start: weekStart, end: weekEnd };
            }
            
            myClasses.forEach(cls => {
                if (!cls.startDate) return; // Skip classes without start date
                
                for (let week = 1; week <= 6; week++) {
                    const weekDates = getClassWeekDates(cls, week);
                    if (!weekDates) continue;
                    
                    // Find the class day within this week
                    const dayOffset = cls.day === 'Saturday' ? 6 : 0; // Saturday = 6, Sunday = 0
                    const classDate = new Date(weekDates.start);
                    classDate.setDate(weekDates.start.getDate() + ((dayOffset - weekDates.start.getDay() + 7) % 7));
                    
                    const dateKey = `${classDate.getFullYear()}-${classDate.getMonth()}-${classDate.getDate()}`;
                    if (!classDays[dateKey]) classDays[dateKey] = [];
                    classDays[dateKey].push({ ...cls, week });
                    
                    // Also store in teacherCalendarClassMap for click handling
                    if (!teacherCalendarClassMap[dateKey]) teacherCalendarClassMap[dateKey] = [];
                    teacherCalendarClassMap[dateKey].push({ ...cls, week });
                }
            });
            
            let html = '';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            const prevMonth = new Date(calendarYear, calendarMonth, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(calendarYear, calendarMonth, day);
                const dateKey = `${calendarYear}-${calendarMonth}-${day}`;
                const dayClasses = classDays[dateKey] || [];
                
                let classes = ['calendar-day'];
                if (currentDate.getTime() === today.getTime()) classes.push('today');
                if (courseStart && currentDate.getTime() === courseStart.getTime()) classes.push('course-start');
                if (courseEnd && currentDate.getTime() === courseEnd.getTime()) classes.push('course-end');
                if (dayClasses.length > 0) classes.push('has-class');
                
                let weekNum = '';
                if (courseStart && currentDate >= courseStart && currentDate <= courseEnd) {
                    const diffDays = Math.floor((currentDate - courseStart) / (1000 * 60 * 60 * 24));
                    weekNum = `W${Math.floor(diffDays / 7) + 1}`;
                }
                
                // Add click handler for days with classes
                const clickHandler = dayClasses.length > 0 ? `onclick="openTeacherCalendarDayClasses('${dateKey}')"` : '';
                const cursorStyle = dayClasses.length > 0 ? 'cursor: pointer;' : '';
                
                html += `<div class="${classes.join(' ')}" ${clickHandler} style="${cursorStyle}">
                    <div class="calendar-day-number">${day}</div>
                    ${weekNum ? `<div class="calendar-week-label">${weekNum}</div>` : ''}
                    ${dayClasses.length > 0 ? `
                        <div>
                            ${dayClasses.map(c => `<span class="calendar-class-dot" style="background: ${getLevelColor(c.level)};" title="${LEVELS[c.level]} - ${c.time}" onclick="event.stopPropagation(); openClassDetails('${c.id}')"></span>`).join('')}
                        </div>
                        <div class="calendar-class-info">${dayClasses.length} class${dayClasses.length > 1 ? 'es' : ''}</div>
                    ` : ''}
                </div>`;
            }
            
            const remainingCells = 42 - (startDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        // Store teacher calendar class data for click handling
        let teacherCalendarClassMap = {};
        
        function openTeacherCalendarDayClasses(dateKey) {
            const dayClasses = teacherCalendarClassMap[dateKey] || [];
            if (dayClasses.length === 1) {
                openClassDetails(dayClasses[0].id);
            } else if (dayClasses.length > 1) {
                // Show modal with clickable class options (reuse the same modal as admin)
                const container = document.getElementById('calendarClassPickerList');
                container.innerHTML = dayClasses.map(c => {
                    const teacher = allTeachers.find(t => t.id === c.teacherId);
                    return `
                        <div class="calendar-class-option" onclick="closeCalendarClassPicker(); openClassDetails('${c.id}');" style="padding: 12px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #00ffff; font-size: 14px; margin-bottom: 5px;">${c.time}</div>
                                    <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: #888;">Week ${c.week || '-'}</div>
                                    ${teacher ? `<div style="font-size: 11px; color: #39ff14;">ðŸ‘¨â€ðŸ« ${teacher.name}</div>` : ''}
                                    <div style="font-size: 11px; color: #ffff00;">${(c.students || []).length} students</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('calendarClassPickerModal').classList.add('active');
            }
        }
        
        // Load all classes for teacher schedule view
        let allClassesForTeacher = [];
        async function loadAllClassesForTeacher() {
            try {
                const snap = await db.collection('scheduler_classes').get();
                allClassesForTeacher = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { console.error(e); }
        }

        // Load Data
        async function loadSchedulerSettings() {
            try {
                const doc = await db.collection('scheduler_settings').doc('main').get();
                if (doc.exists) schedulerSettings = { ...schedulerSettings, ...doc.data() };
                updateWeekTrackers();
                if (currentUser?.role === 'admin' || currentUser?.role === 'support') {
                    document.getElementById('settingMinStudents').value = schedulerSettings.minStudents;
                    document.getElementById('settingMaxStudents').value = schedulerSettings.maxStudents;
                    document.getElementById('settingCurrentWeek').value = schedulerSettings.currentWeek;
                    if (schedulerSettings.startDate) {
                        document.getElementById('settingStartDate').value = schedulerSettings.startDate;
                    }
                    
                    // Update display values
                    const displayMin = document.getElementById('displayMinStudents');
                    const displayMax = document.getElementById('displayMaxStudents');
                    if (displayMin) displayMin.textContent = schedulerSettings.minStudents;
                    if (displayMax) displayMax.textContent = schedulerSettings.maxStudents;
                    
                    renderCourseCalendar();
                }
            } catch (e) { console.error(e); }
        }

        function updateWeekTrackers() {
            const html = Array.from({ length: 6 }, (_, i) => {
                const w = i + 1;
                const dateStr = getWeekDateString(w);
                return `<button class="week-btn ${w === schedulerSettings.currentWeek ? 'current' : ''} ${w < schedulerSettings.currentWeek ? 'completed' : ''}" onclick="setCurrentWeek(${w})" title="${dateStr}">Week ${w}${dateStr ? `<br><span style="font-size: 10px;">${dateStr}</span>` : ''}</button>`;
            }).join('');
            ['dashboardWeekTracker', 'classesWeekTracker', 'teacherWeekTracker'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = html; });
        }
        
        function getWeekDateString(weekNum) {
            if (!schedulerSettings.startDate) return '';
            const start = new Date(schedulerSettings.startDate + 'T00:00:00');
            const weekStart = new Date(start);
            weekStart.setDate(start.getDate() + (weekNum - 1) * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
            return `${formatDate(weekStart)}-${formatDate(weekEnd)}`;
        }
        
        function getWeekDates(weekNum) {
            if (!schedulerSettings.startDate) return null;
            const start = parseESTDate(schedulerSettings.startDate);
            const weekStart = new Date(start);
            weekStart.setDate(start.getDate() + (weekNum - 1) * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return { start: weekStart, end: weekEnd };
        }
        
        function getCourseEndDate() {
            if (!schedulerSettings.startDate) return null;
            const start = parseESTDate(schedulerSettings.startDate);
            const end = new Date(start);
            end.setDate(start.getDate() + (6 * 7) - 1); // 6 weeks
            return end;
        }
        
        function renderCourseCalendar() {
            const container = document.getElementById('courseCalendarGrid');
            if (!container) return;
            
            if (!schedulerSettings.startDate) {
                container.innerHTML = '<p style="color: #888; font-size: 12px; grid-column: 1/-1;">Set a start date above to see the course calendar.</p>';
                return;
            }
            
            const today = getESTToday();
            
            const startDate = parseESTDate(schedulerSettings.startDate);
            const endDate = getCourseEndDate();
            
            // Summary section
            const formatFullDate = (d) => d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            
            let html = `
                <div class="course-dates-summary" style="grid-column: 1/-1;">
                    <div class="course-date-item">
                        <div class="course-date-label">ðŸ“… COURSE START</div>
                        <div class="course-date-value">${formatFullDate(startDate)}</div>
                    </div>
                    <div class="course-date-item">
                        <div class="course-date-label">ðŸ COURSE END</div>
                        <div class="course-date-value end">${formatFullDate(endDate)}</div>
                    </div>
                </div>
            `;
            
            // Week cards
            for (let w = 1; w <= 6; w++) {
                const weekDates = getWeekDates(w);
                const isPast = weekDates.end < today;
                const isCurrent = w === schedulerSettings.currentWeek;
                const isFuture = weekDates.start > today;
                
                let status = 'Upcoming';
                if (isPast) status = 'âœ“ Completed';
                else if (isCurrent) status = 'â–¶ CURRENT WEEK';
                
                const formatShortDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                html += `
                    <div class="week-date-card ${isCurrent ? 'current' : ''} ${isPast ? 'past' : ''} ${isFuture ? 'future' : ''}">
                        <div class="week-date-number">Week ${w}</div>
                        <div class="week-date-range">${formatShortDate(weekDates.start)} - ${formatShortDate(weekDates.end)}</div>
                        <div class="week-date-status">${status}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function setCurrentWeek(w) {
            schedulerSettings.currentWeek = w;
            await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
            updateWeekTrackers();
            if (currentUser?.role === 'admin' || currentUser?.role === 'support') {
                renderCourseCalendar();
                renderAdminSchedule();
            }
            if (currentUser?.role === 'teacher') {
                loadTeacherClasses();
                renderTeacherSchedule();
            }
        }

        async function loadAllStudents() {
            console.log('Loading all students...');
            try {
                // Simple query without orderBy to avoid index requirements
                const snap = await db.collection('scheduler_students').get();
                console.log('Students snapshot:', snap.size, 'documents');
                allStudents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Sort locally by createdAt if available
                allStudents.sort((a, b) => {
                    const aTime = a.createdAt?.toDate?.() || new Date(0);
                    const bTime = b.createdAt?.toDate?.() || new Date(0);
                    return bTime - aTime;
                });
                
                console.log('Loaded students:', allStudents.length);
                renderStudentsTable(); 
                updateDashboardStats();
            } catch (e) { 
                console.error('Error loading students:', e); 
                document.getElementById('studentsTableBody').innerHTML = `<tr><td colspan="9" style="color: #ff3366;">Error loading: ${e.message}</td></tr>`;
            }
        }

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            // Only show students that are NOT assigned, proposed, or completed
            const unassignedStudents = allStudents.filter(s => s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed');
            
            if (unassignedStudents.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #888;">No unassigned students. All students are in classes, proposals, or completed.</td></tr>'; 
                return; 
            }
            tbody.innerHTML = unassignedStudents.map(s => {
                // Check if student has availability set (supports both classTime and legacy availabilities)
                const avail = s.availabilities || {};
                const hasAvailability = s.classTime || avail[1] || avail[2] || avail[3];
                const availButton = hasAvailability 
                    ? `<button class="btn btn-sm btn-info" onclick="showStudentAvailability('${s.id}', '${s.name.replace(/'/g, "\\'")}')">ðŸ• View</button>`
                    : '<span style="color: #888; font-size: 11px;">Not set</span>';
                
                return `
                <tr>
                    <td>${s.name}</td>
                    <td style="font-size: 11px;">${s.email}</td>
                    <td>${s.city || ''}, ${s.state || ''}</td>
                    <td style="font-size: 11px;">${s.timezone || 'N/A'}</td>
                    <td>${availButton}</td>
                    <td>
                        ${s.videoUrl ? `<button class="btn btn-sm btn-info" onclick="playStudentVideo('${s.videoUrl}', '${s.name}')" title="Watch pronunciation video">ðŸŽ¬ Watch</button>` : '<span style="color: #888; font-size: 11px;">No video</span>'}
                    </td>
                    <td>${s.level ? `<span class="level-badge level-${s.level}">${LEVELS[s.level]}</span>` : '<span style="color: #888;">Not assigned</span>'}</td>
                    <td><span class="status-badge status-${s.status}">${s.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="openLevelModal('${s.id}', '${s.name}', '${s.level || ''}')">ðŸ“</button>
                        <button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteStudent('${s.id}')" ${canDelete() ? '' : 'style="display:none;"'}>ðŸ—‘ï¸</button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        function showStudentAvailability(studentId, studentName) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const avail = student.availabilities || {};
            const hasLegacyAvail = avail[1] || avail[2] || avail[3];
            
            // Build time slot options
            const TIME_SLOTS = ['6:30 PM', '7:10 PM', '7:50 PM', '8:30 PM', '9:10 PM', '9:50 PM', '10:30 PM', '11:10 PM'];
            const DAYS = ['Saturday', 'Sunday'];
            let optionsHtml = '<option value="">-- Select Time --</option>';
            DAYS.forEach(day => {
                TIME_SLOTS.forEach(time => {
                    const val = day + '-' + time;
                    optionsHtml += '<option value="' + val + '">' + day + ' @ ' + time + ' EST</option>';
                });
            });
            
            let currentTime = '';
            let contentHtml;
            if (student.classTime && !hasLegacyAvail) {
                const parts = student.classTime.split('-');
                const day = parts[0];
                const time = parts.slice(1).join('-');
                currentTime = student.classTime;
                contentHtml = '<div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; border-radius: 8px; padding: 12px; margin-bottom: 15px;"><div style="font-size: 11px; color: #39ff14; margin-bottom: 5px;">ðŸ“… Current Class Time</div><div style="color: #fff; font-size: 14px;">' + day + ' @ ' + time + ' EST</div></div>';
            } else {
                contentHtml = '<div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; border-radius: 8px; padding: 12px; margin-bottom: 10px;"><div style="font-size: 11px; color: #39ff14; margin-bottom: 5px;">1st Choice (Most Preferred)</div><div style="color: #fff; font-size: 14px;">' + (avail[1] || '<span style="color: #888;">Not set</span>') + '</div></div><div style="background: rgba(0,255,255,0.2); border: 2px solid #00ffff; border-radius: 8px; padding: 12px; margin-bottom: 10px;"><div style="font-size: 11px; color: #00ffff; margin-bottom: 5px;">2nd Choice</div><div style="color: #fff; font-size: 14px;">' + (avail[2] || '<span style="color: #888;">Not set</span>') + '</div></div><div style="background: rgba(255,0,255,0.2); border: 2px solid #ff00ff; border-radius: 8px; padding: 12px; margin-bottom: 15px;"><div style="font-size: 11px; color: #ff00ff; margin-bottom: 5px;">3rd Choice</div><div style="color: #fff; font-size: 14px;">' + (avail[3] || '<span style="color: #888;">Not set</span>') + '</div></div>';
                currentTime = avail[1] || '';
            }
            
            // Add edit section
            contentHtml += '<div style="border-top: 1px solid #444; padding-top: 15px; margin-top: 10px;"><div style="font-size: 11px; color: #ff9900; margin-bottom: 8px;">âœï¸ Change Availability</div><select id="editAvailabilitySelect" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #ff9900; border-radius: 5px; color: #fff; font-size: 12px;">' + optionsHtml + '</select><button class="btn" style="width: 100%; margin-top: 10px; background: #ff9900; border-color: #ff9900; color: #000;" onclick="confirmChangeAvailability(\'' + studentId + '\', \'' + studentName.replace(/'/g, "\\'") + '\', \'' + currentTime + '\')">ðŸ’¾ Update Availability</button></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'availabilityModal';
            modal.innerHTML = '<div class="modal" style="max-width: 400px;"><button class="modal-close" onclick="document.getElementById(\'availabilityModal\').remove()">âœ•</button><h3 class="modal-title">ðŸ• ' + studentName + '\'s Availability</h3><div style="margin-top: 15px;">' + contentHtml + '</div><button class="btn btn-secondary" style="margin-top: 15px; width: 100%;" onclick="document.getElementById(\'availabilityModal\').remove()">Close</button></div>';
            document.body.appendChild(modal);
        }
        
        async function confirmChangeAvailability(studentId, studentName, currentTime) {
            const newTime = document.getElementById('editAvailabilitySelect').value;
            
            if (!newTime) {
                alert('Please select a new time slot.');
                return;
            }
            
            if (newTime === currentTime) {
                alert('The selected time is the same as the current time.');
                return;
            }
            
            const newParts = newTime.split('-');
            const newDay = newParts[0];
            const newTimeStr = newParts.slice(1).join('-');
            
            let currentDisplay = 'Not set';
            if (currentTime) {
                const currentParts = currentTime.split('-');
                currentDisplay = currentParts[0] + ' @ ' + currentParts.slice(1).join('-') + ' EST';
            }
            
            const confirmed = confirm(
                'âš ï¸ CONFIRM AVAILABILITY CHANGE\n\n' +
                'Student: ' + studentName + '\n\n' +
                'Current: ' + currentDisplay + '\n' +
                'New: ' + newDay + ' @ ' + newTimeStr + ' EST\n\n' +
                'Are you sure you want to change this student\'s availability?'
            );
            
            if (!confirmed) return;
            
            try {
                // Update in Firebase
                await db.collection('scheduler_students').doc(studentId).update({
                    classTime: newTime,
                    availabilities: firebase.firestore.FieldValue.delete()
                });
                
                // Update local data
                const studentIdx = allStudents.findIndex(s => s.id === studentId);
                if (studentIdx !== -1) {
                    allStudents[studentIdx].classTime = newTime;
                    delete allStudents[studentIdx].availabilities;
                }
                
                alert('âœ… Availability updated successfully!');
                
                // Close modal and refresh
                document.getElementById('availabilityModal').remove();
                renderStudentsTable();
                renderLimboStudents();
                
            } catch (error) {
                console.error('Error updating availability:', error);
                alert('âŒ Error updating availability: ' + error.message);
            }
        }
        
        function playStudentVideo(videoUrl, studentName) {
            // Open modal with video player
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'videoPlayerModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <button class="modal-close" onclick="closeVideoPlayer()">âœ•</button>
                    <h3 class="modal-title">ðŸŽ¬ ${studentName}'s Pronunciation Recording</h3>
                    <div style="text-align: center; padding: 15px;">
                        <video src="${videoUrl}" controls autoplay style="width: 100%; max-width: 640px; border-radius: 8px; background: #000;"></video>
                    </div>
                    <div style="background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 10px; margin-top: 10px;">
                        <p style="font-size: 12px; color: #ffff00; margin-bottom: 5px;">ðŸ“– Expected to read:</p>
                        <p style="font-size: 13px; color: #888;">"í™©í˜¼ì´ ì§ˆ ë¬´ë µ, ë‚¡ì€ ì•„íŒŒíŠ¸ ë‹¨ì§€ ë†€ì´í„° ë²¤ì¹˜ì—ëŠ” ì–¸ì œë‚˜ ê°™ì€ í’ê²½ì´ íŽ¼ì³ì¡Œë‹¤..."</p>
                        <p style="font-size: 13px; color: #ff9900; margin-top: 10px;">If they said <strong style="color: #00ffff;">"I do not know how to read Korean"</strong> â†’ Absolute Beginner level</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeVideoPlayer() {
            const modal = document.getElementById('videoPlayerModal');
            if (modal) modal.remove();
        }

        function updateDashboardStats() {
            document.getElementById('statTotalStudents').textContent = allStudents.length;
            document.getElementById('statAssignedStudents').textContent = allStudents.filter(s => s.status === 'assigned').length;
            document.getElementById('statPendingStudents').textContent = allStudents.filter(s => !s.level && s.status !== 'assigned' && s.status !== 'completed').length;
            // Limbo count includes students with status 'limbo' OR students with a level who aren't assigned/completed/proposed
            document.getElementById('statLimboStudents').textContent = allStudents.filter(s => 
                s.status === 'limbo' || 
                (s.level && s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed')
            ).length;
            document.getElementById('statTotalClasses').textContent = allClasses.filter(c => c.status !== 'completed').length;
        }

        async function loadAllTeachers() {
            try {
                const snap = await db.collection('scheduler_teachers').get();
                allTeachers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTeachersList();
            } catch (e) { console.error(e); }
        }

        function renderTeachersList() {
            const container = document.getElementById('teachersListContainer');
            if (allTeachers.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 12px;">No teachers yet.</p>'; return; }
            container.innerHTML = allTeachers.map(t => {
                const tc = allClasses.filter(c => c.teacherId === t.id);
                return `<div class="teacher-card"><div class="teacher-name">ðŸ‘¨â€ðŸ« ${t.name}</div><div class="teacher-classes">ðŸ“§ ${t.email}<br>ðŸ“… ${(t.availableDays || []).join(', ')}<br>ðŸ“š ${tc.length} classes</div>${canDelete() ? `<button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteTeacher('${t.id}')" style="margin-top: 10px;">ðŸ—‘ï¸</button>` : ''}</div>`;
            }).join('');
        }

        // ==================== CLASS TYPE MANAGEMENT ====================
        
        async function loadClassTypes() {
            try {
                const snap = await db.collection('scheduler_class_types').get();
                allClassTypes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Merge custom class types with default levels
                LEVELS = { ...DEFAULT_LEVELS };
                allClassTypes.forEach(ct => {
                    LEVELS[ct.id] = ct.name;
                    CLASS_TYPE_COLORS[ct.id] = ct.color || '#ff00ff';
                    CLASS_TYPE_WEEKS[ct.id] = ct.weeks || 6;
                    if (!LEVEL_PRIORITY.includes(ct.id)) {
                        LEVEL_PRIORITY.push(ct.id);
                    }
                });
                
                // Update displays
                updateClassTypesDisplay();
                updateClassTypeSelects();
                updateLevelStyles();
                
            } catch (e) { 
                console.error('Error loading class types:', e); 
            }
        }
        
        function updateClassTypesDisplay() {
            const display = document.getElementById('classTypesDisplay');
            if (display) {
                const allTypes = Object.entries(LEVELS).map(([id, name]) => {
                    const color = CLASS_TYPE_COLORS[id] || '#888';
                    return `<span style="color: ${color}; margin-right: 10px;">${name}</span>`;
                }).join('');
                display.innerHTML = allTypes || 'None';
            }
        }
        
        function updateClassTypeSelects() {
            // Update Add Class modal select
            const addClassType = document.getElementById('addClassType');
            if (addClassType) {
                addClassType.innerHTML = '<option value="">-- Select Class Type --</option>' + 
                    Object.entries(LEVELS).map(([id, name]) => 
                        `<option value="${id}">${name}</option>`
                    ).join('');
            }
            
            // Update level select in assign level modal
            const levelSelect = document.getElementById('levelSelect');
            if (levelSelect) {
                const currentValue = levelSelect.value;
                levelSelect.innerHTML = '<option value="">-- Select --</option>' + 
                    Object.entries(LEVELS).map(([id, name]) => 
                        `<option value="${id}">${name}</option>`
                    ).join('');
                levelSelect.value = currentValue;
            }
            
            // Update material level selects (don't need "-- Select --")
            const materialLevelSelect = document.getElementById('materialLevelSelect');
            if (materialLevelSelect) {
                const currentValue = materialLevelSelect.value;
                materialLevelSelect.innerHTML = Object.entries(LEVELS).map(([id, name]) => 
                    `<option value="${id}">${name}</option>`
                ).join('');
                if (currentValue && LEVELS[currentValue]) {
                    materialLevelSelect.value = currentValue;
                }
            }
            
            const teacherMaterialLevel = document.getElementById('teacherMaterialLevel');
            if (teacherMaterialLevel) {
                const currentValue = teacherMaterialLevel.value;
                teacherMaterialLevel.innerHTML = Object.entries(LEVELS).map(([id, name]) => 
                    `<option value="${id}">${name}</option>`
                ).join('');
                if (currentValue && LEVELS[currentValue]) {
                    teacherMaterialLevel.value = currentValue;
                }
            }
            
            // Update other level selects throughout the app with data-level-select attribute
            document.querySelectorAll('select[data-level-select]').forEach(select => {
                if (select.id === 'levelSelect' || select.id === 'materialLevelSelect' || select.id === 'teacherMaterialLevel' || select.id === 'addClassType') return; // Already handled
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select --</option>' + 
                    Object.entries(LEVELS).map(([id, name]) => 
                        `<option value="${id}">${name}</option>`
                    ).join('');
                select.value = currentValue;
            });
        }
        
        function updateLevelStyles() {
            // Dynamically add CSS for custom class type badges
            let styleEl = document.getElementById('dynamicLevelStyles');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamicLevelStyles';
                document.head.appendChild(styleEl);
            }
            
            let css = '';
            Object.entries(CLASS_TYPE_COLORS).forEach(([id, color]) => {
                css += `.level-${id} { border-color: ${color}; color: ${color}; background: ${color}20; }\n`;
            });
            styleEl.textContent = css;
        }
        
        function openAddClassTypeModal() {
            document.getElementById('classTypeId').value = '';
            document.getElementById('classTypeName').value = '';
            document.getElementById('classTypeWeeks').value = '6';
            document.getElementById('classTypeDescription').value = '';
            document.querySelector('input[name="classTypeColor"][value="#ff00ff"]').checked = true;
            
            // Show existing class types
            renderExistingClassTypes();
            
            document.getElementById('addClassTypeModal').classList.add('active');
        }
        
        function renderExistingClassTypes() {
            const container = document.getElementById('existingClassTypesList');
            if (!container) return;
            
            const customTypes = allClassTypes;
            if (customTypes.length === 0) {
                container.innerHTML = '<p style="color: #666;">No custom class types yet. Default types: Absolute Beginner, Novice, Beginner, Advanced Beginner</p>';
                return;
            }
            
            container.innerHTML = customTypes.map(ct => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px; margin-bottom: 5px;">
                    <span style="color: ${ct.color || '#fff'};">${ct.name} (${ct.id})</span>
                    <button class="btn btn-sm" style="background: #ff3366; padding: 3px 8px; font-size: 10px;" onclick="deleteClassType('${ct.id}')">ðŸ—‘ï¸</button>
                </div>
            `).join('');
        }
        
        async function saveClassType() {
            const id = document.getElementById('classTypeId').value.trim();
            const name = document.getElementById('classTypeName').value.trim();
            const weeks = parseInt(document.getElementById('classTypeWeeks').value) || 6;
            const description = document.getElementById('classTypeDescription').value.trim();
            const color = document.querySelector('input[name="classTypeColor"]:checked')?.value || '#ff00ff';
            
            if (!id || !name) {
                alert('Please fill in the Class Type ID and Display Name');
                return;
            }
            
            if (DEFAULT_LEVELS[id]) {
                alert('This ID is reserved for a default level. Please choose a different ID.');
                return;
            }
            
            try {
                await db.collection('scheduler_class_types').doc(id).set({
                    name,
                    color,
                    weeks,
                    description,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`Class type "${name}" created successfully!`);
                await loadClassTypes();
                renderExistingClassTypes();
                
                // Clear form
                document.getElementById('classTypeId').value = '';
                document.getElementById('classTypeName').value = '';
                document.getElementById('classTypeDescription').value = '';
                
            } catch (e) {
                console.error('Error saving class type:', e);
                alert('Error creating class type: ' + e.message);
            }
        }
        
        async function deleteClassType(id) {
            if (!confirm(`Are you sure you want to delete this class type? This won't delete existing classes of this type.`)) return;
            
            try {
                await db.collection('scheduler_class_types').doc(id).delete();
                alert('Class type deleted');
                await loadClassTypes();
                renderExistingClassTypes();
            } catch (e) {
                console.error('Error deleting class type:', e);
                alert('Error: ' + e.message);
            }
        }
        
        function openAddClassModal() {
            // Populate teachers dropdown
            const teacherSelect = document.getElementById('addClassTeacher');
            teacherSelect.innerHTML = '<option value="">-- No Teacher --</option>' + 
                allTeachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            
            // Update class types dropdown
            updateClassTypeSelects();
            
            // Clear form
            document.getElementById('addClassType').value = '';
            document.getElementById('addClassDay').value = '';
            document.getElementById('addClassTime').value = '';
            document.getElementById('addClassStartDate').value = '';
            document.getElementById('addClassTeacher').value = '';
            document.getElementById('addClassMaxStudents').value = '10';
            
            document.getElementById('addClassModal').classList.add('active');
        }
        
        async function saveNewClass() {
            const level = document.getElementById('addClassType').value;
            const day = document.getElementById('addClassDay').value;
            const time = document.getElementById('addClassTime').value;
            const startDate = document.getElementById('addClassStartDate').value;
            const teacherId = document.getElementById('addClassTeacher').value || null;
            const maxStudents = parseInt(document.getElementById('addClassMaxStudents').value) || 10;
            
            if (!level || !day || !time || !startDate) {
                alert('Please fill in all required fields (Class Type, Day, Time, Start Date)');
                return;
            }
            
            try {
                const classData = {
                    level,
                    day,
                    time,
                    startDate,
                    teacherId,
                    maxStudents,
                    students: [],
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdManually: true
                };
                
                const docRef = await db.collection('scheduler_classes').add(classData);
                
                alert(`Class created successfully! ID: ${docRef.id}`);
                closeModal('addClassModal');
                await loadAllClasses();
                
            } catch (e) {
                console.error('Error creating class:', e);
                alert('Error creating class: ' + e.message);
            }
        }
        
        function getLevelColor(level) {
            return CLASS_TYPE_COLORS[level] || '#888';
        }
        
        function getLevelWeeks(level) {
            return CLASS_TYPE_WEEKS[level] || 6;
        }

        async function loadAllClasses() {
            try {
                const snap = await db.collection('scheduler_classes').get();
                allClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Also load prescheduled slots
                const prescheduledSnap = await db.collection('prescheduled_slots').get();
                allPrescheduledSlots = prescheduledSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                renderClasses(); renderLimboStudents(); updateDashboardStats();
            } catch (e) { console.error(e); }
        }

        function renderClasses() {
            const container = document.getElementById('classesContainer');
            // Only show active classes, not completed
            const activeClasses = allClasses.filter(c => c.status !== 'completed');
            
            let html = '';
            
            // Show active classes first
            if (activeClasses.length > 0) {
                html += activeClasses.map(c => {
                    const teacher = allTeachers.find(t => t.id === c.teacherId);
                    const available = getAvailableTeachers(c.day, c.time, c.id);
                    const startDateStr = c.startDate ? new Date(c.startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const canEditDate = currentUser?.role === 'admin' || currentUser?.role === 'support';
                    return `
                        <div class="class-card" ondragover="event.preventDefault()" ondrop="handleDrop(event, '${c.id}')">
                            <div class="class-header">
                                <div>
                                    <div class="class-day">${c.day}</div>
                                    <div class="class-time">${c.time} EST</div>
                                    ${canEditDate ? `
                                        <div style="font-size: 11px; color: #ffff00; margin-top: 3px; cursor: pointer; text-decoration: underline;" onclick="openEditStartDateModal('${c.id}', '${c.startDate || ''}', '${c.day}', '${c.time}', '${c.level}')" title="Click to edit start date">
                                            ðŸ“… Starts: ${startDateStr}
                                        </div>
                                    ` : `
                                        <div style="font-size: 11px; color: #ffff00; margin-top: 3px;">ðŸ“… Starts: ${startDateStr}</div>
                                    `}
                                </div>
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            </div>
                            <div class="student-list">${(c.students || []).map(s => `<div class="student-chip"><span class="rank-dot rank-${s.rank}"></span>${s.name}</div>`).join('')}</div>
                            <div style="margin-top: 10px; font-size: 11px; color: #888;">${(c.students || []).length} students</div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                ${teacher ? `<div style="color: #39ff14; font-size: 12px;">ðŸ‘¨â€ðŸ« ${teacher.name}</div><button class="btn btn-sm btn-warning" onclick="unassignTeacher('${c.id}')" style="margin-top: 5px;">Remove</button>` : `<div style="font-size: 11px; color: #888; margin-bottom: 5px;">Teachers:</div><div style="display: flex; gap: 5px; flex-wrap: wrap;">${available.length > 0 ? available.map(t => `<button class="assign-btn" onclick="assignTeacherToClass('${t.id}', '${c.id}')">${t.name}</button>`).join('') : '<span style="color: #ff3366; font-size: 11px;">None</span>'}</div>`}
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-success" onclick="markCourseComplete('${c.id}')" style="flex: 1;">ðŸŽ“ Complete</button>
                                <button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteClass('${c.id}')" title="Delete Class" ${canDelete() ? '' : 'style="display:none;"'}>ðŸ—‘ï¸</button>
                            </div>
                            <div class="drop-zone">Drop student here</div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show prescheduled slots at the bottom
            if (allPrescheduledSlots && allPrescheduledSlots.length > 0) {
                html += '<div style="margin-top: 20px;"><h4 style="color: #ff9800; margin-bottom: 10px; font-size: 13px;">â³ Pre-scheduled Classes</h4>';
                html += '<div style="display: grid; gap: 10px;">';
                html += allPrescheduledSlots.map(ps => {
                    const startDate = ps.startDate ? new Date(ps.startDate + 'T00:00:00') : null;
                    const startDateStr = startDate ? startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const classTypeName = LEVELS[ps.classType] || ps.classType || 'Class';
                    
                    // Calculate days until start
                    let daysUntilStart = '';
                    if (startDate) {
                        const now = new Date();
                        const diffTime = startDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysUntilStart = `<span style="color: #ffff00;">(in ${diffDays} day${diffDays > 1 ? 's' : ''})</span>`;
                        } else if (diffDays === 0) {
                            daysUntilStart = '<span style="color: #39ff14;">(Today!)</span>';
                        }
                    }
                    
                    return `
                        <div class="class-card" style="border: 2px solid #ff9800; background: rgba(255,152,0,0.1);">
                            <div class="class-header">
                                <div>
                                    <div class="class-day" style="color: #ff9800;">${ps.day}</div>
                                    <div class="class-time">${ps.time} EST</div>
                                    <div style="font-size: 11px; color: #ff9800; margin-top: 3px;">ðŸ“… Starts: ${startDateStr} ${daysUntilStart}</div>
                                </div>
                                <span class="level-badge level-${ps.classType}" style="border-color: #ff9800;">${classTypeName}</span>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; margin-top: 10px;">
                                <span style="color: #ff9800; font-size: 12px;">â³ Pre-scheduled - No students yet</span>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                <div style="color: #39ff14; font-size: 12px;">ðŸ‘¨â€ðŸ« ${ps.teacherName || 'Unassigned'}</div>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-warning" onclick="convertPrescheduleToClass('${ps.id}')" style="flex: 1;">ðŸ“š Create Class</button>
                                <button class="btn btn-sm btn-danger" onclick="deletePreschedule('${ps.id}')" title="Cancel Pre-schedule">âŒ</button>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div></div>';
            }
            
            if (activeClasses.length === 0 && (!allPrescheduledSlots || allPrescheduledSlots.length === 0)) {
                html = '<p style="color: #888; font-size: 12px;">No active classes yet.</p>';
            }
            
            container.innerHTML = html;
        }

        function renderLimboStudents() {
            const container = document.getElementById('limboContainer');
            // Include students with status 'limbo' OR students with a level who aren't assigned/completed/proposed
            const limbo = allStudents.filter(s => 
                s.status === 'limbo' || 
                (s.level && s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed')
            );
            if (limbo.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 12px;">No students in limbo.</p>'; return; }
            container.innerHTML = limbo.map(s => {
                const avail = s.availabilities || {};
                const hasLegacyAvail = avail[1] || avail[2] || avail[3];
                const isReturning = s.isReturningStudent ? '<span style="background: #ff9900; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">RETURNING</span>' : '';
                const needsLevel = !s.level ? '<span style="background: #ff3366; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">NEEDS CLASS</span>' : '';
                
                let availHtml;
                if (s.classTime && !hasLegacyAvail) {
                    const parts = s.classTime.split('-');
                    availHtml = '<span class="avail-tag pref-1">' + parts[0] + ' @ ' + parts.slice(1).join('-') + '</span>';
                } else if (hasLegacyAvail) {
                    availHtml = (avail[1] ? '<span class="avail-tag pref-1">1st: ' + avail[1] + '</span>' : '') + (avail[2] ? '<span class="avail-tag pref-2">2nd: ' + avail[2] + '</span>' : '') + (avail[3] ? '<span class="avail-tag pref-3">3rd: ' + avail[3] + '</span>' : '');
                } else {
                    availHtml = '<span style="color: #888; font-size: 11px;">No availability set</span>';
                }
                
                return `
                <div class="limbo-student" draggable="true" ondragstart="draggedStudentId='${s.id}'; document.querySelectorAll('.drop-zone').forEach(z=>z.classList.add('active'));" ondragend="draggedStudentId=null; document.querySelectorAll('.drop-zone').forEach(z=>z.classList.remove('active'));">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="color: #00ffff; margin-bottom: 5px;">${s.name}${isReturning}${needsLevel}</div>
                        <button class="btn btn-sm" style="background: #ff9800; color: #000; padding: 2px 6px; font-size: 10px;" onclick="event.stopPropagation(); returnToAccountCreation('${s.id}', '${s.name.replace(/'/g, "\\'")}')">â†©ï¸ Return</button>
                    </div>
                    ${s.level ? `<span class="level-badge level-${s.level}">${LEVELS[s.level]}</span>` : '<span style="color: #888; font-size: 11px;">No class assigned</span>'}
                    <div class="limbo-availability">
                        ${availHtml}
                    </div>
                </div>
            `}).join('');
        }
        
        async function returnToAccountCreation(studentId, studentName) {
            if (!confirm(`Return "${studentName}" to Account Creation?\n\nThis will remove them from the scheduler and they will need to be re-added.`)) return;
            
            try {
                // Delete from scheduler_students collection
                await db.collection('scheduler_students').doc(studentId).delete();
                
                // Remove from local array
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) allStudents.splice(idx, 1);
                
                renderStudentsTable();
                renderLimboStudents();
                updateDashboardStats();
                
                alert(`âœ… ${studentName} has been returned to Account Creation.`);
            } catch (e) {
                console.error('Error returning student:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function convertPrescheduleToClass(prescheduleId) {
            const ps = allPrescheduledSlots.find(p => p.id === prescheduleId);
            if (!ps) return;
            
            if (!confirm(`Create actual class from pre-scheduled slot?\n\n${ps.day} @ ${ps.time}\n${LEVELS[ps.classType] || ps.classType}\nTeacher: ${ps.teacherName}\n\nYou can then add students to this class.`)) return;
            
            try {
                // Create the class
                const classData = {
                    day: ps.day,
                    time: ps.time,
                    level: ps.classType,
                    teacherId: ps.teacherId,
                    startDate: ps.startDate,
                    students: [],
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const ref = await db.collection('scheduler_classes').add(classData);
                allClasses.push({ id: ref.id, ...classData });
                
                // Delete the prescheduled slot
                await db.collection('prescheduled_slots').doc(prescheduleId).delete();
                const idx = allPrescheduledSlots.findIndex(p => p.id === prescheduleId);
                if (idx !== -1) allPrescheduledSlots.splice(idx, 1);
                
                renderClasses();
                renderLimboStudents();
                updateDashboardStats();
                
                alert('âœ… Class created! You can now add students to it.');
                
            } catch (e) {
                console.error('Error converting preschedule:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function deletePreschedule(prescheduleId) {
            const ps = allPrescheduledSlots.find(p => p.id === prescheduleId);
            if (!ps) return;
            
            if (!confirm(`Delete pre-scheduled class?\n\n${ps.day} @ ${ps.time}\n${LEVELS[ps.classType] || ps.classType}`)) return;
            
            try {
                await db.collection('prescheduled_slots').doc(prescheduleId).delete();
                const idx = allPrescheduledSlots.findIndex(p => p.id === prescheduleId);
                if (idx !== -1) allPrescheduledSlots.splice(idx, 1);
                
                renderClasses();
                
                alert('âœ… Pre-scheduled class deleted.');
                
            } catch (e) {
                console.error('Error deleting preschedule:', e);
                alert('âŒ Error: ' + e.message);
            }
        }

        function getAvailableTeachers(day, time, excludeId) {
            return allTeachers.filter(t => {
                if (!(t.availableDays || []).includes(day)) return false;
                // Only check against ACTIVE classes (not completed ones)
                return !allClasses.find(c => c.id !== excludeId && c.teacherId === t.id && c.day === day && c.time === time && c.status !== 'completed');
            });
        }

        // Level Assignment
        function openLevelModal(id, name, level) {
            document.getElementById('modalStudentId').value = id;
            document.getElementById('modalStudentName').textContent = name;
            document.getElementById('levelSelect').value = level || '';
            document.getElementById('levelModal').classList.add('active');
        }

        function closeLevelModal() { document.getElementById('levelModal').classList.remove('active'); }
        
        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active'); 
        }

        async function assignStudentLevel() {
            const id = document.getElementById('modalStudentId').value;
            const level = document.getElementById('levelSelect').value;
            if (!level) { showMessage('levelModalMessage', 'Select a level', 'error'); return; }
            try {
                await db.collection('scheduler_students').doc(id).update({ level });
                const idx = allStudents.findIndex(s => s.id === id);
                if (idx !== -1) allStudents[idx].level = level;
                closeLevelModal(); renderStudentsTable(); updateDashboardStats();
            } catch (e) { showMessage('levelModalMessage', 'Error: ' + e.message, 'error'); }
        }

        async function deleteStudent(id) {
            if (!confirm('Delete this student?')) return;
            await db.collection('scheduler_students').doc(id).delete();
            allStudents = allStudents.filter(s => s.id !== id);
            renderStudentsTable(); updateDashboardStats();
        }

        // Teacher Management
        async function addNewTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            const email = document.getElementById('newTeacherEmail').value.trim();
            const password = document.getElementById('newTeacherPassword').value;
            if (!name || !email || !password) { showMessage('addTeacherMessage', 'Fill all fields', 'error'); return; }

            if (password.length < 6) { showMessage('addTeacherMessage', 'Password must be at least 6 characters', 'error'); return; }

            const days = [];
            if (document.getElementById('teacherDaySat').checked) days.push('Saturday');
            if (document.getElementById('teacherDaySun').checked) days.push('Sunday');
            if (document.getElementById('teacherDayThu').checked) days.push('Thursday');

            try {
                console.log('Creating teacher account for:', email);
                
                // Use secondary auth to create account without logging out admin
                const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                console.log('Teacher auth account created:', userCredential.user.uid);
                
                // Sign out of secondary auth immediately
                await secondaryAuth.signOut();
                
                // Add to scheduler_teachers collection
                const ref = await db.collection('scheduler_teachers').add({ 
                    name, 
                    email, 
                    uid: userCredential.user.uid, 
                    availableDays: days, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                // Also add to users collection with teacher role
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    role: 'teacher',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                allTeachers.push({ id: ref.id, name, email, uid: userCredential.user.uid, availableDays: days });
                ['newTeacherName', 'newTeacherEmail', 'newTeacherPassword'].forEach(id => document.getElementById(id).value = '');
                renderTeachersList();
                showMessage('addTeacherMessage', 'Teacher added successfully!', 'success');
            } catch (e) { 
                console.error('Error creating teacher:', e);
                showMessage('addTeacherMessage', 'Error: ' + e.message, 'error'); 
            }
        }

        async function deleteTeacher(id) {
            if (!confirm('Delete this teacher?')) return;
            await db.collection('scheduler_teachers').doc(id).delete();
            for (const c of allClasses.filter(c => c.teacherId === id)) {
                await db.collection('scheduler_classes').doc(c.id).update({ teacherId: null });
                c.teacherId = null;
            }
            allTeachers = allTeachers.filter(t => t.id !== id);
            renderTeachersList(); renderClasses();
        }

        async function assignTeacherToClass(teacherId, classId) {
            await db.collection('scheduler_classes').doc(classId).update({ teacherId });
            const idx = allClasses.findIndex(c => c.id === classId);
            if (idx !== -1) allClasses[idx].teacherId = teacherId;
            renderClasses(); renderTeachersList();
        }

        async function unassignTeacher(classId) {
            await db.collection('scheduler_classes').doc(classId).update({ teacherId: null });
            const idx = allClasses.findIndex(c => c.id === classId);
            if (idx !== -1) allClasses[idx].teacherId = null;
            renderClasses(); renderTeachersList();
        }

        // Auto-Generate Classes
        let previewedClasses = [];
        let previewedLimboStudents = [];
        let selectedTeacherForAutoGen = null;
        let eligibleStudentsForAutoGen = [];
        
        function autoGenerateClasses() {
            eligibleStudentsForAutoGen = allStudents.filter(s => s.level && s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed');
            if (eligibleStudentsForAutoGen.length === 0) { alert('No eligible students with levels assigned. (Students must not be already assigned to a class)'); return; }
            
            // Reset selection
            selectedTeacherForAutoGen = null;
            previewedClasses = [];
            previewedLimboStudents = [];
            
            // Render teacher buttons
            renderTeacherSelectionButtons();
            
            // Clear preview container
            document.getElementById('classPreviewContainer').innerHTML = '<p style="color: #888; font-size: 12px;">Select a teacher above to generate class previews...</p>';
            document.getElementById('limboPreviewContainer').style.display = 'none';
            document.getElementById('selectedTeacherInfo').style.display = 'none';
            document.getElementById('generateProposalsBtn').disabled = true;
            
            document.getElementById('startDateModal').classList.add('active');
        }
        
        function renderTeacherSelectionButtons() {
            const container = document.getElementById('teacherSelectionButtons');
            if (allTeachers.length === 0) {
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">No teachers available. Please add teachers first.</p>';
                return;
            }
            
            container.innerHTML = allTeachers.map(t => {
                const days = (t.availableDays || []).join(', ') || 'No days set';
                return `
                    <button class="btn teacher-auto-gen-btn" id="teacherBtn-${t.id}" 
                            onclick="selectTeacherForAutoGen('${t.id}')"
                            style="padding: 10px 15px; background: rgba(0,0,0,0.5); border: 2px solid #888; color: #fff;">
                        <div style="font-weight: bold;">${t.name}</div>
                        <div style="font-size: 10px; color: #888;">${days}</div>
                    </button>
                `;
            }).join('');
        }
        
        function selectTeacherForAutoGen(teacherId) {
            const teacher = allTeachers.find(t => t.id === teacherId);
            if (!teacher) return;
            
            selectedTeacherForAutoGen = teacher;
            
            // Update button styles
            document.querySelectorAll('.teacher-auto-gen-btn').forEach(btn => {
                btn.style.borderColor = '#888';
                btn.style.background = 'rgba(0,0,0,0.5)';
            });
            const selectedBtn = document.getElementById(`teacherBtn-${teacherId}`);
            if (selectedBtn) {
                selectedBtn.style.borderColor = '#39ff14';
                selectedBtn.style.background = 'rgba(57,255,20,0.2)';
            }
            
            // Show selected teacher info
            document.getElementById('selectedTeacherInfo').style.display = 'block';
            document.getElementById('selectedTeacherName').textContent = teacher.name;
            document.getElementById('selectedTeacherDays').textContent = `Available: ${(teacher.availableDays || []).join(', ') || 'No days set'}`;
            
            // Generate class previews with teacher availability
            generateClassPreviewsWithTeacher(eligibleStudentsForAutoGen, teacher);
        }
        
        function generateClassPreviewsWithTeacher(eligible, teacher) {
            previewedClasses = [];
            previewedLimboStudents = [];
            const assigned = new Set();
            
            // Get teacher's available days
            const teacherDays = teacher.availableDays || [];
            
            // Get teacher's existing class times (to avoid double-booking)
            const teacherBusySlots = new Set();
            const teacherBusyUntil = {}; // slot -> Date when teacher will be free
            
            allClasses.forEach(c => {
                if (c.teacherId === teacher.id && c.status !== 'completed') {
                    teacherBusySlots.add(`${c.day}-${c.time}`);
                    
                    // Calculate when this class ends (for "available soon" feature)
                    if (c.startDate) {
                        const classLevel = c.level;
                        const weeksInClass = getLevelWeeks(classLevel) || 6;
                        const startDate = new Date(c.startDate);
                        const endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + (weeksInClass * 7));
                        
                        if (!teacherBusyUntil[`${c.day}-${c.time}`] || endDate < teacherBusyUntil[`${c.day}-${c.time}`]) {
                            teacherBusyUntil[`${c.day}-${c.time}`] = endDate;
                        }
                    }
                }
            });
            
            // First pass: Find classes teacher can teach NOW
            for (const level of LEVEL_PRIORITY) {
                const levelStudents = eligible.filter(s => s.level === level && !assigned.has(s.id));
                const slotGroups = {};

                levelStudents.forEach(student => {
                    const availabilities = getStudentAvailabilities(student);
                    for (let rank = 1; rank <= 3; rank++) {
                        const slot = availabilities[rank];
                        if (slot) {
                            const [day, time] = slot.split('-');
                            
                            // Check if teacher is available on this day
                            if (!teacherDays.includes(day)) continue;
                            
                            // Check if teacher is already busy at this time
                            if (teacherBusySlots.has(slot)) continue;
                            
                            if (!slotGroups[slot]) slotGroups[slot] = { students: [], ranks: {} };
                            if (!slotGroups[slot].ranks[student.id]) {
                                slotGroups[slot].students.push(student);
                                slotGroups[slot].ranks[student.id] = rank;
                            }
                        }
                    }
                });

                for (const [slot, group] of Object.entries(slotGroups)) {
                    const unassignedInGroup = group.students.filter(s => !assigned.has(s.id));
                    if (unassignedInGroup.length >= schedulerSettings.minStudents) {
                        const classStudents = unassignedInGroup.slice(0, schedulerSettings.maxStudents);
                        const [day, time] = slot.split('-');

                        previewedClasses.push({
                            id: `preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            day,
                            time,
                            level,
                            teacherId: teacher.id,
                            teacherName: teacher.name,
                            availableNow: true,
                            availableDate: null,
                            students: classStudents.map(s => ({
                                id: s.id,
                                name: s.name,
                                email: s.email,
                                discord: s.discord || '',
                                rank: group.ranks[s.id],
                                timezone: s.timezone
                            })),
                            startDate: null
                        });

                        classStudents.forEach(s => assigned.add(s.id));
                        
                        // Mark this slot as busy for the teacher
                        teacherBusySlots.add(slot);
                    }
                }
            }
            
            // Second pass: Find classes where teacher is BUSY but will be available soon
            for (const level of LEVEL_PRIORITY) {
                const levelStudents = eligible.filter(s => s.level === level && !assigned.has(s.id));
                const slotGroups = {};

                levelStudents.forEach(student => {
                    const availabilities = getStudentAvailabilities(student);
                    for (let rank = 1; rank <= 3; rank++) {
                        const slot = availabilities[rank];
                        if (slot) {
                            const [day, time] = slot.split('-');
                            
                            // Check if teacher is available on this day
                            if (!teacherDays.includes(day)) continue;
                            
                            // Only consider slots where teacher is currently busy but will be free
                            if (!teacherBusyUntil[slot]) continue;
                            
                            if (!slotGroups[slot]) slotGroups[slot] = { students: [], ranks: {}, availableDate: teacherBusyUntil[slot] };
                            if (!slotGroups[slot].ranks[student.id]) {
                                slotGroups[slot].students.push(student);
                                slotGroups[slot].ranks[student.id] = rank;
                            }
                        }
                    }
                });

                for (const [slot, group] of Object.entries(slotGroups)) {
                    const unassignedInGroup = group.students.filter(s => !assigned.has(s.id));
                    if (unassignedInGroup.length >= schedulerSettings.minStudents) {
                        const classStudents = unassignedInGroup.slice(0, schedulerSettings.maxStudents);
                        const [day, time] = slot.split('-');

                        previewedClasses.push({
                            id: `preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            day,
                            time,
                            level,
                            teacherId: teacher.id,
                            teacherName: teacher.name,
                            availableNow: false,
                            availableDate: group.availableDate,
                            students: classStudents.map(s => ({
                                id: s.id,
                                name: s.name,
                                email: s.email,
                                discord: s.discord || '',
                                rank: group.ranks[s.id],
                                timezone: s.timezone
                            })),
                            startDate: null
                        });

                        classStudents.forEach(s => assigned.add(s.id));
                    }
                }
            }
            
            // Find limbo students
            eligible.forEach(s => {
                if (!assigned.has(s.id)) {
                    previewedLimboStudents.push(s);
                }
            });
            
            renderClassPreviews();
        }
        
        function generateClassPreviews(eligible) {
            // Legacy function - now we use generateClassPreviewsWithTeacher
            // This is kept for backward compatibility but shouldn't be called directly
            previewedClasses = [];
            previewedLimboStudents = [];
            const assigned = new Set();
            
            for (const level of LEVEL_PRIORITY) {
                const levelStudents = eligible.filter(s => s.level === level && !assigned.has(s.id));
                const slotGroups = {};

                levelStudents.forEach(student => {
                    const availabilities = getStudentAvailabilities(student);
                    for (let rank = 1; rank <= 3; rank++) {
                        const slot = availabilities[rank];
                        if (slot) {
                            if (!slotGroups[slot]) slotGroups[slot] = { students: [], ranks: {} };
                            if (!slotGroups[slot].ranks[student.id]) {
                                slotGroups[slot].students.push(student);
                                slotGroups[slot].ranks[student.id] = rank;
                            }
                        }
                    }
                });

                for (const [slot, group] of Object.entries(slotGroups)) {
                    const unassignedInGroup = group.students.filter(s => !assigned.has(s.id));
                    if (unassignedInGroup.length >= schedulerSettings.minStudents) {
                        const classStudents = unassignedInGroup.slice(0, schedulerSettings.maxStudents);
                        const [day, time] = slot.split('-');

                        previewedClasses.push({
                            id: `preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            day,
                            time,
                            level,
                            students: classStudents.map(s => ({
                                id: s.id,
                                name: s.name,
                                email: s.email,
                                discord: s.discord || '',
                                rank: group.ranks[s.id],
                                timezone: s.timezone
                            })),
                            startDate: null
                        });

                        classStudents.forEach(s => assigned.add(s.id));
                    }
                }
            }
            
            // Find limbo students
            eligible.forEach(s => {
                if (!assigned.has(s.id)) {
                    previewedLimboStudents.push(s);
                }
            });
            
            renderClassPreviews();
        }
        
        function renderClassPreviews() {
            const container = document.getElementById('classPreviewContainer');
            const limboContainer = document.getElementById('limboPreviewContainer');
            const limboList = document.getElementById('limboStudentsList');
            const generateBtn = document.getElementById('generateProposalsBtn');
            
            // Generate Saturday options for quick select
            const saturdays = getUpcomingSaturdays(5);
            
            if (previewedClasses.length === 0) {
                container.innerHTML = '<p style="color: #ff3366; font-size: 13px;">âŒ No classes can be formed with the current students. Not enough students share the same availability.</p>';
                generateBtn.disabled = true;
                return;
            }
            
            // Separate available now vs available soon
            const availableNowClasses = previewedClasses.filter(c => c.availableNow !== false);
            const availableSoonClasses = previewedClasses.filter(c => c.availableNow === false);
            
            let html = '';
            
            // Available Now section
            if (availableNowClasses.length > 0) {
                html += '<h4 style="color: #39ff14; margin-bottom: 10px; font-size: 14px;">âœ… Available Now (' + availableNowClasses.length + ' classes)</h4>';
                html += availableNowClasses.map((cls, idx) => {
                    const actualIdx = previewedClasses.indexOf(cls);
                    return renderClassPreviewCard(cls, actualIdx, saturdays, 'available');
                }).join('');
            }
            
            // Available Soon section
            if (availableSoonClasses.length > 0) {
                html += '<h4 style="color: #ff9800; margin: 20px 0 10px 0; font-size: 14px;">â³ Available Soon (' + availableSoonClasses.length + ' classes)</h4>';
                html += '<p style="font-size: 11px; color: #888; margin-bottom: 10px;">These time slots are currently occupied but will be free when the existing class ends.</p>';
                html += availableSoonClasses.map((cls, idx) => {
                    const actualIdx = previewedClasses.indexOf(cls);
                    return renderClassPreviewCard(cls, actualIdx, saturdays, 'pending');
                }).join('');
            }
            
            container.innerHTML = html;
            
            // Show limbo students if any
            if (previewedLimboStudents.length > 0) {
                limboContainer.style.display = 'block';
                limboList.innerHTML = previewedLimboStudents.map(s => `
                    <span style="display: inline-block; padding: 5px 10px; margin: 3px; background: rgba(255,51,102,0.2); border-radius: 15px; font-size: 11px; color: #ff3366;">
                        ${s.name} (${LEVELS[s.level]})
                    </span>
                `).join('');
            } else {
                limboContainer.style.display = 'none';
            }
            
            updateGenerateButtonState();
        }
        
        function getUpcomingSaturdays(count) {
            const today = getESTToday();
            
            const daysUntilSat = (6 - today.getDay() + 7) % 7 || 7;
            const nextSat = new Date(today);
            nextSat.setDate(today.getDate() + daysUntilSat);
            
            const saturdays = [];
            for (let i = 0; i < count; i++) {
                const sat = new Date(nextSat);
                sat.setDate(nextSat.getDate() + (i * 7));
                saturdays.push(sat);
            }
            return saturdays;
        }
        
        function renderClassPreviewCard(cls, idx, saturdays, status) {
            const borderColor = status === 'available' ? '#39ff14' : '#ff9800';
            const bgColor = status === 'available' ? 'rgba(57,255,20,0.1)' : 'rgba(255,152,0,0.1)';
            
            // Calculate weeks until available for pending classes
            let availabilityInfo = '';
            if (status === 'pending' && cls.availableDate) {
                const now = new Date();
                const availDate = new Date(cls.availableDate);
                const diffTime = availDate - now;
                const diffWeeks = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffWeeks <= 0) {
                    availabilityInfo = '<span style="color: #39ff14; font-size: 11px;">âœ“ Available now!</span>';
                } else if (diffWeeks === 1) {
                    availabilityInfo = '<span style="color: #ff9800; font-size: 11px;">â³ Available in ~1 week (' + availDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ')</span>';
                } else {
                    availabilityInfo = '<span style="color: #ff9800; font-size: 11px;">â³ Available in ~' + diffWeeks + ' weeks (' + availDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ')</span>';
                }
            }
            
            return `
                <div class="class-preview-card ${cls.startDate ? 'has-date' : ''}" id="preview-card-${idx}" style="border-color: ${borderColor}; background: ${bgColor};">
                    <div class="class-preview-header">
                        <div class="class-preview-info">
                            <strong>${cls.day} @ ${cls.time}</strong>
                            <span class="level-badge level-${cls.level}" style="margin-left: 10px;">${LEVELS[cls.level]}</span>
                            ${cls.teacherName ? '<span style="margin-left: 10px; font-size: 11px; color: ' + borderColor + ';">ðŸ‘¨â€ðŸ« ' + cls.teacherName + '</span>' : ''}
                        </div>
                        <span style="font-size: 12px; color: ${cls.startDate ? '#39ff14' : '#ffff00'};">
                            ${cls.startDate ? 'âœ“ Date Set' : 'âš ï¸ Select Date'}
                        </span>
                    </div>
                    
                    ${availabilityInfo ? '<div style="margin: 5px 0;">' + availabilityInfo + '</div>' : ''}
                    
                    <div class="class-preview-students">
                        ${cls.students.map(s => `
                            <span class="class-preview-student" title="Preference: ${s.rank}">
                                ${s.name} <span style="color: #888;">(#${s.rank})</span>
                            </span>
                        `).join('')}
                    </div>
                    
                    <div class="class-preview-date ${cls.startDate ? 'selected' : ''}">
                        <label>ðŸ“… Start Date:</label>
                        <input type="date" value="${cls.startDate || ''}" onchange="setPreviewClassDate(${idx}, this.value)" ${status === 'pending' && cls.availableDate ? 'min="' + cls.availableDate.toISOString().split('T')[0] + '"' : ''}>
                    </div>
                    
                    ${status === 'pending' && cls.availableDate ? renderAvailableDateButton(cls, idx) : ''}
                    
                    <div class="saturday-quick-btns">
                        ${saturdays.map(sat => {
                            const dateStr = sat.toISOString().split('T')[0];
                            const label = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            const isSelected = cls.startDate === dateStr;
                            // For pending classes, disable dates before available date
                            const isDisabled = status === 'pending' && cls.availableDate && sat < cls.availableDate;
                            if (isDisabled) {
                                return '<button type="button" class="saturday-quick-btn disabled" disabled style="opacity: 0.4; cursor: not-allowed;">' + label + '</button>';
                            }
                            return '<button type="button" class="saturday-quick-btn ' + (isSelected ? 'selected' : '') + '" onclick="setPreviewClassDate(' + idx + ', \'' + dateStr + '\')">' + label + '</button>';
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderAvailableDateButton(cls, idx) {
            const availDate = new Date(cls.availableDate);
            // Find the first Saturday on or after the available date
            const dayOfWeek = availDate.getDay();
            const daysUntilSat = (6 - dayOfWeek + 7) % 7;
            const firstAvailableSaturday = new Date(availDate);
            if (daysUntilSat === 0 && availDate.getDay() !== 6) {
                // If it's not Saturday, go to next Saturday
                firstAvailableSaturday.setDate(availDate.getDate() + 7);
            } else {
                firstAvailableSaturday.setDate(availDate.getDate() + daysUntilSat);
            }
            
            const dateStr = firstAvailableSaturday.toISOString().split('T')[0];
            const label = firstAvailableSaturday.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const isSelected = cls.startDate === dateStr;
            
            return '<div style="margin: 8px 0;">' +
                '<button type="button" class="btn ' + (isSelected ? 'btn-success' : 'btn-warning') + '" ' +
                'onclick="setPreviewClassDate(' + idx + ', \'' + dateStr + '\')" ' +
                'style="width: 100%; padding: 8px; font-size: 12px;">' +
                'ðŸ“… Schedule for ' + label + ' (First available)' +
                '</button>' +
                '</div>';
        }
        
        function getUpcomingSaturdaysHTML(proposalId, selectedDate) {
            const saturdays = getUpcomingSaturdays(5);
            return saturdays.map(sat => {
                const dateStr = sat.toISOString().split('T')[0];
                const label = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isSelected = selectedDate === dateStr;
                return `<button type="button" class="saturday-quick-btn ${isSelected ? 'selected' : ''}" onclick="updateProposalDate('${proposalId}', '${dateStr}')">${label}</button>`;
            }).join('');
        }
        
        function setPreviewClassDate(idx, date) {
            if (previewedClasses[idx]) {
                previewedClasses[idx].startDate = date;
                renderClassPreviews();
            }
        }
        
        function updateGenerateButtonState() {
            const generateBtn = document.getElementById('generateProposalsBtn');
            const allHaveDates = previewedClasses.every(cls => cls.startDate);
            generateBtn.disabled = !allHaveDates || previewedClasses.length === 0;
            
            if (!allHaveDates && previewedClasses.length > 0) {
                const missing = previewedClasses.filter(c => !c.startDate).length;
                generateBtn.textContent = `âš ï¸ ${missing} class(es) need dates`;
            } else {
                generateBtn.textContent = `âœ“ Generate ${previewedClasses.length} Proposals`;
            }
        }
        
        function closeStartDateModal() {
            document.getElementById('startDateModal').classList.remove('active');
            // Note: Don't clear previewedClasses here - confirmAutoGenerate needs it
            // It will be cleared after processing or on cancel
        }
        
        function cancelStartDateModal() {
            document.getElementById('startDateModal').classList.remove('active');
            previewedClasses = [];
            previewedLimboStudents = [];
        }
        
        async function confirmAutoGenerate() {
            // Validate all classes have dates
            const classesWithoutDates = previewedClasses.filter(c => !c.startDate);
            if (classesWithoutDates.length > 0) {
                alert(`Please select a start date for all ${classesWithoutDates.length} classes.`);
                return;
            }
            
            if (previewedClasses.length === 0) {
                alert('No classes to generate.');
                return;
            }
            
            const teacherName = selectedTeacherForAutoGen ? selectedTeacherForAutoGen.name : 'No teacher';
            if (!confirm(`Generate ${previewedClasses.length} class proposals?\n\nTeacher: ${teacherName}`)) return;
            
            // Close modal but DON'T clear data yet
            document.getElementById('startDateModal').classList.remove('active');

            try {
                const newProposals = [];

                for (const cls of previewedClasses) {
                    const proposalData = {
                        day: cls.day,
                        time: cls.time,
                        level: cls.level,
                        students: cls.students.map(s => ({ 
                            id: s.id, 
                            name: s.name, 
                            email: s.email,
                            discord: s.discord || '',
                            rank: s.rank, 
                            timezone: s.timezone,
                            response: 'pending'
                        })),
                        teacherId: cls.teacherId || null,
                        proposedStartDate: cls.startDate,
                        status: 'draft',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const ref = await db.collection('scheduler_proposals').add(proposalData);
                    newProposals.push({ id: ref.id, ...proposalData });

                    // Update student statuses
                    for (const s of cls.students) {
                        await db.collection('scheduler_students').doc(s.id).update({ status: 'proposed', proposalId: ref.id });
                        const idx = allStudents.findIndex(st => st.id === s.id);
                        if (idx !== -1) { allStudents[idx].status = 'proposed'; allStudents[idx].proposalId = ref.id; }
                    }
                }

                // Mark limbo students
                for (const s of previewedLimboStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({ status: 'limbo' });
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) allStudents[idx].status = 'limbo';
                }

                allProposals = [...allProposals, ...newProposals];
                previewedClasses = [];
                previewedLimboStudents = [];
                selectedTeacherForAutoGen = null;
                
                renderStudentsTable(); renderLimboStudents(); updateDashboardStats(); renderProposals();
                
                // Switch to Proposals tab
                showAdminTab('proposals');
                
                alert(`Created ${newProposals.length} class proposals with ${teacherName}!`);
            } catch (e) { alert('Error: ' + e.message); console.error(e); }
        }

        // Drag & Drop
        async function handleDrop(event, classId) {
            event.preventDefault();
            if (!draggedStudentId) return;

            const student = allStudents.find(s => s.id === draggedStudentId);
            const targetClass = allClasses.find(c => c.id === classId);
            if (!student || !targetClass) return;

            const warnings = [];
            if ((targetClass.students || []).length >= schedulerSettings.maxStudents) warnings.push(`Class is full (${schedulerSettings.maxStudents} max)`);
            if (student.level !== targetClass.level) warnings.push(`Level mismatch: ${LEVELS[student.level]} vs ${LEVELS[targetClass.level]}`);

            if (warnings.length > 0) {
                pendingDropAction = { studentId: draggedStudentId, classId };
                document.getElementById('warningMessage').innerHTML = warnings.join('<br>');
                document.getElementById('warningModal').classList.add('active');
            } else {
                await executeDropAction(draggedStudentId, classId);
            }
        }

        async function executeDropAction(studentId, classId) {
            const student = allStudents.find(s => s.id === studentId);
            const targetClass = allClasses.find(c => c.id === classId);

            let rank = 3;
            const classSlot = `${targetClass.day}-${targetClass.time}`;
            Object.entries(student.availabilities || {}).forEach(([r, slot]) => { if (slot === classSlot) rank = parseInt(r); });

            targetClass.students = targetClass.students || [];
            targetClass.students.push({ id: student.id, name: student.name, rank, timezone: student.timezone });

            await db.collection('scheduler_classes').doc(classId).update({ students: targetClass.students });
            await db.collection('scheduler_students').doc(studentId).update({ status: 'assigned', classId });

            const idx = allStudents.findIndex(s => s.id === studentId);
            if (idx !== -1) { allStudents[idx].status = 'assigned'; allStudents[idx].classId = classId; }

            renderClasses(); renderLimboStudents(); renderStudentsTable(); updateDashboardStats();
        }

        function closeWarningModal() { document.getElementById('warningModal').classList.remove('active'); pendingDropAction = null; }
        async function confirmWarningAction() { if (pendingDropAction) await executeDropAction(pendingDropAction.studentId, pendingDropAction.classId); closeWarningModal(); }

        // Settings
        async function saveSettings() {
            schedulerSettings.minStudents = parseInt(document.getElementById('settingMinStudents').value) || 5;
            schedulerSettings.maxStudents = parseInt(document.getElementById('settingMaxStudents').value) || 10;
            schedulerSettings.currentWeek = parseInt(document.getElementById('settingCurrentWeek').value) || 1;
            schedulerSettings.startDate = document.getElementById('settingStartDate').value || null;
            await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
            updateWeekTrackers();
            renderCourseCalendar();
            
            // Update the display values
            const displayMin = document.getElementById('displayMinStudents');
            const displayMax = document.getElementById('displayMaxStudents');
            if (displayMin) displayMin.textContent = schedulerSettings.minStudents;
            if (displayMax) displayMax.textContent = schedulerSettings.maxStudents;
            
            showMessage('settingsMessage', 'Settings saved! Classes will now require ' + schedulerSettings.minStudents + '-' + schedulerSettings.maxStudents + ' students.', 'success');
        }

        // Materials (simplified)
        async function loadMaterialsForLevel() {
            const level = document.getElementById('materialLevelSelect').value;
            const week = document.getElementById('materialWeekSelect').value;
            try {
                let snap = await db.collection('scheduler_materials').get();
                let materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Filter by level and week
                materials = materials.filter(m => m.level === level && (m.week == week || m.week === parseInt(week)));
                
                materials.sort((a, b) => (a.order || 0) - (b.order || 0));
                renderMaterials(materials);
            } catch (e) {
                console.error('Error loading materials:', e);
                document.getElementById('materialsContainer').innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error loading materials: ${e.message}</p>`;
            }
        }

        function renderMaterials(materials) {
            const container = document.getElementById('materialsContainer');
            if (materials.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 14px; font-family: Noto Sans, sans-serif;">No materials for this selection.</p>'; return; }
            
            // Store materials for drag/drop
            window.currentMaterials = materials;
            
            container.innerHTML = materials.map((m, index) => `
                <div class="material-block" draggable="true" data-id="${m.id}" data-index="${index}"
                    ondragstart="handleMaterialDragStart(event)" 
                    ondragover="handleMaterialDragOver(event)" 
                    ondragenter="handleMaterialDragEnter(event)"
                    ondragleave="handleMaterialDragLeave(event)"
                    ondrop="handleMaterialDrop(event)" 
                    ondragend="handleMaterialDragEnd(event)">
                    <div class="material-header">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span class="drag-handle" style="cursor: grab; color: #666; margin-right: 5px;">â‹®â‹®</span>
                            <span class="material-type">${m.type}</span>
                        </div>
                        <div><button class="btn btn-sm btn-info" onclick="editMaterial('${m.id}')">âœï¸</button><button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteMaterial('${m.id}')" ${canDelete() ? '' : 'style="display:none;"'}>ðŸ—‘ï¸</button></div>
                    </div>
                    <div class="material-content">${renderMaterialContent(m)}</div>
                </div>
            `).join('');
        }
        
        let draggedMaterialId = null;
        let draggedMaterialIndex = null;
        
        function handleMaterialDragStart(e) {
            draggedMaterialId = e.currentTarget.dataset.id;
            draggedMaterialIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleMaterialDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleMaterialDragEnter(e) {
            e.preventDefault();
            if (e.currentTarget.dataset.id !== draggedMaterialId) {
                e.currentTarget.style.borderTop = '3px solid #00ffff';
            }
        }
        
        function handleMaterialDragLeave(e) {
            e.currentTarget.style.borderTop = '';
        }
        
        function handleMaterialDrop(e) {
            e.preventDefault();
            e.currentTarget.style.borderTop = '';
            
            const targetId = e.currentTarget.dataset.id;
            const targetIndex = parseInt(e.currentTarget.dataset.index);
            
            if (draggedMaterialId && draggedMaterialId !== targetId) {
                reorderMaterials(draggedMaterialIndex, targetIndex);
            }
        }
        
        function handleMaterialDragEnd(e) {
            e.currentTarget.style.opacity = '1';
            // Reset all borders
            document.querySelectorAll('.material-block').forEach(el => {
                el.style.borderTop = '';
            });
            draggedMaterialId = null;
            draggedMaterialIndex = null;
        }
        
        async function reorderMaterials(fromIndex, toIndex) {
            if (!window.currentMaterials || fromIndex === toIndex) return;
            
            const materials = [...window.currentMaterials];
            const [moved] = materials.splice(fromIndex, 1);
            materials.splice(toIndex, 0, moved);
            
            // Update order in Firebase
            try {
                const batch = db.batch();
                materials.forEach((m, idx) => {
                    const ref = db.collection('scheduler_materials').doc(m.id);
                    batch.update(ref, { order: idx });
                });
                await batch.commit();
                
                // Reload to show new order
                loadMaterialsForLevel();
            } catch (e) {
                console.error('Error reordering materials:', e);
                alert('Error saving order: ' + e.message);
            }
        }

        function renderMaterialContent(m, isAdmin = true) {
            const fontStyle = "font-family: 'Noto Sans', sans-serif; font-size: 12px; line-height: 1.6;";
            if (m.type === 'text') return `<div style="${fontStyle}">${m.content || ''}</div>`;
            if (m.type === 'link') {
                const drawpadBadge = m.isDrawpad 
                    ? '<span style="background: #00ffff; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ðŸŽ¨ DRAWPAD</span>'
                    : '<span style="background: #ffff00; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ðŸ”— LINK ONLY</span>';
                return `<a href="${m.url}" target="_blank" style="${fontStyle} color: #00ffff;">${m.title || m.url}</a>${drawpadBadge}`;
            }
            if (m.type === 'image') {
                if (isAdmin) {
                    return `
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <a href="${m.url}" download style="${fontStyle} color: #ffff00;">ðŸ“¥ Download Image</a>
                            <button class="btn btn-sm btn-info" onclick="openFilePreview('${m.url}', 'image')" style="font-size: 12px;">ðŸ‘ï¸ Preview</button>
                        </div>
                        <img src="${m.url}" alt="" style="max-width: 100%; border-radius: 4px; margin-top: 10px;">
                    `;
                }
                return `<img src="${m.url}" alt="" style="max-width: 100%; border-radius: 4px;">`;
            }
            if (m.type === 'file') {
                const filename = m.filename || 'Download';
                const url = m.url || '';
                const ext = filename.toLowerCase();
                const isPdf = ext.endsWith('.pdf') || url.toLowerCase().includes('.pdf');
                const isImage = ext.match(/\.(png|jpg|jpeg|gif|webp|svg|bmp)$/i);
                
                if (isAdmin && (isPdf || isImage)) {
                    return `
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <a href="${url}" download="${filename}" style="${fontStyle} color: #ffff00;">ðŸ“¥ ${filename}</a>
                            <button class="btn btn-sm btn-info" onclick="openFilePreview('${url}', '${isPdf ? 'pdf' : 'image'}')" style="font-size: 12px;">ðŸ‘ï¸ Preview</button>
                        </div>
                    `;
                }
                return `<a href="${url}" download="${filename}" style="${fontStyle} color: #ffff00;">ðŸ“¥ ${filename}</a>`;
            }
            if (m.type === 'permutation-game') {
                return `
                    <div style="background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(103,58,183,0.2)); border: 2px solid #9c27b0; border-radius: 10px; padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">ðŸ”„</span>
                            <strong style="color: #ce93d8; font-size: 14px;">${m.title || 'Yodafy Game'}</strong>
                        </div>
                        ${m.description ? `<p style="color: #b0b0c0; font-size: 12px; margin-bottom: 10px;">${m.description}</p>` : ''}
                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #9c27b0, #673ab7); border-color: #9c27b0; color: #fff;" onclick="openPermutationGame()">
                            ðŸŽ® Launch Game
                        </button>
                        <span style="font-size: 10px; color: #888; margin-left: 10px;">Uses AI (GPT)</span>
                    </div>
                `;
            }
            return '';
        }
        
        function openFilePreview(url, type) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'filePreviewModal';
            
            let contentHtml = '';
            if (type === 'pdf') {
                contentHtml = `<iframe src="${url}" style="width: 100%; height: 70vh; border: none; border-radius: 8px; background: #fff;"></iframe>`;
            } else {
                contentHtml = `<img src="${url}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">`;
            }
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 900px; max-height: 85vh;">
                    <button class="modal-close" onclick="closeFilePreview()">âœ•</button>
                    <h3 class="modal-title">ðŸ‘ï¸ File Preview</h3>
                    <div style="margin-top: 15px; text-align: center;">
                        ${contentHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeFilePreview() {
            const modal = document.getElementById('filePreviewModal');
            if (modal) modal.remove();
        }

        // ==================== PERMUTATION GAME ====================
        function openPermutationGame() {
            // Create fullscreen overlay for the game
            const overlay = document.createElement('div');
            overlay.id = 'permutationGameOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: #1a1a2e;
                z-index: 10000;
                overflow: auto;
            `;
            
            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'âœ• Close Game';
            closeBtn.style.cssText = `
                position: fixed;
                top: 15px;
                right: 15px;
                z-index: 10001;
                background: linear-gradient(135deg, #ff7777, #dd3333);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-family: 'Noto Sans', sans-serif;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            `;
            closeBtn.onclick = closePermutationGame;
            
            // Create iframe for the game
            const iframe = document.createElement('iframe');
            iframe.id = 'permutationGameFrame';
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
            `;
            
            // Game HTML content
            iframe.srcdoc = getPermutationGameHTML();
            
            overlay.appendChild(closeBtn);
            overlay.appendChild(iframe);
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
        }
        
        function closePermutationGame() {
            const overlay = document.getElementById('permutationGameOverlay');
            if (overlay) overlay.remove();
            document.body.style.overflow = '';
        }
        
        function getPermutationGameHTML() {
            return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŒŸ Yodafy Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Noto Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/sky.png?v=1750990355') repeat;
      background-size: auto;
      min-height: 100vh; 
      color: #e2e8f0; 
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background-image: 
        radial-gradient(1px 1px at 20px 30px, rgba(0,0,0,0.8), transparent),
        radial-gradient(1px 1px at 40px 70px, rgba(0,0,0,0.6), transparent),
        radial-gradient(1px 1px at 50px 160px, rgba(0,0,0,0.7), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(0,0,0,0.8), transparent),
        radial-gradient(1px 1px at 130px 80px, rgba(0,0,0,0.6), transparent),
        radial-gradient(2px 2px at 160px 120px, rgba(0,0,0,0.9), transparent),
        radial-gradient(1px 1px at 200px 50px, rgba(0,0,0,0.5), transparent),
        radial-gradient(1px 1px at 220px 150px, rgba(0,0,0,0.7), transparent),
        radial-gradient(1px 1px at 280px 90px, rgba(0,0,0,0.6), transparent),
        radial-gradient(2px 2px at 320px 20px, rgba(0,0,0,0.8), transparent),
        radial-gradient(1px 1px at 350px 180px, rgba(0,0,0,0.5), transparent),
        radial-gradient(1px 1px at 400px 60px, rgba(0,0,0,0.7), transparent),
        radial-gradient(1px 1px at 450px 130px, rgba(0,0,0,0.6), transparent),
        radial-gradient(2px 2px at 500px 200px, rgba(0,0,0,0.8), transparent);
      background-repeat: repeat;
      background-size: 550px 250px;
      z-index: 0;
      animation: twinkle 4s ease-in-out infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
    h1 { text-align: center; font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 0 30px rgba(0,255,255,0.3); }
    .subtitle { text-align: center; color: #b0c4de; margin-bottom: 30px; font-size: 14px; }
    .setup-panel { background: rgba(0,0,0,0.7); border: 3px solid #00ffff; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 0 20px rgba(0,255,255,0.2); }
    .setup-panel h2 { margin-bottom: 20px; color: #00ffff; text-shadow: 0 0 10px rgba(0,255,255,0.5); }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #b0c4de; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .level-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .level-btn { padding: 15px 10px; border: 2px solid rgba(0,255,255,0.3); border-radius: 12px; background: rgba(0,0,0,0.5); color: #e2e8f0; cursor: pointer; transition: all 0.3s; text-align: center; }
    .level-btn:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); box-shadow: 0 0 15px rgba(0,255,255,0.3); }
    .level-btn.active { border-color: #00ffff; background: linear-gradient(135deg, rgba(0,255,255,0.2) 0%, rgba(255,0,255,0.2) 100%); box-shadow: 0 0 25px rgba(0,255,255,0.4); }
    .level-btn .level-num { font-size: 24px; font-weight: bold; display: block; margin-bottom: 5px; color: #00ffff; }
    .level-btn .level-desc { font-size: 11px; color: #a0aec0; }
    input[type="text"], textarea, input[type="number"], select { width: 100%; padding: 12px 15px; border: 2px solid rgba(0,255,255,0.3); border-radius: 10px; background: rgba(0,0,0,0.6); color: #e2e8f0; font-size: 16px; transition: all 0.3s; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.3); }
    textarea { min-height: 100px; resize: vertical; }
    .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%); color: #000; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 25px rgba(0,255,255,0.5); }
    .btn-secondary { background: rgba(0,0,0,0.6); color: #e2e8f0; border: 2px solid rgba(0,255,255,0.3); }
    .btn-success { background: linear-gradient(135deg, #39ff14 0%, #00cc00 100%); color: #000; }
    .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 25px rgba(57,255,20,0.5); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    .button-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .inline-input { display: flex; align-items: center; gap: 10px; }
    .inline-input input, .inline-input select { width: auto; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,255,255,0.3); border-radius: 50%; border-top-color: #00ffff; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .generation-progress { background: rgba(0,0,0,0.6); border: 2px solid #00ffff; border-radius: 15px; padding: 20px; margin: 20px 0; text-align: center; }
    .progress-bar { background: rgba(0,0,0,0.5); border-radius: 10px; height: 20px; overflow: hidden; margin: 15px 0; border: 1px solid rgba(0,255,255,0.3); }
    .progress-fill { background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%); height: 100%; transition: width 0.3s ease; }
    .preview-section { margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.6); border: 2px solid #00ffff; border-radius: 15px; max-height: 400px; overflow-y: auto; }
    .preview-section h3 { color: #00ffff; margin-bottom: 15px; }
    .sentence-preview { background: rgba(0,0,0,0.5); border: 1px solid rgba(0,255,255,0.2); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .sentence-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .sentence-number { background: linear-gradient(135deg, #ff00ff 0%, #cc00cc 100%); padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; }
    .perm-count { color: #a0aec0; font-size: 13px; }
    .sentence-korean { font-size: 18px; color: #fff; margin-bottom: 5px; }
    .sentence-english { font-size: 14px; color: #a0aec0; }
    .game-screen { display: none; background: rgba(0,0,0,0.7); border: 3px solid #00ffff; border-radius: 20px; padding: 30px; text-align: center; box-shadow: 0 0 30px rgba(0,255,255,0.2); }
    .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .game-progress { display: flex; align-items: center; gap: 15px; }
    .progress-indicator { background: rgba(255,0,255,0.3); padding: 8px 20px; border-radius: 20px; font-weight: 600; color: #ff88ff; border: 1px solid rgba(255,0,255,0.5); }
    .level-badge { background: linear-gradient(135deg, #ff00ff 0%, #cc00cc 100%); padding: 8px 20px; border-radius: 20px; font-weight: 600; }
    .timer-display { font-size: 48px; font-weight: bold; background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .timer-display.warning { background: linear-gradient(135deg, #ff3366 0%, #ff0000 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: pulse 0.5s ease-in-out infinite; }
    .timer-display.stopped { background: linear-gradient(135deg, #888 0%, #666 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: none; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .english-definition { background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 15px; padding: 20px; margin-bottom: 20px; font-size: 20px; color: #39ff14; }
    .main-sentence { background: rgba(0,0,0,0.6); border: 3px solid #00ffff; border-radius: 20px; padding: 40px; margin-bottom: 30px; box-shadow: 0 0 20px rgba(0,255,255,0.2); }
    .main-sentence .korean { font-size: 32px; font-weight: bold; color: #fff; margin-bottom: 10px; line-height: 1.4; }
    .main-sentence .english { font-size: 22px; color: #b0c4de; line-height: 1.4; }
    .main-sentence .situation { font-size: 20px; color: #ffcc00; font-style: italic; }
    .divider { display: flex; align-items: center; margin: 30px 0; color: #888; }
    .divider::before, .divider::after { content: ''; flex: 1; height: 2px; background: linear-gradient(90deg, transparent, rgba(0,255,255,0.3), transparent); }
    .divider span { padding: 0 20px; font-weight: 600; }
    .divider.hidden-state span { color: #ff3366; }
    .divider.revealed-state span { color: #39ff14; }
    .permutations-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
    .perm-card { background: rgba(0,0,0,0.6); border: 2px solid rgba(0,255,255,0.3); border-radius: 15px; padding: 20px; text-align: left; transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; }
    .perm-card.hidden-card { background: repeating-linear-gradient(45deg, rgba(0,0,0,0.5), rgba(0,0,0,0.5) 10px, rgba(0,0,0,0.7) 10px, rgba(0,0,0,0.7) 20px); border-style: dashed; }
    .perm-card.hidden-card .card-content { filter: blur(8px); user-select: none; }
    .perm-card.hidden-card::after { content: 'ðŸ”’'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; }
    .perm-card.revealed { border-color: #39ff14; background: rgba(57,255,20,0.1); }
    .perm-card:hover:not(.hidden-card) { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,255,255,0.3); border-color: #00ffff; }
    .perm-card .english-text { font-size: 16px; color: #b0c4de; margin-bottom: 10px; }
    .perm-card .korean-text { font-size: 20px; color: #fff; font-weight: 600; }
    .perm-card .korean-text.hidden { display: none; }
    .perm-card .click-hint { font-size: 12px; color: #888; margin-top: 10px; text-align: center; }
    .perm-card .score-badge { position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%); color: #000; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 14px; }
    .perm-card .score-badge.high { background: linear-gradient(135deg, #39ff14 0%, #00cc00 100%); }
    .perm-card .score-badge.medium { background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%); }
    .perm-card .score-badge.low { background: linear-gradient(135deg, #ff3366 0%, #ff0000 100%); }
    .game-controls { margin-top: 30px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
    .btn-start { background: linear-gradient(135deg, #39ff14 0%, #00cc00 100%); color: #000; font-size: 18px; padding: 15px 40px; }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 5px 25px rgba(57,255,20,0.5); }
    .btn-next { background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%); color: #000; font-size: 18px; padding: 15px 40px; }
    .btn-next:hover { transform: translateY(-2px); box-shadow: 0 5px 25px rgba(0,255,255,0.5); }
    .summary-screen { display: none; background: rgba(0,0,0,0.7); border: 3px solid #39ff14; border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 0 30px rgba(57,255,20,0.3); }
    .summary-screen h2 { font-size: 2rem; margin-bottom: 10px; background: linear-gradient(135deg, #39ff14 0%, #00cc00 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .summary-stats { display: flex; justify-content: center; gap: 30px; margin: 30px 0; flex-wrap: wrap; }
    .summary-stat { background: rgba(0,0,0,0.5); border: 2px solid rgba(0,255,255,0.3); border-radius: 15px; padding: 25px 35px; text-align: center; }
    .summary-stat .value { font-size: 36px; font-weight: bold; color: #00ffff; }
    .summary-stat .label { font-size: 14px; color: #a0aec0; margin-top: 5px; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); color: white; padding: 15px 30px; border-radius: 10px; z-index: 1000; display: none; border: 2px solid #00ffff; }
    .toast.show { display: block; animation: fadeInUp 0.3s ease; }
    @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    @media (max-width: 768px) { .level-selector { grid-template-columns: repeat(2, 1fr); } .form-row { grid-template-columns: 1fr; } .main-sentence .korean { font-size: 22px; } .main-sentence .english { font-size: 16px; } .timer-display { font-size: 36px; } .game-header { flex-direction: column; gap: 15px; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŒŸ Yodafy Game</h1>
    <p class="subtitle">Practice sentence variations in Korean</p>
    
    <div class="setup-panel" id="setupPanel">
      <h2>âš™ï¸ Game Setup</h2>
      
      <!-- Saved Games Section -->
      <div class="form-group" style="margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <label style="margin: 0;">ðŸ“‚ Saved Games</label>
          <button class="btn btn-secondary" onclick="loadSavedGamesList()" style="padding: 6px 12px; font-size: 12px;">ðŸ”„ Refresh</button>
        </div>
        <div id="savedGamesList" style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,255,255,0.2); border-radius: 8px; padding: 10px; max-height: 150px; overflow-y: auto;">
          <p style="color: #888; font-size: 12px; text-align: center;">Click refresh to load saved games...</p>
        </div>
      </div>
      
      <div class="form-group">
        <label>Select Level</label>
        <div class="level-selector">
          <button class="level-btn active" onclick="selectLevel(1)" id="levelBtn1">
            <span class="level-num">1</span>
            <span class="level-desc">Word Order<br>(Koreanâ†’Korean)</span>
          </button>
          <button class="level-btn" onclick="selectLevel(2)" id="levelBtn2">
            <span class="level-num">2</span>
            <span class="level-desc">Single Substitution<br>(Koreanâ†’Korean)</span>
          </button>
          <button class="level-btn" onclick="selectLevel(3)" id="levelBtn3">
            <span class="level-num">3</span>
            <span class="level-desc">Multiple Substitution<br>(Englishâ†’Korean)</span>
          </button>
          <button class="level-btn" onclick="selectLevel(4)" id="levelBtn4">
            <span class="level-num">4</span>
            <span class="level-desc">Situational<br>(Open Response)</span>
          </button>
        </div>
      </div>
      
      <div class="form-group">
        <div id="levelDescription" style="background: rgba(0,212,255,0.1); border-left: 4px solid #00d4ff; padding: 15px; border-radius: 0 10px 10px 0;">
          <strong>Level 1:</strong> Students say all word-order permutations by switching noun and time word positions. Same words, different order.
        </div>
      </div>
      
      <div class="form-group">
        <label>Context / Theme (Optional)</label>
        <input type="text" id="contextInput" placeholder="e.g., Crash Landing on You, coffee shop date, job interview...">
        <div style="font-size: 12px; color: #a0aec0; margin-top: 6px;">
          ðŸ’¡ Add a K-drama name, movie, or situation to generate themed sentences
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Number of Sentences</label>
          <div class="inline-input">
            <select id="sentenceCountSelect">
              <option value="1">1 sentence</option>
              <option value="3">3 sentences</option>
              <option value="5" selected>5 sentences</option>
              <option value="10">10 sentences</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>Timer Per Sentence (seconds)</label>
          <div class="inline-input">
            <input type="number" id="timerInput" value="60" min="10" max="300" style="width: 100px;">
            <span>seconds</span>
          </div>
        </div>
      </div>
      
      <!-- Manual Entry Toggle -->
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="manualEntryToggle" onchange="toggleManualEntry()" style="width: 18px; height: 18px;">
          <span>âœï¸ Manual Entry Mode</span>
          <span style="font-size: 11px; color: #888;">(Enter your own sentences - AI will generate permutations)</span>
        </label>
      </div>
      
      <!-- Manual Entry Section -->
      <div id="manualEntrySection" style="display: none; margin-bottom: 20px;">
        <div class="form-group">
          <label>Enter Sentences with Videos</label>
          <p style="font-size: 11px; color: #888; margin-bottom: 10px;">Add phrases one at a time with optional video hints. AI will generate permutations for each.</p>
          
          <div id="manualSentencesList" style="margin-bottom: 15px;"></div>
          
          <!-- Add New Sentence Form -->
          <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,255,0.2); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
            <div style="margin-bottom: 10px;">
              <label style="font-size: 12px; color: #b0c4de;">Korean Sentence *</label>
              <input type="text" id="newSentenceKorean" placeholder="e.g., ì¹œêµ¬ëž‘ ì¹´íŽ˜ì—ì„œ ë¹¨ë¦¬ ì»¤í”¼ë¥¼ ë§ˆì…¨ì–´ìš”" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid rgba(0,255,255,0.3); border-radius: 6px; color: #fff;">
            </div>
            <div style="margin-bottom: 10px;">
              <label style="font-size: 12px; color: #b0c4de;">English Translation *</label>
              <input type="text" id="newSentenceEnglish" placeholder="e.g., I quickly drank coffee at the cafe with my friend" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid rgba(0,255,255,0.3); border-radius: 6px; color: #fff;">
            </div>
            <div style="margin-bottom: 10px;">
              <label style="font-size: 12px; color: #b0c4de;">ðŸŽ¬ Video Hint (optional)</label>
              <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 12px;">
                  <input type="radio" name="videoType" value="loom" checked onchange="toggleVideoInputType()"> Loom Link
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 12px;">
                  <input type="radio" name="videoType" value="upload" onchange="toggleVideoInputType()"> Upload File
                </label>
              </div>
              <div id="loomInputContainer">
                <input type="text" id="newSentenceLoomUrl" placeholder="e.g., https://www.loom.com/share/abc123..." style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid rgba(156,39,176,0.3); border-radius: 6px; color: #fff;">
                <p style="font-size: 10px; color: #888; margin-top: 3px;">Paste the Loom share URL</p>
              </div>
              <div id="uploadInputContainer" style="display: none;">
                <input type="file" id="newSentenceVideoFile" accept="video/*" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid rgba(156,39,176,0.3); border-radius: 6px; color: #fff;">
                <p style="font-size: 10px; color: #888; margin-top: 3px;">Upload MP4, WebM, or other video file</p>
              </div>
            </div>
            <div style="margin-bottom: 10px;">
              <label style="font-size: 12px; color: #ce93d8;">ðŸ“ Video Title (optional)</label>
              <input type="text" id="newSentenceVideoTitle" placeholder="e.g., Pronunciation Demo" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid rgba(156,39,176,0.3); border-radius: 6px; color: #fff;">
            </div>
            <div style="margin-bottom: 10px;">
              <label style="font-size: 12px; color: #ce93d8;">ðŸ“„ Video Description (optional)</label>
              <textarea id="newSentenceVideoDesc" placeholder="e.g., Watch how the speaker emphasizes the time word at the beginning..." style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid rgba(156,39,176,0.3); border-radius: 6px; color: #fff; min-height: 60px;"></textarea>
            </div>
            <button class="btn btn-primary" onclick="addManualSentence()" style="width: 100%;">
              âž• Add Sentence
            </button>
          </div>
        </div>
        <button class="btn btn-success" onclick="processManualSentencesWithVideos()" id="processManualBtn" style="width: 100%;">
          âœ¨ Process All Sentences & Generate Permutations
        </button>
      </div>
      
      <div class="button-row" id="autoGenerateButtons">
        <button class="btn btn-primary" onclick="generateAllSentences()" id="generateBtn">
          âœ¨ Generate Sentences & Permutations
        </button>
        <button class="btn btn-success" onclick="startGame()" id="startGameBtn" disabled>
          â–¶ï¸ Start Game
        </button>
      </div>
      
      <div class="generation-progress" id="generationProgress" style="display: none;">
        <div id="generationStatus">Generating sentences...</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div id="generationDetail" style="font-size: 13px; color: #a0aec0;"></div>
      </div>
      
      <div class="preview-section" id="previewSection" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="margin: 0;">ðŸ“‹ Generated Sentences Preview</h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="openSaveGameModal()" style="padding: 8px 15px; font-size: 13px;">ðŸ’¾ Save Game</button>
            <button class="btn btn-info" onclick="testGame()" style="padding: 8px 15px; font-size: 13px;">ðŸ§ª Test</button>
            <button class="btn btn-success" onclick="startGame()" style="padding: 8px 15px; font-size: 13px;">â–¶ï¸ Start Game</button>
          </div>
        </div>
        <div id="previewList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,255,255,0.2); display: flex; gap: 10px; align-items: center;">
          <button class="btn btn-primary" onclick="generateMoreSentences()" id="generateMoreBtn" style="padding: 10px 20px;">
            âž• Generate More Sentences
          </button>
          <span style="font-size: 12px; color: #888;">Add more sentences without duplicates</span>
        </div>
      </div>
    </div>
    
    <!-- Save Game Modal -->
    <div id="saveGameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center;">
      <div style="background: rgba(0,0,0,0.95); border: 3px solid #00ffff; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;">
        <h3 style="color: #00ffff; margin-bottom: 20px;">ðŸ’¾ Save Game</h3>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; color: #b0c4de;">Game Name *</label>
          <input type="text" id="saveGameName" placeholder="e.g., Kdrama Vocab Week 1" style="width: 100%; padding: 12px; background: rgba(0,0,0,0.6); border: 2px solid rgba(0,255,255,0.3); border-radius: 8px; color: #fff;">
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; color: #b0c4de;">Description (optional)</label>
          <textarea id="saveGameDescription" placeholder="Brief description..." style="width: 100%; padding: 12px; background: rgba(0,0,0,0.6); border: 2px solid rgba(0,255,255,0.3); border-radius: 8px; color: #fff; min-height: 60px;"></textarea>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #b0c4de;">Tags (optional)</label>
          <input type="text" id="saveGameTags" placeholder="e.g., kdrama, beginner, week1" style="width: 100%; padding: 12px; background: rgba(0,0,0,0.6); border: 2px solid rgba(0,255,255,0.3); border-radius: 8px; color: #fff;">
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-success" onclick="saveGame()" style="flex: 1;">âœ… Save</button>
          <button class="btn btn-secondary" onclick="closeSaveGameModal()" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>
    
    <div class="game-screen" id="gameScreen">
      <div class="game-header">
        <button class="btn btn-secondary" onclick="exitGame()">â† Exit</button>
        <div class="game-progress">
          <div class="progress-indicator" id="progressIndicator">Sentence 1 of 5</div>
          <div class="level-badge" id="levelBadge">Level 1</div>
        </div>
        <div class="timer-display stopped" id="timerDisplay">1:00</div>
      </div>
      
      <!-- Video Hint Player -->
      <div id="videoHintContainer" style="display: none; margin: 15px auto; max-width: 560px; background: rgba(0,0,0,0.5); border: 2px solid rgba(156,39,176,0.5); border-radius: 12px; padding: 15px;">
        <div id="videoTitleDisplay" style="display: none; color: #ce93d8; font-size: 16px; font-weight: bold; margin-bottom: 8px; text-align: center;"></div>
        <div id="videoPlayerWrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; background: #000;">
          <!-- Loom embed or video element will be inserted here -->
        </div>
        <div id="videoDescriptionDisplay" style="display: none; color: #a0aec0; font-size: 13px; margin-top: 10px; padding: 10px; background: rgba(156,39,176,0.1); border-radius: 6px; line-height: 1.5;"></div>
      </div>
      
      <div class="english-definition" id="gameEnglishDef" style="display: none;">
        English definition here
      </div>
      
      <div class="main-sentence">
        <div class="korean" id="gameKorean">í•œêµ­ì–´ ë¬¸ìž¥</div>
        <div class="english" id="gameEnglish" style="display: none;">English sentence</div>
        <div class="situation" id="gameSituation" style="display: none;">Situational prompt</div>
      </div>
      
      <div class="divider hidden-state" id="gameDivider">
        <span>â¸ï¸ Press START to begin the timer</span>
      </div>
      
      <div class="permutations-grid" id="permutationsGrid"></div>
      
      <div class="game-controls" id="gameControls">
        <button class="btn btn-start" onclick="startTimer()" id="startTimerBtn">
          â–¶ï¸ Start Timer
        </button>
        <button class="btn" onclick="showEnglishHints()" id="showEnglishBtn" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
          ðŸ‘ï¸ Show English Hints
        </button>
        <button class="btn btn-secondary" onclick="skipToReveal()" id="skipRevealBtn" style="display: none;">
          â­ï¸ Skip to Reveal
        </button>
        <button class="btn btn-next" onclick="nextSentence()" id="nextSentenceBtn" style="display: none;">
          âž¡ï¸ Next Sentence
        </button>
        <button class="btn btn-success" onclick="finishGame()" id="finishGameBtn" style="display: none;">
          ðŸ† Finish Game
        </button>
      </div>
    </div>
    
    <div class="summary-screen" id="summaryScreen">
      <h2>ðŸŽ‰ Game Complete!</h2>
      <p style="color: #a0aec0; margin-bottom: 20px;">Great practice session!</p>
      
      <div class="summary-stats">
        <div class="summary-stat">
          <div class="value" id="summaryTotal">5</div>
          <div class="label">Sentences</div>
        </div>
        <div class="summary-stat">
          <div class="value" id="summaryPerms">35</div>
          <div class="label">Total Permutations</div>
        </div>
        <div class="summary-stat">
          <div class="value" id="summaryLevel">1</div>
          <div class="label">Level</div>
        </div>
      </div>
      
      <div class="button-row" style="justify-content: center; margin-top: 30px;">
        <button class="btn btn-primary" onclick="playAgainSameSettings()">ðŸ”„ Play Again</button>
        <button class="btn btn-secondary" onclick="newGameSetup()">âš™ï¸ New Setup</button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    const AI_FUNCTION_URL = 'https://generateflashcardai-386010826708.us-central1.run.app';
    
    async function callAIProxy(messages, temperature = 0.7) {
      const response = await fetch(AI_FUNCTION_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages, temperature })
      });
      if (!response.ok) throw new Error('AI call failed: ' + response.statusText);
      const result = await response.json();
      if (!result.success) throw new Error(result.error || 'AI call failed');
      return result.data;
    }
    
    let currentLevel = 1;
    let timerSeconds = 60;
    let timerInterval = null;
    let currentSentenceIndex = 0;
    let isRevealed = false;
    let timerRunning = false;
    let gameData = { sentences: [] };
    let savedGames = [];
    
    // Get Firebase reference from parent window (scheduler admin)
    function getFirebaseDB() {
      try {
        if (window.parent && window.parent.db) return window.parent.db;
        if (window.parent && window.parent.firebase) return window.parent.firebase.firestore();
      } catch (e) { console.log('Firebase not available from parent'); }
      return null;
    }
    
    const levelDescriptions = {
      1: '<strong>Level 1:</strong> Students say all word-order permutations by switching noun and time word positions. Same words, different order.',
      2: '<strong>Level 2:</strong> Students say permutations by substituting ONE word (time words, adverbs, adjectives). Different vocabulary, same structure.',
      3: '<strong>Level 3:</strong> Students translate English to Korean with MULTIPLE word substitutions. Most creative variation.',
      4: '<strong>Level 4:</strong> Students respond to a situation naturally. Graded 1-10 based on appropriateness and naturalness.'
    };
    
    function selectLevel(level) {
      currentLevel = level;
      document.querySelectorAll('.level-btn').forEach(btn => {
        const btnLevel = parseInt(btn.id.replace('levelBtn', ''));
        btn.classList.toggle('active', btnLevel === level);
      });
      document.getElementById('levelDescription').innerHTML = levelDescriptions[level];
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('startGameBtn').disabled = true;
      gameData.sentences = [];
    }
    
    function getSentenceGenerationPrompt(level, count, context = '') {
      const contextInstruction = context ? '\\nTHEME/CONTEXT: Generate sentences inspired by or related to "' + context + '". Use vocabulary, situations, and expressions that would fit this theme.\\n' : '';
      const baseRequirements = 'Each sentence MUST include ALL of the following:\\n1. A person phrase with CASUAL particle (ì¹œêµ¬ëž‘, ì—„ë§ˆí•œí…Œ, ì„ ìƒë‹˜ê»˜, ë™ìƒì´ëž‘, ì•„ë¹ í•œí…Œ, ì–¸ë‹ˆëž‘, ì˜¤ë¹ ëž‘, ë‚¨ìžì¹œêµ¬ëž‘, etc.)\\n2. A location/prepositional phrase (ì§‘ì—ì„œ, í•™êµì—ì„œ, ì¹´íŽ˜ì—ì„œ, íšŒì‚¬ì—ì„œ, ê³µì›ì—ì„œ, ë³‘ì›ì—ì„œ, etc.)\\n3. An adverb (ë¹¨ë¦¬, ì²œì²œížˆ, ì¡°ìš©ížˆ, ì—´ì‹¬ížˆ, ê°‘ìžê¸°, ìžì£¼, ë§¤ì¼, ì§„ì§œ, ë„ˆë¬´, etc.)\\n4. Natural K-DRAMA style conversational language\\n5. Can be statements OR questions\\n6. Should be 8-12 words long' + contextInstruction;
      
      if (level === 1 || level === 2) {
        return 'Generate ' + count + ' Korean sentences for a word-order permutation exercise.\\n' + baseRequirements + '\\n\\nReturn ONLY a JSON array with this exact format:\\n[\\n  { "korean": "Korean sentence 1", "english": "English translation 1" },\\n  { "korean": "Korean sentence 2", "english": "English translation 2" }\\n]';
      } else if (level === 3) {
        return 'Generate ' + count + ' English sentences that will be translated to Korean with variations.\\n' + baseRequirements + '\\n\\nReturn ONLY a JSON array with this exact format:\\n[\\n  { "english": "English sentence 1", "korean": "One possible Korean translation 1" },\\n  { "english": "English sentence 2", "korean": "One possible Korean translation 2" }\\n]';
      } else if (level === 4) {
        return 'Generate ' + count + ' situational prompts for Korean language practice.\\n\\nEach situation should be a realistic everyday scenario in Korea requiring a polite or natural Korean response.\\n\\nReturn ONLY a JSON array with this exact format:\\n[\\n  { "situation": "Situation description 1" },\\n  { "situation": "Situation description 2" }\\n]';
      }
    }
    
    function getPermutationPrompt(level, sentence) {
      if (level === 1) {
        return 'Given this Korean sentence: "' + sentence.korean + '"\\nEnglish meaning: "' + sentence.english + '"\\n\\nGenerate ALL valid word-order permutations by rearranging the word positions.\\nThe words must stay the same, only the order changes.\\n\\nReturn ONLY a JSON array:\\n[\\n  { "korean": "permutation 1" },\\n  { "korean": "permutation 2" }\\n]\\n\\nInclude the original sentence as the first permutation.';
      } else if (level === 2) {
        return 'Given this Korean sentence: "' + sentence.korean + '"\\nEnglish meaning: "' + sentence.english + '"\\n\\nGenerate ALL valid single-word substitution permutations.\\nChange ONLY ONE word (time word, adverb, adjective, or person).\\n\\nReturn ONLY a JSON array:\\n[\\n  { "korean": "Korean permutation", "english": "English translation" }\\n]\\n\\nGenerate 8-15 variations.';
      } else if (level === 3) {
        return 'Given this English sentence: "' + sentence.english + '"\\nOne possible Korean translation: "' + sentence.korean + '"\\n\\nGenerate exactly 5 different Korean translations, each with MULTIPLE word variations.\\n\\nReturn ONLY a JSON array:\\n[\\n  { "korean": "Korean translation 1", "english": "Back-translation showing the variation" }\\n]\\n\\nProvide exactly 5 permutations.';
      } else if (level === 4) {
        return 'Given this situation: "' + sentence.situation + '"\\n\\nGenerate exactly 5 natural Korean responses that a native speaker might say in a K-drama.\\n\\nFor each response, provide:\\n1. The Korean response\\n2. The English translation\\n3. A naturalness/appropriateness score from 1-10\\n4. Keywords: Include important vocabulary words as (English, Korean) pairs\\n\\nReturn ONLY a JSON array:\\n[\\n  { "korean": "response", "english": "translation", "score": 9, "keywords": [{"en": "word", "ko": "ë‹¨ì–´"}] }\\n]\\n\\nProvide exactly 5 responses ordered from highest to lowest score.';
      }
    }
    
    async function generateAllSentences() {
      const sentenceCount = parseInt(document.getElementById('sentenceCountSelect').value);
      const context = document.getElementById('contextInput').value.trim();
      const generateBtn = document.getElementById('generateBtn');
      const progressDiv = document.getElementById('generationProgress');
      const progressFill = document.getElementById('progressFill');
      const statusEl = document.getElementById('generationStatus');
      const detailEl = document.getElementById('generationDetail');
      
      generateBtn.disabled = true;
      progressDiv.style.display = 'block';
      gameData.sentences = [];
      
      try {
        statusEl.textContent = 'Generating ' + sentenceCount + ' sentences...';
        detailEl.textContent = context ? 'Theme: "' + context + '"' : 'Creating drama-style Korean sentences...';
        progressFill.style.width = '10%';
        
        const sentencePrompt = getSentenceGenerationPrompt(currentLevel, sentenceCount, context);
        const sentences = await callAIProxy([
          { role: 'system', content: 'You are a Korean language expert specializing in natural, drama-style Korean. Always respond with valid JSON only, no markdown or explanation.' },
          { role: 'user', content: sentencePrompt }
        ], 0.8);
        
        if (!Array.isArray(sentences) || sentences.length === 0) throw new Error('Failed to generate sentences');
        
        progressFill.style.width = '20%';
        
        for (let i = 0; i < sentences.length; i++) {
          const sentence = sentences[i];
          const progress = 20 + (70 * (i + 1) / sentences.length);
          progressFill.style.width = progress + '%';
          statusEl.textContent = 'Generating permutations for sentence ' + (i + 1) + ' of ' + sentences.length + '...';
          
          if (currentLevel === 4) detailEl.textContent = '"' + (sentence.situation || '').substring(0, 50) + '..."';
          else if (currentLevel === 3) detailEl.textContent = '"' + (sentence.english || '').substring(0, 50) + '..."';
          else detailEl.textContent = '"' + (sentence.korean || '').substring(0, 50) + '..."';
          
          const permPrompt = getPermutationPrompt(currentLevel, sentence);
          const permutations = await callAIProxy([
            { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
            { role: 'user', content: permPrompt }
          ], 0.7);
          
          gameData.sentences.push({ sentence: sentence, permutations: Array.isArray(permutations) ? permutations : [] });
        }
        
        progressFill.style.width = '100%';
        statusEl.textContent = 'âœ… Generation complete!';
        detailEl.textContent = 'Generated ' + gameData.sentences.length + ' sentences with permutations';
        
        renderPreview();
        document.getElementById('previewSection').style.display = 'block';
        document.getElementById('startGameBtn').disabled = false;
        showToast('âœ… Generated ' + gameData.sentences.length + ' sentences!');
        
      } catch (error) {
        console.error('Generation error:', error);
        statusEl.textContent = 'âŒ Error: ' + error.message;
        detailEl.textContent = 'Please try again';
        showToast('âŒ Generation failed: ' + error.message);
      }
      
      generateBtn.disabled = false;
    }
    
    async function generateMoreSentences() {
      const sentenceCount = parseInt(document.getElementById('sentenceCountSelect').value);
      const context = document.getElementById('contextInput').value.trim();
      const generateMoreBtn = document.getElementById('generateMoreBtn');
      const progressDiv = document.getElementById('generationProgress');
      const progressFill = document.getElementById('progressFill');
      const statusEl = document.getElementById('generationStatus');
      const detailEl = document.getElementById('generationDetail');
      
      // Get existing sentences for duplicate checking
      const existingSentences = gameData.sentences.map(item => {
        if (currentLevel === 4) return (item.sentence.situation || '').toLowerCase().trim();
        if (currentLevel === 3) return (item.sentence.english || '').toLowerCase().trim();
        return (item.sentence.korean || '').toLowerCase().trim();
      });
      
      generateMoreBtn.disabled = true;
      progressDiv.style.display = 'block';
      
      try {
        // Build prompt that includes existing sentences to avoid
        const existingList = existingSentences.slice(0, 20).join('\\n- ');
        const avoidDuplicatesInstruction = existingSentences.length > 0 ? 
          '\\n\\nIMPORTANT: Do NOT generate sentences similar to these existing ones:\\n- ' + existingList + '\\n\\nGenerate COMPLETELY DIFFERENT sentences with different vocabulary and topics.' : '';
        
        statusEl.textContent = 'Generating ' + sentenceCount + ' more sentences...';
        detailEl.textContent = 'Checking for duplicates against ' + existingSentences.length + ' existing sentences';
        progressFill.style.width = '10%';
        
        const sentencePrompt = getSentenceGenerationPrompt(currentLevel, sentenceCount, context) + avoidDuplicatesInstruction;
        const newSentences = await callAIProxy([
          { role: 'system', content: 'You are a Korean language expert specializing in natural, drama-style Korean. Always respond with valid JSON only, no markdown or explanation. Generate UNIQUE sentences that are different from any provided examples.' },
          { role: 'user', content: sentencePrompt }
        ], 0.9); // Higher temperature for more variety
        
        if (!Array.isArray(newSentences) || newSentences.length === 0) throw new Error('Failed to generate sentences');
        
        progressFill.style.width = '20%';
        
        // Filter out duplicates
        let addedCount = 0;
        let skippedCount = 0;
        
        for (let i = 0; i < newSentences.length; i++) {
          const sentence = newSentences[i];
          const progress = 20 + (70 * (i + 1) / newSentences.length);
          progressFill.style.width = progress + '%';
          
          // Check for duplicates
          let sentenceText;
          if (currentLevel === 4) sentenceText = (sentence.situation || '').toLowerCase().trim();
          else if (currentLevel === 3) sentenceText = (sentence.english || '').toLowerCase().trim();
          else sentenceText = (sentence.korean || '').toLowerCase().trim();
          
          // Check similarity (exact match or very similar)
          const isDuplicate = existingSentences.some(existing => {
            if (existing === sentenceText) return true;
            // Check if 80% similar (simple check)
            const minLen = Math.min(existing.length, sentenceText.length);
            const maxLen = Math.max(existing.length, sentenceText.length);
            if (minLen / maxLen < 0.5) return false; // Too different in length
            
            // Count matching words
            const existingWords = existing.split(/\\s+/);
            const newWords = sentenceText.split(/\\s+/);
            const matchingWords = existingWords.filter(w => newWords.includes(w)).length;
            const similarity = matchingWords / Math.max(existingWords.length, newWords.length);
            return similarity > 0.7; // 70% word overlap = duplicate
          });
          
          if (isDuplicate) {
            skippedCount++;
            statusEl.textContent = 'Skipping duplicate sentence ' + (i + 1) + '...';
            continue;
          }
          
          statusEl.textContent = 'Generating permutations for new sentence ' + (addedCount + 1) + '...';
          
          if (currentLevel === 4) detailEl.textContent = '"' + (sentence.situation || '').substring(0, 50) + '..."';
          else if (currentLevel === 3) detailEl.textContent = '"' + (sentence.english || '').substring(0, 50) + '..."';
          else detailEl.textContent = '"' + (sentence.korean || '').substring(0, 50) + '..."';
          
          const permPrompt = getPermutationPrompt(currentLevel, sentence);
          const permutations = await callAIProxy([
            { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
            { role: 'user', content: permPrompt }
          ], 0.7);
          
          gameData.sentences.push({ sentence: sentence, permutations: Array.isArray(permutations) ? permutations : [] });
          existingSentences.push(sentenceText); // Add to existing for next iteration check
          addedCount++;
        }
        
        progressFill.style.width = '100%';
        statusEl.textContent = 'âœ… Generation complete!';
        detailEl.textContent = 'Added ' + addedCount + ' new sentences' + (skippedCount > 0 ? ', skipped ' + skippedCount + ' duplicates' : '');
        
        renderPreview();
        showToast('âœ… Added ' + addedCount + ' new sentences!' + (skippedCount > 0 ? ' (' + skippedCount + ' duplicates skipped)' : ''));
        
      } catch (error) {
        console.error('Generation error:', error);
        statusEl.textContent = 'âŒ Error: ' + error.message;
        detailEl.textContent = 'Please try again';
        showToast('âŒ Generation failed: ' + error.message);
      }
      
      generateMoreBtn.disabled = false;
    }
    
    function renderPreview() {
      const previewList = document.getElementById('previewList');
      previewList.innerHTML = gameData.sentences.map((item, index) => {
        const s = item.sentence;
        const permCount = item.permutations.length;
        if (currentLevel === 4) {
          return '<div class="sentence-preview"><div class="sentence-preview-header"><span class="sentence-number">Situation ' + (index + 1) + '</span><span class="perm-count">' + permCount + ' responses</span></div><div class="sentence-english">' + (s.situation || '') + '</div></div>';
        } else if (currentLevel === 3) {
          return '<div class="sentence-preview"><div class="sentence-preview-header"><span class="sentence-number">Sentence ' + (index + 1) + '</span><span class="perm-count">' + permCount + ' permutations</span></div><div class="sentence-english">' + (s.english || '') + '</div><div class="sentence-korean" style="margin-top: 8px; font-size: 16px;">â†’ ' + (s.korean || '') + '</div></div>';
        } else {
          return '<div class="sentence-preview"><div class="sentence-preview-header"><span class="sentence-number">Sentence ' + (index + 1) + '</span><span class="perm-count">' + permCount + ' permutations</span></div><div class="sentence-korean">' + (s.korean || '') + '</div><div class="sentence-english">' + (s.english || '') + '</div></div>';
        }
      }).join('');
    }
    
    function startGame() {
      timerSeconds = parseInt(document.getElementById('timerInput').value) || 60;
      currentSentenceIndex = 0;
      document.getElementById('setupPanel').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'block';
      document.getElementById('levelBadge').textContent = 'Level ' + currentLevel;
      loadCurrentSentence();
    }
    
    function testGame() {
      // Test function - same as startGame but just for testing
      if (!gameData.sentences || gameData.sentences.length === 0) {
        showToast('âŒ No sentences to test. Generate or add sentences first.');
        return;
      }
      startGame();
    }
    
    function loadCurrentSentence() {
      const item = gameData.sentences[currentSentenceIndex];
      const s = item.sentence;
      isRevealed = false;
      timerRunning = false;
      
      document.getElementById('progressIndicator').textContent = 'Sentence ' + (currentSentenceIndex + 1) + ' of ' + gameData.sentences.length;
      document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
      document.getElementById('timerDisplay').className = 'timer-display stopped';
      
      // Handle video display
      const videoContainer = document.getElementById('videoHintContainer');
      const videoWrapper = document.getElementById('videoPlayerWrapper');
      const videoTitleEl = document.getElementById('videoTitleDisplay');
      const videoDescEl = document.getElementById('videoDescriptionDisplay');
      
      if (s.videoUrl || s.videoData) {
        videoContainer.style.display = 'block';
        
        // Show video title if available
        if (s.videoTitle) {
          videoTitleEl.textContent = 'ðŸŽ¬ ' + s.videoTitle;
          videoTitleEl.style.display = 'block';
        } else {
          videoTitleEl.style.display = 'none';
        }
        
        // Show video description if available
        if (s.videoDescription) {
          videoDescEl.textContent = s.videoDescription;
          videoDescEl.style.display = 'block';
        } else {
          videoDescEl.style.display = 'none';
        }
        
        if (s.videoUrl && s.videoUrl.includes('loom.com')) {
          // Loom embed
          const loomId = extractLoomId(s.videoUrl);
          if (loomId) {
            videoWrapper.innerHTML = '<iframe src="https://www.loom.com/embed/' + loomId + '" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>';
          } else {
            videoWrapper.innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: 20px;">Invalid Loom URL</p>';
          }
        } else if (s.videoData) {
          // Uploaded video file
          videoWrapper.innerHTML = '<video controls style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="' + s.videoData + '" type="video/mp4">Your browser does not support video.</video>';
        } else if (s.videoUrl) {
          // Direct video URL
          videoWrapper.innerHTML = '<video controls style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="' + s.videoUrl + '" type="video/mp4">Your browser does not support video.</video>';
        }
      } else {
        videoContainer.style.display = 'none';
        videoWrapper.innerHTML = '';
        videoTitleEl.style.display = 'none';
        videoDescEl.style.display = 'none';
      }
      
      const koreanEl = document.getElementById('gameKorean');
      const englishEl = document.getElementById('gameEnglish');
      const situationEl = document.getElementById('gameSituation');
      const englishDefEl = document.getElementById('gameEnglishDef');
      
      koreanEl.style.display = 'none';
      englishEl.style.display = 'none';
      situationEl.style.display = 'none';
      englishDefEl.style.display = 'none';
      
      if (currentLevel === 1) {
        koreanEl.textContent = s.korean || '';
        koreanEl.style.display = 'block';
        englishDefEl.textContent = 'ðŸ“– ' + (s.english || '');
        englishDefEl.style.display = 'block';
      } else if (currentLevel === 2) {
        koreanEl.textContent = s.korean || '';
        koreanEl.style.display = 'block';
        englishEl.textContent = s.english || '';
        englishEl.style.display = 'block';
      } else if (currentLevel === 3) {
        englishEl.textContent = s.english || '';
        englishEl.style.display = 'block';
      } else if (currentLevel === 4) {
        situationEl.textContent = 'ðŸ’­ ' + (s.situation || '');
        situationEl.style.display = 'block';
      }
      
      renderPermutationCards(item.permutations);
      
      document.getElementById('gameDivider').className = 'divider hidden-state';
      document.getElementById('gameDivider').innerHTML = '<span>â¸ï¸ Press START to begin the timer</span>';
      
      document.getElementById('startTimerBtn').style.display = 'inline-block';
      document.getElementById('showEnglishBtn').style.display = 'none';
      document.getElementById('skipRevealBtn').style.display = 'none';
      document.getElementById('nextSentenceBtn').style.display = 'none';
      document.getElementById('finishGameBtn').style.display = 'none';
    }
    
    function extractLoomId(url) {
      // Extract Loom video ID from various URL formats
      // https://www.loom.com/share/abc123
      // https://www.loom.com/embed/abc123
      const match = url.match(/loom\\.com\\/(share|embed)\\/([a-zA-Z0-9]+)/);
      return match ? match[2] : null;
    }
    
    function renderPermutationCards(permutations) {
      const grid = document.getElementById('permutationsGrid');
      grid.innerHTML = permutations.map((p, index) => {
        if (currentLevel === 4) {
          const scoreClass = p.score >= 8 ? 'high' : (p.score >= 5 ? 'medium' : 'low');
          return '<div class="perm-card hidden-card" onclick="revealCard(this, ' + index + ')"><div class="score-badge ' + scoreClass + '">' + (p.score || '?') + '/10</div><div class="card-content"><div class="korean-text">' + (p.korean || '') + '</div><div class="english-text" style="margin-top: 10px;">' + (p.english || '') + '</div></div><div class="click-hint">Click to reveal</div></div>';
        } else if (currentLevel === 3 || currentLevel === 2) {
          return '<div class="perm-card hidden-card" onclick="revealCard(this, ' + index + ')"><div class="card-content"><div class="english-text">' + (p.english || '') + '</div><div class="korean-text">' + (p.korean || '') + '</div></div><div class="click-hint">Click to reveal</div></div>';
        } else {
          return '<div class="perm-card hidden-card" onclick="revealCard(this, ' + index + ')"><div class="card-content"><div class="korean-text">' + (p.korean || '') + '</div></div><div class="click-hint">Click to reveal</div></div>';
        }
      }).join('');
    }
    
    function revealCard(card, index) {
      if (!isRevealed) return;
      card.classList.remove('hidden-card');
      card.classList.add('revealed');
    }
    
    function startTimer() {
      if (timerRunning) return;
      timerRunning = true;
      let timeLeft = timerSeconds;
      
      document.getElementById('timerDisplay').className = 'timer-display';
      document.getElementById('gameDivider').className = 'divider hidden-state';
      document.getElementById('gameDivider').innerHTML = '<span>ðŸ”’ Answers hidden - practice speaking!</span>';
      
      document.getElementById('startTimerBtn').style.display = 'none';
      document.getElementById('showEnglishBtn').style.display = currentLevel === 2 ? 'inline-block' : 'none';
      document.getElementById('skipRevealBtn').style.display = 'inline-block';
      
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timerDisplay').textContent = formatTime(timeLeft);
        
        if (timeLeft <= 10) {
          document.getElementById('timerDisplay').className = 'timer-display warning';
        }
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          revealAllCards();
        }
      }, 1000);
    }
    
    function skipToReveal() {
      if (timerInterval) clearInterval(timerInterval);
      revealAllCards();
    }
    
    function revealAllCards() {
      isRevealed = true;
      document.getElementById('timerDisplay').className = 'timer-display stopped';
      document.getElementById('gameDivider').className = 'divider revealed-state';
      document.getElementById('gameDivider').innerHTML = '<span>âœ… Answers revealed!</span>';
      
      document.querySelectorAll('.perm-card').forEach(card => {
        card.classList.remove('hidden-card');
        card.classList.add('revealed');
      });
      
      document.getElementById('showEnglishBtn').style.display = 'none';
      document.getElementById('skipRevealBtn').style.display = 'none';
      
      if (currentSentenceIndex < gameData.sentences.length - 1) {
        document.getElementById('nextSentenceBtn').style.display = 'inline-block';
      } else {
        document.getElementById('finishGameBtn').style.display = 'inline-block';
      }
    }
    
    function showEnglishHints() {
      document.querySelectorAll('.perm-card .english-text').forEach(el => {
        el.style.display = 'block';
      });
      document.getElementById('showEnglishBtn').style.display = 'none';
    }
    
    function nextSentence() {
      if (timerInterval) clearInterval(timerInterval);
      currentSentenceIndex++;
      loadCurrentSentence();
    }
    
    function finishGame() {
      if (timerInterval) clearInterval(timerInterval);
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('summaryScreen').style.display = 'block';
      
      const totalPerms = gameData.sentences.reduce((sum, item) => sum + item.permutations.length, 0);
      document.getElementById('summaryTotal').textContent = gameData.sentences.length;
      document.getElementById('summaryPerms').textContent = totalPerms;
      document.getElementById('summaryLevel').textContent = currentLevel;
    }
    
    function exitGame() {
      if (timerInterval) clearInterval(timerInterval);
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('setupPanel').style.display = 'block';
    }
    
    function playAgainSameSettings() {
      document.getElementById('summaryScreen').style.display = 'none';
      currentSentenceIndex = 0;
      document.getElementById('gameScreen').style.display = 'block';
      loadCurrentSentence();
    }
    
    function newGameSetup() {
      document.getElementById('summaryScreen').style.display = 'none';
      document.getElementById('setupPanel').style.display = 'block';
      gameData.sentences = [];
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('startGameBtn').disabled = true;
    }
    
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return mins + ':' + (secs < 10 ? '0' : '') + secs;
    }
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // ==================== MANUAL ENTRY FUNCTIONS ====================
    
    function toggleManualEntry() {
      const isManual = document.getElementById('manualEntryToggle').checked;
      document.getElementById('manualEntrySection').style.display = isManual ? 'block' : 'none';
      document.getElementById('autoGenerateButtons').style.display = isManual ? 'none' : 'flex';
      document.getElementById('contextInput').parentElement.style.display = isManual ? 'none' : 'block';
      document.getElementById('sentenceCountSelect').parentElement.parentElement.style.display = isManual ? 'none' : 'grid';
      
      // Clear manual sentences list when toggling
      if (isManual) {
        manualSentencesList = [];
        renderManualSentencesList();
      }
    }
    
    // Manual sentences with videos
    let manualSentencesList = [];
    
    function toggleVideoInputType() {
      const isLoom = document.querySelector('input[name="videoType"]:checked').value === 'loom';
      document.getElementById('loomInputContainer').style.display = isLoom ? 'block' : 'none';
      document.getElementById('uploadInputContainer').style.display = isLoom ? 'none' : 'block';
    }
    
    function addManualSentence() {
      const korean = document.getElementById('newSentenceKorean').value.trim();
      const english = document.getElementById('newSentenceEnglish').value.trim();
      const videoType = document.querySelector('input[name="videoType"]:checked').value;
      const videoTitle = document.getElementById('newSentenceVideoTitle').value.trim();
      const videoDesc = document.getElementById('newSentenceVideoDesc').value.trim();
      
      if (!korean) {
        showToast('âŒ Korean sentence is required');
        return;
      }
      if (!english) {
        showToast('âŒ English translation is required');
        return;
      }
      
      const sentenceData = {
        korean: korean,
        english: english,
        videoUrl: null,
        videoData: null,
        videoTitle: videoTitle || null,
        videoDescription: videoDesc || null
      };
      
      if (videoType === 'loom') {
        const loomUrl = document.getElementById('newSentenceLoomUrl').value.trim();
        if (loomUrl) {
          sentenceData.videoUrl = loomUrl;
        }
        addSentenceToList(sentenceData);
      } else {
        // Handle file upload
        const fileInput = document.getElementById('newSentenceVideoFile');
        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            sentenceData.videoData = e.target.result;
            addSentenceToList(sentenceData);
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          addSentenceToList(sentenceData);
        }
      }
    }
    
    function addSentenceToList(sentenceData) {
      manualSentencesList.push(sentenceData);
      renderManualSentencesList();
      
      // Clear inputs
      document.getElementById('newSentenceKorean').value = '';
      document.getElementById('newSentenceEnglish').value = '';
      document.getElementById('newSentenceLoomUrl').value = '';
      document.getElementById('newSentenceVideoFile').value = '';
      document.getElementById('newSentenceVideoTitle').value = '';
      document.getElementById('newSentenceVideoDesc').value = '';
      
      showToast('âœ… Sentence added! (' + manualSentencesList.length + ' total)');
    }
    
    function renderManualSentencesList() {
      const container = document.getElementById('manualSentencesList');
      if (manualSentencesList.length === 0) {
        container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">No sentences added yet. Add sentences below.</p>';
        return;
      }
      
      container.innerHTML = manualSentencesList.map((s, index) => {
        const hasVideo = s.videoUrl || s.videoData;
        const videoInfo = hasVideo ? (s.videoTitle ? 'ðŸŽ¬ ' + s.videoTitle : 'ðŸŽ¬ Video attached') : '';
        return '<div style="background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; padding: 10px; margin-bottom: 8px;">' +
          '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
            '<div style="flex: 1;">' +
              '<div style="color: #00ffff; font-size: 14px; margin-bottom: 3px;">' + s.korean + '</div>' +
              '<div style="color: #a0aec0; font-size: 12px;">' + s.english + '</div>' +
              (hasVideo ? '<div style="color: #ce93d8; font-size: 11px; margin-top: 3px;">' + videoInfo + '</div>' : '') +
            '</div>' +
            '<button onclick="removeManualSentence(' + index + ')" style="background: rgba(255,0,0,0.2); border: 1px solid #ff6b6b; color: #ff6b6b; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">âœ•</button>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    
    function removeManualSentence(index) {
      manualSentencesList.splice(index, 1);
      renderManualSentencesList();
      showToast('Sentence removed');
    }
    
    async function processManualSentencesWithVideos() {
      if (manualSentencesList.length === 0) {
        showToast('âŒ Please add some sentences first');
        return;
      }
      
      const processBtn = document.getElementById('processManualBtn');
      const progressDiv = document.getElementById('generationProgress');
      const progressFill = document.getElementById('progressFill');
      const statusEl = document.getElementById('generationStatus');
      const detailEl = document.getElementById('generationDetail');
      
      processBtn.disabled = true;
      progressDiv.style.display = 'block';
      gameData.sentences = [];
      
      try {
        statusEl.textContent = 'Processing ' + manualSentencesList.length + ' sentences...';
        progressFill.style.width = '10%';
        
        for (let i = 0; i < manualSentencesList.length; i++) {
          const sentence = manualSentencesList[i];
          const progress = 10 + (80 * (i + 1) / manualSentencesList.length);
          progressFill.style.width = progress + '%';
          statusEl.textContent = 'Generating permutations for sentence ' + (i + 1) + ' of ' + manualSentencesList.length + '...';
          detailEl.textContent = '"' + sentence.korean.substring(0, 50) + '..."';
          
          const permPrompt = getPermutationPrompt(currentLevel, sentence);
          const permutations = await callAIProxy([
            { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
            { role: 'user', content: permPrompt }
          ], 0.7);
          
          gameData.sentences.push({ 
            sentence: sentence, 
            permutations: Array.isArray(permutations) ? permutations : [] 
          });
        }
        
        progressFill.style.width = '100%';
        statusEl.textContent = 'âœ… Processing complete!';
        detailEl.textContent = 'Processed ' + gameData.sentences.length + ' sentences with permutations';
        
        renderPreview();
        document.getElementById('previewSection').style.display = 'block';
        document.getElementById('startGameBtn').disabled = false;
        showToast('âœ… Processed ' + gameData.sentences.length + ' sentences!');
        
      } catch (error) {
        console.error('Processing error:', error);
        statusEl.textContent = 'âŒ Error: ' + error.message;
        detailEl.textContent = 'Please try again';
        showToast('âŒ Processing failed: ' + error.message);
      }
      
      processBtn.disabled = false;
    }
    
    async function processManualSentences() {
      const input = document.getElementById('manualSentencesInput').value.trim();
      if (!input) {
        showToast('âŒ Please enter some sentences');
        return;
      }
      
      const lines = input.split('\\n').filter(line => line.trim());
      if (lines.length === 0) {
        showToast('âŒ No valid sentences found');
        return;
      }
      
      const processBtn = document.getElementById('processManualBtn');
      const progressDiv = document.getElementById('generationProgress');
      const progressFill = document.getElementById('progressFill');
      const statusEl = document.getElementById('generationStatus');
      const detailEl = document.getElementById('generationDetail');
      
      processBtn.disabled = true;
      progressDiv.style.display = 'block';
      gameData.sentences = [];
      
      try {
        statusEl.textContent = 'Processing ' + lines.length + ' sentences...';
        progressFill.style.width = '10%';
        
        const parsedSentences = [];
        for (const line of lines) {
          const parts = line.split('|').map(p => p.trim());
          if (currentLevel === 4) {
            parsedSentences.push({ situation: parts[0] });
          } else if (currentLevel === 3) {
            parsedSentences.push({ english: parts[0], korean: parts[1] || '' });
          } else {
            parsedSentences.push({ korean: parts[0], english: parts[1] || '' });
          }
        }
        
        progressFill.style.width = '20%';
        
        for (let i = 0; i < parsedSentences.length; i++) {
          const sentence = parsedSentences[i];
          const progress = 20 + (70 * (i + 1) / parsedSentences.length);
          progressFill.style.width = progress + '%';
          statusEl.textContent = 'Generating permutations for sentence ' + (i + 1) + ' of ' + parsedSentences.length + '...';
          
          if (currentLevel === 4) detailEl.textContent = '"' + (sentence.situation || '').substring(0, 50) + '..."';
          else if (currentLevel === 3) detailEl.textContent = '"' + (sentence.english || '').substring(0, 50) + '..."';
          else detailEl.textContent = '"' + (sentence.korean || '').substring(0, 50) + '..."';
          
          const permPrompt = getPermutationPrompt(currentLevel, sentence);
          const permutations = await callAIProxy([
            { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
            { role: 'user', content: permPrompt }
          ], 0.7);
          
          gameData.sentences.push({ sentence: sentence, permutations: Array.isArray(permutations) ? permutations : [] });
        }
        
        progressFill.style.width = '100%';
        statusEl.textContent = 'âœ… Processing complete!';
        detailEl.textContent = 'Processed ' + gameData.sentences.length + ' sentences with permutations';
        
        renderPreview();
        document.getElementById('previewSection').style.display = 'block';
        document.getElementById('startGameBtn').disabled = false;
        showToast('âœ… Processed ' + gameData.sentences.length + ' sentences!');
        
      } catch (error) {
        console.error('Processing error:', error);
        statusEl.textContent = 'âŒ Error: ' + error.message;
        detailEl.textContent = 'Please try again';
        showToast('âŒ Processing failed: ' + error.message);
      }
      
      processBtn.disabled = false;
    }
    
    // ==================== SAVE/LOAD FUNCTIONS ====================
    
    function openSaveGameModal() {
      document.getElementById('saveGameModal').style.display = 'flex';
      document.getElementById('saveGameName').value = '';
      document.getElementById('saveGameDescription').value = '';
      document.getElementById('saveGameTags').value = '';
      document.getElementById('saveGameName').focus();
    }
    
    function closeSaveGameModal() {
      document.getElementById('saveGameModal').style.display = 'none';
    }
    
    async function saveGame() {
      const name = document.getElementById('saveGameName').value.trim();
      if (!name) {
        showToast('âŒ Please enter a game name');
        return;
      }
      
      // Check if parent save function is available
      if (!window.parent || !window.parent.saveYodafyGame) {
        showToast('âŒ Save function not available');
        return;
      }
      
      const description = document.getElementById('saveGameDescription').value.trim();
      const tags = document.getElementById('saveGameTags').value.trim().split(',').map(t => t.trim()).filter(t => t);
      
      try {
        // Clean sentences data - convert to plain objects and remove large video data
        const cleanedSentences = [];
        for (let i = 0; i < gameData.sentences.length; i++) {
          const item = gameData.sentences[i];
          const sentenceObj = item.sentence || {};
          const permsArr = item.permutations || [];
          
          // Build clean sentence object manually
          const cleanSentence = {
            korean: sentenceObj.korean || '',
            english: sentenceObj.english || '',
            videoUrl: sentenceObj.videoUrl || null,
            videoTitle: sentenceObj.videoTitle || null,
            videoDescription: sentenceObj.videoDescription || null
          };
          
          // Don't save base64 video data to Firebase (too large)
          if (sentenceObj.videoData) {
            cleanSentence.hasUploadedVideo = true;
          }
          
          // Build clean permutations array manually
          const cleanPerms = [];
          for (let j = 0; j < permsArr.length; j++) {
            cleanPerms.push({
              korean: permsArr[j].korean || '',
              english: permsArr[j].english || ''
            });
          }
          
          cleanedSentences.push({
            sentence: cleanSentence,
            permutations: cleanPerms
          });
        }
        
        const gameToSave = {
          name: name,
          description: description || '',
          tags: tags,
          level: currentLevel,
          timerSeconds: parseInt(document.getElementById('timerInput').value) || 60,
          context: document.getElementById('contextInput').value.trim() || '',
          sentences: cleanedSentences,
          sentenceCount: cleanedSentences.length,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // Convert to JSON string and call parent function
        const jsonData = JSON.stringify(gameToSave);
        const result = await window.parent.saveYodafyGame(jsonData);
        
        if (result.success) {
          closeSaveGameModal();
          showToast('âœ… Game saved: ' + name);
          loadSavedGamesList();
        } else {
          showToast('âŒ Save failed: ' + (result.error || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Save error:', error);
        showToast('âŒ Save failed: ' + (error.message || 'Unknown error'));
      }
    }
    
    async function loadSavedGamesList() {
      const container = document.getElementById('savedGamesList');
      
      // Check if parent load function is available
      if (!window.parent || !window.parent.loadYodafyGames) {
        container.innerHTML = '<p style="color: #ff3366; font-size: 12px; text-align: center;">Load function not available</p>';
        return;
      }
      
      container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Loading...</p>';
      
      try {
        const result = await window.parent.loadYodafyGames();
        
        if (!result.success) {
          container.innerHTML = '<p style="color: #ff3366; font-size: 12px; text-align: center;">Error: ' + result.error + '</p>';
          return;
        }
        
        savedGames = result.games || [];
        
        if (savedGames.length === 0) {
          container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">No saved games yet</p>';
          return;
        }
        
        container.innerHTML = savedGames.map(g => {
          const date = g.createdAt ? new Date(g.createdAt).toLocaleDateString() : '';
          const tags = (g.tags || []).map(t => '<span style="background: rgba(0,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px;">' + t + '</span>').join('');
          return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 8px; border: 1px solid rgba(0,255,255,0.2);">' +
            '<div style="flex: 1;">' +
              '<div style="font-weight: bold; color: #00ffff; font-size: 13px;">' + g.name + '</div>' +
              '<div style="font-size: 11px; color: #888;">Level ' + g.level + ' â€¢ ' + g.sentenceCount + ' sentences â€¢ ' + date + '</div>' +
              (tags ? '<div style="margin-top: 4px;">' + tags + '</div>' : '') +
            '</div>' +
            '<div style="display: flex; gap: 5px;">' +
              '<button class="btn" style="padding: 5px 10px; font-size: 11px; background: #39ff14; color: #000;" onclick="loadSavedGame(\\x27' + g.id + '\\x27)">Load</button>' +
              '<button class="btn" style="padding: 5px 10px; font-size: 11px; background: #ff3366; color: #fff;" onclick="deleteSavedGame(\\x27' + g.id + '\\x27, \\x27' + g.name.replace(/'/g, '') + '\\x27)">ðŸ—‘ï¸</button>' +
            '</div>' +
          '</div>';
        }).join('');
        
      } catch (error) {
        console.error('Load error:', error);
        container.innerHTML = '<p style="color: #ff3366; font-size: 12px; text-align: center;">Error loading games: ' + error.message + '</p>';
      }
    }
    
    async function loadSavedGame(gameId) {
      // Check if parent load function is available
      if (!window.parent || !window.parent.loadYodafyGameById) {
        showToast('âŒ Load function not available');
        return;
      }
      
      try {
        const result = await window.parent.loadYodafyGameById(gameId);
        
        if (!result.success) {
          showToast('âŒ ' + (result.error || 'Game not found'));
          return;
        }
        
        const game = result.game;
        
        // Set level
        selectLevel(game.level || 1);
        
        // Set timer
        document.getElementById('timerInput').value = game.timerSeconds || 60;
        
        // Set context
        document.getElementById('contextInput').value = game.context || '';
        
        // Load sentences
        gameData.sentences = game.sentences || [];
        
        // Show preview
        renderPreview();
        document.getElementById('previewSection').style.display = 'block';
        document.getElementById('startGameBtn').disabled = false;
        
        showToast('âœ… Loaded: ' + game.name);
        
      } catch (error) {
        console.error('Load error:', error);
        showToast('âŒ Load failed: ' + error.message);
      }
    }
    
    async function deleteSavedGame(gameId, gameName) {
      if (!confirm('Delete "' + gameName + '"? This cannot be undone.')) return;
      
      // Check if parent delete function is available
      if (!window.parent || !window.parent.deleteYodafyGame) {
        showToast('âŒ Delete function not available');
        return;
      }
      
      try {
        const result = await window.parent.deleteYodafyGame(gameId);
        if (result.success) {
          showToast('âœ… Deleted: ' + gameName);
          loadSavedGamesList();
        } else {
          showToast('âŒ Delete failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Delete error:', error);
        showToast('âŒ Delete failed: ' + error.message);
      }
    }
    
    // Load saved games on page load with retry
    function initSavedGames() {
      if (window.parent && window.parent.loadYodafyGames) {
        loadSavedGamesList();
      } else {
        // Retry after a short delay if parent functions not ready
        setTimeout(initSavedGames, 500);
      }
    }
    setTimeout(initSavedGames, 300);
  <\/script>
</body>
</html>`;
        }
        // ==================== END PERMUTATION GAME ====================

        function addMaterialBlock(type) {
            document.getElementById('editingMaterialId').value = '';
            document.getElementById('editingMaterialType').value = type;
            document.getElementById('materialModalTitle').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const form = document.getElementById('materialFormContainer');

            if (type === 'text') {
                form.innerHTML = `
                    <div class="form-group">
                        <label>Content</label>
                        <div class="rich-text-toolbar">
                            <button type="button" onclick="execRichCmd('bold')" title="Bold"><b>B</b></button>
                            <button type="button" onclick="execRichCmd('italic')" title="Italic"><i>I</i></button>
                            <button type="button" onclick="execRichCmd('underline')" title="Underline"><u>U</u></button>
                            <div class="toolbar-divider"></div>
                            <input type="color" id="textColorPicker" value="#ffffff" onchange="execRichCmd('foreColor', this.value)" title="Text Color">
                            <input type="color" id="bgColorPicker" value="#000000" onchange="execRichCmd('hiliteColor', this.value)" title="Highlight Color">
                            <div class="toolbar-divider"></div>
                            <button type="button" onclick="execRichCmd('insertUnorderedList')" title="Bullet List">â€¢ List</button>
                            <button type="button" onclick="execRichCmd('insertOrderedList')" title="Numbered List">1. List</button>
                            <div class="toolbar-divider"></div>
                            <button type="button" onclick="execRichCmd('fontSize', '3')" title="Normal Size">A</button>
                            <button type="button" onclick="execRichCmd('fontSize', '5')" title="Large Size" style="font-size: 16px;">A</button>
                            <div class="toolbar-divider"></div>
                            <button type="button" onclick="triggerEditorFileUpload('image')" title="Insert Image">ðŸ–¼ï¸</button>
                            <button type="button" onclick="triggerEditorFileUpload('audio')" title="Insert Audio">ðŸ”Š</button>
                            <button type="button" onclick="triggerEditorFileUpload('file')" title="Insert File">ðŸ“Ž</button>
                            <div class="toolbar-divider"></div>
                            <button type="button" onclick="execRichCmd('removeFormat')" title="Clear Formatting">âœ•</button>
                        </div>
                        <div id="richTextEditor" class="rich-text-editor" contenteditable="true" 
                            ondragover="handleEditorDragOver(event)" 
                            ondrop="handleEditorDrop(event)"
                            ondragleave="handleEditorDragLeave(event)"></div>
                        <input type="file" id="editorFileInput" style="display: none;" onchange="handleEditorFileSelect(event)">
                        <p style="font-size: 11px; color: #888; margin-top: 5px;">ðŸ’¡ Tip: You can drag & drop images directly into the editor</p>
                    </div>
                `;
            }
            else if (type === 'link') form.innerHTML = `
                <div class="form-group"><label>URL</label><input type="url" id="materialUrl" placeholder="https://..."></div>
                <div class="form-group"><label>Title</label><input type="text" id="materialTitle" placeholder="Link title"></div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="materialDrawpad" style="width: 18px; height: 18px;">
                        <span>ðŸŽ¨ Enable Drawpad Mode</span>
                    </label>
                    <p style="font-size: 11px; color: #888; margin-top: 5px;">When enabled, teachers can draw on this link when presenting. Otherwise, it opens as a regular clickable link.</p>
                </div>
            `;
            else if (type === 'image') form.innerHTML = `
                <div class="form-group">
                    <label>Upload Image or Enter URL</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-sm btn-info" onclick="document.getElementById('imageFileInput').click()">ðŸ“¤ Upload Image</button>
                        <span style="color: #888; font-size: 12px; align-self: center;">or paste URL below</span>
                    </div>
                    <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleMaterialFileUpload(event, 'image')">
                    <input type="url" id="materialUrl" placeholder="https://...">
                    <div id="imagePreview" style="margin-top: 10px;"></div>
                </div>
                <div class="form-group"><label>Caption</label><input type="text" id="materialCaption" placeholder="Caption"></div>`;
            else if (type === 'file') form.innerHTML = `
                <div class="form-group">
                    <label>Upload File or Enter URL</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-sm btn-info" onclick="document.getElementById('fileFileInput').click()">ðŸ“¤ Upload File</button>
                        <span style="color: #888; font-size: 12px; align-self: center;">or paste URL below</span>
                    </div>
                    <input type="file" id="fileFileInput" style="display: none;" onchange="handleMaterialFileUpload(event, 'file')">
                    <input type="url" id="materialUrl" placeholder="https://...">
                    <div id="uploadProgress" style="margin-top: 10px;"></div>
                </div>
                <div class="form-group"><label>Display Name</label><input type="text" id="materialFilename" placeholder="document.pdf"></div>`;
            else if (type === 'permutation-game') form.innerHTML = `
                <div class="form-group">
                    <label>Yodafy Game Title</label>
                    <input type="text" id="materialTitle" placeholder="e.g., Level 1 Yodafy Practice" value="ðŸŒŸ Yodafy Game">
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="materialDescription" placeholder="Description of this Yodafy game activity..." style="height: 80px;"></textarea>
                </div>
                <div style="background: rgba(156,39,176,0.2); border: 2px solid #9c27b0; border-radius: 8px; padding: 15px; margin-top: 10px;">
                    <p style="color: #ce93d8; font-size: 13px; margin: 0;">
                        <strong>ðŸŒŸ Yodafy Game</strong><br><br>
                        This interactive game helps students practice Korean sentence variations through 4 levels:<br>
                        â€¢ <strong>Level 1:</strong> Word-order permutations<br>
                        â€¢ <strong>Level 2:</strong> Single word substitutions<br>
                        â€¢ <strong>Level 3:</strong> Multiple word substitutions<br>
                        â€¢ <strong>Level 4:</strong> Situational responses<br><br>
                        <em>Uses AI (GPT) to generate sentences and permutations.</em>
                    </p>
                </div>`;

            // Show/hide Test button based on material type
            const testBtn = document.getElementById('testYodafyBtn');
            if (testBtn) {
                testBtn.style.display = type === 'permutation-game' ? 'inline-block' : 'none';
            }

            document.getElementById('materialModal').classList.add('active');
        }
        
        let currentEditorUploadType = 'image';
        
        function triggerEditorFileUpload(type) {
            currentEditorUploadType = type;
            const input = document.getElementById('editorFileInput');
            if (type === 'image') input.accept = 'image/*';
            else if (type === 'audio') input.accept = 'audio/*';
            else input.accept = '*/*';
            input.click();
        }
        
        async function handleEditorFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            await uploadAndInsertFile(file, currentEditorUploadType);
            event.target.value = '';
        }
        
        function handleEditorDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#39ff14';
            event.currentTarget.style.background = 'rgba(57, 255, 20, 0.1)';
        }
        
        function handleEditorDragLeave(event) {
            event.currentTarget.style.borderColor = '#333';
            event.currentTarget.style.background = '#0a0a15';
        }
        
        async function handleEditorDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#333';
            event.currentTarget.style.background = '#0a0a15';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const type = file.type.startsWith('image/') ? 'image' : 
                             file.type.startsWith('audio/') ? 'audio' : 'file';
                await uploadAndInsertFile(file, type);
            }
        }
        
        async function uploadAndInsertFile(file, type) {
            const editor = document.getElementById('richTextEditor');
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'color: #ffff00; font-size: 14px; padding: 5px;';
            statusDiv.textContent = `Uploading ${file.name}...`;
            editor.appendChild(statusDiv);
            
            try {
                const filename = `materials/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const storageRef = firebase.storage().ref().child(filename);
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                
                statusDiv.remove();
                
                if (type === 'image') {
                    const img = document.createElement('img');
                    img.src = url;
                    img.style.cssText = 'max-width: 100%; border-radius: 4px; margin: 10px 0;';
                    editor.appendChild(img);
                } else if (type === 'audio') {
                    const audio = document.createElement('audio');
                    audio.src = url;
                    audio.controls = true;
                    audio.style.cssText = 'width: 100%; margin: 10px 0;';
                    editor.appendChild(audio);
                } else {
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = file.name;
                    link.textContent = `ðŸ“ ${file.name}`;
                    link.style.cssText = 'color: #00ffff; display: block; margin: 10px 0;';
                    editor.appendChild(link);
                }
                
                editor.appendChild(document.createElement('br'));
                editor.focus();
            } catch (e) {
                statusDiv.textContent = `Error: ${e.message}`;
                statusDiv.style.color = '#ff3366';
                console.error('Upload error:', e);
            }
        }
        
        async function handleMaterialFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const progressDiv = document.getElementById(type === 'image' ? 'imagePreview' : 'uploadProgress');
            progressDiv.innerHTML = `<p style="color: #ffff00; font-size: 12px;">Uploading ${file.name}...</p>`;
            
            try {
                const filename = `materials/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const storageRef = firebase.storage().ref().child(filename);
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                
                document.getElementById('materialUrl').value = url;
                
                if (type === 'image') {
                    progressDiv.innerHTML = `<img src="${url}" style="max-width: 200px; border-radius: 4px; border: 2px solid #39ff14;"><p style="color: #39ff14; font-size: 12px;">âœ“ Image uploaded!</p>`;
                } else {
                    document.getElementById('materialFilename').value = file.name;
                    progressDiv.innerHTML = `<p style="color: #39ff14; font-size: 12px;">âœ“ File uploaded: ${file.name}</p>`;
                }
            } catch (e) {
                progressDiv.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
                console.error('Upload error:', e);
            }
        }
        
        function execRichCmd(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('richTextEditor').focus();
        }

        function closeMaterialModal() { document.getElementById('materialModal').classList.remove('active'); }
        
        function testYodafyFromMaterial() {
            // Open the Yodafy game in test mode
            const title = document.getElementById('materialTitle')?.value || 'ðŸŒŸ Yodafy Game';
            const description = document.getElementById('materialDescription')?.value || '';
            
            // Open the permutation game overlay
            openPermutationGame();
        }

        async function saveMaterial() {
            const type = document.getElementById('editingMaterialType').value;
            const level = document.getElementById('materialLevelSelect').value;
            const week = document.getElementById('materialWeekSelect').value;
            const id = document.getElementById('editingMaterialId').value;

            const data = { type, level, week: parseInt(week) };
            
            // Only set order for new materials, preserve existing order for edits
            if (!id) {
                data.order = Date.now();
            }
            
            if (type === 'text') {
                const editor = document.getElementById('richTextEditor');
                data.content = editor ? editor.innerHTML : '';
            }
            else if (type === 'link') { 
                data.url = document.getElementById('materialUrl').value; 
                data.title = document.getElementById('materialTitle').value;
                data.isDrawpad = document.getElementById('materialDrawpad')?.checked || false;
            }
            else if (type === 'image') { data.url = document.getElementById('materialUrl').value; data.caption = document.getElementById('materialCaption')?.value; }
            else if (type === 'file') { data.url = document.getElementById('materialUrl').value; data.filename = document.getElementById('materialFilename').value; }
            else if (type === 'permutation-game') {
                data.title = document.getElementById('materialTitle')?.value || 'ðŸŒŸ Yodafy Game';
                data.description = document.getElementById('materialDescription')?.value || '';
                data.gameType = 'permutation';
            }

            try {
                if (id) {
                    await db.collection('scheduler_materials').doc(id).update(data);
                } else {
                    await db.collection('scheduler_materials').add(data);
                }
                closeMaterialModal();
                loadMaterialsForLevel();
                alert(`âœ… Material ${id ? 'updated' : 'saved'} successfully!`);
            } catch (e) { showMessage('materialModalMessage', 'Error: ' + e.message, 'error'); }
        }

        async function editMaterial(id) {
            const doc = await db.collection('scheduler_materials').doc(id).get();
            if (!doc.exists) return;
            const m = doc.data();
            addMaterialBlock(m.type);
            // Set the ID AFTER addMaterialBlock (which clears it)
            document.getElementById('editingMaterialId').value = id;
            document.getElementById('materialModalTitle').textContent = `Edit ${m.type.charAt(0).toUpperCase() + m.type.slice(1)}`;
            setTimeout(() => {
                if (m.type === 'text') {
                    const editor = document.getElementById('richTextEditor');
                    if (editor) editor.innerHTML = m.content || '';
                }
                else if (m.type === 'link') { 
                    document.getElementById('materialUrl').value = m.url || ''; 
                    document.getElementById('materialTitle').value = m.title || '';
                    if (document.getElementById('materialDrawpad')) document.getElementById('materialDrawpad').checked = m.isDrawpad || false;
                }
                else if (m.type === 'image') { document.getElementById('materialUrl').value = m.url || ''; if (document.getElementById('materialCaption')) document.getElementById('materialCaption').value = m.caption || ''; }
                else if (m.type === 'file') { document.getElementById('materialUrl').value = m.url || ''; document.getElementById('materialFilename').value = m.filename || ''; }
                else if (m.type === 'permutation-game') {
                    if (document.getElementById('materialTitle')) document.getElementById('materialTitle').value = m.title || 'ðŸŒŸ Yodafy Game';
                    if (document.getElementById('materialDescription')) document.getElementById('materialDescription').value = m.description || '';
                }
            }, 100);
        }

        async function deleteMaterial(id) {
            if (!confirm('Delete this material?')) return;
            await db.collection('scheduler_materials').doc(id).delete();
            loadMaterialsForLevel();
        }

        // Teacher Materials
        async function loadTeacherMaterials() {
            const level = document.getElementById('teacherMaterialLevel').value;
            const week = document.getElementById('teacherMaterialWeek').value;
            try {
                let snap = await db.collection('scheduler_materials').get();
                let materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Filter by level and week
                materials = materials.filter(m => m.level === level && (m.week == week || m.week === parseInt(week)));
                
                materials.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                const container = document.getElementById('teacherMaterialsDisplay');
                
                if (materials.length === 0) { 
                    container.innerHTML = '<p style="color: #888; font-size: 14px; font-family: Noto Sans, sans-serif;">No materials for this selection.</p>'; 
                    return; 
                }
                container.innerHTML = materials.map(m => `
                    <div class="material-block">
                        <div class="material-header">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span class="material-type">${m.type}</span>
                            </div>
                        </div>
                        <div class="material-content">${renderMaterialContent(m, false)}</div>
                    </div>
                `).join('');
            } catch (e) { 
                console.error('Error loading teacher materials:', e);
                document.getElementById('teacherMaterialsDisplay').innerHTML = `<p style="color: #ff3366; font-size: 14px; font-family: Noto Sans, sans-serif;">Error loading materials: ${e.message}</p>`; 
            }
        }
        
        async function showClassMaterial(level, week) {
            try {
                const snap = await db.collection('scheduler_materials').get();
                let materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Filter by level and week, show links and Yodafy games
                materials = materials.filter(m => 
                    m.level === level && 
                    (m.week === week || m.week === parseInt(week)) &&
                    (m.type === 'link' || m.type === 'permutation-game')
                );
                materials.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                const levelName = LEVELS[level] || level; // Fallback to level ID if not found
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'classMaterialModal';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <button class="modal-close" onclick="closeClassMaterialModal()">âœ•</button>
                        <h3 class="modal-title">ðŸ“– ${levelName} - Week ${week} Materials</h3>
                        <p style="font-size: 11px; color: #888; margin-top: 5px;">ðŸ’¡ Click on a link to present with drawing tools, or launch games</p>
                        <div style="margin-top: 15px;">
                            ${materials.length === 0 ? 
                                '<p style="color: #888; font-size: 12px; font-family: Noto Sans, sans-serif; text-align: center; padding: 20px;">No materials available for this level and week.</p>' :
                                materials.map(m => {
                                    const content = renderTeacherMaterialContent(m);
                                    if (!content) return '';
                                    return `
                                        <div class="material-block" style="margin-bottom: 15px;">
                                            <div class="material-content">${content}</div>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add click handlers for images after modal is added
                setTimeout(() => {
                    const modalEl = document.getElementById('classMaterialModal');
                    if (modalEl) {
                        modalEl.querySelectorAll('.clickable-media').forEach(el => {
                            el.onclick = (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                // Get URL from multiple possible sources
                                let url = el.dataset.src || el.src || el.getAttribute('src');
                                let type = el.dataset.type || 'image';
                                
                                // If it's an img element, use src
                                if (el.tagName === 'IMG' && el.src) {
                                    url = el.src;
                                }
                                
                                console.log('Opening presentation:', url, type);
                                if (url) {
                                    openPresentationMode(url, type);
                                } else {
                                    alert('Could not get file URL');
                                }
                            };
                        });
                    }
                }, 100);
            } catch (e) {
                console.error('Error loading class materials:', e);
                alert('Error loading materials: ' + e.message);
            }
        }
        
        // Helper function to get week from dropdown and show material
        // Can accept either a classId (will prepend 'materialWeekSelect_') or a full element ID
        function showClassMaterialFromDropdown(level, idOrClassId) {
            // Check if it's a full element ID (contains 'materialWeekSelect' or 'adminMaterialWeekSelect')
            let selectId = idOrClassId;
            if (!idOrClassId.includes('materialWeekSelect') && !idOrClassId.includes('MaterialWeekSelect')) {
                selectId = 'materialWeekSelect_' + idOrClassId;
            }
            const select = document.getElementById(selectId);
            const week = select ? parseInt(select.value) : 1;
            showClassMaterial(level, week);
        }
        
        function renderTeacherMaterialContent(m) {
            const fontStyle = "font-family: 'Noto Sans', sans-serif; font-size: 12px; line-height: 1.6;";
            
            // Links
            if (m.type === 'link') {
                // Check if drawpad mode is enabled
                if (m.isDrawpad) {
                    // Drawpad mode - click to present with drawing tools
                    return `<div class="clickable-media" data-src="${m.url}" data-type="link" style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer;">
                        <span style="font-size: 24px;">ðŸŽ¨</span>
                        <p style="${fontStyle} color: #00ffff; margin-top: 8px;">${m.title || m.url}</p>
                        <p style="font-size: 11px; color: #888;">Click to present with drawing tools</p>
                    </div>`;
                } else {
                    // Regular link - just opens in new tab
                    return `<div style="background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 15px; text-align: center;">
                        <span style="font-size: 24px;">ðŸ”—</span>
                        <p style="${fontStyle} margin-top: 8px;">
                            <a href="${m.url}" target="_blank" style="color: #ffff00; text-decoration: none;">${m.title || m.url}</a>
                        </p>
                        <p style="font-size: 11px; color: #888;">Click to open in new tab</p>
                    </div>`;
                }
            }
            
            // Yodafy Game
            if (m.type === 'permutation-game') {
                return `<div style="background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(103,58,183,0.2)); border: 2px solid #9c27b0; border-radius: 8px; padding: 15px; text-align: center;">
                    <span style="font-size: 24px;">ðŸ”„</span>
                    <p style="${fontStyle} color: #ce93d8; margin-top: 8px; font-weight: 600;">${m.title || 'Yodafy Game'}</p>
                    ${m.description ? `<p style="font-size: 11px; color: #888; margin: 5px 0;">${m.description}</p>` : ''}
                    <button class="btn btn-sm" style="background: linear-gradient(135deg, #9c27b0, #673ab7); border-color: #9c27b0; color: #fff; margin-top: 10px;" onclick="closeClassMaterialModal(); openPermutationGame();">
                        ðŸŽ® Launch Game
                    </button>
                    <p style="font-size: 10px; color: #888; margin-top: 5px;">Uses AI (GPT)</p>
                </div>`;
            }
            
            return '';
        }
        
        // Presentation Mode Variables
        let presentationCanvas = null;
        let presentationCtx = null;
        let isDrawing = false;
        let currentTool = 'rainbow';
        let brushSize = 5;
        let brushColor = '#ff0000';
        let rainbowHue = 0;
        let lastX = 0;
        let lastY = 0;
        
        function openPresentationMode(src, type = 'image') {
            if (!src) {
                alert('No file URL available');
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'presentation-overlay';
            overlay.id = 'presentationMode';
            
            // Determine content type
            const srcLower = src.toLowerCase();
            const isIframe = type === 'pdf' || type === 'link' || srcLower.includes('.pdf');
            
            // For iframes, we don't put canvas on top (so scrolling works)
            // For images, canvas goes on top for drawing
            
            overlay.innerHTML = `
                <div class="presentation-toolbar">
                    <div class="tool-group">
                        <button id="toolRainbow" class="active" onclick="setDrawTool('rainbow')" title="Rainbow Pen">ðŸŒˆ Draw</button>
                        <button id="toolPen" onclick="setDrawTool('pen')" title="Pen">âœï¸ Pen</button>
                        <button id="toolHighlight" onclick="setDrawTool('highlight')" title="Highlighter">ðŸ–ï¸ Highlight</button>
                        <button id="toolEraser" onclick="setDrawTool('eraser')" title="Eraser">ðŸ§¹ Erase</button>
                    </div>
                    <div class="tool-group">
                        <label style="color: #fff; font-size: 12px;">Size:</label>
                        <input type="range" id="brushSizeSlider" min="2" max="50" value="${brushSize}" oninput="updateBrushSize(this.value)">
                        <span id="brushSizeDisplay" style="color: #fff; font-size: 14px; min-width: 25px;">${brushSize}px</span>
                        <input type="color" id="penColorPicker" value="${brushColor}" oninput="brushColor = this.value" title="Pen Color">
                    </div>
                    <div class="tool-group">
                        <button onclick="clearCanvas()" title="Clear All">ðŸ—‘ï¸ Clear</button>
                        <button onclick="undoCanvas()" title="Undo">â†©ï¸ Undo</button>
                    </div>
                </div>
                <button class="presentation-close" onclick="closePresentationMode()">âœ• Close</button>
                <div class="presentation-content" id="presentationContent">
                    ${isIframe ? `
                        <div style="position: relative; width: 95vw; height: calc(100vh - 80px);">
                            <iframe id="presentationIframe" src="${src}" style="width: 100%; height: 100%; border: none; border-radius: 8px;"></iframe>
                            <canvas id="presentationCanvas" class="presentation-canvas" style="pointer-events: none;"></canvas>
                            <div id="drawingToggle" style="position: absolute; top: 10px; left: 10px; z-index: 100;">
                                <button onclick="toggleDrawingMode()" id="drawModeBtn" style="background: #333; border: 2px solid #00ffff; color: #00ffff; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">âœï¸ Enable Drawing</button>
                            </div>
                        </div>
                    ` : `
                        <div class="presentation-wrapper" id="presentationWrapper">
                            <img id="presentationImage" class="presentation-image" src="${src}" draggable="false" />
                            <canvas id="presentationCanvas" class="presentation-canvas"></canvas>
                        </div>
                    `}
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            
            // Initialize after content loads
            if (isIframe) {
                const iframe = document.getElementById('presentationIframe');
                iframe.onload = () => {
                    initIframeCanvas();
                };
                setTimeout(initIframeCanvas, 1000);
            } else {
                const img = document.getElementById('presentationImage');
                img.onload = () => {
                    initPresentationCanvas();
                };
                img.onerror = () => {
                    document.getElementById('presentationWrapper').innerHTML = `
                        <div style="color: #fff; text-align: center; padding: 50px;">
                            <p style="font-size: 40px;">âŒ</p>
                            <p>Failed to load content</p>
                            <a href="${src}" target="_blank" style="color: #00ffff;">Open in new tab</a>
                        </div>
                    `;
                };
                // If image already loaded (cached)
                if (img.complete && img.naturalWidth > 0) {
                    initPresentationCanvas();
                }
            }
        }
        
        let drawingModeEnabled = false;
        
        function toggleDrawingMode() {
            drawingModeEnabled = !drawingModeEnabled;
            const canvas = document.getElementById('presentationCanvas');
            const btn = document.getElementById('drawModeBtn');
            if (drawingModeEnabled) {
                canvas.style.pointerEvents = 'auto';
                btn.textContent = 'ðŸ–±ï¸ Disable Drawing (Enable Scroll)';
                btn.style.background = '#00ffff';
                btn.style.color = '#000';
            } else {
                canvas.style.pointerEvents = 'none';
                btn.textContent = 'âœï¸ Enable Drawing';
                btn.style.background = '#333';
                btn.style.color = '#00ffff';
            }
        }
        
        function initIframeCanvas() {
            presentationCanvas = document.getElementById('presentationCanvas');
            const iframe = document.getElementById('presentationIframe');
            if (!presentationCanvas || !iframe) return;
            
            presentationCanvas.width = iframe.offsetWidth;
            presentationCanvas.height = iframe.offsetHeight;
            presentationCanvas.style.width = iframe.offsetWidth + 'px';
            presentationCanvas.style.height = iframe.offsetHeight + 'px';
            presentationCanvas.style.top = '0';
            presentationCanvas.style.left = '0';
            
            presentationCtx = presentationCanvas.getContext('2d');
            presentationCtx.lineCap = 'round';
            presentationCtx.lineJoin = 'round';
            
            window.canvasStates = [];
            saveCanvasState();
            
            // Mouse events
            presentationCanvas.addEventListener('mousedown', startDrawing);
            presentationCanvas.addEventListener('mousemove', draw);
            presentationCanvas.addEventListener('mouseup', stopDrawing);
            presentationCanvas.addEventListener('mouseleave', stopDrawing);
            
            // Touch events
            presentationCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            presentationCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            presentationCanvas.addEventListener('touchend', stopDrawing);
        }
        
        function updateBrushSize(value) {
            brushSize = parseInt(value);
            const display = document.getElementById('brushSizeDisplay');
            if (display) display.textContent = brushSize + 'px';
        }
        
        function initPresentationCanvas() {
            presentationCanvas = document.getElementById('presentationCanvas');
            const wrapper = document.getElementById('presentationWrapper');
            const img = document.getElementById('presentationImage');
            
            if (!presentationCanvas || !wrapper || !img) return;
            
            // Wait a tiny bit for image to render
            setTimeout(() => {
                const width = img.offsetWidth;
                const height = img.offsetHeight;
                
                presentationCanvas.width = width;
                presentationCanvas.height = height;
                presentationCanvas.style.width = width + 'px';
                presentationCanvas.style.height = height + 'px';
                
                presentationCtx = presentationCanvas.getContext('2d');
                presentationCtx.lineCap = 'round';
                presentationCtx.lineJoin = 'round';
                
                // Store states for undo
                window.canvasStates = [];
                saveCanvasState();
                
                // Mouse events
                presentationCanvas.addEventListener('mousedown', startDrawing);
                presentationCanvas.addEventListener('mousemove', draw);
                presentationCanvas.addEventListener('mouseup', stopDrawing);
                presentationCanvas.addEventListener('mouseleave', stopDrawing);
                
                // Touch events for tablet
                presentationCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
                presentationCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
                presentationCanvas.addEventListener('touchend', stopDrawing);
                
                // Resize handler
                window.addEventListener('resize', resizeCanvas);
            }, 50);
        }
        
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getPosition(e);
            saveCanvasState();
        }
        
        function draw(e) {
            if (!isDrawing || !presentationCtx) return;
            
            const [x, y] = getPosition(e);
            
            presentationCtx.beginPath();
            presentationCtx.moveTo(lastX, lastY);
            presentationCtx.lineTo(x, y);
            
            if (currentTool === 'rainbow') {
                rainbowHue = (rainbowHue + 2) % 360;
                presentationCtx.strokeStyle = `hsl(${rainbowHue}, 100%, 50%)`;
                presentationCtx.lineWidth = brushSize;
                presentationCtx.globalAlpha = 1;
                presentationCtx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'pen') {
                presentationCtx.strokeStyle = brushColor;
                presentationCtx.lineWidth = brushSize;
                presentationCtx.globalAlpha = 1;
                presentationCtx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'highlight') {
                presentationCtx.strokeStyle = brushColor;
                presentationCtx.lineWidth = brushSize * 3;
                presentationCtx.globalAlpha = 0.3;
                presentationCtx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'eraser') {
                presentationCtx.globalCompositeOperation = 'destination-out';
                presentationCtx.lineWidth = brushSize * 2;
                presentationCtx.globalAlpha = 1;
            }
            
            presentationCtx.stroke();
            [lastX, lastY] = [x, y];
        }
        
        function stopDrawing() {
            isDrawing = false;
            if (presentationCtx) {
                presentationCtx.globalAlpha = 1;
                presentationCtx.globalCompositeOperation = 'source-over';
            }
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            startDrawing(mouseEvent);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            draw(mouseEvent);
        }
        
        function getPosition(e) {
            const rect = presentationCanvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left;
            const y = (e.clientY || e.pageY) - rect.top;
            return [x, y];
        }
        
        function setDrawTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.presentation-toolbar button').forEach(btn => {
                if (btn.id && btn.id.startsWith('tool')) {
                    btn.classList.remove('active');
                }
            });
            const toolBtn = document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1));
            if (toolBtn) toolBtn.classList.add('active');
        }
        
        function saveCanvasState() {
            if (!presentationCanvas) return;
            if (window.canvasStates.length > 20) window.canvasStates.shift();
            window.canvasStates.push(presentationCanvas.toDataURL());
        }
        
        function undoCanvas() {
            if (!window.canvasStates || window.canvasStates.length <= 1) return;
            window.canvasStates.pop();
            const img = new Image();
            img.onload = () => {
                presentationCtx.clearRect(0, 0, presentationCanvas.width, presentationCanvas.height);
                presentationCtx.drawImage(img, 0, 0);
            };
            img.src = window.canvasStates[window.canvasStates.length - 1];
        }
        
        function clearCanvas() {
            if (!presentationCtx || !presentationCanvas) return;
            saveCanvasState();
            presentationCtx.clearRect(0, 0, presentationCanvas.width, presentationCanvas.height);
        }
        
        function resizeCanvas() {
            if (!presentationCanvas) return;
            const wrapper = document.getElementById('presentationWrapper');
            const img = document.getElementById('presentationImage');
            const iframe = document.getElementById('presentationIframe');
            if (!wrapper) return;
            
            let width, height;
            if (img && img.complete && img.naturalWidth > 0) {
                width = img.offsetWidth;
                height = img.offsetHeight;
            } else if (iframe) {
                width = iframe.offsetWidth;
                height = iframe.offsetHeight;
            } else {
                width = wrapper.offsetWidth;
                height = wrapper.offsetHeight;
            }
            
            const imageData = presentationCtx.getImageData(0, 0, presentationCanvas.width, presentationCanvas.height);
            presentationCanvas.width = width;
            presentationCanvas.height = height;
            presentationCanvas.style.width = width + 'px';
            presentationCanvas.style.height = height + 'px';
            presentationCtx.putImageData(imageData, 0, 0);
            presentationCtx.lineCap = 'round';
            presentationCtx.lineJoin = 'round';
        }
        
        function closePresentationMode() {
            const overlay = document.getElementById('presentationMode');
            if (overlay) {
                overlay.remove();
                document.body.style.overflow = '';
                window.removeEventListener('resize', resizeCanvas);
            }
        }
        
        function closeClassMaterialModal() {
            const modal = document.getElementById('classMaterialModal');
            if (modal) modal.remove();
        }

        // Teacher Classes - New design with per-class week tracking
        async function loadTeacherClasses() {
            if (!currentUser) return;
            try {
                const snap = await db.collection('scheduler_classes').where('teacherId', '==', currentUser.odId).get();
                const allClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const activeClasses = allClasses.filter(c => c.status !== 'completed');
                
                // Also load prescheduled slots for this teacher
                const prescheduledSnap = await db.collection('prescheduled_slots').where('teacherId', '==', currentUser.odId).get();
                const prescheduledSlots = prescheduledSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const container = document.getElementById('teacherClassesContainer');
                
                if (activeClasses.length === 0 && prescheduledSlots.length === 0) { 
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No classes assigned.</p>'; 
                    return; 
                }
                
                // Load ALL attendance data for all classes
                const allAttendanceData = {};
                for (const cls of activeClasses) {
                    try {
                        const attendanceSnap = await db.collection('scheduler_attendance')
                            .where('classId', '==', cls.id)
                            .get();
                        
                        allAttendanceData[cls.id] = {};
                        attendanceSnap.docs.forEach(doc => {
                            const data = doc.data();
                            const key = `${data.studentId}_${data.week}`;
                            allAttendanceData[cls.id][key] = data.status;
                        });
                    } catch (err) {
                        console.error('Error loading attendance for class:', cls.id, err);
                        allAttendanceData[cls.id] = {};
                    }
                }
                
                // Helper function to calculate class week dates based on its start date
                function getClassWeekDates(cls, weekNum) {
                    if (!cls.startDate) return null;
                    const startDate = parseESTDate(cls.startDate);
                    const weekStart = new Date(startDate);
                    weekStart.setDate(startDate.getDate() + (weekNum - 1) * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    return { start: weekStart, end: weekEnd };
                }
                
                // Helper function to get current week number for a class (using EST)
                function getClassCurrentWeek(cls) {
                    if (!cls.startDate) return null;
                    const startDate = parseESTDate(cls.startDate);
                    const todayDate = getESTToday();
                    
                    if (todayDate < startDate) return 0; // Not started yet
                    
                    const daysSinceStart = getDaysBetween(todayDate, startDate);
                    const weekNum = Math.floor(daysSinceStart / 7) + 1;
                    return Math.min(weekNum, 7); // Cap at 7 (meaning past week 6)
                }
                
                // Helper function to check if all students have attendance for a week
                function isWeekAttendanceComplete(cls, weekNum) {
                    const students = cls.students || [];
                    if (students.length === 0) return false;
                    
                    const classAttendance = allAttendanceData[cls.id] || {};
                    return students.every(s => {
                        const key = `${s.id}_${weekNum}`;
                        return classAttendance[key] && ['present', 'late', 'absent'].includes(classAttendance[key]);
                    });
                }
                
                // Helper function to format date range
                function formatDateRange(start, end) {
                    const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                    return `${formatDate(start)}-${formatDate(end)}`;
                }
                
                // Helper function to get attendance status
                function getAttendanceStatusForClass(classId, studentId, week) {
                    const classAttendance = allAttendanceData[classId] || {};
                    return classAttendance[`${studentId}_${week}`] || '';
                }
                
                // Render active classes first, then prescheduled
                let html = '';
                
                // Active classes section
                if (activeClasses.length > 0) {
                    html += activeClasses.map(c => renderClassCard(c)).join('');
                }
                
                // Prescheduled section at the bottom
                if (prescheduledSlots.length > 0) {
                    html += '<div style="margin-top: 20px;"><h4 style="color: #ff9800; margin-bottom: 10px;">â³ Upcoming Pre-scheduled Classes</h4>';
                    html += prescheduledSlots.map(ps => renderPrescheduledCard(ps)).join('');
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
                // Populate attendance dropdown
                const select = document.getElementById('attendanceClassSelect');
                if (select) {
                    select.innerHTML = '<option value="">-- Select --</option>' + allClasses.map(c => `<option value="${c.id}">${c.day} ${c.time} - ${LEVELS[c.level]}</option>`).join('');
                }
                
                // Helper function to render a prescheduled card
                function renderPrescheduledCard(ps) {
                    const startDate = ps.startDate ? new Date(ps.startDate + 'T00:00:00') : null;
                    const startDateDisplay = startDate ? startDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const classTypeName = LEVELS[ps.classType] || ps.classType || 'Class';
                    
                    // Calculate days until start
                    let daysUntilStart = '';
                    if (startDate) {
                        const now = new Date();
                        const diffTime = startDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysUntilStart = `(in ${diffDays} day${diffDays > 1 ? 's' : ''})`;
                        } else if (diffDays === 0) {
                            daysUntilStart = '(Today!)';
                        }
                    }
                    
                    return `
                        <div class="class-card" style="border: 2px solid #ff9800; background: rgba(255,152,0,0.1);">
                            <div class="class-header">
                                <div>
                                    <div class="class-day" style="color: #ff9800;">${ps.day}</div>
                                    <div class="class-time">${ps.time} EST</div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="level-badge level-${ps.classType}" style="border-color: #ff9800;">${classTypeName}</span>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 8px; margin-top: 10px;">
                                <div style="font-size: 24px; margin-bottom: 5px;">â³</div>
                                <p style="color: #ff9800; font-size: 14px; margin: 0; font-weight: bold;">Pre-scheduled</p>
                                <p style="color: #fff; font-size: 13px; margin: 5px 0;">Starts: ${startDateDisplay}</p>
                                <p style="color: #ffff00; font-size: 12px; margin: 0;">${daysUntilStart}</p>
                                <p style="color: #888; font-size: 11px; margin-top: 10px;">Students will be assigned before the start date.</p>
                            </div>
                        </div>
                    `;
                }
                
                // Helper function to render a class card
                function renderClassCard(c) {
                    const currentWeek = getClassCurrentWeek(c);
                    const startDateDisplay = c.startDate ? new Date(c.startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                    
                    // Build week tracker
                    let weekTrackerHtml = '<div class="class-week-tracker">';
                    for (let w = 1; w <= 6; w++) {
                        const weekDates = getClassWeekDates(c, w);
                        const dateRange = weekDates ? formatDateRange(weekDates.start, weekDates.end) : '';
                        const isCompleted = isWeekAttendanceComplete(c, w) && currentWeek > w;
                        const isCurrent = currentWeek === w;
                        const isFuture = currentWeek < w;
                        
                        let weekClass = 'class-week-box';
                        if (isCompleted) weekClass += ' completed';
                        else if (isCurrent) weekClass += ' current';
                        else if (isFuture) weekClass += ' future';
                        
                        weekTrackerHtml += `
                            <div class="${weekClass}" onclick="showClassMaterial('${c.level}', ${w})" style="cursor: pointer;" title="Click to view Week ${w} materials">
                                <span class="week-label">Week ${w}</span>
                                <span class="week-dates">${dateRange}</span>
                                <span style="font-size: 9px; color: #9c27b0;">ðŸ“–</span>
                            </div>
                        `;
                    }
                    weekTrackerHtml += '</div>';
                    
                    // Determine which week to show attendance for
                    const attendanceWeek = currentWeek > 0 && currentWeek <= 6 ? currentWeek : 1;
                    
                    return `
                        <div class="class-card">
                            <div class="class-header">
                                <div>
                                    <div class="class-day">${c.day}</div>
                                    <div class="class-time">${c.time} EST</div>
                                    <div style="font-size: 11px; color: #00ffff; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                </div>
                            </div>
                            
                            ${weekTrackerHtml}
                            <p style="font-size: 10px; color: #888; text-align: center; margin: 5px 0;">ðŸ‘† Click any week to view materials</p>
                            
                            ${currentWeek >= 1 && currentWeek <= 6 ? `
                                <h4 style="color: #ffff00; font-size: 13px; margin: 10px 0;">Attendance - Week ${attendanceWeek}</h4>
                                <div style="display: grid; gap: 10px;">
                                    ${(c.students || []).map(s => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                            <span style="cursor: pointer; text-decoration: underline; color: #00ffff;" onclick="openStudentAnalyticsMenu('${s.id}', '${s.name.replace(/'/g, "\\'")}', '${(s.email || '').replace(/'/g, "\\'")}')">${s.name}</span>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="attendance-btn present ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'present' ? 'active' : ''}" onclick="markAttendanceWithWeek('${c.id}', '${s.id}', 'present', ${attendanceWeek})">P</button>
                                                <button class="attendance-btn late ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'late' ? 'active' : ''}" onclick="markAttendanceWithWeek('${c.id}', '${s.id}', 'late', ${attendanceWeek})">L</button>
                                                <button class="attendance-btn absent ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'absent' ? 'active' : ''}" onclick="handleAbsentClickWithWeek('${c.id}', '${s.id}', '${s.name.replace(/'/g, "\\'")}', ${attendanceWeek})">A</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : currentWeek > 6 ? `
                                <div style="text-align: center; padding: 15px; background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px;">
                                    <p style="color: #39ff14; font-size: 13px; margin: 0;">ðŸŽ“ Course Complete!</p>
                                    <p style="color: #888; font-size: 11px; margin-top: 5px;">This class has finished all 6 weeks.</p>
                                    <button class="btn btn-sm btn-success" onclick="markClassAsCompleted('${c.id}')" style="margin-top: 10px;">Move to Completed</button>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <p style="color: #888; font-size: 12px;">Class hasn't started yet.</p>
                                </div>
                            `}
                        </div>
                    `;
                }
                
            } catch (e) { console.error(e); }
        }
        
        // Mark attendance with specific week
        async function markAttendanceWithWeek(classId, studentId, status, week) {
            const key = `${classId}_${studentId}_${week}`;
            attendanceCache[key] = status;

            try {
                await db.collection('scheduler_attendance').doc(key).set({ 
                    classId, 
                    studentId, 
                    week, 
                    status, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                }, { merge: true });
                
                // Check if this completes Week 6 attendance
                if (week === 6) {
                    await checkWeek6Complete(classId);
                }
                
                loadTeacherClasses();
            } catch (e) { 
                console.error('Error saving attendance:', e); 
                alert('Error saving attendance: ' + e.message);
            }
        }
        
        // Handle absent click with specific week
        function handleAbsentClickWithWeek(classId, studentId, studentName, week) {
            window.currentAbsenceWeek = week;
            openAbsenceModal(classId, studentId, studentName);
        }
        
        // Check if Week 6 is complete and show reminder
        async function checkWeek6Complete(classId) {
            try {
                const classDoc = await db.collection('scheduler_classes').doc(classId).get();
                if (!classDoc.exists) return;
                
                const classData = classDoc.data();
                const students = classData.students || [];
                
                // Check if all students have Week 6 attendance
                const attendanceSnap = await db.collection('scheduler_attendance')
                    .where('classId', '==', classId)
                    .where('week', '==', 6)
                    .get();
                
                const markedStudents = new Set();
                attendanceSnap.docs.forEach(doc => {
                    markedStudents.add(doc.data().studentId);
                });
                
                const allMarked = students.every(s => markedStudents.has(s.id));
                
                if (allMarked) {
                    // Show reminder modal
                    showWeek6ReminderModal(classId, classData);
                }
            } catch (e) {
                console.error('Error checking Week 6 completion:', e);
            }
        }
        
        // Show Week 6 completion reminder
        function showWeek6ReminderModal(classId, classData) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'week6ReminderModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 450px;">
                    <button class="modal-close" onclick="closeWeek6ReminderModal()">Ã—</button>
                    <div style="text-align: center;">
                        <div style="font-size: 50px; margin-bottom: 15px;">ðŸŽ‰</div>
                        <h3 style="color: #39ff14; font-size: 12px; margin-bottom: 15px;">Week 6 Complete!</h3>
                        <p style="color: #fff; font-size: 13px; margin-bottom: 20px;">
                            ${classData.day} @ ${classData.time} - ${LEVELS[classData.level]}
                        </p>
                        <div style="background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <p style="color: #ffff00; font-size: 14px; margin-bottom: 10px;">ðŸ“¢ REMINDER</p>
                            <p style="color: #fff; font-size: 12px; line-height: 1.6;">
                                Please inform your students about:<br><br>
                                1ï¸âƒ£ <strong style="color: #39ff14;">Discount for next course</strong><br>
                                2ï¸âƒ£ <strong style="color: #00ffff;">1-Year Academy Program</strong>
                            </p>
                        </div>
                        <button class="btn btn-success" onclick="markClassAsCompleted('${classId}'); closeWeek6ReminderModal();" style="width: 100%;">
                            âœ… Move to Completed
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeWeek6ReminderModal() {
            const modal = document.getElementById('week6ReminderModal');
            if (modal) modal.remove();
        }
        
        // Mark class as completed
        async function markClassAsCompleted(classId) {
            try {
                await db.collection('scheduler_classes').doc(classId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadTeacherClasses();
                loadTodayClasses();
                loadTeacherCompletedClasses();
            } catch (e) {
                console.error('Error marking class as completed:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Set 1-Year Academy status for a student
        async function setAcademyStatus(classId, studentId, status) {
            try {
                const classDoc = await db.collection('scheduler_classes').doc(classId).get();
                const currentData = classDoc.data();
                const academyStatus = currentData.academyStatus || {};
                academyStatus[studentId] = status;
                
                await db.collection('scheduler_classes').doc(classId).update({
                    academyStatus: academyStatus
                });
                
                // Update local data and re-render without reloading from Firebase
                const classIndex = allCompletedClasses.findIndex(c => c.id === classId);
                if (classIndex !== -1) {
                    allCompletedClasses[classIndex].academyStatus = academyStatus;
                }
                renderFilteredCompletedClasses();
            } catch (e) {
                console.error('Error setting academy status:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Load Today's Classes Tab
        async function loadTodayClasses() {
            if (!currentUser) return;
            const container = document.getElementById('todayClassesContainer');
            if (!container) return;
            
            try {
                const snap = await db.collection('scheduler_classes').where('teacherId', '==', currentUser.odId).get();
                const fetchedClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                const activeClasses = fetchedClasses.filter(c => c.status !== 'completed');
                
                // Update allClassesForTeacher so analytics can find student emails
                allClassesForTeacher = fetchedClasses;
                
                // Use EST timezone for "today" determination
                const todayEST = getESTToday();
                const todayDayName = getESTDayName();
                
                // Filter classes that have started AND are scheduled for today (EST)
                const todaysClasses = activeClasses.filter(c => {
                    if (!c.startDate) return false;
                    const startDate = parseESTDate(c.startDate);
                    return isDateOnOrAfter(todayEST, startDate) && c.day === todayDayName;
                });
                
                if (todaysClasses.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 40px; margin-bottom: 15px;">ðŸ“…</div>
                            <p style="color: #888; font-size: 13px;">No classes scheduled for today (${todayDayName} EST).</p>
                            <p style="color: #666; font-size: 12px; margin-top: 10px;">Check the Calendar or My Classes tab for your schedule.</p>
                        </div>
                    `;
                    return;
                }
                
                // Load attendance data for today's classes
                const allAttendanceData = {};
                for (const cls of todaysClasses) {
                    const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', cls.id).get();
                    allAttendanceData[cls.id] = {};
                    attendanceSnap.docs.forEach(doc => {
                        const data = doc.data();
                        allAttendanceData[cls.id][`${data.studentId}_${data.week}`] = data.status;
                    });
                }
                
                container.innerHTML = todaysClasses.map(c => renderClassCardForToday(c, allAttendanceData)).join('');
                
            } catch (e) { 
                console.error(e); 
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">Error loading today\'s classes.</p>';
            }
        }
        
        // Load Completed Classes Tab
        let completedClassesFilterDays = '7'; // Default to 7 days
        let allCompletedClasses = []; // Store all completed classes for filtering
        
        async function loadTeacherCompletedClasses() {
            if (!currentUser) return;
            const container = document.getElementById('teacherCompletedClassesContainer');
            if (!container) return;
            
            try {
                const snap = await db.collection('scheduler_classes')
                    .where('teacherId', '==', currentUser.odId)
                    .where('status', '==', 'completed')
                    .get();
                    
                allCompletedClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Apply the current filter
                renderFilteredCompletedClasses();
                
            } catch (e) { 
                console.error(e); 
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">Error loading completed classes.</p>';
            }
        }
        
        function filterCompletedClasses(days) {
            completedClassesFilterDays = days;
            
            // Update active button
            document.querySelectorAll('.completed-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.days === days) {
                    btn.classList.add('active');
                }
            });
            
            renderFilteredCompletedClasses();
        }
        
        function renderFilteredCompletedClasses() {
            const container = document.getElementById('teacherCompletedClassesContainer');
            if (!container) return;
            
            let filteredClasses = allCompletedClasses;
            
            // Apply date filter based on completedAt timestamp
            if (completedClassesFilterDays !== 'all') {
                const daysAgo = parseInt(completedClassesFilterDays);
                const cutoffDate = getESTDate();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                cutoffDate.setHours(0, 0, 0, 0);
                
                filteredClasses = allCompletedClasses.filter(c => {
                    if (!c.completedAt) return false;
                    const completedDate = c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt);
                    return completedDate >= cutoffDate;
                });
            }
            
            if (filteredClasses.length === 0) {
                const filterLabel = completedClassesFilterDays === 'all' ? '' : ` in the last ${completedClassesFilterDays} days`;
                container.innerHTML = `<p style="color: #888; font-size: 12px;">No completed classes${filterLabel}.</p>`;
                return;
            }
            
            // Sort by completedAt (most recent first)
            filteredClasses.sort((a, b) => {
                const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt || 0);
                const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt || 0);
                return dateB - dateA;
            });
            
            container.innerHTML = filteredClasses.map(c => {
                const startDateDisplay = c.startDate ? parseESTDate(c.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                const completedDateDisplay = c.completedAt ? 
                    (c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt)).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 
                    'Unknown';
                
                return `
                    <div class="class-card completed-class">
                        <div class="class-header">
                            <div>
                                <div class="class-day">${c.day}</div>
                                <div class="class-time">${c.time} EST</div>
                                <div style="font-size: 11px; color: #888; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                                <div style="font-size: 11px; color: #39ff14; margin-top: 2px;">âœ… Completed: ${completedDateDisplay}</div>
                            </div>
                            <div style="text-align: right;">
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            </div>
                        </div>
                        
                        <h4 style="color: #ffff00; font-size: 13px; margin: 15px 0 10px 0;">1-Year Academy Status</h4>
                        <div style="display: grid; gap: 8px;">
                            ${(c.students || []).map(s => {
                                const academyStatus = c.academyStatus?.[s.id] || 'pending';
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                        <span style="color: #fff; font-size: 12px;">${s.name}</span>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-sm ${academyStatus === 'yes' ? 'btn-success' : ''}" onclick="setAcademyStatus('${c.id}', '${s.id}', 'yes')" style="font-size: 10px; padding: 4px 8px; ${academyStatus === 'yes' ? '' : 'opacity: 0.5;'}">âœ… Yes</button>
                                            <button class="btn btn-sm ${academyStatus === 'no' ? 'btn-danger' : ''}" onclick="setAcademyStatus('${c.id}', '${s.id}', 'no')" style="font-size: 10px; padding: 4px 8px; ${academyStatus === 'no' ? '' : 'opacity: 0.5;'}">âŒ No</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Helper function to render class card for Today tab
        function renderClassCardForToday(c, allAttendanceData) {
            // Helper functions
            function getClassWeekDates(cls, weekNum) {
                if (!cls.startDate) return null;
                const startDate = parseESTDate(cls.startDate);
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + (weekNum - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                return { start: weekStart, end: weekEnd };
            }
            
            function getClassCurrentWeek(cls) {
                if (!cls.startDate) return null;
                const startDate = parseESTDate(cls.startDate);
                const todayDate = getESTToday();
                if (todayDate < startDate) return 0;
                const daysSinceStart = getDaysBetween(todayDate, startDate);
                return Math.min(Math.floor(daysSinceStart / 7) + 1, 7);
            }
            
            function formatDateRange(start, end) {
                const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                return `${formatDate(start)}-${formatDate(end)}`;
            }
            
            function isWeekAttendanceComplete(cls, weekNum) {
                const students = cls.students || [];
                if (students.length === 0) return false;
                const classAttendance = allAttendanceData[cls.id] || {};
                return students.every(s => {
                    const key = `${s.id}_${weekNum}`;
                    return classAttendance[key] && ['present', 'late', 'absent'].includes(classAttendance[key]);
                });
            }
            
            function getAttendanceStatusForClass(classId, studentId, week) {
                const classAttendance = allAttendanceData[classId] || {};
                return classAttendance[`${studentId}_${week}`] || '';
            }
            
            const currentWeek = getClassCurrentWeek(c);
            const startDateDisplay = c.startDate ? new Date(c.startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
            
            // Build week tracker
            let weekTrackerHtml = '<div class="class-week-tracker">';
            for (let w = 1; w <= 6; w++) {
                const weekDates = getClassWeekDates(c, w);
                const dateRange = weekDates ? formatDateRange(weekDates.start, weekDates.end) : '';
                const isCompleted = isWeekAttendanceComplete(c, w) && currentWeek > w;
                const isCurrent = currentWeek === w;
                const isFuture = currentWeek < w;
                
                let weekClass = 'class-week-box';
                if (isCompleted) weekClass += ' completed';
                else if (isCurrent) weekClass += ' current';
                else if (isFuture) weekClass += ' future';
                
                weekTrackerHtml += `
                    <div class="${weekClass}">
                        <span class="week-label">Week ${w}</span>
                        <span class="week-dates">${dateRange}</span>
                    </div>
                `;
            }
            weekTrackerHtml += '</div>';
            
            const attendanceWeek = currentWeek > 0 && currentWeek <= 6 ? currentWeek : 1;
            
            return `
                <div class="class-card today-class">
                    <div class="class-header">
                        <div>
                            <div class="class-day">${c.day}</div>
                            <div class="class-time">${c.time} EST</div>
                            <div style="font-size: 11px; color: #00ffff; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                        </div>
                        <div style="text-align: right;">
                            <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            <div style="font-size: 11px; color: #39ff14; margin-top: 5px;">ðŸ“ TODAY</div>
                        </div>
                    </div>
                    
                    ${weekTrackerHtml}
                    
                    <div style="margin: 10px 0;">
                        <button class="btn btn-sm btn-info" onclick="showClassMaterial('${c.level}', ${attendanceWeek})" style="width: 100%;">ðŸ“– Show Material (Week ${attendanceWeek})</button>
                    </div>
                    
                    ${currentWeek >= 1 && currentWeek <= 6 ? `
                        <h4 style="color: #ffff00; font-size: 13px; margin: 10px 0;">Attendance - Week ${attendanceWeek}</h4>
                        <div style="display: grid; gap: 10px;">
                            ${(c.students || []).map(s => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                    <span style="cursor: pointer; text-decoration: underline; color: #00ffff;" onclick="openStudentAnalyticsMenu('${s.id}', '${s.name.replace(/'/g, "\\'")}', '${(s.email || '').replace(/'/g, "\\'")}')">${s.name}</span>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="attendance-btn present ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'present' ? 'active' : ''}" onclick="markAttendanceWithWeek('${c.id}', '${s.id}', 'present', ${attendanceWeek})">P</button>
                                        <button class="attendance-btn late ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'late' ? 'active' : ''}" onclick="markAttendanceWithWeek('${c.id}', '${s.id}', 'late', ${attendanceWeek})">L</button>
                                        <button class="attendance-btn absent ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'absent' ? 'active' : ''}" onclick="handleAbsentClickWithWeek('${c.id}', '${s.id}', '${s.name.replace(/'/g, "\\'")}', ${attendanceWeek})">A</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : currentWeek > 6 ? `
                        <div style="text-align: center; padding: 15px; background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px;">
                            <p style="color: #39ff14; font-size: 13px; margin: 0;">ðŸŽ“ Course Complete!</p>
                            <button class="btn btn-sm btn-success" onclick="markClassAsCompleted('${c.id}')" style="margin-top: 10px;">Move to Completed</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        let attendanceCache = {};

        function getAttendanceStatus(classId, studentId, week) {
            const key = `${classId}_${studentId}_${week}`;
            return attendanceCache[key] || '';
        }
        
        // Handle absent button click - show modal
        function handleAbsentClick(classId, studentId, studentName) {
            openAbsenceModal(classId, studentId, studentName);
        }

        async function markAttendance(classId, studentId, status) {
            const week = schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            attendanceCache[key] = status;

            try {
                console.log('Saving attendance:', { classId, studentId, week, status, key });
                await db.collection('scheduler_attendance').doc(key).set({ 
                    classId, 
                    studentId, 
                    week, 
                    status, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                }, { merge: true });
                console.log('Attendance saved successfully');
                loadTeacherClasses();
                
                // Check if all students marked in Week 6 (for reminder)
                if (week === 6 && currentUser?.role === 'teacher') {
                    checkClassAttendanceComplete(classId);
                }
            } catch (e) { 
                console.error('Error saving attendance:', e); 
                alert('Error saving attendance: ' + e.message);
            }
        }

        async function loadAttendanceHistory() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const tbody = document.getElementById('attendanceHistoryBody');
            if (!classId) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">Select a class</td></tr>'; return; }

            try {
                const classDoc = await db.collection('scheduler_classes').doc(classId).get();
                if (!classDoc.exists) return;
                const classData = classDoc.data();
                const students = classData.students || [];

                const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                const attendanceMap = {};
                attendanceSnap.docs.forEach(d => { const data = d.data(); attendanceMap[`${data.studentId}_${data.week}`] = data.status; });

                tbody.innerHTML = students.map(s => `
                    <tr>
                        <td>${s.name}</td>
                        ${[1,2,3,4,5,6].map(w => {
                            const status = attendanceMap[`${s.id}_${w}`] || '-';
                            const cls = status === 'present' ? 'history-present' : status === 'late' ? 'history-late' : status === 'absent' ? 'history-absent' : '';
                            return `<td class="${cls}" style="text-align: center;">${status === 'present' ? 'P' : status === 'late' ? 'L' : status === 'absent' ? 'A' : '-'}</td>`;
                        }).join('')}
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        // ==================== SCHEDULE RENDERING ====================
        
        function renderAdminSchedule() {
            const grid = document.getElementById('adminScheduleGrid');
            const totalSlots = TIME_SLOTS.length * DAYS.length;
            
            // Filter to only active classes (not completed)
            const activeClassList = allClasses.filter(c => c.status !== 'completed');
            
            // Build a map of classes by day and time
            const classMap = {};
            DAYS.forEach(day => {
                classMap[day] = {};
                TIME_SLOTS.forEach(time => {
                    classMap[day][time] = [];
                });
            });
            
            // Populate the map with active classes only
            activeClassList.forEach(cls => {
                if (classMap[cls.day] && classMap[cls.day][cls.time]) {
                    classMap[cls.day][cls.time].push(cls);
                }
            });
            
            // Calculate stats (only for active classes)
            let activeClasses = 0;
            let needsTeacher = 0;
            let fullClasses = 0;
            let emptySlots = 0;
            let totalAvailableSpots = 0;
            
            activeClassList.forEach(cls => {
                const studentCount = (cls.students || []).length;
                const spotsLeft = schedulerSettings.maxStudents - studentCount;
                
                if (cls.teacherId) {
                    activeClasses++;
                } else {
                    needsTeacher++;
                }
                
                if (studentCount >= schedulerSettings.maxStudents) {
                    fullClasses++;
                } else {
                    totalAvailableSpots += spotsLeft;
                }
            });
            
            // Count empty slots
            DAYS.forEach(day => {
                TIME_SLOTS.forEach(time => {
                    if (classMap[day][time].length === 0) {
                        emptySlots++;
                    }
                });
            });
            
            // Update summary stats
            document.getElementById('schedTotalSlots').textContent = totalSlots;
            document.getElementById('schedActiveClasses').textContent = activeClasses;
            document.getElementById('schedNeedsTeacher').textContent = needsTeacher;
            document.getElementById('schedFullClasses').textContent = fullClasses;
            document.getElementById('schedEmptySlots').textContent = emptySlots;
            document.getElementById('schedAvailableSpots').textContent = totalAvailableSpots;
            
            // Get current week dates for schedule header
            const weekDates = getWeekDates(schedulerSettings.currentWeek);
            let satDate = '', sunDate = '';
            if (weekDates) {
                const start = weekDates.start;
                const satOffset = (6 - start.getDay() + 7) % 7;
                const sat = new Date(start);
                sat.setDate(start.getDate() + satOffset);
                const sun = new Date(sat);
                sun.setDate(sat.getDate() + 1);
                satDate = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                sunDate = sun.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            // Build the grid HTML
            let html = '';
            
            // Header row with dates
            html += '<div class="schedule-header">TIME (EST)</div>';
            DAYS.forEach(day => {
                const dateStr = day === 'Saturday' ? satDate : sunDate;
                html += `<div class="schedule-header">${day.toUpperCase()}${dateStr ? `<br><span style="font-size: 11px; color: #ffff00;">${dateStr}</span>` : ''}</div>`;
            });
            
            // Time rows
            TIME_SLOTS.forEach(time => {
                html += `<div class="schedule-time">${time}</div>`;
                
                DAYS.forEach(day => {
                    const classes = classMap[day][time];
                    let cellClass = 'schedule-cell';
                    
                    if (classes.length === 0) {
                        cellClass += ' empty';
                        html += `<div class="${cellClass}"><div style="color: #666; font-size: 11px; text-align: center;">No class</div></div>`;
                    } else {
                        html += `<div class="${cellClass} has-class">`;
                        
                        classes.forEach(cls => {
                            const teacher = allTeachers.find(t => t.id === cls.teacherId);
                            const studentCount = (cls.students || []).length;
                            const isFull = studentCount >= schedulerSettings.maxStudents;
                            const needsTeacherFlag = !cls.teacherId;
                            
                            let blockClass = 'schedule-class-block clickable';
                            if (isFull) blockClass += ' full';
                            else if (needsTeacherFlag) blockClass += ' no-teacher';
                            
                            html += `
                                <div class="${blockClass}" onclick="openClassDetails('${cls.id}')">
                                    <div class="schedule-class-level">${LEVELS[cls.level]}</div>
                                    <div class="schedule-class-students">ðŸ‘¥ ${studentCount}/${schedulerSettings.maxStudents}</div>
                                    <div class="schedule-class-info">${isFull ? 'ðŸ”´ FULL' : `ðŸŸ¢ ${schedulerSettings.maxStudents - studentCount} spots`}</div>
                                    ${teacher 
                                        ? `<div class="schedule-class-teacher">ðŸ‘¨â€ðŸ« ${teacher.name}</div>` 
                                        : `<div style="color: #ffff00; font-size: 11px;">âš ï¸ No teacher</div>`
                                    }
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    }
                });
            });
            
            grid.innerHTML = html;
        }
        
        function renderTeacherSchedule() {
            const grid = document.getElementById('teacherScheduleGrid');
            const classes = allClassesForTeacher || [];
            
            // Build a map of classes by day and time
            const classMap = {};
            DAYS.forEach(day => {
                classMap[day] = {};
                TIME_SLOTS.forEach(time => {
                    classMap[day][time] = null;
                });
            });
            
            // Find teacher's active classes (not completed)
            const myClasses = classes.filter(c => c.teacherId === currentUser.odId && c.status !== 'completed');
            
            myClasses.forEach(cls => {
                if (classMap[cls.day]) {
                    classMap[cls.day][cls.time] = cls;
                }
            });
            
            // Calculate stats
            let totalStudents = 0;
            let fullClasses = 0;
            let availableSpots = 0;
            
            myClasses.forEach(cls => {
                const studentCount = (cls.students || []).length;
                totalStudents += studentCount;
                
                if (studentCount >= schedulerSettings.maxStudents) {
                    fullClasses++;
                } else {
                    availableSpots += (schedulerSettings.maxStudents - studentCount);
                }
            });
            
            // Update summary stats
            document.getElementById('teacherTotalClasses').textContent = myClasses.length;
            document.getElementById('teacherTotalStudents').textContent = totalStudents;
            document.getElementById('teacherFullClasses').textContent = fullClasses;
            document.getElementById('teacherAvailableSpots').textContent = availableSpots;
            
            // Get current week dates for schedule header
            const weekDates = getWeekDates(schedulerSettings.currentWeek);
            let satDate = '', sunDate = '';
            if (weekDates) {
                const start = weekDates.start;
                const satOffset = (6 - start.getDay() + 7) % 7;
                const sat = new Date(start);
                sat.setDate(start.getDate() + satOffset);
                const sun = new Date(sat);
                sun.setDate(sat.getDate() + 1);
                satDate = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                sunDate = sun.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            // Build the grid HTML
            let html = '';
            
            // Header row with dates
            html += '<div class="schedule-header">TIME (EST)</div>';
            DAYS.forEach(day => {
                const dateStr = day === 'Saturday' ? satDate : sunDate;
                html += `<div class="schedule-header">${day.toUpperCase()}${dateStr ? `<br><span style="font-size: 11px; color: #ffff00;">${dateStr}</span>` : ''}</div>`;
            });
            
            // Time rows
            TIME_SLOTS.forEach(time => {
                html += `<div class="schedule-time">${time}</div>`;
                
                DAYS.forEach(day => {
                    const cls = classMap[day][time];
                    let cellClass = 'schedule-cell';
                    
                    if (!cls) {
                        cellClass += ' empty';
                        html += `<div class="${cellClass}"><div style="color: #666; font-size: 11px; text-align: center;">-</div></div>`;
                    } else {
                        const studentCount = (cls.students || []).length;
                        const isFull = studentCount >= schedulerSettings.maxStudents;
                        
                        cellClass += isFull ? ' full' : ' has-class';
                        
                        html += `
                            <div class="${cellClass}">
                                <div class="schedule-class-block clickable ${isFull ? 'full' : ''}" onclick="openClassDetails('${cls.id}')">
                                    <div class="schedule-class-level">${LEVELS[cls.level]}</div>
                                    <div class="schedule-class-students">ðŸ‘¥ ${studentCount}/${schedulerSettings.maxStudents}</div>
                                    <div class="schedule-class-info">${isFull ? 'ðŸ”´ FULL' : `ðŸŸ¢ ${schedulerSettings.maxStudents - studentCount} spots left`}</div>
                                </div>
                            </div>
                        `;
                    }
                });
            });
            
            grid.innerHTML = html;
        }

        // ==================== CLASS DETAILS MODAL ====================
        
        async function openClassDetails(classId) {
            const cls = allClasses.find(c => c.id === classId) || allClassesForTeacher.find(c => c.id === classId);
            if (!cls) return;
            
            const teacher = allTeachers.find(t => t.id === cls.teacherId);
            
            // Load attendance data for this class
            let attendanceMap = {};
            let contactedMap = {};
            try {
                const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                attendanceSnap.docs.forEach(d => {
                    const data = d.data();
                    attendanceMap[`${data.studentId}_${data.week}`] = { status: data.status, reason: data.reason || null };
                });
                
                // Load contacted status
                const contactedSnap = await db.collection('scheduler_contacted').where('classId', '==', classId).get();
                contactedSnap.docs.forEach(d => {
                    const data = d.data();
                    contactedMap[data.studentId] = data.contacted;
                });
            } catch (e) { console.error(e); }
            
            // Get full student data - for teachers, load directly from Firebase if allStudents is empty
            const studentIds = (cls.students || []).map(s => s.id);
            const fullStudentData = {};
            
            // First try to get from allStudents (admin/support)
            for (const sid of studentIds) {
                const studentDoc = allStudents.find(s => s.id === sid);
                if (studentDoc) {
                    fullStudentData[sid] = studentDoc;
                }
            }
            
            // For teachers or if allStudents is empty, load directly from Firebase
            if (Object.keys(fullStudentData).length < studentIds.length) {
                try {
                    for (const sid of studentIds) {
                        if (!fullStudentData[sid]) {
                            const studentDoc = await db.collection('scheduler_students').doc(sid).get();
                            if (studentDoc.exists) {
                                fullStudentData[sid] = { id: studentDoc.id, ...studentDoc.data() };
                            } else {
                                // Fallback to embedded student data from class
                                const embeddedStudent = cls.students.find(s => s.id === sid);
                                if (embeddedStudent) {
                                    fullStudentData[sid] = embeddedStudent;
                                }
                            }
                        }
                    }
                } catch (e) { 
                    console.error('Error loading student data:', e);
                    // Use embedded student data as fallback
                    for (const student of (cls.students || [])) {
                        if (!fullStudentData[student.id]) {
                            fullStudentData[student.id] = student;
                        }
                    }
                }
            }
            
            // Format start date for display
            const startDateDisplay = cls.startDate ? new Date(cls.startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
            
            // Header
            document.getElementById('classDetailsHeader').innerHTML = `
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="color: #ffff00; font-size: 14px;">${cls.day} @ ${cls.time} EST</div>
                        <div style="color: #00ffff; font-size: 12px; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                        <span class="level-badge level-${cls.level}">${LEVELS[cls.level]}</span>
                    </div>
                    <div style="text-align: right;">
                        ${teacher ? `<div style="color: #39ff14; font-size: 13px;">ðŸ‘¨â€ðŸ« ${teacher.name}</div>` : '<div style="color: #ff3366; font-size: 13px;">âš ï¸ No teacher assigned</div>'}
                        <div style="color: #888; font-size: 12px;">ðŸ‘¥ ${(cls.students || []).length} students</div>
                    </div>
                </div>
            `;
            
            // Students list
            let studentsHtml = '';
            for (const student of (cls.students || [])) {
                const fullData = fullStudentData[student.id] || {};
                const phone = fullData.phone || '';
                
                // Check if student has any absences
                let hasAbsence = false;
                let absenceWeeks = [];
                for (let w = 1; w <= 6; w++) {
                    const att = attendanceMap[`${student.id}_${w}`];
                    if (att && att.status === 'absent') {
                        hasAbsence = true;
                        absenceWeeks.push(w);
                    }
                }
                
                const isContacted = contactedMap[student.id] || false;
                
                studentsHtml += `
                    <div class="student-detail-row ${hasAbsence ? 'absent-student' : ''}">
                        <div class="student-detail-header">
                            <div class="student-detail-name" style="cursor: pointer; text-decoration: underline;" onclick="closeClassDetailsModal(); openStudentAnalyticsMenu('${student.id}', '${student.name.replace(/'/g, "\\'")}', '${(fullData.email || '').replace(/'/g, "\\'")}')">${student.name}</div>
                            <div class="rank-dot rank-${student.rank}" style="width: 12px; height: 12px;" title="Preference #${student.rank}"></div>
                        </div>
                        <div class="student-detail-info">ðŸ“§ ${fullData.email || 'N/A'} | ðŸŒ ${fullData.timezone || 'N/A'}</div>
                        
                        <div class="student-detail-attendance">
                            ${[1,2,3,4,5,6].map(w => {
                                const att = attendanceMap[`${student.id}_${w}`];
                                const status = att?.status || '';
                                const reason = att?.reason || '';
                                let cls = 'attendance-week';
                                let text = `W${w}: -`;
                                if (status === 'present') { cls += ' present'; text = `W${w}: P`; }
                                else if (status === 'late') { cls += ' late'; text = `W${w}: L`; }
                                else if (status === 'absent') { cls += ' absent'; text = `W${w}: A`; }
                                return `<span class="${cls}" title="${reason ? 'Reason: ' + reason : 'No reason'}">${text}</span>`;
                            }).join('')}
                        </div>
                        
                        ${hasAbsence ? `
                            <div class="student-detail-phone ${hasAbsence ? 'visible' : ''}">
                                ðŸ“ž ${phone ? `<a href="tel:${phone}">${phone}</a>` : 'No phone number'}
                            </div>
                            ${absenceWeeks.map(w => {
                                const att = attendanceMap[`${student.id}_${w}`];
                                return att?.reason ? `<div class="absence-reason-display">Week ${w} reason: ${att.reason}</div>` : `<div class="absence-reason-display" style="color: #ff3366;">Week ${w}: No reason given</div>`;
                            }).join('')}
                            <div class="contacted-row ${hasAbsence ? 'visible' : ''}">
                                <label class="contacted-checkbox">
                                    <input type="checkbox" ${isContacted ? 'checked' : ''} onchange="markStudentContacted('${classId}', '${student.id}', this.checked)">
                                    <span>âœ… Student has been contacted</span>
                                </label>
                            </div>
                        ` : ''}
                        
                        ${(currentUser?.role === 'admin' || currentUser?.role === 'support') ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                <button class="btn btn-sm btn-warning" onclick="closeClassDetailsModal(); openMoveStudentModal('${student.id}', '${student.name}', '${classId}')">ðŸ”„ Move Student</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            document.getElementById('classStudentsList').innerHTML = studentsHtml || '<p style="color: #888; font-size: 12px;">No students in this class.</p>';
            document.getElementById('classDetailsModal').classList.add('active');
        }
        
        function closeClassDetailsModal() {
            document.getElementById('classDetailsModal').classList.remove('active');
        }
        
        async function markStudentContacted(classId, studentId, contacted) {
            try {
                await db.collection('scheduler_contacted').doc(`${classId}_${studentId}`).set({
                    classId,
                    studentId,
                    contacted,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (e) { console.error(e); }
        }

        // ==================== ABSENCE REASON MODAL ====================
        
        function openAbsenceModal(classId, studentId, studentName) {
            document.getElementById('absenceClassId').value = classId;
            document.getElementById('absenceStudentId').value = studentId;
            document.getElementById('absenceStudentName').textContent = studentName;
            document.getElementById('absenceReasonForm').style.display = 'none';
            document.getElementById('absenceSubmitBtn').style.display = 'none';
            document.getElementById('absenceReasonText').value = '';
            document.getElementById('absenceModal').classList.add('active');
        }
        
        function closeAbsenceModal() {
            document.getElementById('absenceModal').classList.remove('active');
            window.currentAbsenceWeek = null;
        }
        
        // Edit Start Date Modal Functions
        function openEditStartDateModal(classId, currentStartDate, day, time, level) {
            document.getElementById('editStartDateClassId').value = classId;
            document.getElementById('editStartDateInput').value = currentStartDate || '';
            document.getElementById('editStartDateClassInfo').innerHTML = `
                <div style="color: #ffff00; font-size: 13px; margin-bottom: 5px;">${day} @ ${time} EST</div>
                <span class="level-badge level-${level}">${LEVELS[level]}</span>
            `;
            document.getElementById('editStartDateMessage').innerHTML = '';
            document.getElementById('editStartDateModal').classList.add('active');
        }
        
        function closeEditStartDateModal() {
            document.getElementById('editStartDateModal').classList.remove('active');
        }
        
        async function saveClassStartDate() {
            const classId = document.getElementById('editStartDateClassId').value;
            const newStartDate = document.getElementById('editStartDateInput').value;
            
            if (!newStartDate) {
                document.getElementById('editStartDateMessage').innerHTML = '<p class="message error">Please select a date.</p>';
                return;
            }
            
            try {
                await db.collection('scheduler_classes').doc(classId).update({
                    startDate: newStartDate
                });
                
                // Update local data
                const classIndex = allClasses.findIndex(c => c.id === classId);
                if (classIndex !== -1) {
                    allClasses[classIndex].startDate = newStartDate;
                }
                
                closeEditStartDateModal();
                renderClasses();
                renderMonthlyCalendar();
                renderTeacherCalendar();
                
                // Show success message briefly
                alert('Start date updated successfully!');
            } catch (e) {
                console.error('Error saving start date:', e);
                document.getElementById('editStartDateMessage').innerHTML = `<p class="message error">Error: ${e.message}</p>`;
            }
        }
        
        function showAbsenceReasonForm() {
            document.getElementById('absenceReasonForm').style.display = 'block';
            document.getElementById('absenceSubmitBtn').style.display = 'block';
        }
        
        async function markAbsentNoReason() {
            const classId = document.getElementById('absenceClassId').value;
            const studentId = document.getElementById('absenceStudentId').value;
            const week = window.currentAbsenceWeek || schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            
            try {
                await db.collection('scheduler_attendance').doc(key).set({
                    classId,
                    studentId,
                    week,
                    status: 'absent',
                    reason: null,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                attendanceCache[key] = 'absent';
                closeAbsenceModal();
                
                // Check if Week 6 is complete
                if (week === 6) {
                    await checkWeek6Complete(classId);
                }
                
                loadTeacherClasses();
            } catch (e) { console.error(e); }
        }
        
        async function submitAbsenceWithReason() {
            const classId = document.getElementById('absenceClassId').value;
            const studentId = document.getElementById('absenceStudentId').value;
            const reason = document.getElementById('absenceReasonText').value.trim();
            const week = window.currentAbsenceWeek || schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            
            if (!reason) {
                alert('Please enter the reason for absence.');
                return;
            }
            
            try {
                await db.collection('scheduler_attendance').doc(key).set({
                    classId,
                    studentId,
                    week,
                    status: 'absent',
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                attendanceCache[key] = 'absent';
                closeAbsenceModal();
                
                // Check if Week 6 is complete
                if (week === 6) {
                    await checkWeek6Complete(classId);
                }
                
                loadTeacherClasses();
            } catch (e) { console.error(e); }
        }

        // ==================== ABSENCES LIST ====================
        
        let allAbsencesData = [];
        
        async function loadAbsencesList() {
            const container = document.getElementById('absencesListContainer');
            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading absences...</p>';
            
            const weekFilter = document.getElementById('absenceWeekFilter').value;
            
            try {
                // Get all attendance records marked as absent
                let query = db.collection('scheduler_attendance').where('status', '==', 'absent');
                
                if (weekFilter !== 'all') {
                    query = query.where('week', '==', parseInt(weekFilter));
                }
                
                const attendanceSnap = await query.get();
                
                if (attendanceSnap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No absences found.</p>';
                    updateAbsenceStats(0, 0, 0);
                    return;
                }
                
                // Get contacted statuses
                const contactedSnap = await db.collection('scheduler_contacted').get();
                const contactedMap = {};
                contactedSnap.docs.forEach(d => {
                    const data = d.data();
                    contactedMap[data.studentId] = data.contacted;
                });
                
                // Build the absences data
                allAbsencesData = [];
                
                for (const doc of attendanceSnap.docs) {
                    const data = doc.data();
                    
                    // Get student info
                    const student = allStudents.find(s => s.id === data.studentId);
                    
                    // Get class info
                    const cls = allClasses.find(c => c.id === data.classId);
                    
                    if (student && cls) {
                        allAbsencesData.push({
                            id: doc.id,
                            studentId: data.studentId,
                            classId: data.classId,
                            week: data.week,
                            reason: data.reason || null,
                            studentName: student.name,
                            studentEmail: student.email,
                            studentPhone: student.phone || '',
                            studentDiscord: student.discord || '',
                            classDay: cls.day,
                            classTime: cls.time,
                            classLevel: cls.level,
                            contacted: contactedMap[data.studentId] || false,
                            timestamp: data.timestamp
                        });
                    }
                }
                
                // Sort by week (descending), then by student name
                allAbsencesData.sort((a, b) => {
                    if (b.week !== a.week) return b.week - a.week;
                    return a.studentName.localeCompare(b.studentName);
                });
                
                renderAbsencesList();
                
            } catch (e) { 
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
            }
        }
        
        function renderAbsencesList() {
            const container = document.getElementById('absencesListContainer');
            const contactFilter = document.getElementById('absenceContactFilter').value;
            
            let filteredData = allAbsencesData;
            
            if (contactFilter === 'contacted') {
                filteredData = allAbsencesData.filter(a => a.contacted);
            } else if (contactFilter === 'not-contacted') {
                filteredData = allAbsencesData.filter(a => !a.contacted);
            }
            
            // Update stats
            const totalAbsences = allAbsencesData.length;
            const contactedCount = allAbsencesData.filter(a => a.contacted).length;
            const notContactedCount = allAbsencesData.filter(a => !a.contacted).length;
            updateAbsenceStats(totalAbsences, contactedCount, notContactedCount);
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No absences match the current filter.</p>';
                return;
            }
            
            container.innerHTML = filteredData.map(a => `
                <div class="absence-item ${a.contacted ? 'contacted' : 'not-contacted'}">
                    <div class="absence-item-info">
                        <div class="absence-item-name">${a.studentName}</div>
                        <div class="absence-item-details">ðŸ“§ ${a.studentEmail}</div>
                        <div class="absence-item-class">ðŸ“š ${a.classDay} @ ${a.classTime} EST - ${LEVELS[a.classLevel]}</div>
                        ${a.reason ? `<div class="absence-item-reason">ðŸ’¬ "${a.reason}"</div>` : '<div class="absence-item-reason" style="color: #ff3366;">âš ï¸ No reason given</div>'}
                        ${a.studentPhone ? `<div class="absence-item-phone">ðŸ“ž <a href="tel:${a.studentPhone}">${a.studentPhone}</a></div>` : '<div class="absence-item-phone" style="color: #888;">ðŸ“ž No phone</div>'}
                        ${a.studentDiscord ? `<div class="absence-item-phone" style="color: #7289da;">ðŸŽ® ${a.studentDiscord}</div>` : '<div class="absence-item-phone" style="color: #888;">ðŸŽ® No Discord</div>'}
                    </div>
                    <div class="absence-item-status">
                        <div class="absence-week-badge">Week ${a.week}</div>
                        <div class="absence-status-badge ${a.contacted ? 'contacted' : 'not-contacted'}">
                            ${a.contacted ? 'âœ… CONTACTED' : 'âŒ NOT CONTACTED'}
                        </div>
                        <label class="contacted-checkbox" style="margin-top: 5px;">
                            <input type="checkbox" ${a.contacted ? 'checked' : ''} onchange="updateAbsenceContacted('${a.classId}', '${a.studentId}', this.checked)">
                            <span style="font-size: 11px;">Mark contacted</span>
                        </label>
                    </div>
                </div>
            `).join('');
        }
        
        function filterAbsencesList() {
            renderAbsencesList();
        }
        
        function updateAbsenceStats(total, contacted, notContacted) {
            document.getElementById('absenceTotalCount').textContent = total;
            document.getElementById('absenceContactedCount').textContent = contacted;
            document.getElementById('absenceNotContactedCount').textContent = notContacted;
        }
        
        async function updateAbsenceContacted(classId, studentId, contacted) {
            try {
                await db.collection('scheduler_contacted').doc(`${classId}_${studentId}`).set({
                    classId,
                    studentId,
                    contacted,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Update local data
                allAbsencesData.forEach(a => {
                    if (a.studentId === studentId) {
                        a.contacted = contacted;
                    }
                });
                
                renderAbsencesList();
            } catch (e) { console.error(e); }
        }

        // ==================== MONTHLY CALENDAR ====================
        
        let calendarMonth = getESTMonth();
        let calendarYear = getESTYear();
        
        function changeCalendarMonth(delta) {
            calendarMonth += delta;
            if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
            if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
            renderMonthlyCalendar();
            renderTeacherCalendar();
        }
        
        function renderMonthlyCalendar() {
            const grid = document.getElementById('monthlyCalendarGrid');
            const label = document.getElementById('calendarMonthLabel');
            if (!grid || !label) return;
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[calendarMonth]} ${calendarYear} (EST)`;
            
            const today = getESTToday();
            
            // Course dates
            let courseStart = null, courseEnd = null;
            if (schedulerSettings.startDate) {
                courseStart = parseESTDate(schedulerSettings.startDate);
                courseEnd = getCourseEndDate();
            }
            
            // Get first day of month and number of days
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Build class schedule map for quick lookup
            const classDays = {};
            allClasses.filter(c => c.status !== 'completed').forEach(cls => {
                // For each week of the course, calculate the actual date
                for (let week = 1; week <= 6; week++) {
                    const weekDates = getWeekDates(week);
                    if (!weekDates) continue;
                    
                    const dayOffset = cls.day === 'Saturday' ? 6 : 0;
                    const classDate = new Date(weekDates.start);
                    classDate.setDate(weekDates.start.getDate() + ((dayOffset - weekDates.start.getDay() + 7) % 7));
                    
                    const dateKey = `${classDate.getFullYear()}-${classDate.getMonth()}-${classDate.getDate()}`;
                    if (!classDays[dateKey]) classDays[dateKey] = [];
                    classDays[dateKey].push({ ...cls, week });
                }
            });
            
            // Store in global map for click handling
            calendarClassMap = { ...calendarClassMap, ...classDays };
            
            let html = '';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            // Previous month days
            const prevMonth = new Date(calendarYear, calendarMonth, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(calendarYear, calendarMonth, day);
                const dateKey = `${calendarYear}-${calendarMonth}-${day}`;
                const dayClasses = classDays[dateKey] || [];
                
                let classes = ['calendar-day'];
                if (currentDate.getTime() === today.getTime()) classes.push('today');
                if (courseStart && currentDate.getTime() === courseStart.getTime()) classes.push('course-start');
                if (courseEnd && currentDate.getTime() === courseEnd.getTime()) classes.push('course-end');
                if (dayClasses.length > 0) classes.push('has-class');
                
                // Find which week this falls in
                let weekNum = '';
                if (courseStart && currentDate >= courseStart && currentDate <= courseEnd) {
                    const diffDays = Math.floor((currentDate - courseStart) / (1000 * 60 * 60 * 24));
                    weekNum = `W${Math.floor(diffDays / 7) + 1}`;
                }
                
                // Make clickable if has classes
                const clickHandler = dayClasses.length > 0 ? `onclick="openCalendarDayClasses('${dateKey}')"` : '';
                
                html += `<div class="${classes.join(' ')}" ${clickHandler}>
                    <div class="calendar-day-number">${day}</div>
                    ${weekNum ? `<div class="calendar-week-label">${weekNum}</div>` : ''}
                    ${dayClasses.length > 0 ? `
                        <div>
                            ${dayClasses.map(c => `<span class="calendar-class-dot" style="background: ${getLevelColor(c.level)};" title="${LEVELS[c.level]} - ${c.time}" onclick="event.stopPropagation(); openClassDetails('${c.id}')"></span>`).join('')}
                        </div>
                        <div class="calendar-class-info">${dayClasses.length} class${dayClasses.length > 1 ? 'es' : ''}</div>
                    ` : ''}
                </div>`;
            }
            
            // Next month days
            const remainingCells = 42 - (startDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function getLevelColor(level) {
            const colors = { absolute: '#ff3366', novice: '#ff9900', beginner: '#ffff00', advanced: '#39ff14' };
            return colors[level] || '#888';
        }
        
        // Store calendar class data for click handling
        let calendarClassMap = {};
        
        function openCalendarDayClasses(dateKey) {
            // If only one class on this day, open its details directly
            const dayClasses = calendarClassMap[dateKey] || [];
            if (dayClasses.length === 1) {
                openClassDetails(dayClasses[0].id);
            } else if (dayClasses.length > 1) {
                // Show modal with clickable class options
                const container = document.getElementById('calendarClassPickerList');
                container.innerHTML = dayClasses.map(c => {
                    const teacher = allTeachers.find(t => t.id === c.teacherId);
                    return `
                        <div class="calendar-class-option" onclick="closeCalendarClassPicker(); openClassDetails('${c.id}');" style="padding: 12px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #00ffff; font-size: 14px; margin-bottom: 5px;">${c.time}</div>
                                    <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: #888;">Week ${c.week || '-'}</div>
                                    ${teacher ? `<div style="font-size: 11px; color: #39ff14;">ðŸ‘¨â€ðŸ« ${teacher.name}</div>` : ''}
                                    <div style="font-size: 11px; color: #ffff00;">${(c.students || []).length} students</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('calendarClassPickerModal').classList.add('active');
            }
        }
        
        function closeCalendarClassPicker() {
            document.getElementById('calendarClassPickerModal').classList.remove('active');
        }

        // ==================== COMPLETED STUDENTS ====================
        
        async function loadCompletedStudents() {
            const container = document.getElementById('completedStudentsContainer');
            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading completed students...</p>';
            
            try {
                const completedStudents = allStudents.filter(s => s.status === 'completed');
                
                if (completedStudents.length === 0) {
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No completed students yet.</p>';
                    updateCompletedStats(0, 0, 0, 0);
                    return;
                }
                
                // Get community status for each student
                const communitySnap = await db.collection('scheduler_community').get();
                const communityMap = {};
                communitySnap.docs.forEach(d => {
                    communityMap[d.id] = d.data().status;
                });
                
                const total = completedStudents.length;
                const joined = completedStudents.filter(s => communityMap[s.id] === 'joined').length;
                const notInterested = completedStudents.filter(s => communityMap[s.id] === 'not-interested').length;
                const pending = total - joined - notInterested;
                
                updateCompletedStats(total, joined, notInterested, pending);
                
                const isAdmin = currentUser?.role === 'admin';
                
                container.innerHTML = completedStudents.map(s => {
                    const status = communityMap[s.id] || 'pending';
                    const cls = allClasses.find(c => c.id === s.classId);
                    
                    return `
                        <div class="completed-item ${status}">
                            <div class="completed-item-info">
                                <div class="completed-item-name">${s.name}</div>
                                <div class="completed-item-details">ðŸ“§ ${s.email} | ðŸ“ž ${s.phone || 'No phone'}</div>
                                ${cls ? `<div class="completed-item-class">ðŸ“š ${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}</div>` : ''}
                            </div>
                            <div class="completed-item-actions">
                                ${status === 'pending' ? `
                                    <button class="community-btn join" onclick="setCommunityStatus('${s.id}', 'joined')">âœ“ Joined</button>
                                    <button class="community-btn not-interested" onclick="setCommunityStatus('${s.id}', 'not-interested')">âœ— Not Interested</button>
                                ` : `
                                    <div class="community-status ${status}">${status === 'joined' ? 'âœ… JOINED COMMUNITY' : 'âŒ NOT INTERESTED'}</div>
                                    <button class="btn btn-sm btn-secondary" onclick="setCommunityStatus('${s.id}', 'pending')">Reset</button>
                                `}
                                ${canDelete() ? `<button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteCompletedStudent('${s.id}')" style="margin-left: 5px;">ðŸ—‘ï¸</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) { 
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
            }
        }
        
        function updateCompletedStats(total, joined, notInterested, pending) {
            document.getElementById('completedTotalCount').textContent = total;
            document.getElementById('completedJoinedCount').textContent = joined;
            document.getElementById('completedNotInterestedCount').textContent = notInterested;
            document.getElementById('completedPendingCount').textContent = pending;
        }
        
        async function setCommunityStatus(studentId, status) {
            try {
                await db.collection('scheduler_community').doc(studentId).set({
                    studentId,
                    status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadCompletedStudents();
            } catch (e) { console.error(e); }
        }
        
        async function deleteCompletedStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) return;
            
            try {
                // Delete from scheduler_students
                await db.collection('scheduler_students').doc(studentId).delete();
                
                // Delete from scheduler_community
                await db.collection('scheduler_community').doc(studentId).delete();
                
                // Remove from local array
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) allStudents.splice(idx, 1);
                
                loadCompletedStudents();
                updateDashboardStats();
                alert('Student deleted successfully.');
            } catch (e) { 
                console.error(e);
                alert('Error deleting student: ' + e.message);
            }
        }
        
        // ==================== ADMIN COMPLETED CLASSES ====================
        
        let adminCompletedFilterDays = '7';
        let allAdminCompletedClasses = [];
        
        async function loadAdminCompletedClasses() {
            const container = document.getElementById('adminCompletedClassesContainer');
            if (!container) return;
            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading completed classes...</p>';
            
            try {
                // Get ALL completed classes (from all teachers)
                const snap = await db.collection('scheduler_classes')
                    .where('status', '==', 'completed')
                    .get();
                
                allAdminCompletedClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                renderAdminFilteredCompletedClasses();
            } catch (e) {
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
            }
        }
        
        function filterAdminCompletedClasses(days) {
            adminCompletedFilterDays = days;
            
            document.querySelectorAll('.admin-completed-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.days === days) {
                    btn.classList.add('active');
                }
            });
            
            renderAdminFilteredCompletedClasses();
        }
        
        function renderAdminFilteredCompletedClasses() {
            const container = document.getElementById('adminCompletedClassesContainer');
            if (!container) return;
            
            let filteredClasses = allAdminCompletedClasses;
            
            // Apply date filter
            if (adminCompletedFilterDays !== 'all') {
                const daysAgo = parseInt(adminCompletedFilterDays);
                const cutoffDate = getESTDate();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                cutoffDate.setHours(0, 0, 0, 0);
                
                filteredClasses = allAdminCompletedClasses.filter(c => {
                    if (!c.completedAt) return false;
                    const completedDate = c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt);
                    return completedDate >= cutoffDate;
                });
            }
            
            // Calculate stats
            let totalStudents = 0;
            let joinedCount = 0;
            let declinedCount = 0;
            let pendingCount = 0;
            
            filteredClasses.forEach(c => {
                const students = c.students || [];
                const academyStatus = c.academyStatus || {};
                students.forEach(s => {
                    totalStudents++;
                    const status = academyStatus[s.id];
                    if (status === 'yes') joinedCount++;
                    else if (status === 'no') declinedCount++;
                    else pendingCount++;
                });
            });
            
            updateCompletedStats(totalStudents, joinedCount, declinedCount, pendingCount);
            
            if (filteredClasses.length === 0) {
                const filterLabel = adminCompletedFilterDays === 'all' ? '' : ` in the last ${adminCompletedFilterDays} days`;
                container.innerHTML = `<p style="color: #888; font-size: 12px;">No completed classes${filterLabel}.</p>`;
                return;
            }
            
            // Sort by completedAt (most recent first)
            filteredClasses.sort((a, b) => {
                const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt || 0);
                const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt || 0);
                return dateB - dateA;
            });
            
            container.innerHTML = filteredClasses.map(c => {
                const teacher = allTeachers.find(t => t.id === c.teacherId);
                const teacherName = teacher ? teacher.name : 'Unknown Teacher';
                const startDateDisplay = c.startDate ? parseESTDate(c.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                const completedDateDisplay = c.completedAt ? 
                    (c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt)).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 
                    'Unknown';
                
                return `
                    <div class="class-card completed-class" style="margin-bottom: 15px;">
                        <div class="class-header">
                            <div>
                                <div class="class-day">${c.day}</div>
                                <div class="class-time">${c.time} EST</div>
                                <div style="font-size: 11px; color: #39ff14; margin-top: 3px;">ðŸ‘¨â€ðŸ« ${teacherName}</div>
                                <div style="font-size: 11px; color: #888; margin-top: 2px;">ðŸ“… Started: ${startDateDisplay}</div>
                                <div style="font-size: 11px; color: #00ffff; margin-top: 2px;">âœ… Completed: ${completedDateDisplay}</div>
                            </div>
                            <div style="text-align: right;">
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            </div>
                        </div>
                        
                        <h4 style="color: #ffff00; font-size: 13px; margin: 15px 0 10px 0;">1-Year Academy Status</h4>
                        <div style="display: grid; gap: 8px;">
                            ${(c.students || []).map(s => {
                                const academyStatus = c.academyStatus?.[s.id] || 'pending';
                                const statusDisplay = academyStatus === 'yes' ? 
                                    '<span style="color: #39ff14; font-size: 11px;">âœ… YES - Joined</span>' :
                                    academyStatus === 'no' ? 
                                    '<span style="color: #ff3366; font-size: 11px;">âŒ NO - Declined</span>' :
                                    '<span style="color: #ffff00; font-size: 11px;">â³ Pending</span>';
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                        <span style="cursor: pointer; text-decoration: underline; color: #00ffff; font-size: 12px;" onclick="openStudentAnalyticsMenu('${s.id}', '${s.name.replace(/'/g, "\\'")}', '${(s.email || '').replace(/'/g, "\\'")}')">${s.name}</span>
                                        ${statusDisplay}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== ADMIN TEACHER VIEW ====================
        
        let adminViewingTeacherId = null;
        let adminViewingTeacherClasses = [];
        
        function loadTeacherButtonsForAdmin() {
            const container = document.getElementById('teacherButtonsContainer');
            if (!container) return;
            
            if (allTeachers.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No teachers found. Add teachers in the Teachers tab.</p>';
                return;
            }
            
            container.innerHTML = allTeachers.map(t => `
                <button class="btn btn-sm teacher-select-btn ${adminViewingTeacherId === t.id ? 'active' : ''}" onclick="loadAdminTeacherView('${t.id}', '${t.name.replace(/'/g, "\\'")}')">${t.name}</button>
            `).join('');
        }
        
        async function loadAdminTeacherView(teacherId, teacherName) {
            adminViewingTeacherId = teacherId;
            
            // Update button states
            document.querySelectorAll('.teacher-select-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('adminViewingTeacherName').textContent = teacherName;
            document.getElementById('adminTeacherViewContainer').style.display = 'block';
            
            // Load teacher's classes
            try {
                const snap = await db.collection('scheduler_classes')
                    .where('teacherId', '==', teacherId)
                    .get();
                
                adminViewingTeacherClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Also store in allClassesForTeacher so openStudentAnalyticsMenu can find student emails
                allClassesForTeacher = adminViewingTeacherClasses;
                
                // Load attendance data
                const attendanceData = {};
                for (const cls of adminViewingTeacherClasses) {
                    const attendanceSnap = await db.collection('scheduler_attendance')
                        .where('classId', '==', cls.id)
                        .get();
                    attendanceData[cls.id] = {};
                    attendanceSnap.docs.forEach(doc => {
                        const data = doc.data();
                        attendanceData[cls.id][`${data.studentId}_${data.week}`] = data.status;
                    });
                }
                
                // Store attendance data for rendering
                window.adminTeacherAttendanceData = attendanceData;
                
                // Default to Today view
                switchAdminTeacherViewTab('today');
                
            } catch (e) {
                console.error(e);
                document.getElementById('adminTeacherTodayView').innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error loading classes: ${e.message}</p>`;
            }
        }
        
        function closeAdminTeacherView() {
            adminViewingTeacherId = null;
            document.getElementById('adminTeacherViewContainer').style.display = 'none';
            document.querySelectorAll('.teacher-select-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        function switchAdminTeacherViewTab(tab) {
            document.querySelectorAll('.admin-teacher-view-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) btn.classList.add('active');
            });
            
            document.getElementById('adminTeacherTodayView').style.display = tab === 'today' ? 'block' : 'none';
            document.getElementById('adminTeacherClassesView').style.display = tab === 'classes' ? 'block' : 'none';
            
            if (tab === 'today') {
                renderAdminTeacherTodayView();
            } else {
                renderAdminTeacherClassesView();
            }
        }
        
        function renderAdminTeacherTodayView() {
            const container = document.getElementById('adminTeacherTodayView');
            const activeClasses = adminViewingTeacherClasses.filter(c => c.status !== 'completed');
            
            const todayEST = getESTToday();
            const todayDayName = getESTDayName();
            
            const todaysClasses = activeClasses.filter(c => {
                if (!c.startDate) return false;
                const startDate = parseESTDate(c.startDate);
                return isDateOnOrAfter(todayEST, startDate) && c.day === todayDayName;
            });
            
            if (todaysClasses.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 40px; margin-bottom: 15px;">ðŸ“…</div>
                        <p style="color: #888; font-size: 13px;">No classes scheduled for today (${todayDayName} EST).</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = todaysClasses.map(c => renderAdminTeacherClassCard(c, true)).join('');
        }
        
        function renderAdminTeacherClassesView() {
            const container = document.getElementById('adminTeacherClassesView');
            const activeClasses = adminViewingTeacherClasses.filter(c => c.status !== 'completed');
            
            // Get prescheduled slots for this teacher
            const teacherPreschedules = allPrescheduledSlots.filter(ps => ps.teacherId === adminViewingTeacherId);
            
            if (activeClasses.length === 0 && teacherPreschedules.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No active classes for this teacher.</p>';
                return;
            }
            
            let html = '';
            
            // Show active classes first
            if (activeClasses.length > 0) {
                html += activeClasses.map(c => renderAdminTeacherClassCard(c, false)).join('');
            }
            
            // Show prescheduled classes at the bottom
            if (teacherPreschedules.length > 0) {
                html += '<div style="margin-top: 20px;"><h4 style="color: #ff9800; margin-bottom: 10px; font-size: 13px;">â³ Pre-scheduled Classes</h4>';
                html += teacherPreschedules.map(ps => {
                    const startDate = ps.startDate ? new Date(ps.startDate + 'T00:00:00') : null;
                    const startDateStr = startDate ? startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const classTypeName = LEVELS[ps.classType] || ps.classType || 'Class';
                    
                    // Calculate days until start
                    let daysUntilStart = '';
                    if (startDate) {
                        const now = new Date();
                        const diffTime = startDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysUntilStart = `(in ${diffDays} day${diffDays > 1 ? 's' : ''})`;
                        } else if (diffDays === 0) {
                            daysUntilStart = '(Today!)';
                        }
                    }
                    
                    return `
                        <div class="class-card" style="border: 2px solid #ff9800; background: rgba(255,152,0,0.1);">
                            <div class="class-header">
                                <div>
                                    <div class="class-day" style="color: #ff9800;">${ps.day}</div>
                                    <div class="class-time">${ps.time} EST</div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="level-badge level-${ps.classType}" style="border-color: #ff9800;">${classTypeName}</span>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 8px; margin-top: 10px;">
                                <div style="font-size: 24px; margin-bottom: 5px;">â³</div>
                                <p style="color: #ff9800; font-size: 14px; margin: 0; font-weight: bold;">Pre-scheduled</p>
                                <p style="color: #fff; font-size: 13px; margin: 5px 0;">Starts: ${startDateStr}</p>
                                <p style="color: #ffff00; font-size: 12px; margin: 0;">${daysUntilStart}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function renderAdminTeacherClassCard(c, isToday) {
            const attendanceData = window.adminTeacherAttendanceData || {};
            
            function getClassWeekDates(cls, weekNum) {
                if (!cls.startDate) return null;
                const startDate = parseESTDate(cls.startDate);
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + (weekNum - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                return { start: weekStart, end: weekEnd };
            }
            
            function getClassCurrentWeek(cls) {
                if (!cls.startDate) return null;
                const startDate = parseESTDate(cls.startDate);
                const todayDate = getESTToday();
                if (todayDate < startDate) return 0;
                const daysSinceStart = getDaysBetween(todayDate, startDate);
                return Math.min(Math.floor(daysSinceStart / 7) + 1, 7);
            }
            
            function formatDateRange(start, end) {
                const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                return `${formatDate(start)}-${formatDate(end)}`;
            }
            
            function isWeekAttendanceComplete(cls, weekNum) {
                const students = cls.students || [];
                if (students.length === 0) return false;
                const classAttendance = attendanceData[cls.id] || {};
                return students.every(s => {
                    const key = `${s.id}_${weekNum}`;
                    return classAttendance[key] && ['present', 'late', 'absent'].includes(classAttendance[key]);
                });
            }
            
            function getAttendanceStatus(classId, studentId, week) {
                const classAttendance = attendanceData[classId] || {};
                return classAttendance[`${studentId}_${week}`] || '';
            }
            
            const currentWeek = getClassCurrentWeek(c);
            const startDateDisplay = c.startDate ? parseESTDate(c.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
            
            // Build week tracker
            let weekTrackerHtml = '<div class="class-week-tracker">';
            for (let w = 1; w <= 6; w++) {
                const weekDates = getClassWeekDates(c, w);
                const dateRange = weekDates ? formatDateRange(weekDates.start, weekDates.end) : '';
                const isCompleted = isWeekAttendanceComplete(c, w) && currentWeek > w;
                const isCurrent = currentWeek === w;
                const isFuture = currentWeek < w;
                
                let weekClass = 'class-week-box';
                if (isCompleted) weekClass += ' completed';
                else if (isCurrent) weekClass += ' current';
                else if (isFuture) weekClass += ' future';
                
                weekTrackerHtml += `
                    <div class="${weekClass}" onclick="showClassMaterial('${c.level}', ${w})" style="cursor: pointer;" title="Click to view Week ${w} materials">
                        <span class="week-label">Week ${w}</span>
                        <span class="week-dates">${dateRange}</span>
                        <span style="font-size: 9px; color: #9c27b0;">ðŸ“–</span>
                    </div>
                `;
            }
            weekTrackerHtml += '</div>';
            
            const attendanceWeek = currentWeek > 0 && currentWeek <= 6 ? currentWeek : 1;
            
            return `
                <div class="class-card ${isToday ? 'today-class' : ''}" style="margin-bottom: 15px;">
                    <div class="class-header">
                        <div>
                            <div class="class-day">${c.day}</div>
                            <div class="class-time">${c.time} EST</div>
                            <div style="font-size: 11px; color: #00ffff; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                        </div>
                        <div style="text-align: right;">
                            <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            ${isToday ? '<div style="font-size: 11px; color: #39ff14; margin-top: 5px;">ðŸ“ TODAY</div>' : ''}
                        </div>
                    </div>
                    
                    ${weekTrackerHtml}
                    <p style="font-size: 10px; color: #888; text-align: center; margin: 5px 0;">ðŸ‘† Click any week to view materials</p>
                    
                    ${currentWeek >= 1 && currentWeek <= 6 ? `
                        <h4 style="color: #ffff00; font-size: 13px; margin: 10px 0;">Attendance - Week ${attendanceWeek}</h4>
                        <div style="display: grid; gap: 10px;">
                            ${(c.students || []).map(s => {
                                const status = getAttendanceStatus(c.id, s.id, attendanceWeek);
                                const statusDisplay = status === 'present' ? '<span style="color: #39ff14;">âœ“ Present</span>' :
                                    status === 'late' ? '<span style="color: #ffff00;">â° Late</span>' :
                                    status === 'absent' ? '<span style="color: #ff3366;">âœ— Absent</span>' :
                                    '<span style="color: #888;">- Not marked</span>';
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                        <span style="cursor: pointer; text-decoration: underline; color: #00ffff; font-size: 12px;" onclick="openStudentAnalyticsMenu('${s.id}', '${s.name.replace(/'/g, "\\'")}', '${(s.email || '').replace(/'/g, "\\'")}')">${s.name}</span>
                                        <span style="font-size: 11px;">${statusDisplay}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : currentWeek > 6 ? `
                        <div style="text-align: center; padding: 15px; background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px;">
                            <p style="color: #39ff14; font-size: 13px; margin: 0;">ðŸŽ“ Course Complete!</p>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <p style="color: #888; font-size: 12px;">Class hasn't started yet.</p>
                        </div>
                    `}
                </div>
            `;
        }
        
        // ==================== MOVE STUDENT ====================
        
        let selectedMoveClassId = null;
        
        function openMoveStudentModal(studentId, studentName, fromClassId) {
            document.getElementById('moveStudentId').value = studentId;
            document.getElementById('moveFromClassId').value = fromClassId;
            document.getElementById('moveStudentName').textContent = studentName;
            document.getElementById('returnToPoolCheckbox').checked = false;
            selectedMoveClassId = null;
            
            renderMoveClassOptions(studentId, fromClassId);
            document.getElementById('moveToClassSection').style.display = 'block';
            document.getElementById('moveStudentModal').classList.add('active');
        }
        
        function closeMoveStudentModal() {
            document.getElementById('moveStudentModal').classList.remove('active');
        }
        
        function toggleMoveOptions() {
            const returnToPool = document.getElementById('returnToPoolCheckbox').checked;
            document.getElementById('moveToClassSection').style.display = returnToPool ? 'none' : 'block';
        }
        
        function renderMoveClassOptions(studentId, fromClassId) {
            const container = document.getElementById('moveClassOptions');
            const student = allStudents.find(s => s.id === studentId);
            
            // Show all active classes except the current one
            const availableClasses = allClasses.filter(c => c.id !== fromClassId && c.status !== 'completed');
            
            if (availableClasses.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No other classes available.</p>';
                return;
            }
            
            container.innerHTML = availableClasses.map(c => {
                const teacher = allTeachers.find(t => t.id === c.teacherId);
                const studentCount = (c.students || []).length;
                const isFull = studentCount >= schedulerSettings.maxStudents;
                const levelMatch = student && student.level === c.level;
                
                return `
                    <div class="move-student-class ${selectedMoveClassId === c.id ? 'selected' : ''}" onclick="selectMoveClass('${c.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #00ffff; font-size: 13px;">${c.day} @ ${c.time}</div>
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                ${!levelMatch ? '<span style="color: #ff9900; font-size: 11px;"> âš ï¸ Level mismatch</span>' : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: ${isFull ? '#ff3366' : '#39ff14'};">
                                    ðŸ‘¥ ${studentCount}/${schedulerSettings.maxStudents} ${isFull ? '(FULL)' : ''}
                                </div>
                                <div style="font-size: 11px; color: #888;">${teacher ? teacher.name : 'No teacher'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectMoveClass(classId) {
            selectedMoveClassId = classId;
            document.querySelectorAll('.move-student-class').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
        
        async function confirmMoveStudent() {
            const studentId = document.getElementById('moveStudentId').value;
            const fromClassId = document.getElementById('moveFromClassId').value;
            const returnToPool = document.getElementById('returnToPoolCheckbox').checked;
            
            if (returnToPool) {
                // Return student to pool for reassignment
                await returnStudentToPool(studentId, fromClassId);
            } else if (selectedMoveClassId) {
                // Move to selected class
                await moveStudentToClass(studentId, fromClassId, selectedMoveClassId);
            } else {
                alert('Please select a destination class or check "Return to pool".');
                return;
            }
            
            closeMoveStudentModal();
        }
        
        async function returnStudentToPool(studentId, fromClassId) {
            try {
                // Remove from current class
                const fromClass = allClasses.find(c => c.id === fromClassId);
                if (fromClass) {
                    const updatedStudents = (fromClass.students || []).filter(s => s.id !== studentId);
                    await db.collection('scheduler_classes').doc(fromClassId).update({ students: updatedStudents });
                    fromClass.students = updatedStudents;
                }
                
                // Update student status back to pending/limbo
                await db.collection('scheduler_students').doc(studentId).update({ 
                    status: 'pending', 
                    classId: null 
                });
                
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) {
                    allStudents[idx].status = 'pending';
                    allStudents[idx].classId = null;
                }
                
                renderStudentsTable();
                renderClasses();
                updateDashboardStats();
                alert('Student returned to pool for reassignment.');
            } catch (e) { 
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        async function moveStudentToClass(studentId, fromClassId, toClassId) {
            try {
                const student = allStudents.find(s => s.id === studentId);
                
                // Remove from current class
                const fromClass = allClasses.find(c => c.id === fromClassId);
                if (fromClass) {
                    const updatedStudents = (fromClass.students || []).filter(s => s.id !== studentId);
                    await db.collection('scheduler_classes').doc(fromClassId).update({ students: updatedStudents });
                    fromClass.students = updatedStudents;
                }
                
                // Add to new class
                const toClass = allClasses.find(c => c.id === toClassId);
                if (toClass && student) {
                    const slot = `${toClass.day}-${toClass.time}`;
                    let rank = 3; // Default to 3rd preference
                    if (student.availabilities) {
                        for (let r = 1; r <= 3; r++) {
                            if (student.availabilities[r] === slot) { rank = r; break; }
                        }
                    }
                    
                    const newStudent = { id: student.id, name: student.name, rank, timezone: student.timezone };
                    const updatedStudents = [...(toClass.students || []), newStudent];
                    await db.collection('scheduler_classes').doc(toClassId).update({ students: updatedStudents });
                    toClass.students = updatedStudents;
                    
                    // Update student record
                    await db.collection('scheduler_students').doc(studentId).update({ classId: toClassId });
                    student.classId = toClassId;
                }
                
                renderClasses();
                updateDashboardStats();
                alert('Student moved successfully!');
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        // ==================== MARK COURSE COMPLETE ====================
        
        async function markCourseComplete(classId) {
            if (!confirm('Mark this class as completed? This will move all students to the Completed section and free up the time slot.')) return;
            
            try {
                const cls = allClasses.find(c => c.id === classId);
                if (!cls) return;
                
                // Update class status
                await db.collection('scheduler_classes').doc(classId).update({ status: 'completed' });
                cls.status = 'completed';
                
                // Update all students in this class to completed
                for (const student of (cls.students || [])) {
                    await db.collection('scheduler_students').doc(student.id).update({ status: 'completed' });
                    const idx = allStudents.findIndex(s => s.id === student.id);
                    if (idx !== -1) allStudents[idx].status = 'completed';
                }
                
                renderClasses();
                renderStudentsTable();
                updateDashboardStats();
                alert('Class marked as completed! Students moved to Completed section.');
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteClass(classId) {
            const cls = allClasses.find(c => c.id === classId);
            if (!cls) return;
            
            const studentCount = (cls.students || []).length;
            let confirmMsg = `Are you sure you want to DELETE this class?\n\n${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}`;
            
            if (studentCount > 0) {
                confirmMsg += `\n\nâš ï¸ This class has ${studentCount} student(s). They will be returned to the student pool for reassignment.`;
            }
            
            confirmMsg += '\n\nThis action cannot be undone.';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Return students to pool (handle missing documents gracefully)
                for (const student of (cls.students || [])) {
                    try {
                        // Check if student document exists first
                        const studentDoc = await db.collection('scheduler_students').doc(student.id).get();
                        if (studentDoc.exists) {
                            await db.collection('scheduler_students').doc(student.id).update({ 
                                status: 'pending', 
                                classId: null 
                            });
                        }
                        const idx = allStudents.findIndex(s => s.id === student.id);
                        if (idx !== -1) {
                            allStudents[idx].status = 'pending';
                            allStudents[idx].classId = null;
                        }
                    } catch (studentErr) {
                        console.warn(`Could not update student ${student.id}, may have been deleted:`, studentErr.message);
                        // Continue with other students
                    }
                }
                
                // Delete the class
                await db.collection('scheduler_classes').doc(classId).delete();
                
                // Remove from local array
                const classIdx = allClasses.findIndex(c => c.id === classId);
                if (classIdx !== -1) allClasses.splice(classIdx, 1);
                
                // Delete associated attendance records
                try {
                    const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                    for (const doc of attendanceSnap.docs) {
                        await doc.ref.delete();
                    }
                } catch (attendanceErr) {
                    console.warn('Could not delete some attendance records:', attendanceErr.message);
                }
                
                renderClasses();
                renderStudentsTable();
                renderAdminSchedule();
                updateDashboardStats();
                alert('Class deleted successfully.' + (studentCount > 0 ? ` ${studentCount} student(s) returned to pool.` : ''));
            } catch (e) {
                console.error(e);
                alert('Error deleting class: ' + e.message);
            }
        }
        
        // ==================== COMMUNITY REMINDER (Week 6) ====================
        
        let communityReminderShown = false;
        
        async function checkWeek6Reminder() {
            if (!currentUser || currentUser.role !== 'teacher') return;
            if (communityReminderShown) return;
            
            // Check if there are any completed classes with pending academy status
            try {
                const completedSnap = await db.collection('scheduler_classes')
                    .where('teacherId', '==', currentUser.odId)
                    .where('status', '==', 'completed')
                    .get();
                
                let hasPendingAcademyStatus = false;
                
                for (const doc of completedSnap.docs) {
                    const classData = doc.data();
                    const students = classData.students || [];
                    const academyStatus = classData.academyStatus || {};
                    
                    // Check if any student has pending (or no) academy status
                    for (const student of students) {
                        const status = academyStatus[student.id];
                        if (!status || status === 'pending') {
                            hasPendingAcademyStatus = true;
                            break;
                        }
                    }
                    if (hasPendingAcademyStatus) break;
                }
                
                // Also show reminder if it's Week 6 and no completed classes yet
                const isWeek6 = schedulerSettings.currentWeek === 6;
                
                // Show reminder if: (Week 6 OR has completed classes) AND has pending academy statuses
                if (hasPendingAcademyStatus || (isWeek6 && completedSnap.empty)) {
                    communityReminderShown = true;
                    document.getElementById('communityReminderModal').classList.add('active');
                }
            } catch (e) {
                console.error('Error checking Week 6 reminder:', e);
                // Fallback to old behavior
                if (schedulerSettings.currentWeek === 6) {
                    communityReminderShown = true;
                    document.getElementById('communityReminderModal').classList.add('active');
                }
            }
        }
        
        function closeCommunityReminderModal() {
            document.getElementById('communityReminderModal').classList.remove('active');
        }

        // ==================== ADMIN ATTENDANCE ====================
        
        async function loadAdminAttendance() {
            const container = document.getElementById('adminAttendanceContainer');
            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading attendance...</p>';
            
            // Populate class filter dropdown
            const classFilter = document.getElementById('adminAttendanceClassFilter');
            const activeClasses = allClasses.filter(c => c.status !== 'completed');
            classFilter.innerHTML = '<option value="all">All Classes</option>' + 
                activeClasses.map(c => `<option value="${c.id}">${c.day} ${c.time} - ${LEVELS[c.level]}</option>`).join('');
            
            const selectedClass = classFilter.value;
            
            try {
                // Get all attendance records
                const attendanceSnap = await db.collection('scheduler_attendance').get();
                const attendanceMap = {};
                attendanceSnap.docs.forEach(d => {
                    const data = d.data();
                    if (!attendanceMap[data.classId]) attendanceMap[data.classId] = {};
                    if (!attendanceMap[data.classId][data.studentId]) attendanceMap[data.classId][data.studentId] = {};
                    attendanceMap[data.classId][data.studentId][data.week] = data.status;
                });
                
                // Filter classes
                let classesToShow = activeClasses;
                if (selectedClass !== 'all') {
                    classesToShow = activeClasses.filter(c => c.id === selectedClass);
                }
                
                // Count stats
                let presentCount = 0, lateCount = 0, absentCount = 0, notMarkedCount = 0;
                
                let html = '';
                
                for (const cls of classesToShow) {
                    const teacher = allTeachers.find(t => t.id === cls.teacherId);
                    
                    html += `
                        <div class="card" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="color: #00ffff; margin: 0;">${cls.day} @ ${cls.time}</h4>
                                    <span class="level-badge level-${cls.level}">${LEVELS[cls.level]}</span>
                                    ${teacher ? `<span style="color: #39ff14; font-size: 12px; margin-left: 10px;">ðŸ‘¨â€ðŸ« ${teacher.name}</span>` : ''}
                                </div>
                                <button class="btn btn-sm btn-info" onclick="openClassDetails('${cls.id}')">View Details</button>
                            </div>
                            
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>W1</th>
                                        <th>W2</th>
                                        <th>W3</th>
                                        <th>W4</th>
                                        <th>W5</th>
                                        <th>W6</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const student of (cls.students || [])) {
                        html += `<tr><td><span style="color: #00ffff; cursor: pointer; text-decoration: underline;" onclick="openStudentAnalyticsMenu('${student.id}', '${student.name.replace(/'/g, "\\'")}', '${(student.email || '').replace(/'/g, "\\'")}')">${student.name}</span></td>`;
                        
                        for (let w = 1; w <= 6; w++) {
                            const status = attendanceMap[cls.id]?.[student.id]?.[w];
                            let badge = '-';
                            let color = '#888';
                            
                            if (status === 'present') { badge = 'âœ“'; color = '#39ff14'; presentCount++; }
                            else if (status === 'late') { badge = 'L'; color = '#ffff00'; lateCount++; }
                            else if (status === 'absent') { badge = 'A'; color = '#ff3366'; absentCount++; }
                            else { notMarkedCount++; }
                            
                            html += `<td style="text-align: center; color: ${color}; font-weight: bold;">${badge}</td>`;
                        }
                        
                        html += '</tr>';
                    }
                    
                    html += '</tbody></table></div>';
                }
                
                if (classesToShow.length === 0) {
                    html = '<p style="color: #888; font-size: 12px;">No active classes found.</p>';
                }
                
                // Update stats
                document.getElementById('adminAttendancePresent').textContent = presentCount;
                document.getElementById('adminAttendanceLate').textContent = lateCount;
                document.getElementById('adminAttendanceAbsent').textContent = absentCount;
                document.getElementById('adminAttendanceNotMarked').textContent = notMarkedCount;
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
            }
        }
        
        // ==================== STUDENT DETAILS MODAL ====================
        
        function openStudentDetailsModal(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('Student not found');
                return;
            }
            
            const cls = allClasses.find(c => c.id === student.classId);
            
            const content = document.getElementById('studentDetailsContent');
            content.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    <div style="background: rgba(0,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffff;">
                        <h4 style="color: #00ffff; margin: 0 0 10px 0; font-size: 12px;">${student.name}</h4>
                        <p style="font-size: 13px; color: #888; margin: 0;">Student ID: ${student.id}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“§ EMAIL</p>
                            <p style="font-size: 13px; color: #fff; margin: 0; word-break: break-all;">${student.email || 'Not provided'}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“ž PHONE</p>
                            <p style="font-size: 13px; color: #fff; margin: 0;">${student.phone || 'Not provided'}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“š LEVEL</p>
                            <p style="font-size: 13px; margin: 0;"><span class="level-badge level-${student.level || 'none'}">${student.level ? LEVELS[student.level] : 'Not assigned'}</span></p>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“‹ STATUS</p>
                            <p style="font-size: 13px; color: ${student.status === 'assigned' ? '#39ff14' : student.status === 'completed' ? '#ff00ff' : '#ffff00'}; margin: 0;">${(student.status || 'pending').toUpperCase()}</p>
                        </div>
                    </div>
                    
                    ${cls ? `
                        <div style="background: rgba(57,255,20,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #39ff14;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸŽ“ CURRENT CLASS</p>
                            <p style="font-size: 13px; color: #39ff14; margin: 0;">${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}</p>
                        </div>
                    ` : ''}
                    
                    ${student.availabilities && student.availabilities.length > 0 ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 8px 0;">ðŸ“… AVAILABILITY</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${student.availabilities.map(a => `<span style="background: rgba(0,255,255,0.2); color: #00ffff; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${a}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${student.registeredAt ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“† REGISTERED</p>
                            <p style="font-size: 12px; color: #fff; margin: 0;">${new Date(student.registeredAt.seconds ? student.registeredAt.seconds * 1000 : student.registeredAt).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('studentDetailsModal').classList.add('active');
        }
        
        function closeStudentDetailsModal() {
            document.getElementById('studentDetailsModal').classList.remove('active');
        }
        
        // ==================== STUDENT ANALYTICS FUNCTIONS ====================
        
        let currentAnalyticsStudentId = null;
        let currentAnalyticsStudentName = null;
        let currentAnalyticsStudentEmail = null;
        let currentAnalyticsType = null;
        
        async function openStudentAnalyticsMenu(studentId, studentName, studentEmail = null) {
            // Try to find student email from multiple sources
            let email = studentEmail;
            
            if (!email || email === 'undefined' || email === '') {
                // First try allStudents (scheduler_students collection) - admin only
                const student = allStudents.find(s => s.id === studentId);
                if (student && student.email) {
                    email = student.email;
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Try to find in class students (embedded in allClasses - admin)
                for (const cls of allClasses) {
                    const classStudent = (cls.students || []).find(s => s.id === studentId);
                    if (classStudent && classStudent.email) {
                        email = classStudent.email;
                        break;
                    }
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Try to find in teacher's classes (allClassesForTeacher)
                for (const cls of (allClassesForTeacher || [])) {
                    const classStudent = (cls.students || []).find(s => s.id === studentId);
                    if (classStudent && classStudent.email) {
                        email = classStudent.email;
                        break;
                    }
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Try to find in admin's viewed teacher classes (adminViewingTeacherClasses)
                for (const cls of (adminViewingTeacherClasses || [])) {
                    const classStudent = (cls.students || []).find(s => s.id === studentId);
                    if (classStudent && classStudent.email) {
                        email = classStudent.email;
                        break;
                    }
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Try to find in admin completed classes (allAdminCompletedClasses)
                for (const cls of (allAdminCompletedClasses || [])) {
                    const classStudent = (cls.students || []).find(s => s.id === studentId);
                    if (classStudent && classStudent.email) {
                        email = classStudent.email;
                        break;
                    }
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Last resort - look up directly from scheduler_students collection
                try {
                    const studentDoc = await db.collection('scheduler_students').doc(studentId).get();
                    if (studentDoc.exists && studentDoc.data().email) {
                        email = studentDoc.data().email;
                    }
                } catch (e) {
                    console.error('Error looking up student:', e);
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                alert('Could not find student email. Please ensure the student has an email address on record.');
                return;
            }
            
            currentAnalyticsStudentId = studentId;
            currentAnalyticsStudentName = studentName;
            currentAnalyticsStudentEmail = email;
            
            document.getElementById('analyticsStudentName').textContent = studentName;
            document.getElementById('studentAnalyticsMenuModal').classList.add('active');
        }
        
        function closeStudentAnalyticsMenu() {
            document.getElementById('studentAnalyticsMenuModal').classList.remove('active');
        }
        
        async function openAnalyticsDatePicker(type) {
            currentAnalyticsType = type;
            const typeLabels = {
                pronunciation: 'ðŸŽ¤ Pronunciation',
                grammar: 'ðŸ“– Grammar',
                vocabulary: 'ðŸ“š Vocabulary'
            };
            
            document.getElementById('analyticsDatePickerTitle').textContent = `${typeLabels[type]} Analytics`;
            document.getElementById('analyticsDatePickerModal').classList.add('active');
            document.getElementById('studentAnalyticsMenuModal').classList.remove('active');
            
            const datesList = document.getElementById('analyticsDatesList');
            datesList.innerHTML = '<p style="color: #00ffff; font-size: 12px; text-align: center;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading...</p>';
            
            try {
                let dates = [];
                let hasData = false;
                
                if (type === 'pronunciation') {
                    const submissions = await db.collection('submissions2')
                        .where('studentEmail', '==', currentAnalyticsStudentEmail)
                        .where('status', '==', 'graded')
                        .get();
                    hasData = !submissions.empty;
                    
                    submissions.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.gradedAt) {
                            const date = data.gradedAt.toDate ? data.gradedAt.toDate() : new Date(data.gradedAt);
                            dates.push({
                                id: doc.id,
                                date: date,
                                testTitle: data.testTitle || 'Pronunciation Test',
                                overallScore: data.overallScore
                            });
                        }
                    });
                } else if (type === 'grammar') {
                    const submissions = await db.collection('submissions')
                        .where('studentEmail', '==', currentAnalyticsStudentEmail)
                        .where('status', '==', 'graded')
                        .get();
                    hasData = !submissions.empty;
                    
                    submissions.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.gradedAt) {
                            const date = data.gradedAt.toDate ? data.gradedAt.toDate() : new Date(data.gradedAt);
                            dates.push({
                                id: doc.id,
                                date: date,
                                testTitle: data.testTitle || 'Grammar Test',
                                overallScore: data.overallScore
                            });
                        }
                    });
                } else if (type === 'vocabulary') {
                    // For vocabulary, we need to check multiple data sources
                    // First, find the student's UID from users collection
                    let studentUid = null;
                    try {
                        const userQuery = await db.collection('users').where('email', '==', currentAnalyticsStudentEmail).limit(1).get();
                        if (!userQuery.empty) {
                            studentUid = userQuery.docs[0].id;
                        }
                    } catch (e) {
                        console.log('Could not find user by email:', e);
                    }
                    
                    // Check flashcardResults by email
                    try {
                        const results = await db.collection('flashcardResults')
                            .where('studentEmail', '==', currentAnalyticsStudentEmail)
                            .get();
                        
                        if (!results.empty) {
                            hasData = true;
                            results.docs.forEach(doc => {
                                const data = doc.data();
                                if (data.completedAt) {
                                    const date = data.completedAt.toDate ? data.completedAt.toDate() : new Date(data.completedAt);
                                    dates.push({
                                        id: doc.id,
                                        date: date,
                                        testTitle: data.setTitle || 'Vocabulary Set',
                                        overallScore: data.score
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.log('Error checking flashcardResults:', e);
                    }
                    
                    // Check leitnerProgress by studentId (UID)
                    if (studentUid) {
                        try {
                            const leitnerSnap = await db.collection('leitnerProgress').where('studentId', '==', studentUid).limit(1).get();
                            if (!leitnerSnap.empty) {
                                hasData = true;
                            }
                        } catch (e) {
                            console.log('Error checking leitnerProgress:', e);
                        }
                        
                        // Also check leitnerStats
                        try {
                            const statsDoc = await db.collection('leitnerStats').doc(studentUid).get();
                            if (statsDoc.exists && statsDoc.data().totalReviews > 0) {
                                hasData = true;
                            }
                        } catch (e) {
                            console.log('Error checking leitnerStats:', e);
                        }
                        
                        // Also check masteryDeck
                        try {
                            const masterySnap = await db.collection('masteryDeck').where('studentId', '==', studentUid).limit(1).get();
                            if (!masterySnap.empty) {
                                hasData = true;
                            }
                        } catch (e) {
                            console.log('Error checking masteryDeck:', e);
                        }
                    }
                }
                
                // Sort by date descending
                dates.sort((a, b) => b.date - a.date);
                
                if (!hasData && dates.length === 0) {
                    datesList.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 40px; margin-bottom: 15px;">ðŸ“­</div>
                            <p style="color: #888; font-size: 13px;">No ${type} analytics found for this student.</p>
                            <p style="color: #666; font-size: 12px; margin-top: 10px;">Analytics will appear here once the student completes ${type} evaluations.</p>
                        </div>
                    `;
                    return;
                }
                
                // Show "View All Analytics" button at top
                let html = `
                    <div onclick="loadAnalyticsForDate('all')" style="cursor: pointer; background: linear-gradient(135deg, rgba(0,255,255,0.2), rgba(255,0,255,0.2)); border: 3px solid #00ffff; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <p style="font-size: 12px; color: #00ffff; margin: 0 0 5px 0; font-weight: bold;">ðŸ“Š View All Analytics</p>
                        <p style="font-size: 12px; color: #888; margin: 0;">Comprehensive overview with charts & improvement stats</p>
                    </div>
                `;
                
                if (dates.length > 0) {
                    html += `<p style="font-size: 12px; color: #888; margin-bottom: 10px; text-align: center;">Or view individual sessions (${dates.length} total):</p>`;
                    html += `<div style="max-height: 300px; overflow-y: auto;">`;
                    html += dates.slice(0, 10).map(d => {
                        const dateStr = d.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                        const timeStr = d.date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        const scoreColor = d.overallScore >= 80 ? '#39ff14' : d.overallScore >= 60 ? '#ffff00' : '#ff3366';
                        
                        return `
                            <div onclick="loadAnalyticsForDate('${d.id}')" style="cursor: pointer; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#00ffff'" onmouseout="this.style.borderColor='#333'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-size: 13px; color: #00ffff; margin: 0 0 3px 0;">${d.testTitle}</p>
                                        <p style="font-size: 11px; color: #888; margin: 0;">ðŸ“… ${dateStr}</p>
                                    </div>
                                    ${d.overallScore !== undefined ? `
                                        <div style="background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 6px; border: 2px solid ${scoreColor};">
                                            <span style="font-size: 14px; color: ${scoreColor}; font-weight: bold;">${d.overallScore}%</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                    html += `</div>`;
                    
                    if (dates.length > 10) {
                        html += `<p style="font-size: 11px; color: #666; text-align: center; margin-top: 10px;">Showing 10 of ${dates.length} sessions</p>`;
                    }
                }
                
                datesList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading analytics dates:', error);
                datesList.innerHTML = `<p style="color: #ff3366; font-size: 12px; text-align: center;">Error loading dates: ${error.message}</p>`;
            }
        }
        
        function closeAnalyticsDatePicker() {
            document.getElementById('analyticsDatePickerModal').classList.remove('active');
            document.getElementById('studentAnalyticsMenuModal').classList.add('active');
        }
        
        async function loadAnalyticsForDate(submissionId) {
            document.getElementById('analyticsDatePickerModal').classList.remove('active');
            document.getElementById('analyticsDisplayModal').classList.add('active');
            
            const typeLabels = {
                pronunciation: 'ðŸŽ¤ Pronunciation Analytics',
                grammar: 'ðŸ“– Grammar Analytics',
                vocabulary: 'ðŸ“š Vocabulary Analytics'
            };
            
            document.getElementById('analyticsDisplayTitle').textContent = `${typeLabels[currentAnalyticsType]} - ${currentAnalyticsStudentName}`;
            
            const content = document.getElementById('analyticsDisplayContent');
            content.innerHTML = '<p style="color: #00ffff; font-size: 12px; text-align: center;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading analytics...</p>';
            
            try {
                if (currentAnalyticsType === 'pronunciation') {
                    await renderPronunciationAnalytics(submissionId, content);
                } else if (currentAnalyticsType === 'grammar') {
                    await renderGrammarAnalytics(submissionId, content);
                } else if (currentAnalyticsType === 'vocabulary') {
                    await renderVocabularyAnalytics(submissionId, content);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                content.innerHTML = `<p style="color: #ff3366; font-size: 12px; text-align: center;">Error loading analytics: ${error.message}</p>`;
            }
        }
        
        async function renderPronunciationAnalytics(submissionId, container) {
            // Load ALL pronunciation submissions for this student to show comprehensive analytics
            const allSubmissions = await db.collection('submissions2')
                .where('studentEmail', '==', currentAnalyticsStudentEmail)
                .where('status', '==', 'graded')
                .get();
            
            if (allSubmissions.empty) {
                container.innerHTML = '<p style="color: #ff3366;">No pronunciation data found.</p>';
                return;
            }
            
            // Process all submissions
            const submissions = [];
            const topicScores = {};
            
            allSubmissions.docs.forEach(doc => {
                const data = doc.data();
                const gradedAt = data.gradedAt?.toDate ? data.gradedAt.toDate() : new Date();
                
                submissions.push({
                    id: doc.id,
                    date: gradedAt,
                    grades: data.grades || {},
                    overallScore: data.overallScore || 0,
                    testTitle: data.testTitle || 'Pronunciation Test'
                });
                
                // Organize scores by topic
                Object.entries(data.grades || {}).forEach(([key, grade]) => {
                    const topic = key.includes('_') ? key.split('_')[1] : key;
                    if (!topicScores[topic]) topicScores[topic] = [];
                    topicScores[topic].push({ grade, date: gradedAt });
                });
            });
            
            // Sort submissions by date
            submissions.sort((a, b) => a.date - b.date);
            
            // Calculate improvements
            let overallImprovement = 'N/A';
            let weeklyImprovement = 'N/A';
            let monthlyImprovement = 'N/A';
            
            if (submissions.length >= 2) {
                const firstAvg = submissions[0].overallScore;
                const lastAvg = submissions[submissions.length - 1].overallScore;
                if (firstAvg > 0) {
                    overallImprovement = ((lastAvg - firstAvg) / firstAvg * 100).toFixed(1);
                }
                
                // Weekly improvement
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const weekSubmissions = submissions.filter(s => s.date >= oneWeekAgo);
                if (weekSubmissions.length >= 2) {
                    const weekFirst = weekSubmissions[0].overallScore;
                    const weekLast = weekSubmissions[weekSubmissions.length - 1].overallScore;
                    if (weekFirst > 0) {
                        weeklyImprovement = ((weekLast - weekFirst) / weekFirst * 100).toFixed(1);
                    }
                }
                
                // Monthly improvement
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                const monthSubmissions = submissions.filter(s => s.date >= oneMonthAgo);
                if (monthSubmissions.length >= 2) {
                    const monthFirst = monthSubmissions[0].overallScore;
                    const monthLast = monthSubmissions[monthSubmissions.length - 1].overallScore;
                    if (monthFirst > 0) {
                        monthlyImprovement = ((monthLast - monthFirst) / monthFirst * 100).toFixed(1);
                    }
                }
            }
            
            const latestSubmission = submissions[submissions.length - 1];
            const improvementColor = val => parseFloat(val) >= 0 ? '#39ff14' : '#ff3366';
            const improvementSign = val => parseFloat(val) >= 0 ? '+' : '';
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.2) 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px; text-align: center;">
                        <p style="font-size: 14px; color: #00ffff; margin: 0 0 5px 0;">ðŸŽ¤ Pronunciation Analytics for ${currentAnalyticsStudentName}</p>
                        <p style="font-size: 12px; color: #888; margin: 0 0 10px 0;">${submissions.length} total evaluations</p>
                        <div style="font-size: 36px; font-weight: bold; color: ${latestSubmission.overallScore >= 80 ? '#39ff14' : latestSubmission.overallScore >= 60 ? '#ffff00' : '#ff3366'};">${latestSubmission.overallScore}%</div>
                        <p style="font-size: 13px; color: #888; margin-top: 5px;">Latest Score</p>
                    </div>
                </div>
                
                <!-- Improvement Stats -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${overallImprovement !== 'N/A' ? improvementColor(overallImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ALL-TIME</p>
                        <div style="font-size: 16px; font-weight: bold; color: ${overallImprovement !== 'N/A' ? improvementColor(overallImprovement) : '#888'};">${overallImprovement !== 'N/A' ? improvementSign(overallImprovement) + overallImprovement + '%' : 'N/A'}</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${monthlyImprovement !== 'N/A' ? improvementColor(monthlyImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">THIS MONTH</p>
                        <div style="font-size: 16px; font-weight: bold; color: ${monthlyImprovement !== 'N/A' ? improvementColor(monthlyImprovement) : '#888'};">${monthlyImprovement !== 'N/A' ? improvementSign(monthlyImprovement) + monthlyImprovement + '%' : 'N/A'}</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${weeklyImprovement !== 'N/A' ? improvementColor(weeklyImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">THIS WEEK</p>
                        <div style="font-size: 16px; font-weight: bold; color: ${weeklyImprovement !== 'N/A' ? improvementColor(weeklyImprovement) : '#888'};">${weeklyImprovement !== 'N/A' ? improvementSign(weeklyImprovement) + weeklyImprovement + '%' : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Progress Chart -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #00ffff; font-size: 14px; margin-bottom: 15px;">ðŸ“ˆ Progress Over Time</h4>
                    <div style="height: 200px;">
                        <canvas id="pronProgressChart"></canvas>
                    </div>
                </div>
                
                <!-- Topic Performance Chart -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #00ffff; font-size: 14px; margin-bottom: 15px;">ðŸ“Š Performance by Character</h4>
                    <div style="height: 200px;">
                        <canvas id="pronTopicChart"></canvas>
                    </div>
                </div>
                
                <!-- Character Scores Grid -->
                <h4 style="color: #00ffff; font-size: 14px; margin-bottom: 15px;">ðŸ”¤ Latest Character Scores</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; margin-bottom: 20px;">
                    ${Object.entries(topicScores).map(([topic, scores]) => {
                        scores.sort((a, b) => b.date - a.date);
                        const latestScore = scores[0].grade;
                        const color = latestScore >= 8 ? '#39ff14' : latestScore >= 5 ? '#ffff00' : '#ff3366';
                        return `
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid ${color}; border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-size: 18px; color: #fff; margin-bottom: 3px;">${topic}</div>
                                <div style="font-size: 12px; font-weight: bold; color: ${color};">${latestScore}/10</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Create Progress Chart
            setTimeout(() => {
                const progressCtx = document.getElementById('pronProgressChart');
                if (progressCtx) {
                    new Chart(progressCtx, {
                        type: 'line',
                        data: {
                            labels: submissions.map(s => s.date.toLocaleDateString()),
                            datasets: [{
                                label: 'Score %',
                                data: submissions.map(s => s.overallScore),
                                borderColor: '#00ffff',
                                backgroundColor: 'rgba(0,255,255,0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 100, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            },
                            plugins: { legend: { labels: { color: '#fff' } } }
                        }
                    });
                }
                
                // Create Topic Chart
                const topicCtx = document.getElementById('pronTopicChart');
                if (topicCtx) {
                    const topics = Object.keys(topicScores);
                    const latestScores = topics.map(t => {
                        const scores = topicScores[t];
                        scores.sort((a, b) => b.date - a.date);
                        return scores[0].grade;
                    });
                    
                    new Chart(topicCtx, {
                        type: 'bar',
                        data: {
                            labels: topics,
                            datasets: [{
                                label: 'Score',
                                data: latestScores,
                                backgroundColor: latestScores.map(s => s >= 8 ? 'rgba(57,255,20,0.7)' : s >= 5 ? 'rgba(255,255,0,0.7)' : 'rgba(255,51,102,0.7)'),
                                borderColor: latestScores.map(s => s >= 8 ? '#39ff14' : s >= 5 ? '#ffff00' : '#ff3366'),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 10, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }, 100);
        }
        
        async function renderGrammarAnalytics(submissionId, container) {
            // Load ALL grammar submissions for this student
            const allSubmissions = await db.collection('submissions')
                .where('studentEmail', '==', currentAnalyticsStudentEmail)
                .where('status', '==', 'graded')
                .get();
            
            if (allSubmissions.empty) {
                container.innerHTML = '<p style="color: #ff3366;">No grammar data found.</p>';
                return;
            }
            
            // Process all submissions
            const submissions = [];
            const topicScores = {};
            
            allSubmissions.docs.forEach(doc => {
                const data = doc.data();
                const gradedAt = data.gradedAt?.toDate ? data.gradedAt.toDate() : new Date();
                
                submissions.push({
                    id: doc.id,
                    date: gradedAt,
                    grades: data.grades || {},
                    overallScore: data.overallScore || 0,
                    testTitle: data.testTitle || 'Grammar Test'
                });
                
                Object.entries(data.grades || {}).forEach(([topic, grade]) => {
                    if (!topicScores[topic]) topicScores[topic] = [];
                    const scoreVal = typeof grade === 'number' ? grade * 10 : grade;
                    topicScores[topic].push({ grade: scoreVal, date: gradedAt });
                });
            });
            
            submissions.sort((a, b) => a.date - b.date);
            
            // Calculate improvements
            let overallImprovement = 'N/A';
            let weeklyImprovement = 'N/A';
            
            if (submissions.length >= 2) {
                const firstAvg = submissions[0].overallScore;
                const lastAvg = submissions[submissions.length - 1].overallScore;
                if (firstAvg > 0) {
                    overallImprovement = ((lastAvg - firstAvg) / firstAvg * 100).toFixed(1);
                }
                
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const weekSubmissions = submissions.filter(s => s.date >= oneWeekAgo);
                if (weekSubmissions.length >= 2) {
                    const weekFirst = weekSubmissions[0].overallScore;
                    const weekLast = weekSubmissions[weekSubmissions.length - 1].overallScore;
                    if (weekFirst > 0) {
                        weeklyImprovement = ((weekLast - weekFirst) / weekFirst * 100).toFixed(1);
                    }
                }
            }
            
            const latestSubmission = submissions[submissions.length - 1];
            const improvementColor = val => parseFloat(val) >= 0 ? '#39ff14' : '#ff3366';
            const improvementSign = val => parseFloat(val) >= 0 ? '+' : '';
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(72,187,120,0.2) 0%, rgba(56,178,172,0.2) 100%); border: 2px solid #48bb78; border-radius: 12px; padding: 20px; text-align: center;">
                        <p style="font-size: 14px; color: #48bb78; margin: 0 0 5px 0;">ðŸ“– Grammar Analytics for ${currentAnalyticsStudentName}</p>
                        <p style="font-size: 12px; color: #888; margin: 0 0 10px 0;">${submissions.length} total evaluations</p>
                        <div style="font-size: 36px; font-weight: bold; color: ${latestSubmission.overallScore >= 80 ? '#39ff14' : latestSubmission.overallScore >= 60 ? '#ffff00' : '#ff3366'};">${latestSubmission.overallScore}%</div>
                        <p style="font-size: 13px; color: #888; margin-top: 5px;">Latest Score</p>
                    </div>
                </div>
                
                <!-- Improvement Stats -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${overallImprovement !== 'N/A' ? improvementColor(overallImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ALL-TIME IMPROVEMENT</p>
                        <div style="font-size: 18px; font-weight: bold; color: ${overallImprovement !== 'N/A' ? improvementColor(overallImprovement) : '#888'};">${overallImprovement !== 'N/A' ? improvementSign(overallImprovement) + overallImprovement + '%' : 'N/A'}</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${weeklyImprovement !== 'N/A' ? improvementColor(weeklyImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">WEEKLY IMPROVEMENT</p>
                        <div style="font-size: 18px; font-weight: bold; color: ${weeklyImprovement !== 'N/A' ? improvementColor(weeklyImprovement) : '#888'};">${weeklyImprovement !== 'N/A' ? improvementSign(weeklyImprovement) + weeklyImprovement + '%' : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Progress Chart -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #48bb78; font-size: 14px; margin-bottom: 15px;">ðŸ“ˆ Progress Over Time</h4>
                    <div style="height: 200px;">
                        <canvas id="grammarProgressChart"></canvas>
                    </div>
                </div>
                
                <!-- Topic Scores -->
                ${Object.keys(topicScores).length > 0 ? `
                    <h4 style="color: #48bb78; font-size: 14px; margin-bottom: 15px;">ðŸ“Š Topic Scores</h4>
                    <div style="display: grid; gap: 10px;">
                        ${Object.entries(topicScores).map(([topic, scores]) => {
                            scores.sort((a, b) => b.date - a.date);
                            const latest = scores[0].grade;
                            const color = latest >= 80 ? '#39ff14' : latest >= 60 ? '#ffff00' : '#ff3366';
                            return `
                                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 13px; color: #fff;">${topic}</span>
                                        <span style="font-size: 14px; font-weight: bold; color: ${color};">${latest}%</span>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                        <div style="background: ${color}; width: ${latest}%; height: 100%; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            `;
            
            // Create Progress Chart
            setTimeout(() => {
                const ctx = document.getElementById('grammarProgressChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: submissions.map(s => s.date.toLocaleDateString()),
                            datasets: [{
                                label: 'Score %',
                                data: submissions.map(s => s.overallScore),
                                borderColor: '#48bb78',
                                backgroundColor: 'rgba(72,187,120,0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 100, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            },
                            plugins: { legend: { labels: { color: '#fff' } } }
                        }
                    });
                }
            }, 100);
        }
        
        async function renderVocabularyAnalytics(submissionId, container) {
            container.innerHTML = '<p style="color: #00ffff; font-size: 12px; text-align: center;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading SRS Stats...</p>';
            
            // First, find the student's UID from users collection
            let studentUid = null;
            let studentDisplayName = currentAnalyticsStudentName;
            try {
                const userQuery = await db.collection('users').where('email', '==', currentAnalyticsStudentEmail).limit(1).get();
                if (!userQuery.empty) {
                    studentUid = userQuery.docs[0].id;
                    studentDisplayName = userQuery.docs[0].data().displayName || studentDisplayName;
                }
            } catch (e) {
                console.log('Could not find user by email:', e);
            }
            
            if (!studentUid) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 15px;">ðŸ”</div>
                        <p style="color: #ff9900; font-size: 14px;">Could not find student account</p>
                        <p style="color: #888; font-size: 12px; margin-top: 10px;">Email: ${currentAnalyticsStudentEmail}</p>
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">The student may not have created an account yet.</p>
                    </div>
                `;
                return;
            }
            
            // Load all data sources
            let leitnerCards = [];
            let leitnerStats = { 
                totalCorrect: 0, 
                totalReviews: 0, 
                currentStreak: 0, 
                longestStreak: 0,
                totalLapses: 0,
                totalMastered: 0,
                totalCardsLearning: 0,
                studyLog: {}
            };
            let masteryDeckCount = 0;
            
            try {
                // Load Leitner cards from leitnerProgress collection
                const leitnerSnap = await db.collection('leitnerProgress').where('studentId', '==', studentUid).get();
                leitnerCards = leitnerSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log('Loaded leitnerProgress:', leitnerCards.length, leitnerCards.slice(0, 3));
                
                // Load Leitner stats
                const statsDoc = await db.collection('leitnerStats').doc(studentUid).get();
                if (statsDoc.exists) {
                    leitnerStats = { ...leitnerStats, ...statsDoc.data() };
                }
                
                // Load Mastery Deck count (words mastered from games)
                const masterySnap = await db.collection('masteryDeck').where('studentId', '==', studentUid).get();
                masteryDeckCount = masterySnap.size;
            } catch (e) {
                console.error('Error loading vocabulary data:', e);
            }
            
            // Calculate metrics - use correct threshold of 5
            const LEITNER_LEECH_THRESHOLD = 5;
            const LEITNER_BOX_NAMES = {
                1: 'Day 1', 2: 'Day 2', 3: 'Day 3', 4: 'Semi-Mastery',
                5: 'Day 5', 6: 'Weekly', 7: 'Monthly', 8: 'Mastery'
            };
            
            const boxCounts = {};
            const boxLapses = {}; // Track lapses per box
            for (let i = 1; i <= 8; i++) {
                const cardsInBox = leitnerCards.filter(c => c.box === i);
                boxCounts[i] = cardsInBox.length;
                boxLapses[i] = cardsInBox.reduce((sum, c) => sum + (c.lapseCount || 0), 0);
            }
            
            // Semi-mastery count (Day 4+)
            const semiMasteredCount = (boxCounts[4] || 0) + (boxCounts[5] || 0) + (boxCounts[6] || 0) + (boxCounts[7] || 0);
            
            // Calculate Day 1 interval completion rates
            const day1Cards = leitnerCards.filter(c => c.box === 1 || c.day1Intervals);
            const day1IntervalStats = {
                first: { completed: 0, total: day1Cards.length },
                thirtyMin: { completed: 0, total: day1Cards.length },
                twoHours: { completed: 0, total: day1Cards.length },
                beforeSleep: { completed: 0, total: day1Cards.length }
            };
            
            day1Cards.forEach(card => {
                const intervals = card.day1Intervals || {};
                if (intervals.first) day1IntervalStats.first.completed++;
                if (intervals.thirtyMin) day1IntervalStats.thirtyMin.completed++;
                if (intervals.twoHours) day1IntervalStats.twoHours.completed++;
                if (intervals.beforeSleep) day1IntervalStats.beforeSleep.completed++;
            });
            
            const totalLearning = leitnerCards.filter(c => c.box < 8).length;
            const leitnerMastered = boxCounts[8] || 0;
            const totalMastered = leitnerMastered + masteryDeckCount;
            const totalCardsInSystem = leitnerCards.length + masteryDeckCount;
            const masteryRate = totalCardsInSystem > 0 ? (totalMastered / totalCardsInSystem * 100).toFixed(1) : 0;
            
            const accuracy = leitnerStats.totalReviews > 0 ?
                (leitnerStats.totalCorrect / leitnerStats.totalReviews * 100).toFixed(1) : 0;
            const resetRate = leitnerStats.totalReviews > 0 ?
                (leitnerStats.totalLapses / leitnerStats.totalReviews * 100).toFixed(1) : 0;
            
            // Calculate per-box reset rates
            const boxResetRates = {};
            const totalLapsesAllCards = leitnerCards.reduce((sum, c) => sum + (c.lapseCount || 0), 0);
            for (let i = 1; i <= 7; i++) {
                if (boxLapses[i] > 0 && totalLapsesAllCards > 0) {
                    boxResetRates[i] = ((boxLapses[i] / totalLapsesAllCards) * 100).toFixed(1);
                } else {
                    boxResetRates[i] = '0';
                }
            }
            
            // Find the box with highest reset contribution
            let highestResetBox = 0;
            let highestResetValue = 0;
            for (let i = 1; i <= 7; i++) {
                if (parseFloat(boxResetRates[i]) > highestResetValue) {
                    highestResetValue = parseFloat(boxResetRates[i]);
                    highestResetBox = i;
                }
            }
            
            // Get leech cards (cards that student struggles with) - threshold is 5
            const leechCards = leitnerCards
                .filter(c => (c.lapseCount || 0) >= LEITNER_LEECH_THRESHOLD)
                .sort((a, b) => (b.lapseCount || 0) - (a.lapseCount || 0))
                .slice(0, 10);
            
            // Also get cards with any lapses for debugging
            const cardsWithLapses = leitnerCards.filter(c => (c.lapseCount || 0) > 0);
            console.log('Cards with lapses:', cardsWithLapses.length, cardsWithLapses.slice(0, 5));
            
            // Calculate time to mastery
            const masteredCards = leitnerCards.filter(c => c.box === 8 && c.masteredDate && c.firstSeenDate);
            let avgTimeToMastery = 'N/A';
            if (masteredCards.length > 0) {
                const times = masteredCards.map(c => {
                    const first = c.firstSeenDate?.toDate ? c.firstSeenDate.toDate() : new Date(c.firstSeenDate);
                    const mastered = c.masteredDate?.toDate ? c.masteredDate.toDate() : new Date(c.masteredDate);
                    return Math.floor((mastered - first) / (1000 * 60 * 60 * 24));
                });
                avgTimeToMastery = (times.reduce((a, b) => a + b, 0) / times.length).toFixed(1);
            }
            
            // Calculate weekly consistency
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            const studyLog = leitnerStats.studyLog || {};
            
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push({ date: dateStr, count: studyLog[dateStr] || 0 });
            }
            const daysStudiedThisWeek = last7Days.filter(d => d.count > 0).length;
            const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            // Due cards count
            const leitnerDueCards = leitnerCards.filter(card => {
                if (card.box >= 8) return false;
                if (!card.nextReviewDate) return card.box === 1;
                const nextReview = card.nextReviewDate?.toDate ? card.nextReviewDate.toDate() : new Date(card.nextReviewDate);
                return nextReview <= new Date();
            });
            
            // Check if there's any data at all
            const hasData = leitnerCards.length > 0 || masteryDeckCount > 0 || leitnerStats.totalReviews > 0;
            
            if (!hasData) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 15px;">ðŸ“š</div>
                        <p style="color: #888; font-size: 14px;">No vocabulary data yet</p>
                        <p style="color: #666; font-size: 12px; margin-top: 10px;">This student hasn't started using the flashcard system yet.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(237,137,54,0.2) 0%, rgba(221,107,32,0.2) 100%); border: 2px solid #ed8936; border-radius: 12px; padding: 20px; text-align: center;">
                        <p style="font-size: 14px; color: #ed8936; margin: 0 0 5px 0;">ðŸ“ˆ SRS Stats for ${currentAnalyticsStudentName}</p>
                        <p style="font-size: 12px; color: #888; margin: 0;">Spaced Repetition Learning Analytics</p>
                    </div>
                </div>
                
                <!-- Core Progress Section -->
                <h4 style="color: #ed8936; font-size: 14px; margin-bottom: 15px;">ðŸ“ˆ Core Progress</h4>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(245,158,11,0.1); border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">â­ MASTERY DECK</p>
                        <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${masteryDeckCount}</div>
                        <p style="font-size: 10px; color: #888;">from games</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(72,187,120,0.2) 0%, rgba(56,178,172,0.2) 100%); border: 2px solid #48bb78; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ§  SEMI-MASTERED</p>
                        <div style="font-size: 20px; font-weight: bold; color: #48bb78;">${semiMasteredCount}</div>
                        <p style="font-size: 10px; color: #888;">Day 4+ cards</p>
                    </div>
                    <div style="background: rgba(159,122,234,0.1); border: 2px solid #9f7aea; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“¦ LEITNER GRAD</p>
                        <div style="font-size: 20px; font-weight: bold; color: #9f7aea;">${leitnerMastered}</div>
                        <p style="font-size: 10px; color: #888;">through SRS</p>
                    </div>
                    <div style="background: rgba(102,126,234,0.1); border: 2px solid #667eea; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“Š MASTERY RATE</p>
                        <div style="font-size: 20px; font-weight: bold; color: #667eea;">${masteryRate}%</div>
                        <p style="font-size: 10px; color: #888;">of all cards</p>
                    </div>
                    <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ”„ IN ROTATION</p>
                        <div style="font-size: 20px; font-weight: bold; color: #00ffff;">${totalLearning}</div>
                        <p style="font-size: 10px; color: #888;">learning</p>
                    </div>
                </div>
                
                <!-- Day 1 Practice Pattern Section -->
                ${day1IntervalStats.first.total > 0 ? `
                <div style="background: linear-gradient(135deg, rgba(245,101,101,0.1) 0%, rgba(237,137,54,0.1) 100%); border: 2px solid #fc8181; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #e53e3e; font-size: 14px; margin: 0 0 15px 0;">ðŸ”¥ Day 1 Practice Pattern (Spaced Intervals)</h4>
                    <p style="font-size: 11px; color: #888; margin: 0 0 12px 0;">Research shows 3-5 spaced recalls on Day 1 dramatically improve retention.</p>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                            <p style="font-size: 14px; margin: 0 0 5px 0;">1ï¸âƒ£</p>
                            <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">First Practice</p>
                            <div style="font-size: 14px; font-weight: bold; color: ${day1IntervalStats.first.completed === day1IntervalStats.first.total ? '#48bb78' : '#ed8936'};">
                                ${day1IntervalStats.first.completed}/${day1IntervalStats.first.total}
                            </div>
                            <p style="font-size: 10px; color: #888;">${day1IntervalStats.first.total > 0 ? Math.round(day1IntervalStats.first.completed / day1IntervalStats.first.total * 100) : 0}%</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                            <p style="font-size: 14px; margin: 0 0 5px 0;">â°</p>
                            <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">30 Min Later</p>
                            <div style="font-size: 14px; font-weight: bold; color: ${day1IntervalStats.thirtyMin.completed === day1IntervalStats.thirtyMin.total ? '#48bb78' : day1IntervalStats.thirtyMin.completed > 0 ? '#ed8936' : '#f56565'};">
                                ${day1IntervalStats.thirtyMin.completed}/${day1IntervalStats.thirtyMin.total}
                            </div>
                            <p style="font-size: 10px; color: #888;">${day1IntervalStats.thirtyMin.total > 0 ? Math.round(day1IntervalStats.thirtyMin.completed / day1IntervalStats.thirtyMin.total * 100) : 0}%</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                            <p style="font-size: 14px; margin: 0 0 5px 0;">ðŸ•</p>
                            <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">2 Hours Later</p>
                            <div style="font-size: 14px; font-weight: bold; color: ${day1IntervalStats.twoHours.completed === day1IntervalStats.twoHours.total ? '#48bb78' : day1IntervalStats.twoHours.completed > 0 ? '#ed8936' : '#f56565'};">
                                ${day1IntervalStats.twoHours.completed}/${day1IntervalStats.twoHours.total}
                            </div>
                            <p style="font-size: 10px; color: #888;">${day1IntervalStats.twoHours.total > 0 ? Math.round(day1IntervalStats.twoHours.completed / day1IntervalStats.twoHours.total * 100) : 0}%</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                            <p style="font-size: 14px; margin: 0 0 5px 0;">ðŸŒ™</p>
                            <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">Before Sleep</p>
                            <div style="font-size: 14px; font-weight: bold; color: ${day1IntervalStats.beforeSleep.completed === day1IntervalStats.beforeSleep.total ? '#48bb78' : day1IntervalStats.beforeSleep.completed > 0 ? '#ed8936' : '#f56565'};">
                                ${day1IntervalStats.beforeSleep.completed}/${day1IntervalStats.beforeSleep.total}
                            </div>
                            <p style="font-size: 10px; color: #888;">${day1IntervalStats.beforeSleep.total > 0 ? Math.round(day1IntervalStats.beforeSleep.completed / day1IntervalStats.beforeSleep.total * 100) : 0}%</p>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Recall Quality Section -->
                <h4 style="color: #48bb78; font-size: 14px; margin-bottom: 15px;">ðŸŽ¯ Recall Quality</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(72,187,120,0.1); border: 2px solid #48bb78; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">âœ… ACCURACY</p>
                        <div style="font-size: 20px; font-weight: bold; color: #48bb78;">${accuracy}%</div>
                        <p style="font-size: 10px; color: #888;">${leitnerStats.totalCorrect || 0}/${leitnerStats.totalReviews || 0}</p>
                    </div>
                    <div style="background: rgba(66,153,225,0.1); border: 2px solid #4299e1; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">â±ï¸ AVG TO MASTER</p>
                        <div style="font-size: 20px; font-weight: bold; color: #4299e1;">${avgTimeToMastery}</div>
                        <p style="font-size: 10px; color: #888;">days</p>
                    </div>
                    <div style="background: rgba(56,178,172,0.1); border: 2px solid #38b2ac; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ’ª STRONG WORDS</p>
                        <div style="font-size: 20px; font-weight: bold; color: #38b2ac;">${(boxCounts[6] || 0) + (boxCounts[7] || 0)}</div>
                        <p style="font-size: 10px; color: #888;">Weekly+Monthly</p>
                    </div>
                </div>
                
                <!-- Struggle Analysis Section -->
                <h4 style="color: #f56565; font-size: 14px; margin-bottom: 15px;">âš ï¸ Struggle Analysis</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(245,101,101,0.1); border: 2px solid #f56565; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ”„ TOTAL RESETS</p>
                        <div style="font-size: 20px; font-weight: bold; color: #f56565;">${totalLapsesAllCards}</div>
                        <p style="font-size: 10px; color: #888;">across all cards</p>
                    </div>
                    <div style="background: rgba(237,137,54,0.1); border: 2px solid #ed8936; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“‰ OVERALL RESET RATE</p>
                        <div style="font-size: 20px; font-weight: bold; color: #ed8936;">${resetRate}%</div>
                        <p style="font-size: 10px; color: #888;">of reviews</p>
                    </div>
                </div>
                
                <!-- Per-Box Reset Rates -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <p style="font-size: 12px; color: #f56565; margin: 0 0 10px 0;">ðŸ“Š Reset Distribution by Box</p>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                        ${[1,2,3,4,5,6,7].map(box => {
                            const isHighest = box === highestResetBox && highestResetValue > 20;
                            const lapseCount = boxLapses[box] || 0;
                            const pct = boxResetRates[box];
                            const bgColor = isHighest ? 'rgba(245,101,101,0.3)' : 'rgba(0,0,0,0.3)';
                            const borderColor = isHighest ? '#f56565' : (parseFloat(pct) > 15 ? '#ed8936' : '#555');
                            const textColor = isHighest ? '#f56565' : (parseFloat(pct) > 15 ? '#ed8936' : '#888');
                            return `
                                <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 6px; padding: 8px; text-align: center; ${isHighest ? 'box-shadow: 0 0 10px rgba(245,101,101,0.5);' : ''}">
                                    <p style="font-size: 10px; color: #888; margin: 0 0 3px 0;">${LEITNER_BOX_NAMES[box]}</p>
                                    <div style="font-size: 12px; font-weight: bold; color: ${textColor};">${pct}%</div>
                                    <p style="font-size: 9px; color: #666; margin-top: 2px;">${lapseCount} resets</p>
                                    ${isHighest ? '<p style="font-size: 9px; color: #f56565; margin-top: 2px;">âš ï¸ HIGHEST</p>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Leech Cards -->
                ${leechCards.length > 0 ? `
                    <div style="background: rgba(245,101,101,0.1); border: 2px solid #f56565; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                        <p style="font-size: 12px; color: #f56565; margin: 0 0 10px 0;">ðŸ©¸ Leech Cards (${LEITNER_LEECH_THRESHOLD}+ resets) - ${leechCards.length} found</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${leechCards.map(c => `
                                <span style="background: rgba(0,0,0,0.3); padding: 6px 10px; border-radius: 5px; font-size: 12px; border: 1px solid #f56565;">
                                    <span style="color: #fff;">${c.english || c.korean || c.word || 'Card'}</span>
                                    <span style="color: #f56565; margin-left: 5px; font-weight: bold;">(${c.lapseCount}x)</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : cardsWithLapses.length > 0 ? `
                    <div style="background: rgba(237,137,54,0.1); border: 2px solid #ed8936; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                        <p style="font-size: 12px; color: #ed8936; margin: 0 0 5px 0;">âš ï¸ ${cardsWithLapses.length} cards have been reset (but less than ${LEITNER_LEECH_THRESHOLD}x each)</p>
                        <p style="font-size: 11px; color: #888;">Top struggling cards:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                            ${cardsWithLapses.sort((a,b) => (b.lapseCount||0) - (a.lapseCount||0)).slice(0,8).map(c => `
                                <span style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                    <span style="color: #fff;">${c.english || c.korean || c.word || 'Card'}</span>
                                    <span style="color: #ed8936; margin-left: 3px;">(${c.lapseCount}x)</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div style="background: rgba(72,187,120,0.1); border: 2px solid #48bb78; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                        <p style="font-size: 13px; color: #48bb78; margin: 0;">ðŸŽ‰ No struggling cards! Student hasn't reset any words.</p>
                    </div>
                `}
                
                <!-- Consistency Section -->
                <h4 style="color: #ed8936; font-size: 14px; margin-bottom: 15px;">ðŸ”¥ Consistency & Habits</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                    <div style="background: rgba(237,137,54,0.1); border: 2px solid #ed8936; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ”¥ CURRENT STREAK</p>
                        <div style="font-size: 20px; font-weight: bold; color: #ed8936;">${leitnerStats.currentStreak || 0}</div>
                        <p style="font-size: 10px; color: #888;">days (best: ${leitnerStats.longestStreak || 0})</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #888; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“… WEEKLY</p>
                        <div style="font-size: 20px; font-weight: bold; color: #fff;">${Math.round(daysStudiedThisWeek / 7 * 100)}%</div>
                        <div style="display: flex; justify-content: center; gap: 3px; margin-top: 5px;">
                            ${last7Days.map((d, i) => {
                                const dayDate = new Date(d.date);
                                const dayIndex = dayDate.getDay();
                                const isToday = d.date === todayStr;
                                const bgColor = d.count > 0 ? '#39ff14' : '#333';
                                return `<div style="width: 14px; height: 14px; background: ${bgColor}; border-radius: 3px; font-size: 10px; display: flex; align-items: center; justify-content: center; color: ${d.count > 0 ? '#000' : '#666'}; ${isToday ? 'border: 1px solid #fff;' : ''}">${dayLabels[dayIndex]}</div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #888; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“ REVIEWS TODAY</p>
                        <div style="font-size: 20px; font-weight: bold; color: #fff;">${studyLog[todayStr] || 0}</div>
                        <p style="font-size: 10px; color: #888;">cards</p>
                    </div>
                    <div style="background: rgba(${leitnerDueCards.length > 0 ? '245,101,101' : '72,187,120'},0.1); border: 2px solid ${leitnerDueCards.length > 0 ? '#f56565' : '#48bb78'}; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">â° OVERDUE</p>
                        <div style="font-size: 20px; font-weight: bold; color: ${leitnerDueCards.length > 0 ? '#f56565' : '#48bb78'};">${leitnerDueCards.length}</div>
                        <p style="font-size: 10px; color: #888;">need review</p>
                    </div>
                </div>
                
                <!-- Leitner Box Distribution -->
                ${totalLearning > 0 || leitnerMastered > 0 ? `
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="color: #9f7aea; font-size: 14px; margin-bottom: 15px;">ðŸ“¦ Leitner Box Distribution</h4>
                        <div style="display: flex; gap: 5px; align-items: end; height: 100px;">
                            ${[1,2,3,4,5,6,7,8].map(box => {
                                const count = boxCounts[box] || 0;
                                const maxCount = Math.max(...Object.values(boxCounts), 1);
                                const pct = maxCount > 0 ? (count / maxCount * 100) : 0;
                                const colors = ['#f56565', '#ed8936', '#ecc94b', '#48bb78', '#38b2ac', '#4299e1', '#9f7aea', '#d69e2e'];
                                const isDay4 = box === 4;
                                const brainIcon = isDay4 ? '<span style="font-size: 12px;">ðŸ§ </span>' : '';
                                const barGlow = isDay4 ? 'box-shadow: 0 0 10px #48bb78;' : '';
                                const labelStyle = isDay4 ? 'color: #48bb78; font-weight: bold;' : 'color: #888;';
                                const countStyle = isDay4 ? 'color: #48bb78; font-weight: bold;' : 'color: #fff;';
                                return `
                                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                        ${brainIcon}
                                        <span style="font-size: 12px; ${countStyle} margin-bottom: 3px;">${count}</span>
                                        <div style="width: 100%; background: ${colors[box-1]}; height: ${Math.max(pct, 8)}%; border-radius: 4px 4px 0 0; min-height: 8px; ${barGlow}"></div>
                                        <span style="font-size: 10px; ${labelStyle} margin-top: 5px;">${LEITNER_BOX_NAMES[box]}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: linear-gradient(135deg, rgba(72,187,120,0.15) 0%, rgba(56,178,172,0.15) 100%); border: 1px solid #48bb78; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">ðŸ§ </span>
                                <div>
                                    <p style="font-size: 11px; color: #48bb78; margin: 0; font-weight: bold;">Semi-Mastery = Halfway Point!</p>
                                    <p style="font-size: 10px; color: #888; margin: 2px 0 0 0;">Memory is now in the Neocortex. Recognition is fast and recall is reliable.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function closeAnalyticsDisplay() {
            document.getElementById('analyticsDisplayModal').classList.remove('active');
        }
        
        // ==================== EXISTING STUDENT SEARCH FUNCTIONS ====================
        
        let existingStudentsCache = [];
        
        function openExistingStudentSearch() {
            document.getElementById('existingStudentSearchInput').value = '';
            document.getElementById('existingStudentSearchResults').innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Enter a name or email to search...</p>';
            document.getElementById('existingStudentSearchModal').classList.add('active');
        }
        
        function closeExistingStudentSearch() {
            document.getElementById('existingStudentSearchModal').classList.remove('active');
        }
        
        async function searchExistingStudents() {
            const searchTerm = document.getElementById('existingStudentSearchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('existingStudentSearchResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Enter at least 2 characters to search...</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p style="color: #00ffff; font-size: 12px; text-align: center;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Searching...</p>';
            
            try {
                // Search in the users collection (students with accounts)
                const usersSnapshot = await db.collection('users').where('role', '==', 'student').get();
                
                const matchingUsers = [];
                const existingEmails = new Set(allStudents.map(s => s.email?.toLowerCase()));
                
                usersSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const email = (data.email || '').toLowerCase();
                    const displayName = (data.displayName || '').toLowerCase();
                    
                    // Check if matches search term
                    if (email.includes(searchTerm) || displayName.includes(searchTerm)) {
                        // Check if already in scheduler_students
                        const alreadyRegistered = existingEmails.has(email);
                        
                        matchingUsers.push({
                            uid: doc.id,
                            email: data.email,
                            displayName: data.displayName || email.split('@')[0],
                            phone: data.phoneNumber || data.phone || '',
                            discord: data.discord || '',
                            alreadyRegistered
                        });
                    }
                });
                
                if (matchingUsers.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 40px; margin-bottom: 15px;">ðŸ”</div>
                            <p style="color: #888; font-size: 13px;">No students found matching "${searchTerm}"</p>
                            <p style="color: #666; font-size: 12px; margin-top: 10px;">Try a different search term.</p>
                        </div>
                    `;
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <p style="font-size: 12px; color: #888; margin-bottom: 10px;">Found ${matchingUsers.length} student(s):</p>
                    <div style="display: grid; gap: 10px;">
                        ${matchingUsers.map(user => `
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid ${user.alreadyRegistered ? '#888' : '#00ffff'}; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-size: 14px; color: ${user.alreadyRegistered ? '#888' : '#00ffff'}; margin: 0 0 5px 0;">${user.displayName}</p>
                                        <p style="font-size: 12px; color: #888; margin: 0;">${user.email}</p>
                                    </div>
                                    ${user.alreadyRegistered ? `
                                        <span style="background: rgba(136,136,136,0.2); color: #888; padding: 6px 12px; border-radius: 5px; font-size: 12px;">Already Registered</span>
                                    ` : `
                                        <button class="btn btn-success btn-sm" onclick="openAddExistingStudentForm('${user.uid}', '${user.displayName.replace(/'/g, "\\'")}', '${user.email}', '${(user.phone || '').replace(/'/g, "\\'")}', '${(user.discord || '').replace(/'/g, "\\'")}')">âž• Add</button>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error searching students:', error);
                resultsDiv.innerHTML = `<p style="color: #ff3366; font-size: 12px; text-align: center;">Error searching: ${error.message}</p>`;
            }
        }
        
        function openAddExistingStudentForm(uid, name, email, phone, discord) {
            document.getElementById('addExistingStudentUid').value = uid;
            document.getElementById('addExistingStudentName').textContent = name;
            document.getElementById('addExistingStudentEmail').textContent = email;
            document.getElementById('addExistingStudentPhone').value = phone || '';
            document.getElementById('addExistingStudentDiscord').value = discord || '';
            document.getElementById('addExistingStudentCountry').value = 'US';
            document.getElementById('addExistingStudentTimezone').value = 'America/New_York';
            
            document.getElementById('existingStudentSearchModal').classList.remove('active');
            document.getElementById('addExistingStudentFormModal').classList.add('active');
        }
        
        function closeAddExistingStudentForm() {
            document.getElementById('addExistingStudentFormModal').classList.remove('active');
        }
        
        async function confirmAddExistingStudent() {
            const uid = document.getElementById('addExistingStudentUid').value;
            const name = document.getElementById('addExistingStudentName').textContent;
            const email = document.getElementById('addExistingStudentEmail').textContent;
            const phone = document.getElementById('addExistingStudentPhone').value.trim();
            const discord = document.getElementById('addExistingStudentDiscord').value.trim();
            const country = document.getElementById('addExistingStudentCountry').value;
            const timezone = document.getElementById('addExistingStudentTimezone').value;
            
            try {
                // Add to scheduler_students collection
                await db.collection('scheduler_students').add({
                    name: name,
                    email: email,
                    phone: phone,
                    discord: discord,
                    country: country,
                    timezone: timezone,
                    existingAccountUid: uid,
                    status: 'pending',
                    isReturningStudent: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`âœ… ${name} has been added to registered students!`);
                closeAddExistingStudentForm();
                loadAllStudents();
                
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student: ' + error.message);
            }
        }
        
        // ==================== CLASS COMPLETE REMINDER (Week 6 after all marked) ====================
        
        let classCompleteReminderShownFor = new Set(); // Track which classes we've shown reminder for
        
        async function checkClassAttendanceComplete(classId) {
            // Only check if it's week 6
            if (schedulerSettings.currentWeek !== 6) return;
            
            // Don't show again for same class in this session
            if (classCompleteReminderShownFor.has(classId)) return;
            
            const cls = allClasses.find(c => c.id === classId);
            if (!cls || !cls.students || cls.students.length === 0) return;
            
            try {
                // Get all attendance records for this class in week 6
                const attendanceSnap = await db.collection('scheduler_attendance')
                    .where('classId', '==', classId)
                    .where('week', '==', 6)
                    .get();
                
                const markedStudents = new Set(attendanceSnap.docs.map(d => d.data().studentId));
                const allMarked = cls.students.every(s => markedStudents.has(s.id));
                
                if (allMarked) {
                    classCompleteReminderShownFor.add(classId);
                    document.getElementById('classCompleteReminderModal').classList.add('active');
                }
            } catch (e) {
                console.error('Error checking class attendance complete:', e);
            }
        }
        
        function closeClassCompleteReminderModal() {
            document.getElementById('classCompleteReminderModal').classList.remove('active');
        }

        // ==================== DATABASE CLEANUP ====================
        
        let cleanupIssues = {
            orphanAssigned: [],      // Students marked 'assigned' but class doesn't exist
            orphanProposed: [],      // Students marked 'proposed' but proposal doesn't exist
            invalidClassRefs: [],    // Students with classId that doesn't exist
            invalidProposalRefs: []  // Students with proposalId that doesn't exist
        };
        
        async function scanForIssues() {
            const preview = document.getElementById('cleanupPreview');
            const issuesList = document.getElementById('cleanupIssuesList');
            const cleanBtn = document.getElementById('cleanOrphansBtn');
            
            issuesList.innerHTML = '<p style="font-size: 12px; color: #888;">Scanning...</p>';
            preview.style.display = 'block';
            
            // Reset issues
            cleanupIssues = {
                orphanAssigned: [],
                orphanProposed: [],
                invalidClassRefs: [],
                invalidProposalRefs: []
            };
            
            try {
                // Load fresh data from Firebase
                const [studentsSnap, classesSnap, proposalsSnap] = await Promise.all([
                    db.collection('scheduler_students').get(),
                    db.collection('scheduler_classes').get(),
                    db.collection('scheduler_proposals').get()
                ]);
                
                const students = studentsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                const classIds = new Set(classesSnap.docs.map(d => d.id));
                const proposalIds = new Set(proposalsSnap.docs.map(d => d.id));
                
                // Check each student
                for (const student of students) {
                    // Check for assigned status with non-existent class
                    if (student.status === 'assigned') {
                        if (!student.classId || !classIds.has(student.classId)) {
                            cleanupIssues.orphanAssigned.push(student);
                        }
                    }
                    
                    // Check for proposed status with non-existent proposal
                    if (student.status === 'proposed') {
                        if (!student.proposalId || !proposalIds.has(student.proposalId)) {
                            cleanupIssues.orphanProposed.push(student);
                        }
                    }
                    
                    // Check for classId reference to non-existent class
                    if (student.classId && !classIds.has(student.classId)) {
                        cleanupIssues.invalidClassRefs.push(student);
                    }
                    
                    // Check for proposalId reference to non-existent proposal
                    if (student.proposalId && !proposalIds.has(student.proposalId)) {
                        cleanupIssues.invalidProposalRefs.push(student);
                    }
                }
                
                // Build issues report
                const totalIssues = cleanupIssues.orphanAssigned.length + 
                                   cleanupIssues.orphanProposed.length;
                
                if (totalIssues === 0) {
                    issuesList.innerHTML = '<p style="font-size: 13px; color: #39ff14;">âœ… No issues found! Database is clean.</p>';
                    cleanBtn.disabled = true;
                } else {
                    let html = '';
                    
                    if (cleanupIssues.orphanAssigned.length > 0) {
                        html += `
                            <div style="margin-bottom: 10px;">
                                <p style="font-size: 12px; color: #ff3366;">âš ï¸ ${cleanupIssues.orphanAssigned.length} students marked "assigned" but class doesn't exist:</p>
                                <div style="margin-left: 10px;">
                                    ${cleanupIssues.orphanAssigned.map(s => `
                                        <span style="display: inline-block; padding: 3px 8px; margin: 2px; background: rgba(255,51,102,0.2); border-radius: 10px; font-size: 11px; color: #ff3366;">
                                            ${s.name} (classId: ${s.classId || 'null'})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (cleanupIssues.orphanProposed.length > 0) {
                        html += `
                            <div style="margin-bottom: 10px;">
                                <p style="font-size: 12px; color: #ffff00;">âš ï¸ ${cleanupIssues.orphanProposed.length} students marked "proposed" but proposal doesn't exist:</p>
                                <div style="margin-left: 10px;">
                                    ${cleanupIssues.orphanProposed.map(s => `
                                        <span style="display: inline-block; padding: 3px 8px; margin: 2px; background: rgba(255,255,0,0.2); border-radius: 10px; font-size: 11px; color: #ffff00;">
                                            ${s.name} (proposalId: ${s.proposalId || 'null'})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `<p style="font-size: 12px; color: #00ffff; margin-top: 10px;">Click "Clean Orphan Records" to fix these ${totalIssues} issue(s).</p>`;
                    
                    issuesList.innerHTML = html;
                    cleanBtn.disabled = false;
                }
                
            } catch (e) {
                console.error('Error scanning for issues:', e);
                issuesList.innerHTML = `<p style="font-size: 12px; color: #ff3366;">âŒ Error: ${e.message}</p>`;
                cleanBtn.disabled = true;
            }
        }
        
        async function cleanOrphanRecords() {
            const totalIssues = cleanupIssues.orphanAssigned.length + cleanupIssues.orphanProposed.length;
            
            if (totalIssues === 0) {
                alert('No issues to clean.');
                return;
            }
            
            if (!confirm(`This will reset ${totalIssues} orphan student record(s) to "pending" status. Continue?`)) return;
            
            try {
                let fixed = 0;
                
                // Fix orphan assigned students
                for (const student of cleanupIssues.orphanAssigned) {
                    await db.collection('scheduler_students').doc(student.id).update({
                        status: 'pending',
                        classId: null
                    });
                    fixed++;
                }
                
                // Fix orphan proposed students
                for (const student of cleanupIssues.orphanProposed) {
                    await db.collection('scheduler_students').doc(student.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    fixed++;
                }
                
                showMessage('cleanupMessage', `âœ… Fixed ${fixed} orphan record(s). Students reset to "pending" status.`, 'success');
                
                // Reload data
                await loadAllStudents();
                await loadAllClasses();
                await loadProposals();
                
                // Clear preview
                document.getElementById('cleanupPreview').style.display = 'none';
                document.getElementById('cleanOrphansBtn').disabled = true;
                
                // Reset issues
                cleanupIssues = {
                    orphanAssigned: [],
                    orphanProposed: [],
                    invalidClassRefs: [],
                    invalidProposalRefs: []
                };
                
            } catch (e) {
                console.error('Error cleaning orphan records:', e);
                showMessage('cleanupMessage', `âŒ Error: ${e.message}`, 'error');
            }
        }
        
        async function resetAllData() {
            if (!confirm('âš ï¸ WARNING: This will DELETE ALL students, classes, proposals, and attendance records. This cannot be undone!\n\nAre you absolutely sure?')) return;
            if (!confirm('âš ï¸ FINAL WARNING: All data will be permanently deleted. Type "DELETE" in the next prompt to confirm.')) return;
            
            const confirmation = prompt('Type "DELETE" to confirm:');
            if (confirmation !== 'DELETE') {
                alert('Reset cancelled.');
                return;
            }
            
            try {
                showMessage('cleanupMessage', 'ðŸ”„ Deleting all data...', 'info');
                
                // Delete all students
                const studentsSnap = await db.collection('scheduler_students').get();
                for (const doc of studentsSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all classes
                const classesSnap = await db.collection('scheduler_classes').get();
                for (const doc of classesSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all proposals
                const proposalsSnap = await db.collection('scheduler_proposals').get();
                for (const doc of proposalsSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all attendance records
                const attendanceSnap = await db.collection('scheduler_attendance').get();
                for (const doc of attendanceSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Reset local arrays
                allStudents = [];
                allClasses = [];
                allProposals = [];
                
                // Refresh UI
                renderStudentsTable();
                renderClasses();
                renderProposals();
                renderAvailableStudentsForProposals();
                updateDashboardStats();
                
                showMessage('cleanupMessage', 'âœ… All data has been deleted.', 'success');
                document.getElementById('cleanupPreview').style.display = 'none';
                
            } catch (e) {
                console.error('Error resetting data:', e);
                showMessage('cleanupMessage', `âŒ Error: ${e.message}`, 'error');
            }
        }

        // ==================== PROPOSALS ====================
        
        async function loadProposals() {
            try {
                const snap = await db.collection('scheduler_proposals').orderBy('createdAt', 'desc').get();
                allProposals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderProposals();
            } catch (e) {
                console.error('Error loading proposals:', e);
            }
        }
        
        function renderProposals() {
            const container = document.getElementById('proposalsContainer');
            if (!container) return;
            
            if (allProposals.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No proposals yet. Use "Auto-Generate Classes" to create proposals.</p>';
                return;
            }
            
            container.innerHTML = allProposals.map(p => {
                const teacher = allTeachers.find(t => t.id === p.teacherId);
                const statusLabel = {
                    'draft': 'Draft - Select Date',
                    'sent': 'Awaiting Responses',
                    'all_agreed': 'All Students Agreed! âœ“',
                    'has_rejections': 'Has Rejections'
                }[p.status] || p.status;
                
                const agreedCount = (p.students || []).filter(s => s.response === 'agreed').length;
                const rejectedCount = (p.students || []).filter(s => s.response === 'rejected').length;
                const pendingCount = (p.students || []).filter(s => s.response === 'pending').length;
                
                return `
                    <div class="proposal-card status-${p.status}" id="proposal-${p.id}">
                        <div class="proposal-header">
                            <div class="proposal-info">
                                <div class="proposal-day">${p.day} @ ${p.time}</div>
                                <div class="proposal-time">
                                    <span class="level-badge level-${p.level}">${LEVELS[p.level]}</span>
                                    ${teacher ? `<span style="margin-left: 10px;">ðŸ‘¨â€ðŸ« ${teacher.name}</span>` : '<span style="margin-left: 10px; color: #888;">No teacher assigned</span>'}
                                </div>
                            </div>
                            <span class="proposal-status ${p.status}">${statusLabel}</span>
                        </div>
                        
                        <div class="proposal-students" 
                            ondragover="handleProposalDragOver(event)" 
                            ondragleave="handleProposalDragLeave(event)" 
                            ondrop="handleProposalDrop(event, '${p.id}')"
                            data-proposal-id="${p.id}">
                            <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
                                Students: ${(p.students || []).length} 
                                ${p.status !== 'draft' ? `(âœ“ ${agreedCount} | âœ— ${rejectedCount} | â³ ${pendingCount})` : ''}
                            </div>
                            ${(p.students || []).map(s => `
                                <div class="proposal-student">
                                    <span class="proposal-student-name">${s.name}</span>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span class="proposal-student-response ${s.response}">${s.response === 'agreed' ? 'âœ“ Agreed' : s.response === 'rejected' ? 'âœ— Rejected' : 'â³ Pending'}</span>
                                        <button class="btn btn-sm btn-danger" onclick="removeStudentFromProposal('${p.id}', '${s.id}')" title="Remove from proposal" style="padding: 2px 5px; font-size: 10px;">âœ•</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${(p.students || []).length === 0 ? '<p style="color: #666; font-size: 11px; text-align: center;">Drop students here</p>' : ''}
                        </div>
                        
                        <div class="proposal-date-picker" style="${p.proposedStartDate ? 'background: rgba(57,255,20,0.1); border-color: #39ff14;' : ''}">
                            <label style="font-size: 12px; color: ${p.proposedStartDate ? '#39ff14' : '#ffff00'};">
                                ðŸ“… ${p.proposedStartDate ? 'Proposed Start Date:' : 'Select Proposed Start Date:'}
                            </label>
                            <input type="date" 
                                id="proposalDate-${p.id}" 
                                value="${p.proposedStartDate || ''}"
                                style="margin-left: 10px; font-family: 'Noto Sans', sans-serif; font-size: 12px; padding: 5px; background: #1a1a2e; color: ${p.proposedStartDate ? '#39ff14' : '#00ffff'}; border: 1px solid ${p.proposedStartDate ? '#39ff14' : '#00ffff'}; border-radius: 4px;" 
                                onchange="updateProposalDate('${p.id}', this.value)">
                            <div class="saturday-quick-btns" style="margin-top: 8px;">
                                ${getUpcomingSaturdaysHTML(p.id, p.proposedStartDate)}
                            </div>
                        </div>
                        
                        <div class="proposal-actions">
                            ${p.proposedStartDate ? `
                                <button class="btn btn-sm btn-success" onclick="initiateProposal('${p.id}')" style="background: linear-gradient(135deg, #39ff14, #00ff88);">ðŸš€ Initiate Class</button>
                            ` : ''}
                            ${p.status === 'draft' && p.proposedStartDate ? `
                                <button class="btn btn-sm btn-info" onclick="sendProposalToStudents('${p.id}')">ðŸ“§ Send to Students</button>
                            ` : ''}
                            <button class="btn btn-sm btn-warning" onclick="reclassProposal('${p.id}')">ðŸ”„ ReClass</button>
                            ${canDelete() ? `<button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteProposal('${p.id}')">ðŸ—‘ï¸ Delete</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderAvailableStudentsForProposals() {
            const container = document.getElementById('availableStudentsForProposals');
            if (!container) return;
            
            // Get students who are not assigned, not in proposals, and have a level
            const available = allStudents.filter(s => 
                s.level && 
                s.status !== 'assigned' && 
                s.status !== 'proposed' && 
                s.status !== 'completed'
            );
            
            if (available.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No available students.</p>';
                return;
            }
            
            container.innerHTML = available.map(s => {
                // Check if student is a good fit for any proposal
                const isGoodFit = allProposals.some(p => {
                    if (p.level !== s.level) return false;
                    const slot = `${p.day}-${p.time}`;
                    return Object.values(s.availabilities || {}).includes(slot);
                });
                
                const availSlots = Object.entries(s.availabilities || {})
                    .map(([rank, slot]) => `${rank}: ${slot}`)
                    .join(', ');
                
                return `
                    <div class="available-student ${isGoodFit ? 'rainbow-fit' : ''}" 
                        draggable="true" 
                        ondragstart="handleAvailableStudentDragStart(event, '${s.id}')"
                        ondragend="handleAvailableStudentDragEnd(event)"
                        data-student-id="${s.id}">
                        <div class="available-student-name">${s.name} ${isGoodFit ? 'ðŸŒˆ' : ''}</div>
                        <div class="available-student-info">
                            <span class="level-badge level-${s.level}" style="font-size: 10px; padding: 2px 4px;">${LEVELS[s.level]}</span>
                            <span style="margin-left: 5px;">${s.status || 'pending'}</span>
                        </div>
                        <div class="available-student-info" style="margin-top: 3px; font-size: 10px; color: #666;">
                            ${availSlots || 'No availability set'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Drag and drop for proposals
        function handleAvailableStudentDragStart(event, studentId) {
            draggedProposalStudentId = studentId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleAvailableStudentDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedProposalStudentId = null;
        }
        
        function handleProposalDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleProposalDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        async function handleProposalDrop(event, proposalId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedProposalStudentId) return;
            
            const student = allStudents.find(s => s.id === draggedProposalStudentId);
            const proposal = allProposals.find(p => p.id === proposalId);
            
            if (!student || !proposal) return;
            
            // Check level match
            if (student.level !== proposal.level) {
                if (!confirm(`Level mismatch: Student is ${LEVELS[student.level]}, class is ${LEVELS[proposal.level]}. Add anyway?`)) {
                    return;
                }
            }
            
            // Check if already in this proposal
            if ((proposal.students || []).some(s => s.id === student.id)) {
                alert('Student is already in this proposal.');
                return;
            }
            
            // Check availability match
            const slot = `${proposal.day}-${proposal.time}`;
            const availRank = Object.entries(student.availabilities || {}).find(([r, s]) => s === slot)?.[0] || 3;
            
            try {
                // Add student to proposal
                const newStudent = {
                    id: student.id,
                    name: student.name,
                    email: student.email,
                    discord: student.discord || '',
                    rank: parseInt(availRank),
                    timezone: student.timezone,
                    response: proposal.status === 'draft' ? 'pending' : 'pending'
                };
                
                proposal.students = proposal.students || [];
                proposal.students.push(newStudent);
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                // Update student status
                await db.collection('scheduler_students').doc(student.id).update({
                    status: 'proposed',
                    proposalId: proposalId
                });
                
                const idx = allStudents.findIndex(s => s.id === student.id);
                if (idx !== -1) {
                    allStudents[idx].status = 'proposed';
                    allStudents[idx].proposalId = proposalId;
                }
                
                renderProposals();
                renderAvailableStudentsForProposals();
            } catch (e) {
                console.error('Error adding student to proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function removeStudentFromProposal(proposalId, studentId) {
            if (!confirm('Remove this student from the proposal? They will be returned to the available students list.')) return;
            
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                proposal.students = (proposal.students || []).filter(s => s.id !== studentId);
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                // Update student status back to pending/limbo
                await db.collection('scheduler_students').doc(studentId).update({
                    status: 'pending',
                    proposalId: null
                });
                
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) {
                    allStudents[idx].status = 'pending';
                    allStudents[idx].proposalId = null;
                }
                
                // Recalculate proposal status
                await updateProposalStatus(proposalId);
                
                renderProposals();
                renderAvailableStudentsForProposals();
            } catch (e) {
                console.error('Error removing student:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function updateProposalDate(proposalId, date) {
            try {
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    proposedStartDate: date
                });
                
                const proposal = allProposals.find(p => p.id === proposalId);
                if (proposal) proposal.proposedStartDate = date;
                
                renderProposals();
            } catch (e) {
                console.error('Error updating proposal date:', e);
            }
        }
        
        async function sendProposalToStudents(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal || !proposal.proposedStartDate) {
                alert('Please select a proposed start date first.');
                return;
            }
            
            if ((proposal.students || []).length === 0) {
                alert('No students in this proposal.');
                return;
            }
            
            // Show Discord names modal
            showDiscordNamesModal(proposal);
        }
        
        function showDiscordNamesModal(proposal) {
            const students = proposal.students || [];
            const discordNames = students.map(s => s.discord || `${s.name} (no Discord)`).join('\n');
            const startDate = new Date(proposal.proposedStartDate).toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'discordNamesModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <button class="modal-close" onclick="closeDiscordNamesModal()">âœ•</button>
                    <h3 class="modal-title">ðŸ“‹ Discord Names to Contact</h3>
                    <p style="font-size: 12px; color: #888; margin-bottom: 15px;">
                        Class: <span style="color: #00ffff;">${proposal.day} @ ${proposal.time}</span> | 
                        Level: <span class="level-badge level-${proposal.level}">${LEVELS[proposal.level]}</span> |
                        Start: <span style="color: #39ff14;">${startDate}</span>
                    </p>
                    
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <textarea id="discordNamesList" readonly style="width: 100%; height: 150px; background: transparent; border: none; color: #fff; font-family: 'Noto Sans', sans-serif; font-size: 12px; resize: none; outline: none;">${discordNames}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-success" onclick="copyDiscordNames()">ðŸ“‹ Copy All Names</button>
                        <button class="btn btn-info" onclick="confirmSendProposal('${proposal.id}')">ðŸ“§ Mark as Sent</button>
                        <button class="btn btn-secondary" onclick="closeDiscordNamesModal()">Close</button>
                    </div>
                    
                    <p id="copyConfirmation" style="font-size: 12px; color: #39ff14; text-align: center; margin-top: 10px; display: none;">âœ“ Copied to clipboard!</p>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyDiscordNames() {
            const textarea = document.getElementById('discordNamesList');
            textarea.select();
            document.execCommand('copy');
            
            // Also try modern clipboard API
            navigator.clipboard.writeText(textarea.value).catch(() => {});
            
            const confirmation = document.getElementById('copyConfirmation');
            confirmation.style.display = 'block';
            setTimeout(() => confirmation.style.display = 'none', 2000);
        }
        
        function closeDiscordNamesModal() {
            const modal = document.getElementById('discordNamesModal');
            if (modal) modal.remove();
        }
        
        async function confirmSendProposal(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            try {
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    status: 'sent'
                });
                
                proposal.status = 'sent';
                closeDiscordNamesModal();
                renderProposals();
                
                alert(`Proposal marked as sent to ${proposal.students.length} students!`);
            } catch (e) {
                console.error('Error sending proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function updateProposalStatus(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal || proposal.status === 'draft') return;
            
            const students = proposal.students || [];
            const allAgreed = students.length > 0 && students.every(s => s.response === 'agreed');
            const hasRejections = students.some(s => s.response === 'rejected');
            
            let newStatus = 'sent';
            if (allAgreed) newStatus = 'all_agreed';
            else if (hasRejections) newStatus = 'has_rejections';
            
            if (newStatus !== proposal.status) {
                await db.collection('scheduler_proposals').doc(proposalId).update({ status: newStatus });
                proposal.status = newStatus;
            }
        }
        
        // Simulate student response (for testing - in production this would be done by students)
        async function simulateStudentResponse(proposalId, studentId, response) {
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                const student = proposal.students.find(s => s.id === studentId);
                if (student) student.response = response;
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                await updateProposalStatus(proposalId);
                renderProposals();
            } catch (e) {
                console.error('Error updating response:', e);
            }
        }
        
        async function proceedWithClass(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            const agreedStudents = (proposal.students || []).filter(s => s.response === 'agreed' || proposal.status === 'draft');
            
            if (agreedStudents.length < schedulerSettings.minStudents) {
                if (!confirm(`Only ${agreedStudents.length} students agreed (minimum is ${schedulerSettings.minStudents}). Proceed anyway?`)) return;
            }
            
            if (!proposal.proposedStartDate) {
                alert('Please set a start date before proceeding.');
                return;
            }
            
            try {
                // Create actual class from proposal
                const classData = {
                    day: proposal.day,
                    time: proposal.time,
                    level: proposal.level,
                    students: agreedStudents.map(s => ({
                        id: s.id,
                        name: s.name,
                        rank: s.rank,
                        timezone: s.timezone
                    })),
                    teacherId: proposal.teacherId,
                    startDate: proposal.proposedStartDate,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const classRef = await db.collection('scheduler_classes').add(classData);
                
                // Update students to assigned status
                for (const s of agreedStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'assigned',
                        classId: classRef.id,
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'assigned';
                        allStudents[idx].classId = classRef.id;
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Handle rejected students - return to pending
                const rejectedStudents = (proposal.students || []).filter(s => s.response === 'rejected');
                for (const s of rejectedStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                // Add to classes list
                allClasses.push({ id: classRef.id, ...classData });
                
                // Update settings with start date
                schedulerSettings.startDate = proposal.proposedStartDate;
                await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderClasses();
                updateDashboardStats();
                
                alert(`Class created successfully with ${agreedStudents.length} students!`);
            } catch (e) {
                console.error('Error creating class:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function initiateProposal(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            if (!proposal.proposedStartDate) {
                alert('Please set a start date before initiating this class.');
                return;
            }
            
            const students = proposal.students || [];
            if (students.length === 0) {
                alert('No students in this proposal.');
                return;
            }
            
            const startDateFormatted = new Date(proposal.proposedStartDate).toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
            });
            
            if (!confirm(`Initiate class?\n\nðŸ“… ${proposal.day} @ ${proposal.time}\nðŸ“š ${LEVELS[proposal.level]}\nðŸ‘¥ ${students.length} students\nðŸ—“ï¸ Starting: ${startDateFormatted}\n\nThis will create the class and add it to the schedule.`)) return;
            
            try {
                // Create actual class from proposal
                const classData = {
                    day: proposal.day,
                    time: proposal.time,
                    level: proposal.level,
                    students: students.map(s => ({
                        id: s.id,
                        name: s.name,
                        rank: s.rank,
                        timezone: s.timezone
                    })),
                    teacherId: proposal.teacherId,
                    startDate: proposal.proposedStartDate,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const classRef = await db.collection('scheduler_classes').add(classData);
                
                // Update students to assigned status
                for (const s of students) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'assigned',
                        classId: classRef.id,
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'assigned';
                        allStudents[idx].classId = classRef.id;
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                // Add to classes list
                allClasses.push({ id: classRef.id, ...classData });
                
                // Update settings with start date if not already set
                if (!schedulerSettings.startDate || proposal.proposedStartDate < schedulerSettings.startDate) {
                    schedulerSettings.startDate = proposal.proposedStartDate;
                    await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
                }
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderClasses();
                renderCourseCalendar();
                updateDashboardStats();
                
                alert(`âœ… Class initiated successfully!\n\n${proposal.day} @ ${proposal.time} with ${students.length} students has been added to the schedule.`);
                
            } catch (e) {
                console.error('Error initiating proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function reclassProposal(proposalId) {
            if (!confirm('This will disband the group and return all students to the available list. Continue?')) return;
            
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                // Return all students to pending
                for (const s of (proposal.students || [])) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderStudentsTable();
                updateDashboardStats();
            } catch (e) {
                console.error('Error reclassing proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteProposal(proposalId) {
            if (!confirm('Delete this proposal? Students will be returned to the available list.')) return;
            await reclassProposal(proposalId);
        }

        // ==================== SUGGESTIONS ====================
        
        let selectedPriority = '';
        
        function selectPriority(priority) {
            selectedPriority = priority;
            document.getElementById('suggestionPriority').value = priority;
            
            // Update button styles
            ['priorityHigh', 'priorityMid', 'priorityLow'].forEach(id => {
                document.getElementById(id).classList.remove('selected');
            });
            
            const btnId = priority === 'high' ? 'priorityHigh' : priority === 'mid' ? 'priorityMid' : 'priorityLow';
            document.getElementById(btnId).classList.add('selected');
        }
        
        async function submitSuggestion() {
            const title = document.getElementById('suggestionTitle').value.trim();
            const description = document.getElementById('suggestionDescription').value.trim();
            const priority = document.getElementById('suggestionPriority').value;
            
            if (!title) { showMessage('suggestionFormMessage', 'Please enter a title', 'error'); return; }
            if (!description) { showMessage('suggestionFormMessage', 'Please enter a description', 'error'); return; }
            if (!priority) { showMessage('suggestionFormMessage', 'Please select a priority level', 'error'); return; }
            
            // Get teacher ID (stored as odId for teachers)
            const teacherId = currentUser.odId || currentUser.id || currentUser.uid;
            
            try {
                await db.collection('scheduler_suggestions').add({
                    title,
                    description,
                    priority,
                    status: 'pending',
                    teacherId: teacherId,
                    teacherName: currentUser.name,
                    adminResponse: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    respondedAt: null
                });
                
                showMessage('suggestionFormMessage', 'Suggestion submitted successfully!', 'success');
                
                // Reset form
                document.getElementById('suggestionTitle').value = '';
                document.getElementById('suggestionDescription').value = '';
                document.getElementById('suggestionPriority').value = '';
                selectedPriority = '';
                ['priorityHigh', 'priorityMid', 'priorityLow'].forEach(id => {
                    document.getElementById(id).classList.remove('selected');
                });
                
                // Reload suggestions list
                loadTeacherSuggestions();
            } catch (e) {
                showMessage('suggestionFormMessage', 'Error: ' + e.message, 'error');
            }
        }
        
        async function loadTeacherSuggestions() {
            const container = document.getElementById('teacherSuggestionsContainer');
            if (!container || !currentUser) return;
            
            // Get teacher ID (stored as odId for teachers)
            const teacherId = currentUser.odId || currentUser.id || currentUser.uid;
            
            try {
                const snap = await db.collection('scheduler_suggestions')
                    .where('teacherId', '==', teacherId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (snap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No suggestions submitted yet.</p>';
                    return;
                }
                
                container.innerHTML = snap.docs.map(doc => {
                    const s = doc.data();
                    const date = s.createdAt ? new Date(s.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    const priorityLabel = s.priority === 'high' ? 'ðŸ”´ High' : s.priority === 'mid' ? 'ðŸŸ¡ Mid' : 'ðŸŸ¢ Low';
                    const statusLabel = s.status === 'pending' ? 'Pending Review' : s.status === 'approved' ? 'Approved âœ“' : 'Declined';
                    
                    return `
                        <div class="suggestion-card priority-${s.priority}">
                            <div class="suggestion-header">
                                <div class="suggestion-title">${s.title}</div>
                                <span class="suggestion-priority ${s.priority}">${priorityLabel}</span>
                            </div>
                            <div class="suggestion-body">${s.description}</div>
                            <div class="suggestion-meta">
                                <span>Submitted: ${date}</span>
                                <span class="suggestion-status ${s.status}">${statusLabel}</span>
                            </div>
                            ${s.adminResponse ? `
                                <div style="margin-top: 10px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 5px;">
                                    <p style="font-size: 11px; color: #00ffff; margin-bottom: 5px;">ðŸ“¬ Admin Response:</p>
                                    <p style="font-size: 12px; color: #ccc;">${s.adminResponse}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading teacher suggestions:', e);
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">Error loading suggestions.</p>';
            }
        }
        
        async function loadAdminSuggestions() {
            const container = document.getElementById('adminSuggestionsContainer');
            if (!container) return;
            
            try {
                const snap = await db.collection('scheduler_suggestions')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (snap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No suggestions yet.</p>';
                    return;
                }
                
                container.innerHTML = snap.docs.map(doc => {
                    const s = doc.data();
                    const date = s.createdAt ? new Date(s.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    const priorityLabel = s.priority === 'high' ? 'ðŸ”´ High' : s.priority === 'mid' ? 'ðŸŸ¡ Mid' : 'ðŸŸ¢ Low';
                    const statusLabel = s.status === 'pending' ? 'Pending Review' : s.status === 'approved' ? 'Approved âœ“' : 'Declined';
                    
                    return `
                        <div class="suggestion-card priority-${s.priority}">
                            <div class="suggestion-header">
                                <div class="suggestion-title">${s.title}</div>
                                <span class="suggestion-priority ${s.priority}">${priorityLabel}</span>
                            </div>
                            <div class="suggestion-body">${s.description}</div>
                            <div class="suggestion-meta">
                                <span>ðŸ‘¨â€ðŸ« ${s.teacherName} â€¢ ${date}</span>
                                <span class="suggestion-status ${s.status}">${statusLabel}</span>
                            </div>
                            ${s.status === 'pending' ? `
                                <div class="suggestion-actions">
                                    <button class="btn btn-sm btn-success" onclick="respondToSuggestion('${doc.id}', 'approved')">âœ“ Approve</button>
                                    <button class="btn btn-sm btn-danger" onclick="respondToSuggestion('${doc.id}', 'declined')">âœ— Decline</button>
                                </div>
                            ` : `
                                ${s.adminResponse ? `
                                    <div style="margin-top: 10px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 5px;">
                                        <p style="font-size: 11px; color: #00ffff; margin-bottom: 5px;">ðŸ“¬ Your Response:</p>
                                        <p style="font-size: 12px; color: #ccc;">${s.adminResponse}</p>
                                    </div>
                                ` : ''}
                            `}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading admin suggestions:', e);
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">Error loading suggestions.</p>';
            }
        }
        
        async function respondToSuggestion(suggestionId, status) {
            let adminResponse = '';
            
            if (status === 'approved') {
                adminResponse = prompt('Add a message (optional):', 'Approved! We will work on this.');
                if (adminResponse === null) return; // Cancelled
                if (!adminResponse) adminResponse = 'Approved! We will work on this.';
            } else {
                adminResponse = prompt('Reason for declining:', 'After careful consideration, it would take too many resources for this.');
                if (adminResponse === null) return; // Cancelled
                if (!adminResponse) adminResponse = 'After careful consideration, it would take too many resources for this.';
            }
            
            try {
                await db.collection('scheduler_suggestions').doc(suggestionId).update({
                    status,
                    adminResponse,
                    respondedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                loadAdminSuggestions();
            } catch (e) {
                console.error('Error responding to suggestion:', e);
                alert('Error: ' + e.message);
            }
        }

        // ==================== VIDEO RECORDING ====================
        
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStream = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let isRecording = false;
        
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        async function startRecording() {
            if (isRecording) return;
            
            try {
                // Request camera and microphone access with 720p
                recordingStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: true
                });
                
                // Show preview
                const preview = document.getElementById('videoPreview');
                const playback = document.getElementById('videoPlayback');
                preview.srcObject = recordingStream;
                preview.style.display = 'block';
                playback.style.display = 'none';
                
                // Setup recorder
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(recordingStream, { mimeType: 'video/webm' });
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    await uploadRecording(blob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                const btn = document.getElementById('recordBtn');
                btn.className = 'record-btn recording';
                btn.textContent = 'â¹ï¸ STOP RECORDING';
                document.getElementById('recordingSection').classList.add('recording');
                document.getElementById('recordingStatus').textContent = 'Recording in progress... Click button to stop.';
                
                // Start timer with 1-minute limit
                recordingSeconds = 0;
                document.getElementById('recordingTimer').style.display = 'block';
                updateRecordingTimer();
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    updateRecordingTimer();
                    
                    // Auto-stop at 1 minute
                    if (recordingSeconds >= 60) {
                        stopRecording();
                    }
                }, 1000);
                
            } catch (err) {
                console.error('Error starting recording:', err);
                alert('Could not access camera/microphone. Please allow access and try again.');
            }
        }
        
        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            isRecording = false;
            mediaRecorder.stop();
            
            // Stop all tracks
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            
            // Stop timer
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            // Update UI
            const btn = document.getElementById('recordBtn');
            btn.className = 'record-btn start';
            btn.textContent = 'ðŸŽ¤ RE-RECORD';
            document.getElementById('recordingSection').classList.remove('recording');
            document.getElementById('videoPreview').style.display = 'none';
            document.getElementById('recordingStatus').textContent = 'Processing video...';
        }
        
        function updateRecordingTimer() {
            const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
            const secs = (recordingSeconds % 60).toString().padStart(2, '0');
            document.getElementById('recordingTimer').textContent = `${mins}:${secs} / 01:00`;
        }
        
        async function uploadRecording(blob) {
            try {
                document.getElementById('recordingStatus').textContent = 'Uploading video...';
                
                // Generate unique filename
                const filename = `recordings/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.webm`;
                const storageRef = firebase.storage().ref().child(filename);
                
                // Upload to Firebase Storage
                const snapshot = await storageRef.put(blob);
                const downloadUrl = await snapshot.ref.getDownloadURL();
                
                // Store URL in hidden field
                document.getElementById('studentVideoUrl').value = downloadUrl;
                
                // Show playback
                const playback = document.getElementById('videoPlayback');
                playback.src = downloadUrl;
                playback.style.display = 'block';
                
                document.getElementById('recordingStatus').innerHTML = '<span style="color: #39ff14;">âœ… Video uploaded successfully!</span>';
                document.getElementById('recordingTimer').style.display = 'none';
                
            } catch (err) {
                console.error('Error uploading recording:', err);
                document.getElementById('recordingStatus').innerHTML = '<span style="color: #ff3366;">âŒ Upload failed. Please try again.</span>';
            }
        }

        // ==================== READY TAB FUNCTIONS ====================
        
        let allReadyRequests = [];
        let filteredReadyRequests = [];

        async function loadReadyRequests() {
            const listDiv = document.getElementById('readyRequestsList');
            listDiv.innerHTML = '<p style="color: #00ffff; font-size: 13px;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading requests...</p>';

            try {
                const snapshot = await db.collection('account_ready_requests')
                    .orderBy('submittedAt', 'desc')
                    .get();
                
                allReadyRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filteredReadyRequests = [...allReadyRequests];
                
                updateReadyDashboard();
                renderReadyRequests();
                
            } catch (error) {
                console.error('Error loading ready requests:', error);
                listDiv.innerHTML = `<p style="color: #ff3366; font-size: 13px;">Error: ${error.message}</p>`;
            }
        }

        function updateReadyDashboard() {
            const total = allReadyRequests.length;
            const pending = allReadyRequests.filter(r => !r.checkedOff).length;
            const completed = allReadyRequests.filter(r => r.checkedOff).length;
            
            document.getElementById('statTotalReady').textContent = total;
            document.getElementById('statPendingReady').textContent = pending;
            document.getElementById('statCompletedReady').textContent = completed;
        }

        function filterReadyRequests() {
            const searchTerm = document.getElementById('readySearch').value.toLowerCase();
            const filter = document.getElementById('readyFilter').value;

            filteredReadyRequests = allReadyRequests.filter(r => {
                const matchesSearch = (r.fullName || '').toLowerCase().includes(searchTerm) || 
                                     (r.email || '').toLowerCase().includes(searchTerm);
                
                let matchesFilter = true;
                if (filter === 'pending') matchesFilter = !r.checkedOff;
                if (filter === 'completed') matchesFilter = r.checkedOff;

                return matchesSearch && matchesFilter;
            });

            renderReadyRequests();
        }

        function renderReadyRequests() {
            const listDiv = document.getElementById('readyRequestsList');

            if (filteredReadyRequests.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 13px; color: #888; grid-column: 1/-1;">No requests found.</p>';
                return;
            }

            let html = '';
            filteredReadyRequests.forEach(r => {
                const isChecked = r.checkedOff;
                const borderColor = isChecked ? '#39ff14' : '#ff9800';
                const statusBadge = isChecked 
                    ? '<span style="background: #39ff14; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">âœ… ACCOUNT CREATED</span>'
                    : '<span style="background: #ff9800; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">â³ PENDING</span>';
                
                const submittedDate = r.submittedAt ? new Date(r.submittedAt.toDate()).toLocaleString() : 'N/A';
                
                const checkboxChecked = isChecked ? 'checked' : '';
                
                html += `
                    <div style="background: rgba(0,0,0,0.5); border: 2px solid ${borderColor}; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" ${checkboxChecked} onchange="toggleReadyCheckbox('${r.id}', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="color: #00ffff; font-size: 14px;">${r.fullName || 'Unknown'}</span>
                            </div>
                            ${statusBadge}
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ðŸ“§ ${r.email || 'No email'}</div>
                        <div style="font-size: 11px; color: #666; margin-bottom: 10px;">ðŸ“… Submitted: ${submittedDate}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <button class="btn btn-info btn-sm" onclick="generatePasswordForReady('${r.id}')">
                                ðŸ”‘ PW GEN
                            </button>
                            <span id="pwDisplay_${r.id}" style="font-size: 13px; color: #39ff14; padding: 5px 10px; background: rgba(0,0,0,0.5); border-radius: 4px; display: none;"></span>
                            <button class="btn btn-sm" style="background: #666;" onclick="copyReadyInfo('${escapeHtmlForAcct(r.fullName || '')}', '${escapeHtmlForAcct(r.email || '')}')">
                                ðŸ“‹ COPY INFO
                            </button>
                            <button class="btn btn-success btn-sm" onclick="completeReadyRequest('${r.id}', '${escapeHtmlForAcct(r.fullName || '')}')">
                                âœ… COMPLETE
                            </button>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        async function completeReadyRequest(requestId, fullName) {
            if (!confirm(`Mark "${fullName}" as complete and remove from the list?\n\nThis means the account has been created and this request is no longer needed.`)) {
                return;
            }

            try {
                await db.collection('account_ready_requests').doc(requestId).delete();
                
                // Remove from local arrays
                allReadyRequests = allReadyRequests.filter(r => r.id !== requestId);
                filteredReadyRequests = filteredReadyRequests.filter(r => r.id !== requestId);
                
                updateReadyDashboard();
                renderReadyRequests();
                
                alert(`âœ… "${fullName}" has been removed from the Ready list.`);
                
            } catch (error) {
                console.error('Error completing request:', error);
                alert('Error: ' + error.message);
            }
        }

        async function toggleReadyCheckbox(requestId, isChecked) {
            try {
                await db.collection('account_ready_requests').doc(requestId).update({
                    checkedOff: isChecked,
                    accountCreated: isChecked,
                    accountCreatedAt: isChecked ? firebase.firestore.FieldValue.serverTimestamp() : null
                });
                
                // Update local data
                const request = allReadyRequests.find(r => r.id === requestId);
                if (request) {
                    request.checkedOff = isChecked;
                    request.accountCreated = isChecked;
                }
                
                updateReadyDashboard();
                renderReadyRequests();
                
            } catch (error) {
                console.error('Error updating checkbox:', error);
                alert('Error updating status: ' + error.message);
            }
        }

        function generatePasswordForReady(requestId) {
            // Generate a random password: 2 words + 2 numbers + 1 symbol
            const words = ['Blue', 'Red', 'Green', 'Star', 'Moon', 'Sun', 'Fire', 'Ice', 'Wind', 'Rain', 'Cloud', 'Wave', 'Rock', 'Tree', 'Bird', 'Fish', 'Bear', 'Wolf', 'Lion', 'Tiger', 'Eagle', 'Hawk', 'Swift', 'Brave', 'Bold', 'Cool', 'Fast', 'Bright', 'Dark', 'Light'];
            const symbols = ['!', '@', '#', '$', '%', '&', '*'];
            
            const word1 = words[Math.floor(Math.random() * words.length)];
            const word2 = words[Math.floor(Math.random() * words.length)];
            const num = Math.floor(Math.random() * 90) + 10; // 10-99
            const symbol = symbols[Math.floor(Math.random() * symbols.length)];
            
            const password = `${word1}${word2}${num}${symbol}`;
            
            // Display the password
            const pwDisplay = document.getElementById(`pwDisplay_${requestId}`);
            pwDisplay.textContent = password;
            pwDisplay.style.display = 'inline-block';
            
            // Copy to clipboard
            navigator.clipboard.writeText(password).then(() => {
                // Flash green to indicate copied
                pwDisplay.style.background = 'rgba(57,255,20,0.3)';
                setTimeout(() => {
                    pwDisplay.style.background = 'rgba(0,0,0,0.5)';
                }, 500);
            });
        }

        function copyReadyInfo(fullName, email) {
            const info = `Name: ${fullName}\nEmail: ${email}`;
            navigator.clipboard.writeText(info).then(() => {
                alert('âœ… Info copied to clipboard!');
            });
        }

        // ==================== END READY TAB FUNCTIONS ====================

        // ==================== SLOT MANAGER FUNCTIONS ====================
        
        let selectedSlotInfo = null;
        let templateUploadedImages = [];
        let classTemplates = {}; // Cache for loaded templates
        
        // Use existing TIME_SLOTS and DAYS variables from schedule
        
        async function initSlotManager() {
            // Populate teacher dropdown
            const teacherSelect = document.getElementById('slotManagerTeacher');
            if (teacherSelect) {
                teacherSelect.innerHTML = '<option value="">-- All Teachers --</option>' + 
                    allTeachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }
            
            // Load prescheduled slots from Firebase
            await loadPrescheduledSlots();
            
            // Initialize Sales Chat
            await initSalesChat();
            
            // Load class template for first class type
            loadClassTemplate();
            
            renderSlotGrid();
        }
        
        async function loadPrescheduledSlots() {
            try {
                const snapshot = await db.collection('prescheduled_slots').get();
                allPrescheduledSlots = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Loaded prescheduled slots:', allPrescheduledSlots.length);
            } catch (e) {
                console.error('Error loading prescheduled slots:', e);
                allPrescheduledSlots = [];
            }
        }
        
        function renderSlotGrid() {
            const container = document.getElementById('slotGridContainer');
            const selectedTeacherId = document.getElementById('slotManagerTeacher')?.value || '';
            const weeksToShow = parseInt(document.getElementById('slotManagerView')?.value || '8');
            
            const relevantTeachers = selectedTeacherId 
                ? allTeachers.filter(t => t.id === selectedTeacherId)
                : allTeachers;
            
            if (relevantTeachers.length === 0) {
                container.innerHTML = '<p style="color: #888;">No teachers available. Add teachers first.</p>';
                return;
            }
            
            // Build slot status map
            const slotStatus = {}; // key: "day-time" -> { status, class, teacherId, availableDate, week, prescheduled }
            
            const now = new Date();
            
            // First, check for prescheduled slots
            allPrescheduledSlots.forEach(ps => {
                const key = `${ps.day}-${ps.time}`;
                const startDate = ps.startDate ? new Date(ps.startDate) : null;
                
                // Check if the prescheduled class has started (startDate is in the past)
                if (startDate && startDate <= now) {
                    // This prescheduled slot has started, it should now be shown as occupied
                    // The actual class should have been created, so we skip this
                    return;
                }
                
                if (!selectedTeacherId || ps.teacherId === selectedTeacherId) {
                    slotStatus[key] = {
                        status: 'prescheduled',
                        prescheduled: ps,
                        teacherId: ps.teacherId,
                        teacherName: ps.teacherName || allTeachers.find(t => t.id === ps.teacherId)?.name || 'Unknown',
                        classType: ps.classType,
                        startDate: startDate
                    };
                }
            });
            
            // Then check active classes
            allClasses.forEach(cls => {
                if (cls.status === 'completed') return;
                
                const key = `${cls.day}-${cls.time}`;
                
                // Skip if already marked as prescheduled (prescheduled takes visual priority until class starts)
                if (slotStatus[key]?.status === 'prescheduled') {
                    // Check if class has actually started
                    const clsStart = cls.startDate ? new Date(cls.startDate) : null;
                    if (clsStart && clsStart <= now) {
                        // Class has started, override prescheduled status
                    } else {
                        return; // Keep prescheduled status
                    }
                }
                
                const startDate = cls.startDate ? new Date(cls.startDate) : null;
                
                let currentWeek = 0;
                let weeksTotal = getLevelWeeks(cls.level) || 6;
                let endDate = null;
                
                if (startDate) {
                    const daysDiff = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                    currentWeek = Math.floor(daysDiff / 7) + 1;
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (weeksTotal * 7));
                }
                
                let status = 'occupied'; // red
                if (currentWeek >= weeksTotal) {
                    status = 'available'; // green - class has ended
                } else if (currentWeek >= weeksTotal - 1) {
                    status = 'ending'; // yellow - ending soon
                }
                
                // Only track if teacher matches filter (or no filter)
                if (!selectedTeacherId || cls.teacherId === selectedTeacherId) {
                    slotStatus[key] = {
                        status,
                        class: cls,
                        teacherId: cls.teacherId,
                        teacherName: allTeachers.find(t => t.id === cls.teacherId)?.name || 'Unassigned',
                        availableDate: endDate,
                        week: currentWeek,
                        weeksTotal
                    };
                }
            });
            
            // Build grid HTML
            let html = '';
            
            DAYS.forEach(day => {
                html += `<div style="margin-bottom: 20px;">`;
                html += `<h4 style="color: #00ffff; margin-bottom: 10px;">${day}</h4>`;
                html += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">`;
                
                TIME_SLOTS.forEach(time => {
                    const key = `${day}-${time}`;
                    const slot = slotStatus[key];
                    
                    let bgColor, borderColor, statusText, statusIcon, clickable = true, xBadge = '';
                    
                    if (slot?.status === 'prescheduled') {
                        // Get enrollment data
                        const ps = slot.prescheduled;
                        const enrolledCount = ps?.enrolledStudents?.length || 0;
                        const maxSeats = ps?.maxSeats || salesChatSettings?.defaultMaxSeats || 5;
                        const isFull = enrolledCount >= maxSeats;
                        
                        if (isFull) {
                            // FULL - show as pink/magenta
                            bgColor = 'rgba(233,30,99,0.3)';
                            borderColor = '#e91e63';
                            statusText = 'FULL';
                            statusIcon = 'ðŸ”´';
                        } else {
                            // Pre-scheduled with seats available
                            bgColor = 'rgba(255,152,0,0.3)';
                            borderColor = '#ff9800';
                            statusText = `${enrolledCount}/${maxSeats} seats`;
                            statusIcon = 'ðŸŸ ';
                        }
                        const classTypeName = LEVELS[slot.classType] || slot.classType || 'Class';
                        xBadge = `<div style="font-size: 9px; color: ${isFull ? '#e91e63' : '#ff9800'}; margin-top: 3px;">${classTypeName}</div>`;
                    } else if (!slot) {
                        // Check if any teacher is available for this day
                        const availableTeacher = relevantTeachers.find(t => (t.availableDays || []).includes(day));
                        if (availableTeacher) {
                            bgColor = 'rgba(57,255,20,0.2)';
                            borderColor = '#39ff14';
                            statusText = 'Available';
                            statusIcon = 'ðŸŸ¢';
                        } else {
                            bgColor = 'rgba(136,136,136,0.2)';
                            borderColor = '#888';
                            statusText = 'No Teacher';
                            statusIcon = 'âš«';
                            clickable = false;
                        }
                    } else if (slot.status === 'available') {
                        bgColor = 'rgba(57,255,20,0.2)';
                        borderColor = '#39ff14';
                        statusText = 'Available';
                        statusIcon = 'ðŸŸ¢';
                    } else if (slot.status === 'ending') {
                        bgColor = 'rgba(255,255,0,0.2)';
                        borderColor = '#ffff00';
                        statusText = `Week ${slot.week}/${slot.weeksTotal}`;
                        statusIcon = 'ðŸŸ¡';
                    } else {
                        bgColor = 'rgba(255,51,102,0.2)';
                        borderColor = '#ff3366';
                        statusText = `Week ${slot.week}/${slot.weeksTotal}`;
                        statusIcon = 'ðŸ”´';
                    }
                    
                    const availDateStr = slot?.availableDate 
                        ? `Opens: ${slot.availableDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                        : '';
                    
                    const classInfo = slot?.class 
                        ? `<div style="font-size: 10px; color: #888; margin-top: 3px;">${LEVELS[slot.class.level] || slot.class.level}</div>`
                        : '';
                    
                    const teacherInfo = slot?.teacherName && slot.status !== 'prescheduled'
                        ? `<div style="font-size: 9px; color: #666; margin-top: 2px;">ðŸ‘¨â€ðŸ« ${slot.teacherName}</div>`
                        : (slot?.status === 'prescheduled' ? `<div style="font-size: 9px; color: ${slot.prescheduled?.enrolledStudents?.length >= (slot.prescheduled?.maxSeats || 5) ? '#e91e63' : '#ff9800'}; margin-top: 2px;">ðŸ‘¨â€ðŸ« ${slot.teacherName}</div>` : '');
                    
                    const startDateInfo = slot?.status === 'prescheduled' && slot.startDate
                        ? `<div style="font-size: 9px; color: ${slot.prescheduled?.enrolledStudents?.length >= (slot.prescheduled?.maxSeats || 5) ? '#e91e63' : '#ff9800'};">Starts: ${slot.startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>`
                        : '';
                    
                    html += `
                        <div class="slot-card" onclick="${clickable ? `openSlotDetails('${day}', '${time}')` : ''}" 
                             style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 10px; 
                                    cursor: ${clickable ? 'pointer' : 'not-allowed'}; transition: all 0.2s; text-align: center; position: relative;">
                            ${xBadge}
                            <div style="font-size: 14px; font-weight: bold; color: #fff;">${time}</div>
                            <div style="font-size: 18px; margin: 5px 0;">${statusIcon}</div>
                            <div style="font-size: 11px; color: ${borderColor};">${statusText}</div>
                            ${classInfo}
                            ${teacherInfo}
                            ${startDateInfo}
                            ${slot?.status === 'ending' || slot?.status === 'occupied' ? `<div style="font-size: 9px; color: #ff9800; margin-top: 3px;">${availDateStr}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            
            // Update forecast and workload
            renderSlotForecast(slotStatus, weeksToShow);
            renderTeacherWorkload();
            renderSlotAnalytics();
        }
        
        function renderSlotForecast(slotStatus, weeksToShow) {
            const forecastDiv = document.getElementById('slotForecast');
            const now = new Date();
            
            // Group by weeks until available
            const weekBuckets = {};
            
            Object.entries(slotStatus).forEach(([key, slot]) => {
                if (slot.status === 'ending' || slot.status === 'occupied') {
                    if (slot.availableDate) {
                        const weeksUntil = Math.ceil((slot.availableDate - now) / (1000 * 60 * 60 * 24 * 7));
                        if (weeksUntil > 0 && weeksUntil <= weeksToShow) {
                            if (!weekBuckets[weeksUntil]) weekBuckets[weeksUntil] = [];
                            weekBuckets[weeksUntil].push({ key, slot });
                        }
                    }
                }
            });
            
            // Count currently available
            const availableNow = Object.values(slotStatus).filter(s => s.status === 'available').length;
            const totalSlots = DAYS.length * TIME_SLOTS.length;
            const occupiedSlots = Object.keys(slotStatus).length;
            const openSlots = totalSlots - occupiedSlots;
            
            let html = `<div style="margin-bottom: 10px;"><strong style="color: #39ff14;">${availableNow + openSlots} slots available now</strong></div>`;
            
            // Count prescheduled
            const prescheduledCount = Object.values(slotStatus).filter(s => s.status === 'prescheduled').length;
            if (prescheduledCount > 0) {
                html += `<div style="margin-bottom: 10px; color: #ff9800;">${prescheduledCount} slots pre-scheduled</div>`;
            }
            
            const sortedWeeks = Object.keys(weekBuckets).map(Number).sort((a, b) => a - b);
            
            if (sortedWeeks.length === 0) {
                html += `<p style="color: #888;">No upcoming slot openings in the next ${weeksToShow} weeks.</p>`;
            } else {
                sortedWeeks.forEach(week => {
                    const slots = weekBuckets[week];
                    html += `<div style="margin: 8px 0; padding: 8px; background: rgba(255,255,0,0.1); border-radius: 5px;">`;
                    html += `<strong style="color: #ffff00;">In ${week} week${week > 1 ? 's' : ''}:</strong> ${slots.length} slot${slots.length > 1 ? 's' : ''} opening`;
                    html += `<div style="font-size: 11px; color: #888; margin-top: 5px;">`;
                    html += slots.map(s => `${s.key.replace('-', ' @ ')}`).join(', ');
                    html += `</div></div>`;
                });
            }
            
            forecastDiv.innerHTML = html;
        }
        
        function renderTeacherWorkload() {
            const workloadDiv = document.getElementById('teacherWorkload');
            
            const teacherHours = {};
            allTeachers.forEach(t => {
                teacherHours[t.id] = { name: t.name, classes: 0, hours: 0, prescheduled: 0 };
            });
            
            allClasses.forEach(cls => {
                if (cls.status === 'completed') return;
                if (cls.teacherId && teacherHours[cls.teacherId]) {
                    teacherHours[cls.teacherId].classes++;
                    teacherHours[cls.teacherId].hours += 1; // Assuming 1 hour per class
                }
            });
            
            // Count prescheduled
            allPrescheduledSlots.forEach(ps => {
                if (ps.teacherId && teacherHours[ps.teacherId]) {
                    teacherHours[ps.teacherId].prescheduled++;
                }
            });
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">';
            
            Object.values(teacherHours).forEach(t => {
                const loadColor = t.classes > 6 ? '#ff3366' : (t.classes > 4 ? '#ffff00' : '#39ff14');
                html += `
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; border-left: 3px solid ${loadColor};">
                        <div style="font-weight: bold; color: #00ffff;">${t.name}</div>
                        <div style="font-size: 12px; color: #888;">${t.classes} active classes</div>
                        ${t.prescheduled > 0 ? `<div style="font-size: 11px; color: #ff9800;">${t.prescheduled} pre-scheduled</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            workloadDiv.innerHTML = html;
        }
        
        function renderSlotAnalytics() {
            const analyticsDiv = document.getElementById('slotAnalytics');
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="color: #39ff14; font-weight: bold; margin-bottom: 5px;">ðŸ“ˆ Highest Attendance Slots</div>
                        <div style="font-size: 11px; color: #888;">Based on student presence data</div>
                        <div style="margin-top: 5px; font-size: 12px;">
                            Requires attendance data...
                        </div>
                    </div>
                    <div>
                        <div style="color: #ff3366; font-weight: bold; margin-bottom: 5px;">ðŸ“‰ Highest Absence Slots</div>
                        <div style="font-size: 11px; color: #888;">Slots with most student absences</div>
                        <div style="margin-top: 5px; font-size: 12px;">
                            Requires attendance data...
                        </div>
                    </div>
                </div>
            `;
            
            analyticsDiv.innerHTML = html;
        }
        
        function openSlotDetails(day, time) {
            const key = `${day}-${time}`;
            const selectedTeacherId = document.getElementById('slotManagerTeacher')?.value || '';
            
            // Check for prescheduled slot first
            const prescheduled = allPrescheduledSlots.find(ps => ps.day === day && ps.time === time);
            
            // Find class info for this slot
            const cls = allClasses.find(c => c.day === day && c.time === time && c.status !== 'completed' && 
                (!selectedTeacherId || c.teacherId === selectedTeacherId));
            
            const teacher = cls ? allTeachers.find(t => t.id === cls.teacherId) : 
                (prescheduled ? allTeachers.find(t => t.id === prescheduled.teacherId) :
                allTeachers.find(t => (t.availableDays || []).includes(day)));
            
            selectedSlotInfo = { day, time, class: cls, teacher, prescheduled };
            
            document.getElementById('slotDetailsTitle').textContent = `ðŸ“… ${day} @ ${time} EST`;
            
            // Hide all sections initially
            document.getElementById('slotStudentRoster').style.display = 'none';
            document.getElementById('slotDateSelection').style.display = 'none';
            document.getElementById('slotPrescheduleInfo').style.display = 'none';
            document.getElementById('prescheduleForm').style.display = 'none';
            
            let html = '';
            
            if (prescheduled && !cls) {
                // Show prescheduled info
                const startDate = prescheduled.startDate ? new Date(prescheduled.startDate) : null;
                const classTypeName = LEVELS[prescheduled.classType] || prescheduled.classType || 'Class';
                const enrolledCount = prescheduled.enrolledStudents?.length || 0;
                const maxSeats = prescheduled.maxSeats || salesChatSettings?.defaultMaxSeats || 5;
                const isFull = enrolledCount >= maxSeats;
                
                // Build seat dots visualization
                let seatDots = '';
                for (let i = 0; i < maxSeats; i++) {
                    seatDots += `<span style="display: inline-block; width: 12px; height: 12px; margin: 0 2px; border-radius: 3px; ${i < enrolledCount ? 'background: #ff9800;' : 'background: rgba(57,255,20,0.3); border: 1px solid #39ff14;'}"></span>`;
                }
                
                // Build enrolled students list
                let studentsHtml = '';
                if (enrolledCount > 0) {
                    studentsHtml = `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 12px; color: #aeb8de; margin-bottom: 8px;">ðŸ‘¥ Enrolled Students (${enrolledCount}/${maxSeats}):</div>
                            ${prescheduled.enrolledStudents.map((s, i) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 5px;">
                                    <span style="color: #fff; font-size: 12px;">${escapeHtml(s.name)}</span>
                                    <button onclick="removeStudentFromPrescheduled('${prescheduled.id}', ${i})" style="background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5; padding: 3px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">Remove</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                html = `
                    <div style="background: rgba(255,152,0,0.2); border: 2px solid #ff9800; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">${isFull ? 'ðŸ”´' : 'ðŸŸ '}</div>
                        <div style="color: ${isFull ? '#e91e63' : '#ff9800'}; font-weight: bold; font-size: 16px;">${isFull ? 'FULL' : 'Pre-scheduled'}</div>
                        <div style="color: #fff; margin-top: 10px;">
                            <div><strong>Class:</strong> ${classTypeName}</div>
                            <div><strong>Teacher:</strong> ${prescheduled.teacherName || 'Unknown'}</div>
                            ${startDate ? `<div><strong>Starts:</strong> ${startDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</div>` : ''}
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="font-size: 12px; color: #aeb8de; margin-bottom: 5px;">Seats: ${enrolledCount}/${maxSeats}</div>
                            <div>${seatDots}</div>
                        </div>
                        
                        ${studentsHtml}
                        
                        <button onclick="openSalesChatFromSlotModal()" style="margin-top: 20px; width: 100%; padding: 12px 20px; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,244,200,0.7)); border: none; border-radius: 10px; color: rgba(12,14,30,0.95); font-size: 14px; font-weight: bold; cursor: pointer;">
                            ðŸ’¬ Open Sales Chat
                        </button>
                    </div>
                `;
                
                // Show preschedule info section with cancel button
                document.getElementById('slotPrescheduleInfo').style.display = 'block';
                document.getElementById('prescheduleDetails').innerHTML = `
                    <div style="font-size: 13px;">
                        <div><strong>Class Type:</strong> ${classTypeName}</div>
                        <div><strong>Teacher:</strong> ${prescheduled.teacherName}</div>
                        ${startDate ? `<div><strong>Start Date:</strong> ${startDate.toLocaleDateString()}</div>` : ''}
                    </div>
                `;
                
            } else if (cls) {
                // Show occupied class info with students
                const startDate = cls.startDate ? new Date(cls.startDate) : null;
                const weeksTotal = getLevelWeeks(cls.level) || 6;
                let currentWeek = 0;
                let endDate = null;
                
                if (startDate) {
                    const now = new Date();
                    const daysDiff = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                    currentWeek = Math.floor(daysDiff / 7) + 1;
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (weeksTotal * 7));
                }
                
                const statusColor = currentWeek >= weeksTotal ? '#39ff14' : (currentWeek >= weeksTotal - 1 ? '#ffff00' : '#ff3366');
                const statusText = currentWeek >= weeksTotal ? 'Completed' : (currentWeek >= weeksTotal - 1 ? 'Ending Soon' : 'In Progress');
                
                html = `
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span class="level-badge level-${cls.level}">${LEVELS[cls.level] || cls.level}</span>
                            <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                        </div>
                        <div style="font-size: 13px; margin-bottom: 5px;">
                            <strong>Teacher:</strong> ${teacher?.name || 'Unassigned'}
                        </div>
                        <div style="font-size: 13px; margin-bottom: 5px;">
                            <strong>Progress:</strong> Week ${currentWeek} of ${weeksTotal}
                        </div>
                        ${startDate ? `<div style="font-size: 13px; margin-bottom: 5px;"><strong>Started:</strong> ${startDate.toLocaleDateString()}</div>` : ''}
                        ${endDate ? `<div style="font-size: 13px; margin-bottom: 5px;"><strong>Ends:</strong> ${endDate.toLocaleDateString()}</div>` : ''}
                        <div style="font-size: 13px;">
                            <strong>Students:</strong> ${cls.students?.length || 0}
                        </div>
                    </div>
                `;
                
                // Show student roster
                if (cls.students && cls.students.length > 0) {
                    document.getElementById('slotStudentRoster').style.display = 'block';
                    
                    // Get full student info from allStudents
                    let rosterHtml = '';
                    cls.students.forEach(s => {
                        const fullStudent = allStudents.find(st => st.id === s.id) || s;
                        rosterHtml += `
                            <tr>
                                <td style="padding: 8px;">${fullStudent.name || s.name || 'Unknown'}</td>
                                <td style="padding: 8px;">${fullStudent.phoneNumber || fullStudent.phone || '-'}</td>
                                <td style="padding: 8px;">${fullStudent.discord || '-'}</td>
                                <td style="padding: 8px;">${fullStudent.email || s.email || '-'}</td>
                            </tr>
                        `;
                    });
                    document.getElementById('slotStudentRosterBody').innerHTML = rosterHtml;
                }
                
                // Show date selection for next session
                showDateSelection(day, endDate, true);
                
            } else {
                // Empty slot - show available
                html = `
                    <div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ðŸŸ¢</div>
                        <div style="color: #39ff14; font-weight: bold; font-size: 16px;">Slot Available!</div>
                        <div style="color: #888; font-size: 12px; margin-top: 5px;">
                            ${teacher ? `Teacher: ${teacher.name}` : 'No teacher assigned to this day'}
                        </div>
                    </div>
                `;
                
                // Show date selection (3 weeks from today as buffer)
                const bufferDate = new Date();
                bufferDate.setDate(bufferDate.getDate() + 21); // 3 weeks
                showDateSelection(day, bufferDate, false);
            }
            
            document.getElementById('slotDetailsContent').innerHTML = html;
            document.getElementById('slotDetailsModal').classList.add('active');
        }
        
        function showDateSelection(day, baseDate, hasExistingClass) {
            document.getElementById('slotDateSelection').style.display = 'block';
            
            const now = new Date();
            let startFrom;
            
            if (hasExistingClass && baseDate) {
                // For occupied slots: start from when class ends
                startFrom = new Date(baseDate);
            } else {
                // For empty slots: start from today
                startFrom = new Date();
            }
            
            // Find the first matching day (Saturday or Sunday) on or after startFrom
            const targetDayNum = day === 'Saturday' ? 6 : 0;
            while (startFrom.getDay() !== targetDayNum) {
                startFrom.setDate(startFrom.getDate() + 1);
            }
            
            // If the first date is in the past, move to next week
            if (startFrom < now) {
                startFrom.setDate(startFrom.getDate() + 7);
            }
            
            // Calculate end date (3 weeks from startFrom)
            const endDate = new Date(startFrom);
            endDate.setDate(endDate.getDate() + 21); // 3 weeks
            
            // Generate date options within the 3 week window
            let optionsHtml = '';
            let currentDate = new Date(startFrom);
            let count = 0;
            
            while (currentDate <= endDate && count < 5) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const label = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const dayLabel = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                optionsHtml += `
                    <button type="button" class="btn btn-sm date-option-btn" 
                            onclick="selectScheduleDate('${dateStr}')"
                            style="background: rgba(57,255,20,0.2); border: 1px solid #39ff14; color: #39ff14;">
                        ${dayLabel}, ${label}
                    </button>
                `;
                
                currentDate.setDate(currentDate.getDate() + 7); // Next week
                count++;
            }
            
            // Update the description text
            const descText = hasExistingClass 
                ? `Select a start date (available dates within 3 weeks after class ends):`
                : `Select a start date (available dates within the next 3 weeks):`;
            
            document.getElementById('slotDateOptions').innerHTML = optionsHtml;
            document.querySelector('#slotDateSelection p').textContent = descText;
            
            // Populate preschedule form dropdowns
            const classTypeSelect = document.getElementById('prescheduleClassType');
            const teacherSelect = document.getElementById('prescheduleTeacher');
            
            if (classTypeSelect) {
                // Get levels from existing LEVELS object or data-level-select elements
                let options = '<option value="">-- Select Class Type --</option>';
                Object.entries(LEVELS).forEach(([key, name]) => {
                    options += `<option value="${key}">${name}</option>`;
                });
                classTypeSelect.innerHTML = options;
            }
            
            if (teacherSelect) {
                let options = '<option value="">-- Select Teacher --</option>';
                allTeachers.forEach(t => {
                    if ((t.availableDays || []).includes(selectedSlotInfo.day)) {
                        options += `<option value="${t.id}">${t.name}</option>`;
                    }
                });
                teacherSelect.innerHTML = options;
                
                // Pre-select current teacher if available
                if (selectedSlotInfo.teacher) {
                    teacherSelect.value = selectedSlotInfo.teacher.id;
                }
            }
        }
        
        let selectedScheduleDateValue = null;
        
        function selectScheduleDate(dateStr) {
            selectedScheduleDateValue = dateStr;
            
            // Update button styles
            document.querySelectorAll('.date-option-btn').forEach(btn => {
                btn.style.background = 'rgba(57,255,20,0.2)';
                btn.style.borderColor = '#39ff14';
            });
            event.target.style.background = '#39ff14';
            event.target.style.borderColor = '#39ff14';
            event.target.style.color = '#000';
            
            // Show preschedule form
            document.getElementById('prescheduleForm').style.display = 'block';
        }
        
        async function confirmPreschedule() {
            if (!selectedScheduleDateValue) {
                alert('Please select a date first.');
                return;
            }
            
            const classType = document.getElementById('prescheduleClassType').value;
            const teacherId = document.getElementById('prescheduleTeacher').value;
            
            if (!classType) {
                alert('Please select a class type.');
                return;
            }
            
            if (!teacherId) {
                alert('Please select a teacher.');
                return;
            }
            
            const teacher = allTeachers.find(t => t.id === teacherId);
            
            try {
                const prescheduleData = {
                    day: selectedSlotInfo.day,
                    time: selectedSlotInfo.time,
                    startDate: selectedScheduleDateValue,
                    classType: classType,
                    teacherId: teacherId,
                    teacherName: teacher?.name || 'Unknown',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const ref = await db.collection('prescheduled_slots').add(prescheduleData);
                
                allPrescheduledSlots.push({ id: ref.id, ...prescheduleData });
                
                closeModal('slotDetailsModal');
                renderSlotGrid();
                
                alert(`âœ… Slot pre-scheduled!\n\n${selectedSlotInfo.day} @ ${selectedSlotInfo.time}\n${LEVELS[classType] || classType}\nTeacher: ${teacher?.name}\nStarts: ${new Date(selectedScheduleDateValue).toLocaleDateString()}`);
                
            } catch (e) {
                console.error('Error pre-scheduling slot:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function cancelPreschedule() {
            if (!selectedSlotInfo?.prescheduled) return;
            
            if (!confirm('Are you sure you want to cancel this pre-scheduled slot?')) return;
            
            try {
                await db.collection('prescheduled_slots').doc(selectedSlotInfo.prescheduled.id).delete();
                
                const idx = allPrescheduledSlots.findIndex(ps => ps.id === selectedSlotInfo.prescheduled.id);
                if (idx !== -1) allPrescheduledSlots.splice(idx, 1);
                
                closeModal('slotDetailsModal');
                renderSlotGrid();
                
                alert('âœ… Pre-schedule cancelled.');
                
            } catch (e) {
                console.error('Error cancelling preschedule:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        // Student email functions
        function copyStudentEmails() {
            if (!selectedSlotInfo?.class?.students) return;
            
            const emails = selectedSlotInfo.class.students
                .map(s => {
                    const fullStudent = allStudents.find(st => st.id === s.id) || s;
                    return fullStudent.email || s.email;
                })
                .filter(e => e)
                .join(', ');
            
            navigator.clipboard.writeText(emails).then(() => {
                alert('âœ… Emails copied to clipboard!\n\n' + emails);
            }).catch(err => {
                console.error('Copy failed:', err);
                prompt('Copy these emails:', emails);
            });
        }
        
        async function copyClassInfoEmail() {
            if (!selectedSlotInfo?.class) return;
            
            const cls = selectedSlotInfo.class;
            const classType = cls.level;
            const template = await getClassTemplate(classType);
            
            const day = selectedSlotInfo.day;
            const time = selectedSlotInfo.time;
            const timeConversions = convertTimeToAllZones(time);
            const startDate = cls.startDate ? new Date(cls.startDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'TBD';
            
            const className = LEVELS[classType] || classType || 'Class';
            
            let emailContent = `Subject: ${className} - Class Information

Hello!

Welcome to ${className}! Here are your class details:

ðŸ“… SCHEDULE
Day: Every ${day}
Starting: ${startDate}

â° CLASS TIMES (All US Timezones)
â€¢ Eastern (EST): ${time}
â€¢ Central (CST): ${timeConversions.CST}
â€¢ Mountain (MST): ${timeConversions.MST}
â€¢ Pacific (PST): ${timeConversions.PST}

`;
            
            if (template?.classLink) {
                emailContent += `ðŸ”— CLASS LINK
${template.classLink}

`;
            }
            
            if (template?.preparation) {
                emailContent += `ðŸ“ BEFORE CLASS - PLEASE PREPARE
${template.preparation}

`;
            }
            
            if (template?.images?.length > 0) {
                emailContent += `ðŸ“· Note: Reference images are attached to this email.

`;
            }
            
            emailContent += `See you in class!
KoreanLearnin Team`;
            
            navigator.clipboard.writeText(emailContent).then(() => {
                alert('âœ… Email content copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                prompt('Copy this email content:', emailContent);
            });
        }
        
        // Class Templates Functions
        async function loadClassTemplate() {
            const classType = document.getElementById('templateClassType')?.value;
            if (!classType) {
                document.getElementById('templateStatus').innerHTML = '<span style="color: #888;">Select a class type</span>';
                return;
            }
            
            try {
                const doc = await db.collection('class_templates').doc(classType).get();
                
                if (doc.exists) {
                    const template = doc.data();
                    classTemplates[classType] = template;
                    
                    document.getElementById('templateClassLink').value = template.classLink || '';
                    document.getElementById('templatePreparation').value = template.preparation || '';
                    
                    // Show images
                    if (template.images && template.images.length > 0) {
                        templateUploadedImages = template.images;
                        renderTemplateImages();
                    } else {
                        templateUploadedImages = [];
                        document.getElementById('templateImagePreview').innerHTML = '<p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>';
                    }
                    
                    document.getElementById('templateStatus').innerHTML = '<span style="color: #39ff14;">âœ“ Template loaded</span>';
                } else {
                    // Clear fields
                    document.getElementById('templateClassLink').value = '';
                    document.getElementById('templatePreparation').value = '';
                    templateUploadedImages = [];
                    document.getElementById('templateImagePreview').innerHTML = '<p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>';
                    
                    document.getElementById('templateStatus').innerHTML = '<span style="color: #ffff00;">No template saved yet</span>';
                }
            } catch (e) {
                console.error('Error loading template:', e);
                document.getElementById('templateStatus').innerHTML = '<span style="color: #ff3366;">Error loading template</span>';
            }
        }
        
        async function getClassTemplate(classType) {
            if (classTemplates[classType]) {
                return classTemplates[classType];
            }
            
            try {
                const doc = await db.collection('class_templates').doc(classType).get();
                if (doc.exists) {
                    classTemplates[classType] = doc.data();
                    return classTemplates[classType];
                }
            } catch (e) {
                console.error('Error getting template:', e);
            }
            
            return null;
        }
        
        async function saveClassTemplate() {
            const classType = document.getElementById('templateClassType')?.value;
            if (!classType) {
                alert('Please select a class type.');
                return;
            }
            
            const classLink = document.getElementById('templateClassLink')?.value || '';
            const preparation = document.getElementById('templatePreparation')?.value || '';
            
            try {
                const templateData = {
                    classLink,
                    preparation,
                    images: templateUploadedImages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('class_templates').doc(classType).set(templateData, { merge: true });
                
                classTemplates[classType] = templateData;
                
                document.getElementById('templateStatus').innerHTML = '<span style="color: #39ff14;">âœ“ Template saved!</span>';
                alert('âœ… Template saved successfully!');
                
            } catch (e) {
                console.error('Error saving template:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function deleteClassTemplate() {
            const classType = document.getElementById('templateClassType')?.value;
            if (!classType) {
                alert('Please select a class type.');
                return;
            }
            
            if (!confirm(`Delete template for ${LEVELS[classType] || classType}?`)) return;
            
            try {
                await db.collection('class_templates').doc(classType).delete();
                
                delete classTemplates[classType];
                
                document.getElementById('templateClassLink').value = '';
                document.getElementById('templatePreparation').value = '';
                templateUploadedImages = [];
                document.getElementById('templateImagePreview').innerHTML = '<p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>';
                
                document.getElementById('templateStatus').innerHTML = '<span style="color: #ffff00;">Template deleted</span>';
                alert('âœ… Template deleted.');
                
            } catch (e) {
                console.error('Error deleting template:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        function handleTemplateImageUpload(event) {
            const files = event.target.files;
            
            Array.from(files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    templateUploadedImages.push({ name: file.name, data: e.target.result });
                    renderTemplateImages();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function renderTemplateImages() {
            const previewDiv = document.getElementById('templateImagePreview');
            
            if (templateUploadedImages.length === 0) {
                previewDiv.innerHTML = '<p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>';
                return;
            }
            
            previewDiv.innerHTML = templateUploadedImages.map((img, idx) => `
                <div style="position: relative; display: inline-block;">
                    <img src="${img.data}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 2px solid #00ffff;">
                    <button onclick="removeTemplateImage(${idx})" style="position: absolute; top: -5px; right: -5px; background: #ff3366; color: #fff; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 10px;">âœ•</button>
                </div>
            `).join('');
        }
        
        function removeTemplateImage(idx) {
            templateUploadedImages.splice(idx, 1);
            renderTemplateImages();
        }
        
        function previewClassTemplate() {
            const classType = document.getElementById('templateClassType')?.value;
            const classLink = document.getElementById('templateClassLink')?.value || '';
            const preparation = document.getElementById('templatePreparation')?.value || '';
            
            const className = LEVELS[classType] || classType || '[Class Type]';
            
            let imagesHtml = '';
            if (templateUploadedImages.length > 0) {
                imagesHtml = `
                    <div style="margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px;">
                        <h3 style="color: #333; margin-bottom: 10px;">ðŸ“· Reference Images</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${templateUploadedImages.map(img => `<img src="${img.data}" style="max-width: 200px; max-height: 150px; border-radius: 5px; border: 1px solid #ddd;">`).join('')}
                        </div>
                    </div>
                `;
            }
            
            const previewHtml = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="color: #333; margin: 10px 0;">${className} Template</h1>
                </div>
                
                ${classLink ? `
                <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h2 style="color: #2e7d32; margin-bottom: 10px;">ðŸ”— Class Link</h2>
                    <p style="font-size: 14px; word-break: break-all;"><a href="${classLink}" style="color: #1976d2;">${classLink}</a></p>
                </div>
                ` : '<p style="color: #999;">No class link set</p>'}
                
                ${preparation ? `
                <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h2 style="color: #e65100; margin-bottom: 10px;">ðŸ“ Preparation Instructions</h2>
                    <p style="font-size: 14px; white-space: pre-wrap;">${preparation}</p>
                </div>
                ` : '<p style="color: #999;">No preparation instructions set</p>'}
                
                ${imagesHtml}
            `;
            
            document.getElementById('pdfPreviewContent').innerHTML = previewHtml;
            document.getElementById('pdfPreviewModal').classList.add('active');
        }
        
        // Shopify Listing Generator
        function openShopifyListingModal() {
            document.getElementById('shopifyListingModal').classList.add('active');
            generateShopifyListing();
        }
        
        function generateShopifyListing() {
            const classType = document.getElementById('shopifyClassType')?.value || '';
            const day = document.getElementById('shopifyClassDay')?.value || 'Saturday';
            const time = document.getElementById('shopifyClassTime')?.value || '6:30 PM';
            const startDate = document.getElementById('shopifyStartDate')?.value || '';
            const duration = document.getElementById('shopifyDuration')?.value || '6';
            const additionalText = document.getElementById('shopifyAdditionalText')?.value || '';
            const whatLearn = document.getElementById('shopifyWhatLearn')?.value || '';
            
            const className = LEVELS[classType] || classType || '[Class Type]';
            
            // Format date - use same approach as openSlotDetails
            const formattedDate = startDate ? new Date(startDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : '[Start Date]';
            
            // Convert EST to other timezones
            const timeConversions = convertTimeToAllZones(time);
            
            let listing = `ðŸ“š ${className} - ${duration}-Week Program

ðŸ“… SCHEDULE
${day}s starting ${formattedDate}

â° CLASS TIMES (All US Timezones)
â€¢ Eastern (EST): ${time}
â€¢ Central (CST): ${timeConversions.CST}
â€¢ Mountain (MST): ${timeConversions.MST}
â€¢ Pacific (PST): ${timeConversions.PST}

ðŸ“‹ PROGRAM DETAILS
â€¢ Duration: ${duration} weeks
â€¢ Day: Every ${day}
â€¢ Live interactive class via Zoom

`;
            
            if (whatLearn) {
                listing += `âœ¨ WHAT YOU'LL LEARN
${whatLearn}

`;
            }
            
            if (additionalText) {
                listing += `ðŸ“ ADDITIONAL INFORMATION
${additionalText}

`;
            }
            
            listing += `ðŸŽ“ Join us for an engaging Korean learning experience!`;
            
            document.getElementById('shopifyListingOutput').textContent = listing;
        }
        
        function convertTimeToAllZones(estTime) {
            // Parse EST time
            const [timePart, ampm] = estTime.split(' ');
            let [hours, minutes] = timePart.split(':').map(Number);
            
            if (ampm === 'PM' && hours !== 12) hours += 12;
            if (ampm === 'AM' && hours === 12) hours = 0;
            
            const formatTime = (h) => {
                if (h < 0) h += 24;
                if (h >= 24) h -= 24;
                const period = h >= 12 ? 'PM' : 'AM';
                const hour12 = h % 12 || 12;
                return `${hour12}:${String(minutes).padStart(2, '0')} ${period}`;
            };
            
            return {
                EST: estTime,
                CST: formatTime(hours - 1),
                MST: formatTime(hours - 2),
                PST: formatTime(hours - 3)
            };
        }
        
        function copyShopifyListing() {
            const text = document.getElementById('shopifyListingOutput').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                prompt('Copy this listing:', text);
            });
        }
        
        function useSlotForShopify() {
            if (!selectedSlotInfo) return;
            
            document.getElementById('shopifyClassDay').value = selectedSlotInfo.day;
            document.getElementById('shopifyClassTime').value = selectedSlotInfo.time;
            
            if (selectedSlotInfo.class?.level) {
                document.getElementById('shopifyClassType').value = selectedSlotInfo.class.level;
            } else if (selectedSlotInfo.prescheduled?.classType) {
                document.getElementById('shopifyClassType').value = selectedSlotInfo.prescheduled.classType;
            }
            
            closeModal('slotDetailsModal');
            openShopifyListingModal();
            
            // Generate date options based on slot status
            updateShopifyDateOptions();
        }
        
        function updateShopifyDateOptions() {
            const container = document.getElementById('shopifyDateOptions');
            const day = selectedSlotInfo?.day || document.getElementById('shopifyClassDay').value;
            
            // Check if this is a pre-scheduled slot - only show the one scheduled date
            if (selectedSlotInfo?.prescheduled?.startDate) {
                const dateStr = selectedSlotInfo.prescheduled.startDate;
                // Use same date parsing as openSlotDetails
                const scheduledDate = new Date(dateStr);
                const label = scheduledDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayLabel = scheduledDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                document.getElementById('shopifyStartDate').value = dateStr;
                
                container.innerHTML = `
                    <button type="button" class="btn btn-sm shopify-date-btn selected" 
                            style="background: #ff9800; border: 1px solid #ff9800; color: #000; font-size: 11px; cursor: default;">
                        ${dayLabel}, ${label} (Scheduled)
                    </button>
                `;
                generateShopifyListing();
                return;
            }
            
            // Check if this is an active class - only show the class start date
            if (selectedSlotInfo?.class?.startDate) {
                const dateStr = selectedSlotInfo.class.startDate;
                // Use same date parsing as openSlotDetails
                const classDate = new Date(dateStr);
                const label = classDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayLabel = classDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                document.getElementById('shopifyStartDate').value = dateStr;
                
                container.innerHTML = `
                    <button type="button" class="btn btn-sm shopify-date-btn selected" 
                            style="background: #39ff14; border: 1px solid #39ff14; color: #000; font-size: 11px; cursor: default;">
                        ${dayLabel}, ${label} (Current)
                    </button>
                `;
                generateShopifyListing();
                return;
            }
            
            // Empty slot - show multiple date options within 3 weeks
            const now = new Date();
            let startFrom = new Date();
            
            // Find the first matching day (Saturday or Sunday)
            const targetDayNum = day === 'Saturday' ? 6 : 0;
            while (startFrom.getDay() !== targetDayNum) {
                startFrom.setDate(startFrom.getDate() + 1);
            }
            
            // If the first date is in the past, move to next week
            if (startFrom < now) {
                startFrom.setDate(startFrom.getDate() + 7);
            }
            
            // Calculate end date (3 weeks from startFrom)
            const endDate = new Date(startFrom);
            endDate.setDate(endDate.getDate() + 21);
            
            // Generate date buttons
            let html = '';
            let currentDate = new Date(startFrom);
            let count = 0;
            let firstDateSelected = false;
            
            while (currentDate <= endDate && count < 5) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const label = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayLabel = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                const isSelected = !firstDateSelected;
                if (isSelected) {
                    firstDateSelected = true;
                    document.getElementById('shopifyStartDate').value = dateStr;
                }
                
                html += `
                    <button type="button" class="btn btn-sm shopify-date-btn ${isSelected ? 'selected' : ''}" 
                            onclick="selectShopifyDate('${dateStr}')"
                            style="background: ${isSelected ? '#39ff14' : 'rgba(57,255,20,0.2)'}; 
                                   border: 1px solid #39ff14; 
                                   color: ${isSelected ? '#000' : '#39ff14'}; 
                                   font-size: 11px;">
                        ${dayLabel}, ${label}
                    </button>
                `;
                
                currentDate.setDate(currentDate.getDate() + 7);
                count++;
            }
            
            container.innerHTML = html;
            generateShopifyListing();
        }
        
        function selectShopifyDate(dateStr) {
            document.getElementById('shopifyStartDate').value = dateStr;
            
            // Update button styles
            document.querySelectorAll('.shopify-date-btn').forEach(btn => {
                btn.style.background = 'rgba(57,255,20,0.2)';
                btn.style.color = '#39ff14';
                btn.classList.remove('selected');
            });
            event.target.style.background = '#39ff14';
            event.target.style.color = '#000';
            event.target.classList.add('selected');
            
            generateShopifyListing();
        }
        
        // ==================== SALES CHAT MODAL FUNCTIONS ====================
        
        // Sales Chat State
        let salesChats = [];
        let currentSalesChatId = null;
        let currentSalesSlot = null;
        let salesChatFilter = 'all';
        let salesChatProcessing = new Set();
        let salesDownsellTimerInterval = null;
        const SALES_FOX_IMAGE = 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Pixel_Fox_Character_remix_01k6575q5hfdc80wrh32w9qr8k.png?v=1766748246';
        
        let salesChatSettings = {
            // General
            firstMessageTemplate: 'ì•ˆë…•í•˜ì„¸ìš” {customerName}ë‹˜! This is {teacherName}, the Korean Teacher from TikTok! I\'ll help you get conversational Korean in 1 year! I have {seatsMessage} for {day}, {time} EST. Did you want to register for class?',
            defaultMaxSeats: 5,
            autoDeleteDays: 30,
            downsellMinutes: 0,
            downsellMessage: 'Hey {customerName}! Just checking in - still interested in learning Korean? ðŸ¦Š We still have a spot for you on {day} at {time}!',
            postSellMessage: '',
            coldTimerMinutes: 30,
            notificationSound: null,
            
            // AI Personality
            agentName: 'Calvin',
            agentRole: 'Korean Teacher from TikTok',
            personalityTone: 'friendly',
            emojiLevel: 'moderate',
            responseLength: 'balanced',
            customPersonality: '',
            
            // Business
            businessName: 'KoreanLearnin',
            businessWebsite: 'https://koreanlearnin.com',
            businessEmail: '',
            businessPhone: '',
            introCoursePrice: '$100',
            advancedProgramPrice: '$250/month',
            currentPromotion: '',
            promotionLink: '',
            
            // Lead Scoring Keywords
            hotKeywords: 'sign up, register, enroll, buy, purchase, ready, start now, let\'s do it',
            warmKeywords: 'price, cost, schedule, how much, tell me more, interested, sounds good',
            coldKeywords: 'not interested, too expensive, maybe later, no thanks, can\'t afford'
        };
        
        // Collections for dynamic content
        let salesKnowledgeBase = [];
        let salesTemplates = [];
        let salesObjectionHandlers = [];
        let salesColdTimerIntervals = {};
        
        const SALES_AI_FUNCTION_URL = 'https://generateflashcardai-386010826708.us-central1.run.app';
        
        // Escape HTML helper
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize Sales Chat
        async function initSalesChat() {
            await loadSalesChatSettings();
            await loadSalesKnowledgeBase();
            await loadSalesTemplates();
            await loadSalesObjectionHandlers();
            setupSalesChatListeners();
            startDownsellTimer();
            startColdTimer();
            renderSalesSuggestionsSidebar();
        }
        
        // ===== SUGGESTIONS SIDEBAR - ALL FEATURES =====
        
        // Default suggestions data (built-in)
        const defaultSuggestions = [
            // Objection Handlers
            { id: 'default-obj-1', type: 'objection', title: 'Too Expensive', content: 'I understand budget is important! The $100 intro course is actually less than $17/week for 6 weeks of live instruction. That\'s cheaper than most apps, and you get real feedback from a native speaker! ðŸŽ¯ Would you like me to tell you more about what\'s included?', tags: ['price', 'budget', 'money', 'cost'], uses: 0, favorite: false },
            { id: 'default-obj-2', type: 'objection', title: 'No Time', content: 'Our classes are only 40 minutes on weekends! Most students fit it in easily between other activities. We have slots from 6:30 PM to 11:10 PM EST on Saturdays and Sundays. What time works best for you? ðŸ“…', tags: ['time', 'schedule', 'busy'], uses: 0, favorite: false },
            { id: 'default-obj-3', type: 'objection', title: 'Not Ready / Scared', content: 'That\'s totally okay! Learning Korean is a journey, not a race. ðŸ˜Š Our beginner course starts from zero - we\'ll teach you Hangul (the alphabet) first, then build from there. Many of our students had no prior experience!', tags: ['beginner', 'nervous', 'scared', 'ready'], uses: 0, favorite: false },
            { id: 'default-obj-4', type: 'objection', title: 'Need to Think', content: 'I totally get wanting to think it over! Just so you know, spots do fill up since we keep classes small (5-10 students max). No pressure at all - but if you\'re interested, I\'d recommend securing your spot soon! ðŸ™‚', tags: ['think', 'decide', 'later'], uses: 0, favorite: false },
            // Templates
            { id: 'default-tmp-1', type: 'template', title: 'Welcome Message', content: 'ì•ˆë…•í•˜ì„¸ìš”! This is {agentName}, the Korean Teacher from TikTok! ðŸŽ® Thanks so much for reaching out about learning Korean! I\'d love to help you get started. What made you interested in learning Korean? K-dramas, K-pop, or something else? ðŸ˜Š', tags: ['welcome', 'intro', 'greeting'], uses: 0, favorite: false },
            { id: 'default-tmp-2', type: 'template', title: 'Class Info', content: 'Our 6-week intro course is {introPrice} total - that covers everything! Classes are on Saturdays and Sundays, 40 minutes each. We keep groups small (5-10 students) so everyone gets attention. You\'ll learn Hangul, basic grammar, and everyday conversation! ðŸ“š', tags: ['info', 'class', 'details', 'price'], uses: 0, favorite: false },
            // Closing Scripts
            { id: 'default-cls-1', type: 'closing', title: 'Ready to Start', content: 'Perfect! I\'ll save your spot right now! ðŸŽ‰ Here\'s what happens next: I\'ll send you a registration link, and once you sign up, you\'ll get access to our Discord server where all the classes happen. Sound good?', tags: ['close', 'register', 'signup'], uses: 0, favorite: false },
            { id: 'default-cls-2', type: 'closing', title: 'Limited Seats', content: 'Just a heads up - we only have {seatsLeft} spots left for this time slot! ðŸ”¥ I don\'t want you to miss out if this is the time that works best for you. Want me to hold one for you?', tags: ['urgency', 'seats', 'limited'], uses: 0, favorite: false },
        ];
        
        let allSuggestions = [];
        let suggestionFavorites = JSON.parse(localStorage.getItem('salesSuggestionFavorites') || '{}');
        let suggestionUses = JSON.parse(localStorage.getItem('salesSuggestionUses') || '{}');
        let currentSuggestionFilter = 'all';
        
        // Render the suggestions sidebar
        function renderSalesSuggestionsSidebar() {
            // Start with empty array
            allSuggestions = [];
            
            // Track which default IDs have been overridden by custom entries
            const overriddenDefaults = new Set();
            
            // First, add custom objection handlers from Firebase
            salesObjectionHandlers.forEach(o => {
                // Check if this overrides a default (by basedOn field or matching title)
                if (o.basedOn) {
                    overriddenDefaults.add(o.basedOn);
                }
                // Also check by title match
                const matchingDefault = defaultSuggestions.find(d => 
                    d.type === 'objection' && d.title.toLowerCase() === o.title.toLowerCase()
                );
                if (matchingDefault) {
                    overriddenDefaults.add(matchingDefault.id);
                }
                
                allSuggestions.push({
                    id: o.id,
                    type: 'objection',
                    title: o.title,
                    content: o.response,
                    tags: o.tags ? o.tags.split(',').map(t => t.trim()) : [],
                    uses: suggestionUses[o.id] || 0,
                    favorite: suggestionFavorites[o.id] || false,
                    isCustom: true
                });
            });
            
            // Add custom templates from Firebase
            salesTemplates.forEach(t => {
                // Check if this overrides a default
                if (t.basedOn) {
                    overriddenDefaults.add(t.basedOn);
                }
                // Also check by title match
                const matchingDefault = defaultSuggestions.find(d => 
                    d.type === (t.category || 'template') && d.title.toLowerCase() === t.title.toLowerCase()
                );
                if (matchingDefault) {
                    overriddenDefaults.add(matchingDefault.id);
                }
                
                allSuggestions.push({
                    id: t.id,
                    type: t.category || 'template',
                    title: t.title,
                    content: t.content,
                    tags: t.tags ? t.tags.split(',').map(t => t.trim()) : [],
                    uses: suggestionUses[t.id] || 0,
                    favorite: suggestionFavorites[t.id] || false,
                    isCustom: true
                });
            });
            
            // Now add defaults that haven't been overridden
            defaultSuggestions.forEach(d => {
                if (!overriddenDefaults.has(d.id)) {
                    allSuggestions.push({
                        ...d,
                        uses: suggestionUses[d.id] || 0,
                        favorite: suggestionFavorites[d.id] || false,
                        isCustom: false
                    });
                }
            });
            
            // Render all sections
            renderSuggestionSection('objection', 'salesObjectionHandlersList');
            renderSuggestionSection('template', 'salesTemplatesList2');
            renderSuggestionSection('closing', 'salesClosingScriptsList');
            renderFavoritesSuggestions();
            updateContextSuggestions();
        }
        
        // Render a single section
        function renderSuggestionSection(type, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let suggestions = allSuggestions.filter(s => s.type === type);
            
            // Sort by: favorites first, then by uses (most used first)
            suggestions.sort((a, b) => {
                if (a.favorite && !b.favorite) return -1;
                if (!a.favorite && b.favorite) return 1;
                return (b.uses || 0) - (a.uses || 0);
            });
            
            container.innerHTML = suggestions.map(s => renderSuggestionCard(s)).join('');
        }
        
        // Render a single suggestion card
        function renderSuggestionCard(s) {
            const tagsHtml = s.tags && s.tags.length > 0 
                ? `<div class="sales-suggestion-card-tags">${s.tags.slice(0, 3).map(t => `<span class="sales-suggestion-card-tag">${escapeHtml(t)}</span>`).join('')}</div>` 
                : '';
            
            return `
                <div class="sales-suggestion-card ${s.type} ${s.highlighted ? 'highlighted' : ''}" 
                     data-id="${s.id}" 
                     data-type="${s.type}"
                     data-full-text="${escapeHtml(s.content)}"
                     onclick="copySuggestionToClipboard('${s.id}', event)">
                    <div class="sales-suggestion-card-header">
                        <div class="sales-suggestion-card-title">${escapeHtml(s.title)}</div>
                        <div class="sales-suggestion-card-meta">
                            ${s.uses > 0 ? `<span class="sales-suggestion-card-uses">${s.uses}Ã—</span>` : ''}
                            <button class="sales-suggestion-card-fav ${s.favorite ? 'active' : ''}" onclick="toggleSuggestionFavorite('${s.id}', event)" title="Favorite">
                                ${s.favorite ? 'â­' : 'â˜†'}
                            </button>
                        </div>
                    </div>
                    <div class="sales-suggestion-card-preview">${escapeHtml(s.content.substring(0, 80))}...</div>
                    ${tagsHtml}
                    <div class="sales-suggestion-card-actions">
                        <button class="sales-suggestion-edit-btn" onclick="openSuggestionEdit('${s.id}', event)">âœï¸ Edit</button>
                        <button class="sales-suggestion-ai-btn" onclick="aiEditSuggestion('${s.id}', event)">âœ¨ AI</button>
                        <button class="sales-suggestion-personalize-btn" onclick="personalizeSuggestion('${s.id}', event)">ðŸ”„ Personal</button>
                    </div>
                </div>
            `;
        }
        
        // Copy suggestion to clipboard (click on card)
        function copySuggestionToClipboard(id, event) {
            if (event.target.tagName === 'BUTTON') return; // Don't copy if clicking a button
            
            const suggestion = allSuggestions.find(s => s.id === id);
            if (!suggestion) return;
            
            // Personalize and copy
            const personalizedText = personalizeSuggestionText(suggestion.content);
            navigator.clipboard.writeText(personalizedText);
            
            // Track usage
            suggestionUses[id] = (suggestionUses[id] || 0) + 1;
            localStorage.setItem('salesSuggestionUses', JSON.stringify(suggestionUses));
            
            // Visual feedback
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.classList.add('copied');
                setTimeout(() => card.classList.remove('copied'), 500);
            }
            
            // Update uses display
            suggestion.uses = suggestionUses[id];
        }
        
        // Personalize suggestion text with variables
        function personalizeSuggestionText(text) {
            const chat = currentSalesChatId ? salesChats.find(c => c.id === currentSalesChatId) : null;
            const ps = currentSalesSlot?.prescheduled;
            
            let result = text;
            result = result.replace(/{customerName}/g, chat?.customerName || 'there');
            result = result.replace(/{agentName}/g, salesChatSettings.agentName || 'Calvin');
            result = result.replace(/{teacherName}/g, ps?.teacherName || salesChatSettings.agentName || 'Calvin');
            result = result.replace(/{day}/g, chat?.slotDay || ps?.day || 'Saturday');
            result = result.replace(/{time}/g, chat?.slotTime || ps?.time || '8:30 PM');
            result = result.replace(/{introPrice}/g, salesChatSettings.introCoursePrice || '$100');
            result = result.replace(/{advancedPrice}/g, salesChatSettings.advancedProgramPrice || '$250/month');
            result = result.replace(/{businessName}/g, salesChatSettings.businessName || 'KoreanLearnin');
            result = result.replace(/{website}/g, salesChatSettings.businessWebsite || '');
            result = result.replace(/{promo}/g, salesChatSettings.currentPromotion || '');
            
            // Calculate seats left
            const enrolled = ps?.enrolledStudents?.length || 0;
            const maxSeats = ps?.maxSeats || 5;
            result = result.replace(/{seatsLeft}/g, (maxSeats - enrolled).toString());
            
            return result;
        }
        
        // Toggle favorite
        function toggleSuggestionFavorite(id, event) {
            event.stopPropagation();
            
            suggestionFavorites[id] = !suggestionFavorites[id];
            localStorage.setItem('salesSuggestionFavorites', JSON.stringify(suggestionFavorites));
            
            // Update the suggestion object
            const suggestion = allSuggestions.find(s => s.id === id);
            if (suggestion) suggestion.favorite = suggestionFavorites[id];
            
            renderSalesSuggestionsSidebar();
        }
        
        // Render favorites section
        function renderFavoritesSuggestions() {
            const favorites = allSuggestions.filter(s => s.favorite);
            const section = document.getElementById('salesFavoritesSection');
            const list = document.getElementById('salesFavoritesList');
            
            if (favorites.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = favorites.map(s => renderSuggestionCard(s)).join('');
        }
        
        // Update context-aware suggestions based on last customer message
        function updateContextSuggestions() {
            const container = document.getElementById('salesContextRecommendations');
            const buttonsContainer = document.getElementById('salesContextButtons');
            
            const chat = currentSalesChatId ? salesChats.find(c => c.id === currentSalesChatId) : null;
            if (!chat || !chat.messages?.length) {
                container.style.display = 'none';
                return;
            }
            
            const lastCustomerMsg = [...chat.messages].reverse().find(m => m.role === 'customer');
            if (!lastCustomerMsg) {
                container.style.display = 'none';
                return;
            }
            
            const msgLower = lastCustomerMsg.content.toLowerCase();
            
            // Find matching suggestions based on tags
            const contextMatches = allSuggestions.filter(s => {
                if (!s.tags || s.tags.length === 0) return false;
                return s.tags.some(tag => msgLower.includes(tag.toLowerCase()));
            });
            
            // Also check for keyword matches in title
            const keywordMatches = allSuggestions.filter(s => {
                const titleWords = s.title.toLowerCase().split(/\s+/);
                return titleWords.some(word => word.length > 3 && msgLower.includes(word));
            });
            
            const allMatches = [...new Set([...contextMatches, ...keywordMatches])].slice(0, 4);
            
            if (allMatches.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Render as compact buttons
            container.style.display = 'flex';
            buttonsContainer.innerHTML = allMatches.map(s => `
                <button class="sales-context-btn ${s.type}" 
                        onclick="copyContextSuggestion('${s.id}')" 
                        title="${escapeHtml(s.content.substring(0, 100))}...">
                    ${escapeHtml(s.title)}
                </button>
            `).join('');
        }
        
        // Copy context suggestion when button clicked
        function copyContextSuggestion(id) {
            const suggestion = allSuggestions.find(s => s.id === id);
            if (!suggestion) return;
            
            const personalizedText = personalizeSuggestionText(suggestion.content);
            navigator.clipboard.writeText(personalizedText);
            
            // Track usage
            suggestionUses[id] = (suggestionUses[id] || 0) + 1;
            localStorage.setItem('salesSuggestionUses', JSON.stringify(suggestionUses));
            
            // Visual feedback on the button
            const btn = document.querySelector(`.sales-context-btn[onclick*="${id}"]`);
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = 'âœ… Copied!';
                btn.style.background = 'rgba(57,255,20,0.3)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1000);
            }
        }
        
        // Filter suggestions by search
        function filterSalesSuggestions() {
            const query = document.getElementById('salesSuggestionSearch').value.toLowerCase().trim();
            
            document.querySelectorAll('.sales-suggestion-card').forEach(card => {
                if (!query) {
                    card.style.display = '';
                    return;
                }
                
                const title = card.querySelector('.sales-suggestion-card-title')?.textContent.toLowerCase() || '';
                const preview = card.querySelector('.sales-suggestion-card-preview')?.textContent.toLowerCase() || '';
                const tags = Array.from(card.querySelectorAll('.sales-suggestion-card-tag')).map(t => t.textContent.toLowerCase()).join(' ');
                
                const matches = title.includes(query) || preview.includes(query) || tags.includes(query);
                card.style.display = matches ? '' : 'none';
            });
        }
        
        // Filter by tag/category
        function filterSuggestionsByTag(tag) {
            currentSuggestionFilter = tag;
            
            // Update active chip
            document.querySelectorAll('.sales-filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === tag);
            });
            
            // Filter sections
            document.querySelectorAll('.sales-suggestion-section[data-category]').forEach(section => {
                if (tag === 'all') {
                    section.style.display = '';
                } else if (tag === 'favorite') {
                    section.style.display = 'none';
                } else {
                    section.style.display = section.dataset.category === tag ? '' : 'none';
                }
            });
            
            // Show/hide favorites section
            const favSection = document.getElementById('salesFavoritesSection');
            if (tag === 'favorite') {
                favSection.style.display = 'block';
                document.querySelectorAll('.sales-suggestion-section[data-category]').forEach(s => s.style.display = 'none');
            }
        }
        
        // Open edit modal
        function openSuggestionEdit(id, event) {
            if (event) event.stopPropagation();
            
            const suggestion = allSuggestions.find(s => s.id === id);
            
            document.getElementById('suggestionEditId').value = id;
            document.getElementById('suggestionEditType').value = suggestion?.isCustom ? 'custom' : 'default';
            document.getElementById('suggestionEditTitleInput').value = suggestion?.title || '';
            document.getElementById('suggestionEditCategory').value = suggestion?.type || 'template';
            document.getElementById('suggestionEditTags').value = suggestion?.tags?.join(', ') || '';
            document.getElementById('suggestionEditContent').value = suggestion?.content || '';
            document.getElementById('suggestionEditTitle').textContent = suggestion ? 'âœï¸ Edit Suggestion' : 'âž• Add Suggestion';
            
            // Show delete button only for custom suggestions
            document.getElementById('suggestionDeleteBtn').style.display = suggestion?.isCustom ? 'inline-flex' : 'none';
            
            // Hide AI options initially
            document.getElementById('suggestionAIOptions').style.display = 'none';
            
            document.getElementById('suggestionEditModal').classList.add('active');
        }
        
        // Quick add suggestion
        function quickAddSuggestion(category = 'template') {
            document.getElementById('suggestionEditId').value = '';
            document.getElementById('suggestionEditType').value = 'new';
            document.getElementById('suggestionEditTitleInput').value = '';
            document.getElementById('suggestionEditCategory').value = category;
            document.getElementById('suggestionEditTags').value = '';
            document.getElementById('suggestionEditContent').value = '';
            document.getElementById('suggestionEditTitle').textContent = 'âž• Add Suggestion';
            
            // Hide delete button for new suggestions
            document.getElementById('suggestionDeleteBtn').style.display = 'none';
            
            // Hide AI options
            document.getElementById('suggestionAIOptions').style.display = 'none';
            
            document.getElementById('suggestionEditModal').classList.add('active');
        }
        
        // Save suggestion edit
        async function saveSuggestionEdit() {
            const id = document.getElementById('suggestionEditId').value;
            const type = document.getElementById('suggestionEditType').value;
            const title = document.getElementById('suggestionEditTitleInput').value.trim();
            const category = document.getElementById('suggestionEditCategory').value;
            const tags = document.getElementById('suggestionEditTags').value.trim();
            const content = document.getElementById('suggestionEditContent').value.trim();
            
            if (!title || !content) {
                alert('Please fill in title and content');
                return;
            }
            
            // Determine the correct collection based on category
            const collection = category === 'objection' ? 'sales_objections' : 'sales_templates';
            
            // For objections, we use 'response' field; for templates, we use 'content' field
            const dataToSave = category === 'objection' 
                ? { title, response: content, tags, createdAt: firebase.firestore.FieldValue.serverTimestamp() }
                : { title, content, category, tags, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
            
            try {
                if (type === 'new' || !id) {
                    // Add new to Firebase
                    await db.collection(collection).add(dataToSave);
                    console.log('Added new suggestion to', collection);
                } else if (type === 'custom') {
                    // Update existing custom - need to find which collection it's in
                    const suggestion = allSuggestions.find(s => s.id === id);
                    const originalCollection = suggestion?.type === 'objection' ? 'sales_objections' : 'sales_templates';
                    
                    if (category === 'objection') {
                        await db.collection(originalCollection).doc(id).update({ title, response: content, tags });
                    } else {
                        await db.collection(originalCollection).doc(id).update({ title, content, category, tags });
                    }
                    console.log('Updated suggestion in', originalCollection);
                } else {
                    // "Edit" a default by creating a custom copy with basedOn reference
                    const dataWithBasedOn = { ...dataToSave, basedOn: id };
                    await db.collection(collection).add(dataWithBasedOn);
                    console.log('Created custom copy in', collection, 'based on', id);
                }
                
                closeModal('suggestionEditModal');
                await loadSalesTemplates();
                await loadSalesObjectionHandlers();
                renderSalesSuggestionsSidebar();
                alert('âœ… Saved!');
            } catch (e) {
                console.error('Error saving suggestion:', e);
                alert('Error saving: ' + e.message);
            }
        }
        
        // Delete suggestion from modal
        async function deleteSuggestionFromModal() {
            const id = document.getElementById('suggestionEditId').value;
            const type = document.getElementById('suggestionEditType').value;
            
            if (!id || type !== 'custom') {
                alert('Cannot delete default suggestions');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this suggestion?')) return;
            
            try {
                const suggestion = allSuggestions.find(s => s.id === id);
                const collection = suggestion?.type === 'objection' ? 'sales_objections' : 'sales_templates';
                
                await db.collection(collection).doc(id).delete();
                
                closeModal('suggestionEditModal');
                await loadSalesTemplates();
                await loadSalesObjectionHandlers();
                renderSalesSuggestionsSidebar();
                alert('âœ… Deleted!');
            } catch (e) {
                console.error('Error deleting suggestion:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Copy modal content to clipboard
        function copyModalContent() {
            const content = document.getElementById('suggestionEditContent').value;
            const personalizedText = personalizeSuggestionText(content);
            navigator.clipboard.writeText(personalizedText);
            alert('âœ… Copied to clipboard!');
        }
        
        // Show AI rewrite options
        function aiRewriteInModal() {
            document.getElementById('suggestionAIOptions').style.display = 'block';
            document.getElementById('suggestionAIStyle').onchange = function() {
                document.getElementById('suggestionAICustom').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            };
        }
        
        // Hide AI options
        function hideAIOptions() {
            document.getElementById('suggestionAIOptions').style.display = 'none';
        }
        
        // Generate AI rewrite
        async function generateAIRewrite() {
            const content = document.getElementById('suggestionEditContent').value.trim();
            const style = document.getElementById('suggestionAIStyle').value;
            const customInstructions = document.getElementById('suggestionAICustom').value.trim();
            
            if (!content) {
                alert('Please enter some content first');
                return;
            }
            
            // Build instruction based on style
            let instruction = '';
            switch(style) {
                case 'friendly': instruction = 'Rewrite this to be more friendly, warm, and personable. Add appropriate emojis.'; break;
                case 'professional': instruction = 'Rewrite this to be more professional and business-like. Remove emojis.'; break;
                case 'casual': instruction = 'Rewrite this to be more casual, relaxed, and fun. Use conversational language.'; break;
                case 'urgent': instruction = 'Rewrite this to add urgency and encourage immediate action.'; break;
                case 'shorter': instruction = 'Rewrite this to be more concise. Keep the key points but use fewer words.'; break;
                case 'longer': instruction = 'Expand this with more detail and explanation while keeping the same tone.'; break;
                case 'custom': instruction = customInstructions || 'Improve this message'; break;
            }
            
            // Show loading
            const generateBtn = document.querySelector('#suggestionAIOptions .btn-success');
            const originalText = generateBtn.textContent;
            generateBtn.textContent = 'â³ Generating...';
            generateBtn.disabled = true;
            
            try {
                const response = await fetch(SALES_AI_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: `You are a sales copywriting assistant for ${salesChatSettings.businessName || 'KoreanLearnin'}. ${instruction} Return only the rewritten message, no explanations or quotes.` },
                            { role: 'user', content: content }
                        ],
                        temperature: 0.7
                    })
                });
                
                const result = await response.json();
                if (result.success && result.data) {
                    // Update the textarea with the AI result
                    document.getElementById('suggestionEditContent').value = result.data;
                    hideAIOptions();
                    
                    // Also copy to clipboard
                    const personalizedText = personalizeSuggestionText(result.data);
                    await navigator.clipboard.writeText(personalizedText);
                    alert('âœ¨ AI rewrite applied and copied to clipboard!');
                } else {
                    throw new Error('AI did not return a response');
                }
            } catch (e) {
                console.error('AI rewrite error:', e);
                alert('Error: ' + e.message);
            } finally {
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }
        
        // AI edit suggestion (from card button) - now opens modal with AI options
        async function aiEditSuggestion(id, event) {
            if (event) event.stopPropagation();
            
            // Open the edit modal first
            openSuggestionEdit(id, event);
            
            // Then show AI options
            setTimeout(() => {
                aiRewriteInModal();
            }, 100);
        }
        
        // Pre-generate AI response after using a suggestion
        async function preGenerateAIResponse(usedSuggestionText) {
            const chat = currentSalesChatId ? salesChats.find(c => c.id === currentSalesChatId) : null;
            if (!chat) return;
            
            // Add the used suggestion as an "ai" message temporarily to get context
            const tempMessages = [...(chat.messages || []), {
                role: 'ai',
                content: usedSuggestionText,
                timestamp: new Date().toISOString()
            }];
            
            // Generate what the AI would say next if the customer responds
            // This is shown as a preview/suggestion
            console.log('Pre-generating AI response based on used suggestion...');
        }
        // Personalize and copy
        function personalizeSuggestion(id, event) {
            if (event) event.stopPropagation();
            
            const suggestion = allSuggestions.find(s => s.id === id);
            if (!suggestion) return;
            
            const personalizedText = personalizeSuggestionText(suggestion.content);
            navigator.clipboard.writeText(personalizedText);
            
            // Track usage
            suggestionUses[id] = (suggestionUses[id] || 0) + 1;
            localStorage.setItem('salesSuggestionUses', JSON.stringify(suggestionUses));
            
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.classList.add('copied');
                setTimeout(() => card.classList.remove('copied'), 500);
            }
        }
        
        // Insert quick links
        function insertQuickLink(type) {
            let link = '';
            switch(type) {
                case 'registration':
                    link = salesChatSettings.businessWebsite || 'https://koreanlearnin.com/register';
                    break;
                case 'discord':
                    link = 'https://discord.gg/koreanlearnin'; // Default, should be in settings
                    break;
                case 'promo':
                    link = salesChatSettings.promotionLink || salesChatSettings.businessWebsite || '';
                    break;
            }
            
            if (link) {
                navigator.clipboard.writeText(link);
                alert(`âœ… ${type.charAt(0).toUpperCase() + type.slice(1)} link copied!`);
            } else {
                alert('No link configured. Add it in Settings â†’ Business.');
            }
        }
        
        async function loadSalesChatSettings() {
            try {
                const doc = await db.collection('settings').doc('sales_chat').get();
                if (doc.exists) {
                    salesChatSettings = { ...salesChatSettings, ...doc.data() };
                }
                // Load notification sound if exists
                if (salesChatSettings.notificationSound) {
                    document.getElementById('salesNotificationAudio').src = salesChatSettings.notificationSound;
                }
            } catch (e) {
                console.error('Error loading sales chat settings:', e);
            }
        }
        
        // Load Knowledge Base
        async function loadSalesKnowledgeBase() {
            try {
                const snapshot = await db.collection('sales_knowledge').orderBy('createdAt', 'desc').get();
                salesKnowledgeBase = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error loading knowledge base:', e);
            }
        }
        
        // Load Templates
        async function loadSalesTemplates() {
            try {
                const snapshot = await db.collection('sales_templates').orderBy('createdAt', 'desc').get();
                salesTemplates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error loading templates:', e);
            }
        }
        
        // Load Objection Handlers
        async function loadSalesObjectionHandlers() {
            try {
                const snapshot = await db.collection('sales_objections').orderBy('createdAt', 'desc').get();
                salesObjectionHandlers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error loading objection handlers:', e);
            }
        }
        
        // Settings Modal
        function switchSalesSettingsTab(tabName) {
            document.querySelectorAll('.sales-settings-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sales-settings-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.sales-settings-tab[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById('salesSettings' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            
            // Render lists when switching to those tabs
            if (tabName === 'templates') renderSalesTemplatesList();
            if (tabName === 'objections') renderSalesObjectionsList();
            if (tabName === 'knowledge') renderSalesKnowledgeList();
        }
        
        function openSalesSettingsModal() {
            // General tab
            document.getElementById('salesSettingTemplate').value = salesChatSettings.firstMessageTemplate || '';
            document.getElementById('salesSettingMaxSeats').value = salesChatSettings.defaultMaxSeats || 5;
            document.getElementById('salesSettingAutoDelete').value = salesChatSettings.autoDeleteDays || 30;
            document.getElementById('salesSettingDownsellMinutes').value = salesChatSettings.downsellMinutes || 0;
            document.getElementById('salesSettingDownsellMessage').value = salesChatSettings.downsellMessage || '';
            document.getElementById('salesSettingPostSellMessage').value = salesChatSettings.postSellMessage || '';
            document.getElementById('salesSettingColdTimer').value = salesChatSettings.coldTimerMinutes || 30;
            
            // Notification sound
            if (salesChatSettings.notificationSound) {
                document.getElementById('salesSoundPreview').style.display = 'flex';
                document.getElementById('salesSoundFileName').textContent = 'Custom sound';
            }
            
            // AI Personality tab
            document.getElementById('salesSettingAgentName').value = salesChatSettings.agentName || 'Calvin';
            document.getElementById('salesSettingAgentRole').value = salesChatSettings.agentRole || 'Korean Teacher from TikTok';
            document.getElementById('salesSettingTone').value = salesChatSettings.personalityTone || 'friendly';
            document.getElementById('salesSettingEmojiLevel').value = salesChatSettings.emojiLevel || 'moderate';
            document.getElementById('salesSettingResponseLength').value = salesChatSettings.responseLength || 'balanced';
            document.getElementById('salesSettingCustomPersonality').value = salesChatSettings.customPersonality || '';
            document.getElementById('salesSettingHotKeywords').value = salesChatSettings.hotKeywords || '';
            document.getElementById('salesSettingWarmKeywords').value = salesChatSettings.warmKeywords || '';
            document.getElementById('salesSettingColdKeywords').value = salesChatSettings.coldKeywords || '';
            
            // Business tab
            document.getElementById('salesSettingBusinessName').value = salesChatSettings.businessName || 'KoreanLearnin';
            document.getElementById('salesSettingWebsite').value = salesChatSettings.businessWebsite || '';
            document.getElementById('salesSettingEmail').value = salesChatSettings.businessEmail || '';
            document.getElementById('salesSettingPhone').value = salesChatSettings.businessPhone || '';
            document.getElementById('salesSettingIntroPrice').value = salesChatSettings.introCoursePrice || '$100';
            document.getElementById('salesSettingAdvancedPrice').value = salesChatSettings.advancedProgramPrice || '$250/month';
            document.getElementById('salesSettingPromotion').value = salesChatSettings.currentPromotion || '';
            document.getElementById('salesSettingPromoLink').value = salesChatSettings.promotionLink || '';
            
            // Reset to first tab
            switchSalesSettingsTab('general');
            document.getElementById('salesSettingsModal').classList.add('active');
        }
        
        async function saveSalesChatSettings() {
            // General
            salesChatSettings.firstMessageTemplate = document.getElementById('salesSettingTemplate').value.trim();
            salesChatSettings.defaultMaxSeats = parseInt(document.getElementById('salesSettingMaxSeats').value) || 5;
            salesChatSettings.autoDeleteDays = parseInt(document.getElementById('salesSettingAutoDelete').value) || 30;
            salesChatSettings.downsellMinutes = parseInt(document.getElementById('salesSettingDownsellMinutes').value) || 0;
            salesChatSettings.downsellMessage = document.getElementById('salesSettingDownsellMessage').value.trim();
            salesChatSettings.postSellMessage = document.getElementById('salesSettingPostSellMessage').value.trim();
            salesChatSettings.coldTimerMinutes = parseInt(document.getElementById('salesSettingColdTimer').value) || 30;
            
            // AI Personality
            salesChatSettings.agentName = document.getElementById('salesSettingAgentName').value.trim() || 'Calvin';
            salesChatSettings.agentRole = document.getElementById('salesSettingAgentRole').value.trim() || 'Korean Teacher from TikTok';
            salesChatSettings.personalityTone = document.getElementById('salesSettingTone').value;
            salesChatSettings.emojiLevel = document.getElementById('salesSettingEmojiLevel').value;
            salesChatSettings.responseLength = document.getElementById('salesSettingResponseLength').value;
            salesChatSettings.customPersonality = document.getElementById('salesSettingCustomPersonality').value.trim();
            salesChatSettings.hotKeywords = document.getElementById('salesSettingHotKeywords').value.trim();
            salesChatSettings.warmKeywords = document.getElementById('salesSettingWarmKeywords').value.trim();
            salesChatSettings.coldKeywords = document.getElementById('salesSettingColdKeywords').value.trim();
            
            // Business
            salesChatSettings.businessName = document.getElementById('salesSettingBusinessName').value.trim() || 'KoreanLearnin';
            salesChatSettings.businessWebsite = document.getElementById('salesSettingWebsite').value.trim();
            salesChatSettings.businessEmail = document.getElementById('salesSettingEmail').value.trim();
            salesChatSettings.businessPhone = document.getElementById('salesSettingPhone').value.trim();
            salesChatSettings.introCoursePrice = document.getElementById('salesSettingIntroPrice').value.trim() || '$100';
            salesChatSettings.advancedProgramPrice = document.getElementById('salesSettingAdvancedPrice').value.trim() || '$250/month';
            salesChatSettings.currentPromotion = document.getElementById('salesSettingPromotion').value.trim();
            salesChatSettings.promotionLink = document.getElementById('salesSettingPromoLink').value.trim();
            
            try {
                await db.collection('settings').doc('sales_chat').set(salesChatSettings, { merge: true });
                closeModal('salesSettingsModal');
                alert('âœ… Settings saved!');
            } catch (e) {
                console.error('Error saving settings:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        // ===== NOTIFICATION SOUND =====
        function handleSalesSoundUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                salesChatSettings.notificationSound = e.target.result;
                document.getElementById('salesNotificationAudio').src = e.target.result;
                document.getElementById('salesSoundFileName').textContent = file.name;
                document.getElementById('salesSoundPreview').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
        
        function playSalesNotificationSound() {
            const audio = document.getElementById('salesNotificationAudio');
            if (audio.src) {
                audio.currentTime = 0;
                audio.play();
            }
        }
        
        function removeSalesSound() {
            salesChatSettings.notificationSound = null;
            document.getElementById('salesNotificationAudio').src = '';
            document.getElementById('salesSoundPreview').style.display = 'none';
        }
        
        // ===== KNOWLEDGE BASE =====
        function renderSalesKnowledgeList() {
            const container = document.getElementById('salesKnowledgeList');
            if (salesKnowledgeBase.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">No knowledge entries yet. Add some!</p>';
                return;
            }
            container.innerHTML = salesKnowledgeBase.map(k => `
                <div class="sales-settings-item">
                    <div class="sales-settings-item-content">
                        <div class="sales-settings-item-title">${escapeHtml(k.title)}</div>
                        <div class="sales-settings-item-text">${escapeHtml(k.content)}</div>
                    </div>
                    <div class="sales-settings-item-actions">
                        <button class="sales-settings-item-btn delete" onclick="deleteSalesKnowledge('${k.id}')">ðŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function addSalesKnowledge() {
            const title = prompt('Knowledge entry title:');
            if (!title) return;
            const content = prompt('Knowledge content:');
            if (!content) return;
            
            try {
                await db.collection('sales_knowledge').add({
                    title,
                    content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadSalesKnowledgeBase();
                renderSalesKnowledgeList();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteSalesKnowledge(id) {
            if (!confirm('Delete this knowledge entry?')) return;
            try {
                await db.collection('sales_knowledge').doc(id).delete();
                await loadSalesKnowledgeBase();
                renderSalesKnowledgeList();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        // ===== TEMPLATES =====
        function renderSalesTemplatesList() {
            const container = document.getElementById('salesTemplatesList');
            if (salesTemplates.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">No custom templates yet. Add some!</p>';
                return;
            }
            container.innerHTML = salesTemplates.map(t => `
                <div class="sales-settings-item">
                    <div class="sales-settings-item-content">
                        <div class="sales-settings-item-title">${escapeHtml(t.title)}</div>
                        <div class="sales-settings-item-text">${escapeHtml(t.content)}</div>
                    </div>
                    <div class="sales-settings-item-actions">
                        <button class="sales-settings-item-btn" onclick="copySalesTemplateToClipboard('${t.id}')">ðŸ“‹</button>
                        <button class="sales-settings-item-btn delete" onclick="deleteSalesTemplate('${t.id}')">ðŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function addSalesTemplate() {
            const title = prompt('Template name:');
            if (!title) return;
            const content = prompt('Template message:');
            if (!content) return;
            
            try {
                await db.collection('sales_templates').add({
                    title,
                    content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadSalesTemplates();
                renderSalesTemplatesList();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteSalesTemplate(id) {
            if (!confirm('Delete this template?')) return;
            try {
                await db.collection('sales_templates').doc(id).delete();
                await loadSalesTemplates();
                renderSalesTemplatesList();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        function copySalesTemplateToClipboard(id) {
            const t = salesTemplates.find(x => x.id === id);
            if (t) {
                navigator.clipboard.writeText(t.content);
                alert('Template copied!');
            }
        }
        
        // ===== OBJECTION HANDLERS =====
        function renderSalesObjectionsList() {
            const container = document.getElementById('salesObjectionsList');
            if (salesObjectionHandlers.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">No custom objection handlers yet. Add some!</p>';
                return;
            }
            container.innerHTML = salesObjectionHandlers.map(o => `
                <div class="sales-settings-item">
                    <div class="sales-settings-item-content">
                        <div class="sales-settings-item-title">${escapeHtml(o.title)}</div>
                        <div class="sales-settings-item-text">${escapeHtml(o.response)}</div>
                    </div>
                    <div class="sales-settings-item-actions">
                        <button class="sales-settings-item-btn" onclick="copySalesObjectionToClipboard('${o.id}')">ðŸ“‹</button>
                        <button class="sales-settings-item-btn delete" onclick="deleteSalesObjection('${o.id}')">ðŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function addSalesObjection() {
            const title = prompt('Objection type (e.g., "Too Expensive"):');
            if (!title) return;
            const response = prompt('Response to this objection:');
            if (!response) return;
            
            try {
                await db.collection('sales_objections').add({
                    title,
                    response,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadSalesObjectionHandlers();
                renderSalesObjectionsList();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteSalesObjection(id) {
            if (!confirm('Delete this objection handler?')) return;
            try {
                await db.collection('sales_objections').doc(id).delete();
                await loadSalesObjectionHandlers();
                renderSalesObjectionsList();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        function copySalesObjectionToClipboard(id) {
            const o = salesObjectionHandlers.find(x => x.id === id);
            if (o) {
                navigator.clipboard.writeText(o.response);
                alert('Response copied!');
            }
        }
        
        // ===== COLD TIMER =====
        function startColdTimer() {
            // Check every minute
            setInterval(() => {
                checkColdLeads();
            }, 60000);
        }
        
        function checkColdLeads() {
            if (!salesChatSettings.coldTimerMinutes || salesChatSettings.coldTimerMinutes === 0) return;
            
            const now = new Date();
            const thresholdMs = salesChatSettings.coldTimerMinutes * 60 * 1000;
            
            salesChats.forEach(async chat => {
                if (chat.status === 'closed') return;
                if (chat.urgency === 'grey') return; // Already cold
                
                const lastMsg = chat.messages?.[chat.messages.length - 1];
                if (!lastMsg) return;
                
                const lastMsgTime = new Date(lastMsg.timestamp);
                const elapsed = now - lastMsgTime;
                
                if (elapsed >= thresholdMs) {
                    // Degrade urgency
                    let newUrgency = 'grey';
                    if (chat.urgency === 'red') newUrgency = 'yellow';
                    
                    try {
                        await db.collection('sales_chats').doc(chat.id).update({ urgency: newUrgency });
                    } catch (e) {
                        console.error('Error degrading urgency:', e);
                    }
                }
            });
        }
        
        // ===== FEEDBACK PANEL =====
        function openSalesFeedbackPanel() {
            const select = document.getElementById('salesFeedbackChatSelect');
            select.innerHTML = '<option value="">-- Select a chat --</option>' + 
                salesChats.map(c => `<option value="${c.id}">${escapeHtml(c.customerName || 'Unknown')} - ${c.slotDay} @ ${c.slotTime}</option>`).join('');
            document.getElementById('salesFeedbackResults').innerHTML = '';
            document.getElementById('salesFeedbackPanel').classList.add('open');
        }
        
        function closeSalesFeedbackPanel() {
            document.getElementById('salesFeedbackPanel').classList.remove('open');
        }
        
        async function analyzeSalesConversation() {
            const chatId = document.getElementById('salesFeedbackChatSelect').value;
            if (!chatId) {
                alert('Please select a chat first');
                return;
            }
            
            const chat = salesChats.find(c => c.id === chatId);
            if (!chat || !chat.messages?.length) {
                alert('No messages in this chat');
                return;
            }
            
            document.getElementById('salesFeedbackResults').innerHTML = '<p style="text-align: center; color: #aeb8de;">â³ Analyzing conversation...</p>';
            
            try {
                const conversation = chat.messages.map(m => `${m.role}: ${m.content}`).join('\n\n');
                
                const response = await fetch(SALES_AI_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: `You are a sales coach analyzing a conversation. Provide feedback in this JSON format:
{
    "score": 1-10,
    "strengths": ["strength1", "strength2"],
    "improvements": ["improvement1", "improvement2"],
    "missedObjections": ["objection1"],
    "suggestedNextStep": "what to do next"
}` },
                            { role: 'user', content: `Analyze this sales conversation:\n\n${conversation}` }
                        ],
                        temperature: 0.7
                    })
                });
                
                const result = await response.json();
                if (result.success && result.data) {
                    let feedback;
                    try {
                        feedback = JSON.parse(result.data.replace(/```json\n?|\n?```/g, ''));
                    } catch {
                        feedback = { score: '?', strengths: [], improvements: [result.data], missedObjections: [], suggestedNextStep: '' };
                    }
                    
                    document.getElementById('salesFeedbackResults').innerHTML = `
                        <div class="sales-feedback-card">
                            <h4>ðŸ“Š Score: ${feedback.score}/10</h4>
                        </div>
                        <div class="sales-feedback-card">
                            <h4>âœ… Strengths</h4>
                            <ul>${(feedback.strengths || []).map(s => `<li>${escapeHtml(s)}</li>`).join('') || '<li>None identified</li>'}</ul>
                        </div>
                        <div class="sales-feedback-card">
                            <h4>ðŸ“ˆ Areas to Improve</h4>
                            <ul>${(feedback.improvements || []).map(s => `<li>${escapeHtml(s)}</li>`).join('') || '<li>None identified</li>'}</ul>
                        </div>
                        <div class="sales-feedback-card">
                            <h4>ðŸš§ Missed Objections</h4>
                            <ul>${(feedback.missedObjections || []).map(s => `<li>${escapeHtml(s)}</li>`).join('') || '<li>None detected</li>'}</ul>
                        </div>
                        <div class="sales-feedback-card">
                            <h4>ðŸ‘‰ Suggested Next Step</h4>
                            <p>${escapeHtml(feedback.suggestedNextStep) || 'Continue the conversation'}</p>
                        </div>
                    `;
                } else {
                    throw new Error('AI response failed');
                }
            } catch (e) {
                console.error('Feedback error:', e);
                document.getElementById('salesFeedbackResults').innerHTML = '<p style="color: #fca5a5;">Error analyzing conversation. Please try again.</p>';
            }
        }
        
        // ===== DRAG OVERLAY =====
        function openSalesDragOverlay() {
            const hotCount = salesChats.filter(c => c.urgency === 'red').length;
            const warmCount = salesChats.filter(c => c.urgency === 'yellow').length;
            const coldCount = salesChats.filter(c => c.urgency === 'grey').length;
            
            document.getElementById('salesDragHotCount').textContent = hotCount;
            document.getElementById('salesDragWarmCount').textContent = warmCount;
            document.getElementById('salesDragColdCount').textContent = coldCount;
            
            const grid = document.getElementById('salesDragGrid');
            grid.innerHTML = salesChats.map(chat => `
                <div class="sales-drag-overlay-card urgency-${chat.urgency || 'grey'}" onclick="selectFromSalesDragOverlay('${chat.id}')">
                    <div class="sales-drag-overlay-avatar">${getSalesInitials(chat.customerName)}</div>
                    <div class="sales-drag-overlay-name">${escapeHtml(chat.customerName || 'Unknown')}</div>
                    <div class="sales-drag-overlay-meta">${chat.slotDay} @ ${chat.slotTime}</div>
                </div>
            `).join('');
            
            document.getElementById('salesDragOverlay').classList.add('active');
        }
        
        function closeSalesDragOverlay() {
            document.getElementById('salesDragOverlay').classList.remove('active');
        }
        
        function selectFromSalesDragOverlay(chatId) {
            closeSalesDragOverlay();
            selectSalesChat(chatId);
        }
        
        // Downsell Timer - checks every 30 seconds
        function startDownsellTimer() {
            if (salesDownsellTimerInterval) clearInterval(salesDownsellTimerInterval);
            salesDownsellTimerInterval = setInterval(() => {
                checkDownsellReady();
            }, 30000); // Check every 30 seconds
            // Initial check
            checkDownsellReady();
        }
        
        function checkDownsellReady() {
            if (!salesChatSettings.downsellMinutes || salesChatSettings.downsellMinutes === 0) return;
            
            const now = new Date();
            const thresholdMs = salesChatSettings.downsellMinutes * 60 * 1000;
            
            salesChats.forEach(chat => {
                if (chat.status === 'closed' || chat.downsellReady) return;
                
                // Check last message
                const messages = chat.messages || [];
                if (messages.length === 0) return;
                
                const lastMsg = messages[messages.length - 1];
                // Only trigger if last message was from us (admin or AI) - customer hasn't responded
                if (lastMsg.role === 'customer') return;
                
                const lastMsgTime = new Date(lastMsg.timestamp);
                const elapsed = now - lastMsgTime;
                
                if (elapsed >= thresholdMs && !chat.downsellReady) {
                    // Mark as downsell ready
                    db.collection('sales_chats').doc(chat.id).update({
                        downsellReady: true,
                        downsellReadyAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(e => console.error('Error marking downsell ready:', e));
                }
            });
            
            // Re-render to show fox badges
            renderSalesChatList();
            updateSalesChatCounts();
        }
        
        function getDownsellMessage(chat) {
            const template = salesChatSettings.downsellMessage || 'Hey {customerName}! Still interested? ðŸ¦Š';
            return template
                .replace(/{customerName}/g, chat.customerName || 'there')
                .replace(/{teacherName}/g, chat.teacherName || 'Calvin')
                .replace(/{day}/g, chat.slotDay || '')
                .replace(/{time}/g, chat.slotTime || '');
        }
        
        async function sendDownsellMessage(chatId) {
            const chat = salesChats.find(c => c.id === chatId);
            if (!chat) return;
            
            const downsellMsg = getDownsellMessage(chat);
            const messages = [...(chat.messages || []), {
                role: 'admin',
                content: downsellMsg,
                timestamp: new Date().toISOString()
            }];
            
            try {
                await db.collection('sales_chats').doc(chatId).update({
                    messages,
                    downsellReady: false,
                    downsellSentAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('âœ… Downsell message added to chat!');
            } catch (e) {
                console.error('Error sending downsell:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        function setupSalesChatListeners() {
            // Real-time listener for sales chats
            db.collection('sales_chats').orderBy('updatedAt', 'desc').onSnapshot(snapshot => {
                salesChats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSalesChatList();
                updateSalesChatCounts();
                
                if (currentSalesChatId) {
                    const chat = salesChats.find(c => c.id === currentSalesChatId);
                    if (chat) {
                        renderSalesMessages(chat);
                        updateSalesChatHeader(chat);
                    }
                }
            });
        }
        
        // Open Sales Chat Modal from Slot Details Modal
        function openSalesChatFromSlotModal() {
            if (!selectedSlotInfo?.prescheduled) {
                alert('No pre-scheduled slot selected.');
                return;
            }
            // Close the slot details modal first
            closeModal('slotDetailsModal');
            // Open sales chat
            openSalesChatFromSlot(selectedSlotInfo.day, selectedSlotInfo.time, selectedSlotInfo.prescheduled);
        }
        
        // Remove student from pre-scheduled slot
        async function removeStudentFromPrescheduled(psId, idx) {
            if (!confirm('Remove this student from the slot?')) return;
            
            try {
                const ps = allPrescheduledSlots.find(p => p.id === psId);
                if (!ps) return;
                
                const students = ps.enrolledStudents || [];
                students.splice(idx, 1);
                
                await db.collection('prescheduled_slots').doc(psId).update({ enrolledStudents: students });
                ps.enrolledStudents = students;
                
                // Refresh the modal
                openSlotDetails(ps.day, ps.time);
                renderSlotGrid();
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Open Sales Chat Modal from Slot
        function openSalesChatFromSlot(day, time, prescheduled) {
            currentSalesSlot = { day, time, prescheduled };
            currentSalesChatId = null;
            
            // Show modal
            document.getElementById('salesChatModal').classList.add('active');
            
            // Update slot context banner
            updateSlotContextBanner(prescheduled);
            
            // Check for existing chats for this slot
            const slotChats = salesChats.filter(c => 
                c.slotDay === day && 
                c.slotTime === time && 
                c.prescheduledId === prescheduled?.id
            );
            
            if (slotChats.length > 0) {
                // Show existing chats
                selectSalesChat(slotChats[0].id);
            } else {
                // Show empty state for new chat
                showSalesEmptyState();
            }
            
            renderSalesChatList();
        }
        
        function updateSlotContextBanner(prescheduled) {
            const banner = document.getElementById('salesSlotContext');
            if (!prescheduled || !currentSalesSlot) {
                banner.style.display = 'none';
                return;
            }
            
            banner.style.display = 'flex';
            
            const enrolledCount = prescheduled.enrolledStudents?.length || 0;
            const maxSeats = prescheduled.maxSeats || salesChatSettings.defaultMaxSeats || 5;
            const startDate = prescheduled.startDate ? new Date(prescheduled.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'TBD';
            
            document.getElementById('salesSlotTitle').textContent = `${currentSalesSlot.day} @ ${currentSalesSlot.time} EST`;
            document.getElementById('salesSlotDetails').textContent = `${LEVELS[prescheduled.classType] || prescheduled.classType} â€¢ ${prescheduled.teacherName} â€¢ Starts ${startDate}`;
            
            // Render seat dots
            const seatsContainer = document.getElementById('salesSlotSeats');
            let seatsHtml = '';
            for (let i = 0; i < maxSeats; i++) {
                seatsHtml += `<div class="sales-seat-dot ${i < enrolledCount ? 'filled' : 'empty'}"></div>`;
            }
            seatsHtml += `<span style="font-size: 11px; color: #aeb8de; margin-left: 8px;">${enrolledCount}/${maxSeats}</span>`;
            seatsContainer.innerHTML = seatsHtml;
        }
        
        function closeSalesChatModal() {
            document.getElementById('salesChatModal').classList.remove('active');
            currentSalesChatId = null;
            currentSalesSlot = null;
            
            // Refresh slot grid to show updated enrollment counts
            renderSlotGrid();
        }
        
        // ==================== GOOGLE VOICE ====================
        let googleVoiceWindow = null;
        
        function toggleGoogleVoicePanel() {
            const panel = document.getElementById('salesVoicePanel');
            const expandBtn = document.getElementById('salesVoiceExpandBtn');
            
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                panel.style.width = '350px';
                expandBtn.style.display = 'none';
            } else {
                panel.classList.add('collapsed');
                expandBtn.style.display = 'block';
            }
        }
        
        function openGoogleVoiceWindow() {
            // Close existing popup if open
            if (googleVoiceWindow && !googleVoiceWindow.closed) {
                googleVoiceWindow.focus();
                return;
            }
            
            // Open Google Voice
            googleVoiceWindow = window.open(
                'https://voice.google.com/u/0/messages',
                'GoogleVoice',
                'width=500,height=700,resizable=yes,scrollbars=yes'
            );
            
            if (googleVoiceWindow) {
                googleVoiceWindow.focus();
            } else {
                alert('Popup blocked! Please allow popups for this site.');
            }
        }
        
        // ==================== END GOOGLE VOICE ====================
        
        function showSalesEmptyState() {
            document.getElementById('salesEmptyState').style.display = 'flex';
            document.getElementById('salesActiveChat').style.display = 'none';
            document.getElementById('salesNewChatInput').value = '';
        }
        
        function showSalesActiveChat() {
            document.getElementById('salesEmptyState').style.display = 'none';
            document.getElementById('salesActiveChat').style.display = 'flex';
        }
        
        // Render chat list in sidebar
        function renderSalesChatList() {
            const listEl = document.getElementById('salesChatList');
            if (!listEl) return;
            
            // Filter chats for current slot if one is selected
            let filteredChats = salesChats;
            if (currentSalesSlot?.prescheduled) {
                // Show all chats for this slot, plus recent chats from other slots
                filteredChats = salesChats.filter(c => 
                    (c.slotDay === currentSalesSlot.day && c.slotTime === currentSalesSlot.time && c.prescheduledId === currentSalesSlot.prescheduled.id) ||
                    c.status !== 'closed'
                );
            }
            
            // Apply urgency filter
            if (salesChatFilter === 'downsell') {
                filteredChats = filteredChats.filter(c => c.downsellReady && c.status !== 'closed');
            } else if (salesChatFilter !== 'all') {
                filteredChats = filteredChats.filter(c => c.urgency === salesChatFilter);
            }
            
            if (filteredChats.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-size: 12px;">No conversations yet</div>';
                return;
            }
            
            listEl.innerHTML = filteredChats.map(chat => {
                const isCurrentSlot = currentSalesSlot && chat.slotDay === currentSalesSlot.day && chat.slotTime === currentSalesSlot.time && chat.prescheduledId === currentSalesSlot.prescheduled?.id;
                const lastMsg = chat.messages?.slice(-1)[0];
                const preview = lastMsg ? truncateSalesText(lastMsg.content, 60) : 'No messages';
                const isDownsellReady = chat.downsellReady && chat.status !== 'closed';
                
                // Fox badge for downsell ready chats
                const foxBadge = isDownsellReady ? `
                    <div class="sales-fox-badge" title="Downsell ready! Click to send follow-up.">
                        <img src="${SALES_FOX_IMAGE}" alt="ðŸ¦Š">
                    </div>
                ` : '';
                
                return `
                    <div class="sales-chat-card ${chat.id === currentSalesChatId ? 'active' : ''} urgency-${chat.urgency || 'grey'} ${isDownsellReady ? 'downsell-ready' : ''}" onclick="selectSalesChat('${chat.id}')">
                        ${foxBadge}
                        <div class="sales-chat-card-top">
                            <div class="sales-chat-card-avatar">${getSalesInitials(chat.customerName)}</div>
                            <div class="sales-chat-card-info">
                                <div class="sales-chat-card-name">${escapeHtml(chat.customerName || 'New Customer')}</div>
                                <div class="sales-chat-card-slot">${chat.slotDay} @ ${chat.slotTime}${isCurrentSlot ? ' â­' : ''}</div>
                            </div>
                        </div>
                        <div class="sales-chat-card-preview">${escapeHtml(preview)}</div>
                        <div class="sales-chat-card-meta">
                            <span>${getSalesTimeAgo(chat.updatedAt)}</span>
                            <span class="sales-urgency-badge ${chat.urgency || 'grey'}">${getSalesUrgencyLabel(chat.urgency)}</span>
                        </div>
                        ${isDownsellReady ? `<div class="sales-downsell-timer">ðŸ¦Š Ready to follow up!</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function updateSalesChatCounts() {
            const all = salesChats.filter(c => c.status !== 'closed').length;
            const red = salesChats.filter(c => c.urgency === 'red' && c.status !== 'closed').length;
            const yellow = salesChats.filter(c => c.urgency === 'yellow' && c.status !== 'closed').length;
            const grey = salesChats.filter(c => (c.urgency === 'grey' || !c.urgency) && c.status !== 'closed').length;
            const downsell = salesChats.filter(c => c.downsellReady && c.status !== 'closed').length;
            
            const countAll = document.getElementById('salesCountAll');
            const countRed = document.getElementById('salesCountRed');
            const countYellow = document.getElementById('salesCountYellow');
            const countGrey = document.getElementById('salesCountGrey');
            const countDownsell = document.getElementById('salesCountDownsell');
            
            if (countAll) countAll.textContent = all;
            if (countRed) countRed.textContent = red;
            if (countYellow) countYellow.textContent = yellow;
            if (countGrey) countGrey.textContent = grey;
            if (countDownsell) countDownsell.textContent = downsell;
        }
        
        function filterSalesChats(filter) {
            salesChatFilter = filter;
            
            document.querySelectorAll('.sales-filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });
            
            renderSalesChatList();
        }
        
        // Select a chat
        function selectSalesChat(chatId) {
            currentSalesChatId = chatId;
            const chat = salesChats.find(c => c.id === chatId);
            if (!chat) return;
            
            // Update slot context if different
            if (chat.prescheduledId) {
                const prescheduled = allPrescheduledSlots.find(ps => ps.id === chat.prescheduledId);
                if (prescheduled) {
                    currentSalesSlot = { day: chat.slotDay, time: chat.slotTime, prescheduled };
                    updateSlotContextBanner(prescheduled);
                }
            }
            
            showSalesActiveChat();
            renderSalesMessages(chat);
            updateSalesChatHeader(chat);
            renderSalesChatList();
            
            // Update context-aware suggestions
            updateContextSuggestions();
        }
        
        function updateSalesChatHeader(chat) {
            document.getElementById('salesChatAvatar').textContent = getSalesInitials(chat.customerName);
            document.getElementById('salesChatName').textContent = chat.customerName || 'New Customer';
            document.getElementById('salesChatDetails').innerHTML = `
                <span>ðŸ“ ${chat.state || 'Unknown'}</span>
                <span>ðŸŽ¯ ${chat.reason || 'Unknown'}</span>
                ${chat.downsellReady ? `<span style="color: #ff9800;">ðŸ¦Š Downsell Ready</span>` : ''}
            `;
            
            // Show "Add to Slot" button if hot lead
            const addBtn = document.getElementById('salesAddStudentBtn');
            if (addBtn) {
                addBtn.style.display = chat.urgency === 'red' ? 'inline-flex' : 'none';
            }
            
            // Show/hide downsell button
            let downsellBtn = document.getElementById('salesDownsellBtn');
            if (!downsellBtn) {
                // Create downsell button if it doesn't exist
                const actionsDiv = document.querySelector('.sales-chat-header-actions');
                if (actionsDiv) {
                    const btn = document.createElement('button');
                    btn.id = 'salesDownsellBtn';
                    btn.className = 'sales-header-btn';
                    btn.style.background = 'rgba(255,152,0,0.2)';
                    btn.style.borderColor = 'rgba(255,152,0,0.5)';
                    btn.style.color = '#ff9800';
                    btn.innerHTML = 'ðŸ¦Š Send Follow-up';
                    btn.onclick = () => sendDownsellMessage(currentSalesChatId);
                    actionsDiv.insertBefore(btn, actionsDiv.firstChild);
                    downsellBtn = btn;
                }
            }
            if (downsellBtn) {
                downsellBtn.style.display = chat.downsellReady ? 'inline-flex' : 'none';
            }
        }
        
        // Render messages
        function renderSalesMessages(chat) {
            const container = document.getElementById('salesMessagesContainer');
            if (!container) return;
            
            const messages = chat.messages || [];
            
            if (messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No messages yet</div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                let roleClass = msg.role;
                let label = '';
                
                switch (msg.role) {
                    case 'admin': label = 'ðŸ“¤ You sent'; break;
                    case 'customer': label = 'ðŸ‘¤ Customer'; break;
                    case 'ai': label = 'âœ¨ AI Suggestion (click to copy)'; break;
                }
                
                return `
                    <div class="sales-message ${roleClass}" ${msg.role === 'ai' ? `onclick="copySalesMessageText(this)"` : ''}>
                        <div class="sales-message-label">${label}</div>
                        <div class="sales-message-bubble">${escapeHtml(msg.content)}</div>
                        <div class="sales-message-time">${formatSalesTime(msg.timestamp)}</div>
                    </div>
                `;
            }).join('');
            
            // Add typing indicator if processing
            if (salesChatProcessing.has(chat.id)) {
                container.innerHTML += `
                    <div class="sales-message ai">
                        <div class="sales-message-label">âœ¨ AI is thinking...</div>
                        <div class="sales-typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                `;
            }
            
            container.scrollTop = container.scrollHeight;
        }
        
        function copySalesMessageText(element) {
            const bubble = element.querySelector('.sales-message-bubble');
            if (bubble) {
                navigator.clipboard.writeText(bubble.textContent).then(() => {
                    bubble.style.boxShadow = '0 0 20px rgba(57,255,20,0.5)';
                    setTimeout(() => bubble.style.boxShadow = '', 300);
                });
            }
        }
        
        // Create new chat from message
        async function createSalesChatFromMessage() {
            const input = document.getElementById('salesNewChatInput');
            const customerMessage = input?.value.trim();
            
            if (!customerMessage) {
                alert('Please paste the customer\'s message first.');
                return;
            }
            
            if (!currentSalesSlot?.prescheduled) {
                alert('No slot selected.');
                return;
            }
            
            input.value = '';
            
            const ps = currentSalesSlot.prescheduled;
            const enrolledCount = ps.enrolledStudents?.length || 0;
            const maxSeats = ps.maxSeats || salesChatSettings.defaultMaxSeats || 5;
            const seatsLeft = maxSeats - enrolledCount;
            
            // Extract name from message
            const customerName = extractSalesCustomerName(customerMessage) || 'New Customer';
            
            // Build first response using template
            const firstResponse = buildSalesFirstMessage(ps, seatsLeft, customerName);
            
            const chatData = {
                slotDay: currentSalesSlot.day,
                slotTime: currentSalesSlot.time,
                prescheduledId: ps.id,
                teacherId: ps.teacherId,
                teacherName: ps.teacherName,
                classType: ps.classType,
                customerName: customerName,
                state: extractSalesState(customerMessage),
                reason: extractSalesReason(customerMessage),
                urgency: 'grey',
                status: 'open',
                messages: [
                    { role: 'customer', content: customerMessage, timestamp: new Date().toISOString() },
                    { role: 'ai', content: firstResponse, timestamp: new Date().toISOString() }
                ],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                const docRef = await db.collection('sales_chats').add(chatData);
                currentSalesChatId = docRef.id;
                
                // Add to local cache
                salesChats.unshift({ id: docRef.id, ...chatData });
                
                showSalesActiveChat();
                renderSalesChatList();
                
                // Render messages immediately (no need to call AI - we already have the template response)
                const chat = salesChats.find(c => c.id === docRef.id);
                if (chat) {
                    renderSalesMessages(chat);
                }
                
            } catch (e) {
                console.error('Error creating sales chat:', e);
                alert('Error creating chat: ' + e.message);
            }
        }
        
        function buildSalesFirstMessage(ps, seatsLeft, customerName) {
            const template = salesChatSettings.firstMessageTemplate;
            const seatsMsg = seatsLeft >= 5 ? '3 more seats left' : seatsLeft >= 3 ? '2 more seats left' : seatsLeft === 1 ? '1 more seat left' : seatsLeft + ' seats left';
            const startDate = ps.startDate ? new Date(ps.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'soon';
            
            return template
                .replace(/{customerName}/g, customerName)
                .replace(/{teacherName}/g, ps.teacherName || 'Calvin')
                .replace(/{day}/g, currentSalesSlot.day)
                .replace(/{time}/g, currentSalesSlot.time)
                .replace(/{seatsMessage}/g, seatsMsg)
                .replace(/{classType}/g, LEVELS[ps.classType] || ps.classType || 'Class')
                .replace(/{startDate}/g, startDate);
        }
        
        // Send message (customer reply)
        async function sendSalesMessage() {
            const input = document.getElementById('salesMessageInput');
            const customerMessage = input?.value.trim();
            
            if (!customerMessage || !currentSalesChatId) return;
            input.value = '';
            
            try {
                const chat = salesChats.find(c => c.id === currentSalesChatId);
                if (!chat) return;
                
                const messages = [...(chat.messages || []), {
                    role: 'customer',
                    content: customerMessage,
                    timestamp: new Date().toISOString()
                }];
                
                // Detect urgency
                const urgency = detectSalesUrgency(messages);
                
                // Update messages first
                await db.collection('sales_chats').doc(currentSalesChatId).update({
                    messages,
                    urgency,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local chat
                chat.messages = messages;
                chat.urgency = urgency;
                
                // Extract and update customer info (name, state, reason)
                const infoUpdates = await updateCustomerInfoFromMessages(currentSalesChatId, messages, chat);
                Object.assign(chat, infoUpdates);
                
                // Generate AI response with updated chat info
                await generateSalesAIResponse(currentSalesChatId, chat);
                
            } catch (e) {
                console.error('Error sending message:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Generate AI response
        async function generateSalesAIResponse(chatId, chat) {
            salesChatProcessing.add(chatId);
            renderSalesMessages(chat);
            
            let aiText = '';
            
            try {
                const ps = currentSalesSlot?.prescheduled || allPrescheduledSlots.find(p => p.id === chat.prescheduledId);
                const enrolledCount = ps?.enrolledStudents?.length || 0;
                const maxSeats = ps?.maxSeats || 5;
                const seatsLeft = maxSeats - enrolledCount;
                
                // Get available alternatives
                const alternatives = getAvailableSlotAlternatives(chat.slotDay, chat.slotTime);
                
                const customerNameDisplay = (chat.customerName && chat.customerName !== 'New Customer' && chat.customerName !== 'Unknown') 
                    ? chat.customerName 
                    : null;
                
                const toneDescriptions = {
                    friendly: 'warm, friendly, and approachable',
                    professional: 'professional and business-like',
                    casual: 'casual, relaxed, and fun',
                    enthusiastic: 'very enthusiastic and excited'
                };
                
                const lengthDescriptions = {
                    short: '1-2 sentences',
                    balanced: '2-4 sentences',
                    detailed: '4-6 sentences'
                };
                
                const emojiDescriptions = {
                    none: 'Do not use any emojis.',
                    minimal: 'Use 1-2 emojis per message maximum.',
                    moderate: 'Use 2-4 emojis per message.',
                    heavy: 'Use lots of emojis! ðŸŽ‰ðŸ”¥âœ¨'
                };
                
                // Build knowledge base context
                const knowledgeContext = salesKnowledgeBase.length > 0 
                    ? '\n\nADDITIONAL KNOWLEDGE:\n' + salesKnowledgeBase.map(k => `- ${k.title}: ${k.content}`).join('\n')
                    : '';
                
                const systemPrompt = `You are ${salesChatSettings.agentName || 'Calvin'}, ${salesChatSettings.agentRole || 'a Korean Teacher from TikTok'}, helping sell classes for ${salesChatSettings.businessName || 'KoreanLearnin'}.

PERSONALITY:
- Tone: Be ${toneDescriptions[salesChatSettings.personalityTone] || 'friendly and warm'}
- ${emojiDescriptions[salesChatSettings.emojiLevel] || 'Use emojis moderately.'}
- Response length: ${lengthDescriptions[salesChatSettings.responseLength] || '2-4 sentences'}
${salesChatSettings.customPersonality ? `- Special instructions: ${salesChatSettings.customPersonality}` : ''}

CURRENT SLOT:
- Day/Time: ${chat.slotDay} @ ${chat.slotTime} EST
- Class: ${LEVELS[chat.classType] || chat.classType || 'Beginner'}
- Teacher: ${chat.teacherName || salesChatSettings.agentName || 'Calvin'}
- Seats Available: ${seatsLeft} of ${maxSeats}
- Start Date: ${ps?.startDate ? new Date(ps.startDate).toLocaleDateString() : 'TBD'}

CUSTOMER:
- Name: ${customerNameDisplay || 'Not yet known - ask for their name naturally!'}
- Location: ${chat.state || 'Unknown'}
- Interest: ${chat.reason || 'Unknown'}

${alternatives.length > 0 ? `OTHER AVAILABLE SLOTS (suggest if conflict):
${alternatives.map(a => `- ${a.day} @ ${a.time} (${a.type})`).join('\n')}` : ''}

PROGRAMS:
- 6-Week Intro Course: ${salesChatSettings.introCoursePrice || '$100'} total (perfect for beginners)
- 9-Month Advanced: ${salesChatSettings.advancedProgramPrice || '$250/month'}
${salesChatSettings.currentPromotion ? `- CURRENT PROMOTION: ${salesChatSettings.currentPromotion}` : ''}

SCHEDULE: Saturdays & Sundays, 6:30 PM - 11:10 PM EST
Classes are 40 minutes, small groups (5-10 students)
${salesChatSettings.businessWebsite ? `Website: ${salesChatSettings.businessWebsite}` : ''}
${knowledgeContext}

IMPORTANT INSTRUCTIONS:
${customerNameDisplay ? `- Use the customer's name "${customerNameDisplay}" naturally in your response when appropriate (but not in every message)` : '- If you don\'t know the customer\'s name yet, try to ask for it naturally in your response'}
- Guide the conversation toward signup
- If the customer mentions a scheduling conflict, suggest alternative slots`;

                const apiMessages = [
                    { role: 'system', content: systemPrompt },
                    ...chat.messages.slice(-8).map(m => ({
                        role: m.role === 'customer' ? 'user' : 'assistant',
                        content: m.content
                    }))
                ];
                
                console.log('Calling AI with messages:', apiMessages.length);
                console.log('API URL:', SALES_AI_FUNCTION_URL);
                
                const response = await fetch(SALES_AI_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: apiMessages, temperature: 0.7 })
                });
                
                console.log('AI response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('AI result:', result);
                    if (result.success && result.data) {
                        aiText = result.data;
                        // Play notification sound
                        playSalesNotificationSound();
                    } else {
                        console.error('AI returned success:false or no data:', result);
                        aiText = getSalesFallbackResponse(chat.messages);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('AI response not ok:', response.status, errorText);
                    aiText = getSalesFallbackResponse(chat.messages);
                }
                
            } catch (e) {
                console.error('AI error:', e);
                aiText = getSalesFallbackResponse(chat.messages);
            }
            
            // Always add AI response even if fallback
            if (!aiText) {
                aiText = getSalesFallbackResponse(chat.messages);
            }
            
            try {
                const updatedMessages = [...chat.messages, {
                    role: 'ai',
                    content: aiText,
                    timestamp: new Date().toISOString()
                }];
                
                await db.collection('sales_chats').doc(chatId).update({
                    messages: updatedMessages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.error('Error saving AI message:', e);
            } finally {
                salesChatProcessing.delete(chatId);
                // Force re-render
                const updatedChat = salesChats.find(c => c.id === chatId);
                if (updatedChat) {
                    renderSalesMessages(updatedChat);
                }
            }
        }
        
        function getAvailableSlotAlternatives(excludeDay, excludeTime) {
            const alternatives = [];
            
            // Add pre-scheduled slots first
            allPrescheduledSlots.forEach(ps => {
                if (ps.day === excludeDay && ps.time === excludeTime) return;
                const enrolled = ps.enrolledStudents?.length || 0;
                const max = ps.maxSeats || 5;
                if (enrolled < max) {
                    alternatives.push({ day: ps.day, time: ps.time, type: 'Pre-scheduled' });
                }
            });
            
            // Add green slots as waiting list if needed
            if (alternatives.length < 2) {
                const DAYS = ['Saturday', 'Sunday'];
                const TIME_SLOTS = ['6:30 PM', '7:10 PM', '7:50 PM', '8:30 PM', '9:10 PM', '9:50 PM', '10:30 PM', '11:10 PM'];
                
                for (const day of DAYS) {
                    for (const time of TIME_SLOTS) {
                        if (day === excludeDay && time === excludeTime) continue;
                        if (alternatives.length >= 4) break;
                        
                        const isOccupied = allClasses.some(c => c.day === day && c.time === time && c.status !== 'completed');
                        const isPrescheduled = allPrescheduledSlots.some(ps => ps.day === day && ps.time === time);
                        
                        if (!isOccupied && !isPrescheduled) {
                            alternatives.push({ day, time, type: '2-week waiting list' });
                        }
                    }
                }
            }
            
            return alternatives.slice(0, 4);
        }
        
        function getSalesFallbackResponse(messages) {
            const lastMsg = messages[messages.length - 1]?.content.toLowerCase() || '';
            
            if (lastMsg.includes('price') || lastMsg.includes('cost') || lastMsg.includes('how much')) {
                return "Great question! ðŸ’° Our 6-Week Intro Course is $100 total - that's less than $17/week! Perfect for getting started. Would you like me to save you a spot?";
            }
            if (lastMsg.includes('schedule') || lastMsg.includes('time') || lastMsg.includes('when')) {
                return "ðŸ“… Our classes run Saturdays and Sundays from 6:30-11:10 PM EST. Each class is 40 minutes. What time works best for you?";
            }
            if (lastMsg.includes('sign up') || lastMsg.includes('register') || lastMsg.includes('ready')) {
                return "Amazing! ðŸŽ‰ I'm so excited you're ready to start! Let me save your spot. What's the best email to send the registration link?";
            }
            return "Thanks for your interest! ðŸŒŸ Would you like to know more about our programs, or are you ready to get started?";
        }
        
        // Add student to slot
        async function addStudentToSlotFromChat() {
            if (!currentSalesChatId || !currentSalesSlot?.prescheduled) {
                alert('No active chat or slot.');
                return;
            }
            
            const chat = salesChats.find(c => c.id === currentSalesChatId);
            if (!chat) return;
            
            const studentName = chat.customerName || 'Unknown Student';
            
            if (!confirm(`Add "${studentName}" to ${currentSalesSlot.day} @ ${currentSalesSlot.time}?`)) return;
            
            try {
                const ps = currentSalesSlot.prescheduled;
                const students = ps.enrolledStudents || [];
                
                students.push({
                    name: studentName,
                    chatId: currentSalesChatId,
                    enrolledAt: new Date().toISOString()
                });
                
                await db.collection('prescheduled_slots').doc(ps.id).update({
                    enrolledStudents: students
                });
                
                // Update local cache
                const idx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (idx !== -1) {
                    allPrescheduledSlots[idx].enrolledStudents = students;
                }
                
                // Add post-sell message if configured
                if (salesChatSettings.postSellMessage) {
                    const postSellText = getPostSellMessage(chat, ps);
                    const updatedMessages = [...(chat.messages || []), {
                        role: 'admin',
                        content: postSellText,
                        timestamp: new Date().toISOString(),
                        isPostSell: true
                    }];
                    
                    await db.collection('sales_chats').doc(currentSalesChatId).update({
                        messages: updatedMessages,
                        status: 'closed',
                        closedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Just mark chat as closed
                    await db.collection('sales_chats').doc(currentSalesChatId).update({
                        status: 'closed',
                        closedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                alert(`âœ… ${studentName} has been added to ${currentSalesSlot.day} @ ${currentSalesSlot.time}!`);
                
                // Update UI
                updateSlotContextBanner(ps);
                renderSalesChatList();
                
                // Refresh chat to show post-sell message
                if (salesChatSettings.postSellMessage) {
                    selectSalesChat(currentSalesChatId);
                }
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Get post-sell message with variables replaced
        function getPostSellMessage(chat, ps) {
            let msg = salesChatSettings.postSellMessage || '';
            const startDate = ps?.startDate ? new Date(ps.startDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) : 'TBD';
            
            msg = msg.replace(/{customerName}/g, chat.customerName || 'there');
            msg = msg.replace(/{teacherName}/g, chat.teacherName || ps?.teacherName || 'your teacher');
            msg = msg.replace(/{day}/g, chat.slotDay || ps?.day || '');
            msg = msg.replace(/{time}/g, chat.slotTime || ps?.time || '');
            msg = msg.replace(/{classType}/g, LEVELS[chat.classType] || chat.classType || 'Korean Class');
            msg = msg.replace(/{startDate}/g, startDate);
            
            return msg;
        }
        
        // Start new chat (reset to empty state)
        function startNewSalesChat() {
            currentSalesChatId = null;
            showSalesEmptyState();
            renderSalesChatList();
        }
        
        // Delete chat
        async function deleteSalesChat() {
            if (!currentSalesChatId) return;
            if (!confirm('Delete this conversation?')) return;
            
            try {
                await db.collection('sales_chats').doc(currentSalesChatId).delete();
                currentSalesChatId = null;
                showSalesEmptyState();
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Add Response Modal
        function openSalesAddResponseModal() {
            if (!currentSalesChatId) return;
            document.getElementById('salesAddResponseModal').classList.add('active');
            document.getElementById('salesAdminResponseInput').value = '';
        }
        
        function closeSalesAddResponseModal() {
            document.getElementById('salesAddResponseModal').classList.remove('active');
        }
        
        async function saveSalesAdminResponse() {
            const message = document.getElementById('salesAdminResponseInput')?.value.trim();
            if (!message || !currentSalesChatId) return;
            
            try {
                const chat = salesChats.find(c => c.id === currentSalesChatId);
                if (!chat) return;
                
                const messages = [...(chat.messages || []), {
                    role: 'admin',
                    content: message,
                    timestamp: new Date().toISOString()
                }];
                
                await db.collection('sales_chats').doc(currentSalesChatId).update({
                    messages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeSalesAddResponseModal();
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Summary
        function generateSalesSummary() {
            if (!currentSalesChatId) return;
            const chat = salesChats.find(c => c.id === currentSalesChatId);
            if (!chat) return;
            
            const summary = `ðŸ“‹ CUSTOMER SUMMARY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ‘¤ Name: ${chat.customerName || 'Unknown'}
ðŸ“ Location: ${chat.state || 'Unknown'}
ðŸŽ¯ Interest: ${chat.reason || 'Unknown'}

ðŸ“Š Status: ${getSalesUrgencyLabel(chat.urgency).toUpperCase()}
ðŸ’¬ Messages: ${chat.messages?.length || 0}
ðŸ“… Slot: ${chat.slotDay} @ ${chat.slotTime}

ðŸ“ RECENT MESSAGES:
${chat.messages?.slice(-4).map(m => `â€¢ ${m.role === 'customer' ? 'Customer' : 'Us'}: "${truncateSalesText(m.content, 50)}"`).join('\n') || 'None'}

ðŸŽ¯ NEXT STEP:
${chat.urgency === 'red' ? 'â†’ Ready to buy! Guide to registration.' : 
  chat.urgency === 'yellow' ? 'â†’ Interested. Address questions, build value.' : 
  'â†’ Needs nurturing. Focus on building interest.'}`;
            
            document.getElementById('salesSummaryContent').textContent = summary;
            document.getElementById('salesSummaryModal').classList.add('active');
        }
        
        function copySalesSummary() {
            const summary = document.getElementById('salesSummaryContent').textContent;
            navigator.clipboard.writeText(summary).then(() => alert('Copied!'));
        }
        
        // Copy suggestion
        function copySalesSuggestion(element) {
            const preview = element.querySelector('.sales-suggestion-card-preview');
            if (preview) {
                navigator.clipboard.writeText(preview.textContent).then(() => {
                    element.style.borderColor = '#39ff14';
                    setTimeout(() => element.style.borderColor = '', 300);
                });
            }
        }
        
        function copySalesSuggestionFull(element) {
            const fullText = element.dataset.fullText;
            if (fullText) {
                navigator.clipboard.writeText(fullText).then(() => {
                    const btn = element.querySelector('.sales-suggestion-copy-btn');
                    if (btn) {
                        btn.textContent = 'âœ… Copied!';
                        setTimeout(() => btn.textContent = 'ðŸ“‹ Copy', 1500);
                    }
                });
            }
        }
        
        async function editSuggestionWithAI(element) {
            const fullText = element.dataset.fullText;
            const title = element.querySelector('.sales-suggestion-card-title')?.textContent || 'Message';
            
            if (!fullText) return;
            
            // Get current chat context for personalization
            const chat = currentSalesChatId ? salesChats.find(c => c.id === currentSalesChatId) : null;
            const customerName = chat?.customerName || 'the customer';
            const lastCustomerMessage = chat?.messages?.filter(m => m.role === 'customer').pop()?.content || '';
            
            const instruction = prompt(`How would you like to modify this "${title}" message?\n\nExamples:\n- "Make it shorter"\n- "More friendly"\n- "Add urgency"\n- "Personalize for ${customerName}"\n- "Address their concern about time"`);
            
            if (!instruction) return;
            
            // Show loading state
            const aiBtn = element.querySelector('.sales-suggestion-ai-btn');
            const originalText = aiBtn.textContent;
            aiBtn.textContent = 'â³ Editing...';
            aiBtn.disabled = true;
            
            try {
                const systemPrompt = `You are a sales copywriting assistant for KoreanLearnin, a Korean language school. 
Your job is to edit/improve sales messages based on the user's instructions.
Keep the same general meaning but apply the requested changes.
Keep responses friendly, professional, and concise (2-4 sentences max).
Use emojis sparingly but appropriately.

${chat ? `CONTEXT:
- Customer name: ${customerName}
- Customer's last message: "${lastCustomerMessage}"
- Slot: ${chat.slotDay} @ ${chat.slotTime}` : ''}`;

                const response = await fetch(SALES_AI_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: `Original message:\n"${fullText}"\n\nInstruction: ${instruction}\n\nProvide only the edited message, no explanations.` }
                        ],
                        temperature: 0.7
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        // Copy the edited text to clipboard
                        await navigator.clipboard.writeText(result.data);
                        
                        // Update the preview temporarily to show the edit
                        const preview = element.querySelector('.sales-suggestion-card-preview');
                        const originalPreview = preview.textContent;
                        preview.textContent = result.data;
                        preview.style.color = '#39ff14';
                        preview.style.webkitLineClamp = '5';
                        
                        aiBtn.textContent = 'âœ… Copied!';
                        
                        // Reset after 5 seconds
                        setTimeout(() => {
                            preview.textContent = originalPreview;
                            preview.style.color = '';
                            preview.style.webkitLineClamp = '2';
                            aiBtn.textContent = originalText;
                        }, 5000);
                    } else {
                        throw new Error('AI returned no data');
                    }
                } else {
                    throw new Error('AI request failed');
                }
            } catch (e) {
                console.error('AI edit error:', e);
                alert('Failed to edit with AI. The original text has been copied instead.');
                navigator.clipboard.writeText(fullText);
                aiBtn.textContent = originalText;
            } finally {
                aiBtn.disabled = false;
            }
        }
        
        // Show slot students modal
        function showSlotStudentsModal(ps) {
            const students = ps.enrolledStudents || [];
            const maxSeats = ps.maxSeats || salesChatSettings.defaultMaxSeats || 5;
            
            document.getElementById('slotStudentsSlotInfo').textContent = `${ps.day} @ ${ps.time}`;
            document.getElementById('slotStudentsCapacity').textContent = `${students.length}/${maxSeats} seats`;
            
            // Seat dots
            let seatsHtml = '';
            for (let i = 0; i < maxSeats; i++) {
                seatsHtml += `<div class="sales-seat-dot ${i < students.length ? 'filled' : 'empty'}"></div>`;
            }
            document.getElementById('slotStudentsSeatsVisual').innerHTML = seatsHtml;
            
            // Student list
            document.getElementById('slotStudentsList').innerHTML = students.length ? students.map((s, i) => `
                <div class="sales-student-item">
                    <div class="sales-student-item-info">
                        <div class="sales-student-item-name">${escapeHtml(s.name)}</div>
                        <div class="sales-student-item-meta">Enrolled: ${new Date(s.enrolledAt).toLocaleDateString()}</div>
                    </div>
                    <div class="sales-student-item-actions">
                        ${s.chatId ? `<button class="sales-student-chat-btn" onclick="openStudentChat('${s.chatId}')">ðŸ’¬ Chat</button>` : ''}
                        <button class="sales-student-remove-btn" onclick="removeStudentFromSlot('${ps.id}', ${i})">Remove</button>
                    </div>
                </div>
            `).join('') : '<p style="color: #888; font-size: 12px; text-align: center;">No students enrolled yet.</p>';
            
            window.currentStudentModalSlot = ps;
            document.getElementById('slotStudentsModal').classList.add('active');
        }
        
        async function removeStudentFromSlot(psId, idx) {
            if (!confirm('Remove this student?')) return;
            
            try {
                const ps = allPrescheduledSlots.find(p => p.id === psId);
                if (!ps) return;
                
                const students = ps.enrolledStudents || [];
                students.splice(idx, 1);
                
                await db.collection('prescheduled_slots').doc(psId).update({ enrolledStudents: students });
                ps.enrolledStudents = students;
                
                showSlotStudentsModal(ps);
                renderSlotGrid();
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        function openStudentChat(chatId) {
            closeModal('slotStudentsModal');
            const chat = salesChats.find(c => c.id === chatId);
            if (chat) {
                document.getElementById('salesChatModal').classList.add('active');
                selectSalesChat(chatId);
            }
        }
        
        function openSalesChatForSlot() {
            closeModal('slotStudentsModal');
            if (window.currentStudentModalSlot) {
                const ps = window.currentStudentModalSlot;
                openSalesChatFromSlot(ps.day, ps.time, ps);
            }
        }
        
        // Helper functions
        function getSalesInitials(name) {
            if (!name || name === 'New Customer') return '?';
            return name.split(' ').map(s => s[0]).join('').slice(0, 2).toUpperCase();
        }
        
        function getSalesUrgencyLabel(urgency) {
            switch (urgency) {
                case 'red': return 'ðŸ”¥ Hot';
                case 'yellow': return 'ðŸ’› Warm';
                default: return 'â„ï¸ Cold';
            }
        }
        
        function truncateSalesText(text, len) {
            if (!text) return '';
            return text.length > len ? text.substring(0, len) + '...' : text;
        }
        
        function formatSalesTime(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function getSalesTimeAgo(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const diff = Math.floor((new Date() - date) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }
        
        function extractSalesCustomerName(text) {
            // More comprehensive patterns for name extraction
            const patterns = [
                /my name is ([A-Za-z]+)/i,
                /I'm ([A-Za-z]+)/i,
                /I am ([A-Za-z]+)/i,
                /call me ([A-Za-z]+)/i,
                /this is ([A-Za-z]+)/i,
                /^([A-Za-z]+) here/i,
                /^Hey,? (?:it's |this is )?([A-Za-z]+)/i,
                /^Hi,? (?:it's |this is )?([A-Za-z]+)/i,
                /^Hello,? (?:it's |this is )?([A-Za-z]+)/i,
                /name'?s ([A-Za-z]+)/i,
                /^([A-Za-z]+)!? (?:here|checking in)/i,
                /- ([A-Za-z]+)$/m,  // Signature at end like "- John"
                /^([A-Za-z]+)$/m    // Just a name on its own line
            ];
            
            // Common words to exclude
            const excludeWords = ['hi', 'hey', 'hello', 'yes', 'no', 'yeah', 'yep', 'nope', 'thanks', 'thank', 'please', 'sorry', 'okay', 'ok', 'sure', 'great', 'good', 'nice', 'cool', 'awesome', 'wow', 'oh', 'um', 'uh', 'well', 'so', 'just', 'really', 'very', 'much', 'more', 'here', 'there', 'this', 'that', 'what', 'when', 'where', 'who', 'why', 'how', 'can', 'could', 'would', 'should', 'will', 'have', 'has', 'had', 'do', 'does', 'did', 'am', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'the', 'a', 'an', 'and', 'or', 'but', 'if', 'then', 'also', 'too', 'korean', 'class', 'classes', 'course', 'learn', 'learning', 'interested', 'want', 'looking', 'need', 'help', 'know', 'think', 'feel', 'like', 'love', 'hate', 'want', 'need', 'hope', 'wish'];
            
            for (const p of patterns) {
                const m = text.match(p);
                if (m) {
                    const name = m[1].charAt(0).toUpperCase() + m[1].slice(1).toLowerCase();
                    // Check if it's a real name (not a common word)
                    if (!excludeWords.includes(name.toLowerCase()) && name.length >= 2 && name.length <= 20) {
                        return name;
                    }
                }
            }
            return null;
        }
        
        function extractSalesCustomerNameFromMessages(messages) {
            // Check each customer message, prioritizing earlier ones where they likely introduced themselves
            const customerMessages = messages.filter(m => m.role === 'customer');
            for (const msg of customerMessages) {
                const name = extractSalesCustomerName(msg.content);
                if (name) return name;
            }
            return null;
        }
        
        // Update customer info in real-time as we learn more
        async function updateCustomerInfoFromMessages(chatId, messages, existingChat) {
            const updates = {};
            
            // Try to extract name if we don't have one or it's generic
            const currentName = existingChat?.customerName;
            if (!currentName || currentName === 'New Customer' || currentName === 'Unknown') {
                const extractedName = extractSalesCustomerNameFromMessages(messages);
                if (extractedName) {
                    updates.customerName = extractedName;
                    console.log('Extracted customer name:', extractedName);
                }
            }
            
            // Try to extract state/location
            const currentState = existingChat?.state;
            if (!currentState || currentState === 'Unknown') {
                const allText = messages.filter(m => m.role === 'customer').map(m => m.content).join(' ');
                const extractedState = extractSalesState(allText);
                if (extractedState) {
                    updates.state = extractedState;
                    console.log('Extracted customer state:', extractedState);
                }
            }
            
            // Try to extract reason for learning
            const currentReason = existingChat?.reason;
            if (!currentReason || currentReason === 'Unknown') {
                const allText = messages.filter(m => m.role === 'customer').map(m => m.content).join(' ');
                const extractedReason = extractSalesReason(allText);
                if (extractedReason) {
                    updates.reason = extractedReason;
                    console.log('Extracted learning reason:', extractedReason);
                }
            }
            
            // Apply updates if any
            if (Object.keys(updates).length > 0) {
                await db.collection('sales_chats').doc(chatId).update(updates);
                
                // Update local cache
                const idx = salesChats.findIndex(c => c.id === chatId);
                if (idx !== -1) {
                    Object.assign(salesChats[idx], updates);
                }
                
                // Refresh UI
                renderSalesChatList();
                if (currentSalesChatId === chatId) {
                    const updatedChat = salesChats.find(c => c.id === chatId);
                    if (updatedChat) {
                        document.getElementById('salesChatAvatar').textContent = getSalesInitials(updatedChat.customerName);
                        document.getElementById('salesChatName').textContent = updatedChat.customerName || 'New Customer';
                        document.getElementById('salesChatDetails').innerHTML = `
                            <span>ðŸ“ ${updatedChat.state || 'Unknown'}</span>
                            <span>ðŸŽ¯ ${updatedChat.reason || 'Unknown'}</span>
                        `;
                    }
                }
            }
            
            return updates;
        }
        
        function extractSalesState(text) {
            const states = ['California', 'Texas', 'Florida', 'New York', 'Illinois', 'Pennsylvania', 'Ohio', 'Georgia', 'North Carolina', 'Michigan', 'New Jersey', 'Virginia', 'Washington', 'Arizona', 'Massachusetts', 'Tennessee', 'Indiana', 'Missouri', 'Maryland', 'Wisconsin', 'Colorado', 'Minnesota', 'South Carolina', 'Alabama', 'Louisiana', 'Kentucky', 'Oregon', 'Oklahoma', 'Connecticut', 'Utah', 'Iowa', 'Nevada', 'Arkansas', 'Mississippi', 'Kansas', 'New Mexico', 'Nebraska', 'Idaho', 'West Virginia', 'Hawaii', 'New Hampshire', 'Maine', 'Montana', 'Rhode Island', 'Delaware', 'South Dakota', 'North Dakota', 'Alaska', 'Vermont', 'Wyoming'];
            for (const state of states) {
                if (text.toLowerCase().includes(state.toLowerCase())) return state;
            }
            return null;
        }
        
        function extractSalesReason(text) {
            const reasons = { 'kpop': 'K-pop', 'kdrama': 'K-drama', 'bts': 'K-pop (BTS)', 'blackpink': 'K-pop (Blackpink)', 'travel': 'Travel', 'work': 'Work', 'family': 'Family', 'partner': 'Partner', 'girlfriend': 'Partner', 'boyfriend': 'Partner', 'spouse': 'Partner', 'culture': 'Culture' };
            const lower = text.toLowerCase();
            for (const [key, value] of Object.entries(reasons)) {
                if (lower.includes(key)) return value;
            }
            return null;
        }
        
        function detectSalesUrgency(messages) {
            const text = messages.filter(m => m.role === 'customer').map(m => m.content).join(' ').toLowerCase();
            
            // Use custom keywords from settings or defaults
            const coldKeywords = (salesChatSettings.coldKeywords || 'not interested, too expensive, maybe later, no thanks, can\'t afford').split(',').map(k => k.trim().toLowerCase());
            const hotKeywords = (salesChatSettings.hotKeywords || 'sign up, register, enroll, ready, start now, let\'s do it, i want to, count me in').split(',').map(k => k.trim().toLowerCase());
            const warmKeywords = (salesChatSettings.warmKeywords || 'price, cost, how much, schedule, interested, tell me more, sounds good').split(',').map(k => k.trim().toLowerCase());
            
            for (const kw of coldKeywords) if (kw && text.includes(kw)) return 'grey';
            for (const kw of hotKeywords) if (kw && text.includes(kw)) return 'red';
            for (const kw of warmKeywords) if (kw && text.includes(kw)) return 'yellow';
            return 'grey';
        }
        
        // ==================== END SALES CHAT MODAL FUNCTIONS ====================
        
        // ==================== END SLOT MANAGER FUNCTIONS ====================

        // ==================== ACCOUNT CREATION FUNCTIONS (SHOPIFY) ====================
        
        // Cloud Function URL for Shopify
        const SHOPIFY_FUNCTION_URL = 'https://us-central1-korean-ta-evaluator.cloudfunctions.net/getShopifyCustomersWithTag';
        
        // Global variables for account creation pagination
        let allShopifyCustomersForAccounts = [];
        let filteredShopifyCustomersForAccounts = [];
        let existingAccountEmails = new Set();
        let accountCurrentPage = 1;
        let accountPerPage = 25;

        // Get subscription status from tags (Inactive and Expired merged into Cancelled)
        function getSubscriptionStatus(tags) {
            if (!tags) return 'unknown';
            const tagLower = tags.toLowerCase();
            if (tagLower.includes('appstle_subscription_failed_payment') || tagLower.includes('appstle_subscription_dunning')) return 'failed';
            if (tagLower.includes('appstle_subscription_paused_customer')) return 'paused';
            if (tagLower.includes('appstle_subscription_inactive_customer')) return 'cancelled';
            if (tagLower.includes('appstle_subscription_cancelled_customer')) return 'cancelled';
            if (tagLower.includes('appstle_subscription_expired_customer')) return 'cancelled';
            if (tagLower.includes('appstle_subscription_active_customer')) return 'active';
            if (tagLower.includes('pronunciation')) return 'pronunciation';
            return 'unknown';
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'active': '#39ff14',
                'paused': '#ff9800',
                'failed': '#ff3366',
                'cancelled': '#e91e63',
                'pronunciation': '#9c27b0',
                'unknown': '#666'
            };
            return colors[status] || '#666';
        }

        // Get status label
        function getStatusLabel(status) {
            const labels = {
                'active': 'ACTIVE',
                'paused': 'PAUSED',
                'failed': 'FAILED PAYMENT',
                'cancelled': 'CANCELLED',
                'pronunciation': 'PRONUNCIATION',
                'unknown': 'UNKNOWN'
            };
            return labels[status] || 'UNKNOWN';
        }

        // Cache for Shopify customers
        let shopifyCustomersCache = null;
        let shopifyCustomersCacheTime = null;
        let shopifyCustomersCacheRange = null;

        async function loadShopifyCustomersForAccounts(forceRefresh = false) {
            const loadRange = document.getElementById('accountLoadRange').value;
            const listDiv = document.getElementById('accountCustomersList');
            
            // Check cache - use cached data if same range and less than 5 minutes old
            const cacheAge = shopifyCustomersCacheTime ? (Date.now() - shopifyCustomersCacheTime) / 1000 / 60 : Infinity;
            if (!forceRefresh && shopifyCustomersCache && shopifyCustomersCacheRange === loadRange && cacheAge < 5) {
                console.log('Using cached Shopify customers (age: ' + cacheAge.toFixed(1) + ' min)');
                allShopifyCustomersForAccounts = shopifyCustomersCache;
                filteredShopifyCustomersForAccounts = [...allShopifyCustomersForAccounts];
                accountCurrentPage = 1;
                
                document.getElementById('accountLoadControls').style.display = 'none';
                document.getElementById('accountRefreshBtn').style.display = 'inline-block';
                document.getElementById('accountControls').style.display = 'block';
                document.getElementById('accountPagination').style.display = 'block';
                
                updateAccountDashboard();
                renderShopifyCustomersForAccounts();
                updateAccountCacheStatus();
                return;
            }
            
            listDiv.innerHTML = '<p style="color: #00ffff; font-size: 13px;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading Shopify customers...</p>';
            
            document.getElementById('accountControls').style.display = 'none';
            document.getElementById('accountPagination').style.display = 'none';

            try {
                // First, get all existing Firebase accounts from 'users' collection
                const usersSnapshot = await db.collection('users').get();
                existingAccountEmails = new Set();
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.email) {
                        existingAccountEmails.add(userData.email.toLowerCase());
                    }
                });
                console.log('Found existing accounts:', existingAccountEmails.size);

                // Calculate date filter for Shopify API
                let createdAtMin = null;
                if (loadRange !== 'all') {
                    const days = parseInt(loadRange);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    createdAtMin = cutoffDate.toISOString();
                }

                // Fetch Shopify customers via Cloud Function with date filter
                // Request default_address to get location info
                const response = await fetch(SHOPIFY_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        data: {
                            updated_at_min: createdAtMin,
                            fields: 'id,email,first_name,last_name,phone,tags,created_at,updated_at,default_address,addresses'
                        }
                    })
                });

                const result = await response.json();
                const data = result.result;

                if (data.success && data.customers) {
                    allShopifyCustomersForAccounts = data.customers;
                    
                    // Sort by last name
                    allShopifyCustomersForAccounts.sort((a, b) => 
                        ((a.last_name || '') + (a.first_name || '')).localeCompare((b.last_name || '') + (b.first_name || ''))
                    );
                    
                    console.log('Loaded Shopify customers:', allShopifyCustomersForAccounts.length);

                    // Cache the results
                    shopifyCustomersCache = allShopifyCustomersForAccounts;
                    shopifyCustomersCacheTime = Date.now();
                    shopifyCustomersCacheRange = loadRange;

                    filteredShopifyCustomersForAccounts = [...allShopifyCustomersForAccounts];
                    accountCurrentPage = 1;
                    
                    document.getElementById('accountLoadControls').style.display = 'none';
                    document.getElementById('accountRefreshBtn').style.display = 'inline-block';
                    document.getElementById('accountControls').style.display = 'block';
                    document.getElementById('accountPagination').style.display = 'block';
                    
                    updateAccountDashboard();
                    renderShopifyCustomersForAccounts();
                    updateAccountCacheStatus();
                } else {
                    throw new Error(data.message || 'Failed to fetch customers');
                }

            } catch (error) {
                console.error('Error loading Shopify customers:', error);
                listDiv.innerHTML = `<p style="color: #ff3366; font-size: 13px;">Error: ${error.message}</p>`;
            }
        }

        function refreshShopifyCustomersForAccounts() {
            // Show load controls again so user can change range if needed
            document.getElementById('accountLoadControls').style.display = 'block';
            loadShopifyCustomersForAccounts(true);
        }

        function updateAccountCacheStatus() {
            const rangeLabels = {
                '7': 'Last 7 Days',
                '14': 'Last 14 Days',
                '30': 'Last 30 Days',
                '90': 'Last 3 Months',
                'all': 'All Time'
            };
            const rangeLabel = rangeLabels[shopifyCustomersCacheRange] || shopifyCustomersCacheRange;
            const loadedTime = shopifyCustomersCacheTime ? new Date(shopifyCustomersCacheTime).toLocaleTimeString() : '';
            
            document.getElementById('accountLastLoaded').innerHTML = `ðŸ“Š Showing: <strong>${rangeLabel}</strong> (${allShopifyCustomersForAccounts.length} customers) â€¢ Loaded at ${loadedTime}`;
        }

        function updateAccountDashboard() {
            const withAccount = allShopifyCustomersForAccounts.filter(c => existingAccountEmails.has((c.email || '').toLowerCase())).length;
            const withoutAccount = allShopifyCustomersForAccounts.length - withAccount;
            
            document.getElementById('statTotalCustomers').textContent = allShopifyCustomersForAccounts.length;
            document.getElementById('statWithAccount').textContent = withAccount;
            document.getElementById('statWithoutAccount').textContent = withoutAccount;
        }

        function filterShopifyCustomersForAccounts() {
            const searchTerm = document.getElementById('accountSearch').value.toLowerCase();
            const accountFilter = document.getElementById('accountFilter').value;
            const statusFilter = document.getElementById('accountStatusFilter').value;
            const tagFilter = document.getElementById('accountTagFilter').value;
            const dateFilter = document.getElementById('accountDateFilter').value;

            // Calculate date cutoff
            let dateCutoff = null;
            if (dateFilter !== 'all') {
                const days = parseInt(dateFilter);
                dateCutoff = new Date();
                dateCutoff.setDate(dateCutoff.getDate() - days);
            }

            filteredShopifyCustomersForAccounts = allShopifyCustomersForAccounts.filter(c => {
                const fullName = `${c.first_name || ''} ${c.last_name || ''}`.toLowerCase();
                const email = (c.email || '').toLowerCase();
                const matchesSearch = fullName.includes(searchTerm) || email.includes(searchTerm);
                
                const hasAccount = existingAccountEmails.has(email);
                let matchesAccountFilter = true;
                if (accountFilter === 'no-account') matchesAccountFilter = !hasAccount;
                if (accountFilter === 'has-account') matchesAccountFilter = hasAccount;

                // Subscription status filter
                let matchesStatusFilter = true;
                if (statusFilter !== 'all') {
                    const customerStatus = getSubscriptionStatus(c.tags);
                    matchesStatusFilter = customerStatus === statusFilter;
                }

                // Tag filter - check if customer has the selected tag
                let matchesTagFilter = true;
                if (tagFilter !== 'all') {
                    const customerTags = (c.tags || '').toUpperCase();
                    matchesTagFilter = customerTags.includes(tagFilter);
                }

                // Date filter (using updated_at from Shopify)
                let matchesDateFilter = true;
                if (dateCutoff && c.updated_at) {
                    const customerDate = new Date(c.updated_at);
                    matchesDateFilter = customerDate >= dateCutoff;
                }

                return matchesSearch && matchesAccountFilter && matchesStatusFilter && matchesTagFilter && matchesDateFilter;
            });

            accountCurrentPage = 1;
            renderShopifyCustomersForAccounts();
        }

        function changeAccountPerPage() {
            accountPerPage = parseInt(document.getElementById('accountPerPage').value);
            accountCurrentPage = 1;
            renderShopifyCustomersForAccounts();
        }

        function accountPrevPage() {
            if (accountCurrentPage > 1) {
                accountCurrentPage--;
                renderShopifyCustomersForAccounts();
            }
        }

        function accountNextPage() {
            const totalPages = Math.ceil(filteredShopifyCustomersForAccounts.length / accountPerPage);
            if (accountCurrentPage < totalPages) {
                accountCurrentPage++;
                renderShopifyCustomersForAccounts();
            }
        }

        function renderShopifyCustomersForAccounts() {
            const listDiv = document.getElementById('accountCustomersList');
            const totalPages = Math.ceil(filteredShopifyCustomersForAccounts.length / accountPerPage) || 1;
            const startIdx = (accountCurrentPage - 1) * accountPerPage;
            const endIdx = startIdx + accountPerPage;
            const pageCustomers = filteredShopifyCustomersForAccounts.slice(startIdx, endIdx);

            // Update pagination info
            document.getElementById('accountPageInfo').textContent = `Page ${accountCurrentPage} of ${totalPages} (${filteredShopifyCustomersForAccounts.length} customers)`;
            document.getElementById('accountPrevBtn').disabled = accountCurrentPage === 1;
            document.getElementById('accountNextBtn').disabled = accountCurrentPage === totalPages;

            if (pageCustomers.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 13px; color: #888; grid-column: 1/-1;">No customers match your filter criteria.</p>';
                return;
            }

            let html = '';
            pageCustomers.forEach(c => {
                const hasAccount = existingAccountEmails.has((c.email || '').toLowerCase());
                const borderColor = hasAccount ? '#39ff14' : '#ff9800';
                const accountBadge = hasAccount 
                    ? '<span style="background: #39ff14; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">âœ… HAS ACCOUNT</span>'
                    : '<span style="background: #ff9800; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">âš ï¸ NO ACCOUNT</span>';
                
                // Subscription status
                const subStatus = getSubscriptionStatus(c.tags);
                const subColor = getStatusColor(subStatus);
                const subLabel = getStatusLabel(subStatus);
                const subBadge = `<span style="background: ${subColor}; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${subLabel}</span>`;
                
                const fullName = `${c.first_name || ''} ${c.last_name || ''}`.trim() || 'Unknown';
                
                // Get location from default_address or first address in addresses array
                let addr = c.default_address || null;
                if (!addr && c.addresses && c.addresses.length > 0) {
                    addr = c.addresses[0];
                }
                addr = addr || {};
                const city = addr.city || '';
                const state = addr.province || addr.province_code || '';
                const location = city && state ? `${city}, ${state}` : (city || state || 'N/A');
                
                // Get tags
                const tags = c.tags || '';
                const tagsList = tags.split(',').map(t => t.trim()).filter(t => t);
                const tagsDisplay = tagsList.length > 0 
                    ? tagsList.map(t => `<span style="background: rgba(255,0,255,0.3); color: #ff88ff; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 3px;">${t}</span>`).join('')
                    : '<span style="color: #666; font-size: 11px;">No tags</span>';
                
                // Format updated date
                const updatedDate = c.updated_at ? new Date(c.updated_at).toLocaleDateString() : 'N/A';
                
                // Buttons based on account status
                let actionButtons = '';
                if (hasAccount) {
                    // Has account - show Freeze and Delete buttons
                    actionButtons = `
                        <button class="btn btn-warning btn-sm" style="margin-top: 10px;" onclick="freezeCustomerAccount('${escapeHtmlForAcct(c.email || '')}', '${escapeHtmlForAcct(fullName)}')">
                            ðŸ”’ FREEZE
                        </button>
                        ${canDelete() ? `<button class="btn btn-danger btn-sm admin-delete-btn" style="margin-top: 10px; margin-left: 5px;" onclick="deleteCustomerAccount('${escapeHtmlForAcct(c.email || '')}', '${escapeHtmlForAcct(fullName)}')">
                            ðŸ—‘ï¸ DELETE
                        </button>` : ''}
                    `;
                } else {
                    // No account - show Create button (passing city, state, tags)
                    actionButtons = `
                        <button class="btn btn-success btn-sm" style="margin-top: 10px;" onclick="openCreateAccountModal('${c.id}', '${escapeHtmlForAcct(fullName)}', '${escapeHtmlForAcct(c.email || '')}', '${escapeHtmlForAcct(c.phone || '')}', '${escapeHtmlForAcct(city)}', '${escapeHtmlForAcct(state)}', '${escapeHtmlForAcct(tags)}')">
                            âž• CREATE ACCOUNT
                        </button>
                    `;
                }

                // Remove tag button (always shown)
                const removeTagBtn = `<button class="btn btn-info btn-sm" style="margin-top: 10px; margin-left: 5px;" onclick="removeCustomerTag('${c.id}', '${escapeHtmlForAcct(fullName)}')">
                    ðŸ·ï¸ REMOVE TAG
                </button>`;

                html += `
                    <div style="background: rgba(0,0,0,0.5); border: 2px solid ${borderColor}; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                            <span style="color: #00ffff; font-size: 14px;">${fullName}</span>
                            ${accountBadge}
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ðŸ“§ ${c.email || 'No email'}</div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ðŸ“ž ${c.phone || 'No phone'}</div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ðŸ“ ${location}</div>
                        <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Shopify ID: ${c.id}</div>
                        <div style="font-size: 11px; color: #888; margin-bottom: 8px;">ðŸ“… Updated: ${updatedDate}</div>
                        <div style="margin-bottom: 5px;">${subBadge}</div>
                        <div style="margin-bottom: 8px;">${tagsDisplay}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${actionButtons}
                            ${removeTagBtn}
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        function escapeHtmlForAcct(str) {
            if (!str) return '';
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function openCreateAccountModal(shopifyId, name, email, phone, city, state, tags) {
            document.getElementById('createAcctShopifyId').value = shopifyId;
            document.getElementById('createAcctName').value = name;
            document.getElementById('createAcctEmail').value = email;
            document.getElementById('createAcctPhone').value = phone || '';
            document.getElementById('createAcctCity').value = city || '';
            document.getElementById('createAcctState').value = state || '';
            document.getElementById('createAcctTags').value = tags || '';
            document.getElementById('createAcctPassword').value = '';
            document.getElementById('createAcctPasswordConfirm').value = '';
            document.getElementById('createAccountMessage').innerHTML = '';
            document.getElementById('submitCreateAcctBtn').disabled = false;
            document.getElementById('submitCreateAcctBtn').textContent = 'âœ… CREATE ACCOUNT';
            
            document.getElementById('createAccountModal').classList.add('active');
        }

        function closeCreateAccountModal() {
            document.getElementById('createAccountModal').classList.remove('active');
        }
        
        function generatePassword() {
            // Generate a random 8-character password with letters and numbers
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Fill both password fields
            document.getElementById('createAcctPassword').value = password;
            document.getElementById('createAcctPasswordConfirm').value = password;
        }

        async function submitCreateCustomerAccount() {
            const shopifyId = document.getElementById('createAcctShopifyId').value;
            const name = document.getElementById('createAcctName').value;
            const email = document.getElementById('createAcctEmail').value;
            const phone = document.getElementById('createAcctPhone').value;
            const city = document.getElementById('createAcctCity').value;
            const state = document.getElementById('createAcctState').value;
            const tags = document.getElementById('createAcctTags').value;
            const password = document.getElementById('createAcctPassword').value;
            const passwordConfirm = document.getElementById('createAcctPasswordConfirm').value;
            const messageDiv = document.getElementById('createAccountMessage');
            const btn = document.getElementById('submitCreateAcctBtn');

            // Validation
            if (!password || password.length < 6) {
                messageDiv.innerHTML = '<div style="background: rgba(255,51,102,0.2); border: 1px solid #ff3366; padding: 10px; border-radius: 5px; color: #ff3366; font-size: 12px; margin-bottom: 10px;">âš ï¸ Password must be at least 6 characters</div>';
                return;
            }

            if (password !== passwordConfirm) {
                messageDiv.innerHTML = '<div style="background: rgba(255,51,102,0.2); border: 1px solid #ff3366; padding: 10px; border-radius: 5px; color: #ff3366; font-size: 12px; margin-bottom: 10px;">âš ï¸ Passwords do not match</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creating...';
            messageDiv.innerHTML = '<div style="background: rgba(0,255,255,0.2); border: 1px solid #00ffff; padding: 10px; border-radius: 5px; color: #00ffff; font-size: 12px; margin-bottom: 10px;">â³ Creating account...</div>';

            try {
                // Use secondary auth to create account without logging out admin
                const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                
                // Sign out of secondary auth immediately
                await secondaryAuth.signOut();
                
                // Add to users collection with location and tags
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    displayName: name,
                    phoneNumber: phone || null,
                    city: city || null,
                    state: state || null,
                    shopifyTags: tags || null,
                    role: 'student',
                    shopifyCustomerId: shopifyId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local cache
                existingAccountEmails.add(email.toLowerCase());
                
                messageDiv.innerHTML = '<div style="background: rgba(57,255,20,0.2); border: 1px solid #39ff14; padding: 10px; border-radius: 5px; color: #39ff14; font-size: 12px; margin-bottom: 10px;">âœ… Account created successfully!</div>';
                
                // Close modal after delay and refresh
                setTimeout(() => {
                    closeCreateAccountModal();
                    updateAccountDashboard();
                    renderShopifyCustomersForAccounts();
                }, 1500);

            } catch (error) {
                console.error('Error creating account:', error);
                messageDiv.innerHTML = `<div style="background: rgba(255,51,102,0.2); border: 1px solid #ff3366; padding: 10px; border-radius: 5px; color: #ff3366; font-size: 12px; margin-bottom: 10px;">âŒ Error: ${error.message}</div>`;
                btn.disabled = false;
                btn.textContent = 'âœ… CREATE ACCOUNT';
            }
        }

        // Remove Tag Function - Opens Shopify admin to edit customer
        function removeCustomerTag(shopifyId, customerName) {
            if (confirm(`This will open Shopify admin to edit ${customerName}'s tags.\n\nYou'll need to manually remove the subscription tag from the customer.\n\nContinue?`)) {
                // Open Shopify admin customer page in new tab
                const shopifyAdminUrl = `https://admin.shopify.com/store/koreanlearnin/customers/${shopifyId}`;
                window.open(shopifyAdminUrl, '_blank');
            }
        }

        // Cloud Function URLs for account management
        const ACCOUNT_FUNCTIONS = {
            freezeStudentAccount: 'https://us-central1-korean-ta-evaluator.cloudfunctions.net/freezeStudentAccount',
            unfreezeStudentAccount: 'https://us-central1-korean-ta-evaluator.cloudfunctions.net/unfreezeStudentAccount',
            deleteStudentAccount: 'https://us-central1-korean-ta-evaluator.cloudfunctions.net/deleteStudentAccount'
        };

        // Freeze Customer Account
        async function freezeCustomerAccount(email, customerName) {
            if (!confirm(`Are you sure you want to FREEZE the account for ${customerName}?\n\nThis will disable their login.`)) {
                return;
            }

            try {
                const response = await fetch(ACCOUNT_FUNCTIONS.freezeStudentAccount, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { email: email } })
                });

                const result = await response.json();
                
                if (result.result && result.result.success) {
                    alert(`âœ… Account for ${customerName} has been frozen.`);
                } else {
                    throw new Error(result.result?.message || 'Failed to freeze account');
                }
            } catch (error) {
                console.error('Error freezing account:', error);
                alert(`âŒ Error: ${error.message}`);
            }
        }

        // Delete Customer Account
        async function deleteCustomerAccount(email, customerName) {
            if (!confirm(`âš ï¸ WARNING: Are you sure you want to DELETE the account for ${customerName}?\n\nThis action CANNOT be undone!`)) {
                return;
            }

            // Double confirmation
            if (!confirm(`FINAL CONFIRMATION:\n\nDelete account for ${customerName} (${email})?\n\nClick OK to permanently delete.`)) {
                return;
            }

            try {
                const response = await fetch(ACCOUNT_FUNCTIONS.deleteStudentAccount, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { email: email } })
                });

                const result = await response.json();
                
                if (result.result && result.result.success) {
                    // Remove from local cache
                    existingAccountEmails.delete(email.toLowerCase());
                    
                    alert(`âœ… Account for ${customerName} has been deleted.`);
                    
                    // Refresh the display
                    updateAccountDashboard();
                    renderShopifyCustomersForAccounts();
                } else {
                    throw new Error(result.result?.message || 'Failed to delete account');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert(`âŒ Error: ${error.message}`);
            }
        }

        // ==================== END ACCOUNT CREATION FUNCTIONS ====================

        // ==================== LIGHT/DARK MODE TOGGLE ====================
        function toggleLightMode() {
            const body = document.body;
            const toggle = document.getElementById('themeToggle');
            
            if (toggle.checked) {
                body.classList.remove('light-mode');
                localStorage.setItem('scheduler-theme', 'dark');
            } else {
                body.classList.add('light-mode');
                localStorage.setItem('scheduler-theme', 'light');
            }
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem('scheduler-theme');
            const toggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'light' && toggle) {
                document.body.classList.add('light-mode');
                toggle.checked = false;
            } else if (toggle) {
                document.body.classList.remove('light-mode');
                toggle.checked = true;
            }
        }
        // ==================== END LIGHT/DARK MODE TOGGLE ====================

        // Init
        document.addEventListener('DOMContentLoaded', () => { 
            loadThemePreference();
            renderAvailabilityGrid();
            
            // Add event listener for split timezone select
            const splitTimezoneSelect = document.getElementById('splitTimezoneSelect');
            if (splitTimezoneSelect) {
                splitTimezoneSelect.addEventListener('change', renderAvailabilityGrid);
            }
            
            // Add event listener for manual timezone select
            const studentTimezone = document.getElementById('studentTimezone');
            if (studentTimezone) {
                studentTimezone.addEventListener('change', renderAvailabilityGrid);
            }
        });
    </script>
</body>
</html>
