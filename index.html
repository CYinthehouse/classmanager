<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Scheduler | KoreanLearnin</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans', sans-serif; 
            background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/sky.png?v=1750990355') repeat;
            background-size: auto;
            min-height: 100vh; 
            padding: 20px; 
            color: #fff; 
            font-size: 13px; 
        }
        
        /* Light/Dark Mode Toggle - Fixed position top right */
        .theme-toggle-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9999;
        }
        
        /* From Uiverse.io by andrew-demchenk0 */
        .switch {
            font-size: 17px;
            position: relative;
            display: inline-block;
            width: 64px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #73C0FC;
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            border-radius: 20px;
            left: 2px;
            bottom: 2px;
            z-index: 2;
            background-color: #e8e8e8;
            transition: .4s;
        }
        .sun svg {
            position: absolute;
            top: 6px;
            left: 36px;
            z-index: 1;
            width: 24px;
            height: 24px;
        }
        .moon svg {
            fill: #73C0FC;
            position: absolute;
            top: 5px;
            left: 5px;
            z-index: 1;
            width: 24px;
            height: 24px;
        }
        .sun svg {
            animation: rotate 15s linear infinite;
        }
        @keyframes rotate {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }
        .moon svg {
            animation: tilt 5s linear infinite;
        }
        @keyframes tilt {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }
        .switch input:checked + .slider {
            background-color: #183153;
        }
        .switch input:focus + .slider {
            box-shadow: 0 0 1px #183153;
        }
        .switch input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        /* Light mode styles */
        body.light-mode {
            background: #5dd0ff;
        }
        body.light-mode .header {
            background: linear-gradient(135deg, #4a90c2 0%, #3a7ab0 100%);
            border-color: #2a6090;
        }
        body.light-mode .nav-tabs {
            background: rgba(255,255,255,0.3);
            border-color: #4a90c2;
        }
        body.light-mode .nav-tab {
            background: rgba(255,255,255,0.5);
            color: #2a6090;
            border-color: #4a90c2;
        }
        body.light-mode .nav-tab:hover {
            background: rgba(255,255,255,0.7);
        }
        body.light-mode .nav-tab.active {
            background: #4a90c2;
            color: #fff;
        }
        body.light-mode .card {
            background: rgba(255,255,255,0.9);
            border-color: #4a90c2;
            color: #1a1a2e;
        }
        body.light-mode .card h3 {
            color: #2a6090;
            border-bottom-color: #4a90c2;
        }
        body.light-mode .stat-card {
            background: linear-gradient(135deg, rgba(74,144,194,0.3), rgba(58,122,176,0.3));
            color: #1a1a2e;
        }
        body.light-mode input,
        body.light-mode select,
        body.light-mode textarea {
            background: rgba(255,255,255,0.9);
            color: #1a1a2e;
            border-color: #4a90c2;
        }
        body.light-mode label {
            color: #2a6090;
        }
        body.light-mode th {
            background: rgba(74,144,194,0.5);
            color: #1a1a2e;
        }
        body.light-mode td {
            color: #1a1a2e;
        }
        body.light-mode tr:hover {
            background: rgba(74,144,194,0.1);
        }
        body.light-mode .class-card {
            background: rgba(255,255,255,0.8);
            color: #1a1a2e;
        }
        body.light-mode .teacher-card {
            background: rgba(255,255,255,0.8);
            color: #1a1a2e;
        }
        body.light-mode #loginSection {
            background: rgba(255,255,255,0.95);
            border-color: #4a90c2;
        }
        body.light-mode #loginSection h2 {
            color: #2a6090;
        }
        body.light-mode .role-tab {
            background: rgba(74,144,194,0.2);
            color: #2a6090;
            border-color: #4a90c2;
        }
        body.light-mode .role-tab.active {
            background: #4a90c2;
            color: #fff;
        }
        body.light-mode .modal {
            background: #f0f8ff;
            border-color: #4a90c2;
        }
        body.light-mode .modal-title {
            color: #2a6090;
        }
        
        /* Outreach Tab Styles */
        .outreach-period-btn {
            background: rgba(255,255,255,0.1);
            color: #888;
            border: 1px solid #444;
            padding: 8px 16px;
            font-size: 12px;
        }
        .outreach-period-btn:hover {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }
        .outreach-period-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border-color: transparent;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .header { margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 10px; border: 3px solid #00ffff; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 0 20px rgba(0,255,255,0.3); }
        .header h1 { font-size: 20px; color: #00ffff; text-shadow: 0 0 10px #00ffff; }
        .user-info { font-size: 12px; color: #39ff14; }
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; border: 2px solid #ff00ff; }
        .nav-tab { padding: 12px 18px; background: rgba(255,0,255,0.2); color: #ff00ff; border: 2px solid #ff00ff; border-radius: 5px; cursor: pointer; font-family: 'Noto Sans', sans-serif; font-size: 12px; transition: all 0.3s; }
        .nav-tab:hover { background: rgba(255,0,255,0.4); box-shadow: 0 0 15px rgba(255,0,255,0.5); }
        .nav-tab.active { background: #ff00ff; color: #000; box-shadow: 0 0 20px #ff00ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .card { background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; border: 3px solid #00ffff; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,255,255,0.2); }
        .card h3 { font-size: 12px; margin-bottom: 15px; color: #00ffff; border-bottom: 2px solid #00ffff; padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, rgba(255,0,255,0.3), rgba(0,255,255,0.3)); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #fff; }
        .stat-card.green { border-color: #39ff14; }
        .stat-card.cyan { border-color: #00ffff; }
        .stat-card.pink { border-color: #ff00ff; }
        .stat-card.yellow { border-color: #ffff00; }
        .stat-card.orange { border-color: #ff6600; }
        .stat-number { font-size: 24px; margin-bottom: 10px; }
        .stat-label { font-size: 11px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #ffff00; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ff00ff; border-radius: 5px; font-family: 'Noto Sans', sans-serif; font-size: 14px; background: rgba(0,0,0,0.5); color: #fff; }
        input:focus, select:focus { outline: none; border-color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.3); }
        select option { background: #1a1a2e; }
        .btn { padding: 12px 20px; border: 2px solid; border-radius: 5px; cursor: pointer; font-family: 'Noto Sans', sans-serif; font-size: 12px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, #ff00ff, #cc00cc); color: #fff; border-color: #ff00ff; }
        .btn-success { background: linear-gradient(135deg, #39ff14, #2ecc40); color: #000; border-color: #39ff14; }
        .btn-info { background: linear-gradient(135deg, #00ffff, #00cccc); color: #000; border-color: #00ffff; }
        .btn-warning { background: linear-gradient(135deg, #ffff00, #cccc00); color: #000; border-color: #ffff00; }
        .btn-danger { background: linear-gradient(135deg, #ff3366, #cc0033); color: #fff; border-color: #ff3366; }
        .btn-sm { padding: 6px 12px; font-size: 11px; }
        .btn-block { width: 100%; }
        .completed-filter-btn { background: transparent; border: 1px solid #444; color: #888; transition: all 0.2s; }
        .completed-filter-btn:hover { border-color: #00ffff; color: #00ffff; }
        .completed-filter-btn.active { background: rgba(0,255,255,0.2); border-color: #00ffff; color: #00ffff; }
        .admin-completed-filter-btn { background: transparent; border: 1px solid #444; color: #888; transition: all 0.2s; }
        .admin-completed-filter-btn:hover { border-color: #ff00ff; color: #ff00ff; }
        .admin-completed-filter-btn.active { background: rgba(255,0,255,0.2); border-color: #ff00ff; color: #ff00ff; }
        .admin-teacher-view-tab { background: transparent; border: 1px solid #444; color: #888; transition: all 0.2s; }
        .admin-teacher-view-tab:hover { border-color: #00ffff; color: #00ffff; }
        .admin-teacher-view-tab.active { background: rgba(0,255,255,0.2); border-color: #00ffff; color: #00ffff; }
        .teacher-select-btn { background: transparent; border: 2px solid #39ff14; color: #39ff14; padding: 8px 15px; cursor: pointer; transition: all 0.2s; }
        .teacher-select-btn:hover { background: rgba(57,255,20,0.2); }
        .teacher-select-btn.active { background: #39ff14; color: #000; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 10px; text-align: left; border: 1px solid #333; }
        th { background: rgba(255,0,255,0.3); color: #ff00ff; }
        tr:hover { background: rgba(0,255,255,0.1); }
        .level-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 2px solid; }
        .level-absolute { border-color: #ff00ff; color: #ff00ff; background: rgba(255,0,255,0.2); }
        .level-novice { border-color: #00ffff; color: #00ffff; background: rgba(0,255,255,0.2); }
        .level-beginner { border-color: #39ff14; color: #39ff14; background: rgba(57,255,20,0.2); }
        .level-advanced { border-color: #ffff00; color: #ffff00; background: rgba(255,255,0,0.2); }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .status-pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .status-assigned { background: rgba(57,255,20,0.2); color: #39ff14; }
        .status-limbo { background: rgba(255,51,102,0.2); color: #ff3366; }
        .status-proposed { background: rgba(0,255,255,0.2); color: #00ffff; }
        .availability-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .day-column { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; padding: 15px; }
        .day-title { text-align: center; color: #39ff14; font-size: 14px; margin-bottom: 15px; }
        .time-slot { background: rgba(255,255,255,0.05); border: 2px solid #444; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; text-align: center; font-size: 12px; position: relative; }
        .time-slot:hover { border-color: #00ffff; }
        .time-slot.selected-1 { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .time-slot.selected-2 { border-color: #ffff00; background: rgba(255,255,0,0.2); }
        .time-slot.selected-3 { border-color: #ff6600; background: rgba(255,102,0,0.2); }
        .rank-badge { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #000; }
        .time-slot.selected-1 .rank-badge { background: #39ff14; }
        .time-slot.selected-2 .rank-badge { background: #ffff00; }
        .time-slot.selected-3 .rank-badge { background: #ff6600; }
        .local-time { font-size: 11px; color: #888; margin-top: 5px; }
        .selection-legend { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .legend-color { width: 20px; height: 20px; border: 2px solid; border-radius: 4px; }
        .legend-color.ideal { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .legend-color.second { border-color: #ffff00; background: rgba(255,255,0,0.2); }
        .legend-color.doable { border-color: #ff6600; background: rgba(255,102,0,0.2); }
        .class-card { background: rgba(0,0,0,0.5); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .class-card.today-class { border-color: #39ff14; box-shadow: 0 0 15px rgba(57,255,20,0.3); }
        .class-card.completed-class { border-color: #888; opacity: 0.8; }
        .class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .class-time { color: #39ff14; font-size: 14px; }
        .class-day { color: #ffff00; font-size: 12px; }
        .class-week-tracker { display: flex; gap: 4px; margin: 15px 0; flex-wrap: wrap; }
        .class-week-box { flex: 1; min-width: 80px; padding: 8px 5px; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 5px; text-align: center; font-size: 10px; color: #555; }
        .class-week-box.completed { border-color: #39ff14; color: #39ff14; background: rgba(57,255,20,0.1); }
        .class-week-box.completed::before { content: 'âœ“ '; }
        .class-week-box.current { border-color: #ffff00; color: #ffff00; background: rgba(255,255,0,0.15); box-shadow: 0 0 8px rgba(255,255,0,0.3); }
        .class-week-box.future { border-color: #333; color: #444; }
        .class-week-box .week-label { font-weight: bold; font-size: 11px; display: block; margin-bottom: 3px; }
        .class-week-box .week-dates { font-size: 9px; color: inherit; opacity: 0.8; }
        .academy-status { display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 4px; font-size: 10px; }
        .academy-status.yes { background: rgba(57,255,20,0.2); border: 1px solid #39ff14; color: #39ff14; }
        .academy-status.no { background: rgba(255,51,102,0.2); border: 1px solid #ff3366; color: #ff3366; }
        .academy-status.pending { background: rgba(255,255,0,0.2); border: 1px solid #ffff00; color: #ffff00; }
        .student-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .student-chip { background: rgba(255,0,255,0.2); border: 1px solid #ff00ff; padding: 5px 10px; border-radius: 15px; font-size: 11px; display: flex; align-items: center; gap: 5px; }
        .rank-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .rank-dot.rank-1 { background: #39ff14; }
        .rank-dot.rank-2 { background: #ffff00; }
        .rank-dot.rank-3 { background: #ff6600; }
        .limbo-section { background: rgba(255,51,102,0.1); border: 2px dashed #ff3366; border-radius: 8px; padding: 20px; min-height: 100px; }
        .limbo-student { background: rgba(0,0,0,0.5); border: 2px solid #ff3366; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: grab; }
        .drop-zone { border: 2px dashed #00ffff; border-radius: 8px; padding: 15px; text-align: center; margin-top: 10px; opacity: 0; transition: opacity 0.2s; font-size: 12px; color: #00ffff; }
        .drop-zone.active { opacity: 1; background: rgba(0,255,255,0.1); }
        .week-tracker { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .week-btn { padding: 10px 15px; background: rgba(0,0,0,0.3); border: 2px solid #444; border-radius: 5px; color: #888; font-family: 'Noto Sans', sans-serif; font-size: 12px; cursor: pointer; }
        .week-btn.current { border-color: #39ff14; color: #39ff14; box-shadow: 0 0 10px rgba(57,255,20,0.3); }
        .week-btn.completed { border-color: #ff00ff; color: #ff00ff; }
        .attendance-btn { padding: 8px 12px; border: 2px solid; border-radius: 5px; background: transparent; font-family: 'Noto Sans', sans-serif; font-size: 11px; cursor: pointer; }
        .attendance-btn.present { border-color: #39ff14; color: #39ff14; }
        .attendance-btn.present.active { background: #39ff14; color: #000; }
        .attendance-btn.late { border-color: #ffff00; color: #ffff00; }
        .attendance-btn.late.active { background: #ffff00; color: #000; }
        .attendance-btn.absent { border-color: #ff3366; color: #ff3366; }
        .attendance-btn.absent.active { background: #ff3366; color: #fff; }
        .teacher-card { background: rgba(0,0,0,0.5); border: 2px solid #39ff14; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .teacher-name { color: #39ff14; font-size: 14px; margin-bottom: 8px; }
        .teacher-classes { font-size: 11px; color: #888; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; border: 3px solid #ff00ff; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #ff3366; font-size: 20px; cursor: pointer; font-family: 'Noto Sans', sans-serif; }
        .modal-title { color: #00ffff; font-size: 12px; margin-bottom: 20px; }
        #loginSection { max-width: 450px; margin: 50px auto; background: rgba(0,0,0,0.8); padding: 30px; border-radius: 10px; border: 3px solid #ff00ff; }
        #loginSection h2 { font-size: 14px; margin-bottom: 25px; color: #00ffff; text-align: center; }
        #mainPanel { display: none; }
        .role-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .role-tab { flex: 1; padding: 15px; background: rgba(255,0,255,0.2); border: 2px solid #ff00ff; border-radius: 5px; color: #ff00ff; font-family: 'Noto Sans', sans-serif; font-size: 12px; cursor: pointer; text-align: center; }
        .role-tab.active { background: #ff00ff; color: #000; }
        .message { padding: 12px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; }
        .message.success { background: rgba(57,255,20,0.2); border: 2px solid #39ff14; color: #39ff14; }
        .message.error { background: rgba(255,51,102,0.2); border: 2px solid #ff3366; color: #ff3366; }
        .success-screen { text-align: center; padding: 40px; }
        .success-icon { font-size: 60px; margin-bottom: 20px; }
        .assign-btn { padding: 6px 10px; background: transparent; border: 2px solid #39ff14; border-radius: 4px; color: #39ff14; font-family: 'Noto Sans', sans-serif; font-size: 11px; cursor: pointer; }
        .assign-btn:hover { background: #39ff14; color: #000; }
        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; }
        .checkbox-label input { width: 18px; height: 18px; }
        .settings-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .settings-label { color: #ffff00; font-size: 12px; min-width: 180px; }
        .settings-input { width: 100px; text-align: center; }
        .material-block { background: rgba(0,0,0,0.3); border: 2px solid #444; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: grab; transition: all 0.2s; }
        .material-block:hover { border-color: #666; }
        .material-block.dragging { opacity: 0.5; }
        .material-block .drag-handle { font-size: 14px; color: #555; }
        .material-block:hover .drag-handle { color: #00ffff; }
        .material-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .material-type { font-size: 11px; color: #ff00ff; text-transform: uppercase; }
        .material-content { font-size: 13px; line-height: 1.6; }
        .material-content img { max-width: 100%; border-radius: 5px; }
        .material-content a { color: #00ffff; }
        .history-present { color: #39ff14; }
        .history-late { color: #ffff00; }
        .history-absent { color: #ff3366; }
        
        /* Rich Text Editor Styles */
        .rich-text-toolbar { display: flex; flex-wrap: wrap; gap: 5px; padding: 8px; background: #1a1a2e; border: 2px solid #333; border-bottom: none; border-radius: 8px 8px 0 0; }
        .rich-text-toolbar button { background: #333; border: 1px solid #555; color: #fff; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: 'Noto Sans', sans-serif; min-width: 32px; }
        .rich-text-toolbar button:hover { background: #444; border-color: #00ffff; }
        .rich-text-toolbar button.active { background: #00ffff; color: #000; }
        .rich-text-toolbar input[type="color"] { width: 32px; height: 28px; border: 1px solid #555; border-radius: 4px; cursor: pointer; background: #333; padding: 2px; }
        .rich-text-toolbar .toolbar-divider { width: 1px; background: #555; margin: 0 5px; }
        .rich-text-editor { min-height: 200px; padding: 15px; background: #0a0a15; border: 2px solid #333; border-radius: 0 0 8px 8px; color: #fff; font-family: 'Noto Sans', sans-serif; font-size: 14px; line-height: 1.8; outline: none; overflow-y: auto; }
        .rich-text-editor:focus { border-color: #00ffff; }
        .rich-text-editor ul, .rich-text-editor ol { margin: 10px 0; padding-left: 25px; }
        .rich-text-editor li { margin: 5px 0; }
        
        /* Presentation Mode Styles */
        .presentation-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 10000; display: flex; flex-direction: column; }
        .presentation-toolbar { display: flex; gap: 10px; padding: 10px 20px; background: #1a1a2e; border-bottom: 2px solid #333; align-items: center; flex-wrap: wrap; justify-content: center; }
        .presentation-toolbar button { background: #333; border: 2px solid #555; color: #fff; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: 'Noto Sans', sans-serif; transition: all 0.2s; }
        .presentation-toolbar button:hover { border-color: #00ffff; background: #444; }
        .presentation-toolbar button.active { background: #00ffff; color: #000; border-color: #00ffff; }
        .presentation-toolbar .tool-group { display: flex; gap: 5px; padding: 0 10px; border-right: 1px solid #555; align-items: center; }
        .presentation-toolbar .tool-group:last-child { border-right: none; }
        .presentation-toolbar input[type="range"] { width: 100px; cursor: pointer; }
        .presentation-toolbar input[type="color"] { width: 35px; height: 35px; border: 2px solid #555; border-radius: 4px; cursor: pointer; }
        .presentation-content { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; }
        .presentation-wrapper { position: relative; display: flex; align-items: center; justify-content: center; }
        .presentation-image { display: block; max-width: 95vw; max-height: calc(100vh - 80px); object-fit: contain; user-select: none; -webkit-user-drag: none; }
        .presentation-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; pointer-events: auto; }
        .presentation-close { position: fixed; top: 70px; right: 20px; background: #ff3366; border: none; color: #fff; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-family: 'Noto Sans', sans-serif; font-size: 14px; z-index: 10001; }
        .presentation-close:hover { background: #ff1744; }
        .clickable-media { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .clickable-media:hover { border-color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.5); }
        
        /* Rainbow cursor animation */
        @keyframes rainbow-cursor { 0% { background: #ff0000; } 16% { background: #ff8800; } 33% { background: #ffff00; } 50% { background: #00ff00; } 66% { background: #0088ff; } 83% { background: #8800ff; } 100% { background: #ff0000; } }
        .rainbow-draw { animation: rainbow-cursor 2s linear infinite; }
        
        /* Schedule Calendar Styles */
        .schedule-grid { display: grid; grid-template-columns: 100px repeat(2, 1fr); gap: 2px; background: #333; border: 2px solid #00ffff; border-radius: 8px; overflow: hidden; }
        .schedule-header { background: linear-gradient(135deg, #ff00ff, #cc00cc); color: #fff; padding: 12px 8px; text-align: center; font-size: 13px; font-weight: bold; }
        .schedule-time { background: rgba(0,255,255,0.2); color: #00ffff; padding: 10px 8px; text-align: center; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .schedule-cell { background: rgba(0,0,0,0.6); padding: 8px; min-height: 80px; transition: all 0.2s; position: relative; }
        .schedule-cell:hover { background: rgba(0,255,255,0.1); }
        .schedule-cell.has-class { border-left: 3px solid #39ff14; }
        .schedule-cell.empty { border-left: 3px solid #666; }
        .schedule-cell.needs-teacher { border-left: 3px solid #ffff00; }
        .schedule-cell.full { border-left: 3px solid #ff3366; }
        .schedule-class-block { background: rgba(57,255,20,0.15); border: 1px solid #39ff14; border-radius: 5px; padding: 8px; margin-bottom: 5px; }
        .schedule-class-block.no-teacher { background: rgba(255,255,0,0.15); border-color: #ffff00; }
        .schedule-class-block.full { background: rgba(255,51,102,0.15); border-color: #ff3366; }
        .schedule-class-level { font-size: 11px; color: #ff00ff; margin-bottom: 4px; }
        .schedule-class-info { font-size: 11px; color: #888; }
        .schedule-class-teacher { font-size: 11px; color: #39ff14; margin-top: 4px; }
        .schedule-class-students { font-size: 12px; color: #00ffff; font-weight: bold; }
        .schedule-legend { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .legend-bar { width: 4px; height: 20px; border-radius: 2px; }
        .legend-bar.active { background: #39ff14; }
        .legend-bar.needs-teacher { background: #ffff00; }
        .legend-bar.full { background: #ff3366; }
        .legend-bar.empty { background: #666; }
        .schedule-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .summary-box { background: rgba(0,0,0,0.5); border: 2px solid; border-radius: 8px; padding: 15px; text-align: center; }
        .summary-box.total { border-color: #00ffff; }
        .summary-box.active { border-color: #39ff14; }
        .summary-box.needs-teacher { border-color: #ffff00; }
        .summary-box.full { border-color: #ff3366; }
        .summary-box.empty { border-color: #666; }
        .summary-box.available { border-color: #ff00ff; }
        .summary-number { font-size: 20px; margin-bottom: 5px; }
        .summary-label { font-size: 11px; color: #888; }
        
        /* Class Details Modal Styles */
        .student-detail-row { background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .student-detail-row.absent-student { border-color: #ff3366; background: rgba(255,51,102,0.1); }
        .student-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 10px; }
        .student-detail-name { color: #00ffff; font-size: 14px; }
        .student-detail-info { font-size: 12px; color: #888; margin-bottom: 5px; }
        .student-detail-phone { font-size: 13px; color: #39ff14; margin: 8px 0; padding: 8px; background: rgba(57,255,20,0.1); border-radius: 5px; display: none; }
        .student-detail-phone.visible { display: block; }
        .student-detail-phone a { color: #39ff14; text-decoration: none; }
        .student-detail-attendance { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
        .attendance-week { padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 1px solid #333; }
        .attendance-week.present { background: rgba(57,255,20,0.2); color: #39ff14; border-color: #39ff14; }
        .attendance-week.late { background: rgba(255,255,0,0.2); color: #ffff00; border-color: #ffff00; }
        .attendance-week.absent { background: rgba(255,51,102,0.2); color: #ff3366; border-color: #ff3366; }
        .contacted-row { margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: none; }
        .contacted-row.visible { display: flex; align-items: center; gap: 10px; }
        .contacted-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; }
        .contacted-checkbox input { width: 18px; height: 18px; accent-color: #39ff14; }
        .absence-reason-display { font-size: 12px; color: #ff9900; margin-top: 5px; padding: 5px; background: rgba(255,153,0,0.1); border-radius: 4px; }
        
        /* Absence List Styles */
        .absence-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid; transition: all 0.2s; }
        .absence-item:hover { transform: translateX(5px); }
        .absence-item.contacted { background: rgba(57,255,20,0.1); border-color: #39ff14; }
        .absence-item.not-contacted { background: rgba(255,51,102,0.1); border-color: #ff3366; }
        .absence-item-info { flex: 1; }
        .absence-item-name { color: #00ffff; font-size: 14px; margin-bottom: 5px; }
        .absence-item-details { font-size: 12px; color: #888; }
        .absence-item-class { font-size: 12px; color: #ffff00; margin-top: 3px; }
        .absence-item-reason { font-size: 12px; color: #ff9900; margin-top: 5px; padding: 5px 8px; background: rgba(255,153,0,0.1); border-radius: 4px; display: inline-block; }
        .absence-item-phone { font-size: 13px; margin-top: 5px; }
        .absence-item-phone a { color: #39ff14; text-decoration: none; }
        .absence-item-status { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .absence-status-badge { padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .absence-status-badge.contacted { background: rgba(57,255,20,0.3); color: #39ff14; }
        .absence-status-badge.not-contacted { background: rgba(255,51,102,0.3); color: #ff3366; }
        .absence-week-badge { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px; font-size: 11px; color: #888; }
        
        /* Limbo Student Availability Tags */
        .limbo-availability { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .avail-tag { padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 2px solid; }
        .avail-tag.pref-1 { background: rgba(57,255,20,0.2); border-color: #39ff14; color: #39ff14; }
        .avail-tag.pref-2 { background: rgba(255,255,0,0.2); border-color: #ffff00; color: #ffff00; }
        .avail-tag.pref-3 { background: rgba(255,102,0,0.2); border-color: #ff6600; color: #ff6600; }
        
        /* Clickable schedule cell */
        .schedule-class-block.clickable { cursor: pointer; transition: all 0.2s; }
        .schedule-class-block.clickable:hover { transform: scale(1.02); box-shadow: 0 0 10px rgba(0,255,255,0.3); }
        
        /* Course Calendar Styles */
        .week-date-card { background: rgba(0,0,0,0.4); border: 2px solid #444; border-radius: 8px; padding: 12px; text-align: center; transition: all 0.2s; }
        .week-date-card:hover { border-color: #00ffff; }
        .week-date-card.current { border-color: #39ff14; background: rgba(57,255,20,0.1); }
        .week-date-card.past { opacity: 0.5; }
        .week-date-card.future { border-color: #666; }
        .week-date-number { font-size: 14px; color: #00ffff; margin-bottom: 5px; }
        .week-date-card.current .week-date-number { color: #39ff14; }
        .week-date-range { font-size: 12px; color: #ffff00; margin-bottom: 5px; }
        .week-date-status { font-size: 11px; color: #888; }
        .week-date-card.current .week-date-status { color: #39ff14; }
        .course-dates-summary { background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .course-date-item { text-align: center; }
        .course-date-label { font-size: 11px; color: #888; margin-bottom: 5px; }
        .course-date-value { font-size: 14px; color: #00ffff; }
        .course-date-value.end { color: #ff00ff; }
        
        /* Monthly Calendar */
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-header { background: rgba(0,0,0,0.5); color: #00ffff; padding: 10px 5px; text-align: center; font-size: 12px; }
        .calendar-day { background: rgba(0,0,0,0.3); border: 1px solid #333; min-height: 80px; padding: 5px; position: relative; transition: all 0.2s; }
        .calendar-day:hover { border-color: #00ffff; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.today { border-color: #00ffff; box-shadow: 0 0 10px rgba(0,255,255,0.3); }
        .calendar-day.course-start, .calendar-day.course-end { border-color: #ff00ff; }
        .calendar-day-number { font-size: 14px; color: #fff; margin-bottom: 5px; }
        .calendar-day.today .calendar-day-number { color: #00ffff; font-weight: bold; }
        .calendar-day.has-class { background: rgba(57,255,20,0.1); }
        .calendar-class-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin: 1px; cursor: pointer; }
        .calendar-class-info { font-size: 10px; color: #888; margin-top: 3px; }
        .calendar-week-label { position: absolute; top: 5px; right: 5px; font-size: 10px; color: #666; }
        .calendar-day.has-class { cursor: pointer; }
        .calendar-day.has-class:hover { background: rgba(57,255,20,0.2); }
        
        /* Date Option Buttons */
        .date-option { padding: 12px; border: 2px solid #333; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; background: rgba(0,0,0,0.3); }
        .date-option:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .date-option.selected { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .date-option-day { font-size: 14px; color: #00ffff; margin-bottom: 3px; }
        .date-option-date { font-size: 12px; color: #ffff00; }
        .date-option-end { font-size: 11px; color: #888; margin-top: 5px; }
        
        /* Completed Students */
        .completed-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid; }
        .completed-item.joined { background: rgba(57,255,20,0.1); border-color: #39ff14; }
        .completed-item.not-interested { background: rgba(255,51,102,0.1); border-color: #ff3366; }
        .completed-item.pending { background: rgba(255,255,0,0.1); border-color: #ffff00; }
        .completed-item-info { flex: 1; }
        .completed-item-name { color: #00ffff; font-size: 14px; margin-bottom: 5px; }
        .completed-item-details { font-size: 12px; color: #888; }
        .completed-item-class { font-size: 12px; color: #ffff00; margin-top: 3px; }
        .completed-item-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .community-btn { padding: 8px 12px; border-radius: 5px; font-size: 12px; font-family: 'Noto Sans', sans-serif; cursor: pointer; border: none; transition: all 0.2s; }
        .community-btn.join { background: #39ff14; color: #000; }
        .community-btn.not-interested { background: #ff3366; color: #fff; }
        .community-btn:hover { transform: scale(1.05); }
        .community-status { padding: 5px 10px; border-radius: 5px; font-size: 12px; }
        .community-status.joined { background: rgba(57,255,20,0.3); color: #39ff14; }
        .community-status.not-interested { background: rgba(255,51,102,0.3); color: #ff3366; }
        
        /* Move Student Modal */
        .move-student-class { padding: 10px; margin: 5px 0; border: 2px solid #333; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .move-student-class:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .move-student-class.selected { border-color: #39ff14; background: rgba(57,255,20,0.1); }
        
        /* Calendar Class Picker */
        .calendar-class-option:hover { border-color: #39ff14 !important; background: rgba(57,255,20,0.2) !important; transform: scale(1.02); }
        
        /* Video Recording */
        .recording-section { background: rgba(0,0,0,0.3); border: 2px solid #ff3366; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .recording-section.recording { border-color: #ff0000; animation: pulse-border 1s infinite; }
        @keyframes pulse-border { 0%, 100% { border-color: #ff0000; } 50% { border-color: #ff6666; } }
        .record-btn { padding: 15px 25px; font-size: 14px; border-radius: 50px; cursor: pointer; transition: all 0.2s; font-family: 'Noto Sans', sans-serif; }
        .record-btn.start { background: #ff3366; color: #fff; border: none; }
        .record-btn.start:hover { background: #ff0044; transform: scale(1.05); }
        .record-btn.recording { background: #ff0000; color: #fff; border: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .video-preview { width: 100%; max-width: 400px; border-radius: 8px; background: #000; margin: 10px auto; display: block; }
        .korean-passage { background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 15px; margin: 10px 0; font-size: 12px; line-height: 1.8; color: #fff; }
        
        /* Priority Buttons */
        .priority-btn { padding: 10px 15px; font-size: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-family: 'Noto Sans', sans-serif; background: #1a1a2e; color: #888; border: 2px solid #333; }
        .priority-btn:hover { border-color: #666; }
        .priority-btn.selected { transform: scale(1.05); }
        .priority-btn.selected#priorityHigh { background: rgba(255,0,0,0.2); border-color: #ff0000; color: #ff0000; }
        .priority-btn.selected#priorityMid { background: rgba(255,255,0,0.2); border-color: #ffff00; color: #ffff00; }
        .priority-btn.selected#priorityLow { background: rgba(57,255,20,0.2); border-color: #39ff14; color: #39ff14; }
        
        /* Suggestion Cards */
        .suggestion-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .suggestion-card.priority-high { border-left: 4px solid #ff0000; }
        .suggestion-card.priority-mid { border-left: 4px solid #ffff00; }
        .suggestion-card.priority-low { border-left: 4px solid #39ff14; }
        .suggestion-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .suggestion-title { color: #00ffff; font-size: 14px; flex: 1; }
        .suggestion-priority { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .suggestion-priority.high { background: rgba(255,0,0,0.3); color: #ff0000; }
        .suggestion-priority.mid { background: rgba(255,255,0,0.3); color: #ffff00; }
        .suggestion-priority.low { background: rgba(57,255,20,0.3); color: #39ff14; }
        .suggestion-body { font-size: 12px; color: #ccc; margin-bottom: 10px; line-height: 1.6; }
        .suggestion-meta { font-size: 11px; color: #666; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-status { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .suggestion-status.pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .suggestion-status.approved { background: rgba(57,255,20,0.2); color: #39ff14; }
        .suggestion-status.declined { background: rgba(255,51,102,0.2); color: #ff3366; }
        .suggestion-actions { display: flex; gap: 8px; margin-top: 10px; }
        
        /* Proposals Layout */
        .proposals-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .proposals-left, .proposals-right { min-width: 0; }
        @media (max-width: 1024px) { .proposals-layout { grid-template-columns: 1fr; } }
        
        /* Proposal Card */
        .proposal-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .proposal-card.status-draft { border-left: 4px solid #888; }
        .proposal-card.status-sent { border-left: 4px solid #ffff00; }
        .proposal-card.status-all_agreed { border-left: 4px solid #39ff14; }
        .proposal-card.status-has_rejections { border-left: 4px solid #ff3366; }
        .proposal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .proposal-info { flex: 1; }
        .proposal-day { color: #00ffff; font-size: 12px; }
        .proposal-time { color: #888; font-size: 13px; }
        .proposal-status { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .proposal-status.draft { background: rgba(136,136,136,0.3); color: #888; }
        .proposal-status.sent { background: rgba(255,255,0,0.3); color: #ffff00; }
        .proposal-status.all_agreed { background: rgba(57,255,20,0.3); color: #39ff14; }
        .proposal-status.has_rejections { background: rgba(255,51,102,0.3); color: #ff3366; }
        .proposal-students { margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; min-height: 60px; }
        .proposal-students.drag-over { border: 2px dashed #00ffff; background: rgba(0,255,255,0.1); }
        .proposal-student { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px; border: 1px solid #333; }
        .proposal-student-name { font-size: 12px; color: #fff; }
        .proposal-student-response { font-size: 11px; padding: 2px 6px; border-radius: 3px; }
        .proposal-student-response.pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .proposal-student-response.agreed { background: rgba(57,255,20,0.2); color: #39ff14; }
        .proposal-student-response.rejected { background: rgba(255,51,102,0.2); color: #ff3366; }
        .proposal-date-picker { margin: 10px 0; padding: 10px; background: rgba(255,255,0,0.1); border: 1px solid #ffff00; border-radius: 5px; }
        .proposal-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        
        /* Available Students for Drag */
        .available-student { padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; cursor: grab; transition: all 0.2s; }
        .available-student:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .available-student.dragging { opacity: 0.5; cursor: grabbing; }
        .available-student.rainbow-fit { animation: rainbow-border 2s linear infinite; }
        @keyframes rainbow-border {
            0% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
            17% { border-color: #ff9900; box-shadow: 0 0 10px #ff9900; }
            33% { border-color: #ffff00; box-shadow: 0 0 10px #ffff00; }
            50% { border-color: #39ff14; box-shadow: 0 0 10px #39ff14; }
            67% { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; }
            83% { border-color: #ff00ff; box-shadow: 0 0 10px #ff00ff; }
            100% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        }
        .available-student-name { font-size: 13px; color: #fff; margin-bottom: 3px; }
        .available-student-info { font-size: 11px; color: #888; }
        
        /* Date Picker Modal */
        .date-picker-modal { text-align: center; }
        .date-picker-modal input[type="date"] { font-family: 'Noto Sans', sans-serif; font-size: 14px; padding: 10px; background: #1a1a2e; color: #00ffff; border: 2px solid #00ffff; border-radius: 5px; }
        
        /* Class Preview Cards */
        .class-preview-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .class-preview-card.has-date { border-color: #39ff14; }
        .class-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .class-preview-info { color: #00ffff; font-size: 11px; }
        .class-preview-students { display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
        .class-preview-student { padding: 5px 10px; background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 15px; font-size: 11px; color: #fff; }
        .class-preview-date { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; }
        .class-preview-date label { font-size: 12px; color: #ffff00; }
        .class-preview-date input[type="date"] { font-family: 'Noto Sans', sans-serif; font-size: 12px; padding: 8px; background: #1a1a2e; color: #00ffff; border: 2px solid #00ffff; border-radius: 5px; flex: 1; }
        .class-preview-date.selected input { border-color: #39ff14; color: #39ff14; }
        .saturday-quick-btns { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .saturday-quick-btn { padding: 5px 8px; font-size: 10px; background: rgba(255,255,0,0.1); border: 1px solid #ffff00; color: #ffff00; border-radius: 4px; cursor: pointer; font-family: 'Noto Sans', sans-serif; }
        .saturday-quick-btn:hover { background: rgba(255,255,0,0.3); }
        .saturday-quick-btn.selected { background: rgba(57,255,20,0.3); border-color: #39ff14; color: #39ff14; }
        
        @media (max-width: 768px) { .header h1 { font-size: 12px; } .grid-2 { grid-template-columns: 1fr; } .availability-grid { grid-template-columns: 1fr; } .schedule-grid { grid-template-columns: 60px repeat(2, 1fr); } .schedule-header, .schedule-time { font-size: 11px; padding: 8px 4px; } #courseCalendarGrid { grid-template-columns: repeat(2, 1fr); } .monthly-calendar { grid-template-columns: repeat(7, 1fr); } .calendar-day { min-height: 50px; } }
        
        /* ==================== SALES CHAT STYLES ==================== */
        .sales-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; }
        .sales-modal-overlay.active { display: flex; }
        .sales-modal { width: 100%; height: 100vh; max-height: 100vh; display: flex; background: #050512; overflow: hidden; }
        .sales-sidebar { width: 280px; min-width: 280px; height: 100%; max-height: 100vh; display: flex; flex-direction: column; background: rgba(8,10,25,0.95); border-right: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        .sales-sidebar-header { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .sales-sidebar-title { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .sales-sidebar-title h2 { font-size: 15px; font-weight: 800; color: #fff; }
        .sales-sidebar-title h2 span { color: #ffd682; }
        .sales-close-btn { width: 32px; height: 32px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #aeb8de; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .sales-close-btn:hover { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #fca5a5; }
        .sales-new-chat-btn { width: 100%; padding: 8px 12px; border-radius: 10px; border: 1px dashed rgba(255,214,130,0.3); background: rgba(255,214,130,0.08); color: #ffd682; cursor: pointer; font-size: 12px; font-weight: 600; }
        .sales-new-chat-btn:hover { background: rgba(255,214,130,0.15); border-color: rgba(255,214,130,0.5); }
        .sales-voice-panel { width: 300px; min-width: 300px; height: 100%; max-height: 100vh; display: flex; flex-direction: column; background: rgba(8,10,25,0.95); border-left: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        .sales-voice-panel.collapsed { width: 0; min-width: 0; overflow: hidden; border: none; }
        .sales-voice-header { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .sales-voice-header h3 { font-size: 14px; font-weight: 700; color: #4285f4; display: flex; align-items: center; gap: 8px; }
        .sales-voice-toggle { padding: 6px 12px; border-radius: 8px; border: 1px solid rgba(66,133,244,0.3); background: rgba(66,133,244,0.1); color: #4285f4; font-size: 11px; cursor: pointer; }
        .sales-voice-toggle:hover { background: rgba(66,133,244,0.2); }
        .sales-voice-frame { flex: 1; width: 100%; border: none; background: #fff; }
        .sales-voice-notice { padding: 20px; text-align: center; color: #aeb8de; font-size: 12px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .sales-voice-notice a { color: #4285f4; text-decoration: none; }
        .sales-voice-notice a:hover { text-decoration: underline; }
        .sales-voice-expand-btn { position: absolute; right: 0; top: 50%; transform: translateY(-50%); padding: 12px 8px; background: rgba(66,133,244,0.2); border: 1px solid rgba(66,133,244,0.3); border-right: none; border-radius: 8px 0 0 8px; color: #4285f4; cursor: pointer; font-size: 14px; z-index: 10; }
        .sales-voice-expand-btn:hover { background: rgba(66,133,244,0.3); }
        .sales-filter-tabs { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; flex-shrink: 0; }
        .sales-filter-tab { padding: 4px 8px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aeb8de; font-size: 10px; font-weight: 600; cursor: pointer; }
        .sales-filter-tab:hover { background: rgba(255,255,255,0.05); }
        .sales-filter-tab.active { background: rgba(255,214,130,0.15); border-color: rgba(255,214,130,0.3); color: #ffd682; }
        .sales-filter-tab .count { display: inline-flex; min-width: 14px; height: 14px; padding: 0 3px; border-radius: 7px; background: rgba(255,255,255,0.1); font-size: 9px; margin-left: 3px; align-items: center; justify-content: center; }
        .sales-chat-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; min-height: 0; }
        .sales-chat-list::-webkit-scrollbar { width: 6px; }
        .sales-chat-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        .sales-chat-card { position: relative; border-radius: 10px; padding: 10px; background: linear-gradient(180deg, rgba(10,16,42,0.68), rgba(10,16,42,0.92)); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 0.15s; flex-shrink: 0; }
        .sales-chat-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); }
        .sales-chat-card.active { border-color: rgba(255,214,130,0.5); box-shadow: 0 0 15px rgba(255,214,130,0.2); }
        .sales-chat-card.urgency-red { border-color: rgba(239,68,68,0.6); box-shadow: 0 0 15px rgba(239,68,68,0.3); }
        .sales-chat-card.urgency-yellow { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 15px rgba(251,191,36,0.3); }
        .sales-chat-card.urgency-grey { border-color: rgba(156,163,175,0.4); opacity: 0.7; }
        .sales-chat-card-top { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .sales-chat-card-avatar { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,255,255,0.5)); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 11px; color: rgba(12,14,30,0.9); flex-shrink: 0; }
        .sales-chat-card-info { flex: 1; min-width: 0; }
        .sales-chat-card-name { font-size: 12px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sales-chat-card-slot { font-size: 9px; color: #ff9800; margin-top: 2px; }
        .sales-chat-card-preview { font-size: 10px; color: #aeb8de; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .sales-chat-card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 9px; color: #666; }
        .sales-urgency-badge { padding: 2px 5px; border-radius: 8px; font-size: 8px; font-weight: 700; }
        .sales-urgency-badge.red { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .sales-urgency-badge.yellow { background: rgba(251,191,36,0.2); color: #fde68a; }
        .sales-urgency-badge.grey { background: rgba(156,163,175,0.2); color: #d1d5db; }
        .sales-main-area { flex: 1; display: flex; flex-direction: column; background: linear-gradient(180deg, #050512, #07102a); min-width: 0; height: 100%; max-height: 100vh; overflow: hidden; }
        .sales-empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; color: #aeb8de; overflow-y: auto; }
        .sales-empty-state-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.6; }
        .sales-empty-state h3 { font-size: 16px; color: #fff; margin-bottom: 6px; }
        .sales-empty-state p { font-size: 12px; max-width: 280px; }
        .sales-chat-header { padding: 12px 16px; background: rgba(8,10,25,0.9); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; flex-wrap: wrap; gap: 8px; }
        .sales-chat-header-left { display: flex; align-items: center; gap: 10px; }
        .sales-chat-header-avatar { width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,255,255,0.5)); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; color: rgba(12,14,30,0.9); flex-shrink: 0; }
        .sales-chat-header-info { }
        .sales-chat-header-name { font-size: 14px; font-weight: 700; color: #fff; }
        .sales-chat-header-details { display: flex; gap: 10px; margin-top: 3px; font-size: 10px; color: #aeb8de; flex-wrap: wrap; }
        .sales-chat-header-actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .sales-header-btn { padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #aeb8de; font-size: 10px; cursor: pointer; white-space: nowrap; }
        .sales-header-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .sales-header-btn.danger { border-color: rgba(239,68,68,0.3); color: #fca5a5; }
        .sales-header-btn.danger:hover { background: rgba(239,68,68,0.2); }
        .sales-header-btn.success { border-color: rgba(57,255,20,0.3); color: #39ff14; background: rgba(57,255,20,0.1); }
        .sales-header-btn.success:hover { background: rgba(57,255,20,0.2); }
        .sales-messages-container { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; min-height: 0; }
        .sales-messages-container::-webkit-scrollbar { width: 6px; }
        .sales-messages-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        .sales-message { max-width: 85%; animation: salesMsgSlide 0.2s ease; }
        @keyframes salesMsgSlide { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .sales-message.customer { align-self: flex-start; }
        .sales-message.admin { align-self: flex-end; }
        .sales-message.ai { align-self: flex-end; }
        .sales-message-label { font-size: 9px; color: #666; margin-bottom: 3px; padding: 0 10px; }
        .sales-message.admin .sales-message-label, .sales-message.ai .sales-message-label { text-align: right; }
        .sales-message-bubble { padding: 10px 14px; border-radius: 14px; font-size: 12px; line-height: 1.4; }
        .sales-message.customer .sales-message-bubble { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-bottom-left-radius: 4px; color: #eef2ff; }
        .sales-message.admin .sales-message-bubble { background: linear-gradient(135deg, rgba(99,102,241,0.25), rgba(99,102,241,0.15)); border: 1px solid rgba(99,102,241,0.3); border-bottom-right-radius: 4px; color: #eef2ff; }
        .sales-message.ai .sales-message-bubble { background: linear-gradient(135deg, rgba(255,214,130,0.2), rgba(255,214,130,0.1)); border: 1px solid rgba(255,214,130,0.25); border-bottom-right-radius: 4px; color: #eef2ff; cursor: pointer; }
        .sales-message.ai .sales-message-bubble:hover { background: linear-gradient(135deg, rgba(255,214,130,0.3), rgba(255,214,130,0.2)); }
        .sales-message-time { font-size: 8px; color: rgba(174,184,222,0.5); margin-top: 3px; padding: 0 10px; }
        .sales-message.admin .sales-message-time, .sales-message.ai .sales-message-time { text-align: right; }
        .sales-typing-indicator { display: flex; gap: 4px; padding: 10px 14px; background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.1)); border: 1px solid rgba(139,92,246,0.25); border-radius: 14px; width: fit-content; align-self: flex-end; }
        .sales-typing-indicator span { width: 5px; height: 5px; background: #c4b5fd; border-radius: 50%; animation: salesTypingBounce 1.4s ease-in-out infinite; }
        .sales-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .sales-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes salesTypingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        .sales-input-area { padding: 12px 16px; background: rgba(8,10,25,0.95); border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .sales-input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
        .sales-input-container { flex: 1; min-width: 0; }
        .sales-input-label { font-size: 10px; color: #aeb8de; margin-bottom: 4px; }
        .sales-message-input { width: 100%; padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.15); background: rgba(10,16,42,0.8); color: #eef2ff; font-size: 12px; font-family: inherit; resize: none; min-height: 42px; max-height: 100px; box-sizing: border-box; }
        .sales-message-input:focus { outline: none; border-color: rgba(255,214,130,0.5); }
        .sales-message-input::placeholder { color: rgba(174,184,222,0.5); }
        .sales-send-btn { padding: 10px 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,244,200,0.7)); color: rgba(12,14,30,0.95); font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        .sales-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(255,214,130,0.3); }
        .sales-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .sales-context-recommendations { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .sales-context-label { font-size: 10px; color: #aeb8de; }
        .sales-context-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
        .sales-context-btn { padding: 5px 10px; border-radius: 8px; border: 1px solid rgba(57,255,20,0.3); background: rgba(57,255,20,0.1); color: #39ff14; font-size: 10px; cursor: pointer; }
        .sales-context-btn:hover { background: rgba(57,255,20,0.25); transform: translateY(-1px); }
        .sales-context-btn.objection { border-color: rgba(245,158,11,0.4); background: rgba(245,158,11,0.1); color: #f59e0b; }
        .sales-context-btn.objection:hover { background: rgba(245,158,11,0.25); }
        .sales-context-btn.template { border-color: rgba(139,92,246,0.4); background: rgba(139,92,246,0.1); color: #a78bfa; }
        .sales-context-btn.template:hover { background: rgba(139,92,246,0.25); }
        .sales-context-btn.closing { border-color: rgba(16,185,129,0.4); background: rgba(16,185,129,0.1); color: #10b981; }
        .sales-context-btn.closing:hover { background: rgba(16,185,129,0.25); }
        .sales-suggestions-sidebar { width: 240px; min-width: 240px; height: 100%; max-height: 100vh; background: rgba(8,10,25,0.95); border-left: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .sales-suggestions-header { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .sales-suggestions-header h3 { font-size: 13px; font-weight: 700; color: #ffd682; display: flex; align-items: center; gap: 6px; }
        .sales-suggestions-content { flex: 1; overflow-y: auto; padding: 10px; min-height: 0; }
        .sales-suggestion-section { margin-bottom: 14px; }
        .sales-suggestion-title { font-size: 9px; font-weight: 700; color: #aeb8de; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px; }
        .sales-suggestion-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 10px; margin-bottom: 6px; cursor: pointer; transition: all 0.15s; position: relative; }
        .sales-suggestion-card:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,214,130,0.3); }
        .sales-suggestion-card.objection { border-left: 3px solid #f59e0b; }
        .sales-suggestion-card.template { border-left: 3px solid #8b5cf6; }
        .sales-suggestion-card.closing { border-left: 3px solid #10b981; }
        .sales-suggestion-card.highlighted { border-color: #39ff14; box-shadow: 0 0 10px rgba(57,255,20,0.3); }
        .sales-suggestion-card.copied { background: rgba(57,255,20,0.2); }
        .sales-suggestion-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 3px; }
        .sales-suggestion-card-title { font-size: 10px; font-weight: 700; color: #fff; flex: 1; }
        .sales-suggestion-card-meta { display: flex; gap: 4px; align-items: center; }
        .sales-suggestion-card-uses { font-size: 8px; color: #888; background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 8px; }
        .sales-suggestion-card-fav { background: none; border: none; cursor: pointer; font-size: 12px; padding: 0; opacity: 0.5; }
        .sales-suggestion-card-fav:hover { opacity: 1; }
        .sales-suggestion-card-fav.active { opacity: 1; }
        .sales-suggestion-card-preview { font-size: 9px; color: #aeb8de; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .sales-suggestion-card-tags { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .sales-suggestion-card-tag { font-size: 8px; padding: 1px 5px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #aeb8de; }
        .sales-suggestion-card-actions { display: flex; gap: 4px; margin-top: 6px; }
        .sales-suggestion-edit-btn { padding: 3px 6px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #aeb8de; font-size: 9px; cursor: pointer; }
        .sales-suggestion-edit-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .sales-suggestion-ai-btn { padding: 3px 6px; border-radius: 4px; border: 1px solid rgba(255,214,130,0.3); background: rgba(255,214,130,0.1); color: #ffd682; font-size: 9px; cursor: pointer; }
        .sales-suggestion-ai-btn:hover { background: rgba(255,214,130,0.2); }
        .sales-suggestion-personalize-btn { padding: 3px 6px; border-radius: 4px; border: 1px solid rgba(57,255,20,0.3); background: rgba(57,255,20,0.1); color: #39ff14; font-size: 9px; cursor: pointer; }
        .sales-suggestion-personalize-btn:hover { background: rgba(57,255,20,0.2); }
        .sales-suggestion-add-btn { width: 28px; height: 28px; border-radius: 8px; border: 1px dashed rgba(255,214,130,0.3); background: transparent; color: #ffd682; font-size: 14px; cursor: pointer; }
        .sales-suggestion-add-btn:hover { background: rgba(255,214,130,0.1); }
        .sales-suggestions-search { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sales-suggestions-search input { width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #eef2ff; font-size: 11px; }
        .sales-suggestions-search input::placeholder { color: rgba(174,184,222,0.5); }
        .sales-suggestions-search input:focus { outline: none; border-color: rgba(255,214,130,0.3); }
        .sales-suggestions-filters { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); flex-wrap: wrap; }
        .sales-filter-chip { padding: 4px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aeb8de; font-size: 10px; cursor: pointer; }
        .sales-filter-chip:hover { background: rgba(255,255,255,0.05); }
        .sales-filter-chip.active { background: rgba(255,214,130,0.15); border-color: rgba(255,214,130,0.3); color: #ffd682; }
        .sales-quick-links { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sales-quick-link-btn { flex: 1; padding: 5px 4px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: #aeb8de; font-size: 9px; cursor: pointer; text-align: center; }
        .sales-quick-link-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
        .sales-section-add-btn { background: none; border: none; color: #ffd682; font-size: 12px; cursor: pointer; margin-left: 5px; opacity: 0.6; }
        .sales-section-add-btn:hover { opacity: 1; }
        .sales-fox-badge { position: absolute; top: -6px; right: -6px; width: 24px; height: 24px; border-radius: 50%; overflow: hidden; border: 2px solid #ff9800; box-shadow: 0 0 10px rgba(255,152,0,0.5); animation: salesFoxPulse 2s ease-in-out infinite; }
        .sales-fox-badge img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes salesFoxPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,152,0,0.5); } 50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255,152,0,0.8); } }
        .sales-chat-card.downsell-ready { border-color: rgba(255,152,0,0.8); box-shadow: 0 0 20px rgba(255,152,0,0.4); }
        .sales-downsell-timer { font-size: 8px; color: #ff9800; margin-top: 3px; display: flex; align-items: center; gap: 3px; }
        .sales-slot-context { padding: 10px 14px; background: linear-gradient(135deg, rgba(255,152,0,0.15), rgba(255,152,0,0.05)); border-bottom: 1px solid rgba(255,152,0,0.3); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .sales-slot-context-icon { font-size: 20px; }
        .sales-slot-context-info { flex: 1; }
        .sales-slot-context-title { font-size: 12px; font-weight: 700; color: #ff9800; }
        .sales-slot-context-details { font-size: 10px; color: #aeb8de; margin-top: 2px; }
        .sales-slot-context-seats { display: flex; gap: 3px; align-items: center; }
        .sales-seat-dot { width: 10px; height: 10px; border-radius: 2px; }
        .sales-seat-dot.filled { background: #ff9800; }
        .sales-seat-dot.empty { background: rgba(57,255,20,0.3); border: 1px solid #39ff14; }
        .sales-students-list { margin: 15px 0; max-height: 300px; overflow-y: auto; }
        .sales-student-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(10,16,42,0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 8px; }
        .sales-student-item-info { flex: 1; }
        .sales-student-item-name { font-size: 13px; font-weight: 600; color: #fff; }
        .sales-student-item-meta { font-size: 11px; color: #aeb8de; margin-top: 2px; }
        .sales-student-item-actions { display: flex; gap: 8px; }
        .sales-student-chat-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,214,130,0.3); background: rgba(255,214,130,0.1); color: #ffd682; font-size: 10px; cursor: pointer; }
        .sales-student-chat-btn:hover { background: rgba(255,214,130,0.2); }
        .sales-student-remove-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(239,68,68,0.3); background: rgba(239,68,68,0.1); color: #fca5a5; font-size: 10px; cursor: pointer; }
        .sales-student-remove-btn:hover { background: rgba(239,68,68,0.2); }
        .sales-settings-tabs { display: flex; gap: 4px; padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; }
        .sales-settings-tab { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aeb8de; font-size: 11px; font-weight: 600; cursor: pointer; }
        .sales-settings-tab:hover { background: rgba(255,255,255,0.05); }
        .sales-settings-tab.active { background: rgba(255,214,130,0.15); border-color: rgba(255,214,130,0.3); color: #ffd682; }
        .sales-settings-panel { display: none; }
        .sales-settings-panel.active { display: block; }
        .sales-sound-upload { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .sales-sound-preview { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; }
        .sales-sound-preview span { font-size: 12px; color: #aeb8de; }
        .sales-settings-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 8px; }
        .sales-settings-item:hover { background: rgba(255,255,255,0.05); }
        .sales-settings-item-content { flex: 1; min-width: 0; }
        .sales-settings-item-title { font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .sales-settings-item-text { font-size: 11px; color: #aeb8de; line-height: 1.4; word-wrap: break-word; }
        .sales-settings-item-actions { display: flex; gap: 6px; margin-left: 10px; flex-shrink: 0; }
        .sales-settings-item-btn { padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aeb8de; font-size: 10px; cursor: pointer; }
        .sales-settings-item-btn:hover { background: rgba(255,255,255,0.1); }
        .sales-settings-item-btn.delete { border-color: rgba(239,68,68,0.3); color: #fca5a5; }
        .sales-settings-item-btn.delete:hover { background: rgba(239,68,68,0.2); }
        .sales-feedback-panel { position: fixed; right: -400px; top: 0; width: 400px; height: 100vh; background: rgba(8,10,25,0.98); border-left: 1px solid rgba(255,255,255,0.1); z-index: 2500; transition: right 0.3s; display: flex; flex-direction: column; }
        .sales-feedback-panel.open { right: 0; }
        .sales-feedback-header { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .sales-feedback-header h2 { font-size: 16px; color: #fff; margin: 0; }
        .sales-feedback-header button { background: none; border: none; color: #aeb8de; font-size: 20px; cursor: pointer; }
        .sales-feedback-content { flex: 1; overflow-y: auto; padding: 16px; }
        .sales-feedback-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 12px; }
        .sales-feedback-card h4 { font-size: 13px; color: #ffd682; margin-bottom: 8px; }
        .sales-feedback-card p { font-size: 12px; color: #aeb8de; line-height: 1.5; }
        .sales-feedback-card ul { margin: 8px 0 0 0; padding-left: 20px; }
        .sales-feedback-card li { font-size: 11px; color: #aeb8de; margin-bottom: 4px; }
        .sales-drag-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; flex-direction: column; padding: 30px; }
        .sales-drag-overlay.active { display: flex; }
        .sales-drag-overlay-header { text-align: center; margin-bottom: 20px; position: relative; }
        .sales-drag-overlay-header h2 { font-size: 24px; color: #fff; margin-bottom: 8px; }
        .sales-drag-overlay-header p { font-size: 14px; color: #aeb8de; }
        .sales-drag-overlay-close { position: absolute; right: 0; top: 0; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 20px; cursor: pointer; }
        .sales-drag-overlay-close:hover { background: rgba(239,68,68,0.3); }
        .sales-drag-overlay-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .sales-drag-stat { padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; }
        .sales-drag-stat.hot { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .sales-drag-stat.warm { background: rgba(251,191,36,0.2); color: #fde68a; }
        .sales-drag-stat.cold { background: rgba(156,163,175,0.2); color: #d1d5db; }
        .sales-drag-overlay-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; }
        .sales-drag-overlay-card { padding: 15px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .sales-drag-overlay-card:hover { transform: translateY(-3px); border-color: rgba(255,214,130,0.5); }
        .sales-drag-overlay-card.urgency-red { border-color: rgba(239,68,68,0.6); }
        .sales-drag-overlay-card.urgency-yellow { border-color: rgba(251,191,36,0.6); }
        .sales-drag-overlay-card.urgency-grey { border-color: rgba(156,163,175,0.4); opacity: 0.7; }
        .sales-drag-overlay-avatar { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,255,255,0.5)); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; color: rgba(12,14,30,0.9); margin-bottom: 10px; }
        .sales-drag-overlay-name { font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .sales-drag-overlay-meta { font-size: 11px; color: #aeb8de; }
        @media (max-width: 1400px) { .sales-voice-panel { width: 280px; min-width: 280px; } }
        @media (max-width: 1200px) { .sales-suggestions-sidebar { display: none; } .sales-voice-panel { display: none; } }
        @media (max-width: 900px) { 
            .sales-modal { flex-direction: column; } 
            .sales-sidebar { width: 100%; min-width: 100%; height: auto; max-height: 30vh; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); } 
            .sales-main-area { flex: 1; min-height: 0; }
            .sales-chat-header { padding: 10px 12px; }
            .sales-chat-header-actions { display: none; }
            .sales-messages-container { padding: 12px; }
            .sales-input-area { padding: 10px 12px; }
        }
        /* ==================== END SALES CHAT STYLES ==================== */
        
        /* ==================== STUDENT LOOKUP STYLES ==================== */
        .student-lookup-container { max-height: 500px; overflow-y: auto; }
        .student-lookup-search { margin-bottom: 15px; }
        .student-lookup-search input { width: 100%; padding: 10px 15px; border-radius: 8px; border: 2px solid #444; background: rgba(0,0,0,0.3); color: #fff; font-size: 13px; }
        .student-lookup-search input:focus { outline: none; border-color: #00ffff; }
        .student-lookup-search input::placeholder { color: #888; }
        .student-lookup-list { display: flex; flex-direction: column; gap: 8px; }
        .student-lookup-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .student-lookup-item:hover { background: rgba(0,255,255,0.1); border-color: #00ffff; transform: translateX(5px); }
        .student-lookup-item-info { flex: 1; }
        .student-lookup-item-name { font-size: 13px; font-weight: 600; color: #fff; }
        .student-lookup-item-email { font-size: 11px; color: #888; margin-top: 2px; }
        .student-lookup-item-source { font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }
        .student-lookup-item-source.users { background: rgba(0,255,255,0.2); color: #00ffff; }
        .student-lookup-item-source.scheduler { background: rgba(57,255,20,0.2); color: #39ff14; }
        .student-lookup-stats { display: flex; gap: 15px; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .student-lookup-stat { text-align: center; flex: 1; }
        .student-lookup-stat-number { font-size: 20px; font-weight: 700; color: #00ffff; }
        .student-lookup-stat-label { font-size: 10px; color: #888; text-transform: uppercase; }
        .student-lookup-empty { text-align: center; padding: 30px; color: #888; }
        /* ==================== END STUDENT LOOKUP STYLES ==================== */

        /* ==================== TUESDAY READING CLASS STYLES ==================== */
        #adminTabTuesdayreading { font-size: 16px; }
        #adminTabTuesdayreading h3 { font-size: 22px; }
        #adminTabTuesdayreading p { font-size: 14px; }
        #adminTabTuesdayreading .card { font-size: 16px; }
        .tr-input-mode-btn { transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); transform: scale(1); box-shadow: none; }
        .tr-input-mode-btn:hover { transform: scale(1.05); }
        .tr-input-mode-btn.tr-mode-active { background: #00ffff !important; color: #000 !important; font-weight: 600 !important; transform: scale(1.08); box-shadow: 0 0 18px rgba(0,255,255,0.45); }
        .tr-input-mode-btn:not(.tr-mode-active) { background: rgba(255,255,255,0.08) !important; color: #aaa !important; transform: scale(1); box-shadow: none; }
        .tr-set-block { background: rgba(0,0,0,0.3); border: 2px solid #444; border-radius: 10px; padding: 15px; margin-bottom: 12px; }
        .tr-set-fadein { animation: trSetFadeIn 0.4s ease-out both; }
        @keyframes trSetFadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .tr-set-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tr-set-label { color: #00ffff; font-size: 15px; font-weight: 600; }
        .tr-set-block textarea { width: 100%; min-height: 90px; padding: 10px; background: #0a0a15; border: 2px solid #333; border-radius: 6px; color: #fff; font-family: 'Noto Sans', sans-serif; font-size: 15px; line-height: 1.6; resize: vertical; box-sizing: border-box; }
        .tr-set-block textarea:focus { border-color: #00ffff; outline: none; }
        .tr-image-drop { border: 2px dashed #555; border-radius: 8px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .tr-image-drop:hover { border-color: #00ffff; background: rgba(0,255,255,0.05); }
        .tr-extracted-text { margin-top: 10px; padding: 10px; background: rgba(57,255,20,0.1); border: 1px solid rgba(57,255,20,0.3); border-radius: 6px; }
        .tr-reading-card { background: rgba(0,0,0,0.4); border: 2px solid #ff00ff; border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .tr-card-header { background: linear-gradient(135deg, rgba(255,0,255,0.15), rgba(156,39,176,0.15)); padding: 12px 18px; border-bottom: 1px solid rgba(255,0,255,0.3); }
        .tr-card-header-title { color: #ff00ff; font-weight: 600; font-size: 16px; }
        .tr-card-header-meta { color: #888; font-size: 13px; margin-top: 3px; }
        .tr-card-columns { display: flex; gap: 0; min-height: 120px; }
        .tr-card-col { flex: 1; padding: 15px; padding-bottom: 50px; position: relative; }
        .tr-card-col-left { background: rgba(136,255,136,0.05); border-right: 1px solid rgba(255,255,255,0.1); }
        .tr-card-col-right { background: rgba(255,170,0,0.05); }
        .tr-col-header { display: flex; gap: 20px; border-bottom: 2px solid rgba(255,255,255,0.15); padding: 10px 18px; }
        .tr-col-header-cell { flex: 1; text-align: center; font-weight: 600; font-size: 15px; }
        .tr-col-header-cell.novice-label { color: #88ff88; }
        .tr-col-header-cell.begup-label { color: #ffaa00; }
        .tr-sentence-item { padding: 10px 12px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-bottom: 8px; }
        .tr-sentence-item:last-child { margin-bottom: 0; }
        .tr-korean-text { font-size: 17px; color: #fff; line-height: 1.6; margin-bottom: 5px; }
        .tr-english-text { font-size: 14px; color: #aaa; font-style: italic; line-height: 1.4; }
        .tr-check-area { position: absolute; bottom: 10px; right: 12px; display: flex; align-items: center; gap: 8px; }
        .tr-check-area .tr-check-btn { background: linear-gradient(135deg, #5865F2, #7289DA); border: none; color: #fff; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.25s; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(88,101,242,0.3); }
        .tr-check-area .tr-check-btn:hover { transform: scale(1.07); box-shadow: 0 0 20px rgba(88,101,242,0.55); }
        .tr-check-area .tr-check-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .tr-check-area .tr-check-btn.checking { background: linear-gradient(135deg, #FFA500, #e69500); }
        .tr-check-area .tr-check-btn.success { background: linear-gradient(135deg, #39ff14, #20cc00); color: #000; }
        .tr-check-area .tr-check-btn.error { background: linear-gradient(135deg, #ff4444, #cc2222); }
        .tr-check-area .tr-pts { background: linear-gradient(135deg, #39ff14, #20cc00); color: #000; padding: 5px 12px; border-radius: 14px; font-size: 12px; font-weight: 700; box-shadow: 0 0 10px rgba(57,255,20,0.3); }
        @keyframes trOverlayFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes trCardSlideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ==================== MATERIALS CREATION WINDOW STYLES ==================== */
        .mat-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(5,5,18,0.96); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 10000; overflow-y: auto; display: none; }
        .mat-overlay.active { display: block; animation: trOverlayFadeIn 0.3s ease-out both; }
        .mat-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .mat-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0 20px 0; border-bottom: 2px solid rgba(255,0,255,0.3); margin-bottom: 25px; }
        .mat-header h2 { color: #ff00ff; font-size: 22px; margin: 0; }
        .mat-close-btn { background: rgba(255,68,68,0.9); color: #fff; border: none; width: 38px; height: 38px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .mat-close-btn:hover { background: #ff4444; transform: scale(1.15); }
        .mat-panels { display: grid; grid-template-columns: 380px 1fr; gap: 20px; }
        @media (max-width: 900px) { .mat-panels { grid-template-columns: 1fr; } }
        .mat-input-panel { background: rgba(0,0,0,0.4); border: 2px solid #444; border-radius: 12px; padding: 20px; }
        .mat-input-panel h3 { color: #00ffff; font-size: 16px; margin: 0 0 15px 0; }
        .mat-input-panel textarea { width: 100%; min-height: 180px; padding: 12px; background: #0a0a15; border: 2px solid #333; border-radius: 8px; color: #fff; font-family: 'Noto Sans', sans-serif; font-size: 15px; line-height: 1.7; resize: vertical; box-sizing: border-box; }
        .mat-input-panel textarea:focus { border-color: #00ffff; outline: none; }
        .mat-input-panel textarea::placeholder { color: #555; }
        .mat-color-row { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
        .mat-color-row label { color: #888; font-size: 11px; }
        .mat-color-row input[type="color"] { width: 36px; height: 28px; border: 1px solid #444; border-radius: 4px; background: none; cursor: pointer; }
        .mat-font-size-row { display: flex; gap: 12px; align-items: center; margin-top: 12px; }
        .mat-font-size-row label { color: #888; font-size: 11px; white-space: nowrap; }
        .mat-font-size-row input[type="range"] { flex: 1; accent-color: #ff00ff; }
        .mat-font-size-row span { color: #00ffff; font-size: 12px; min-width: 36px; }
        .mat-generate-row { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .mat-btn-generate { padding: 12px 24px; background: linear-gradient(135deg, #ff00ff, #9c27b0); border: 2px solid #ff00ff; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.25s; }
        .mat-btn-generate:hover { transform: scale(1.04); box-shadow: 0 0 20px rgba(255,0,255,0.4); }
        .mat-preview-panel { background: rgba(0,0,0,0.4); border: 2px solid #444; border-radius: 12px; padding: 20px; }
        .mat-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .mat-preview-header h3 { color: #ff00ff; font-size: 16px; margin: 0; }
        .mat-export-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .mat-btn-export { padding: 8px 16px; border: 2px solid; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; background: rgba(0,0,0,0.3); }
        .mat-btn-export:hover { transform: scale(1.04); }
        .mat-btn-pdf { color: #ff3366; border-color: #ff3366; }
        .mat-btn-pdf:hover { background: rgba(255,51,102,0.15); box-shadow: 0 0 12px rgba(255,51,102,0.3); }
        .mat-btn-html { color: #39ff14; border-color: #39ff14; }
        .mat-btn-html:hover { background: rgba(57,255,20,0.15); box-shadow: 0 0 12px rgba(57,255,20,0.3); }
        .mat-slideshow { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 10px; overflow: hidden; background: #111; border: 2px solid #333; }
        .mat-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; opacity: 0; transition: opacity 0.5s ease; box-sizing: border-box; }
        .mat-slide.active { opacity: 1; }
        .mat-slide-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
        .mat-slide-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .mat-slide-content { position: relative; z-index: 2; max-width: 85%; width: 85%; display: flex; flex-direction: column; align-items: center; gap: 12px; overflow: hidden; }
        .mat-slide-korean { font-weight: 700; line-height: 1.6; color: #000; word-break: keep-all; display: block; width: 100%; text-align: center; }
        .mat-slide-number { position: absolute; bottom: 12px; right: 18px; font-size: 13px; color: #000; opacity: 0.3; z-index: 2; }
        .mat-slide-nav { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 15px; }
        .mat-slide-nav button { padding: 8px 20px; background: rgba(255,0,255,0.2); border: 2px solid #ff00ff; border-radius: 6px; color: #ff00ff; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .mat-slide-nav button:hover { background: rgba(255,0,255,0.4); box-shadow: 0 0 12px rgba(255,0,255,0.3); }
        .mat-slide-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
        .mat-slide-nav span { color: #888; font-size: 13px; min-width: 80px; text-align: center; }
        .mat-slide-dots { display: flex; gap: 6px; justify-content: center; margin-top: 10px; }
        .mat-slide-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,0,255,0.25); border: 1px solid rgba(255,0,255,0.4); cursor: pointer; transition: all 0.2s; }
        .mat-slide-dot.active { background: #ff00ff; box-shadow: 0 0 8px rgba(255,0,255,0.5); }
        .mat-empty-preview { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; color: #555; }
        .mat-empty-preview span { font-size: 48px; margin-bottom: 12px; }
        .mat-empty-preview p { font-size: 14px; }
        .mat-slide-title { position: absolute; top: 0; left: 0; width: 100%; padding: 10px 18px; font-size: 11px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; z-index: 2; opacity: 0.7; }

        /* Expanded Preview Mode */
        .mat-expanded-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
        .mat-expanded-overlay.active { display: flex; }
        .mat-expanded-close { position: fixed; top: 15px; right: 20px; background: rgba(255,68,68,0.9); color: #fff; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 20001; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .mat-expanded-close:hover { background: #ff4444; transform: scale(1.15); }
        .mat-expanded-slide-wrap { position: relative; overflow: visible; flex-shrink: 0; }
        .mat-expanded-slide-inner { position: relative; width: 1920px; height: 1080px; transform-origin: top left; }
        .mat-expanded-slide-wrap .mat-slide-bg { position: absolute; top: 0; left: 0; width: 1920px; height: 1080px; border-radius: 12px; }
        .mat-expanded-content { position: absolute; top: 123px; left: 155px; right: 155px; bottom: 123px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; z-index: 2; overflow: visible; text-align: center; }
        .mat-expanded-sentence { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 12px; width: 100%; }
        .mat-word { font-weight: 700; color: #000; cursor: pointer; padding: 6px 8px; border-radius: 6px; transition: all 0.15s; position: relative; user-select: none; }
        .mat-word:hover { background: rgba(0,200,255,0.25); transform: scale(1.05); }
        .mat-word.mat-word-playing { background: rgba(255,0,255,0.25); transform: scale(1.08); }
        .mat-word .mat-word-tip { position: absolute; bottom: calc(100% + 12px); left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #1a1a2e, #2d2748); color: #fff; padding: 20px 24px; border-radius: 12px; min-width: 300px; max-width: 420px; z-index: 30000; box-shadow: 0 8px 30px rgba(0,0,0,0.7); border: 2px solid #00ffff; opacity: 0; visibility: hidden; transition: all 0.2s ease; pointer-events: none; white-space: normal; text-align: left; font-size: 16px; font-weight: 400; }
        .mat-word:hover .mat-word-tip { opacity: 1; visibility: visible; pointer-events: auto; }
        .mat-word .mat-word-tip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 8px solid transparent; border-top-color: #00ffff; }
        .mat-word.mat-tip-left .mat-word-tip { left: 0; transform: translateX(0); }
        .mat-word.mat-tip-left .mat-word-tip::after { left: 30px; transform: none; }
        .mat-word.mat-tip-right .mat-word-tip { left: auto; right: 0; transform: translateX(0); }
        .mat-word.mat-tip-right .mat-word-tip::after { left: auto; right: 30px; transform: none; }
        .mat-word-tip .tip-label { font-size: 11px; color: #00ffff; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .mat-word-tip .tip-english { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 6px; }
        .mat-word-tip .tip-pos { font-size: 12px; color: #ff00ff; font-style: italic; margin-bottom: 4px; }
        .mat-word-tip .tip-detail { font-size: 11px; color: #aaa; line-height: 1.5; }
        .mat-word-tip .tip-loading { font-size: 12px; color: #888; }
        .mat-expanded-nav { display: flex; gap: 15px; align-items: center; z-index: 20001; flex-shrink: 0; }
        .mat-expanded-nav button { padding: 10px 24px; background: rgba(255,0,255,0.25); border: 2px solid #ff00ff; border-radius: 8px; color: #ff00ff; font-size: 14px; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .mat-expanded-nav button:hover { background: rgba(255,0,255,0.45); }
        .mat-expanded-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
        .mat-expanded-nav span { color: #888; font-size: 14px; min-width: 80px; text-align: center; }
        .mat-expanded-num { position: absolute; bottom: 20px; right: 30px; font-size: 22px; color: #000; opacity: 0.3; z-index: 2; }
        .mat-expanded-hint { color: rgba(255,255,255,0.35); font-size: 12px; flex-shrink: 0; }
        /* ==================== END MATERIALS CREATION WINDOW STYLES ==================== */
        /* ==================== END TUESDAY READING CLASS STYLES ==================== */
    </style>
</head>
<body>
    <!-- Theme Toggle Switch - Fixed position top right -->
    <div class="theme-toggle-container">
        <label class="switch">
            <input type="checkbox" id="themeToggle" checked onchange="toggleLightMode()">
            <span class="slider">
                <span class="sun">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f9d71c">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="12" y1="21" x2="12" y2="23" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="1" y1="12" x2="3" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="21" y1="12" x2="23" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                    </svg>
                </span>
                <span class="moon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </span>
            </span>
        </label>
    </div>

    <div class="container">
        <!-- Login Section -->
        <div id="loginSection">
            <h2>ðŸŽ® CLASS SCHEDULER</h2>
            <div class="role-tabs">
                <button class="role-tab active" onclick="switchRole('admin')">âš™ï¸ ADMIN</button>
                <button class="role-tab" onclick="switchRole('support')">ðŸ›Ÿ SUPPORT</button>
                <button class="role-tab" onclick="switchRole('teacher')">ðŸ‘¨â€ðŸ« TEACHER</button>
            </div>

            <!-- Admin Login -->
            <div id="adminLoginForm">
                <div id="adminLoginMessage"></div>
                <div class="form-group"><label>Admin Email</label><input type="email" id="adminEmail" placeholder="Enter admin email"></div>
                <div class="form-group"><label>Password</label><input type="password" id="adminPassword" placeholder="Enter password"></div>
                <button class="btn btn-primary btn-block" onclick="adminLogin()">ðŸ”“ LOGIN AS ADMIN</button>
            </div>

            <!-- Support Login -->
            <div id="supportLoginForm" style="display: none;">
                <div id="supportLoginMessage"></div>
                <div class="form-group"><label>Support Email</label><input type="email" id="supportEmail" placeholder="Enter support email"></div>
                <div class="form-group"><label>Password</label><input type="password" id="supportPassword" placeholder="Enter password"></div>
                <button class="btn btn-block" style="background: #9c27b0; border-color: #9c27b0;" onclick="supportLogin()">ðŸ”“ LOGIN AS SUPPORT</button>
            </div>

            <!-- Teacher Login -->
            <div id="teacherLoginForm" style="display: none;">
                <div id="teacherLoginMessage"></div>
                <div class="form-group"><label>Teacher Email</label><input type="email" id="teacherEmail" placeholder="Enter teacher email"></div>
                <div class="form-group"><label>Password</label><input type="password" id="teacherPassword" placeholder="Enter password"></div>
                <button class="btn btn-success btn-block" onclick="teacherLogin()">ðŸ”“ LOGIN AS TEACHER</button>
            </div>
        </div>

        <!-- Main Panel -->
        <div id="mainPanel">
            <div class="header">
                <h1>ðŸŽ® CLASS SCHEDULER</h1>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="user-info" id="userInfoDisplay"></span>
                    <button class="btn btn-danger btn-sm" onclick="logout()">LOGOUT</button>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" style="display: none;">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showAdminTab('dashboard')">ðŸ“Š Dashboard</button>
                    <button class="nav-tab" onclick="showAdminTab('calendar')">ðŸ—“ï¸ Calendar</button>
                    <button class="nav-tab" onclick="showAdminTab('schedule')">ðŸ“… Schedule</button>
                    <button class="nav-tab" onclick="showAdminTab('students')">ðŸ“‹ Students</button>
                    <button class="nav-tab" onclick="showAdminTab('proposals')">ðŸ“ Proposals</button>
                    <button class="nav-tab" onclick="showAdminTab('classes')">ðŸ“š Classes</button>
                    <button class="nav-tab" onclick="showAdminTab('checkin')">âœ… Check-in</button>
                    <button class="nav-tab" onclick="showAdminTab('outreach')">ðŸ“ž Outreach</button>
                    <button class="nav-tab" onclick="showAdminTab('attendance')">ðŸ“Š Attendance</button>
                    <button class="nav-tab" onclick="showAdminTab('absences')">ðŸš« Absences</button>
                    <button class="nav-tab" onclick="showAdminTab('movehistory')">ðŸ”„ Move History</button>
                    <button class="nav-tab" onclick="showAdminTab('completed')">ðŸŽ“ Completed</button>
                    <button class="nav-tab" onclick="showAdminTab('teachers')">ðŸ‘¨â€ðŸ« Teachers</button>
                    <button class="nav-tab" onclick="showAdminTab('materials')">ðŸ“– Materials</button>
                    <button class="nav-tab" onclick="showAdminTab('tuesdayreading')">ðŸ“– Tuesday Reading</button>
                    <button class="nav-tab" onclick="showAdminTab('slotmanager')">ðŸ“… Slot Manager</button>
                    <button class="nav-tab" onclick="showAdminTab('suggestions')">ðŸ’¡ Suggestions</button>
                    <button class="nav-tab" onclick="showAdminTab('ready')">âœ… Ready</button>
                    <button class="nav-tab" onclick="showAdminTab('accounts')">ðŸ‘¤ Account Creation</button>
                    <button class="nav-tab" onclick="showAdminTab('settings')">âš™ï¸ Settings</button>
                </div>

                <div id="adminTabDashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card cyan"><div class="stat-number" id="statTotalStudents">0</div><div class="stat-label">TOTAL STUDENTS</div></div>
                        <div class="stat-card green"><div class="stat-number" id="statAssignedStudents">0</div><div class="stat-label">ASSIGNED</div></div>
                        <div class="stat-card yellow"><div class="stat-number" id="statPendingStudents">0</div><div class="stat-label">PENDING LEVEL</div></div>
                        <div class="stat-card orange"><div class="stat-number" id="statLimboStudents">0</div><div class="stat-label">IN LIMBO</div></div>
                        <div class="stat-card pink"><div class="stat-number" id="statTotalClasses">0</div><div class="stat-label">CLASSES</div></div>
                    </div>
                    <div class="card"><h3>ðŸ“… Current Week</h3><div class="week-tracker" id="dashboardWeekTracker"></div></div>
                    
                    <!-- Quick Actions -->
                    <div class="card" style="margin-top: 20px;">
                        <h3>ðŸš€ Quick Actions</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <button class="btn btn-info" onclick="openStudentLookupModal()">ðŸ” Student Lookup</button>
                        </div>
                    </div>
                    
                    <!-- Teacher Classes View -->
                    <div class="card" style="margin-top: 20px;">
                        <h3>ðŸ‘¨â€ðŸ« View Teacher's Classes</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Click a teacher to view their Today and My Classes view (useful for covering classes)</p>
                        <div id="teacherButtonsContainer" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <!-- Teacher buttons will be populated here -->
                        </div>
                        <div id="adminTeacherViewContainer" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 8px;">
                                <span style="color: #00ffff; font-size: 13px;">Viewing classes for: <strong id="adminViewingTeacherName"></strong></span>
                                <button class="btn btn-sm btn-secondary" onclick="closeAdminTeacherView()">âœ• Close</button>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button class="btn btn-sm admin-teacher-view-tab active" onclick="switchAdminTeacherViewTab('today')" data-tab="today">ðŸ“… Today</button>
                                <button class="btn btn-sm admin-teacher-view-tab" onclick="switchAdminTeacherViewTab('classes')" data-tab="classes">ðŸ“š My Classes</button>
                            </div>
                            <div id="adminTeacherTodayView"></div>
                            <div id="adminTeacherClassesView" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div id="adminTabCalendar" class="tab-content">
                    <div class="card">
                        <h3>ðŸ—“ï¸ Monthly Calendar</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <button class="btn btn-info" onclick="changeCalendarMonth(-1)">â—€ Prev</button>
                            <span id="calendarMonthLabel" style="font-size: 12px; color: #00ffff;"></span>
                            <button class="btn btn-info" onclick="changeCalendarMonth(1)">Next â–¶</button>
                        </div>
                        <div class="monthly-calendar" id="monthlyCalendarGrid"></div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-top: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Class Day</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #00ffff;"></div><span>Today</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff00ff;"></div><span>Course Start/End</span></div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Tab -->
                <div id="adminTabSchedule" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“… Weekly Schedule Overview</h3>
                        
                        <!-- Summary Stats -->
                        <div class="schedule-summary" id="adminScheduleSummary">
                            <div class="summary-box total"><div class="summary-number" id="schedTotalSlots">16</div><div class="summary-label">TOTAL SLOTS</div></div>
                            <div class="summary-box active"><div class="summary-number" id="schedActiveClasses">0</div><div class="summary-label">ACTIVE CLASSES</div></div>
                            <div class="summary-box needs-teacher"><div class="summary-number" id="schedNeedsTeacher">0</div><div class="summary-label">NEED TEACHER</div></div>
                            <div class="summary-box full"><div class="summary-number" id="schedFullClasses">0</div><div class="summary-label">FULL CLASSES</div></div>
                            <div class="summary-box empty"><div class="summary-number" id="schedEmptySlots">16</div><div class="summary-label">EMPTY SLOTS</div></div>
                            <div class="summary-box available"><div class="summary-number" id="schedAvailableSpots">0</div><div class="summary-label">SPOTS AVAILABLE</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend">
                            <div class="legend-item"><div class="legend-bar active"></div><span>Active (has teacher)</span></div>
                            <div class="legend-item"><div class="legend-bar needs-teacher"></div><span>Needs Teacher</span></div>
                            <div class="legend-item"><div class="legend-bar full"></div><span>Full (max students)</span></div>
                            <div class="legend-item"><div class="legend-bar empty"></div><span>Empty Slot</span></div>
                        </div>
                        
                        <!-- Schedule Grid -->
                        <div class="schedule-grid" id="adminScheduleGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div id="adminTabStudents" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“‹ Registered Students</h3>
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="loadAllStudents()">ðŸ”„ Refresh Students</button>
                            <button class="btn btn-success" onclick="autoGenerateClasses()">ðŸ¤– Auto-Generate Classes</button>
                            <button class="btn btn-warning" onclick="openExistingStudentSearch()">ðŸ” Add Existing Student</button>
                        </div>
                        <div style="overflow-x: auto;"><table><thead><tr><th>Name</th><th>Email</th><th>Location</th><th>Timezone</th><th>Availability</th><th>Video</th><th>Class</th><th>Status</th><th>Actions</th></tr></thead><tbody id="studentsTableBody"><tr><td colspan="9" style="text-align: center; color: #888;">Loading...</td></tr></tbody></table></div>
                    </div>
                </div>

                <!-- Proposals Tab -->
                <div id="adminTabProposals" class="tab-content">
                    <div class="proposals-layout">
                        <!-- Left Side - Proposed Classes -->
                        <div class="proposals-left">
                            <div class="card">
                                <h3>ðŸ“ Proposed Classes</h3>
                                <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Review and manage class proposals before finalizing.</p>
                                <div id="proposalsContainer"><p style="color: #888; font-size: 12px;">No proposals yet. Use "Auto-Generate Classes" to create proposals.</p></div>
                            </div>
                        </div>
                        
                        <!-- Right Side - Available Students -->
                        <div class="proposals-right">
                            <div class="card">
                                <h3>ðŸ‘¥ Available Students</h3>
                                <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Drag students into proposed classes. <span style="color: #ff00ff;">ðŸŒˆ Rainbow = good fit</span></p>
                                <div id="availableStudentsForProposals"><p style="color: #888; font-size: 12px;">No available students.</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="adminTabClasses" class="tab-content">
                    <!-- Class Management Buttons -->
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <h3 style="margin: 0;">ðŸŽ“ Class Management</h3>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #ff00ff, #cc00cc); border-color: #ff00ff;" onclick="openAddClassTypeModal()">âž• Add Class Type</button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #00ffff, #00cccc); border-color: #00ffff; color: #000;" onclick="openAddClassModal()">âž• Add Class</button>
                            </div>
                        </div>
                        <p style="font-size: 11px; color: #888; margin-top: 10px;">Class Types: <span id="classTypesDisplay">Loading...</span></p>
                    </div>
                    
                    <div class="card"><h3>ðŸ“… Week Tracker</h3><div class="week-tracker" id="classesWeekTracker"></div></div>
                    <div class="grid-2">
                        <div class="card"><h3>ðŸ“š Generated Classes</h3><div id="classesContainer"><p style="color: #888; font-size: 12px;">No classes yet.</p></div></div>
                        <div class="card"><h3 style="color: #ff3366; border-color: #ff3366;">âš ï¸ Limbo Students</h3><div class="limbo-section" id="limboContainer"><p style="color: #888; font-size: 12px;">No students in limbo.</p></div></div>
                    </div>
                </div>

                <!-- Check-in Tab (Weekly Attendance) -->
                <div id="adminTabCheckin" class="tab-content">
                    <div class="card">
                        <h3>âœ… Weekly Attendance</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Manually mark which students attended class this week.</p>
                        
                        <!-- Week Navigation -->
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                            <button class="btn btn-sm" onclick="changeCheckinWeek(-1)" style="padding: 8px 15px;">â—€ Previous</button>
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: 600; color: #00ffff;" id="checkinWeekDisplay">Week of Jan 7, 2026</div>
                                <div style="font-size: 12px; color: #888;">Tuesday & Wednesday Classes</div>
                            </div>
                            <button class="btn btn-sm" onclick="changeCheckinWeek(1)" style="padding: 8px 15px;">Next â–¶</button>
                        </div>
                        
                        <!-- Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #00ffff;"><div class="summary-number" id="checkinTotalStudents" style="color: #00ffff;">0</div><div class="summary-label">TOTAL STUDENTS</div></div>
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="checkinAttended" style="color: #39ff14;">0</div><div class="summary-label">ATTENDED</div></div>
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="checkinAbsent" style="color: #ff3366;">0</div><div class="summary-label">ABSENT</div></div>
                            <div class="summary-box" style="border-color: #ff9800;"><div class="summary-number" id="checkinExceptions" style="color: #ff9800;">0</div><div class="summary-label">EXCEPTIONS</div></div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="loadCheckinData()">ðŸ”„ Refresh</button>
                            <button class="btn btn-success" onclick="markAllPresent()">âœ… Mark All Present</button>
                            <button class="btn" onclick="openAttendanceAnalytics()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: #fff;">ðŸ“Š Analytics</button>
                            <button class="btn" onclick="openContactLog()" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: #fff;">ðŸ“ Contact Log</button>
                            <button class="btn btn-secondary" onclick="clearAllAttendance()">ðŸ—‘ï¸ Clear All</button>
                        </div>
                        
                        <!-- Two Column Layout -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            
                            <!-- Left: All Registered Students -->
                            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px;">
                                <h4 style="color: #00ffff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    <span>ðŸ‘¥ All Students</span>
                                    <span style="font-size: 12px; color: #888; font-weight: normal;">(<span id="checkinStudentCount">0</span> total)</span>
                                </h4>
                                
                                <!-- Search Bar -->
                                <div style="margin-bottom: 15px;">
                                    <input type="text" id="checkinSearchInput" placeholder="ðŸ” Search by name or Discord..." 
                                           oninput="filterCheckinStudents()" 
                                           style="width: 100%; padding: 10px 15px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 8px; color: #fff; font-size: 13px;">
                                </div>
                                
                                <!-- Legend -->
                                <div style="display: flex; gap: 15px; margin-bottom: 15px; font-size: 11px; flex-wrap: wrap;">
                                    <span><span style="color: #666;">âšª</span> Not marked</span>
                                    <span><span style="color: #39ff14;">âœ…</span> Attended</span>
                                    <span><span style="background: linear-gradient(135deg, #ff9800, #ff5722); padding: 2px 6px; border-radius: 4px; font-size: 9px;">EXCEPTION</span> Not required</span>
                                </div>
                                
                                <div id="checkinAllStudentsList" style="max-height: 500px; overflow-y: auto;">
                                    <p style="color: #888; font-size: 12px;">Loading students...</p>
                                </div>
                            </div>
                            
                            <!-- Right: This Week's Attendance -->
                            <div style="background: rgba(57,255,20,0.05); border: 1px solid rgba(57,255,20,0.2); border-radius: 12px; padding: 20px;">
                                <h4 style="color: #39ff14; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    <span>ðŸ“‹ Attended This Week</span>
                                    <span style="font-size: 12px; color: #888; font-weight: normal;">(<span id="checkinThisWeekCount">0</span>)</span>
                                </h4>
                                
                                <div id="checkinThisWeekList" style="max-height: 500px; overflow-y: auto;">
                                    <p style="color: #888; font-size: 12px;">No attendance marked yet.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Students Not Attended -->
                        <div style="margin-top: 20px; background: rgba(255,51,102,0.1); border: 1px solid rgba(255,51,102,0.3); border-radius: 12px; padding: 20px;">
                            <h4 style="color: #ff3366; margin-bottom: 15px;">âš ï¸ Did Not Attend</h4>
                            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Students who haven't been marked as attended this week.</p>
                            <div id="checkinAbsentList">
                                <p style="color: #39ff14;">Everyone attended! ðŸŽ‰</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Outreach Analytics Tab (Full Page) -->
                <div id="adminTabOutreach" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“ž Outreach Analytics & Contact Management</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 20px;">Bird's eye view of all student contact history, outreach status, and follow-ups.</p>
                        
                        <!-- Time Period Filter -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                            <div style="display: flex; gap: 5px;">
                                <button class="btn outreach-period-btn active" id="outreachPeriodWeek" onclick="setOutreachPeriod('week')">This Week</button>
                                <button class="btn outreach-period-btn" id="outreachPeriodMonth" onclick="setOutreachPeriod('month')">This Month</button>
                                <button class="btn outreach-period-btn" id="outreachPeriodAll" onclick="setOutreachPeriod('all')">All Time</button>
                            </div>
                            <button class="btn btn-info" onclick="loadOutreachAnalytics()">ðŸ”„ Refresh</button>
                            <button class="btn" onclick="exportOutreachReport()" style="background: linear-gradient(135deg, #667eea, #764ba2);">ðŸ“¥ Export Report</button>
                        </div>
                        
                        <!-- Summary Stats Row -->
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 25px;">
                            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 12px; padding: 15px; text-align: center;">
                                <div id="outreachTotalStudents" style="font-size: 28px; font-weight: 700; color: #00ffff;">0</div>
                                <div style="font-size: 11px; color: #888;">Total Students</div>
                            </div>
                            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 12px; padding: 15px; text-align: center;">
                                <div id="outreachContacted" style="font-size: 28px; font-weight: 700; color: #39ff14;">0</div>
                                <div style="font-size: 11px; color: #888;">Contacted</div>
                            </div>
                            <div style="background: rgba(255,51,102,0.1); border: 2px solid #ff3366; border-radius: 12px; padding: 15px; text-align: center;">
                                <div id="outreachNotContacted" style="font-size: 28px; font-weight: 700; color: #ff3366;">0</div>
                                <div style="font-size: 11px; color: #888;">Not Contacted</div>
                            </div>
                            <div style="background: rgba(255,170,0,0.1); border: 2px solid #ffaa00; border-radius: 12px; padding: 15px; text-align: center;">
                                <div id="outreachPending" style="font-size: 28px; font-weight: 700; color: #ffaa00;">0</div>
                                <div style="font-size: 11px; color: #888;">Pending</div>
                            </div>
                            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 12px; padding: 15px; text-align: center;">
                                <div id="outreachResolved" style="font-size: 28px; font-weight: 700; color: #39ff14;">0</div>
                                <div style="font-size: 11px; color: #888;">Resolved</div>
                            </div>
                            <div style="background: rgba(255,51,102,0.1); border: 2px solid #ff3366; border-radius: 12px; padding: 15px; text-align: center;">
                                <div id="outreachEscalated" style="font-size: 28px; font-weight: 700; color: #ff3366;">0</div>
                                <div style="font-size: 11px; color: #888;">Escalated</div>
                            </div>
                        </div>
                        
                        <!-- Two Column Layout: Not Contacted vs Contact History -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                            
                            <!-- Left: Students Never Contacted -->
                            <div style="background: rgba(255,51,102,0.05); border: 2px solid rgba(255,51,102,0.3); border-radius: 12px; padding: 20px;">
                                <h4 style="color: #ff3366; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                                    <span>ðŸš¨ Need Outreach (2+ Absences)</span>
                                    <span id="outreachNeverContactedCount" style="background: #ff3366; color: #fff; padding: 2px 10px; border-radius: 12px; font-size: 12px;">0</span>
                                </h4>
                                <p style="font-size: 11px; color: #888; margin-bottom: 15px;">Students with 2+ class absences who have never been contacted.</p>
                                <div id="outreachNeverContactedList" style="max-height: 350px; overflow-y: auto;">
                                    <p style="color: #888; font-size: 12px; text-align: center;">Loading...</p>
                                </div>
                            </div>
                            
                            <!-- Right: Students With Pending Follow-ups -->
                            <div style="background: rgba(255,170,0,0.05); border: 2px solid rgba(255,170,0,0.3); border-radius: 12px; padding: 20px;">
                                <h4 style="color: #ffaa00; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                                    <span>â° Pending Follow-ups</span>
                                    <span id="outreachPendingFollowupsCount" style="background: #ffaa00; color: #000; padding: 2px 10px; border-radius: 12px; font-size: 12px;">0</span>
                                </h4>
                                <p style="font-size: 11px; color: #888; margin-bottom: 15px;">Contacts that need follow-up or are still pending.</p>
                                <div id="outreachPendingFollowupsList" style="max-height: 350px; overflow-y: auto;">
                                    <p style="color: #888; font-size: 12px; text-align: center;">Loading...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Full Student Contact Overview Table -->
                        <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px;">
                            <h4 style="color: #00ffff; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                                <span>ðŸ“Š All Students Contact Overview</span>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="outreachSearchInput" placeholder="ðŸ” Search student..." oninput="filterOutreachTable()" style="padding: 6px 12px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; font-size: 12px; width: 180px;">
                                    <select id="outreachStatusFilter" onchange="filterOutreachTable()" style="padding: 6px 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; font-size: 12px;">
                                        <option value="all">All Status</option>
                                        <option value="never">Never Contacted</option>
                                        <option value="contacted">Contacted</option>
                                        <option value="pending">Pending</option>
                                        <option value="resolved">Resolved</option>
                                        <option value="escalate">Escalated</option>
                                    </select>
                                </div>
                            </h4>
                            
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead>
                                        <tr style="background: rgba(0,255,255,0.1);">
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #00ffff; color: #00ffff;">Student</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #00ffff;">Absences</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #ffaa00;" title="Monday">M</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #ffaa00;" title="Tuesday">T</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #ffaa00;" title="Wednesday">W</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #ffaa00;" title="Thursday">Th</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #ffaa00;" title="Friday">F</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #00ffff;"># Contacts</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #00ffff;">Last Contact</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #00ffff;">Status</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #00ffff;">Resolution</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #00ffff; color: #00ffff;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="outreachTableBody">
                                        <tr><td colspan="12" style="padding: 40px; text-align: center; color: #888;">Loading student data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Recent Contact Activity Log -->
                        <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; margin-top: 20px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">ðŸ“ Recent Contact Activity</h4>
                            <div id="outreachRecentActivity" style="max-height: 300px; overflow-y: auto;">
                                <p style="color: #888; font-size: 12px; text-align: center;">Loading recent activity...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="adminTabAttendance" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“Š Attendance Overview</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">View and manage attendance for all classes.</p>
                        
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-info" onclick="loadAdminAttendance()">ðŸ”„ Refresh</button>
                            <div class="form-group" style="margin: 0;">
                                <select id="adminAttendanceClassFilter" onchange="loadAdminAttendance()" style="padding: 8px; font-size: 12px;">
                                    <option value="all">All Classes</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Attendance Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="adminAttendancePresent" style="color: #39ff14;">0</div><div class="summary-label">PRESENT</div></div>
                            <div class="summary-box" style="border-color: #ffff00;"><div class="summary-number" id="adminAttendanceLate" style="color: #ffff00;">0</div><div class="summary-label">LATE</div></div>
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="adminAttendanceAbsent" style="color: #ff3366;">0</div><div class="summary-label">ABSENT</div></div>
                            <div class="summary-box" style="border-color: #888;"><div class="summary-number" id="adminAttendanceNotMarked" style="color: #888;">0</div><div class="summary-label">NOT MARKED</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Present</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ffff00;"></div><span>Late</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>Absent</span></div>
                        </div>
                        
                        <!-- Attendance List -->
                        <div id="adminAttendanceContainer">
                            <p style="color: #888; font-size: 12px;">Click refresh to load attendance...</p>
                        </div>
                    </div>
                </div>

                <!-- Absences Tab -->
                <div id="adminTabAbsences" class="tab-content">
                    <div class="card">
                        <h3>ðŸš« Student Absences</h3>
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-info" onclick="loadAbsencesList()">ðŸ”„ Refresh</button>
                            <div class="form-group" style="margin: 0;">
                                <select id="absenceWeekFilter" onchange="loadAbsencesList()" style="padding: 8px; font-size: 12px;">
                                    <option value="all">All Weeks</option>
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <select id="absenceContactFilter" onchange="filterAbsencesList()" style="padding: 8px; font-size: 12px;">
                                    <option value="all">All Status</option>
                                    <option value="not-contacted">Not Contacted Only</option>
                                    <option value="contacted">Contacted Only</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Absence Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="absenceTotalCount" style="color: #ff3366;">0</div><div class="summary-label">TOTAL ABSENCES</div></div>
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="absenceContactedCount" style="color: #39ff14;">0</div><div class="summary-label">CONTACTED</div></div>
                            <div class="summary-box" style="border-color: #ff6600;"><div class="summary-number" id="absenceNotContactedCount" style="color: #ff6600;">0</div><div class="summary-label">NOT CONTACTED</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Contacted</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>Not Contacted</span></div>
                        </div>
                        
                        <!-- Absences List -->
                        <div id="absencesListContainer">
                            <p style="color: #888; font-size: 12px;">Click refresh to load absences...</p>
                        </div>
                    </div>
                </div>

                <!-- Move History Tab -->
                <div id="adminTabMovehistory" class="tab-content">
                    <div class="card">
                        <h3>ðŸ”„ Student Move History</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Track all student movements between classes, returns to pool, and drops.</p>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-info" onclick="loadMoveHistory()">ðŸ”„ Refresh</button>
                            <input type="text" id="moveHistorySearch" placeholder="ðŸ” Search by student name..." oninput="filterMoveHistory()" style="padding: 8px 12px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; font-size: 12px; width: 200px;">
                            <select id="moveHistoryFilter" onchange="filterMoveHistory()" style="padding: 8px 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; font-size: 12px;">
                                <option value="all">All Actions</option>
                                <option value="moved">Moved to Class</option>
                                <option value="pool">Returned to Pool</option>
                                <option value="dropped">Dropped</option>
                            </select>
                        </div>
                        
                        <!-- Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 10px; padding: 15px; text-align: center;">
                                <div id="moveHistoryTotal" style="font-size: 24px; font-weight: 700; color: #00ffff;">0</div>
                                <div style="font-size: 11px; color: #888;">Total Moves</div>
                            </div>
                            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 10px; padding: 15px; text-align: center;">
                                <div id="moveHistoryMoved" style="font-size: 24px; font-weight: 700; color: #39ff14;">0</div>
                                <div style="font-size: 11px; color: #888;">Class Transfers</div>
                            </div>
                            <div style="background: rgba(255,170,0,0.1); border: 2px solid #ffaa00; border-radius: 10px; padding: 15px; text-align: center;">
                                <div id="moveHistoryPool" style="font-size: 24px; font-weight: 700; color: #ffaa00;">0</div>
                                <div style="font-size: 11px; color: #888;">Returned to Pool</div>
                            </div>
                            <div style="background: rgba(255,51,102,0.1); border: 2px solid #ff3366; border-radius: 10px; padding: 15px; text-align: center;">
                                <div id="moveHistoryDropped" style="font-size: 24px; font-weight: 700; color: #ff3366;">0</div>
                                <div style="font-size: 11px; color: #888;">Dropped</div>
                            </div>
                        </div>
                        
                        <!-- History List -->
                        <div id="moveHistoryList" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: #888; font-size: 12px; text-align: center;">Click Refresh to load move history...</p>
                        </div>
                    </div>
                </div>

                <!-- Completed Tab -->
                <div id="adminTabCompleted" class="tab-content">
                    <div class="card">
                        <h3>ðŸŽ“ Completed Classes</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">View all completed classes and track 1-Year Academy enrollment status.</p>
                        
                        <!-- Date Filter -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; color: #888; margin-bottom: 5px; display: block;">Filter by completion date:</label>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('all')" data-days="all">All time</button>
                                <button class="btn btn-sm admin-completed-filter-btn active" onclick="filterAdminCompletedClasses('7')" data-days="7">Last 7 days</button>
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('14')" data-days="14">Last 14 days</button>
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('28')" data-days="28">Last 28 days</button>
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('90')" data-days="90">Last 3 months</button>
                                <button class="btn btn-sm admin-completed-filter-btn" onclick="filterAdminCompletedClasses('180')" data-days="180">Last 6 months</button>
                            </div>
                        </div>
                        
                        <!-- Completed Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #ff00ff;"><div class="summary-number" id="completedTotalCount" style="color: #ff00ff;">0</div><div class="summary-label">TOTAL STUDENTS</div></div>
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="completedJoinedCount" style="color: #39ff14;">0</div><div class="summary-label">JOINED (YES)</div></div>
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="completedNotInterestedCount" style="color: #ff3366;">0</div><div class="summary-label">DECLINED (NO)</div></div>
                            <div class="summary-box" style="border-color: #ffff00;"><div class="summary-number" id="completedPendingCount" style="color: #ffff00;">0</div><div class="summary-label">PENDING</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Yes - Joined Academy</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>No - Declined</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ffff00;"></div><span>Pending Decision</span></div>
                        </div>
                        
                        <!-- Completed Classes List -->
                        <div id="adminCompletedClassesContainer">
                            <p style="color: #888; font-size: 12px;">Loading completed classes...</p>
                        </div>
                    </div>
                </div>

                <div id="adminTabTeachers" class="tab-content">
                    <div class="grid-2">
                        <div class="card">
                            <h3>âž• Add New Teacher</h3>
                            <div id="addTeacherMessage"></div>
                            <div class="form-group"><label>Teacher Name</label><input type="text" id="newTeacherName" placeholder="Enter name"></div>
                            <div class="form-group"><label>Teacher Email</label><input type="email" id="newTeacherEmail" placeholder="Enter email"></div>
                            <div class="form-group"><label>Password</label><input type="password" id="newTeacherPassword" placeholder="Create password"></div>
                            <div class="form-group"><label>Available Days</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDaySat" checked> Saturday</label>
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDaySun" checked> Sunday</label>
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDayThu"> Thursday</label>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="addNewTeacher()">âž• Add Teacher</button>
                        </div>
                        <div class="card"><h3>ðŸ‘¨â€ðŸ« Teacher List</h3><div id="teachersListContainer"><p style="color: #888;">Loading...</p></div></div>
                    </div>
                </div>

                <div id="adminTabMaterials" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“– Teaching Materials</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Select Level</label>
                                <select id="materialLevelSelect" onchange="loadMaterialsForLevel()" data-level-select>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Select Week</label>
                                <select id="materialWeekSelect" onchange="loadMaterialsForLevel()">
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-sm btn-primary" onclick="addMaterialBlock('text')">ðŸ“ Text</button>
                            <button class="btn btn-sm btn-info" onclick="addMaterialBlock('link')">ðŸ”— Link</button>
                            <button class="btn btn-sm btn-success" onclick="addMaterialBlock('image')">ðŸ–¼ï¸ Image</button>
                            <button class="btn btn-sm btn-warning" onclick="addMaterialBlock('file')">ðŸ“ File</button>
                            <button class="btn btn-sm" style="background: linear-gradient(135deg, #9c27b0, #673ab7); border-color: #9c27b0; color: #fff;" onclick="addMaterialBlock('permutation-game')">ðŸŒŸ Yodafy Game</button>
                        </div>
                        <div id="materialsContainer"><p style="color: #888; font-size: 14px; font-family: 'Noto Sans', sans-serif;">No materials yet.</p></div>
                    </div>
                </div>

                <!-- Tuesday Reading Class Tab -->
                <div id="adminTabTuesdayreading" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“– Tuesday Reading Class</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Upload materials for Tuesday Reading Class. Select TEXT or IMAGE input. Up to 10 sets, each becomes a reading card.</p>

                        <!-- View Materials Button -->
                        <div style="margin-bottom: 18px;">
                            <button class="btn" onclick="openMaterialsCreator()" style="background: linear-gradient(135deg, #7c3aed, #a855f7); border: 2px solid #a855f7; color: #fff; font-size: 14px; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.25s; box-shadow: 0 0 15px rgba(168,85,247,0.3);" onmouseover="this.style.transform='scale(1.04)';this.style.boxShadow='0 0 25px rgba(168,85,247,0.5)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 0 15px rgba(168,85,247,0.3)'">ðŸ“‘ View Materials</button>
                        </div>

                        <!-- Input Mode Toggle -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                            <button class="btn btn-sm tr-input-mode-btn tr-mode-active" id="trModeTextBtn" onclick="setTRInputMode('text')">ðŸ“ TEXT Input</button>
                            <button class="btn btn-sm tr-input-mode-btn" id="trModeImageBtn" onclick="setTRInputMode('image')">ðŸ–¼ï¸ IMAGE Input</button>
                        </div>

                        <!-- Sets Container -->
                        <div id="trSetsContainer">
                            <p style="color: #888; font-size: 13px;">No sets added yet. Click "âž• Add Set" to begin.</p>
                        </div>

                        <!-- Add Set Button -->
                        <div style="margin: 15px 0;">
                            <button class="btn btn-success" onclick="addTRSet()" id="trAddSetBtn">âž• Add Set (<span id="trSetCount">0</span>/10)</button>
                        </div>

                        <!-- Generate Cards -->
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <button class="btn" onclick="generateTRCards()" style="background: linear-gradient(135deg, #ff00ff, #9c27b0); border-color: #ff00ff; color: #fff; font-weight: 600;">ðŸƒ Generate Reading Cards</button>
                            <button class="btn btn-sm" onclick="clearAllTR()" style="background: #333; color: #ff3366; border-color: #ff3366;">ðŸ—‘ï¸ Clear All</button>
                        </div>

                        <!-- AI Processing Indicator -->
                        <div id="trAIProcessing" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,0,255,0.1); border: 1px solid #ff00ff; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #ff00ff;">â³ Generating English translations via AI...</div>
                            <div style="font-size: 11px; color: #888; margin-top: 5px;">This may take a moment</div>
                        </div>
                    </div>

                </div>

                <!-- Materials Creation Window Overlay -->
                <div class="mat-overlay" id="materialsOverlay">
                    <div class="mat-container">
                        <div class="mat-header">
                            <h2>ðŸ“‘ Materials Creator</h2>
                            <button class="mat-close-btn" onclick="closeMaterialsCreator()">âœ•</button>
                        </div>
                        <div class="mat-panels">
                            <div class="mat-input-panel">
                                <h3>ðŸ“ Korean Text Input</h3>
                                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">Enter Korean sentences â€” 2 to 3 per slide. Separate slides with a blank line.</p>
                                <textarea id="matTextInput" placeholder="ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ì•„ìš”.&#10;ì €ëŠ” í•œêµ­ì–´ë¥¼ ê³µë¶€í•©ë‹ˆë‹¤.&#10;ë‚´ì¼ í•™êµì— ê°ˆ ê±°ì˜ˆìš”.&#10;&#10;í•œêµ­ì€ ì•„ë¦„ë‹¤ìš´ ë‚˜ë¼ìž…ë‹ˆë‹¤.&#10;ì„œìš¸ì€ í° ë„ì‹œìž…ë‹ˆë‹¤.&#10;í•œê°•ì´ ì„œìš¸ì„ ì§€ë‚˜ê°‘ë‹ˆë‹¤."></textarea>
                                <p style="font-size: 10px; color: #555; margin-top: 5px;">Slides detected: <span id="matSlideCount" style="color: #00ffff;">0</span> <span style="color:#444;">(separate slides with a blank line)</span></p>
                                <div class="mat-font-size-row">
                                    <label>Font Size</label>
                                    <input type="range" id="matFontSize" min="16" max="60" value="30" oninput="document.getElementById('matFontSizeVal').textContent=this.value+'px'; matRegenerateSlides();">
                                    <span id="matFontSizeVal">30px</span>
                                </div>
                                <div class="mat-generate-row">
                                    <button class="mat-btn-generate" onclick="matGenerateSlides()">ðŸŽ¬ Generate Slideshow</button>
                                </div>
                            </div>
                            <div class="mat-preview-panel">
                                <div class="mat-preview-header">
                                    <h3>ðŸŽ¬ Slideshow Preview</h3>
                                    <div class="mat-export-btns" id="matExportBtns" style="display: none;">
                                        <button class="mat-btn-export mat-btn-pdf" onclick="matExportPDF()">ðŸ“„ Export PDF</button>
                                        <button class="mat-btn-export mat-btn-html" onclick="matExportHTML()">ðŸŒ Export HTML</button>
                                    </div>
                                </div>
                                <div id="matSlideshowArea" style="cursor: pointer;" title="Click to expand">
                                    <div class="mat-empty-preview"><span>ðŸ“‘</span><p>Enter Korean text and click Generate to preview slides</p></div>
                                </div>
                                <p id="matExpandHint" style="display:none; text-align:center; font-size:11px; color:#666; margin-top:6px;">ðŸ” Click the preview to expand and interact with words</p>
                                <div id="matPrefetchStatus" style="display:none; margin-top:8px; text-align:center;">
                                    <div style="display:inline-flex; align-items:center; gap:8px; background:rgba(0,200,255,0.1); border:1px solid rgba(0,200,255,0.3); border-radius:20px; padding:6px 16px;">
                                        <div id="matPrefetchSpinner" style="width:14px;height:14px;border:2px solid rgba(0,200,255,0.3);border-top-color:#00ccff;border-radius:50%;animation:matSpin 0.8s linear infinite;"></div>
                                        <span id="matPrefetchText" style="font-size:11px;color:#00ccff;">Loading word data...</span>
                                        <span id="matPrefetchCount" style="font-size:11px;color:#888;">0 / 0</span>
                                    </div>
                                    <div style="margin-top:4px;width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                                        <div id="matPrefetchBar" style="width:0%;height:100%;background:linear-gradient(90deg,#00ccff,#ff00ff);border-radius:2px;transition:width 0.3s ease;"></div>
                                    </div>
                                </div>
                                <style>@keyframes matSpin{to{transform:rotate(360deg)}}</style>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expanded Slide Preview -->
                <div class="mat-expanded-overlay" id="matExpandedOverlay">
                    <button class="mat-expanded-close" onclick="matCloseExpanded()">âœ•</button>
                    <div class="mat-expanded-slide-wrap" id="matExpandedSlideWrap"></div>
                    <div class="mat-expanded-nav">
                        <button onclick="matExpandedPrev()" id="matExpPrevBtn">â—€ Prev</button>
                        <span id="matExpIndicator">1 / 1</span>
                        <button onclick="matExpandedNext()" id="matExpNextBtn">Next â–¶</button>
                    </div>
                    <div class="mat-expanded-hint">Click a word to hear it Â· Hover for translation</div>
                </div>

                <div id="adminTabSuggestions" class="tab-content">
                    <div class="card">
                        <h3>ðŸ’¡ Teacher Suggestions</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Review and respond to suggestions from teachers.</p>
                        <div id="adminSuggestionsContainer"><p style="color: #888; font-size: 12px;">No suggestions yet.</p></div>
                    </div>
                </div>

                <!-- Ready Tab -->
                <div id="adminTabReady" class="tab-content">
                    <div class="card">
                        <h3>âœ… Ready for Account</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Students who have completed Lesson 3 and requested their account. Check off students after creating their account.</p>
                        
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="loadReadyRequests()">ðŸ”„ Refresh Requests</button>
                        </div>
                        
                        <!-- Dashboard Stats -->
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                            <div style="background: rgba(0,255,255,0.2); border: 2px solid #00ffff; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #00ffff; font-weight: bold;" id="statTotalReady">0</div>
                                <div style="font-size: 11px; color: #888;">TOTAL REQUESTS</div>
                            </div>
                            <div style="background: rgba(255,152,0,0.2); border: 2px solid #ff9800; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #ff9800; font-weight: bold;" id="statPendingReady">0</div>
                                <div style="font-size: 11px; color: #888;">PENDING</div>
                            </div>
                            <div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #39ff14; font-weight: bold;" id="statCompletedReady">0</div>
                                <div style="font-size: 11px; color: #888;">COMPLETED</div>
                            </div>
                        </div>
                        
                        <!-- Filter -->
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <input type="text" id="readySearch" placeholder="ðŸ” Search by name or email..." oninput="filterReadyRequests()" style="width: 100%;">
                                </div>
                                <div>
                                    <select id="readyFilter" onchange="filterReadyRequests()">
                                        <option value="all">All Requests</option>
                                        <option value="pending">Pending Only</option>
                                        <option value="completed">Completed Only</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ready List -->
                        <div id="readyRequestsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">
                            <p style="color: #888; font-size: 12px;">Click "Refresh Requests" to load student requests...</p>
                        </div>
                    </div>
                </div>

                <!-- Slot Manager Tab -->
                <div id="adminTabSlotmanager" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“… Class Slot Manager</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">View slot availability, generate student materials, and create Shopify listings.</p>
                        
                        <!-- Controls -->
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: center;">
                            <div>
                                <label style="font-size: 12px; color: #888;">Select Teacher:</label>
                                <select id="slotManagerTeacher" onchange="renderSlotGrid()" style="margin-left: 5px;">
                                    <option value="">-- All Teachers --</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #888;">View:</label>
                                <select id="slotManagerView" onchange="renderSlotGrid()" style="margin-left: 5px;">
                                    <option value="4">Next 4 Weeks</option>
                                    <option value="8" selected>Next 8 Weeks</option>
                                    <option value="12">Next 12 Weeks</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 12px;">
                            <span><span style="display: inline-block; width: 15px; height: 15px; background: #39ff14; border-radius: 3px; vertical-align: middle;"></span> Available</span>
                            <span><span style="display: inline-block; width: 15px; height: 15px; background: #ffff00; border-radius: 3px; vertical-align: middle;"></span> Ending Soon (Weeks 5-6)</span>
                            <span><span style="display: inline-block; width: 15px; height: 15px; background: #ff3366; border-radius: 3px; vertical-align: middle;"></span> Mid-Session</span>
                            <span><span style="display: inline-block; width: 15px; height: 15px; background: #888; border-radius: 3px; vertical-align: middle;"></span> No Teacher Available</span>
                        </div>
                        
                        <!-- Slot Grid -->
                        <div id="slotGridContainer" style="margin-bottom: 30px;">
                            <p style="color: #888; font-size: 12px;">Loading slot availability...</p>
                        </div>
                        
                        <!-- Forecast Section -->
                        <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #00ffff; margin-bottom: 10px;">ðŸ“Š Upcoming Availability Forecast</h4>
                            <div id="slotForecast" style="font-size: 13px;">
                                <p style="color: #888;">Loading forecast...</p>
                            </div>
                        </div>
                        
                        <!-- Teacher Workload -->
                        <div style="background: rgba(255,0,255,0.1); border: 2px solid #ff00ff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #ff00ff; margin-bottom: 10px;">ðŸ‘¨â€ðŸ« Teacher Workload</h4>
                            <div id="teacherWorkload" style="font-size: 13px;">
                                <p style="color: #888;">Loading workload...</p>
                            </div>
                        </div>
                        
                        <!-- Analytics Section -->
                        <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px; padding: 15px;">
                            <h4 style="color: #39ff14; margin-bottom: 10px;">ðŸ“ˆ Slot Analytics (Based on Attendance)</h4>
                            <div id="slotAnalytics" style="font-size: 13px;">
                                <p style="color: #888;">Loading analytics...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Class Templates Section -->
                    <div class="card" style="margin-top: 20px;">
                        <h3>ðŸ“„ Class Templates</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Pre-load video links, preparation instructions, and images for each class type. These will be used when generating materials and sending emails to students.</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <div class="form-group">
                                    <label>Class Type *</label>
                                    <select id="templateClassType" data-level-select onchange="loadClassTemplate()">
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Class Link (Zoom/Google Meet) *</label>
                                    <input type="text" id="templateClassLink" placeholder="https://zoom.us/j/...">
                                </div>
                                <div class="form-group">
                                    <label>Preparation Instructions for Students</label>
                                    <textarea id="templatePreparation" rows="6" placeholder="What students should do before class..."></textarea>
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label>Upload Images (optional)</label>
                                    <input type="file" id="templateImages" multiple accept="image/*" onchange="handleTemplateImageUpload(event)">
                                    <div id="templateImagePreview" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; min-height: 100px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
                                        <p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>
                                    </div>
                                </div>
                                <div style="background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 8px; padding: 10px; margin-top: 10px;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 5px;">Template Status:</div>
                                    <div id="templateStatus" style="color: #ffff00; font-size: 12px;">No template loaded</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" onclick="saveClassTemplate()">ðŸ’¾ Save Template</button>
                            <button class="btn btn-info" onclick="previewClassTemplate()">ðŸ‘ï¸ Preview</button>
                            <button class="btn btn-danger" onclick="deleteClassTemplate()" style="margin-left: auto;">ðŸ—‘ï¸ Delete Template</button>
                        </div>
                    </div>
                </div>

                <!-- Account Creation Tab -->
                <div id="adminTabAccounts" class="tab-content">
                    <div class="card">
                        <h3>ðŸ‘¤ Account Creation</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Create Firebase accounts for Shopify customers. Customers need accounts to log in and access their materials.</p>
                        
                        <!-- Initial Load Controls -->
                        <div id="accountLoadControls" style="margin-bottom: 15px; padding: 15px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px;">
                            <p style="font-size: 13px; color: #00ffff; margin-bottom: 10px;">âš¡ Select a date range to load customers faster:</p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <select id="accountLoadRange" style="padding: 8px 12px;">
                                    <option value="7">Last 7 Days</option>
                                    <option value="14" selected>Last 14 Days</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                    <option value="all">All Time (Slow)</option>
                                </select>
                                <button class="btn btn-success" onclick="loadShopifyCustomersForAccounts()">ðŸ“¥ Load Customers</button>
                                <span id="accountCacheStatus" style="font-size: 12px; color: #888;"></span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="refreshShopifyCustomersForAccounts()" id="accountRefreshBtn" style="display: none;">ðŸ”„ Refresh</button>
                            <span id="accountLastLoaded" style="font-size: 12px; color: #888; align-self: center;"></span>
                        </div>
                        
                        <!-- Dashboard Stats -->
                        <div id="accountCreationDashboard" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                            <div style="background: rgba(0,255,255,0.2); border: 2px solid #00ffff; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #00ffff; font-weight: bold;" id="statTotalCustomers">0</div>
                                <div style="font-size: 11px; color: #888;">TOTAL CUSTOMERS</div>
                            </div>
                            <div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #39ff14; font-weight: bold;" id="statWithAccount">0</div>
                                <div style="font-size: 11px; color: #888;">WITH ACCOUNT</div>
                            </div>
                            <div style="background: rgba(255,152,0,0.2); border: 2px solid #ff9800; padding: 15px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                                <div style="font-size: 20px; color: #ff9800; font-weight: bold;" id="statWithoutAccount">0</div>
                                <div style="font-size: 11px; color: #888;">WITHOUT ACCOUNT</div>
                            </div>
                        </div>
                        
                        <!-- Filters -->
                        <div id="accountControls" style="display: none; margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <input type="text" id="accountSearch" placeholder="ðŸ” Search by name or email..." oninput="filterShopifyCustomersForAccounts()" style="width: 100%;">
                                </div>
                                <div>
                                    <select id="accountFilter" onchange="filterShopifyCustomersForAccounts()">
                                        <option value="all">All Customers</option>
                                        <option value="no-account">Without Account</option>
                                        <option value="has-account">With Account</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="accountStatusFilter" onchange="filterShopifyCustomersForAccounts()">
                                        <option value="all">All Statuses</option>
                                        <option value="active">Active</option>
                                        <option value="paused">Paused</option>
                                        <option value="failed">Failed Payment</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="accountTagFilter" onchange="filterShopifyCustomersForAccounts()">
                                        <option value="all">All Tags</option>
                                        <option value="PRONUNCIATION">Pronunciation</option>
                                        <option value="KPOP">Kpop</option>
                                        <option value="KDRAMA">Kdrama</option>
                                        <option value="SURVIVAL">Survival Phrase</option>
                                        <option value="VOCABULARY">Vocabulary</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="accountDateFilter" onchange="filterShopifyCustomersForAccounts()">
                                        <option value="all">All Time</option>
                                        <option value="7">Last 7 Days</option>
                                        <option value="14">Last 14 Days</option>
                                        <option value="30">Last 30 Days</option>
                                        <option value="90">Last 3 Months</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="accountPerPage" onchange="changeAccountPerPage()">
                                        <option value="10">10 per page</option>
                                        <option value="25" selected>25 per page</option>
                                        <option value="50">50 per page</option>
                                        <option value="100">100 per page</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customers List -->
                        <div id="accountCustomersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                            <p style="color: #888; font-size: 12px;">Click "Refresh Customers" to load Shopify customers...</p>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="accountPagination" style="display: none; margin-top: 20px; text-align: center;">
                            <button class="btn btn-info btn-sm" id="accountPrevBtn" onclick="accountPrevPage()">â—€ Prev</button>
                            <span id="accountPageInfo" style="margin: 0 15px; font-size: 13px;"></span>
                            <button class="btn btn-info btn-sm" id="accountNextBtn" onclick="accountNextPage()">Next â–¶</button>
                        </div>
                    </div>
                </div>

                <div id="adminTabSettings" class="tab-content">
                    <div class="card">
                        <h3>âš™ï¸ Class Generation Settings</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 20px;">These settings control how classes are generated in the ðŸ“‹ Students section.</p>
                        <div id="settingsMessage"></div>
                        <div class="settings-row">
                            <span class="settings-label">Min Students/Class:</span>
                            <input type="number" class="settings-input" id="settingMinStudents" value="5" min="1" max="20">
                            <span style="font-size: 11px; color: #888; margin-left: 10px;">Minimum students needed to form a class</span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Max Students/Class:</span>
                            <input type="number" class="settings-input" id="settingMaxStudents" value="10" min="1" max="20">
                            <span style="font-size: 11px; color: #888; margin-left: 10px;">Maximum students allowed per class</span>
                        </div>
                        <button class="btn btn-success" onclick="saveSettings()">ðŸ’¾ Save Settings</button>
                        
                        <!-- Current Settings Display -->
                        <div style="margin-top: 20px; padding: 15px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px;">
                            <h4 style="color: #00ffff; font-size: 12px; margin-bottom: 10px;">ðŸ“Š Current Settings</h4>
                            <p style="font-size: 12px; color: #fff; margin: 5px 0;">â€¢ Classes need at least <strong id="displayMinStudents" style="color: #39ff14;">5</strong> students to be generated</p>
                            <p style="font-size: 12px; color: #fff; margin: 5px 0;">â€¢ Classes can have up to <strong id="displayMaxStudents" style="color: #39ff14;">10</strong> students maximum</p>
                        </div>
                    </div>
                    
                    <!-- Hidden fields to maintain compatibility -->
                    <input type="hidden" id="settingCurrentWeek" value="1">
                    <input type="hidden" id="settingStartDate" value="">
                    <div id="courseCalendarPreview" style="display: none;"><div id="courseCalendarGrid"></div></div>
                    
                    <!-- Database Cleanup Section -->
                    <div class="card" style="margin-top: 20px; border-color: #ff3366;">
                        <h3 style="color: #ff3366;">ðŸ§¹ Database Cleanup</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Remove orphan records and fix inconsistent data.</p>
                        <div id="cleanupMessage"></div>
                        <div id="cleanupPreview" style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; display: none;">
                            <p style="font-size: 12px; color: #ffff00; margin-bottom: 10px;">ðŸ“‹ Issues Found:</p>
                            <div id="cleanupIssuesList"></div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="scanForIssues()">ðŸ” Scan for Issues</button>
                            <button class="btn btn-warning" onclick="cleanOrphanRecords()" id="cleanOrphansBtn" disabled>ðŸ§¹ Clean Orphan Records</button>
                            <button class="btn btn-danger admin-delete-btn" onclick="resetAllData()" id="resetAllDataBtn">âš ï¸ Reset ALL Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teacher Dashboard -->
            <div id="teacherDashboard" style="display: none;">
                <div class="nav-tabs">
                    <button class="nav-tab" onclick="showTeacherTab('today')">ðŸ“… Today</button>
                    <button class="nav-tab active" onclick="showTeacherTab('myClasses')">ðŸ“š My Classes</button>
                    <button class="nav-tab" onclick="showTeacherTab('calendar')">ðŸ—“ï¸ Calendar</button>
                    <button class="nav-tab" onclick="showTeacherTab('schedule')">ðŸ“… Schedule</button>
                    <button class="nav-tab" onclick="showTeacherTab('attendance')">ðŸ“Š Attendance</button>
                    <button class="nav-tab" onclick="showTeacherTab('completed')">âœ… Completed</button>
                    <button class="nav-tab" onclick="showTeacherTab('materials')">ðŸ“– Materials</button>
                    <button class="nav-tab" onclick="showTeacherTab('suggestions')">ðŸ’¡ Suggestions</button>
                </div>
                
                <!-- Today Tab -->
                <div id="teacherTabToday" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“… Today's Classes</h3>
                        <div id="todayClassesContainer"><p style="color: #888;">Loading...</p></div>
                    </div>
                </div>
                
                <!-- My Classes Tab -->
                <div id="teacherTabMyClasses" class="tab-content active">
                    <div class="card">
                        <h3>ðŸ“š My Classes</h3>
                        <div id="teacherClassesContainer"><p style="color: #888;">Loading...</p></div>
                    </div>
                </div>
                
                <!-- Teacher Calendar Tab -->
                <div id="teacherTabCalendar" class="tab-content">
                    <div class="card">
                        <h3>ðŸ—“ï¸ Monthly Calendar</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <button class="btn btn-info" onclick="changeCalendarMonth(-1)">â—€ Prev</button>
                            <span id="teacherCalendarMonthLabel" style="font-size: 12px; color: #00ffff;"></span>
                            <button class="btn btn-info" onclick="changeCalendarMonth(1)">Next â–¶</button>
                        </div>
                        <div class="monthly-calendar" id="teacherMonthlyCalendarGrid"></div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-top: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Class Day</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #00ffff;"></div><span>Today</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff00ff;"></div><span>Course Start/End</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Teacher Schedule Tab -->
                <div id="teacherTabSchedule" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“… My Weekly Schedule</h3>
                        
                        <!-- Summary Stats for Teacher -->
                        <div class="schedule-summary" id="teacherScheduleSummary">
                            <div class="summary-box active"><div class="summary-number" id="teacherTotalClasses">0</div><div class="summary-label">MY CLASSES</div></div>
                            <div class="summary-box cyan"><div class="summary-number" id="teacherTotalStudents">0</div><div class="summary-label">TOTAL STUDENTS</div></div>
                            <div class="summary-box full"><div class="summary-number" id="teacherFullClasses">0</div><div class="summary-label">FULL CLASSES</div></div>
                            <div class="summary-box available"><div class="summary-number" id="teacherAvailableSpots">0</div><div class="summary-label">SPOTS AVAILABLE</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend">
                            <div class="legend-item"><div class="legend-bar active"></div><span>My Class</span></div>
                            <div class="legend-item"><div class="legend-bar full"></div><span>Full</span></div>
                            <div class="legend-item"><div class="legend-bar empty"></div><span>Not Assigned</span></div>
                        </div>
                        
                        <!-- Schedule Grid -->
                        <div class="schedule-grid" id="teacherScheduleGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <div id="teacherTabAttendance" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“Š Attendance History</h3>
                        <div class="form-group"><label>Select Class</label><select id="attendanceClassSelect" onchange="loadAttendanceHistory()"><option value="">-- Select --</option></select></div>
                        <div style="overflow-x: auto;"><table><thead><tr><th>Student</th><th>W1</th><th>W2</th><th>W3</th><th>W4</th><th>W5</th><th>W6</th></tr></thead><tbody id="attendanceHistoryBody"><tr><td colspan="7" style="text-align: center; color: #888;">Select a class</td></tr></tbody></table></div>
                    </div>
                </div>
                
                <!-- Completed Classes Tab -->
                <div id="teacherTabCompleted" class="tab-content">
                    <div class="card">
                        <h3>âœ… Completed Classes</h3>
                        <p style="color: #888; font-size: 12px; margin-bottom: 15px;">Track 1-Year Academy enrollment for graduated students</p>
                        
                        <!-- Date Filter -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; color: #888; margin-bottom: 5px; display: block;">Filter by completion date:</label>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-sm completed-filter-btn active" onclick="filterCompletedClasses('7')" data-days="7">Last 7 days</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('14')" data-days="14">Last 14 days</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('28')" data-days="28">Last 28 days</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('90')" data-days="90">Last 3 months</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('180')" data-days="180">Last 6 months</button>
                                <button class="btn btn-sm completed-filter-btn" onclick="filterCompletedClasses('all')" data-days="all">All time</button>
                            </div>
                        </div>
                        
                        <div id="teacherCompletedClassesContainer"><p style="color: #888; font-size: 12px;">No completed classes yet.</p></div>
                    </div>
                </div>
                
                <div id="teacherTabMaterials" class="tab-content">
                    <div class="card">
                        <h3>ðŸ“– Teaching Materials</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Select Level</label>
                                <select id="teacherMaterialLevel" onchange="loadTeacherMaterials()" data-level-select>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Select Week</label>
                                <select id="teacherMaterialWeek" onchange="loadTeacherMaterials()">
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                </select>
                            </div>
                        </div>
                        <div id="teacherMaterialsDisplay"><p style="color: #888; font-size: 14px; font-family: 'Noto Sans', sans-serif;">Select a level and week to view materials.</p></div>
                    </div>
                </div>
                
                <div id="teacherTabSuggestions" class="tab-content">
                    <div class="card">
                        <h3>ðŸ’¡ Submit a Suggestion</h3>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Share your ideas to help improve our classes and system.</p>
                        <div id="suggestionFormMessage"></div>
                        <div class="form-group">
                            <label>Suggestion Title</label>
                            <input type="text" id="suggestionTitle" placeholder="Brief title for your suggestion">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="suggestionDescription" rows="4" placeholder="Describe your suggestion in detail..." style="width: 100%; font-family: 'Noto Sans', sans-serif; font-size: 12px; padding: 10px; background: #1a1a2e; color: #fff; border: 2px solid #333; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Priority Level</label>
                            <div style="display: flex; gap: 10px; margin-top: 8px;">
                                <button type="button" class="priority-btn" id="priorityHigh" onclick="selectPriority('high')">ðŸ”´ High</button>
                                <button type="button" class="priority-btn" id="priorityMid" onclick="selectPriority('mid')">ðŸŸ¡ Mid</button>
                                <button type="button" class="priority-btn" id="priorityLow" onclick="selectPriority('low')">ðŸŸ¢ Low</button>
                            </div>
                            <input type="hidden" id="suggestionPriority" value="">
                        </div>
                        <button class="btn btn-success" onclick="submitSuggestion()">ðŸ“¤ Submit Suggestion</button>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3>ðŸ“‹ My Previous Suggestions</h3>
                        <div id="teacherSuggestionsContainer"><p style="color: #888; font-size: 12px;">No suggestions submitted yet.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Level Modal -->
    <div class="modal-overlay" id="levelModal">
        <div class="modal">
            <button class="modal-close" onclick="closeLevelModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“ Assign Class</h3>
            <p style="font-size: 13px; margin-bottom: 15px;">Student: <span id="modalStudentName" style="color: #00ffff;"></span></p>
            <div id="levelModalMessage"></div>
            <div class="form-group"><label>Select Class</label>
                <select id="levelSelect" data-level-select><!-- Populated dynamically --></select>
            </div>
            <input type="hidden" id="modalStudentId">
            <button class="btn btn-success" onclick="assignStudentLevel()">âœ“ Assign</button>
        </div>
    </div>

    <!-- Material Modal -->
    <div class="modal-overlay" id="materialModal">
        <div class="modal">
            <button class="modal-close" onclick="closeMaterialModal()">âœ•</button>
            <h3 class="modal-title" id="materialModalTitle">Add Material</h3>
            <div id="materialModalMessage"></div>
            <div id="materialFormContainer"></div>
            <input type="hidden" id="editingMaterialId">
            <input type="hidden" id="editingMaterialType">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveMaterial()">ðŸ’¾ Save</button>
                <button class="btn btn-info" id="testYodafyBtn" onclick="testYodafyFromMaterial()" style="display: none;">ðŸ§ª Test</button>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div class="modal-overlay" id="warningModal">
        <div class="modal">
            <button class="modal-close" onclick="closeWarningModal()">âœ•</button>
            <h3 class="modal-title" style="color: #ffff00;">âš ï¸ Warning</h3>
            <p id="warningMessage" style="font-size: 13px; margin-bottom: 20px;"></p>
            <button class="btn btn-success" onclick="confirmWarningAction()">Proceed</button>
            <button class="btn btn-secondary" onclick="closeWarningModal()">Cancel</button>
        </div>
    </div>

    <!-- Absence Reason Modal -->
    <div class="modal-overlay" id="absenceModal">
        <div class="modal">
            <button class="modal-close" onclick="closeAbsenceModal()">âœ•</button>
            <h3 class="modal-title" style="color: #ff3366;">ðŸ“ Absence Reason</h3>
            <p style="font-size: 13px; margin-bottom: 15px;">Student: <span id="absenceStudentName" style="color: #00ffff;"></span></p>
            <p style="font-size: 13px; margin-bottom: 20px;">Did the student give a reason for their absence?</p>
            <input type="hidden" id="absenceClassId">
            <input type="hidden" id="absenceStudentId">
            <div id="absenceReasonForm" style="display: none; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Reason for Absence</label>
                    <textarea id="absenceReasonText" rows="3" placeholder="Enter the reason..."></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="showAbsenceReasonForm()">âœ“ Yes, has reason</button>
                <button class="btn btn-danger" onclick="markAbsentNoReason()">âœ— No reason given</button>
            </div>
            <div id="absenceSubmitBtn" style="display: none; margin-top: 15px;">
                <button class="btn btn-primary" onclick="submitAbsenceWithReason()">ðŸ’¾ Save Absence with Reason</button>
            </div>
        </div>
    </div>

    <!-- Edit Start Date Modal -->
    <div class="modal-overlay" id="editStartDateModal">
        <div class="modal" style="max-width: 400px;">
            <button class="modal-close" onclick="closeEditStartDateModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“… Edit Class Start Date</h3>
            <div id="editStartDateClassInfo" style="margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;"></div>
            <input type="hidden" id="editStartDateClassId">
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="editStartDateInput" style="width: 100%;">
            </div>
            <div id="editStartDateMessage" style="margin-bottom: 15px;"></div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveClassStartDate()" style="flex: 1;">ðŸ’¾ Save</button>
                <button class="btn btn-secondary" onclick="closeEditStartDateModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Class Details Modal -->
    <div class="modal-overlay" id="classDetailsModal">
        <div class="modal" style="max-width: 700px;">
            <button class="modal-close" onclick="closeClassDetailsModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“š Class Details</h3>
            <div id="classDetailsHeader" style="margin-bottom: 20px;"></div>
            <div id="classDetailsMessage"></div>
            <h4 style="color: #ffff00; font-size: 14px; margin-bottom: 15px;">ðŸ‘¥ Students in this Class</h4>
            <div id="classStudentsList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Course Start Date Modal -->
    <div class="modal-overlay" id="startDateModal">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="cancelStartDateModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“… Preview & Set Class Start Dates</h3>
            <p style="font-size: 13px; margin-bottom: 15px; color: #888;">Select a teacher first (their availability will be considered), then review class groupings.</p>
            
            <!-- Teacher Selection -->
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px;">
                <h4 style="color: #00ffff; font-size: 14px; margin-bottom: 10px;">ðŸ‘¨â€ðŸ« Select Teacher for Auto-Generation</h4>
                <p style="font-size: 11px; color: #888; margin-bottom: 10px;">Classes will only be generated for times when this teacher is available.</p>
                <div id="teacherSelectionButtons" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <!-- Teacher buttons will be inserted here -->
                </div>
                <div id="selectedTeacherInfo" style="display: none; margin-top: 10px; padding: 10px; background: rgba(57,255,20,0.1); border-radius: 5px;">
                    <span style="color: #39ff14; font-size: 12px;">âœ“ Selected: <strong id="selectedTeacherName"></strong></span>
                    <span id="selectedTeacherDays" style="color: #888; font-size: 11px; margin-left: 10px;"></span>
                </div>
            </div>
            
            <div id="classPreviewContainer" style="margin-bottom: 20px;">
                <p style="color: #888; font-size: 12px;">Select a teacher above to generate class previews...</p>
            </div>
            
            <div id="limboPreviewContainer" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(255,51,102,0.1); border: 2px solid #ff3366; border-radius: 8px;">
                <h4 style="color: #ff3366; font-size: 14px; margin-bottom: 10px;">âš ï¸ Students Without Enough Classmates (Limbo)</h4>
                <p style="font-size: 11px; color: #888; margin-bottom: 10px;">These students don't have enough classmates with matching availability. They will be marked as "limbo".</p>
                <div id="limboStudentsList"></div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; padding-top: 15px; border-top: 2px solid #333;">
                <button class="btn btn-success" onclick="confirmAutoGenerate()" id="generateProposalsBtn" disabled>âœ“ Generate Proposals</button>
                <button class="btn btn-secondary" onclick="cancelStartDateModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Move Student Modal -->
    <div class="modal-overlay" id="moveStudentModal">
        <div class="modal" style="max-width: 600px;">
            <button class="modal-close" onclick="closeMoveStudentModal()">âœ•</button>
            <h3 class="modal-title">ðŸ”„ Move Student</h3>
            <p style="font-size: 13px; margin-bottom: 15px;">Student: <span id="moveStudentName" style="color: #00ffff;"></span></p>
            <input type="hidden" id="moveStudentId">
            <input type="hidden" id="moveFromClassId">
            <div style="margin-bottom: 15px;">
                <label class="checkbox-label">
                    <input type="checkbox" id="returnToPoolCheckbox" onchange="toggleMoveOptions()">
                    <span style="font-size: 12px;">Return to student pool (schedule changed, needs reassignment)</span>
                </label>
            </div>
            <div id="moveToClassSection">
                <h4 style="color: #ffff00; font-size: 14px; margin-bottom: 10px;">Select destination class:</h4>
                <div id="moveClassOptions" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="confirmMoveStudent()">âœ“ Confirm Move</button>
                <button class="btn btn-secondary" onclick="closeMoveStudentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal-overlay" id="studentDetailsModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeStudentDetailsModal()">âœ•</button>
            <h3 class="modal-title">ðŸ‘¤ Student Details</h3>
            <div id="studentDetailsContent" style="padding: 15px 0;">
                <p style="color: #888; font-size: 12px;">Loading...</p>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeStudentDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Student Analytics Menu Popup -->
    <div class="modal-overlay" id="studentAnalyticsMenuModal">
        <div class="modal" style="max-width: 400px;">
            <button class="modal-close" onclick="closeStudentAnalyticsMenu()">âœ•</button>
            <h3 class="modal-title">ðŸ“Š <span id="analyticsStudentName">Student</span> Analytics</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 20px; text-align: center;">Select an analytics category to view</p>
            <div style="display: grid; gap: 12px;">
                <button class="btn" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 14px;" onclick="openAnalyticsDatePicker('pronunciation')">
                    ðŸŽ¤ Pronunciation Analytics
                </button>
                <button class="btn" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); font-size: 14px;" onclick="openAnalyticsDatePicker('grammar')">
                    ðŸ“– Grammar Analytics
                </button>
                <button class="btn" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); font-size: 14px;" onclick="openAnalyticsDatePicker('vocabulary')">
                    ðŸ“š Vocabulary Analytics
                </button>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn btn-info" id="backToStudentLookupBtn" onclick="backToStudentLookup()" style="display: none;">â† Back to List</button>
                <button class="btn btn-secondary" onclick="closeStudentAnalyticsMenu()">Close</button>
            </div>
        </div>
    </div>

    <!-- Analytics Date Picker Modal -->
    <div class="modal-overlay" id="analyticsDatePickerModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeAnalyticsDatePicker()">âœ•</button>
            <h3 class="modal-title" id="analyticsDatePickerTitle">ðŸ“Š Select Date</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px; text-align: center;">Select a date to view analytics</p>
            <div id="analyticsDatesList" style="max-height: 400px; overflow-y: auto;">
                <p style="color: #888; font-size: 12px; text-align: center;">Loading dates...</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAnalyticsDatePicker()">Back</button>
            </div>
        </div>
    </div>

    <!-- Analytics Display Modal -->
    <div class="modal-overlay" id="analyticsDisplayModal">
        <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeAnalyticsDisplay()">âœ•</button>
            <h3 class="modal-title" id="analyticsDisplayTitle">ðŸ“Š Analytics</h3>
            <div id="analyticsDisplayContent" style="padding: 15px 0;">
                <p style="color: #888; font-size: 12px; text-align: center;">Loading analytics...</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn btn-info" id="backToStudentLookupFromDisplayBtn" onclick="backToStudentLookup()" style="display: none;">â† Back to Student List</button>
                <button class="btn btn-secondary" onclick="closeAnalyticsDisplay()">Close</button>
            </div>
        </div>
    </div>

    <!-- ==================== STUDENT LOOKUP MODAL ==================== -->
    <div class="modal-overlay" id="studentLookupModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeStudentLookupModal()">âœ•</button>
            <h3 class="modal-title">ðŸ” Student Lookup</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Search all students with KoreanLearnin accounts. Click a student to view their analytics.</p>
            
            <div class="student-lookup-stats" id="studentLookupStats">
                <div class="student-lookup-stat">
                    <div class="student-lookup-stat-number" id="studentLookupTotalCount">0</div>
                    <div class="student-lookup-stat-label">Total Students</div>
                </div>
                <div class="student-lookup-stat">
                    <div class="student-lookup-stat-number" id="studentLookupUsersCount">0</div>
                    <div class="student-lookup-stat-label">From Accounts</div>
                </div>
                <div class="student-lookup-stat">
                    <div class="student-lookup-stat-number" id="studentLookupSchedulerCount">0</div>
                    <div class="student-lookup-stat-label">In Classes</div>
                </div>
            </div>
            
            <div class="student-lookup-search">
                <input type="text" id="studentLookupSearchInput" placeholder="ðŸ” Search by name or email..." oninput="filterStudentLookup()">
            </div>
            
            <div class="student-lookup-container" id="studentLookupList">
                <div class="student-lookup-empty">
                    <p style="font-size: 36px; margin-bottom: 10px;">â³</p>
                    <p>Loading students...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SALES CHAT MODAL ==================== -->
    <div class="sales-modal-overlay" id="salesChatModal">
        <div class="sales-modal">
            <!-- Left Sidebar: Chat List -->
            <aside class="sales-sidebar" id="salesSidebar">
                <div class="sales-sidebar-header">
                    <div class="sales-sidebar-title">
                        <h2>ðŸ’¬ <span>Sales</span> Chat</h2>
                        <div style="display: flex; gap: 6px;">
                            <button class="sales-close-btn" onclick="openSalesDragOverlay()" title="Grid View">ðŸ“‹</button>
                            <button class="sales-close-btn" onclick="openSalesFeedbackPanel()" title="AI Feedback">ðŸ’¬</button>
                            <button class="sales-close-btn" onclick="openSalesSettingsModal()" title="Settings">âš™ï¸</button>
                            <button class="sales-close-btn" onclick="closeSalesChatModal()">Ã—</button>
                        </div>
                    </div>
                    <button class="sales-new-chat-btn" onclick="startNewSalesChat()">+ New Conversation</button>
                </div>
                
                <div class="sales-filter-tabs">
                    <button class="sales-filter-tab active" data-filter="all" onclick="filterSalesChats('all')">All <span class="count" id="salesCountAll">0</span></button>
                    <button class="sales-filter-tab" data-filter="red" onclick="filterSalesChats('red')">ðŸ”¥ Hot <span class="count" id="salesCountRed">0</span></button>
                    <button class="sales-filter-tab" data-filter="yellow" onclick="filterSalesChats('yellow')">ðŸ’› Warm <span class="count" id="salesCountYellow">0</span></button>
                    <button class="sales-filter-tab" data-filter="grey" onclick="filterSalesChats('grey')">â„ï¸ Cold <span class="count" id="salesCountGrey">0</span></button>
                    <button class="sales-filter-tab" data-filter="downsell" onclick="filterSalesChats('downsell')">ðŸ¦Š Ready <span class="count" id="salesCountDownsell">0</span></button>
                </div>
                
                <div class="sales-chat-list" id="salesChatList"></div>
            </aside>
            
            <!-- Main Chat Area -->
            <main class="sales-main-area" id="salesMainArea">
                <div class="sales-slot-context" id="salesSlotContext" style="display: none; flex-shrink: 0;">
                    <div class="sales-slot-context-icon">ðŸ“…</div>
                    <div class="sales-slot-context-info">
                        <div class="sales-slot-context-title" id="salesSlotTitle">Saturday @ 8:30 PM EST</div>
                        <div class="sales-slot-context-details" id="salesSlotDetails">Beginner â€¢ Calvin â€¢ Starts Jan 18</div>
                    </div>
                    <div class="sales-slot-context-seats" id="salesSlotSeats"></div>
                </div>
                
                <div class="sales-empty-state" id="salesEmptyState" style="flex: 1; min-height: 0; overflow-y: auto;">
                    <div class="sales-empty-state-icon">ðŸ’¬</div>
                    <h3>Start a Conversation</h3>
                    <p>Paste the customer's first message below to begin a sales conversation for this slot.</p>
                    <div style="width: 100%; max-width: 500px; margin-top: 24px;">
                        <textarea class="sales-message-input" id="salesNewChatInput" placeholder="Paste customer's message here..." rows="4" style="width: 100%; min-height: 100px;" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); createSalesChatFromMessage(); }"></textarea>
                        <button class="sales-send-btn" style="width: 100%; margin-top: 12px;" onclick="createSalesChatFromMessage()">âœ¨ Create Chat & Get AI Response</button>
                    </div>
                </div>
                
                <div id="salesActiveChat" style="display: none; flex: 1; flex-direction: column; min-height: 0; overflow: hidden;">
                    <div class="sales-chat-header">
                        <div class="sales-chat-header-left">
                            <div class="sales-chat-header-avatar" id="salesChatAvatar">?</div>
                            <div class="sales-chat-header-info">
                                <div class="sales-chat-header-name" id="salesChatName">Customer Name</div>
                                <div class="sales-chat-header-details" id="salesChatDetails"><span>ðŸ“ Unknown</span><span>ðŸŽ¯ Unknown</span></div>
                            </div>
                        </div>
                        <div class="sales-chat-header-actions">
                            <button class="sales-header-btn" onclick="openSalesAddResponseModal()">ðŸ“¤ Add Sent</button>
                            <button class="sales-header-btn" onclick="generateSalesSummary()">ðŸ“‹ Summary</button>
                            <button class="sales-header-btn success" id="salesAddStudentBtn" onclick="addStudentToSlotFromChat()" style="display: none;">âœ… Add to Slot</button>
                            <button class="sales-header-btn danger" onclick="deleteSalesChat()">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="sales-messages-container" id="salesMessagesContainer" style="flex: 1; min-height: 0; overflow-y: auto;"></div>
                    <div class="sales-input-area" style="flex-shrink: 0;">
                        <div class="sales-input-wrapper">
                            <div class="sales-input-container">
                                <div class="sales-input-label">ðŸ“¥ Paste customer's reply:</div>
                                <textarea class="sales-message-input" id="salesMessageInput" placeholder="Paste what the customer replied..." rows="2" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendSalesMessage(); }"></textarea>
                            </div>
                            <button class="sales-send-btn" id="salesSendBtn" onclick="sendSalesMessage()">âœ¨ Get AI Response</button>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Suggestions Sidebar -->
            <aside class="sales-suggestions-sidebar" id="salesSuggestionsSidebar">
                <div class="sales-suggestions-header">
                    <h3>ðŸ’¡ Smart Suggestions</h3>
                    <button class="sales-suggestion-add-btn" onclick="quickAddSuggestion()" title="Quick Add">âž•</button>
                </div>
                <div class="sales-suggestions-search">
                    <input type="text" id="salesSuggestionSearch" placeholder="ðŸ” Search suggestions..." oninput="filterSalesSuggestions()">
                </div>
                <div class="sales-suggestions-filters">
                    <button class="sales-filter-chip active" data-filter="all" onclick="filterSuggestionsByTag('all')">All</button>
                    <button class="sales-filter-chip" data-filter="objection" onclick="filterSuggestionsByTag('objection')">ðŸš§</button>
                    <button class="sales-filter-chip" data-filter="template" onclick="filterSuggestionsByTag('template')">ðŸ“</button>
                    <button class="sales-filter-chip" data-filter="closing" onclick="filterSuggestionsByTag('closing')">ðŸŽ¯</button>
                </div>
                <div class="sales-suggestions-content" id="salesSuggestionsContent">
                    <div class="sales-suggestion-section" data-category="objection">
                        <div class="sales-suggestion-title">ðŸš§ Objection Handlers</div>
                        <div id="salesObjectionHandlersList"></div>
                    </div>
                    <div class="sales-suggestion-section" data-category="template">
                        <div class="sales-suggestion-title">ðŸ“ Templates</div>
                        <div id="salesTemplatesList2"></div>
                    </div>
                    <div class="sales-suggestion-section" data-category="closing">
                        <div class="sales-suggestion-title">ðŸŽ¯ Closing Scripts</div>
                        <div id="salesClosingScriptsList"></div>
                    </div>
                </div>
            </aside>
            
            <!-- Google Voice Panel -->
            <aside class="sales-voice-panel collapsed" id="salesVoicePanel">
                <div class="sales-voice-header">
                    <h3>ðŸ“ž Google Voice</h3>
                    <button class="sales-voice-toggle" onclick="toggleGoogleVoicePanel()">Hide</button>
                </div>
                <div class="sales-voice-notice">
                    <div style="font-size: 48px; margin-bottom: 20px;">ðŸ“ž</div>
                    <h3 style="color: #fff; margin-bottom: 10px;">Google Voice</h3>
                    <p style="margin-bottom: 20px;">Open Google Voice in a new window to message customers.</p>
                    <button onclick="openGoogleVoiceWindow()" style="padding: 16px 32px; background: linear-gradient(135deg, #4285f4, #34a853); border: none; border-radius: 12px; color: #fff; font-size: 16px; font-weight: bold; cursor: pointer;">ðŸ“ž Open Google Voice</button>
                </div>
            </aside>
            <button class="sales-voice-expand-btn" id="salesVoiceExpandBtn" onclick="toggleGoogleVoicePanel()">ðŸ“ž</button>
        </div>
    </div>
    
    <!-- Sales Add Response Modal -->
    <div class="modal-overlay" id="salesAddResponseModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeSalesAddResponseModal()">âœ•</button>
            <h3 class="modal-title">ðŸ“¤ Add Your Sent Message</h3>
            <p style="font-size: 12px; color: #888; margin: 10px 0;">Paste the message you sent to the customer (for record keeping).</p>
            <div class="form-group">
                <label>Your message:</label>
                <textarea id="salesAdminResponseInput" rows="4" placeholder="Paste what you sent..."></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeSalesAddResponseModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveSalesAdminResponse()">Save Message</button>
            </div>
        </div>
    </div>
    
    <!-- Sales Summary Modal -->
    <div class="modal-overlay" id="salesSummaryModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeModal('salesSummaryModal')">âœ•</button>
            <h3 class="modal-title">ðŸ“‹ Customer Summary</h3>
            <div id="salesSummaryContent" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin: 15px 0; font-size: 12px; white-space: pre-wrap; color: #eef2ff;"></div>
            <button class="btn btn-info" onclick="copySalesSummary()" style="width: 100%;">ðŸ“‹ Copy to Clipboard</button>
        </div>
    </div>
    
    <!-- Sales Settings Modal -->
    <div class="modal-overlay" id="salesSettingsModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <button class="modal-close" onclick="closeModal('salesSettingsModal')">âœ•</button>
            <h3 class="modal-title">âš™ï¸ Sales Chat Settings</h3>
            <div class="sales-settings-tabs">
                <button class="sales-settings-tab active" onclick="switchSalesSettingsTab('general')">ðŸ”§ General</button>
                <button class="sales-settings-tab" onclick="switchSalesSettingsTab('personality')">ðŸŽ­ AI Personality</button>
                <button class="sales-settings-tab" onclick="switchSalesSettingsTab('business')">ðŸ’¼ Business</button>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 20px;">
                <div class="sales-settings-panel active" id="salesSettingsGeneral">
                    <div class="form-group"><label>First Message Template</label><textarea id="salesSettingTemplate" rows="4" placeholder="Use {customerName}, {teacherName}, {day}, {time}"></textarea></div>
                    <div class="form-group"><label>Default Max Seats</label><input type="number" id="salesSettingMaxSeats" min="1" max="20" value="5"></div>
                    <div class="form-group"><label>Post-Sell Message</label><textarea id="salesSettingPostSellMessage" rows="3" placeholder="ðŸŽ‰ Awesome {customerName}! You're all set..."></textarea></div>
                </div>
                <div class="sales-settings-panel" id="salesSettingsPersonality">
                    <div class="form-group"><label>Agent Name</label><input type="text" id="salesSettingAgentName" placeholder="Calvin"></div>
                    <div class="form-group"><label>Agent Role</label><input type="text" id="salesSettingAgentRole" placeholder="Korean Teacher from TikTok"></div>
                    <div class="form-group"><label>Personality Tone</label><select id="salesSettingTone"><option value="friendly">ðŸ˜Š Friendly & Warm</option><option value="professional">ðŸ’¼ Professional</option><option value="casual">ðŸ˜Ž Casual & Fun</option></select></div>
                    <div class="form-group"><label>Emoji Level</label><select id="salesSettingEmojiLevel"><option value="none">None</option><option value="minimal">Minimal</option><option value="moderate">Moderate</option><option value="heavy">Heavy</option></select></div>
                    <div class="form-group"><label>Response Length</label><select id="salesSettingResponseLength"><option value="short">Short</option><option value="balanced">Balanced</option><option value="detailed">Detailed</option></select></div>
                </div>
                <div class="sales-settings-panel" id="salesSettingsBusiness">
                    <div class="form-group"><label>Business Name</label><input type="text" id="salesSettingBusinessName" placeholder="KoreanLearnin"></div>
                    <div class="form-group"><label>Website URL</label><input type="text" id="salesSettingWebsite" placeholder="https://koreanlearnin.com"></div>
                    <div class="form-group"><label>Intro Course Price</label><input type="text" id="salesSettingIntroPrice" placeholder="$100"></div>
                    <div class="form-group"><label>Advanced Program Price</label><input type="text" id="salesSettingAdvancedPrice" placeholder="$250/month"></div>
                    <div class="form-group"><label>Current Promotion</label><input type="text" id="salesSettingPromotion" placeholder="New Year Special - 20% off!"></div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn-secondary" onclick="closeModal('salesSettingsModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveSalesChatSettings()">ðŸ’¾ Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Sales Feedback Panel -->
    <div class="sales-feedback-panel" id="salesFeedbackPanel">
        <div class="sales-feedback-header"><h2>ðŸ’¬ AI Feedback</h2><button onclick="closeSalesFeedbackPanel()">âœ•</button></div>
        <div class="sales-feedback-content">
            <div class="form-group"><label>Select Conversation</label><select id="salesFeedbackChatSelect" onchange="loadSalesFeedbackChat()"><option value="">-- Select a chat --</option></select></div>
            <button class="btn btn-info" onclick="analyzeSalesConversation()" style="width: 100%; margin: 15px 0;">ðŸ” Analyze Conversation</button>
            <div id="salesFeedbackResults"></div>
        </div>
    </div>
    
    <!-- Sales Drag Overlay -->
    <div class="sales-drag-overlay" id="salesDragOverlay">
        <div class="sales-drag-overlay-header">
            <h2>ðŸ“‹ Quick Chat Switch</h2>
            <p>Click a chat to switch to it</p>
            <button class="sales-drag-overlay-close" onclick="closeSalesDragOverlay()">âœ•</button>
        </div>
        <div class="sales-drag-overlay-stats">
            <div class="sales-drag-stat hot"><span id="salesDragHotCount">0</span> Hot</div>
            <div class="sales-drag-stat warm"><span id="salesDragWarmCount">0</span> Warm</div>
            <div class="sales-drag-stat cold"><span id="salesDragColdCount">0</span> Cold</div>
        </div>
        <div class="sales-drag-overlay-grid" id="salesDragGrid"></div>
    </div>
    <!-- ==================== END SALES CHAT MODALS ==================== -->

    <!-- Existing Student Search Modal -->
    <div class="modal-overlay" id="existingStudentSearchModal">
        <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeExistingStudentSearch()">âœ•</button>
            <h3 class="modal-title">ðŸ” Add Existing Student</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Search for students who already have an account in the evaluation system.</p>
            
            <div class="form-group">
                <label>Search by Name or Email</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="existingStudentSearchInput" placeholder="Enter name or email..." oninput="searchExistingStudents()" style="flex: 1;">
                    <button class="btn btn-info" onclick="searchExistingStudents()">ðŸ” Search</button>
                </div>
            </div>
            
            <div id="existingStudentSearchResults" style="margin-top: 20px;">
                <p style="color: #888; font-size: 12px; text-align: center;">Enter a name or email to search...</p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeExistingStudentSearch()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Existing Student Form Modal -->
    <div class="modal-overlay" id="addExistingStudentFormModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeAddExistingStudentForm()">âœ•</button>
            <h3 class="modal-title">âž• Add to Registered Students</h3>
            
            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="font-size: 14px; color: #00ffff; margin: 0 0 5px 0;" id="addExistingStudentName">Student Name</p>
                <p style="font-size: 12px; color: #888; margin: 0;" id="addExistingStudentEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b7c4c3c2d3d2d9c3f7d2dad6dedb99d4d8da">[email&#160;protected]</a></p>
            </div>
            
            <input type="hidden" id="addExistingStudentUid">
            
            <div class="form-group">
                <label>Phone Number <span style="color: #888; font-size: 11px;">(Optional)</span></label>
                <input type="tel" id="addExistingStudentPhone" placeholder="Phone number">
            </div>
            
            <div class="form-group">
                <label>Discord Username <span style="color: #888; font-size: 11px;">(Optional)</span></label>
                <input type="text" id="addExistingStudentDiscord" placeholder="Discord username">
            </div>
            
            <div class="form-group">
                <label>Country</label>
                <select id="addExistingStudentCountry">
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="GB">United Kingdom</option>
                    <option value="AU">Australia</option>
                    <option value="KR">South Korea</option>
                    <option value="JP">Japan</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Timezone</label>
                <select id="addExistingStudentTimezone">
                    <option value="America/New_York">Eastern Time (ET)</option>
                    <option value="America/Chicago">Central Time (CT)</option>
                    <option value="America/Denver">Mountain Time (MT)</option>
                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    <option value="America/Anchorage">Alaska Time (AKT)</option>
                    <option value="Pacific/Honolulu">Hawaii Time (HST)</option>
                    <option value="Europe/London">London (GMT/BST)</option>
                    <option value="Europe/Paris">Paris/Berlin (CET)</option>
                    <option value="Asia/Seoul">Seoul (KST)</option>
                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                    <option value="Australia/Sydney">Sydney (AEST)</option>
                    <option value="Australia/Perth">Perth (AWST)</option>
                </select>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-success" onclick="confirmAddExistingStudent()">âœ… Add Student</button>
                <button class="btn btn-secondary" onclick="closeAddExistingStudentForm()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Community Reminder Modal (for teachers on Week 6) -->
    <div class="modal-overlay" id="communityReminderModal">
        <div class="modal" style="text-align: center; max-width: 600px;">
            <button class="modal-close" onclick="closeCommunityReminderModal()">âœ•</button>
            <h3 class="modal-title" style="color: #ff00ff;">ðŸŽ‰ Final Week Reminder!</h3>
            <div style="font-size: 50px; margin: 20px 0;">ðŸŽ“</div>
            <p style="font-size: 14px; color: #ffff00; margin-bottom: 15px;">This is the LAST WEEK of the 6-week course!</p>
            <p style="font-size: 13px; color: #888; margin-bottom: 20px;">Please remind your students about the <strong style="color: #00ffff;">KoreanLearnin Community</strong> programs!</p>
            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                <p style="font-size: 13px; color: #00ffff; margin-bottom: 10px;">ðŸ—£ï¸ Suggested script:</p>
                <p style="font-size: 12px; color: #fff; font-style: italic; margin-bottom: 10px;">"Congratulations on finishing the course! If you'd like to continue learning and get conversational in Korean within 1 year, consider joining our programs!"</p>
            </div>
            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left;">
                <p style="font-size: 14px; color: #39ff14; margin-bottom: 10px; text-align: center;">ðŸ’° Pricing Options</p>
                <p style="font-size: 12px; color: #fff; margin-bottom: 8px;"><strong style="color: #ffff00;">ðŸŒŸ 1-Year Mastery Program:</strong> $500/year</p>
                <p style="font-size: 11px; color: #888; margin-bottom: 10px; padding-left: 20px;">â†’ Since you paid $200 for this course, it's only <strong style="color: #39ff14;">$300</strong> to upgrade!</p>
                <p style="font-size: 11px; color: #ff9900; margin-bottom: 10px; padding-left: 20px;">âš¡ Sign up THIS WEEK to get a $200 discount code!</p>
                <p style="font-size: 12px; color: #fff;"><strong style="color: #00ffff;">ðŸ“… Monthly Program:</strong> $89/month</p>
            </div>
            <button class="btn btn-success" onclick="closeCommunityReminderModal()">Got it! ðŸ‘</button>
        </div>
    </div>

    <!-- Class Attendance Complete Modal (for teachers after marking all students in Week 6) -->
    <div class="modal-overlay" id="classCompleteReminderModal">
        <div class="modal" style="text-align: center; max-width: 600px;">
            <button class="modal-close" onclick="closeClassCompleteReminderModal()">âœ•</button>
            <h3 class="modal-title" style="color: #ff00ff;">ðŸŽ‰ All Students Marked!</h3>
            <div style="font-size: 50px; margin: 20px 0;">âœ…</div>
            <p style="font-size: 14px; color: #ffff00; margin-bottom: 15px;">You've marked attendance for all students in the final week!</p>
            <p style="font-size: 13px; color: #888; margin-bottom: 20px;">Don't forget to ask them about continuing their Korean journey!</p>
            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left;">
                <p style="font-size: 14px; color: #39ff14; margin-bottom: 12px; text-align: center;">ðŸ’¬ Remind your students:</p>
                <p style="font-size: 12px; color: #fff; margin-bottom: 10px;"><strong style="color: #ffff00;">ðŸŒŸ 1-Year Mastery Program:</strong> Get conversational in Korean within 1 year!</p>
                <p style="font-size: 12px; color: #fff; margin-bottom: 5px; padding-left: 15px;">â€¢ Regular price: $500/year</p>
                <p style="font-size: 12px; color: #39ff14; margin-bottom: 5px; padding-left: 15px;">â€¢ Your class fee ($200) rolls into it = <strong>Only $300!</strong></p>
                <p style="font-size: 12px; color: #ff9900; margin-bottom: 15px; padding-left: 15px;">âš¡ Must sign up THIS WEEK to get the $200 discount code!</p>
                <p style="font-size: 12px; color: #fff;"><strong style="color: #00ffff;">ðŸ“… Monthly Program:</strong> $89/month - no commitment!</p>
            </div>
            <button class="btn btn-success" onclick="closeClassCompleteReminderModal()">Got it! ðŸ‘</button>
        </div>
    </div>

    <!-- Calendar Class Picker Modal -->
    <div class="modal-overlay" id="calendarClassPickerModal">
        <div class="modal" style="max-width: 400px;">
            <button class="modal-close" onclick="closeCalendarClassPicker()">âœ•</button>
            <h3 class="modal-title">ðŸ“… Classes on this Day</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Click a class to view details:</p>
            <div id="calendarClassPickerList" style="display: grid; gap: 10px;"></div>
        </div>
    </div>

    <!-- Shopify Listing Generator Modal -->
    <div class="modal-overlay" id="shopifyListingModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('shopifyListingModal')">âœ•</button>
            <h3 class="modal-title">ðŸ›’ Shopify Listing Generator</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Generate copy-paste ready text for Shopify product listings.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <div class="form-group">
                        <label>Class Type *</label>
                        <select id="shopifyClassType" data-level-select onchange="generateShopifyListing()">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Day *</label>
                        <select id="shopifyClassDay" onchange="updateShopifyDateOptions(); generateShopifyListing()" disabled>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Time (EST) *</label>
                        <select id="shopifyClassTime" onchange="generateShopifyListing()" disabled>
                            <option value="6:30 PM">6:30 PM EST</option>
                            <option value="7:10 PM">7:10 PM EST</option>
                            <option value="7:50 PM">7:50 PM EST</option>
                            <option value="8:30 PM">8:30 PM EST</option>
                            <option value="9:10 PM">9:10 PM EST</option>
                            <option value="9:50 PM">9:50 PM EST</option>
                            <option value="10:30 PM">10:30 PM EST</option>
                            <option value="11:10 PM">11:10 PM EST</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Date *</label>
                        <div id="shopifyDateOptions" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
                        <input type="hidden" id="shopifyStartDate">
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <select id="shopifyDuration" onchange="generateShopifyListing()">
                            <option value="6">6 Weeks</option>
                            <option value="4">4 Weeks</option>
                            <option value="8">8 Weeks</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Additional Text (optional)</label>
                        <textarea id="shopifyAdditionalText" rows="4" placeholder="Any additional information to include..." onchange="generateShopifyListing()"></textarea>
                    </div>
                    <div class="form-group">
                        <label>What Students Will Learn (optional)</label>
                        <textarea id="shopifyWhatLearn" rows="4" placeholder="â€¢ Conversational Korean phrases&#10;â€¢ Pronunciation practice&#10;â€¢ Cultural context" onchange="generateShopifyListing()"></textarea>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.5); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="color: #00ffff; font-weight: bold;">Generated Listing:</label>
                    <button class="btn btn-success btn-sm" onclick="copyShopifyListing()">ðŸ“‹ Copy to Clipboard</button>
                </div>
                <pre id="shopifyListingOutput" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; white-space: pre-wrap; font-size: 12px; max-height: 300px; overflow-y: auto; color: #e2e8f0;"></pre>
            </div>
            
            <button class="btn btn-secondary" onclick="closeModal('shopifyListingModal')" style="width: 100%;">Close</button>
        </div>
    </div>

    <!-- Slot Details Modal -->
    <div class="modal-overlay" id="slotDetailsModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('slotDetailsModal')">âœ•</button>
            <h3 class="modal-title" id="slotDetailsTitle">ðŸ“… Slot Details</h3>
            <div id="slotDetailsContent" style="margin: 15px 0;">
                <p style="color: #888;">Loading...</p>
            </div>
            
            <!-- Student Roster (shown for occupied slots) -->
            <div id="slotStudentRoster" style="display: none; margin: 15px 0;">
                <h4 style="color: #00ffff; margin-bottom: 10px;">ðŸ‘¥ Student Roster</h4>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 8px;">Name</th>
                                <th style="text-align: left; padding: 8px;">Phone</th>
                                <th style="text-align: left; padding: 8px;">Discord</th>
                                <th style="text-align: left; padding: 8px;">Email</th>
                                <th style="text-align: center; padding: 8px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="slotStudentRosterBody"></tbody>
                    </table>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-sm btn-info" onclick="copyStudentEmails()">ðŸ“‹ Copy Emails</button>
                    <button class="btn btn-sm btn-success" onclick="copyClassInfoEmail()">ðŸ“§ Copy Class Info Email</button>
                </div>
            </div>
            
            <!-- Date Selection (for scheduling) -->
            <div id="slotDateSelection" style="display: none; margin: 15px 0; padding: 15px; background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px;">
                <h4 style="color: #39ff14; margin-bottom: 10px;">ðŸ“… Schedule Next Session</h4>
                <p style="font-size: 11px; color: #888; margin-bottom: 10px;">Select a start date (3-week buffer included):</p>
                <div id="slotDateOptions" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                
                <div id="prescheduleForm" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #39ff14;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 11px;">Class Type *</label>
                            <select id="prescheduleClassType" data-level-select style="font-size: 12px;"></select>
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 11px;">Teacher *</label>
                            <select id="prescheduleTeacher" style="font-size: 12px;"></select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="confirmPreschedule()" style="width: 100%;">âœ“ Pre-schedule This Slot</button>
                </div>
            </div>
            
            <!-- Pre-scheduled Info (for X slots) -->
            <div id="slotPrescheduleInfo" style="display: none; margin: 15px 0; padding: 15px; background: rgba(255,152,0,0.1); border: 2px solid #ff9800; border-radius: 8px;">
                <h4 style="color: #ff9800; margin-bottom: 10px;">â³ Pre-scheduled</h4>
                <div id="prescheduleDetails"></div>
                
                <!-- Enrolled Students List -->
                <div id="slotEnrolledStudentsList" style="margin-top: 15px; display: none;">
                    <h5 style="color: #39ff14; font-size: 12px; margin-bottom: 8px;">ðŸ‘¥ Enrolled Students:</h5>
                    <div id="slotEnrolledStudentsContent"></div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn btn-success btn-sm" onclick="openAddStudentToSlotModal()">âž• Add Student</button>
                    <button class="btn btn-info btn-sm" onclick="openSalesChatFromSlotModal()" style="background: linear-gradient(135deg, rgba(255,214,130,0.9), rgba(255,244,200,0.7)); border-color: #ffd682; color: #1a1a2e;">ðŸ’¬ Sales Chat</button>
                    <button class="btn btn-danger btn-sm" onclick="cancelPreschedule()">âŒ Cancel</button>
                </div>
                
                <!-- Start Class Button -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,152,0,0.3);">
                    <button class="btn btn-success" onclick="convertPrescheduleToClass()" style="width: 100%; padding: 12px; font-size: 14px;">
                        ðŸš€ Start Class (Create from Pre-schedule)
                    </button>
                    <p style="font-size: 10px; color: #888; margin-top: 8px; text-align: center;">
                        This will create the actual class with all linked students. Unlinked students will be added by name only.
                    </p>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
                <button class="btn btn-info" onclick="useSlotForShopify()">ðŸ›’ Shopify Listing</button>
                <button class="btn btn-secondary" onclick="closeModal('slotDetailsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Student to Slot Modal -->
    <div class="modal-overlay" id="addStudentToSlotModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeAddStudentToSlotModal()">âœ•</button>
            <h3 class="modal-title">âž• Add Student to Slot</h3>
            
            <div style="background: rgba(255,152,0,0.1); border: 2px solid #ff9800; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="font-size: 13px; color: #ff9800; margin: 0;" id="addStudentSlotInfo">Saturday @ 8:30 PM EST</p>
                <p style="font-size: 11px; color: #888; margin-top: 4px;" id="addStudentSlotSeats">0/5 seats filled</p>
            </div>
            
            <div class="form-group">
                <label>Student Name *</label>
                <input type="text" id="directAddStudentName" placeholder="Enter student's name">
            </div>
            
            <div class="form-group">
                <label>Email <span style="color: #888; font-size: 11px;">(Optional)</span></label>
                <input type="email" id="directAddStudentEmail" placeholder="student@email.com">
            </div>
            
            <div class="form-group">
                <label>Phone <span style="color: #888; font-size: 11px;">(Optional)</span></label>
                <input type="tel" id="directAddStudentPhone" placeholder="Phone number">
            </div>
            
            <div class="form-group">
                <label style="color: #7289da;">Discord <span style="color: #888; font-size: 11px;">(Optional)</span></label>
                <input type="text" id="directAddStudentDiscord" placeholder="Discord username">
            </div>
            
            <div class="form-group">
                <label>Notes <span style="color: #888; font-size: 11px;">(Optional)</span></label>
                <input type="text" id="directAddStudentNotes" placeholder="Any notes about this student">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAddStudentToSlotModal()">Cancel</button>
                <button class="btn btn-success" onclick="addStudentToSlotDirectly()" style="flex: 1;">âœ… Add Student</button>
            </div>
        </div>
    </div>

    <!-- Link Student Account Modal -->
    <div class="modal-overlay" id="linkAccountModal">
        <div class="modal" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeLinkAccountModal()">âœ•</button>
            <h3 class="modal-title">ðŸ”— Link to Account</h3>
            
            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="font-size: 11px; color: #888; margin: 0;">Linking student:</p>
                <p style="font-size: 14px; color: #00ffff; margin: 4px 0 0 0; font-weight: bold;" id="linkAccountStudentName">Student Name</p>
            </div>
            
            <div class="form-group">
                <label>Search for Account</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="linkAccountSearchInput" placeholder="Search by name or email..." style="flex: 1;" oninput="searchAccountsToLink()">
                    <button class="btn btn-info" onclick="searchAccountsToLink()">ðŸ”</button>
                </div>
            </div>
            
            <div id="linkAccountSearchResults" style="margin-top: 15px;">
                <p style="color: #888; font-size: 12px; text-align: center;">Enter a name or email to search...</p>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-secondary" onclick="closeLinkAccountModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Move Student From Slot Modal -->
    <div class="modal-overlay" id="moveStudentFromSlotModal">
        <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeMoveStudentFromSlotModal()">âœ•</button>
            <h3 class="modal-title">ðŸ”„ Move Student to Another Slot</h3>
            
            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="font-size: 11px; color: #888; margin: 0;">Moving student:</p>
                <p style="font-size: 14px; color: #00ffff; margin: 4px 0 0 0; font-weight: bold;" id="moveSlotStudentName">Student Name</p>
                <p style="font-size: 11px; color: #888; margin: 4px 0 0 0;" id="moveSlotFromInfo">From: Saturday @ 7:10 PM</p>
            </div>
            
            <h4 style="color: #ffff00; font-size: 14px; margin-bottom: 10px;">Select destination slot:</h4>
            
            <div id="moveSlotDestinationList" style="max-height: 350px; overflow-y: auto;">
                <p style="color: #888; font-size: 12px; text-align: center;">Loading available slots...</p>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeMoveStudentFromSlotModal()">Cancel</button>
                <button class="btn btn-success" id="confirmMoveSlotBtn" onclick="confirmMoveStudentFromSlot()" disabled>âœ“ Confirm Move</button>
            </div>
        </div>
    </div>

    <!-- Move Student From Active Class Modal (Slot Manager) -->
    <div class="modal-overlay" id="moveStudentFromClassModal">
        <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeMoveStudentFromClassModal()">âœ•</button>
            <h3 class="modal-title">ðŸ”„ Move Student to Another Class</h3>
            
            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="font-size: 11px; color: #888; margin: 0;">Moving student:</p>
                <p style="font-size: 14px; color: #00ffff; margin: 4px 0 0 0; font-weight: bold;" id="moveClassStudentName">Student Name</p>
                <p style="font-size: 11px; color: #888; margin: 4px 0 0 0;" id="moveClassFromInfo">From: Saturday @ 7:10 PM</p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label class="checkbox-label">
                    <input type="checkbox" id="returnToPoolFromClassCheckbox" onchange="toggleMoveFromClassOptions()">
                    <span style="font-size: 12px;">Return to student pool (schedule changed, needs reassignment)</span>
                </label>
            </div>
            
            <div id="moveClassDestinationSection">
                <h4 style="color: #ffff00; font-size: 14px; margin-bottom: 10px;">Select destination class:</h4>
                
                <div id="moveClassDestinationList" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #888; font-size: 12px; text-align: center;">Loading available classes...</p>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeMoveStudentFromClassModal()">Cancel</button>
                <button class="btn btn-success" id="confirmMoveClassBtn" onclick="confirmMoveStudentFromClass()">âœ“ Confirm Move</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div class="modal-overlay" id="pdfPreviewModal">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('pdfPreviewModal')">âœ•</button>
            <h3 class="modal-title">ðŸ‘ï¸ PDF Preview</h3>
            <div id="pdfPreviewContent" style="background: #fff; color: #000; padding: 30px; border-radius: 8px; margin: 15px 0;">
                <!-- PDF preview will be rendered here -->
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="generateStudentPdf()">ðŸ“„ Generate PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('pdfPreviewModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Account Modal -->
    <div class="modal-overlay" id="createAccountModal">
        <div class="modal" style="max-width: 450px;">
            <button class="modal-close" onclick="closeCreateAccountModal()">âœ•</button>
            <h3 class="modal-title">ðŸ‘¤ Create Customer Account</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Create a Firebase account for this Shopify customer so they can log in.</p>
            
            <div id="createAccountMessage"></div>
            
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="createAcctName" readonly style="background: rgba(255,255,255,0.1);">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="createAcctEmail" readonly style="background: rgba(255,255,255,0.1);">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="createAcctPhone" readonly style="background: rgba(255,255,255,0.1);">
            </div>
            <div class="form-group">
                <label>Location</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="createAcctCity" readonly style="background: rgba(255,255,255,0.1); flex: 1;" placeholder="City">
                    <input type="text" id="createAcctState" readonly style="background: rgba(255,255,255,0.1); width: 80px;" placeholder="State">
                </div>
            </div>
            <div class="form-group">
                <label>Tags</label>
                <input type="text" id="createAcctTags" readonly style="background: rgba(255,255,255,0.1); font-size: 11px;">
            </div>
            <input type="hidden" id="createAcctShopifyId">
            <div class="form-group">
                <label>Password *</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="createAcctPassword" placeholder="Min 6 characters" style="flex: 1;">
                    <button type="button" class="btn btn-info btn-sm" onclick="generatePassword()" style="white-space: nowrap;">ðŸ”‘ PW Gen</button>
                </div>
            </div>
            <div class="form-group">
                <label>Confirm Password *</label>
                <input type="text" id="createAcctPasswordConfirm" placeholder="Re-enter password">
            </div>
            
            <button class="btn btn-success btn-block" id="submitCreateAcctBtn" onclick="submitCreateCustomerAccount()">
                âœ… CREATE ACCOUNT
            </button>
        </div>
    </div>

    <!-- Add Class Type Modal -->
    <div class="modal-overlay" id="addClassTypeModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeModal('addClassTypeModal')">âœ•</button>
            <h3 class="modal-title">âž• Add New Class Type</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Create a new class type (e.g., Kdrama Phrase Class, Kpop Phrase Class)</p>
            
            <div class="form-group">
                <label>Class Type ID (lowercase, no spaces) *</label>
                <input type="text" id="classTypeId" placeholder="e.g., kdrama, kpop, topik" oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9]/g, '')">
            </div>
            <div class="form-group">
                <label>Display Name *</label>
                <input type="text" id="classTypeName" placeholder="e.g., Kdrama Phrase Class">
            </div>
            <div class="form-group">
                <label>Color (for badges)</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#ff00ff" checked> <span style="color: #ff00ff;">â— Magenta</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#00ffff"> <span style="color: #00ffff;">â— Cyan</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#39ff14"> <span style="color: #39ff14;">â— Green</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#ffff00"> <span style="color: #ffff00;">â— Yellow</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#ff6600"> <span style="color: #ff6600;">â— Orange</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#ff3366"> <span style="color: #ff3366;">â— Pink</span></label>
                    <label style="cursor: pointer;"><input type="radio" name="classTypeColor" value="#9966ff"> <span style="color: #9966ff;">â— Purple</span></label>
                </div>
            </div>
            <div class="form-group">
                <label>Number of Weeks</label>
                <input type="number" id="classTypeWeeks" value="6" min="1" max="52">
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <textarea id="classTypeDescription" placeholder="Brief description of this class type..." style="height: 60px;"></textarea>
            </div>
            
            <button class="btn btn-success btn-block" onclick="saveClassType()">âœ… Create Class Type</button>
            
            <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <h4 style="color: #ff3366; font-size: 13px; margin-bottom: 10px;">Existing Class Types</h4>
                <div id="existingClassTypesList" style="font-size: 12px; color: #888;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div class="modal-overlay" id="addClassModal">
        <div class="modal" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModal('addClassModal')">âœ•</button>
            <h3 class="modal-title">âž• Add New Class</h3>
            <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Manually create a class for any class type</p>
            
            <div class="form-group">
                <label>Class Type *</label>
                <select id="addClassType">
                    <option value="">-- Select Class Type --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Day *</label>
                <select id="addClassDay">
                    <option value="">-- Select Day --</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                </select>
            </div>
            <div class="form-group">
                <label>Time (EST) *</label>
                <select id="addClassTime">
                    <option value="">-- Select Time --</option>
                    <option value="6:30 PM">6:30 PM</option>
                    <option value="7:10 PM">7:10 PM</option>
                    <option value="7:50 PM">7:50 PM</option>
                    <option value="8:30 PM">8:30 PM</option>
                    <option value="9:10 PM">9:10 PM</option>
                    <option value="9:50 PM">9:50 PM</option>
                    <option value="10:30 PM">10:30 PM</option>
                    <option value="11:10 PM">11:10 PM</option>
                </select>
            </div>
            <div class="form-group">
                <label>Start Date *</label>
                <input type="date" id="addClassStartDate">
            </div>
            <div class="form-group">
                <label>Assign Teacher (optional)</label>
                <select id="addClassTeacher">
                    <option value="">-- No Teacher --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Max Students</label>
                <input type="number" id="addClassMaxStudents" value="10" min="1" max="50">
            </div>
            
            <button class="btn btn-success btn-block" onclick="saveNewClass()">âœ… Create Class</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        console.log('Script starting...');

        // ==================== EST TIMEZONE HELPERS ====================
        // All date/time operations should use these functions to ensure consistent EST behavior
        
        // Get current date/time in EST timezone
        function getESTDate() {
            const now = new Date();
            // Convert to EST by using toLocaleString with America/New_York timezone
            const estString = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
            return new Date(estString);
        }
        
        // Get current day name in EST (e.g., "Saturday", "Sunday")
        function getESTDayName() {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return dayNames[getESTDate().getDay()];
        }
        
        // Get current month (0-11) in EST
        function getESTMonth() {
            return getESTDate().getMonth();
        }
        
        // Get current year in EST
        function getESTYear() {
            return getESTDate().getFullYear();
        }
        
        // Parse a date string (YYYY-MM-DD) as EST midnight
        function parseESTDate(dateString) {
            if (!dateString) return null;
            // Parse as EST by appending EST timezone offset
            // Create date at midnight EST
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(dateString + 'T00:00:00-05:00'); // EST is UTC-5
            return date;
        }
        
        // Format a date string (YYYY-MM-DD) for display in EST timezone
        function formatDateInEST(dateString, options = {}) {
            if (!dateString) return 'Not set';
            const defaultOptions = { month: 'short', day: 'numeric', year: 'numeric' };
            const formatOptions = { ...defaultOptions, ...options, timeZone: 'America/New_York' };
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString('en-US', formatOptions);
        }
        
        // Get start of today in EST (midnight)
        function getESTToday() {
            const est = getESTDate();
            est.setHours(0, 0, 0, 0);
            return est;
        }
        
        // Compare two dates (ignoring time) - returns true if date1 >= date2
        function isDateOnOrAfter(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);
            return d1 >= d2;
        }
        
        // Get the number of days between two dates
        function getDaysBetween(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);
            return Math.floor((d1 - d2) / (1000 * 60 * 60 * 24));
        }
        
        // ==================== END EST TIMEZONE HELPERS ====================

        // Check if Firebase SDK is loaded
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded!');
            alert('Firebase SDK failed to load. Please check your internet connection and refresh the page.');
        } else {
            console.log('Firebase SDK loaded');
        }

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDzI1_B49onrKJriy3er88O1KOJTLBzbYY",
            authDomain: "korean-ta-evaluator.firebaseapp.com",
            projectId: "korean-ta-evaluator",
            storageBucket: "korean-ta-evaluator.firebasestorage.app",
            messagingSenderId: "386010826708",
            appId: "1:386010826708:web:d06d6fbdadce561b36b841",
            measurementId: "G-FGT8J0D64J"
        };
        
        console.log('Initializing Firebase...');
        // Initialize Firebase
        let auth, db, storage, secondaryAuth;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            
            // Expose db on window for iframe access
            window.schedulerDb = db;
            
            // Secondary app for creating accounts without logging out admin
            const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
            secondaryAuth = secondaryApp.auth();
            
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize Firebase: " + error.message);
        }

        // Yodafy Game Firebase functions (called from iframe)
        async function saveYodafyGame(jsonData) {
            try {
                const gameData = JSON.parse(jsonData);
                gameData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('yodafy_games').add(gameData);
                return { success: true };
            } catch (error) {
                console.error('Save Yodafy game error:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function loadYodafyGames() {
            try {
                const snap = await db.collection('yodafy_games').orderBy('createdAt', 'desc').limit(20).get();
                const games = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                return { success: true, games: games };
            } catch (error) {
                console.error('Load Yodafy games error:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function loadYodafyGameById(gameId) {
            try {
                const doc = await db.collection('yodafy_games').doc(gameId).get();
                if (!doc.exists) {
                    return { success: false, error: 'Game not found' };
                }
                return { success: true, game: doc.data() };
            } catch (error) {
                console.error('Load Yodafy game error:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function deleteYodafyGame(gameId) {
            try {
                await db.collection('yodafy_games').doc(gameId).delete();
                return { success: true };
            } catch (error) {
                console.error('Delete Yodafy game error:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Expose Yodafy functions on window for iframe access
        window.saveYodafyGame = saveYodafyGame;
        window.loadYodafyGames = loadYodafyGames;
        window.loadYodafyGameById = loadYodafyGameById;
        window.deleteYodafyGame = deleteYodafyGame;

        // Constants
        const TIME_SLOTS = ['6:30 PM', '7:10 PM', '7:50 PM', '8:30 PM', '9:10 PM', '9:50 PM', '10:30 PM', '11:10 PM'];
        const DAYS = ['Saturday', 'Sunday'];
        
        // Helper function to parse date strings as local time (avoids timezone issues)
        // When a date string like "2026-01-17" is parsed with new Date(), it's treated as UTC
        // which causes it to display as the previous day in EST. This helper fixes that.
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            // If it's already a Date object, return it
            if (dateStr instanceof Date) return dateStr;
            // If it's a string, append T12:00:00 to treat as noon local time (avoids day boundary issues)
            if (typeof dateStr === 'string') {
                // Check if it already has time component
                if (dateStr.includes('T')) {
                    return new Date(dateStr);
                }
                // Add noon time to avoid timezone day-shift issues
                return new Date(dateStr + 'T12:00:00');
            }
            return new Date(dateStr);
        }
        
        // Default levels (will be merged with custom class types from Firestore)
        const DEFAULT_LEVELS = { absolute: 'Absolute Beginner', novice: 'Novice', beginner: 'Beginner', advanced: 'Advanced Beginner' };
        let LEVELS = { ...DEFAULT_LEVELS };
        let LEVEL_PRIORITY = ['absolute', 'novice', 'beginner', 'advanced'];
        let CLASS_TYPE_COLORS = { absolute: '#ff00ff', novice: '#00ffff', beginner: '#39ff14', advanced: '#ffff00' };
        let CLASS_TYPE_WEEKS = { absolute: 6, novice: 6, beginner: 6, advanced: 6 };
        let allClassTypes = []; // Custom class types from Firestore

        // State
        let currentUser = null;
        let selectedSlots = { 1: null, 2: null, 3: null };
        let allStudents = [];
        let allClasses = [];
        let allTeachers = [];
        let allProposals = [];
        let allPrescheduledSlots = []; // Pre-scheduled class slots
        let schedulerSettings = { minStudents: 5, maxStudents: 10, currentWeek: 1, startDate: null };
        let pendingDropAction = null;
        let draggedStudentId = null;
        let draggedProposalStudentId = null;

        // Helper: get student availability (supports both classTime and legacy availabilities)
        function getStudentAvailabilities(student) {
            if (student.availabilities && (student.availabilities[1] || student.availabilities[2] || student.availabilities[3])) {
                return student.availabilities;
            }
            if (student.classTime) {
                return { 1: student.classTime, 2: null, 3: null };
            }
            return {};
        }

        // Timezone Map
        // US States with their default timezones
        const US_STATES = {
            'Alabama': 'America/Chicago',
            'Alaska': 'America/Anchorage', // Split timezone
            'Arizona': 'America/Phoenix',
            'Arkansas': 'America/Chicago',
            'California': 'America/Los_Angeles',
            'Colorado': 'America/Denver',
            'Connecticut': 'America/New_York',
            'Delaware': 'America/New_York',
            'Florida': 'America/New_York', // Split timezone
            'Georgia': 'America/New_York',
            'Hawaii': 'Pacific/Honolulu',
            'Idaho': 'America/Boise', // Split timezone
            'Illinois': 'America/Chicago',
            'Indiana': 'America/Indiana/Indianapolis', // Split timezone
            'Iowa': 'America/Chicago',
            'Kansas': 'America/Chicago', // Split timezone
            'Kentucky': 'America/Kentucky/Louisville', // Split timezone
            'Louisiana': 'America/Chicago',
            'Maine': 'America/New_York',
            'Maryland': 'America/New_York',
            'Massachusetts': 'America/New_York',
            'Michigan': 'America/Detroit', // Split timezone
            'Minnesota': 'America/Chicago',
            'Mississippi': 'America/Chicago',
            'Missouri': 'America/Chicago',
            'Montana': 'America/Denver',
            'Nebraska': 'America/Chicago', // Split timezone
            'Nevada': 'America/Los_Angeles', // Split timezone
            'New Hampshire': 'America/New_York',
            'New Jersey': 'America/New_York',
            'New Mexico': 'America/Denver',
            'New York': 'America/New_York',
            'North Carolina': 'America/New_York',
            'North Dakota': 'America/Chicago', // Split timezone
            'Ohio': 'America/New_York',
            'Oklahoma': 'America/Chicago',
            'Oregon': 'America/Los_Angeles', // Split timezone
            'Pennsylvania': 'America/New_York',
            'Rhode Island': 'America/New_York',
            'South Carolina': 'America/New_York',
            'South Dakota': 'America/Chicago', // Split timezone
            'Tennessee': 'America/Chicago', // Split timezone
            'Texas': 'America/Chicago', // Split timezone
            'Utah': 'America/Denver',
            'Vermont': 'America/New_York',
            'Virginia': 'America/New_York',
            'Washington': 'America/Los_Angeles',
            'West Virginia': 'America/New_York',
            'Wisconsin': 'America/Chicago',
            'Wyoming': 'America/Denver',
            'District of Columbia': 'America/New_York'
        };
        
        // Canadian Provinces with their default timezones
        const CA_PROVINCES = {
            'Alberta': 'America/Edmonton',
            'British Columbia': 'America/Vancouver',
            'Manitoba': 'America/Winnipeg',
            'New Brunswick': 'America/Moncton',
            'Newfoundland and Labrador': 'America/St_Johns',
            'Northwest Territories': 'America/Yellowknife',
            'Nova Scotia': 'America/Halifax',
            'Nunavut': 'America/Iqaluit',
            'Ontario': 'America/Toronto',
            'Prince Edward Island': 'America/Halifax',
            'Quebec': 'America/Montreal',
            'Saskatchewan': 'America/Regina',
            'Yukon': 'America/Whitehorse'
        };
        
        // Split timezone states with their options
        const SPLIT_TIMEZONE_STATES = {
            'Alaska': [
                { value: 'America/Anchorage', label: 'Alaska Time (most of Alaska)' },
                { value: 'America/Adak', label: 'Hawaii-Aleutian Time (Aleutian Islands)' }
            ],
            'Florida': [
                { value: 'America/New_York', label: 'Eastern Time (most of Florida)' },
                { value: 'America/Chicago', label: 'Central Time (western panhandle - Pensacola, Panama City)' }
            ],
            'Idaho': [
                { value: 'America/Boise', label: 'Mountain Time (southern Idaho)' },
                { value: 'America/Los_Angeles', label: 'Pacific Time (northern panhandle)' }
            ],
            'Indiana': [
                { value: 'America/Indiana/Indianapolis', label: 'Eastern Time (most of Indiana)' },
                { value: 'America/Chicago', label: 'Central Time (northwest & southwest corners)' }
            ],
            'Kansas': [
                { value: 'America/Chicago', label: 'Central Time (most of Kansas)' },
                { value: 'America/Denver', label: 'Mountain Time (western counties)' }
            ],
            'Kentucky': [
                { value: 'America/Kentucky/Louisville', label: 'Eastern Time (eastern Kentucky)' },
                { value: 'America/Chicago', label: 'Central Time (western Kentucky)' }
            ],
            'Michigan': [
                { value: 'America/Detroit', label: 'Eastern Time (most of Michigan)' },
                { value: 'America/Chicago', label: 'Central Time (western Upper Peninsula)' }
            ],
            'Nebraska': [
                { value: 'America/Chicago', label: 'Central Time (most of Nebraska)' },
                { value: 'America/Denver', label: 'Mountain Time (western panhandle)' }
            ],
            'Nevada': [
                { value: 'America/Los_Angeles', label: 'Pacific Time (most of Nevada)' },
                { value: 'America/Denver', label: 'Mountain Time (West Wendover area)' }
            ],
            'North Dakota': [
                { value: 'America/Chicago', label: 'Central Time (most of North Dakota)' },
                { value: 'America/Denver', label: 'Mountain Time (southwest corner)' }
            ],
            'Oregon': [
                { value: 'America/Los_Angeles', label: 'Pacific Time (most of Oregon)' },
                { value: 'America/Boise', label: 'Mountain Time (Malheur County)' }
            ],
            'South Dakota': [
                { value: 'America/Chicago', label: 'Central Time (eastern South Dakota)' },
                { value: 'America/Denver', label: 'Mountain Time (western South Dakota)' }
            ],
            'Tennessee': [
                { value: 'America/Chicago', label: 'Central Time (western & middle Tennessee)' },
                { value: 'America/New_York', label: 'Eastern Time (eastern Tennessee)' }
            ],
            'Texas': [
                { value: 'America/Chicago', label: 'Central Time (most of Texas)' },
                { value: 'America/Denver', label: 'Mountain Time (El Paso & Hudspeth County)' }
            ]
        };
        
        // Country timezone defaults
        const COUNTRY_TIMEZONES = {
            'US': 'America/New_York',
            'CA': 'America/Toronto',
            'GB': 'Europe/London',
            'AU': 'Australia/Sydney',
            'KR': 'Asia/Seoul',
            'JP': 'Asia/Tokyo',
            'DE': 'Europe/Berlin',
            'FR': 'Europe/Paris'
        };

        // Utility Functions
        function showMessage(id, msg, type) {
            const el = document.getElementById(id);
            if (el) { el.innerHTML = `<div class="message ${type}">${msg}</div>`; setTimeout(() => el.innerHTML = '', 5000); }
        }
        
        // Email validation
        function validateEmail() {
            const email = document.getElementById('studentEmail').value.trim();
            const errorEl = document.getElementById('emailError');
            
            if (!email) {
                errorEl.style.display = 'none';
                return false;
            }
            
            // Check for @ symbol
            if (!email.includes('@')) {
                errorEl.textContent = 'Email must contain @ symbol';
                errorEl.style.display = 'block';
                return false;
            }
            
            // Check for valid format
            const emailRegex = /^[^\s@]+@[^\s@]+\.(com|org|edu|net|gov|co|io|me|info|biz|us|ca|uk|au|de|fr|kr|jp)$/i;
            if (!emailRegex.test(email)) {
                errorEl.textContent = 'Please enter a valid email address';
                errorEl.style.display = 'block';
                return false;
            }
            
            errorEl.style.display = 'none';
            return true;
        }
        
        // Country change handler
        function onCountryChange() {
            const country = document.getElementById('studentCountry').value;
            const locationFields = document.getElementById('locationFields');
            const stateGroup = document.getElementById('stateGroup');
            const cityGroup = document.getElementById('cityGroup');
            const timezoneGroup = document.getElementById('timezoneGroup');
            const splitTimezoneGroup = document.getElementById('splitTimezoneGroup');
            const stateList = document.getElementById('stateList');
            const stateLabel = document.getElementById('stateLabel');
            
            // Reset fields
            document.getElementById('studentState').value = '';
            document.getElementById('studentCity').value = '';
            splitTimezoneGroup.style.display = 'none';
            
            if (country === 'GB') {
                // UK - no state/city needed
                locationFields.style.display = 'none';
                timezoneGroup.style.display = 'none';
            } else if (country === 'US') {
                // US - show state autocomplete
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
                stateLabel.textContent = 'State';
                stateList.innerHTML = Object.keys(US_STATES).map(s => `<option value="${s}">`).join('');
            } else if (country === 'CA') {
                // Canada - show province autocomplete
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
                stateLabel.textContent = 'Province';
                stateList.innerHTML = Object.keys(CA_PROVINCES).map(s => `<option value="${s}">`).join('');
            } else if (country === 'OTHER') {
                // Other - show timezone picker
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                stateLabel.textContent = 'State/Province';
                stateList.innerHTML = '';
                timezoneGroup.style.display = 'block';
            } else if (country) {
                // Other known countries - just city
                locationFields.style.display = 'block';
                stateGroup.style.display = 'none';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
            } else {
                locationFields.style.display = 'none';
                timezoneGroup.style.display = 'none';
            }
            
            renderAvailabilityGrid();
        }
        
        // State change handler
        function onStateChange() {
            const country = document.getElementById('studentCountry').value;
            const state = document.getElementById('studentState').value;
            const splitTimezoneGroup = document.getElementById('splitTimezoneGroup');
            const splitTimezoneSelect = document.getElementById('splitTimezoneSelect');
            const splitTimezoneLabel = document.getElementById('splitTimezoneLabel');
            
            // Check if this is a split timezone state
            if (country === 'US' && SPLIT_TIMEZONE_STATES[state]) {
                const options = SPLIT_TIMEZONE_STATES[state];
                splitTimezoneLabel.textContent = `${state} Timezone`;
                splitTimezoneSelect.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
                splitTimezoneGroup.style.display = 'block';
            } else {
                splitTimezoneGroup.style.display = 'none';
            }
            
            renderAvailabilityGrid();
        }

        function getTimezone(country, state) {
            if (!country) return 'America/New_York';
            
            // UK
            if (country === 'GB') return 'Europe/London';
            
            // US
            if (country === 'US' && state) {
                // Check for split timezone state with user selection
                if (SPLIT_TIMEZONE_STATES[state]) {
                    const splitSelect = document.getElementById('splitTimezoneSelect');
                    if (splitSelect && splitSelect.value) {
                        return splitSelect.value;
                    }
                }
                // Use default for state
                if (US_STATES[state]) return US_STATES[state];
            }
            
            // Canada
            if (country === 'CA' && state) {
                if (CA_PROVINCES[state]) return CA_PROVINCES[state];
            }
            
            // Other countries with manual timezone
            if (country === 'OTHER') {
                return document.getElementById('studentTimezone').value;
            }
            
            // Default for country
            return COUNTRY_TIMEZONES[country] || 'America/New_York';
        }

        function convertESTToLocal(estTime, tz) {
            try {
                const [time, period] = estTime.split(' ');
                let [h, m] = time.split(':').map(Number);
                if (period === 'PM' && h !== 12) h += 12;
                if (period === 'AM' && h === 12) h = 0;
                const d = new Date(); d.setHours(h, m, 0, 0);
                return d.toLocaleString('en-US', { timeZone: tz, hour: 'numeric', minute: '2-digit', hour12: true });
            } catch (e) { return estTime; }
        }

        // Role Switching
        function switchRole(role) {
            document.querySelectorAll('.role-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('adminLoginForm').style.display = role === 'admin' ? 'block' : 'none';
            document.getElementById('supportLoginForm').style.display = role === 'support' ? 'block' : 'none';
            document.getElementById('teacherLoginForm').style.display = role === 'teacher' ? 'block' : 'none';
        }

        // Student Registration
        function renderAvailabilityGrid() {
            const grid = document.getElementById('availabilityGrid');
            const countryEl = document.getElementById('studentCountry');
            const stateEl = document.getElementById('studentState');
            
            // Guard against null elements (page might not have student registration form)
            if (!grid || !countryEl) return;
            
            const country = countryEl.value;
            const state = stateEl?.value || '';
            const tz = getTimezone(country, state);

            grid.innerHTML = DAYS.map(day => `
                <div class="day-column">
                    <div class="day-title">${day}</div>
                    ${TIME_SLOTS.map(time => {
                        const local = convertESTToLocal(time, tz);
                        const slotId = `${day}-${time}`;
                        const rank = Object.entries(selectedSlots).find(([r, s]) => s === slotId)?.[0];
                        return `<div class="time-slot ${rank ? 'selected-' + rank : ''}" onclick="selectSlot('${day}', '${time}')">${time} EST<div class="local-time">Your time: ${local}</div>${rank ? `<div class="rank-badge">${rank}</div>` : ''}</div>`;
                    }).join('')}
                </div>
            `).join('');
        }

        function selectSlot(day, time) {
            const slotId = `${day}-${time}`;
            const existing = Object.entries(selectedSlots).find(([r, s]) => s === slotId)?.[0];
            if (existing) { selectedSlots[existing] = null; }
            else { for (let i = 1; i <= 3; i++) { if (!selectedSlots[i]) { selectedSlots[i] = slotId; break; } } }
            renderAvailabilityGrid();
        }

        async function submitStudentRegistration() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            const discord = document.getElementById('studentDiscord').value.trim();
            const country = document.getElementById('studentCountry').value;
            const videoUrl = document.getElementById('studentVideoUrl').value;
            
            // UK doesn't need city/state
            const city = country === 'GB' ? 'United Kingdom' : document.getElementById('studentCity').value.trim();
            const state = country === 'GB' ? '' : document.getElementById('studentState').value.trim();

            // Validation
            if (!name) { showMessage('studentRegMessage', 'Please enter your name', 'error'); return; }
            if (!email) { showMessage('studentRegMessage', 'Please enter your email', 'error'); return; }
            if (!validateEmail()) { showMessage('studentRegMessage', 'Please enter a valid email address', 'error'); return; }
            if (!country) { showMessage('studentRegMessage', 'Please select your country', 'error'); return; }
            
            // Country-specific validation
            if (country === 'US') {
                if (!state || !US_STATES[state]) { showMessage('studentRegMessage', 'Please select a valid US state', 'error'); return; }
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
                // Check if split timezone state needs selection
                if (SPLIT_TIMEZONE_STATES[state] && !document.getElementById('splitTimezoneSelect').value) {
                    showMessage('studentRegMessage', 'Please select your timezone', 'error'); return;
                }
            } else if (country === 'CA') {
                if (!state || !CA_PROVINCES[state]) { showMessage('studentRegMessage', 'Please select a valid Canadian province', 'error'); return; }
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            } else if (country !== 'GB' && country !== 'OTHER') {
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            } else if (country === 'OTHER') {
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            }
            
            if (!selectedSlots[1] || !selectedSlots[2] || !selectedSlots[3]) { showMessage('studentRegMessage', 'Please select 3 availability preferences', 'error'); return; }
            if (!videoUrl) { showMessage('studentRegMessage', 'Please record your pronunciation video', 'error'); return; }

            const tz = getTimezone(country, state);

            try {
                await db.collection('scheduler_students').add({
                    name, email, phone, discord, city, state, country, timezone: tz,
                    availabilities: { ...selectedSlots },
                    videoUrl: videoUrl,
                    level: null, status: 'pending', classId: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('studentLoginForm').style.display = 'none';
                document.getElementById('studentSuccessScreen').style.display = 'block';
            } catch (e) { showMessage('studentRegMessage', 'Error: ' + e.message, 'error'); }
        }

        function resetStudentForm() {
            selectedSlots = { 1: null, 2: null, 3: null };
            ['studentName', 'studentEmail', 'studentPhone', 'studentDiscord', 'studentCity', 'studentState', 'studentCountry'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('studentVideoUrl').value = '';
            document.getElementById('videoPlayback').style.display = 'none';
            document.getElementById('videoPlayback').src = '';
            document.getElementById('recordingStatus').textContent = '';
            document.getElementById('recordingTimer').style.display = 'none';
            document.getElementById('locationFields').style.display = 'none';
            document.getElementById('timezoneGroup').style.display = 'none';
            document.getElementById('splitTimezoneGroup').style.display = 'none';
            document.getElementById('emailError').style.display = 'none';
            const btn = document.getElementById('recordBtn');
            btn.className = 'record-btn start';
            btn.textContent = 'ðŸŽ¤ HOLD TO RECORD';
            document.getElementById('studentLoginForm').style.display = 'block';
            document.getElementById('studentSuccessScreen').style.display = 'none';
            renderAvailabilityGrid();
        }

        // Admin Login
        async function adminLogin() {
            if (!auth || !db) { showMessage('adminLoginMessage', 'Firebase not ready. Please refresh the page.', 'error'); return; }
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            if (!email || !password) { showMessage('adminLoginMessage', 'Enter email and password', 'error'); return; }

            console.log('Attempting admin login with:', email);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Authentication successful:', userCredential.user.uid);
                
                // Check users collection for admin role
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                console.log('User doc exists:', userDoc.exists);
                
                if (!userDoc.exists) {
                    await auth.signOut();
                    showMessage('adminLoginMessage', 'User not found in database', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                console.log('User data:', userData);
                
                if (userData.role !== 'admin') {
                    await auth.signOut();
                    showMessage('adminLoginMessage', 'Access denied. Admin only.', 'error');
                    return;
                }
                
                currentUser = { ...userData, uid: userCredential.user.uid, role: 'admin' };
                showMessage('adminLoginMessage', 'Login successful!', 'success');
                setTimeout(() => showAdminDashboard(), 500);
            } catch (e) { 
                console.error('Login error:', e);
                showMessage('adminLoginMessage', 'Login failed: ' + e.message, 'error'); 
            }
        }

        // Support Login
        async function supportLogin() {
            if (!auth || !db) { showMessage('supportLoginMessage', 'Firebase not ready. Please refresh the page.', 'error'); return; }
            const email = document.getElementById('supportEmail').value.trim();
            const password = document.getElementById('supportPassword').value;
            if (!email || !password) { showMessage('supportLoginMessage', 'Enter email and password', 'error'); return; }

            console.log('Attempting support login with:', email);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Authentication successful:', userCredential.user.uid);
                
                // Check users collection for support role
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                console.log('User doc exists:', userDoc.exists);
                
                if (!userDoc.exists) {
                    await auth.signOut();
                    showMessage('supportLoginMessage', 'User not found in database', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                console.log('User data:', userData);
                
                if (userData.role !== 'support') {
                    await auth.signOut();
                    showMessage('supportLoginMessage', 'Access denied. Support role only.', 'error');
                    return;
                }
                
                currentUser = { ...userData, uid: userCredential.user.uid, role: 'support' };
                showMessage('supportLoginMessage', 'Login successful!', 'success');
                setTimeout(() => showAdminDashboard(), 500);
            } catch (e) { 
                console.error('Login error:', e);
                showMessage('supportLoginMessage', 'Login failed: ' + e.message, 'error'); 
            }
        }

        // Teacher Login
        async function teacherLogin() {
            if (!auth || !db) { showMessage('teacherLoginMessage', 'Firebase not ready. Please refresh the page.', 'error'); return; }
            const email = document.getElementById('teacherEmail').value.trim();
            const password = document.getElementById('teacherPassword').value;
            if (!email || !password) { showMessage('teacherLoginMessage', 'Enter email and password', 'error'); return; }

            console.log('Attempting teacher login with:', email);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Authentication successful:', userCredential.user.uid);
                
                // Check scheduler_teachers collection
                const q = await db.collection('scheduler_teachers').where('email', '==', email).get();
                
                if (q.empty) { 
                    await auth.signOut(); 
                    showMessage('teacherLoginMessage', 'Not registered as a scheduler teacher', 'error'); 
                    return; 
                }
                
                currentUser = { ...q.docs[0].data(), odId: q.docs[0].id, uid: userCredential.user.uid, role: 'teacher' };
                showMessage('teacherLoginMessage', 'Login successful!', 'success');
                setTimeout(() => showTeacherDashboard(), 500);
            } catch (e) { 
                console.error('Login error:', e);
                showMessage('teacherLoginMessage', 'Login failed: ' + e.message, 'error'); 
            }
        }

        async function logout() {
            await auth.signOut();
            currentUser = null;
            document.getElementById('mainPanel').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('teacherDashboard').style.display = 'none';
        }

        // Admin Dashboard
        function showAdminDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('teacherDashboard').style.display = 'none';
            const roleLabel = currentUser.role === 'support' ? 'Support' : 'Admin';
            document.getElementById('userInfoDisplay').textContent = `${roleLabel}: ${currentUser.email || currentUser.name}`;
            loadSchedulerSettings(); loadAllStudents(); 
            loadAllTeachers().then(() => loadTeacherButtonsForAdmin()); 
            loadClassTypes().then(() => loadAllClasses()); // Load class types first, then classes
            loadProposals();
            initSalesChat(); // Initialize sales chat system
            setupPrescheduledSlotsListener(); // Setup real-time listener for prescheduled slots
            
            // Hide delete buttons and reset button for support role
            if (currentUser.role === 'support') {
                const resetBtn = document.getElementById('resetAllDataBtn');
                if (resetBtn) resetBtn.style.display = 'none';
            }
        }
        
        // Real-time listener for prescheduled slots
        let prescheduledSlotsUnsubscribe = null;
        
        function setupPrescheduledSlotsListener() {
            // Unsubscribe from previous listener if exists
            if (prescheduledSlotsUnsubscribe) {
                prescheduledSlotsUnsubscribe();
            }
            
            // Set up real-time listener
            prescheduledSlotsUnsubscribe = db.collection('prescheduled_slots').onSnapshot(snapshot => {
                allPrescheduledSlots = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Re-render the slot grid if it's visible
                const slotGridContainer = document.getElementById('slotGridContainer');
                if (slotGridContainer && slotGridContainer.offsetParent !== null) {
                    renderSlotGrid();
                }
                
                // Also update slot details modal if open
                if (selectedSlotInfo?.prescheduled) {
                    const updatedPs = allPrescheduledSlots.find(ps => ps.id === selectedSlotInfo.prescheduled.id);
                    if (updatedPs) {
                        selectedSlotInfo.prescheduled = updatedPs;
                        updateSlotEnrolledStudentsList();
                    }
                }
            }, error => {
                console.error('Error listening to prescheduled slots:', error);
            });
        }
        
        // Helper function to check if user can delete
        function canDelete() {
            return currentUser && currentUser.role === 'admin';
        }

        function showAdminTab(tab, clickedElement) {
            document.querySelectorAll('#adminDashboard .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#adminDashboard .nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            
            // Handle both click events and programmatic calls
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Programmatic call - find and activate the correct tab button
                const tabBtn = document.querySelector(`#adminDashboard .nav-tab[onclick*="${tab}"]`);
                if (tabBtn) tabBtn.classList.add('active');
            }
            
            if (tab === 'materials') loadMaterialsForLevel();
            if (tab === 'schedule') renderAdminSchedule();
            if (tab === 'absences') loadAbsencesList();
            if (tab === 'calendar') renderMonthlyCalendar();
            if (tab === 'completed') loadAdminCompletedClasses();
            if (tab === 'attendance') loadAdminAttendance();
            if (tab === 'checkin') { console.log('Check-in tab opened'); updateCheckinWeekDisplay(); loadCheckinData(); }
            if (tab === 'outreach') { loadOutreachAnalytics(); }
            if (tab === 'movehistory') { loadMoveHistory(); }
            if (tab === 'suggestions') loadAdminSuggestions();
            if (tab === 'proposals') { loadProposals(); renderAvailableStudentsForProposals(); }
            if (tab === 'ready') loadReadyRequests();
            if (tab === 'dashboard') loadTeacherButtonsForAdmin();
            if (tab === 'slotmanager') initSlotManager();
            if (tab === 'tuesdayreading') initTuesdayReadingTab();
            if (tab === 'accounts') {
                // Smart loading - use cache if available, otherwise show load controls
                if (shopifyCustomersCache && shopifyCustomersCacheTime) {
                    loadShopifyCustomersForAccounts(); // Will use cache
                }
                // If no cache, just show the load controls (don't auto-load)
            }
        }

        // Teacher Dashboard
        function showTeacherDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('teacherDashboard').style.display = 'block';
            document.getElementById('userInfoDisplay').textContent = `Teacher: ${currentUser.name}`;
            
            // Load class types first, then settings and classes
            loadClassTypes().then(() => {
                // Load settings FIRST, then load classes (so currentWeek is correct)
                loadSchedulerSettings().then(() => {
                    checkWeek6Reminder();
                    loadTeacherClasses(); 
                    loadAllClassesForTeacher();
                    loadAllTeachers(); // Load teachers so names show in class details
                });
            });
        }

        function showTeacherTab(tab) {
            document.querySelectorAll('#teacherDashboard .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#teacherDashboard .nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`teacherTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            event.target.classList.add('active');
            if (tab === 'materials') loadTeacherMaterials();
            if (tab === 'schedule') renderTeacherSchedule();
            if (tab === 'calendar') renderTeacherCalendar();
            if (tab === 'suggestions') loadTeacherSuggestions();
            if (tab === 'today') loadTodayClasses();
            if (tab === 'completed') loadTeacherCompletedClasses();
        }
        
        function renderTeacherCalendar() {
            const grid = document.getElementById('teacherMonthlyCalendarGrid');
            const label = document.getElementById('teacherCalendarMonthLabel');
            if (!grid || !label) return;
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[calendarMonth]} ${calendarYear} (EST)`;
            
            const today = getESTToday();
            
            let courseStart = null, courseEnd = null;
            if (schedulerSettings.startDate) {
                courseStart = parseESTDate(schedulerSettings.startDate);
                courseEnd = getCourseEndDate();
            }
            
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Build class schedule map - only for teacher's classes
            const myClasses = allClassesForTeacher.filter(c => c.teacherId === currentUser?.odId && c.status !== 'completed');
            const classDays = {};
            
            // Clear and rebuild teacher calendar class map
            teacherCalendarClassMap = {};
            
            // Helper to get week dates for a specific class based on its start date
            function getClassWeekDates(cls, weekNum) {
                if (!cls.startDate) return null;
                const classStart = parseESTDate(cls.startDate);
                const weekStart = new Date(classStart);
                weekStart.setDate(classStart.getDate() + (weekNum - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                return { start: weekStart, end: weekEnd };
            }
            
            myClasses.forEach(cls => {
                if (!cls.startDate) return; // Skip classes without start date
                
                for (let week = 1; week <= 6; week++) {
                    const weekDates = getClassWeekDates(cls, week);
                    if (!weekDates) continue;
                    
                    // Find the class day within this week
                    const dayOffset = cls.day === 'Saturday' ? 6 : 0; // Saturday = 6, Sunday = 0
                    const classDate = new Date(weekDates.start);
                    classDate.setDate(weekDates.start.getDate() + ((dayOffset - weekDates.start.getDay() + 7) % 7));
                    
                    const dateKey = `${classDate.getFullYear()}-${classDate.getMonth()}-${classDate.getDate()}`;
                    if (!classDays[dateKey]) classDays[dateKey] = [];
                    classDays[dateKey].push({ ...cls, week });
                    
                    // Also store in teacherCalendarClassMap for click handling
                    if (!teacherCalendarClassMap[dateKey]) teacherCalendarClassMap[dateKey] = [];
                    teacherCalendarClassMap[dateKey].push({ ...cls, week });
                }
            });
            
            let html = '';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            const prevMonth = new Date(calendarYear, calendarMonth, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(calendarYear, calendarMonth, day);
                const dateKey = `${calendarYear}-${calendarMonth}-${day}`;
                const dayClasses = classDays[dateKey] || [];
                
                let classes = ['calendar-day'];
                if (currentDate.getTime() === today.getTime()) classes.push('today');
                if (courseStart && currentDate.getTime() === courseStart.getTime()) classes.push('course-start');
                if (courseEnd && currentDate.getTime() === courseEnd.getTime()) classes.push('course-end');
                if (dayClasses.length > 0) classes.push('has-class');
                
                let weekNum = '';
                if (courseStart && currentDate >= courseStart && currentDate <= courseEnd) {
                    const diffDays = Math.floor((currentDate - courseStart) / (1000 * 60 * 60 * 24));
                    weekNum = `W${Math.floor(diffDays / 7) + 1}`;
                }
                
                // Add click handler for days with classes
                const clickHandler = dayClasses.length > 0 ? `onclick="openTeacherCalendarDayClasses('${dateKey}')"` : '';
                const cursorStyle = dayClasses.length > 0 ? 'cursor: pointer;' : '';
                
                html += `<div class="${classes.join(' ')}" ${clickHandler} style="${cursorStyle}">
                    <div class="calendar-day-number">${day}</div>
                    ${weekNum ? `<div class="calendar-week-label">${weekNum}</div>` : ''}
                    ${dayClasses.length > 0 ? `
                        <div>
                            ${dayClasses.map(c => `<span class="calendar-class-dot" style="background: ${getLevelColor(c.level)};" title="${LEVELS[c.level]} - ${c.time}" onclick="event.stopPropagation(); openClassDetails('${c.id}')"></span>`).join('')}
                        </div>
                        <div class="calendar-class-info">${dayClasses.length} class${dayClasses.length > 1 ? 'es' : ''}</div>
                    ` : ''}
                </div>`;
            }
            
            const remainingCells = 42 - (startDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        // Store teacher calendar class data for click handling
        let teacherCalendarClassMap = {};
        
        function openTeacherCalendarDayClasses(dateKey) {
            const dayClasses = teacherCalendarClassMap[dateKey] || [];
            if (dayClasses.length === 1) {
                openClassDetails(dayClasses[0].id);
            } else if (dayClasses.length > 1) {
                // Show modal with clickable class options (reuse the same modal as admin)
                const container = document.getElementById('calendarClassPickerList');
                container.innerHTML = dayClasses.map(c => {
                    const teacher = allTeachers.find(t => t.id === c.teacherId);
                    return `
                        <div class="calendar-class-option" onclick="closeCalendarClassPicker(); openClassDetails('${c.id}');" style="padding: 12px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #00ffff; font-size: 14px; margin-bottom: 5px;">${c.time}</div>
                                    <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: #888;">Week ${c.week || '-'}</div>
                                    ${teacher ? `<div style="font-size: 11px; color: #39ff14;">ðŸ‘¨â€ðŸ« ${teacher.name}</div>` : ''}
                                    <div style="font-size: 11px; color: #ffff00;">${(c.students || []).length} students</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('calendarClassPickerModal').classList.add('active');
            }
        }
        
        // Load all classes for teacher schedule view
        let allClassesForTeacher = [];
        async function loadAllClassesForTeacher() {
            try {
                const snap = await db.collection('scheduler_classes').get();
                allClassesForTeacher = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { console.error(e); }
        }

        // Load Data
        async function loadSchedulerSettings() {
            try {
                const doc = await db.collection('scheduler_settings').doc('main').get();
                if (doc.exists) schedulerSettings = { ...schedulerSettings, ...doc.data() };
                updateWeekTrackers();
                if (currentUser?.role === 'admin' || currentUser?.role === 'support') {
                    document.getElementById('settingMinStudents').value = schedulerSettings.minStudents;
                    document.getElementById('settingMaxStudents').value = schedulerSettings.maxStudents;
                    document.getElementById('settingCurrentWeek').value = schedulerSettings.currentWeek;
                    if (schedulerSettings.startDate) {
                        document.getElementById('settingStartDate').value = schedulerSettings.startDate;
                    }
                    
                    // Update display values
                    const displayMin = document.getElementById('displayMinStudents');
                    const displayMax = document.getElementById('displayMaxStudents');
                    if (displayMin) displayMin.textContent = schedulerSettings.minStudents;
                    if (displayMax) displayMax.textContent = schedulerSettings.maxStudents;
                    
                    renderCourseCalendar();
                }
            } catch (e) { console.error(e); }
        }

        function updateWeekTrackers() {
            const html = Array.from({ length: 6 }, (_, i) => {
                const w = i + 1;
                const dateStr = getWeekDateString(w);
                return `<button class="week-btn ${w === schedulerSettings.currentWeek ? 'current' : ''} ${w < schedulerSettings.currentWeek ? 'completed' : ''}" onclick="setCurrentWeek(${w})" title="${dateStr}">Week ${w}${dateStr ? `<br><span style="font-size: 10px;">${dateStr}</span>` : ''}</button>`;
            }).join('');
            ['dashboardWeekTracker', 'classesWeekTracker', 'teacherWeekTracker'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = html; });
        }
        
        function getWeekDateString(weekNum) {
            if (!schedulerSettings.startDate) return '';
            const start = new Date(schedulerSettings.startDate + 'T00:00:00');
            const weekStart = new Date(start);
            weekStart.setDate(start.getDate() + (weekNum - 1) * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
            return `${formatDate(weekStart)}-${formatDate(weekEnd)}`;
        }
        
        function getWeekDates(weekNum) {
            if (!schedulerSettings.startDate) return null;
            const start = parseESTDate(schedulerSettings.startDate);
            const weekStart = new Date(start);
            weekStart.setDate(start.getDate() + (weekNum - 1) * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return { start: weekStart, end: weekEnd };
        }
        
        function getCourseEndDate() {
            if (!schedulerSettings.startDate) return null;
            const start = parseESTDate(schedulerSettings.startDate);
            const end = new Date(start);
            end.setDate(start.getDate() + (6 * 7) - 1); // 6 weeks
            return end;
        }
        
        function renderCourseCalendar() {
            const container = document.getElementById('courseCalendarGrid');
            if (!container) return;
            
            if (!schedulerSettings.startDate) {
                container.innerHTML = '<p style="color: #888; font-size: 12px; grid-column: 1/-1;">Set a start date above to see the course calendar.</p>';
                return;
            }
            
            const today = getESTToday();
            
            const startDate = parseESTDate(schedulerSettings.startDate);
            const endDate = getCourseEndDate();
            
            // Summary section
            const formatFullDate = (d) => d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            
            let html = `
                <div class="course-dates-summary" style="grid-column: 1/-1;">
                    <div class="course-date-item">
                        <div class="course-date-label">ðŸ“… COURSE START</div>
                        <div class="course-date-value">${formatFullDate(startDate)}</div>
                    </div>
                    <div class="course-date-item">
                        <div class="course-date-label">ðŸ COURSE END</div>
                        <div class="course-date-value end">${formatFullDate(endDate)}</div>
                    </div>
                </div>
            `;
            
            // Week cards
            for (let w = 1; w <= 6; w++) {
                const weekDates = getWeekDates(w);
                const isPast = weekDates.end < today;
                const isCurrent = w === schedulerSettings.currentWeek;
                const isFuture = weekDates.start > today;
                
                let status = 'Upcoming';
                if (isPast) status = 'âœ“ Completed';
                else if (isCurrent) status = 'â–¶ CURRENT WEEK';
                
                const formatShortDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                html += `
                    <div class="week-date-card ${isCurrent ? 'current' : ''} ${isPast ? 'past' : ''} ${isFuture ? 'future' : ''}">
                        <div class="week-date-number">Week ${w}</div>
                        <div class="week-date-range">${formatShortDate(weekDates.start)} - ${formatShortDate(weekDates.end)}</div>
                        <div class="week-date-status">${status}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function setCurrentWeek(w) {
            schedulerSettings.currentWeek = w;
            await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
            updateWeekTrackers();
            if (currentUser?.role === 'admin' || currentUser?.role === 'support') {
                renderCourseCalendar();
                renderAdminSchedule();
            }
            if (currentUser?.role === 'teacher') {
                loadTeacherClasses();
                renderTeacherSchedule();
            }
        }

        async function loadAllStudents() {
            console.log('Loading all students...');
            try {
                // Simple query without orderBy to avoid index requirements
                const snap = await db.collection('scheduler_students').get();
                console.log('Students snapshot:', snap.size, 'documents');
                allStudents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Sort locally by createdAt if available
                allStudents.sort((a, b) => {
                    const aTime = a.createdAt?.toDate?.() || new Date(0);
                    const bTime = b.createdAt?.toDate?.() || new Date(0);
                    return bTime - aTime;
                });
                
                console.log('Loaded students:', allStudents.length);
                renderStudentsTable(); 
                updateDashboardStats();
            } catch (e) { 
                console.error('Error loading students:', e); 
                document.getElementById('studentsTableBody').innerHTML = `<tr><td colspan="9" style="color: #ff3366;">Error loading: ${e.message}</td></tr>`;
            }
        }

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            // Only show students that are NOT assigned, proposed, or completed
            const unassignedStudents = allStudents.filter(s => s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed');
            
            if (unassignedStudents.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #888;">No unassigned students. All students are in classes, proposals, or completed.</td></tr>'; 
                return; 
            }
            tbody.innerHTML = unassignedStudents.map(s => {
                // Check if student has availability set (supports both classTime and legacy availabilities)
                const avail = s.availabilities || {};
                const hasAvailability = s.classTime || avail[1] || avail[2] || avail[3];
                const availButton = hasAvailability 
                    ? `<button class="btn btn-sm btn-info" onclick="showStudentAvailability('${s.id}', '${s.name.replace(/'/g, "\\'")}')">ðŸ• View</button>`
                    : '<span style="color: #888; font-size: 11px;">Not set</span>';
                
                return `
                <tr>
                    <td>${s.name}</td>
                    <td style="font-size: 11px;">${s.email}</td>
                    <td>${s.city || ''}, ${s.state || ''}</td>
                    <td style="font-size: 11px;">${s.timezone || 'N/A'}</td>
                    <td>${availButton}</td>
                    <td>
                        ${s.videoUrl ? `<button class="btn btn-sm btn-info" onclick="playStudentVideo('${s.videoUrl}', '${s.name}')" title="Watch pronunciation video">ðŸŽ¬ Watch</button>` : '<span style="color: #888; font-size: 11px;">No video</span>'}
                    </td>
                    <td>${s.level ? `<span class="level-badge level-${s.level}">${LEVELS[s.level]}</span>` : '<span style="color: #888;">Not assigned</span>'}</td>
                    <td><span class="status-badge status-${s.status}">${s.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="openLevelModal('${s.id}', '${s.name}', '${s.level || ''}')">ðŸ“</button>
                        <button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteStudent('${s.id}')" ${canDelete() ? '' : 'style="display:none;"'}>ðŸ—‘ï¸</button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        function showStudentAvailability(studentId, studentName) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const avail = student.availabilities || {};
            const hasLegacyAvail = avail[1] || avail[2] || avail[3];
            
            // Build time slot options
            const TIME_SLOTS = ['6:30 PM', '7:10 PM', '7:50 PM', '8:30 PM', '9:10 PM', '9:50 PM', '10:30 PM', '11:10 PM'];
            const DAYS = ['Saturday', 'Sunday'];
            let optionsHtml = '<option value="">-- Select Time --</option>';
            DAYS.forEach(day => {
                TIME_SLOTS.forEach(time => {
                    const val = day + '-' + time;
                    optionsHtml += '<option value="' + val + '">' + day + ' @ ' + time + ' EST</option>';
                });
            });
            
            let currentTime = '';
            let contentHtml;
            if (student.classTime && !hasLegacyAvail) {
                const parts = student.classTime.split('-');
                const day = parts[0];
                const time = parts.slice(1).join('-');
                currentTime = student.classTime;
                contentHtml = '<div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; border-radius: 8px; padding: 12px; margin-bottom: 15px;"><div style="font-size: 11px; color: #39ff14; margin-bottom: 5px;">ðŸ“… Current Class Time</div><div style="color: #fff; font-size: 14px;">' + day + ' @ ' + time + ' EST</div></div>';
            } else {
                contentHtml = '<div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; border-radius: 8px; padding: 12px; margin-bottom: 10px;"><div style="font-size: 11px; color: #39ff14; margin-bottom: 5px;">1st Choice (Most Preferred)</div><div style="color: #fff; font-size: 14px;">' + (avail[1] || '<span style="color: #888;">Not set</span>') + '</div></div><div style="background: rgba(0,255,255,0.2); border: 2px solid #00ffff; border-radius: 8px; padding: 12px; margin-bottom: 10px;"><div style="font-size: 11px; color: #00ffff; margin-bottom: 5px;">2nd Choice</div><div style="color: #fff; font-size: 14px;">' + (avail[2] || '<span style="color: #888;">Not set</span>') + '</div></div><div style="background: rgba(255,0,255,0.2); border: 2px solid #ff00ff; border-radius: 8px; padding: 12px; margin-bottom: 15px;"><div style="font-size: 11px; color: #ff00ff; margin-bottom: 5px;">3rd Choice</div><div style="color: #fff; font-size: 14px;">' + (avail[3] || '<span style="color: #888;">Not set</span>') + '</div></div>';
                currentTime = avail[1] || '';
            }
            
            // Add edit section
            contentHtml += '<div style="border-top: 1px solid #444; padding-top: 15px; margin-top: 10px;"><div style="font-size: 11px; color: #ff9900; margin-bottom: 8px;">âœï¸ Change Availability</div><select id="editAvailabilitySelect" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #ff9900; border-radius: 5px; color: #fff; font-size: 12px;">' + optionsHtml + '</select><button class="btn" style="width: 100%; margin-top: 10px; background: #ff9900; border-color: #ff9900; color: #000;" onclick="confirmChangeAvailability(\'' + studentId + '\', \'' + studentName.replace(/'/g, "\\'") + '\', \'' + currentTime + '\')">ðŸ’¾ Update Availability</button></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'availabilityModal';
            modal.innerHTML = '<div class="modal" style="max-width: 400px;"><button class="modal-close" onclick="document.getElementById(\'availabilityModal\').remove()">âœ•</button><h3 class="modal-title">ðŸ• ' + studentName + '\'s Availability</h3><div style="margin-top: 15px;">' + contentHtml + '</div><button class="btn btn-secondary" style="margin-top: 15px; width: 100%;" onclick="document.getElementById(\'availabilityModal\').remove()">Close</button></div>';
            document.body.appendChild(modal);
        }
        
        async function confirmChangeAvailability(studentId, studentName, currentTime) {
            const newTime = document.getElementById('editAvailabilitySelect').value;
            
            if (!newTime) {
                alert('Please select a new time slot.');
                return;
            }
            
            if (newTime === currentTime) {
                alert('The selected time is the same as the current time.');
                return;
            }
            
            const newParts = newTime.split('-');
            const newDay = newParts[0];
            const newTimeStr = newParts.slice(1).join('-');
            
            let currentDisplay = 'Not set';
            if (currentTime) {
                const currentParts = currentTime.split('-');
                currentDisplay = currentParts[0] + ' @ ' + currentParts.slice(1).join('-') + ' EST';
            }
            
            const confirmed = confirm(
                'âš ï¸ CONFIRM AVAILABILITY CHANGE\n\n' +
                'Student: ' + studentName + '\n\n' +
                'Current: ' + currentDisplay + '\n' +
                'New: ' + newDay + ' @ ' + newTimeStr + ' EST\n\n' +
                'Are you sure you want to change this student\'s availability?'
            );
            
            if (!confirmed) return;
            
            try {
                // Update in Firebase
                await db.collection('scheduler_students').doc(studentId).update({
                    classTime: newTime,
                    availabilities: firebase.firestore.FieldValue.delete()
                });
                
                // Update local data
                const studentIdx = allStudents.findIndex(s => s.id === studentId);
                if (studentIdx !== -1) {
                    allStudents[studentIdx].classTime = newTime;
                    delete allStudents[studentIdx].availabilities;
                }
                
                alert('âœ… Availability updated successfully!');
                
                // Close modal and refresh
                document.getElementById('availabilityModal').remove();
                renderStudentsTable();
                renderLimboStudents();
                
            } catch (error) {
                console.error('Error updating availability:', error);
                alert('âŒ Error updating availability: ' + error.message);
            }
        }
        
        function playStudentVideo(videoUrl, studentName) {
            // Open modal with video player
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'videoPlayerModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <button class="modal-close" onclick="closeVideoPlayer()">âœ•</button>
                    <h3 class="modal-title">ðŸŽ¬ ${studentName}'s Pronunciation Recording</h3>
                    <div style="text-align: center; padding: 15px;">
                        <video src="${videoUrl}" controls autoplay style="width: 100%; max-width: 640px; border-radius: 8px; background: #000;"></video>
                    </div>
                    <div style="background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 10px; margin-top: 10px;">
                        <p style="font-size: 12px; color: #ffff00; margin-bottom: 5px;">ðŸ“– Expected to read:</p>
                        <p style="font-size: 13px; color: #888;">"í™©í˜¼ì´ ì§ˆ ë¬´ë µ, ë‚¡ì€ ì•„íŒŒíŠ¸ ë‹¨ì§€ ë†€ì´í„° ë²¤ì¹˜ì—ëŠ” ì–¸ì œë‚˜ ê°™ì€ í’ê²½ì´ íŽ¼ì³ì¡Œë‹¤..."</p>
                        <p style="font-size: 13px; color: #ff9900; margin-top: 10px;">If they said <strong style="color: #00ffff;">"I do not know how to read Korean"</strong> â†’ Absolute Beginner level</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeVideoPlayer() {
            const modal = document.getElementById('videoPlayerModal');
            if (modal) modal.remove();
        }

        function updateDashboardStats() {
            document.getElementById('statTotalStudents').textContent = allStudents.length;
            document.getElementById('statAssignedStudents').textContent = allStudents.filter(s => s.status === 'assigned').length;
            document.getElementById('statPendingStudents').textContent = allStudents.filter(s => !s.level && s.status !== 'assigned' && s.status !== 'completed').length;
            // Limbo count includes students with status 'limbo' OR students with a level who aren't assigned/completed/proposed
            document.getElementById('statLimboStudents').textContent = allStudents.filter(s => 
                s.status === 'limbo' || 
                (s.level && s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed')
            ).length;
            document.getElementById('statTotalClasses').textContent = allClasses.filter(c => c.status !== 'completed').length;
        }

        async function loadAllTeachers() {
            try {
                const snap = await db.collection('scheduler_teachers').get();
                allTeachers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTeachersList();
            } catch (e) { console.error(e); }
        }

        function renderTeachersList() {
            const container = document.getElementById('teachersListContainer');
            if (allTeachers.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 12px;">No teachers yet.</p>'; return; }
            container.innerHTML = allTeachers.map(t => {
                const tc = allClasses.filter(c => c.teacherId === t.id);
                return `<div class="teacher-card"><div class="teacher-name">ðŸ‘¨â€ðŸ« ${t.name}</div><div class="teacher-classes">ðŸ“§ ${t.email}<br>ðŸ“… ${(t.availableDays || []).join(', ')}<br>ðŸ“š ${tc.length} classes</div>${canDelete() ? `<button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteTeacher('${t.id}')" style="margin-top: 10px;">ðŸ—‘ï¸</button>` : ''}</div>`;
            }).join('');
        }

        // ==================== CLASS TYPE MANAGEMENT ====================
        
        async function loadClassTypes() {
            try {
                const snap = await db.collection('scheduler_class_types').get();
                allClassTypes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Merge custom class types with default levels
                LEVELS = { ...DEFAULT_LEVELS };
                allClassTypes.forEach(ct => {
                    LEVELS[ct.id] = ct.name;
                    CLASS_TYPE_COLORS[ct.id] = ct.color || '#ff00ff';
                    CLASS_TYPE_WEEKS[ct.id] = ct.weeks || 6;
                    if (!LEVEL_PRIORITY.includes(ct.id)) {
                        LEVEL_PRIORITY.push(ct.id);
                    }
                });
                
                // Update displays
                updateClassTypesDisplay();
                updateClassTypeSelects();
                updateLevelStyles();
                
            } catch (e) { 
                console.error('Error loading class types:', e); 
            }
        }
        
        function updateClassTypesDisplay() {
            const display = document.getElementById('classTypesDisplay');
            if (display) {
                const allTypes = Object.entries(LEVELS).map(([id, name]) => {
                    const color = CLASS_TYPE_COLORS[id] || '#888';
                    return `<span style="color: ${color}; margin-right: 10px;">${name}</span>`;
                }).join('');
                display.innerHTML = allTypes || 'None';
            }
        }
        
        function updateClassTypeSelects() {
            // Update Add Class modal select
            const addClassType = document.getElementById('addClassType');
            if (addClassType) {
                addClassType.innerHTML = '<option value="">-- Select Class Type --</option>' + 
                    Object.entries(LEVELS).map(([id, name]) => 
                        `<option value="${id}">${name}</option>`
                    ).join('');
            }
            
            // Update level select in assign level modal
            const levelSelect = document.getElementById('levelSelect');
            if (levelSelect) {
                const currentValue = levelSelect.value;
                levelSelect.innerHTML = '<option value="">-- Select --</option>' + 
                    Object.entries(LEVELS).map(([id, name]) => 
                        `<option value="${id}">${name}</option>`
                    ).join('');
                levelSelect.value = currentValue;
            }
            
            // Update material level selects (don't need "-- Select --")
            const materialLevelSelect = document.getElementById('materialLevelSelect');
            if (materialLevelSelect) {
                const currentValue = materialLevelSelect.value;
                materialLevelSelect.innerHTML = Object.entries(LEVELS).map(([id, name]) => 
                    `<option value="${id}">${name}</option>`
                ).join('');
                if (currentValue && LEVELS[currentValue]) {
                    materialLevelSelect.value = currentValue;
                }
            }
            
            const teacherMaterialLevel = document.getElementById('teacherMaterialLevel');
            if (teacherMaterialLevel) {
                const currentValue = teacherMaterialLevel.value;
                teacherMaterialLevel.innerHTML = Object.entries(LEVELS).map(([id, name]) => 
                    `<option value="${id}">${name}</option>`
                ).join('');
                if (currentValue && LEVELS[currentValue]) {
                    teacherMaterialLevel.value = currentValue;
                }
            }
            
            // Update other level selects throughout the app with data-level-select attribute
            document.querySelectorAll('select[data-level-select]').forEach(select => {
                if (select.id === 'levelSelect' || select.id === 'materialLevelSelect' || select.id === 'teacherMaterialLevel' || select.id === 'addClassType') return; // Already handled
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select --</option>' + 
                    Object.entries(LEVELS).map(([id, name]) => 
                        `<option value="${id}">${name}</option>`
                    ).join('');
                select.value = currentValue;
            });
        }
        
        function updateLevelStyles() {
            // Dynamically add CSS for custom class type badges
            let styleEl = document.getElementById('dynamicLevelStyles');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamicLevelStyles';
                document.head.appendChild(styleEl);
            }
            
            let css = '';
            Object.entries(CLASS_TYPE_COLORS).forEach(([id, color]) => {
                css += `.level-${id} { border-color: ${color}; color: ${color}; background: ${color}20; }\n`;
            });
            styleEl.textContent = css;
        }
        
        function openAddClassTypeModal() {
            document.getElementById('classTypeId').value = '';
            document.getElementById('classTypeName').value = '';
            document.getElementById('classTypeWeeks').value = '6';
            document.getElementById('classTypeDescription').value = '';
            document.querySelector('input[name="classTypeColor"][value="#ff00ff"]').checked = true;
            
            // Show existing class types
            renderExistingClassTypes();
            
            document.getElementById('addClassTypeModal').classList.add('active');
        }
        
        function renderExistingClassTypes() {
            const container = document.getElementById('existingClassTypesList');
            if (!container) return;
            
            const customTypes = allClassTypes;
            if (customTypes.length === 0) {
                container.innerHTML = '<p style="color: #666;">No custom class types yet. Default types: Absolute Beginner, Novice, Beginner, Advanced Beginner</p>';
                return;
            }
            
            container.innerHTML = customTypes.map(ct => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px; margin-bottom: 5px;">
                    <span style="color: ${ct.color || '#fff'};">${ct.name} (${ct.id})</span>
                    <button class="btn btn-sm" style="background: #ff3366; padding: 3px 8px; font-size: 10px;" onclick="deleteClassType('${ct.id}')">ðŸ—‘ï¸</button>
                </div>
            `).join('');
        }
        
        async function saveClassType() {
            const id = document.getElementById('classTypeId').value.trim();
            const name = document.getElementById('classTypeName').value.trim();
            const weeks = parseInt(document.getElementById('classTypeWeeks').value) || 6;
            const description = document.getElementById('classTypeDescription').value.trim();
            const color = document.querySelector('input[name="classTypeColor"]:checked')?.value || '#ff00ff';
            
            if (!id || !name) {
                alert('Please fill in the Class Type ID and Display Name');
                return;
            }
            
            if (DEFAULT_LEVELS[id]) {
                alert('This ID is reserved for a default level. Please choose a different ID.');
                return;
            }
            
            try {
                await db.collection('scheduler_class_types').doc(id).set({
                    name,
                    color,
                    weeks,
                    description,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`Class type "${name}" created successfully!`);
                await loadClassTypes();
                renderExistingClassTypes();
                
                // Clear form
                document.getElementById('classTypeId').value = '';
                document.getElementById('classTypeName').value = '';
                document.getElementById('classTypeDescription').value = '';
                
            } catch (e) {
                console.error('Error saving class type:', e);
                alert('Error creating class type: ' + e.message);
            }
        }
        
        async function deleteClassType(id) {
            if (!confirm(`Are you sure you want to delete this class type? This won't delete existing classes of this type.`)) return;
            
            try {
                await db.collection('scheduler_class_types').doc(id).delete();
                alert('Class type deleted');
                await loadClassTypes();
                renderExistingClassTypes();
            } catch (e) {
                console.error('Error deleting class type:', e);
                alert('Error: ' + e.message);
            }
        }
        
        function openAddClassModal() {
            // Populate teachers dropdown
            const teacherSelect = document.getElementById('addClassTeacher');
            teacherSelect.innerHTML = '<option value="">-- No Teacher --</option>' + 
                allTeachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            
            // Update class types dropdown
            updateClassTypeSelects();
            
            // Clear form
            document.getElementById('addClassType').value = '';
            document.getElementById('addClassDay').value = '';
            document.getElementById('addClassTime').value = '';
            document.getElementById('addClassStartDate').value = '';
            document.getElementById('addClassTeacher').value = '';
            document.getElementById('addClassMaxStudents').value = '10';
            
            document.getElementById('addClassModal').classList.add('active');
        }
        
        async function saveNewClass() {
            const level = document.getElementById('addClassType').value;
            const day = document.getElementById('addClassDay').value;
            const time = document.getElementById('addClassTime').value;
            const startDate = document.getElementById('addClassStartDate').value;
            const teacherId = document.getElementById('addClassTeacher').value || null;
            const maxStudents = parseInt(document.getElementById('addClassMaxStudents').value) || 10;
            
            if (!level || !day || !time || !startDate) {
                alert('Please fill in all required fields (Class Type, Day, Time, Start Date)');
                return;
            }
            
            try {
                const classData = {
                    level,
                    day,
                    time,
                    startDate,
                    teacherId,
                    maxStudents,
                    students: [],
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdManually: true
                };
                
                const docRef = await db.collection('scheduler_classes').add(classData);
                
                alert(`Class created successfully! ID: ${docRef.id}`);
                closeModal('addClassModal');
                await loadAllClasses();
                
            } catch (e) {
                console.error('Error creating class:', e);
                alert('Error creating class: ' + e.message);
            }
        }
        
        function getLevelColor(level) {
            return CLASS_TYPE_COLORS[level] || '#888';
        }
        
        function getLevelWeeks(level) {
            return CLASS_TYPE_WEEKS[level] || 6;
        }

        async function loadAllClasses() {
            try {
                const snap = await db.collection('scheduler_classes').get();
                allClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Also load prescheduled slots
                const prescheduledSnap = await db.collection('prescheduled_slots').get();
                allPrescheduledSlots = prescheduledSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                renderClasses(); renderLimboStudents(); updateDashboardStats();
            } catch (e) { console.error(e); }
        }

        function renderClasses() {
            const container = document.getElementById('classesContainer');
            // Only show active classes, not completed
            const activeClasses = allClasses.filter(c => c.status !== 'completed');
            
            let html = '';
            
            // Show active classes first
            if (activeClasses.length > 0) {
                html += activeClasses.map(c => {
                    const teacher = allTeachers.find(t => t.id === c.teacherId);
                    const available = getAvailableTeachers(c.day, c.time, c.id);
                    const startDateStr = c.startDate ? new Date(c.startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const canEditDate = currentUser?.role === 'admin' || currentUser?.role === 'support';
                    return `
                        <div class="class-card" ondragover="event.preventDefault()" ondrop="handleDrop(event, '${c.id}')">
                            <div class="class-header">
                                <div>
                                    <div class="class-day">${c.day}</div>
                                    <div class="class-time">${c.time} EST</div>
                                    ${canEditDate ? `
                                        <div style="font-size: 11px; color: #ffff00; margin-top: 3px; cursor: pointer; text-decoration: underline;" onclick="openEditStartDateModal('${c.id}', '${c.startDate || ''}', '${c.day}', '${c.time}', '${c.level}')" title="Click to edit start date">
                                            ðŸ“… Starts: ${startDateStr}
                                        </div>
                                    ` : `
                                        <div style="font-size: 11px; color: #ffff00; margin-top: 3px;">ðŸ“… Starts: ${startDateStr}</div>
                                    `}
                                </div>
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            </div>
                            <div class="student-list">${(c.students || []).map(s => `<div class="student-chip"><span class="rank-dot rank-${s.rank}"></span>${s.name}</div>`).join('')}</div>
                            <div style="margin-top: 10px; font-size: 11px; color: #888;">${(c.students || []).length} students</div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                ${teacher ? `<div style="color: #39ff14; font-size: 12px;">ðŸ‘¨â€ðŸ« ${teacher.name}</div><button class="btn btn-sm btn-warning" onclick="unassignTeacher('${c.id}')" style="margin-top: 5px;">Remove</button>` : `<div style="font-size: 11px; color: #888; margin-bottom: 5px;">Teachers:</div><div style="display: flex; gap: 5px; flex-wrap: wrap;">${available.length > 0 ? available.map(t => `<button class="assign-btn" onclick="assignTeacherToClass('${t.id}', '${c.id}')">${t.name}</button>`).join('') : '<span style="color: #ff3366; font-size: 11px;">None</span>'}</div>`}
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-success" onclick="markCourseComplete('${c.id}')" style="flex: 1;">ðŸŽ“ Complete</button>
                                <button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteClass('${c.id}')" title="Delete Class" ${canDelete() ? '' : 'style="display:none;"'}>ðŸ—‘ï¸</button>
                            </div>
                            <div class="drop-zone">Drop student here</div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show prescheduled slots at the bottom
            if (allPrescheduledSlots && allPrescheduledSlots.length > 0) {
                html += '<div style="margin-top: 20px;"><h4 style="color: #ff9800; margin-bottom: 10px; font-size: 13px;">â³ Pre-scheduled Classes</h4>';
                html += '<div style="display: grid; gap: 10px;">';
                html += allPrescheduledSlots.map(ps => {
                    const startDate = ps.startDate ? new Date(ps.startDate + 'T00:00:00') : null;
                    const startDateStr = startDate ? startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const classTypeName = LEVELS[ps.classType] || ps.classType || 'Class';
                    
                    // Calculate days until start
                    let daysUntilStart = '';
                    if (startDate) {
                        const now = new Date();
                        const diffTime = startDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysUntilStart = `<span style="color: #ffff00;">(in ${diffDays} day${diffDays > 1 ? 's' : ''})</span>`;
                        } else if (diffDays === 0) {
                            daysUntilStart = '<span style="color: #39ff14;">(Today!)</span>';
                        }
                    }
                    
                    return `
                        <div class="class-card" style="border: 2px solid #ff9800; background: rgba(255,152,0,0.1);">
                            <div class="class-header">
                                <div>
                                    <div class="class-day" style="color: #ff9800;">${ps.day}</div>
                                    <div class="class-time">${ps.time} EST</div>
                                    <div style="font-size: 11px; color: #ff9800; margin-top: 3px;">ðŸ“… Starts: ${startDateStr} ${daysUntilStart}</div>
                                </div>
                                <span class="level-badge level-${ps.classType}" style="border-color: #ff9800;">${classTypeName}</span>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; margin-top: 10px;">
                                <span style="color: #ff9800; font-size: 12px;">â³ Pre-scheduled - No students yet</span>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                <div style="color: #39ff14; font-size: 12px;">ðŸ‘¨â€ðŸ« ${ps.teacherName || 'Unassigned'}</div>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-warning" onclick="convertPrescheduleToClass('${ps.id}')" style="flex: 1;">ðŸ“š Create Class</button>
                                <button class="btn btn-sm btn-danger" onclick="deletePreschedule('${ps.id}')" title="Cancel Pre-schedule">âŒ</button>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div></div>';
            }
            
            if (activeClasses.length === 0 && (!allPrescheduledSlots || allPrescheduledSlots.length === 0)) {
                html = '<p style="color: #888; font-size: 12px;">No active classes yet.</p>';
            }
            
            container.innerHTML = html;
        }

        function renderLimboStudents() {
            const container = document.getElementById('limboContainer');
            // Include students with status 'limbo' OR students with a level who aren't assigned/completed/proposed
            const limbo = allStudents.filter(s => 
                s.status === 'limbo' || 
                (s.level && s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed')
            );
            if (limbo.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 12px;">No students in limbo.</p>'; return; }
            container.innerHTML = limbo.map(s => {
                const avail = s.availabilities || {};
                const hasLegacyAvail = avail[1] || avail[2] || avail[3];
                const isReturning = s.isReturningStudent ? '<span style="background: #ff9900; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">RETURNING</span>' : '';
                const needsLevel = !s.level ? '<span style="background: #ff3366; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">NEEDS CLASS</span>' : '';
                
                let availHtml;
                if (s.classTime && !hasLegacyAvail) {
                    const parts = s.classTime.split('-');
                    availHtml = '<span class="avail-tag pref-1">' + parts[0] + ' @ ' + parts.slice(1).join('-') + '</span>';
                } else if (hasLegacyAvail) {
                    availHtml = (avail[1] ? '<span class="avail-tag pref-1">1st: ' + avail[1] + '</span>' : '') + (avail[2] ? '<span class="avail-tag pref-2">2nd: ' + avail[2] + '</span>' : '') + (avail[3] ? '<span class="avail-tag pref-3">3rd: ' + avail[3] + '</span>' : '');
                } else {
                    availHtml = '<span style="color: #888; font-size: 11px;">No availability set</span>';
                }
                
                return `
                <div class="limbo-student" draggable="true" ondragstart="draggedStudentId='${s.id}'; document.querySelectorAll('.drop-zone').forEach(z=>z.classList.add('active'));" ondragend="draggedStudentId=null; document.querySelectorAll('.drop-zone').forEach(z=>z.classList.remove('active'));">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="color: #00ffff; margin-bottom: 5px;">${s.name}${isReturning}${needsLevel}</div>
                        <button class="btn btn-sm" style="background: #ff9800; color: #000; padding: 2px 6px; font-size: 10px;" onclick="event.stopPropagation(); returnToAccountCreation('${s.id}', '${s.name.replace(/'/g, "\\'")}')">â†©ï¸ Return</button>
                    </div>
                    ${s.level ? `<span class="level-badge level-${s.level}">${LEVELS[s.level]}</span>` : '<span style="color: #888; font-size: 11px;">No class assigned</span>'}
                    <div class="limbo-availability">
                        ${availHtml}
                    </div>
                </div>
            `}).join('');
        }
        
        async function returnToAccountCreation(studentId, studentName) {
            if (!confirm(`Return "${studentName}" to Account Creation?\n\nThis will remove them from the scheduler and they will need to be re-added.`)) return;
            
            try {
                // Delete from scheduler_students collection
                await db.collection('scheduler_students').doc(studentId).delete();
                
                // Remove from local array
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) allStudents.splice(idx, 1);
                
                renderStudentsTable();
                renderLimboStudents();
                updateDashboardStats();
                
                alert(`âœ… ${studentName} has been returned to Account Creation.`);
            } catch (e) {
                console.error('Error returning student:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function convertPrescheduleToClass(prescheduleId) {
            const ps = allPrescheduledSlots.find(p => p.id === prescheduleId);
            if (!ps) return;
            
            if (!confirm(`Create actual class from pre-scheduled slot?\n\n${ps.day} @ ${ps.time}\n${LEVELS[ps.classType] || ps.classType}\nTeacher: ${ps.teacherName}\n\nYou can then add students to this class.`)) return;
            
            try {
                // Create the class
                const classData = {
                    day: ps.day,
                    time: ps.time,
                    level: ps.classType,
                    teacherId: ps.teacherId,
                    startDate: ps.startDate,
                    students: [],
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const ref = await db.collection('scheduler_classes').add(classData);
                allClasses.push({ id: ref.id, ...classData });
                
                // Delete the prescheduled slot
                await db.collection('prescheduled_slots').doc(prescheduleId).delete();
                const idx = allPrescheduledSlots.findIndex(p => p.id === prescheduleId);
                if (idx !== -1) allPrescheduledSlots.splice(idx, 1);
                
                renderClasses();
                renderLimboStudents();
                updateDashboardStats();
                
                alert('âœ… Class created! You can now add students to it.');
                
            } catch (e) {
                console.error('Error converting preschedule:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function deletePreschedule(prescheduleId) {
            const ps = allPrescheduledSlots.find(p => p.id === prescheduleId);
            if (!ps) return;
            
            if (!confirm(`Delete pre-scheduled class?\n\n${ps.day} @ ${ps.time}\n${LEVELS[ps.classType] || ps.classType}`)) return;
            
            try {
                await db.collection('prescheduled_slots').doc(prescheduleId).delete();
                const idx = allPrescheduledSlots.findIndex(p => p.id === prescheduleId);
                if (idx !== -1) allPrescheduledSlots.splice(idx, 1);
                
                renderClasses();
                
                alert('âœ… Pre-scheduled class deleted.');
                
            } catch (e) {
                console.error('Error deleting preschedule:', e);
                alert('âŒ Error: ' + e.message);
            }
        }

        function getAvailableTeachers(day, time, excludeId) {
            return allTeachers.filter(t => {
                if (!(t.availableDays || []).includes(day)) return false;
                // Only check against ACTIVE classes (not completed ones)
                return !allClasses.find(c => c.id !== excludeId && c.teacherId === t.id && c.day === day && c.time === time && c.status !== 'completed');
            });
        }

        // Level Assignment
        function openLevelModal(id, name, level) {
            document.getElementById('modalStudentId').value = id;
            document.getElementById('modalStudentName').textContent = name;
            document.getElementById('levelSelect').value = level || '';
            document.getElementById('levelModal').classList.add('active');
        }

        function closeLevelModal() { document.getElementById('levelModal').classList.remove('active'); }
        
        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active'); 
        }

        async function assignStudentLevel() {
            const id = document.getElementById('modalStudentId').value;
            const level = document.getElementById('levelSelect').value;
            if (!level) { showMessage('levelModalMessage', 'Select a level', 'error'); return; }
            try {
                await db.collection('scheduler_students').doc(id).update({ level });
                const idx = allStudents.findIndex(s => s.id === id);
                if (idx !== -1) allStudents[idx].level = level;
                closeLevelModal(); renderStudentsTable(); updateDashboardStats();
            } catch (e) { showMessage('levelModalMessage', 'Error: ' + e.message, 'error'); }
        }

        async function deleteStudent(id) {
            if (!confirm('Delete this student?')) return;
            await db.collection('scheduler_students').doc(id).delete();
            allStudents = allStudents.filter(s => s.id !== id);
            renderStudentsTable(); updateDashboardStats();
        }

        // Teacher Management
        async function addNewTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            const email = document.getElementById('newTeacherEmail').value.trim();
            const password = document.getElementById('newTeacherPassword').value;
            if (!name || !email || !password) { showMessage('addTeacherMessage', 'Fill all fields', 'error'); return; }

            if (password.length < 6) { showMessage('addTeacherMessage', 'Password must be at least 6 characters', 'error'); return; }

            const days = [];
            if (document.getElementById('teacherDaySat').checked) days.push('Saturday');
            if (document.getElementById('teacherDaySun').checked) days.push('Sunday');
            if (document.getElementById('teacherDayThu').checked) days.push('Thursday');

            try {
                console.log('Creating teacher account for:', email);
                
                // Use secondary auth to create account without logging out admin
                const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                console.log('Teacher auth account created:', userCredential.user.uid);
                
                // Sign out of secondary auth immediately
                await secondaryAuth.signOut();
                
                // Add to scheduler_teachers collection
                const ref = await db.collection('scheduler_teachers').add({ 
                    name, 
                    email, 
                    uid: userCredential.user.uid, 
                    availableDays: days, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                // Also add to users collection with teacher role
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    role: 'teacher',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                allTeachers.push({ id: ref.id, name, email, uid: userCredential.user.uid, availableDays: days });
                ['newTeacherName', 'newTeacherEmail', 'newTeacherPassword'].forEach(id => document.getElementById(id).value = '');
                renderTeachersList();
                showMessage('addTeacherMessage', 'Teacher added successfully!', 'success');
            } catch (e) { 
                console.error('Error creating teacher:', e);
                showMessage('addTeacherMessage', 'Error: ' + e.message, 'error'); 
            }
        }

        async function deleteTeacher(id) {
            if (!confirm('Delete this teacher?')) return;
            await db.collection('scheduler_teachers').doc(id).delete();
            for (const c of allClasses.filter(c => c.teacherId === id)) {
                await db.collection('scheduler_classes').doc(c.id).update({ teacherId: null });
                c.teacherId = null;
            }
            allTeachers = allTeachers.filter(t => t.id !== id);
            renderTeachersList(); renderClasses();
        }

        async function assignTeacherToClass(teacherId, classId) {
            await db.collection('scheduler_classes').doc(classId).update({ teacherId });
            const idx = allClasses.findIndex(c => c.id === classId);
            if (idx !== -1) allClasses[idx].teacherId = teacherId;
            renderClasses(); renderTeachersList();
        }

        async function unassignTeacher(classId) {
            await db.collection('scheduler_classes').doc(classId).update({ teacherId: null });
            const idx = allClasses.findIndex(c => c.id === classId);
            if (idx !== -1) allClasses[idx].teacherId = null;
            renderClasses(); renderTeachersList();
        }

        // Auto-Generate Classes
        let previewedClasses = [];
        let previewedLimboStudents = [];
        let selectedTeacherForAutoGen = null;
        let eligibleStudentsForAutoGen = [];
        
        function autoGenerateClasses() {
            eligibleStudentsForAutoGen = allStudents.filter(s => s.level && s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed');
            if (eligibleStudentsForAutoGen.length === 0) { alert('No eligible students with levels assigned. (Students must not be already assigned to a class)'); return; }
            
            // Reset selection
            selectedTeacherForAutoGen = null;
            previewedClasses = [];
            previewedLimboStudents = [];
            
            // Render teacher buttons
            renderTeacherSelectionButtons();
            
            // Clear preview container
            document.getElementById('classPreviewContainer').innerHTML = '<p style="color: #888; font-size: 12px;">Select a teacher above to generate class previews...</p>';
            document.getElementById('limboPreviewContainer').style.display = 'none';
            document.getElementById('selectedTeacherInfo').style.display = 'none';
            document.getElementById('generateProposalsBtn').disabled = true;
            
            document.getElementById('startDateModal').classList.add('active');
        }
        
        function renderTeacherSelectionButtons() {
            const container = document.getElementById('teacherSelectionButtons');
            if (allTeachers.length === 0) {
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">No teachers available. Please add teachers first.</p>';
                return;
            }
            
            container.innerHTML = allTeachers.map(t => {
                const days = (t.availableDays || []).join(', ') || 'No days set';
                return `
                    <button class="btn teacher-auto-gen-btn" id="teacherBtn-${t.id}" 
                            onclick="selectTeacherForAutoGen('${t.id}')"
                            style="padding: 10px 15px; background: rgba(0,0,0,0.5); border: 2px solid #888; color: #fff;">
                        <div style="font-weight: bold;">${t.name}</div>
                        <div style="font-size: 10px; color: #888;">${days}</div>
                    </button>
                `;
            }).join('');
        }
        
        function selectTeacherForAutoGen(teacherId) {
            const teacher = allTeachers.find(t => t.id === teacherId);
            if (!teacher) return;
            
            selectedTeacherForAutoGen = teacher;
            
            // Update button styles
            document.querySelectorAll('.teacher-auto-gen-btn').forEach(btn => {
                btn.style.borderColor = '#888';
                btn.style.background = 'rgba(0,0,0,0.5)';
            });
            const selectedBtn = document.getElementById(`teacherBtn-${teacherId}`);
            if (selectedBtn) {
                selectedBtn.style.borderColor = '#39ff14';
                selectedBtn.style.background = 'rgba(57,255,20,0.2)';
            }
            
            // Show selected teacher info
            document.getElementById('selectedTeacherInfo').style.display = 'block';
            document.getElementById('selectedTeacherName').textContent = teacher.name;
            document.getElementById('selectedTeacherDays').textContent = `Available: ${(teacher.availableDays || []).join(', ') || 'No days set'}`;
            
            // Generate class previews with teacher availability
            generateClassPreviewsWithTeacher(eligibleStudentsForAutoGen, teacher);
        }
        
        function generateClassPreviewsWithTeacher(eligible, teacher) {
            previewedClasses = [];
            previewedLimboStudents = [];
            const assigned = new Set();
            
            // Get teacher's available days
            const teacherDays = teacher.availableDays || [];
            
            // Get teacher's existing class times (to avoid double-booking)
            const teacherBusySlots = new Set();
            const teacherBusyUntil = {}; // slot -> Date when teacher will be free
            
            allClasses.forEach(c => {
                if (c.teacherId === teacher.id && c.status !== 'completed') {
                    teacherBusySlots.add(`${c.day}-${c.time}`);
                    
                    // Calculate when this class ends (for "available soon" feature)
                    if (c.startDate) {
                        const classLevel = c.level;
                        const weeksInClass = getLevelWeeks(classLevel) || 6;
                        const startDate = new Date(c.startDate);
                        const endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + (weeksInClass * 7));
                        
                        if (!teacherBusyUntil[`${c.day}-${c.time}`] || endDate < teacherBusyUntil[`${c.day}-${c.time}`]) {
                            teacherBusyUntil[`${c.day}-${c.time}`] = endDate;
                        }
                    }
                }
            });
            
            // First pass: Find classes teacher can teach NOW
            for (const level of LEVEL_PRIORITY) {
                const levelStudents = eligible.filter(s => s.level === level && !assigned.has(s.id));
                const slotGroups = {};

                levelStudents.forEach(student => {
                    const availabilities = getStudentAvailabilities(student);
                    for (let rank = 1; rank <= 3; rank++) {
                        const slot = availabilities[rank];
                        if (slot) {
                            const [day, time] = slot.split('-');
                            
                            // Check if teacher is available on this day
                            if (!teacherDays.includes(day)) continue;
                            
                            // Check if teacher is already busy at this time
                            if (teacherBusySlots.has(slot)) continue;
                            
                            if (!slotGroups[slot]) slotGroups[slot] = { students: [], ranks: {} };
                            if (!slotGroups[slot].ranks[student.id]) {
                                slotGroups[slot].students.push(student);
                                slotGroups[slot].ranks[student.id] = rank;
                            }
                        }
                    }
                });

                for (const [slot, group] of Object.entries(slotGroups)) {
                    const unassignedInGroup = group.students.filter(s => !assigned.has(s.id));
                    if (unassignedInGroup.length >= schedulerSettings.minStudents) {
                        const classStudents = unassignedInGroup.slice(0, schedulerSettings.maxStudents);
                        const [day, time] = slot.split('-');

                        previewedClasses.push({
                            id: `preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            day,
                            time,
                            level,
                            teacherId: teacher.id,
                            teacherName: teacher.name,
                            availableNow: true,
                            availableDate: null,
                            students: classStudents.map(s => ({
                                id: s.id,
                                name: s.name,
                                email: s.email,
                                discord: s.discord || '',
                                rank: group.ranks[s.id],
                                timezone: s.timezone
                            })),
                            startDate: null
                        });

                        classStudents.forEach(s => assigned.add(s.id));
                        
                        // Mark this slot as busy for the teacher
                        teacherBusySlots.add(slot);
                    }
                }
            }
            
            // Second pass: Find classes where teacher is BUSY but will be available soon
            for (const level of LEVEL_PRIORITY) {
                const levelStudents = eligible.filter(s => s.level === level && !assigned.has(s.id));
                const slotGroups = {};

                levelStudents.forEach(student => {
                    const availabilities = getStudentAvailabilities(student);
                    for (let rank = 1; rank <= 3; rank++) {
                        const slot = availabilities[rank];
                        if (slot) {
                            const [day, time] = slot.split('-');
                            
                            // Check if teacher is available on this day
                            if (!teacherDays.includes(day)) continue;
                            
                            // Only consider slots where teacher is currently busy but will be free
                            if (!teacherBusyUntil[slot]) continue;
                            
                            if (!slotGroups[slot]) slotGroups[slot] = { students: [], ranks: {}, availableDate: teacherBusyUntil[slot] };
                            if (!slotGroups[slot].ranks[student.id]) {
                                slotGroups[slot].students.push(student);
                                slotGroups[slot].ranks[student.id] = rank;
                            }
                        }
                    }
                });

                for (const [slot, group] of Object.entries(slotGroups)) {
                    const unassignedInGroup = group.students.filter(s => !assigned.has(s.id));
                    if (unassignedInGroup.length >= schedulerSettings.minStudents) {
                        const classStudents = unassignedInGroup.slice(0, schedulerSettings.maxStudents);
                        const [day, time] = slot.split('-');

                        previewedClasses.push({
                            id: `preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            day,
                            time,
                            level,
                            teacherId: teacher.id,
                            teacherName: teacher.name,
                            availableNow: false,
                            availableDate: group.availableDate,
                            students: classStudents.map(s => ({
                                id: s.id,
                                name: s.name,
                                email: s.email,
                                discord: s.discord || '',
                                rank: group.ranks[s.id],
                                timezone: s.timezone
                            })),
                            startDate: null
                        });

                        classStudents.forEach(s => assigned.add(s.id));
                    }
                }
            }
            
            // Find limbo students
            eligible.forEach(s => {
                if (!assigned.has(s.id)) {
                    previewedLimboStudents.push(s);
                }
            });
            
            renderClassPreviews();
        }
        
        function generateClassPreviews(eligible) {
            // Legacy function - now we use generateClassPreviewsWithTeacher
            // This is kept for backward compatibility but shouldn't be called directly
            previewedClasses = [];
            previewedLimboStudents = [];
            const assigned = new Set();
            
            for (const level of LEVEL_PRIORITY) {
                const levelStudents = eligible.filter(s => s.level === level && !assigned.has(s.id));
                const slotGroups = {};

                levelStudents.forEach(student => {
                    const availabilities = getStudentAvailabilities(student);
                    for (let rank = 1; rank <= 3; rank++) {
                        const slot = availabilities[rank];
                        if (slot) {
                            if (!slotGroups[slot]) slotGroups[slot] = { students: [], ranks: {} };
                            if (!slotGroups[slot].ranks[student.id]) {
                                slotGroups[slot].students.push(student);
                                slotGroups[slot].ranks[student.id] = rank;
                            }
                        }
                    }
                });

                for (const [slot, group] of Object.entries(slotGroups)) {
                    const unassignedInGroup = group.students.filter(s => !assigned.has(s.id));
                    if (unassignedInGroup.length >= schedulerSettings.minStudents) {
                        const classStudents = unassignedInGroup.slice(0, schedulerSettings.maxStudents);
                        const [day, time] = slot.split('-');

                        previewedClasses.push({
                            id: `preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            day,
                            time,
                            level,
                            students: classStudents.map(s => ({
                                id: s.id,
                                name: s.name,
                                email: s.email,
                                discord: s.discord || '',
                                rank: group.ranks[s.id],
                                timezone: s.timezone
                            })),
                            startDate: null
                        });

                        classStudents.forEach(s => assigned.add(s.id));
                    }
                }
            }
            
            // Find limbo students
            eligible.forEach(s => {
                if (!assigned.has(s.id)) {
                    previewedLimboStudents.push(s);
                }
            });
            
            renderClassPreviews();
        }
        
        function renderClassPreviews() {
            const container = document.getElementById('classPreviewContainer');
            const limboContainer = document.getElementById('limboPreviewContainer');
            const limboList = document.getElementById('limboStudentsList');
            const generateBtn = document.getElementById('generateProposalsBtn');
            
            // Generate Saturday options for quick select
            const saturdays = getUpcomingSaturdays(5);
            
            if (previewedClasses.length === 0) {
                container.innerHTML = '<p style="color: #ff3366; font-size: 13px;">âŒ No classes can be formed with the current students. Not enough students share the same availability.</p>';
                generateBtn.disabled = true;
                return;
            }
            
            // Separate available now vs available soon
            const availableNowClasses = previewedClasses.filter(c => c.availableNow !== false);
            const availableSoonClasses = previewedClasses.filter(c => c.availableNow === false);
            
            let html = '';
            
            // Available Now section
            if (availableNowClasses.length > 0) {
                html += '<h4 style="color: #39ff14; margin-bottom: 10px; font-size: 14px;">âœ… Available Now (' + availableNowClasses.length + ' classes)</h4>';
                html += availableNowClasses.map((cls, idx) => {
                    const actualIdx = previewedClasses.indexOf(cls);
                    return renderClassPreviewCard(cls, actualIdx, saturdays, 'available');
                }).join('');
            }
            
            // Available Soon section
            if (availableSoonClasses.length > 0) {
                html += '<h4 style="color: #ff9800; margin: 20px 0 10px 0; font-size: 14px;">â³ Available Soon (' + availableSoonClasses.length + ' classes)</h4>';
                html += '<p style="font-size: 11px; color: #888; margin-bottom: 10px;">These time slots are currently occupied but will be free when the existing class ends.</p>';
                html += availableSoonClasses.map((cls, idx) => {
                    const actualIdx = previewedClasses.indexOf(cls);
                    return renderClassPreviewCard(cls, actualIdx, saturdays, 'pending');
                }).join('');
            }
            
            container.innerHTML = html;
            
            // Show limbo students if any
            if (previewedLimboStudents.length > 0) {
                limboContainer.style.display = 'block';
                limboList.innerHTML = previewedLimboStudents.map(s => `
                    <span style="display: inline-block; padding: 5px 10px; margin: 3px; background: rgba(255,51,102,0.2); border-radius: 15px; font-size: 11px; color: #ff3366;">
                        ${s.name} (${LEVELS[s.level]})
                    </span>
                `).join('');
            } else {
                limboContainer.style.display = 'none';
            }
            
            updateGenerateButtonState();
        }
        
        function getUpcomingSaturdays(count) {
            const today = getESTToday();
            
            const daysUntilSat = (6 - today.getDay() + 7) % 7 || 7;
            const nextSat = new Date(today);
            nextSat.setDate(today.getDate() + daysUntilSat);
            
            const saturdays = [];
            for (let i = 0; i < count; i++) {
                const sat = new Date(nextSat);
                sat.setDate(nextSat.getDate() + (i * 7));
                saturdays.push(sat);
            }
            return saturdays;
        }
        
        function renderClassPreviewCard(cls, idx, saturdays, status) {
            const borderColor = status === 'available' ? '#39ff14' : '#ff9800';
            const bgColor = status === 'available' ? 'rgba(57,255,20,0.1)' : 'rgba(255,152,0,0.1)';
            
            // Calculate weeks until available for pending classes
            let availabilityInfo = '';
            if (status === 'pending' && cls.availableDate) {
                const now = new Date();
                const availDate = new Date(cls.availableDate);
                const diffTime = availDate - now;
                const diffWeeks = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffWeeks <= 0) {
                    availabilityInfo = '<span style="color: #39ff14; font-size: 11px;">âœ“ Available now!</span>';
                } else if (diffWeeks === 1) {
                    availabilityInfo = '<span style="color: #ff9800; font-size: 11px;">â³ Available in ~1 week (' + availDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ')</span>';
                } else {
                    availabilityInfo = '<span style="color: #ff9800; font-size: 11px;">â³ Available in ~' + diffWeeks + ' weeks (' + availDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ')</span>';
                }
            }
            
            return `
                <div class="class-preview-card ${cls.startDate ? 'has-date' : ''}" id="preview-card-${idx}" style="border-color: ${borderColor}; background: ${bgColor};">
                    <div class="class-preview-header">
                        <div class="class-preview-info">
                            <strong>${cls.day} @ ${cls.time}</strong>
                            <span class="level-badge level-${cls.level}" style="margin-left: 10px;">${LEVELS[cls.level]}</span>
                            ${cls.teacherName ? '<span style="margin-left: 10px; font-size: 11px; color: ' + borderColor + ';">ðŸ‘¨â€ðŸ« ' + cls.teacherName + '</span>' : ''}
                        </div>
                        <span style="font-size: 12px; color: ${cls.startDate ? '#39ff14' : '#ffff00'};">
                            ${cls.startDate ? 'âœ“ Date Set' : 'âš ï¸ Select Date'}
                        </span>
                    </div>
                    
                    ${availabilityInfo ? '<div style="margin: 5px 0;">' + availabilityInfo + '</div>' : ''}
                    
                    <div class="class-preview-students">
                        ${cls.students.map(s => `
                            <span class="class-preview-student" title="Preference: ${s.rank}">
                                ${s.name} <span style="color: #888;">(#${s.rank})</span>
                            </span>
                        `).join('')}
                    </div>
                    
                    <div class="class-preview-date ${cls.startDate ? 'selected' : ''}">
                        <label>ðŸ“… Start Date:</label>
                        <input type="date" value="${cls.startDate || ''}" onchange="setPreviewClassDate(${idx}, this.value)" ${status === 'pending' && cls.availableDate ? 'min="' + cls.availableDate.toISOString().split('T')[0] + '"' : ''}>
                    </div>
                    
                    ${status === 'pending' && cls.availableDate ? renderAvailableDateButton(cls, idx) : ''}
                    
                    <div class="saturday-quick-btns">
                        ${saturdays.map(sat => {
                            const dateStr = sat.toISOString().split('T')[0];
                            const label = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            const isSelected = cls.startDate === dateStr;
                            // For pending classes, disable dates before available date
                            const isDisabled = status === 'pending' && cls.availableDate && sat < cls.availableDate;
                            if (isDisabled) {
                                return '<button type="button" class="saturday-quick-btn disabled" disabled style="opacity: 0.4; cursor: not-allowed;">' + label + '</button>';
                            }
                            return '<button type="button" class="saturday-quick-btn ' + (isSelected ? 'selected' : '') + '" onclick="setPreviewClassDate(' + idx + ', \'' + dateStr + '\')">' + label + '</button>';
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderAvailableDateButton(cls, idx) {
            const availDate = new Date(cls.availableDate);
            // Find the first Saturday on or after the available date
            const dayOfWeek = availDate.getDay();
            const daysUntilSat = (6 - dayOfWeek + 7) % 7;
            const firstAvailableSaturday = new Date(availDate);
            if (daysUntilSat === 0 && availDate.getDay() !== 6) {
                // If it's not Saturday, go to next Saturday
                firstAvailableSaturday.setDate(availDate.getDate() + 7);
            } else {
                firstAvailableSaturday.setDate(availDate.getDate() + daysUntilSat);
            }
            
            const dateStr = firstAvailableSaturday.toISOString().split('T')[0];
            const label = firstAvailableSaturday.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const isSelected = cls.startDate === dateStr;
            
            return '<div style="margin: 8px 0;">' +
                '<button type="button" class="btn ' + (isSelected ? 'btn-success' : 'btn-warning') + '" ' +
                'onclick="setPreviewClassDate(' + idx + ', \'' + dateStr + '\')" ' +
                'style="width: 100%; padding: 8px; font-size: 12px;">' +
                'ðŸ“… Schedule for ' + label + ' (First available)' +
                '</button>' +
                '</div>';
        }
        
        function getUpcomingSaturdaysHTML(proposalId, selectedDate) {
            const saturdays = getUpcomingSaturdays(5);
            return saturdays.map(sat => {
                const dateStr = sat.toISOString().split('T')[0];
                const label = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isSelected = selectedDate === dateStr;
                return `<button type="button" class="saturday-quick-btn ${isSelected ? 'selected' : ''}" onclick="updateProposalDate('${proposalId}', '${dateStr}')">${label}</button>`;
            }).join('');
        }
        
        function setPreviewClassDate(idx, date) {
            if (previewedClasses[idx]) {
                previewedClasses[idx].startDate = date;
                renderClassPreviews();
            }
        }
        
        function updateGenerateButtonState() {
            const generateBtn = document.getElementById('generateProposalsBtn');
            const allHaveDates = previewedClasses.every(cls => cls.startDate);
            generateBtn.disabled = !allHaveDates || previewedClasses.length === 0;
            
            if (!allHaveDates && previewedClasses.length > 0) {
                const missing = previewedClasses.filter(c => !c.startDate).length;
                generateBtn.textContent = `âš ï¸ ${missing} class(es) need dates`;
            } else {
                generateBtn.textContent = `âœ“ Generate ${previewedClasses.length} Proposals`;
            }
        }
        
        function closeStartDateModal() {
            document.getElementById('startDateModal').classList.remove('active');
            // Note: Don't clear previewedClasses here - confirmAutoGenerate needs it
            // It will be cleared after processing or on cancel
        }
        
        function cancelStartDateModal() {
            document.getElementById('startDateModal').classList.remove('active');
            previewedClasses = [];
            previewedLimboStudents = [];
        }
        
        async function confirmAutoGenerate() {
            // Validate all classes have dates
            const classesWithoutDates = previewedClasses.filter(c => !c.startDate);
            if (classesWithoutDates.length > 0) {
                alert(`Please select a start date for all ${classesWithoutDates.length} classes.`);
                return;
            }
            
            if (previewedClasses.length === 0) {
                alert('No classes to generate.');
                return;
            }
            
            const teacherName = selectedTeacherForAutoGen ? selectedTeacherForAutoGen.name : 'No teacher';
            if (!confirm(`Generate ${previewedClasses.length} class proposals?\n\nTeacher: ${teacherName}`)) return;
            
            // Close modal but DON'T clear data yet
            document.getElementById('startDateModal').classList.remove('active');

            try {
                const newProposals = [];

                for (const cls of previewedClasses) {
                    const proposalData = {
                        day: cls.day,
                        time: cls.time,
                        level: cls.level,
                        students: cls.students.map(s => ({ 
                            id: s.id, 
                            name: s.name, 
                            email: s.email,
                            discord: s.discord || '',
                            rank: s.rank, 
                            timezone: s.timezone,
                            response: 'pending'
                        })),
                        teacherId: cls.teacherId || null,
                        proposedStartDate: cls.startDate,
                        status: 'draft',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const ref = await db.collection('scheduler_proposals').add(proposalData);
                    newProposals.push({ id: ref.id, ...proposalData });

                    // Update student statuses
                    for (const s of cls.students) {
                        await db.collection('scheduler_students').doc(s.id).update({ status: 'proposed', proposalId: ref.id });
                        const idx = allStudents.findIndex(st => st.id === s.id);
                        if (idx !== -1) { allStudents[idx].status = 'proposed'; allStudents[idx].proposalId = ref.id; }
                    }
                }

                // Mark limbo students
                for (const s of previewedLimboStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({ status: 'limbo' });
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) allStudents[idx].status = 'limbo';
                }

                allProposals = [...allProposals, ...newProposals];
                previewedClasses = [];
                previewedLimboStudents = [];
                selectedTeacherForAutoGen = null;
                
                renderStudentsTable(); renderLimboStudents(); updateDashboardStats(); renderProposals();
                
                // Switch to Proposals tab
                showAdminTab('proposals');
                
                alert(`Created ${newProposals.length} class proposals with ${teacherName}!`);
            } catch (e) { alert('Error: ' + e.message); console.error(e); }
        }

        // Drag & Drop
        async function handleDrop(event, classId) {
            event.preventDefault();
            if (!draggedStudentId) return;

            const student = allStudents.find(s => s.id === draggedStudentId);
            const targetClass = allClasses.find(c => c.id === classId);
            if (!student || !targetClass) return;

            const warnings = [];
            if ((targetClass.students || []).length >= schedulerSettings.maxStudents) warnings.push(`Class is full (${schedulerSettings.maxStudents} max)`);
            if (student.level !== targetClass.level) warnings.push(`Level mismatch: ${LEVELS[student.level]} vs ${LEVELS[targetClass.level]}`);

            if (warnings.length > 0) {
                pendingDropAction = { studentId: draggedStudentId, classId };
                document.getElementById('warningMessage').innerHTML = warnings.join('<br>');
                document.getElementById('warningModal').classList.add('active');
            } else {
                await executeDropAction(draggedStudentId, classId);
            }
        }

        async function executeDropAction(studentId, classId) {
            const student = allStudents.find(s => s.id === studentId);
            const targetClass = allClasses.find(c => c.id === classId);

            let rank = 3;
            const classSlot = `${targetClass.day}-${targetClass.time}`;
            Object.entries(student.availabilities || {}).forEach(([r, slot]) => { if (slot === classSlot) rank = parseInt(r); });

            targetClass.students = targetClass.students || [];
            targetClass.students.push({ id: student.id, name: student.name, rank, timezone: student.timezone });

            await db.collection('scheduler_classes').doc(classId).update({ students: targetClass.students });
            await db.collection('scheduler_students').doc(studentId).update({ status: 'assigned', classId });

            const idx = allStudents.findIndex(s => s.id === studentId);
            if (idx !== -1) { allStudents[idx].status = 'assigned'; allStudents[idx].classId = classId; }

            renderClasses(); renderLimboStudents(); renderStudentsTable(); updateDashboardStats();
        }

        function closeWarningModal() { document.getElementById('warningModal').classList.remove('active'); pendingDropAction = null; }
        async function confirmWarningAction() { if (pendingDropAction) await executeDropAction(pendingDropAction.studentId, pendingDropAction.classId); closeWarningModal(); }

        // Settings
        async function saveSettings() {
            schedulerSettings.minStudents = parseInt(document.getElementById('settingMinStudents').value) || 5;
            schedulerSettings.maxStudents = parseInt(document.getElementById('settingMaxStudents').value) || 10;
            schedulerSettings.currentWeek = parseInt(document.getElementById('settingCurrentWeek').value) || 1;
            schedulerSettings.startDate = document.getElementById('settingStartDate').value || null;
            await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
            updateWeekTrackers();
            renderCourseCalendar();
            
            // Update the display values
            const displayMin = document.getElementById('displayMinStudents');
            const displayMax = document.getElementById('displayMaxStudents');
            if (displayMin) displayMin.textContent = schedulerSettings.minStudents;
            if (displayMax) displayMax.textContent = schedulerSettings.maxStudents;
            
            showMessage('settingsMessage', 'Settings saved! Classes will now require ' + schedulerSettings.minStudents + '-' + schedulerSettings.maxStudents + ' students.', 'success');
        }

        // Materials (simplified)
        async function loadMaterialsForLevel() {
            const level = document.getElementById('materialLevelSelect').value;
            const week = document.getElementById('materialWeekSelect').value;
            try {
                let snap = await db.collection('scheduler_materials').get();
                let materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Filter by level and week
                materials = materials.filter(m => m.level === level && (m.week == week || m.week === parseInt(week)));
                
                materials.sort((a, b) => (a.order || 0) - (b.order || 0));
                renderMaterials(materials);
            } catch (e) {
                console.error('Error loading materials:', e);
                document.getElementById('materialsContainer').innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error loading materials: ${e.message}</p>`;
            }
        }

        function renderMaterials(materials) {
            const container = document.getElementById('materialsContainer');
            if (materials.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 14px; font-family: Noto Sans, sans-serif;">No materials for this selection.</p>'; return; }
            
            // Store materials for drag/drop
            window.currentMaterials = materials;
            
            container.innerHTML = materials.map((m, index) => `
                <div class="material-block" draggable="true" data-id="${m.id}" data-index="${index}"
                    ondragstart="handleMaterialDragStart(event)" 
                    ondragover="handleMaterialDragOver(event)" 
                    ondragenter="handleMaterialDragEnter(event)"
                    ondragleave="handleMaterialDragLeave(event)"
                    ondrop="handleMaterialDrop(event)" 
                    ondragend="handleMaterialDragEnd(event)">
                    <div class="material-header">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span class="drag-handle" style="cursor: grab; color: #666; margin-right: 5px;">â‹®â‹®</span>
                            <span class="material-type">${m.type}</span>
                        </div>
                        <div><button class="btn btn-sm btn-info" onclick="editMaterial('${m.id}')">âœï¸</button><button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteMaterial('${m.id}')" ${canDelete() ? '' : 'style="display:none;"'}>ðŸ—‘ï¸</button></div>
                    </div>
                    <div class="material-content">${renderMaterialContent(m)}</div>
                </div>
            `).join('');
        }
        
        let draggedMaterialId = null;
        let draggedMaterialIndex = null;
        
        function handleMaterialDragStart(e) {
            draggedMaterialId = e.currentTarget.dataset.id;
            draggedMaterialIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleMaterialDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleMaterialDragEnter(e) {
            e.preventDefault();
            if (e.currentTarget.dataset.id !== draggedMaterialId) {
                e.currentTarget.style.borderTop = '3px solid #00ffff';
            }
        }
        
        function handleMaterialDragLeave(e) {
            e.currentTarget.style.borderTop = '';
        }
        
        function handleMaterialDrop(e) {
            e.preventDefault();
            e.currentTarget.style.borderTop = '';
            
            const targetId = e.currentTarget.dataset.id;
            const targetIndex = parseInt(e.currentTarget.dataset.index);
            
            if (draggedMaterialId && draggedMaterialId !== targetId) {
                reorderMaterials(draggedMaterialIndex, targetIndex);
            }
        }
        
        function handleMaterialDragEnd(e) {
            e.currentTarget.style.opacity = '1';
            // Reset all borders
            document.querySelectorAll('.material-block').forEach(el => {
                el.style.borderTop = '';
            });
            draggedMaterialId = null;
            draggedMaterialIndex = null;
        }
        
        async function reorderMaterials(fromIndex, toIndex) {
            if (!window.currentMaterials || fromIndex === toIndex) return;
            
            const materials = [...window.currentMaterials];
            const [moved] = materials.splice(fromIndex, 1);
            materials.splice(toIndex, 0, moved);
            
            // Update order in Firebase
            try {
                const batch = db.batch();
                materials.forEach((m, idx) => {
                    const ref = db.collection('scheduler_materials').doc(m.id);
                    batch.update(ref, { order: idx });
                });
                await batch.commit();
                
                // Reload to show new order
                loadMaterialsForLevel();
            } catch (e) {
                console.error('Error reordering materials:', e);
                alert('Error saving order: ' + e.message);
            }
        }

        function renderMaterialContent(m, isAdmin = true) {
            const fontStyle = "font-family: 'Noto Sans', sans-serif; font-size: 12px; line-height: 1.6;";
            if (m.type === 'text') return `<div style="${fontStyle}">${m.content || ''}</div>`;
            if (m.type === 'link') {
                const drawpadBadge = m.isDrawpad 
                    ? '<span style="background: #00ffff; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ðŸŽ¨ DRAWPAD</span>'
                    : '<span style="background: #ffff00; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ðŸ”— LINK ONLY</span>';
                return `<a href="${m.url}" target="_blank" style="${fontStyle} color: #00ffff;">${m.title || m.url}</a>${drawpadBadge}`;
            }
            if (m.type === 'image') {
                if (isAdmin) {
                    return `
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <a href="${m.url}" download style="${fontStyle} color: #ffff00;">ðŸ“¥ Download Image</a>
                            <button class="btn btn-sm btn-info" onclick="openFilePreview('${m.url}', 'image')" style="font-size: 12px;">ðŸ‘ï¸ Preview</button>
                        </div>
                        <img src="${m.url}" alt="" style="max-width: 100%; border-radius: 4px; margin-top: 10px;">
                    `;
                }
                return `<img src="${m.url}" alt="" style="max-width: 100%; border-radius: 4px;">`;
            }
            if (m.type === 'file') {
                const filename = m.filename || 'Download';
                const url = m.url || '';
                const ext = filename.toLowerCase();
                const isPdf = ext.endsWith('.pdf') || url.toLowerCase().includes('.pdf');
                const isImage = ext.match(/\.(png|jpg|jpeg|gif|webp|svg|bmp)$/i);
                
                if (isAdmin && (isPdf || isImage)) {
                    return `
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <a href="${url}" download="${filename}" style="${fontStyle} color: #ffff00;">ðŸ“¥ ${filename}</a>
                            <button class="btn btn-sm btn-info" onclick="openFilePreview('${url}', '${isPdf ? 'pdf' : 'image'}')" style="font-size: 12px;">ðŸ‘ï¸ Preview</button>
                        </div>
                    `;
                }
                return `<a href="${url}" download="${filename}" style="${fontStyle} color: #ffff00;">ðŸ“¥ ${filename}</a>`;
            }
            if (m.type === 'permutation-game') {
                return `
                    <div style="background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(103,58,183,0.2)); border: 2px solid #9c27b0; border-radius: 10px; padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">ðŸ”„</span>
                            <strong style="color: #ce93d8; font-size: 14px;">${m.title || 'Yodafy Game'}</strong>
                        </div>
                        ${m.description ? `<p style="color: #b0b0c0; font-size: 12px; margin-bottom: 10px;">${m.description}</p>` : ''}
                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #9c27b0, #673ab7); border-color: #9c27b0; color: #fff;" onclick="openPermutationGame()">
                            ðŸŽ® Launch Game
                        </button>
                        <span style="font-size: 10px; color: #888; margin-left: 10px;">Uses AI (GPT)</span>
                    </div>
                `;
            }
            return '';
        }
        
        function openFilePreview(url, type) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'filePreviewModal';
            
            let contentHtml = '';
            if (type === 'pdf') {
                contentHtml = `<iframe src="${url}" style="width: 100%; height: 70vh; border: none; border-radius: 8px; background: #fff;"></iframe>`;
            } else {
                contentHtml = `<img src="${url}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">`;
            }
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 900px; max-height: 85vh;">
                    <button class="modal-close" onclick="closeFilePreview()">âœ•</button>
                    <h3 class="modal-title">ðŸ‘ï¸ File Preview</h3>
                    <div style="margin-top: 15px; text-align: center;">
                        ${contentHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeFilePreview() {
            const modal = document.getElementById('filePreviewModal');
            if (modal) modal.remove();
        }

        // ==================== WEEKLY ATTENDANCE ====================
        let checkinCurrentWeek = getCheckinWeekOf(new Date());
        let checkinStudents = [];
        let checkinRecords = [];
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper function
        function escapeAttr(str) {
            return (str || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        // Get the Tuesday of the week for a given date
        function getCheckinWeekOf(date) {
            const d = new Date(date);
            const day = d.getDay();
            const daysToTuesday = (day < 2) ? (day + 5) : (day - 2);
            d.setDate(d.getDate() - daysToTuesday);
            d.setHours(0, 0, 0, 0);
            return d.toISOString().split('T')[0];
        }
        
        // Change week
        function changeCheckinWeek(delta) {
            const currentDate = new Date(checkinCurrentWeek + 'T00:00:00');
            currentDate.setDate(currentDate.getDate() + (delta * 7));
            checkinCurrentWeek = getCheckinWeekOf(currentDate);
            updateCheckinWeekDisplay();
            loadCheckinData();
        }
        
        // Update week display
        function updateCheckinWeekDisplay() {
            const tuesday = new Date(checkinCurrentWeek + 'T00:00:00');
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            document.getElementById('checkinWeekDisplay').textContent = 'Week of ' + tuesday.toLocaleDateString('en-US', options);
        }
        
        // Load attendance data
        async function loadCheckinData() {
            try {
                // Load all students from users collection (students with accounts)
                const studentsSnap = await db.collection('users').where('role', '==', 'student').get();
                checkinStudents = studentsSnap.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().displayName || doc.data().email?.split('@')[0] || 'Unknown',
                    email: doc.data().email || '',
                    ...doc.data()
                }));
                
                // Sort by name
                checkinStudents.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                // Load attendance records for current week
                const recordsSnap = await db.collection('attendance_records')
                    .where('weekOf', '==', checkinCurrentWeek)
                    .get();
                checkinRecords = recordsSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                renderCheckinData();
            } catch (error) {
                console.error('Error loading attendance data:', error);
            }
        }
        
        // Render attendance data
        function renderCheckinData() {
            // Build a map of studentId -> record
            const recordMap = {};
            checkinRecords.forEach(r => {
                if (r.studentId) recordMap[r.studentId] = r;
            });
            
            // Filter students by search query
            const filteredStudents = checkinStudents.filter(s => {
                if (!checkinSearchQuery) return true;
                const name = (s.name || s.displayName || s.email || '').toLowerCase();
                const discord = (s.discord || s.discordName || '').toLowerCase();
                return name.includes(checkinSearchQuery) || discord.includes(checkinSearchQuery);
            });
            
            // Stats (count all students, not filtered)
            const totalStudents = checkinStudents.length;
            const exceptionCount = checkinStudents.filter(s => s.attendanceException).length;
            const nonExceptionStudents = checkinStudents.filter(s => !s.attendanceException);
            const attended = checkinRecords.filter(r => r.studentId).length;
            const absent = nonExceptionStudents.length - nonExceptionStudents.filter(s => recordMap[s.id]).length;
            
            document.getElementById('checkinTotalStudents').textContent = totalStudents;
            document.getElementById('checkinAttended').textContent = attended;
            document.getElementById('checkinAbsent').textContent = absent;
            document.getElementById('checkinExceptions').textContent = exceptionCount;
            document.getElementById('checkinStudentCount').textContent = filteredStudents.length + (checkinSearchQuery ? ` of ${totalStudents}` : '');
            document.getElementById('checkinThisWeekCount').textContent = attended;
            
            // Render all students list (left side) - filtered
            const allStudentsHtml = filteredStudents.map(s => {
                const record = recordMap[s.id];
                const hasAttended = !!record;
                const isException = s.attendanceException === true;
                const discordDisplay = s.discord || s.discordName ? `<span style="color: #5865F2;">ðŸŽ® ${escapeHtml(s.discord || s.discordName)}</span>` : '<span style="color: #666;">ðŸŽ® No Discord</span>';
                const exceptionBadge = isException ? '<span style="background: linear-gradient(135deg, #ff9800, #ff5722); padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-left: 8px; color: #fff;">EXCEPTION</span>' : '';
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${hasAttended ? '#39ff14' : isException ? '#ff9800' : '#666'};">
                        <div style="flex: 1; cursor: pointer;" onclick="openEditStudentInfoModal('${s.id}')">
                            <div style="font-weight: 600; color: #fff; display: flex; align-items: center; flex-wrap: wrap;">
                                ${hasAttended ? '<span style="color: #39ff14;">âœ…</span>' : '<span style="color: #666;">âšª</span>'} 
                                <span style="margin-left: 4px;">${escapeHtml(s.name || s.email || 'Unknown')}</span>
                                ${exceptionBadge}
                            </div>
                            <div style="font-size: 11px; color: #888; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <span>${s.assignedTier || 'No tier'}</span>
                                <span>${discordDisplay}</span>
                            </div>
                        </div>
                        <div>
                            ${hasAttended 
                                ? '<button class="btn btn-sm" onclick="event.stopPropagation(); removeAttendance(\'' + record.id + '\')" style="font-size: 10px; padding: 3px 8px; background: #ff4444;">âœ• Remove</button>' 
                                : '<button class="btn btn-sm btn-success" onclick="event.stopPropagation(); markWeeklyAttendance(\'' + s.id + '\', \'' + escapeAttr(s.name || s.email) + '\')" style="font-size: 10px; padding: 3px 8px;">âœ“ Present</button>'
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('checkinAllStudentsList').innerHTML = allStudentsHtml || '<p style="color: #888;">No students found.</p>';
            
            // Render attended list (right side)
            const attendedStudents = checkinStudents.filter(s => recordMap[s.id]);
            const attendedHtml = attendedStudents.map(s => {
                const record = recordMap[s.id];
                const time = record.checkedInAt?.toDate ? record.checkedInAt.toDate() : new Date(record.checkedInAt);
                const timeStr = time.toLocaleString('en-US', { 
                    weekday: 'short',
                    month: 'short', 
                    day: 'numeric',
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #39ff14;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #fff;">âœ… ${escapeHtml(s.name || s.email)}</div>
                            <div style="font-size: 11px; color: #888;">${timeStr}</div>
                        </div>
                        <button class="btn btn-sm" onclick="removeAttendance('${record.id}')" style="font-size: 10px; padding: 3px 8px; background: rgba(255,68,68,0.3); color: #ff6666;">âœ•</button>
                    </div>
                `;
            }).join('');
            
            document.getElementById('checkinThisWeekList').innerHTML = attendedHtml || '<p style="color: #888;">No attendance marked yet.</p>';
            
            // Render absent list - separate exceptions from truly absent
            const absentStudents = checkinStudents.filter(s => !recordMap[s.id] && !s.attendanceException);
            const exceptionStudents = checkinStudents.filter(s => !recordMap[s.id] && s.attendanceException);
            
            const absentHtml = absentStudents.map(s => {
                return `
                    <div style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(255,255,255,0.05); border-radius: 8px; margin: 4px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s;" 
                         onclick="showStudentContactInfo('${s.id}')"
                         onmouseover="this.style.borderColor='#ff3366'; this.style.background='rgba(255,51,102,0.1)';"
                         onmouseout="this.style.borderColor='transparent'; this.style.background='rgba(255,255,255,0.05)';">
                        <span style="color: #fff; font-weight: 500;">${escapeHtml(s.name || s.email)}</span>
                        <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); markWeeklyAttendance('${s.id}', '${escapeAttr(s.name || s.email)}')" style="font-size: 10px; padding: 2px 6px;">âœ“ Present</button>
                    </div>
                `;
            }).join('');
            
            // Exception students section
            const exceptionHtml = exceptionStudents.length > 0 ? `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,152,0,0.3);">
                    <div style="font-size: 12px; color: #ff9800; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <span style="background: linear-gradient(135deg, #ff9800, #ff5722); padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #fff;">EXCEPTIONS</span>
                        <span style="color: #888;">(${exceptionStudents.length} students not required to attend)</span>
                    </div>
                    ${exceptionStudents.map(s => `
                        <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,152,0,0.1); border-radius: 8px; margin: 4px; border: 1px solid rgba(255,152,0,0.3); cursor: pointer; transition: all 0.2s;"
                             onclick="openEditStudentInfoModal('${s.id}')"
                             onmouseover="this.style.background='rgba(255,152,0,0.2)'"
                             onmouseout="this.style.background='rgba(255,152,0,0.1)'">
                            <span style="color: #ff9800; font-weight: 500;">${escapeHtml(s.name || s.email)}</span>
                            <span style="font-size: 10px; color: #888;">âœï¸ Edit</span>
                        </div>
                    `).join('')}
                </div>
            ` : '';
            
            document.getElementById('checkinAbsentList').innerHTML = (absentHtml || '<p style="color: #39ff14;">Everyone attended! ðŸŽ‰</p>') + exceptionHtml;
        }
        
        // Search/filter students in check-in
        let checkinSearchQuery = '';
        
        function filterCheckinStudents() {
            checkinSearchQuery = document.getElementById('checkinSearchInput').value.toLowerCase().trim();
            renderCheckinData();
        }
        
        // Show student contact info modal
        async function showStudentContactInfo(studentId) {
            const student = checkinStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const name = student.displayName || student.name || 'Unknown';
            const email = student.email || 'No email';
            const phone = student.phone || student.phoneNumber || 'No phone';
            const discord = student.discord || student.discordName || 'No Discord';
            
            // Load contact history for this student
            let contactHistory = [];
            try {
                const historySnap = await db.collection('attendance_contacts')
                    .where('studentId', '==', studentId)
                    .orderBy('contactDate', 'desc')
                    .limit(5)
                    .get();
                contactHistory = historySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.log('No contact history or index needed');
            }
            
            const historyHtml = contactHistory.length > 0 ? contactHistory.map(c => {
                const date = c.contactDate?.toDate ? c.contactDate.toDate() : new Date(c.contactDate);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const methodIcon = c.contactMethod === 'email' ? 'ðŸ“§' : c.contactMethod === 'phone' ? 'ðŸ“±' : 'ðŸŽ®';
                const statusColor = c.status === 'resolved' ? '#39ff14' : c.status === 'escalate' ? '#ff3366' : '#ffaa00';
                
                return `
                    <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 8px 10px; margin-bottom: 6px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; font-size: 11px;">
                            <span style="color: #888;">${dateStr} ${methodIcon}</span>
                            <span style="color: ${statusColor}; text-transform: capitalize;">${c.status || 'pending'}</span>
                        </div>
                        <div style="font-size: 12px; color: #ccc; margin-top: 4px;">${escapeHtml(c.notes || 'No notes')}</div>
                    </div>
                `;
            }).join('') : '<p style="color: #666; font-size: 11px; text-align: center;">No contact history</p>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'studentContactModal';
            modal.onclick = (e) => { if (e.target === modal) closeStudentContactModal(); };
            modal.innerHTML = `
                <div class="modal" style="max-width: 450px;">
                    <button class="modal-close" onclick="closeStudentContactModal()">âœ•</button>
                    <h3 class="modal-title">ðŸ“ž Contact Student</h3>
                    
                    <div style="background: rgba(255,51,102,0.1); border: 1px solid rgba(255,51,102,0.3); border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <div style="font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 5px;">${escapeHtml(name)}</div>
                        <div style="font-size: 12px; color: #ff6666;">Did not attend this week</div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">ðŸ“§</span>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; color: #888;">Email</div>
                                <div style="color: #00ffff; font-size: 14px;">${escapeHtml(email)}</div>
                            </div>
                            ${email !== 'No email' ? '<button class="btn btn-sm" onclick="copyToClipboard(\'' + escapeAttr(email) + '\')" style="font-size: 10px;">ðŸ“‹ Copy</button>' : ''}
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">ðŸ“±</span>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; color: #888;">Phone</div>
                                <div style="color: #39ff14; font-size: 14px;">${escapeHtml(phone)}</div>
                            </div>
                            ${phone !== 'No phone' ? '<button class="btn btn-sm" onclick="copyToClipboard(\'' + escapeAttr(phone) + '\')" style="font-size: 10px;">ðŸ“‹ Copy</button>' : ''}
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">ðŸŽ®</span>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; color: #888;">Discord</div>
                                <div style="color: #5865F2; font-size: 14px;">${escapeHtml(discord)}</div>
                            </div>
                            ${discord !== 'No Discord' ? '<button class="btn btn-sm" onclick="copyToClipboard(\'' + escapeAttr(discord) + '\')" style="font-size: 10px;">ðŸ“‹ Copy</button>' : ''}
                        </div>
                    </div>
                    
                    <!-- Contact History -->
                    <div style="margin-top: 20px;">
                        <h4 style="color: #888; font-size: 12px; margin-bottom: 10px;">ðŸ“‹ Recent Contact History</h4>
                        ${historyHtml}
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn" onclick="closeStudentContactModal(); openAddContactModal('${studentId}', '${escapeAttr(name)}', '${escapeAttr(email)}')" style="flex: 1; background: linear-gradient(135deg, #ff6b6b, #ee5a24);">ðŸ“ Log Contact</button>
                        <button class="btn btn-success" onclick="closeStudentContactModal(); markWeeklyAttendance('${studentId}', '${escapeAttr(name)}')" style="flex: 1;">âœ“ Mark Present</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeStudentContactModal() {
            const modal = document.getElementById('studentContactModal');
            if (modal) modal.remove();
        }
        
        // ==================== EDIT STUDENT INFO MODAL ====================
        async function openEditStudentInfoModal(studentId) {
            const student = checkinStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const name = student.displayName || student.name || 'Unknown';
            const email = student.email || '';
            const phone = student.phone || student.phoneNumber || '';
            const discord = student.discord || student.discordName || '';
            const isException = student.attendanceException === true;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'editStudentInfoModal';
            modal.onclick = (e) => { if (e.target === modal) closeEditStudentInfoModal(); };
            modal.innerHTML = `
                <div class="modal" style="max-width: 450px;">
                    <button class="modal-close" onclick="closeEditStudentInfoModal()">âœ•</button>
                    <h3 class="modal-title">âœï¸ Edit Student Info</h3>
                    
                    <div style="background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <div style="font-size: 18px; font-weight: 600; color: #fff;">${escapeHtml(name)}</div>
                        <div style="font-size: 12px; color: #888;">${escapeHtml(email)}</div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 5px; color: #00ffff; font-size: 12px;">ðŸŽ® Discord Username</label>
                            <input type="text" id="editStudentDiscord" value="${escapeHtml(discord)}" placeholder="e.g., username#1234 or username" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #5865F2; color: #fff; font-size: 14px;">
                            <div style="font-size: 10px; color: #888; margin-top: 4px;">Enter the student's Discord username for easy contact</div>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 5px; color: #39ff14; font-size: 12px;">ðŸ“± Phone Number</label>
                            <input type="text" id="editStudentPhone" value="${escapeHtml(phone)}" placeholder="e.g., +1 555-123-4567" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #39ff14; color: #fff; font-size: 14px;">
                        </div>
                        
                        <!-- Exception Toggle -->
                        <div class="form-group" style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 8px; padding: 12px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="editStudentException" ${isException ? 'checked' : ''} style="width: 18px; height: 18px; accent-color: #ff9800;">
                                <div>
                                    <div style="color: #ff9800; font-size: 13px; font-weight: 600;">âš ï¸ Attendance Exception</div>
                                    <div style="font-size: 10px; color: #888; margin-top: 2px;">Student is not required to attend class (won't count as absent)</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div id="editStudentMessage" style="margin-top: 15px;"></div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveStudentInfo('${studentId}')" style="flex: 1;">ðŸ’¾ Save Changes</button>
                        <button class="btn btn-secondary" onclick="closeEditStudentInfoModal()" style="flex: 1;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus on Discord input
            setTimeout(() => {
                document.getElementById('editStudentDiscord')?.focus();
            }, 100);
        }
        
        function closeEditStudentInfoModal() {
            const modal = document.getElementById('editStudentInfoModal');
            if (modal) modal.remove();
        }
        
        async function saveStudentInfo(studentId) {
            const discord = document.getElementById('editStudentDiscord').value.trim();
            const phone = document.getElementById('editStudentPhone').value.trim();
            const isException = document.getElementById('editStudentException').checked;
            const messageDiv = document.getElementById('editStudentMessage');
            
            try {
                messageDiv.innerHTML = '<div style="background: rgba(0,255,255,0.2); border: 1px solid #00ffff; padding: 10px; border-radius: 5px; color: #00ffff; font-size: 12px;">â³ Saving...</div>';
                
                // Update Firebase
                await db.collection('users').doc(studentId).update({
                    discord: discord || null,
                    discordName: discord || null,
                    phone: phone || null,
                    phoneNumber: phone || null,
                    attendanceException: isException,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local cache
                const studentIndex = checkinStudents.findIndex(s => s.id === studentId);
                if (studentIndex !== -1) {
                    checkinStudents[studentIndex].discord = discord;
                    checkinStudents[studentIndex].discordName = discord;
                    checkinStudents[studentIndex].phone = phone;
                    checkinStudents[studentIndex].phoneNumber = phone;
                    checkinStudents[studentIndex].attendanceException = isException;
                }
                
                messageDiv.innerHTML = '<div style="background: rgba(57,255,20,0.2); border: 1px solid #39ff14; padding: 10px; border-radius: 5px; color: #39ff14; font-size: 12px;">âœ… Saved successfully!</div>';
                
                // Refresh the display and close modal after delay
                setTimeout(() => {
                    closeEditStudentInfoModal();
                    renderCheckinData();
                }, 1000);
                
            } catch (error) {
                console.error('Error saving student info:', error);
                messageDiv.innerHTML = `<div style="background: rgba(255,51,102,0.2); border: 1px solid #ff3366; padding: 10px; border-radius: 5px; color: #ff3366; font-size: 12px;">âŒ Error: ${error.message}</div>`;
            }
        }
        // ==================== END EDIT STUDENT INFO MODAL ====================
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Brief visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ Copied!';
                btn.style.background = '#39ff14';
                btn.style.color = '#000';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 1500);
            }).catch(() => {
                alert('Could not copy to clipboard');
            });
        }
        
        // ==================== ATTENDANCE ANALYTICS ====================
        let analyticsRecords = [];
        let analyticsPeriod = 'weekly';
        
        async function openAttendanceAnalytics() {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'attendanceAnalyticsModal';
            modal.onclick = (e) => { if (e.target === modal) closeAttendanceAnalytics(); };
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <button class="modal-close" onclick="closeAttendanceAnalytics()">âœ•</button>
                    <h3 class="modal-title">ðŸ“Š Attendance Analytics</h3>
                    
                    <!-- Period Tabs -->
                    <div style="display: flex; gap: 10px; margin: 20px 0;">
                        <button class="btn analytics-tab active" id="analyticsTabWeekly" onclick="switchAnalyticsPeriod('weekly')" style="flex: 1;">ðŸ“… Weekly</button>
                        <button class="btn analytics-tab" id="analyticsTabBiweekly" onclick="switchAnalyticsPeriod('biweekly')" style="flex: 1;">ðŸ“† Bi-Weekly</button>
                        <button class="btn analytics-tab" id="analyticsTabMonthly" onclick="switchAnalyticsPeriod('monthly')" style="flex: 1;">ðŸ—“ï¸ Monthly</button>
                    </div>
                    
                    <!-- Period Info -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <span id="analyticsPeriodLabel" style="color: #888; font-size: 13px;">This week (Mon - Sun)</span>
                    </div>
                    
                    <!-- Loading -->
                    <div id="analyticsLoading" style="text-align: center; padding: 40px;">
                        <div style="width: 40px; height: 40px; border: 3px solid rgba(102,126,234,0.2); border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                        <p style="color: #888;">Loading analytics...</p>
                    </div>
                    
                    <!-- Analytics Content -->
                    <div id="analyticsContent" style="display: none;">
                        <!-- Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 12px; padding: 20px; text-align: center;">
                                <div id="analyticsAttendanceRate" style="font-size: 32px; font-weight: 700; color: #39ff14;">0%</div>
                                <div style="font-size: 12px; color: #888;">Attendance Rate</div>
                            </div>
                            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 12px; padding: 20px; text-align: center;">
                                <div id="analyticsTotalAttended" style="font-size: 32px; font-weight: 700; color: #00ffff;">0</div>
                                <div style="font-size: 12px; color: #888;">Students Attended</div>
                            </div>
                            <div style="background: rgba(255,51,102,0.1); border: 2px solid #ff3366; border-radius: 12px; padding: 20px; text-align: center;">
                                <div id="analyticsTotalAbsent" style="font-size: 32px; font-weight: 700; color: #ff3366;">0</div>
                                <div style="font-size: 12px; color: #888;">Students Absent</div>
                            </div>
                        </div>
                        
                        <!-- Two Column: Top Attenders vs Most Absences -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Top Attenders -->
                            <div style="background: rgba(57,255,20,0.05); border: 1px solid rgba(57,255,20,0.3); border-radius: 12px; padding: 20px;">
                                <h4 style="color: #39ff14; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <span>ðŸ†</span> Top Attenders
                                </h4>
                                <div id="analyticsTopAttenders">
                                    <p style="color: #888; font-size: 12px;">Loading...</p>
                                </div>
                            </div>
                            
                            <!-- Most Absences -->
                            <div style="background: rgba(255,51,102,0.05); border: 1px solid rgba(255,51,102,0.3); border-radius: 12px; padding: 20px;">
                                <h4 style="color: #ff3366; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <span>âš ï¸</span> Most Absences
                                </h4>
                                <div id="analyticsMostAbsences">
                                    <p style="color: #888; font-size: 12px;">Loading...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weeks Breakdown (for bi-weekly and monthly) -->
                        <div id="analyticsWeeksBreakdown" style="display: none; margin-top: 25px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px;">
                            <h4 style="color: #00ffff; margin-bottom: 15px;">ðŸ“ˆ Weekly Breakdown</h4>
                            <div id="analyticsWeeksList"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center;">
                        <button class="btn btn-secondary" onclick="closeAttendanceAnalytics()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add tab styles
            const style = document.createElement('style');
            style.id = 'analyticsTabStyles';
            style.textContent = `
                .analytics-tab { background: rgba(255,255,255,0.1); color: #888; border: 1px solid #444; }
                .analytics-tab:hover { background: rgba(255,255,255,0.15); color: #fff; }
                .analytics-tab.active { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border-color: transparent; }
            `;
            document.head.appendChild(style);
            
            // Load data
            await loadAnalyticsData();
        }
        
        function closeAttendanceAnalytics() {
            const modal = document.getElementById('attendanceAnalyticsModal');
            if (modal) modal.remove();
            const style = document.getElementById('analyticsTabStyles');
            if (style) style.remove();
        }
        
        function switchAnalyticsPeriod(period) {
            analyticsPeriod = period;
            
            // Update tab styles
            document.querySelectorAll('.analytics-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('analyticsTab' + period.charAt(0).toUpperCase() + period.slice(1)).classList.add('active');
            
            // Update period label
            const labels = {
                weekly: 'This week (Mon - Sun)',
                biweekly: 'Last 14 days',
                monthly: 'Last 4 weeks (28 days)'
            };
            document.getElementById('analyticsPeriodLabel').textContent = labels[period];
            
            // Recalculate
            renderAnalytics();
        }
        
        async function loadAnalyticsData() {
            try {
                // Get date range for monthly (28 days) - this covers all periods
                const now = new Date();
                const monthlyStart = new Date(now);
                monthlyStart.setDate(monthlyStart.getDate() - 28);
                
                // Load all attendance records from the past 28 days
                const recordsSnap = await db.collection('attendance_records').get();
                analyticsRecords = recordsSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).filter(r => {
                    // Filter to last 28 days
                    if (!r.weekOf) return false;
                    const recordDate = new Date(r.weekOf + 'T00:00:00');
                    return recordDate >= monthlyStart;
                });
                
                document.getElementById('analyticsLoading').style.display = 'none';
                document.getElementById('analyticsContent').style.display = 'block';
                
                renderAnalytics();
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('analyticsLoading').innerHTML = '<p style="color: #ff3366;">Error loading analytics</p>';
            }
        }
        
        function renderAnalytics() {
            // Calculate date ranges
            const now = new Date();
            let startDate, endDate, numWeeks;
            
            // Get Monday of current week
            const currentMonday = new Date(now);
            const dayOfWeek = currentMonday.getDay();
            const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            currentMonday.setDate(currentMonday.getDate() - daysToMonday);
            currentMonday.setHours(0, 0, 0, 0);
            
            if (analyticsPeriod === 'weekly') {
                startDate = new Date(currentMonday);
                endDate = new Date(currentMonday);
                endDate.setDate(endDate.getDate() + 6);
                numWeeks = 1;
            } else if (analyticsPeriod === 'biweekly') {
                startDate = new Date(currentMonday);
                startDate.setDate(startDate.getDate() - 7);
                endDate = new Date(currentMonday);
                endDate.setDate(endDate.getDate() + 6);
                numWeeks = 2;
            } else { // monthly
                startDate = new Date(currentMonday);
                startDate.setDate(startDate.getDate() - 21);
                endDate = new Date(currentMonday);
                endDate.setDate(endDate.getDate() + 6);
                numWeeks = 4;
            }
            
            // Filter records to date range
            const filteredRecords = analyticsRecords.filter(r => {
                if (!r.weekOf) return false;
                const recordDate = new Date(r.weekOf + 'T00:00:00');
                return recordDate >= startDate && recordDate <= endDate;
            });
            
            // Count attendance per student (unique weeks)
            const studentAttendance = {};
            checkinStudents.forEach(s => {
                studentAttendance[s.id] = {
                    id: s.id,
                    name: s.name || s.displayName || s.email || 'Unknown',
                    email: s.email || '',
                    weeksAttended: new Set(),
                    count: 0
                };
            });
            
            // Count unique weeks attended per student
            filteredRecords.forEach(r => {
                if (r.studentId && studentAttendance[r.studentId]) {
                    studentAttendance[r.studentId].weeksAttended.add(r.weekOf);
                }
            });
            
            // Convert Set to count
            Object.values(studentAttendance).forEach(s => {
                s.count = s.weeksAttended.size;
            });
            
            // Calculate stats
            const studentsArray = Object.values(studentAttendance);
            const totalStudents = studentsArray.length;
            const studentsWithAttendance = studentsArray.filter(s => s.count > 0).length;
            const studentsAbsent = totalStudents - studentsWithAttendance;
            const attendanceRate = totalStudents > 0 ? Math.round((studentsWithAttendance / totalStudents) * 100) : 0;
            
            // Update summary stats
            document.getElementById('analyticsAttendanceRate').textContent = attendanceRate + '%';
            document.getElementById('analyticsTotalAttended').textContent = studentsWithAttendance;
            document.getElementById('analyticsTotalAbsent').textContent = studentsAbsent;
            
            // Sort for top attenders (highest count first)
            const topAttenders = [...studentsArray].sort((a, b) => b.count - a.count).slice(0, 10);
            
            // Sort for most absences (lowest count first, but only those with < numWeeks)
            const mostAbsences = [...studentsArray].sort((a, b) => a.count - b.count).slice(0, 10);
            
            // Render top attenders
            const topHtml = topAttenders.map((s, i) => {
                const percentage = numWeeks > 0 ? Math.round((s.count / numWeeks) * 100) : 0;
                const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : (i + 1) + '.';
                const barColor = percentage >= 80 ? '#39ff14' : percentage >= 50 ? '#ffaa00' : '#ff3366';
                
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <span style="width: 25px; text-align: center;">${medal}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; color: #fff;">${escapeHtml(s.name)}</div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 6px; margin-top: 4px;">
                                <div style="background: ${barColor}; height: 100%; border-radius: 4px; width: ${percentage}%;"></div>
                            </div>
                        </div>
                        <span style="font-size: 12px; color: ${barColor}; font-weight: 600;">${s.count}/${numWeeks}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('analyticsTopAttenders').innerHTML = topHtml || '<p style="color: #888;">No data</p>';
            
            // Render most absences
            const absentHtml = mostAbsences.map((s, i) => {
                const missedWeeks = numWeeks - s.count;
                const percentage = numWeeks > 0 ? Math.round((s.count / numWeeks) * 100) : 0;
                const statusColor = percentage >= 80 ? '#39ff14' : percentage >= 50 ? '#ffaa00' : '#ff3366';
                
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <span style="width: 25px; text-align: center; color: #ff3366;">${i + 1}.</span>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; color: #fff;">${escapeHtml(s.name)}</div>
                            <div style="font-size: 11px; color: #888;">${missedWeeks} week${missedWeeks !== 1 ? 's' : ''} missed</div>
                        </div>
                        <span style="font-size: 12px; color: ${statusColor}; font-weight: 600;">${percentage}%</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('analyticsMostAbsences').innerHTML = absentHtml || '<p style="color: #888;">No data</p>';
            
            // Show weeks breakdown for bi-weekly and monthly
            if (analyticsPeriod !== 'weekly') {
                document.getElementById('analyticsWeeksBreakdown').style.display = 'block';
                
                // Calculate attendance per week
                const weeklyBreakdown = [];
                let weekStart = new Date(startDate);
                
                for (let w = 0; w < numWeeks; w++) {
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    const weekOf = weekStart.toISOString().split('T')[0];
                    
                    // Get Monday's date for this week
                    const monday = new Date(weekStart);
                    const mondayDayOfWeek = monday.getDay();
                    const daysToMon = mondayDayOfWeek === 0 ? 6 : mondayDayOfWeek - 1;
                    monday.setDate(monday.getDate() - daysToMon);
                    const tuesdayOfWeek = getCheckinWeekOf(weekStart);
                    
                    const weekRecords = analyticsRecords.filter(r => r.weekOf === tuesdayOfWeek);
                    const uniqueStudents = new Set(weekRecords.map(r => r.studentId)).size;
                    
                    weeklyBreakdown.push({
                        label: weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        attended: uniqueStudents,
                        total: totalStudents
                    });
                    
                    weekStart.setDate(weekStart.getDate() + 7);
                }
                
                const weeksHtml = weeklyBreakdown.map(w => {
                    const pct = w.total > 0 ? Math.round((w.attended / w.total) * 100) : 0;
                    const barColor = pct >= 80 ? '#39ff14' : pct >= 50 ? '#ffaa00' : '#ff3366';
                    
                    return `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="width: 120px; font-size: 12px; color: #888;">${w.label}</span>
                            <div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; height: 20px;">
                                <div style="background: ${barColor}; height: 100%; border-radius: 4px; width: ${pct}%; display: flex; align-items: center; justify-content: center;">
                                    <span style="font-size: 10px; color: #000; font-weight: 600;">${pct}%</span>
                                </div>
                            </div>
                            <span style="width: 60px; text-align: right; font-size: 12px; color: #fff;">${w.attended}/${w.total}</span>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('analyticsWeeksList').innerHTML = weeksHtml;
            } else {
                document.getElementById('analyticsWeeksBreakdown').style.display = 'none';
            }
        }
        
        // ==================== END ATTENDANCE ANALYTICS ====================

        // ==================== CONTACT LOG SYSTEM ====================
        let contactLogRecords = [];
        let contactLogFilter = 'all';
        
        async function openContactLog() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'contactLogModal';
            modal.onclick = (e) => { if (e.target === modal) closeContactLog(); };
            modal.innerHTML = `
                <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <button class="modal-close" onclick="closeContactLog()">âœ•</button>
                    <h3 class="modal-title">ðŸ“ Contact Log</h3>
                    <p style="color: #888; font-size: 12px; margin-bottom: 20px;">Track all outreach to students about attendance.</p>
                    
                    <!-- Filter & Actions -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                        <select id="contactLogFilter" onchange="filterContactLog()" style="padding: 8px 12px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;">
                            <option value="all">All Status</option>
                            <option value="pending">ðŸŸ¡ Pending</option>
                            <option value="resolved">âœ… Resolved</option>
                            <option value="escalate">ðŸ”´ Escalate</option>
                        </select>
                        <select id="contactLogTimeFilter" onchange="filterContactLog()" style="padding: 8px 12px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;">
                            <option value="all">All Time</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                        <input type="text" id="contactLogSearch" placeholder="ðŸ” Search student..." oninput="filterContactLog()" style="padding: 8px 12px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; flex: 1; min-width: 150px;">
                        <button class="btn btn-info" onclick="loadContactLog()">ðŸ”„ Refresh</button>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; text-align: center;">
                            <div id="contactLogTotal" style="font-size: 24px; font-weight: 700; color: #00ffff;">0</div>
                            <div style="font-size: 11px; color: #888;">Total Contacts</div>
                        </div>
                        <div style="background: rgba(255,170,0,0.1); border: 1px solid rgba(255,170,0,0.3); border-radius: 8px; padding: 15px; text-align: center;">
                            <div id="contactLogPending" style="font-size: 24px; font-weight: 700; color: #ffaa00;">0</div>
                            <div style="font-size: 11px; color: #888;">Pending</div>
                        </div>
                        <div style="background: rgba(57,255,20,0.1); border: 1px solid rgba(57,255,20,0.3); border-radius: 8px; padding: 15px; text-align: center;">
                            <div id="contactLogResolved" style="font-size: 24px; font-weight: 700; color: #39ff14;">0</div>
                            <div style="font-size: 11px; color: #888;">Resolved</div>
                        </div>
                        <div style="background: rgba(255,51,102,0.1); border: 1px solid rgba(255,51,102,0.3); border-radius: 8px; padding: 15px; text-align: center;">
                            <div id="contactLogEscalate" style="font-size: 24px; font-weight: 700; color: #ff3366;">0</div>
                            <div style="font-size: 11px; color: #888;">Escalate</div>
                        </div>
                    </div>
                    
                    <!-- Contact List -->
                    <div id="contactLogList" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: #888; text-align: center; padding: 40px;">Loading contact log...</p>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-secondary" onclick="closeContactLog()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            await loadContactLog();
        }
        
        function closeContactLog() {
            const modal = document.getElementById('contactLogModal');
            if (modal) modal.remove();
        }
        
        async function loadContactLog() {
            try {
                const snap = await db.collection('attendance_contacts')
                    .orderBy('contactDate', 'desc')
                    .limit(100)
                    .get();
                contactLogRecords = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContactLog();
            } catch (error) {
                console.error('Error loading contact log:', error);
                document.getElementById('contactLogList').innerHTML = '<p style="color: #ff3366; text-align: center;">Error loading contact log. Index may need to be created.</p>';
            }
        }
        
        function filterContactLog() {
            renderContactLog();
        }
        
        function renderContactLog() {
            const statusFilter = document.getElementById('contactLogFilter')?.value || 'all';
            const timeFilter = document.getElementById('contactLogTimeFilter')?.value || 'all';
            const searchTerm = document.getElementById('contactLogSearch')?.value?.toLowerCase() || '';
            
            const now = new Date();
            const weekAgo = new Date(now); weekAgo.setDate(weekAgo.getDate() - 7);
            const monthAgo = new Date(now); monthAgo.setDate(monthAgo.getDate() - 30);
            
            let filtered = contactLogRecords.filter(r => {
                // Status filter
                if (statusFilter !== 'all' && r.status !== statusFilter) return false;
                
                // Time filter
                if (timeFilter !== 'all') {
                    const contactDate = r.contactDate?.toDate ? r.contactDate.toDate() : new Date(r.contactDate);
                    if (timeFilter === 'week' && contactDate < weekAgo) return false;
                    if (timeFilter === 'month' && contactDate < monthAgo) return false;
                }
                
                // Search filter
                if (searchTerm && !r.studentName?.toLowerCase().includes(searchTerm) && !r.studentEmail?.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                return true;
            });
            
            // Update stats
            document.getElementById('contactLogTotal').textContent = contactLogRecords.length;
            document.getElementById('contactLogPending').textContent = contactLogRecords.filter(r => r.status === 'pending').length;
            document.getElementById('contactLogResolved').textContent = contactLogRecords.filter(r => r.status === 'resolved').length;
            document.getElementById('contactLogEscalate').textContent = contactLogRecords.filter(r => r.status === 'escalate').length;
            
            // Render list
            if (filtered.length === 0) {
                document.getElementById('contactLogList').innerHTML = '<p style="color: #888; text-align: center; padding: 40px;">No contact records found.</p>';
                return;
            }
            
            const html = filtered.map(r => {
                const contactDate = r.contactDate?.toDate ? r.contactDate.toDate() : new Date(r.contactDate);
                const dateStr = contactDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = contactDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                
                const methodIcon = r.contactMethod === 'email' ? 'ðŸ“§' : r.contactMethod === 'phone' ? 'ðŸ“±' : r.contactMethod === 'discord' ? 'ðŸŽ®' : 'ðŸ’¬';
                const statusColor = r.status === 'resolved' ? '#39ff14' : r.status === 'escalate' ? '#ff3366' : '#ffaa00';
                const statusIcon = r.status === 'resolved' ? 'âœ…' : r.status === 'escalate' ? 'ðŸ”´' : 'ðŸŸ¡';
                
                return `
                    <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 600; color: #fff;">${escapeHtml(r.studentName || 'Unknown')}</div>
                                <div style="font-size: 12px; color: #888;">${escapeHtml(r.studentEmail || '')}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #888;">${dateStr} at ${timeStr}</div>
                                <div style="font-size: 11px; color: ${statusColor};">${statusIcon} ${r.status || 'pending'}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 10px; font-size: 12px;">
                            <span style="color: #888;">${methodIcon} ${r.contactMethod || 'N/A'}</span>
                            <span style="color: #888;">ðŸ‘¤ ${escapeHtml(r.contactedBy || 'Unknown')}</span>
                            <span style="color: #888;">ðŸ“Œ ${escapeHtml(r.reason || 'N/A')}</span>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                            <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Notes:</div>
                            <div style="font-size: 13px; color: #ccc;">${escapeHtml(r.notes || 'No notes')}</div>
                        </div>
                        
                        ${r.resolution ? `
                            <div style="font-size: 12px; color: #39ff14;">
                                <strong>Resolution:</strong> ${escapeHtml(r.resolution)}
                            </div>
                        ` : ''}
                        
                        ${r.followUpNeeded ? `
                            <div style="font-size: 12px; color: #ffaa00; margin-top: 5px;">
                                â° Follow-up needed${r.followUpDate ? ': ' + r.followUpDate : ''}
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            ${r.status !== 'resolved' ? `<button class="btn btn-sm btn-success" onclick="updateContactStatus('${r.id}', 'resolved')" style="font-size: 10px;">âœ… Resolve</button>` : ''}
                            ${r.status !== 'escalate' ? `<button class="btn btn-sm" onclick="updateContactStatus('${r.id}', 'escalate')" style="font-size: 10px; background: #ff3366;">ðŸ”´ Escalate</button>` : ''}
                            <button class="btn btn-sm" onclick="editContactNote('${r.id}')" style="font-size: 10px;">âœï¸ Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="deleteContactRecord('${r.id}')" style="font-size: 10px;">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('contactLogList').innerHTML = html;
        }
        
        async function updateContactStatus(recordId, newStatus) {
            try {
                // If trying to resolve, check if there's a resolution
                if (newStatus === 'resolved') {
                    const record = contactLogRecords.find(r => r.id === recordId);
                    if (record && !record.resolution) {
                        // Prompt for resolution
                        const resolution = prompt('âš ï¸ A resolution is required to mark as Resolved.\n\nPlease enter the resolution/solution:');
                        if (!resolution || resolution.trim() === '') {
                            alert('âŒ Cannot mark as Resolved without a solution.\n\nPlease add a resolution first.');
                            return;
                        }
                        // Update with resolution
                        await db.collection('attendance_contacts').doc(recordId).update({
                            status: newStatus,
                            resolution: resolution.trim(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await loadContactLog();
                        return;
                    }
                }
                
                await db.collection('attendance_contacts').doc(recordId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadContactLog();
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status');
            }
        }
        
        async function deleteContactRecord(recordId) {
            if (!confirm('Delete this contact record?')) return;
            try {
                await db.collection('attendance_contacts').doc(recordId).delete();
                await loadContactLog();
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Error deleting record');
            }
        }
        
        function editContactNote(recordId) {
            const record = contactLogRecords.find(r => r.id === recordId);
            if (!record) return;
            
            const newNotes = prompt('Edit notes:', record.notes || '');
            if (newNotes === null) return;
            
            db.collection('attendance_contacts').doc(recordId).update({
                notes: newNotes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => loadContactLog()).catch(e => {
                console.error('Error updating notes:', e);
                alert('Error updating notes');
            });
        }
        
        // Add Contact Modal
        function openAddContactModal(studentId, studentName, studentEmail) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'addContactModal';
            modal.onclick = (e) => { if (e.target === modal) closeAddContactModal(); };
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <button class="modal-close" onclick="closeAddContactModal()">âœ•</button>
                    <h3 class="modal-title">ðŸ“ Log Contact</h3>
                    
                    <div style="background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #00ffff;">${escapeHtml(studentName)}</div>
                        <div style="font-size: 12px; color: #888;">${escapeHtml(studentEmail)}</div>
                    </div>
                    
                    <input type="hidden" id="addContactStudentId" value="${studentId}">
                    <input type="hidden" id="addContactStudentName" value="${escapeAttr(studentName)}">
                    <input type="hidden" id="addContactStudentEmail" value="${escapeAttr(studentEmail)}">
                    
                    <div class="form-group">
                        <label>Contact Method</label>
                        <select id="addContactMethod" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;">
                            <option value="email">ðŸ“§ Email</option>
                            <option value="phone">ðŸ“± Phone</option>
                            <option value="discord">ðŸŽ® Discord</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Contacted By</label>
                        <input type="text" id="addContactBy" placeholder="Your name" value="${currentUser?.name || ''}" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;">
                    </div>
                    
                    <div class="form-group">
                        <label>Reason</label>
                        <select id="addContactReason" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;">
                            <option value="Missed class">Missed class</option>
                            <option value="Multiple absences">Multiple absences</option>
                            <option value="No response">No response to previous contact</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Issue Type</label>
                        <select id="addContactIssue" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;">
                            <option value="">-- Select if known --</option>
                            <option value="Schedule conflict">Schedule conflict</option>
                            <option value="Technical issue">Technical issue</option>
                            <option value="Personal">Personal reasons</option>
                            <option value="No response">No response</option>
                            <option value="Lost interest">Lost interest</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="addContactNotes" rows="3" placeholder="What was discussed? Any important details..." style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Resolution (if any)</label>
                        <input type="text" id="addContactResolution" placeholder="e.g., Will return next week" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;">
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        <select id="addContactStatus" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;">
                            <option value="pending">ðŸŸ¡ Pending</option>
                            <option value="resolved">âœ… Resolved</option>
                            <option value="escalate">ðŸ”´ Escalate to Admin</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="addContactFollowUp" style="width: 18px; height: 18px;">
                            <span>Follow-up needed</span>
                        </label>
                        <input type="date" id="addContactFollowUpDate" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; margin-top: 8px; display: none;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeAddContactModal()" style="flex: 1;">Cancel</button>
                        <button class="btn btn-success" onclick="saveContactRecord()" style="flex: 1;">ðŸ’¾ Save Contact</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Toggle follow-up date visibility
            document.getElementById('addContactFollowUp').addEventListener('change', function() {
                document.getElementById('addContactFollowUpDate').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        function closeAddContactModal() {
            const modal = document.getElementById('addContactModal');
            if (modal) modal.remove();
        }
        
        async function saveContactRecord() {
            const studentId = document.getElementById('addContactStudentId').value;
            const studentName = document.getElementById('addContactStudentName').value;
            const studentEmail = document.getElementById('addContactStudentEmail').value;
            const contactMethod = document.getElementById('addContactMethod').value;
            const contactedBy = document.getElementById('addContactBy').value.trim();
            const reason = document.getElementById('addContactReason').value;
            const issueType = document.getElementById('addContactIssue').value;
            const notes = document.getElementById('addContactNotes').value.trim();
            const resolution = document.getElementById('addContactResolution').value.trim();
            const status = document.getElementById('addContactStatus').value;
            const followUpNeeded = document.getElementById('addContactFollowUp').checked;
            const followUpDate = document.getElementById('addContactFollowUpDate').value;
            
            if (!contactedBy) {
                alert('Please enter who contacted the student');
                return;
            }
            
            // Require resolution if status is "resolved"
            if (status === 'resolved' && !resolution) {
                alert('âš ï¸ A resolution is required when marking as Resolved.\n\nPlease enter the solution in the Resolution field.');
                document.getElementById('addContactResolution').focus();
                document.getElementById('addContactResolution').style.border = '2px solid #ff3366';
                return;
            }
            
            try {
                await db.collection('attendance_contacts').add({
                    studentId,
                    studentName,
                    studentEmail,
                    contactDate: firebase.firestore.FieldValue.serverTimestamp(),
                    contactMethod,
                    contactedBy,
                    reason,
                    issueType: issueType || null,
                    notes: notes || null,
                    resolution: resolution || null,
                    status,
                    followUpNeeded,
                    followUpDate: followUpNeeded && followUpDate ? followUpDate : null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeAddContactModal();
                alert('âœ… Contact logged successfully!');
            } catch (error) {
                console.error('Error saving contact:', error);
                alert('Error saving contact record');
            }
        }
        
        // ==================== END CONTACT LOG SYSTEM ====================

        // ==================== OUTREACH ANALYTICS (Full Page) ====================
        let outreachPeriod = 'week';
        let outreachAllContacts = [];
        let outreachAllStudents = [];
        
        function setOutreachPeriod(period) {
            outreachPeriod = period;
            document.querySelectorAll('.outreach-period-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('outreachPeriod' + period.charAt(0).toUpperCase() + period.slice(1)).classList.add('active');
            renderOutreachAnalytics();
        }
        
        let outreachAbsences = [];
        let outreachClassAttendance = [];
        
        async function loadOutreachAnalytics() {
            try {
                // Load all students
                const studentsSnap = await db.collection('users').where('role', '==', 'student').get();
                outreachAllStudents = studentsSnap.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().displayName || doc.data().name || doc.data().email?.split('@')[0] || 'Unknown',
                    email: doc.data().email || '',
                    phone: doc.data().phone || doc.data().phoneNumber || '',
                    discord: doc.data().discord || doc.data().discordName || '',
                    assignedTier: doc.data().assignedTier || '',
                    ...doc.data()
                }));
                outreachAllStudents.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                // Load all contact records
                const contactsSnap = await db.collection('attendance_contacts').orderBy('contactDate', 'desc').get();
                outreachAllContacts = contactsSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Load absences from scheduler_attendance
                const absencesSnap = await db.collection('scheduler_attendance').where('status', '==', 'absent').get();
                outreachAbsences = absencesSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Load all class attendance (present/late/absent) for day breakdown
                const allAttendanceSnap = await db.collection('scheduler_attendance').get();
                outreachClassAttendance = allAttendanceSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                renderOutreachAnalytics();
            } catch (error) {
                console.error('Error loading outreach analytics:', error);
            }
        }
        
        // Helper to get day of week from class data
        function getDayFromClass(classId) {
            const cls = allClasses?.find(c => c.id === classId);
            if (cls && cls.day) {
                const dayMap = {
                    'monday': 'Mon', 'tuesday': 'Tue', 'wednesday': 'Wed', 
                    'thursday': 'Thu', 'friday': 'Fri', 'saturday': 'Sat', 'sunday': 'Sun',
                    'mon': 'Mon', 'tue': 'Tue', 'wed': 'Wed', 'thu': 'Thu', 'fri': 'Fri'
                };
                return dayMap[cls.day.toLowerCase()] || cls.day.substring(0, 3);
            }
            return null;
        }
        
        function renderOutreachAnalytics() {
            // Filter contacts by period
            const now = new Date();
            let filteredContacts = outreachAllContacts;
            let periodStartDate = null;
            
            if (outreachPeriod === 'week') {
                periodStartDate = new Date(now);
                periodStartDate.setDate(periodStartDate.getDate() - 7);
                filteredContacts = outreachAllContacts.filter(c => {
                    const date = c.contactDate?.toDate ? c.contactDate.toDate() : new Date(c.contactDate);
                    return date >= periodStartDate;
                });
            } else if (outreachPeriod === 'month') {
                periodStartDate = new Date(now);
                periodStartDate.setDate(periodStartDate.getDate() - 30);
                filteredContacts = outreachAllContacts.filter(c => {
                    const date = c.contactDate?.toDate ? c.contactDate.toDate() : new Date(c.contactDate);
                    return date >= periodStartDate;
                });
            }
            
            // Count absences per student
            const studentAbsenceCount = {};
            outreachAbsences.forEach(a => {
                if (a.studentId) {
                    studentAbsenceCount[a.studentId] = (studentAbsenceCount[a.studentId] || 0) + 1;
                }
            });
            
            // Build attendance by day per student
            const studentDayAttendance = {};
            outreachClassAttendance.forEach(a => {
                if (!a.studentId) return;
                if (!studentDayAttendance[a.studentId]) {
                    studentDayAttendance[a.studentId] = {
                        Mon: { present: 0, absent: 0, total: 0 },
                        Tue: { present: 0, absent: 0, total: 0 },
                        Wed: { present: 0, absent: 0, total: 0 },
                        Thu: { present: 0, absent: 0, total: 0 },
                        Fri: { present: 0, absent: 0, total: 0 }
                    };
                }
                const day = getDayFromClass(a.classId);
                if (day && studentDayAttendance[a.studentId][day]) {
                    studentDayAttendance[a.studentId][day].total++;
                    if (a.status === 'present' || a.status === 'late') {
                        studentDayAttendance[a.studentId][day].present++;
                    } else if (a.status === 'absent') {
                        studentDayAttendance[a.studentId][day].absent++;
                    }
                }
            });
            
            // Build contact map per student (using ALL contacts for "never contacted" check)
            const studentContactMap = {};
            outreachAllStudents.forEach(s => {
                studentContactMap[s.id] = {
                    student: s,
                    contacts: [],
                    filteredContacts: [],
                    totalContacts: 0,
                    lastContact: null,
                    lastStatus: null,
                    lastMethod: null,
                    lastResolution: null,
                    absenceCount: studentAbsenceCount[s.id] || 0,
                    dayAttendance: studentDayAttendance[s.id] || {
                        Mon: { present: 0, absent: 0, total: 0 },
                        Tue: { present: 0, absent: 0, total: 0 },
                        Wed: { present: 0, absent: 0, total: 0 },
                        Thu: { present: 0, absent: 0, total: 0 },
                        Fri: { present: 0, absent: 0, total: 0 }
                    }
                };
            });
            
            // Map all contacts
            outreachAllContacts.forEach(c => {
                if (c.studentId && studentContactMap[c.studentId]) {
                    studentContactMap[c.studentId].contacts.push(c);
                    studentContactMap[c.studentId].totalContacts++;
                }
            });
            
            // Map filtered contacts
            filteredContacts.forEach(c => {
                if (c.studentId && studentContactMap[c.studentId]) {
                    studentContactMap[c.studentId].filteredContacts.push(c);
                }
            });
            
            // Set last contact info
            Object.values(studentContactMap).forEach(data => {
                if (data.contacts.length > 0) {
                    const last = data.contacts[0]; // Already sorted desc
                    data.lastContact = last.contactDate?.toDate ? last.contactDate.toDate() : new Date(last.contactDate);
                    data.lastStatus = last.status;
                    data.lastMethod = last.contactMethod;
                    data.lastResolution = last.resolution;
                }
            });
            
            // Calculate stats
            const totalStudents = outreachAllStudents.length;
            const studentsContacted = Object.values(studentContactMap).filter(d => d.filteredContacts.length > 0).length;
            const studentsNeverContactedWith2PlusAbsences = Object.values(studentContactMap).filter(d => d.totalContacts === 0 && d.absenceCount >= 2).length;
            const pendingCount = filteredContacts.filter(c => c.status === 'pending').length;
            const resolvedCount = filteredContacts.filter(c => c.status === 'resolved').length;
            const escalatedCount = filteredContacts.filter(c => c.status === 'escalate').length;
            
            // Update stats
            document.getElementById('outreachTotalStudents').textContent = totalStudents;
            document.getElementById('outreachContacted').textContent = studentsContacted;
            document.getElementById('outreachNotContacted').textContent = totalStudents - studentsContacted;
            document.getElementById('outreachPending').textContent = pendingCount;
            document.getElementById('outreachResolved').textContent = resolvedCount;
            document.getElementById('outreachEscalated').textContent = escalatedCount;
            
            // Render Never Contacted list (only students with 2+ absences)
            const neverContacted = Object.values(studentContactMap).filter(d => d.totalContacts === 0 && d.absenceCount >= 2);
            // Sort by absence count (most absences first)
            neverContacted.sort((a, b) => b.absenceCount - a.absenceCount);
            document.getElementById('outreachNeverContactedCount').textContent = neverContacted.length;
            
            if (neverContacted.length === 0) {
                document.getElementById('outreachNeverContactedList').innerHTML = '<p style="color: #39ff14; text-align: center; padding: 20px;">ðŸŽ‰ No students with 2+ absences need contact!</p>';
            } else {
                const neverContactedHtml = neverContacted.map(d => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #ff3366; cursor: pointer;" onclick="openOutreachStudentModal('${d.student.id}')">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #fff;">${escapeHtml(d.student.name)}</div>
                            <div style="font-size: 11px; color: #888;">${escapeHtml(d.student.email || 'No email')}</div>
                            <div style="font-size: 11px; color: #ff3366; margin-top: 2px;">âš ï¸ ${d.absenceCount} absences</div>
                        </div>
                        <button class="btn btn-sm" onclick="event.stopPropagation(); openAddContactModal('${d.student.id}', '${escapeAttr(d.student.name)}', '${escapeAttr(d.student.email)}')" style="font-size: 10px; background: linear-gradient(135deg, #ff6b6b, #ee5a24);">ðŸ“ Contact</button>
                    </div>
                `).join('');
                document.getElementById('outreachNeverContactedList').innerHTML = neverContactedHtml;
            }
            
            // Render Pending Follow-ups list
            const pendingFollowups = Object.values(studentContactMap).filter(d => {
                const lastContact = d.contacts[0];
                return lastContact && (lastContact.status === 'pending' || lastContact.followUpNeeded);
            });
            document.getElementById('outreachPendingFollowupsCount').textContent = pendingFollowups.length;
            
            if (pendingFollowups.length === 0) {
                document.getElementById('outreachPendingFollowupsList').innerHTML = '<p style="color: #39ff14; text-align: center; padding: 20px;">âœ… No pending follow-ups!</p>';
            } else {
                const pendingHtml = pendingFollowups.map(d => {
                    const last = d.contacts[0];
                    const dateStr = d.lastContact ? d.lastContact.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A';
                    const methodIcon = last.contactMethod === 'email' ? 'ðŸ“§' : last.contactMethod === 'phone' ? 'ðŸ“±' : 'ðŸŽ®';
                    
                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #ffaa00; cursor: pointer;" onclick="openOutreachStudentModal('${d.student.id}')">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #fff;">${escapeHtml(d.student.name)}</div>
                                <div style="font-size: 11px; color: #888;">${methodIcon} Last: ${dateStr} ${last.followUpDate ? 'â€¢ Follow-up: ' + last.followUpDate : ''}</div>
                                <div style="font-size: 11px; color: #ffaa00; margin-top: 2px;">${escapeHtml(last.notes || 'No notes')}</div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); quickResolveContact('${last.id}', '${escapeAttr(d.student.name)}')" style="font-size: 10px;">âœ…</button>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); openAddContactModal('${d.student.id}', '${escapeAttr(d.student.name)}', '${escapeAttr(d.student.email)}')" style="font-size: 10px; background: #ffaa00; color: #000;">ðŸ“</button>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('outreachPendingFollowupsList').innerHTML = pendingHtml;
            }
            
            // Render main table with day attendance
            renderOutreachTable(studentContactMap);
            
            // Render recent activity
            renderOutreachRecentActivity(filteredContacts.slice(0, 20));
        }
        
        function renderOutreachTable(studentContactMap) {
            const searchTerm = document.getElementById('outreachSearchInput')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('outreachStatusFilter')?.value || 'all';
            
            let students = Object.values(studentContactMap);
            
            // Apply filters
            if (searchTerm) {
                students = students.filter(d => 
                    d.student.name?.toLowerCase().includes(searchTerm) || 
                    d.student.email?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter !== 'all') {
                if (statusFilter === 'never') {
                    students = students.filter(d => d.totalContacts === 0);
                } else if (statusFilter === 'contacted') {
                    students = students.filter(d => d.totalContacts > 0);
                } else {
                    students = students.filter(d => d.lastStatus === statusFilter);
                }
            }
            
            // Sort: Most absences first for never contacted, then by last contact date
            students.sort((a, b) => {
                // Never contacted with absences first
                if (a.totalContacts === 0 && a.absenceCount >= 2 && !(b.totalContacts === 0 && b.absenceCount >= 2)) return -1;
                if (b.totalContacts === 0 && b.absenceCount >= 2 && !(a.totalContacts === 0 && a.absenceCount >= 2)) return 1;
                // Then by absence count
                if (a.absenceCount !== b.absenceCount) return b.absenceCount - a.absenceCount;
                // Then by last contact date
                if (a.lastContact && b.lastContact) return b.lastContact - a.lastContact;
                return 0;
            });
            
            if (students.length === 0) {
                document.getElementById('outreachTableBody').innerHTML = '<tr><td colspan="12" style="padding: 40px; text-align: center; color: #888;">No students match the filters.</td></tr>';
                return;
            }
            
            // Determine if weekly or monthly view for day display
            const isWeekly = outreachPeriod === 'week';
            
            const tableHtml = students.map(d => {
                const statusColor = d.lastStatus === 'resolved' ? '#39ff14' : d.lastStatus === 'escalate' ? '#ff3366' : d.lastStatus === 'pending' ? '#ffaa00' : '#666';
                const statusIcon = d.lastStatus === 'resolved' ? 'âœ…' : d.lastStatus === 'escalate' ? 'ðŸ”´' : d.lastStatus === 'pending' ? 'ðŸŸ¡' : 'âšª';
                const lastDateStr = d.lastContact ? d.lastContact.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }) : 'â€”';
                
                // Generate day attendance cells
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                const dayCells = days.map(day => {
                    const att = d.dayAttendance[day];
                    if (att.total === 0) {
                        return `<td style="padding: 8px; text-align: center; color: #444;">â€”</td>`;
                    }
                    if (isWeekly) {
                        // Show checkmark for present, X for absent
                        if (att.present > 0) {
                            return `<td style="padding: 8px; text-align: center; color: #39ff14;">âœ“</td>`;
                        } else if (att.absent > 0) {
                            return `<td style="padding: 8px; text-align: center; color: #ff3366;">âœ—</td>`;
                        }
                        return `<td style="padding: 8px; text-align: center; color: #444;">â€”</td>`;
                    } else {
                        // Show count for monthly
                        const color = att.present === att.total ? '#39ff14' : att.present > 0 ? '#ffaa00' : '#ff3366';
                        return `<td style="padding: 8px; text-align: center; color: ${color}; font-size: 11px;">${att.present}/${att.total}</td>`;
                    }
                }).join('');
                
                // Absence count styling
                const absenceColor = d.absenceCount >= 3 ? '#ff3366' : d.absenceCount >= 2 ? '#ffaa00' : '#888';
                
                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; ${d.totalContacts === 0 && d.absenceCount >= 2 ? 'background: rgba(255,51,102,0.15);' : ''}" onclick="openOutreachStudentModal('${d.student.id}')">
                        <td style="padding: 12px;">
                            <div style="font-weight: 600; color: #fff;">${escapeHtml(d.student.name)}</div>
                            <div style="font-size: 10px; color: #888;">${escapeHtml(d.student.assignedTier || 'No tier')}</div>
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            <span style="color: ${absenceColor}; font-weight: 600;">${d.absenceCount}</span>
                        </td>
                        ${dayCells}
                        <td style="padding: 8px; text-align: center;">
                            <span style="background: ${d.totalContacts > 0 ? 'rgba(57,255,20,0.2)' : 'rgba(255,51,102,0.2)'}; color: ${d.totalContacts > 0 ? '#39ff14' : '#ff3366'}; padding: 3px 8px; border-radius: 10px; font-weight: 600; font-size: 11px;">${d.totalContacts}</span>
                        </td>
                        <td style="padding: 8px; text-align: center; color: #888; font-size: 11px;">${lastDateStr}</td>
                        <td style="padding: 8px; text-align: center;">
                            <span style="color: ${statusColor}; font-size: 11px;">${statusIcon}</span>
                        </td>
                        <td style="padding: 8px; text-align: center; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #888; font-size: 11px;" title="${escapeHtml(d.lastResolution || '')}">${escapeHtml(d.lastResolution || 'â€”')}</td>
                        <td style="padding: 8px; text-align: center;">
                            <div style="display: flex; gap: 4px; justify-content: center;">
                                ${d.lastStatus === 'pending' ? `<button class="btn btn-sm btn-success" onclick="event.stopPropagation(); quickResolveContact('${d.contacts[0]?.id}', '${escapeAttr(d.student.name)}')" style="font-size: 9px; padding: 3px 6px;">âœ…</button>` : ''}
                                <button class="btn btn-sm" onclick="event.stopPropagation(); openAddContactModal('${d.student.id}', '${escapeAttr(d.student.name)}', '${escapeAttr(d.student.email)}')" style="font-size: 9px; padding: 3px 6px; background: linear-gradient(135deg, #667eea, #764ba2);">ðŸ“</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('outreachTableBody').innerHTML = tableHtml;
        }
        
        function filterOutreachTable() {
            // Re-build contact map and render
            const studentAbsenceCount = {};
            outreachAbsences.forEach(a => {
                if (a.studentId) {
                    studentAbsenceCount[a.studentId] = (studentAbsenceCount[a.studentId] || 0) + 1;
                }
            });
            
            const studentDayAttendance = {};
            outreachClassAttendance.forEach(a => {
                if (!a.studentId) return;
                if (!studentDayAttendance[a.studentId]) {
                    studentDayAttendance[a.studentId] = {
                        Mon: { present: 0, absent: 0, total: 0 },
                        Tue: { present: 0, absent: 0, total: 0 },
                        Wed: { present: 0, absent: 0, total: 0 },
                        Thu: { present: 0, absent: 0, total: 0 },
                        Fri: { present: 0, absent: 0, total: 0 }
                    };
                }
                const day = getDayFromClass(a.classId);
                if (day && studentDayAttendance[a.studentId][day]) {
                    studentDayAttendance[a.studentId][day].total++;
                    if (a.status === 'present' || a.status === 'late') {
                        studentDayAttendance[a.studentId][day].present++;
                    } else if (a.status === 'absent') {
                        studentDayAttendance[a.studentId][day].absent++;
                    }
                }
            });
            
            const studentContactMap = {};
            outreachAllStudents.forEach(s => {
                studentContactMap[s.id] = {
                    student: s,
                    contacts: [],
                    totalContacts: 0,
                    lastContact: null,
                    lastStatus: null,
                    lastMethod: null,
                    lastResolution: null,
                    absenceCount: studentAbsenceCount[s.id] || 0,
                    dayAttendance: studentDayAttendance[s.id] || {
                        Mon: { present: 0, absent: 0, total: 0 },
                        Tue: { present: 0, absent: 0, total: 0 },
                        Wed: { present: 0, absent: 0, total: 0 },
                        Thu: { present: 0, absent: 0, total: 0 },
                        Fri: { present: 0, absent: 0, total: 0 }
                    }
                };
            });
            
            outreachAllContacts.forEach(c => {
                if (c.studentId && studentContactMap[c.studentId]) {
                    studentContactMap[c.studentId].contacts.push(c);
                    studentContactMap[c.studentId].totalContacts++;
                }
            });
            
            Object.values(studentContactMap).forEach(data => {
                if (data.contacts.length > 0) {
                    const last = data.contacts[0];
                    data.lastContact = last.contactDate?.toDate ? last.contactDate.toDate() : new Date(last.contactDate);
                    data.lastStatus = last.status;
                    data.lastMethod = last.contactMethod;
                    data.lastResolution = last.resolution;
                }
            });
            
            renderOutreachTable(studentContactMap);
        }
        
        function renderOutreachRecentActivity(contacts) {
            if (contacts.length === 0) {
                document.getElementById('outreachRecentActivity').innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No recent contact activity.</p>';
                return;
            }
            
            const html = contacts.map(c => {
                const date = c.contactDate?.toDate ? c.contactDate.toDate() : new Date(c.contactDate);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                const methodIcon = c.contactMethod === 'email' ? 'ðŸ“§' : c.contactMethod === 'phone' ? 'ðŸ“±' : 'ðŸŽ®';
                const statusColor = c.status === 'resolved' ? '#39ff14' : c.status === 'escalate' ? '#ff3366' : '#ffaa00';
                
                return `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${statusColor};">
                        <div style="font-size: 12px; color: #888; min-width: 100px;">${dateStr}</div>
                        <div style="font-size: 16px;">${methodIcon}</div>
                        <div style="flex: 1;">
                            <span style="font-weight: 600; color: #fff;">${escapeHtml(c.studentName || 'Unknown')}</span>
                            <span style="color: #888;"> â€” </span>
                            <span style="color: #aaa;">${escapeHtml(c.notes || c.reason || 'No notes')}</span>
                        </div>
                        <div style="color: ${statusColor}; font-size: 11px; text-transform: capitalize;">${c.status || 'pending'}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('outreachRecentActivity').innerHTML = html;
        }
        
        // Quick resolve a contact from the table/list
        async function quickResolveContact(contactId, studentName) {
            if (!contactId) {
                alert('No contact record to resolve.');
                return;
            }
            
            const resolution = prompt(`Enter the resolution for ${studentName}:\n\n(Required to mark as Resolved)`);
            if (!resolution || resolution.trim() === '') {
                alert('âŒ A resolution is required to mark as Resolved.');
                return;
            }
            
            try {
                await db.collection('attendance_contacts').doc(contactId).update({
                    status: 'resolved',
                    resolution: resolution.trim(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('âœ… Marked as resolved!');
                loadOutreachAnalytics();
            } catch (error) {
                console.error('Error resolving contact:', error);
                alert('Error updating contact status');
            }
        }
        
        // Open a comprehensive modal for a student with attendance and contact options
        async function openOutreachStudentModal(studentId) {
            const student = outreachAllStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const contacts = outreachAllContacts.filter(c => c.studentId === studentId);
            const absences = outreachAbsences.filter(a => a.studentId === studentId);
            const attendance = outreachClassAttendance.filter(a => a.studentId === studentId);
            
            // Calculate day attendance
            const dayStats = { Mon: { present: 0, absent: 0 }, Tue: { present: 0, absent: 0 }, Wed: { present: 0, absent: 0 }, Thu: { present: 0, absent: 0 }, Fri: { present: 0, absent: 0 } };
            attendance.forEach(a => {
                const day = getDayFromClass(a.classId);
                if (day && dayStats[day]) {
                    if (a.status === 'present' || a.status === 'late') dayStats[day].present++;
                    else if (a.status === 'absent') dayStats[day].absent++;
                }
            });
            
            // Build day attendance display
            const dayDisplay = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(day => {
                const stat = dayStats[day];
                const total = stat.present + stat.absent;
                if (total === 0) return `<div style="text-align: center; padding: 8px;"><div style="color: #888; font-size: 10px;">${day}</div><div style="color: #444;">â€”</div></div>`;
                const pct = Math.round((stat.present / total) * 100);
                const color = pct >= 80 ? '#39ff14' : pct >= 50 ? '#ffaa00' : '#ff3366';
                return `<div style="text-align: center; padding: 8px;"><div style="color: #888; font-size: 10px;">${day}</div><div style="color: ${color}; font-weight: 600;">${stat.present}/${total}</div></div>`;
            }).join('');
            
            // Contact history
            const lastContact = contacts[0];
            const historyHtml = contacts.slice(0, 5).map(c => {
                const date = c.contactDate?.toDate ? c.contactDate.toDate() : new Date(c.contactDate);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const methodIcon = c.contactMethod === 'email' ? 'ðŸ“§' : c.contactMethod === 'phone' ? 'ðŸ“±' : 'ðŸŽ®';
                const statusColor = c.status === 'resolved' ? '#39ff14' : c.status === 'escalate' ? '#ff3366' : '#ffaa00';
                return `
                    <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 8px; margin-bottom: 6px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; font-size: 11px;">
                            <span style="color: #888;">${dateStr} ${methodIcon}</span>
                            <span style="color: ${statusColor}; text-transform: capitalize;">${c.status || 'pending'}</span>
                        </div>
                        <div style="font-size: 11px; color: #ccc; margin-top: 4px;">${escapeHtml(c.notes || c.reason || 'No notes')}</div>
                        ${c.resolution ? `<div style="font-size: 10px; color: #39ff14; margin-top: 4px;">âœ“ ${escapeHtml(c.resolution)}</div>` : ''}
                    </div>
                `;
            }).join('') || '<p style="color: #666; font-size: 11px; text-align: center;">No contact history</p>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'outreachStudentModal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width: 550px; max-height: 85vh; overflow-y: auto;">
                    <button class="modal-close" onclick="document.getElementById('outreachStudentModal').remove()">âœ•</button>
                    <h3 class="modal-title">ðŸ“Š Student Overview</h3>
                    
                    <!-- Student Info -->
                    <div style="background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <div style="font-size: 20px; font-weight: 600; color: #fff;">${escapeHtml(student.name)}</div>
                        <div style="font-size: 12px; color: #888;">${escapeHtml(student.email || 'No email')}</div>
                        <div style="font-size: 12px; color: #888; margin-top: 5px;">${escapeHtml(student.assignedTier || 'No tier')}</div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(255,51,102,0.1); border: 1px solid #ff3366; border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #ff3366;">${absences.length}</div>
                            <div style="font-size: 10px; color: #888;">Absences</div>
                        </div>
                        <div style="background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #00ffff;">${contacts.length}</div>
                            <div style="font-size: 10px; color: #888;">Contacts</div>
                        </div>
                        <div style="background: rgba(${lastContact?.status === 'resolved' ? '57,255,20' : lastContact?.status === 'pending' ? '255,170,0' : '136,136,136'},0.1); border: 1px solid ${lastContact?.status === 'resolved' ? '#39ff14' : lastContact?.status === 'pending' ? '#ffaa00' : '#888'}; border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 14px; font-weight: 600; color: ${lastContact?.status === 'resolved' ? '#39ff14' : lastContact?.status === 'pending' ? '#ffaa00' : '#888'}; text-transform: capitalize;">${lastContact?.status || 'Never'}</div>
                            <div style="font-size: 10px; color: #888;">Status</div>
                        </div>
                    </div>
                    
                    <!-- Day Attendance -->
                    <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="color: #ffaa00; margin-bottom: 10px; font-size: 13px;">ðŸ“… Attendance by Day</h4>
                        <div style="display: flex; justify-content: space-around; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            ${dayDisplay}
                        </div>
                    </div>
                    
                    <!-- Contact Info -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        ${student.email ? `<button class="btn btn-sm" onclick="copyToClipboard('${escapeAttr(student.email)}')" style="flex: 1; font-size: 11px;">ðŸ“§ Copy Email</button>` : ''}
                        ${student.phone ? `<button class="btn btn-sm" onclick="copyToClipboard('${escapeAttr(student.phone)}')" style="flex: 1; font-size: 11px;">ðŸ“± Copy Phone</button>` : ''}
                        ${student.discord ? `<button class="btn btn-sm" onclick="copyToClipboard('${escapeAttr(student.discord)}')" style="flex: 1; font-size: 11px;">ðŸŽ® Copy Discord</button>` : ''}
                    </div>
                    
                    <!-- Contact History -->
                    <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 10px; font-size: 13px;">ðŸ“ Recent Contacts</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${historyHtml}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px;">
                        ${lastContact && lastContact.status === 'pending' ? `
                            <button class="btn btn-success" onclick="document.getElementById('outreachStudentModal').remove(); quickResolveContact('${lastContact.id}', '${escapeAttr(student.name)}')" style="flex: 1;">âœ… Resolve</button>
                        ` : ''}
                        <button class="btn" onclick="document.getElementById('outreachStudentModal').remove(); openAddContactModal('${studentId}', '${escapeAttr(student.name)}', '${escapeAttr(student.email)}')" style="flex: 1; background: linear-gradient(135deg, #667eea, #764ba2);">ðŸ“ New Contact</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('outreachStudentModal').remove()" style="flex: 1;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function viewStudentContactHistory(studentId) {
            const student = outreachAllStudents.find(s => s.id === studentId);
            const contacts = outreachAllContacts.filter(c => c.studentId === studentId);
            
            if (!student) return;
            
            const historyHtml = contacts.length > 0 ? contacts.map(c => {
                const date = c.contactDate?.toDate ? c.contactDate.toDate() : new Date(c.contactDate);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                const methodIcon = c.contactMethod === 'email' ? 'ðŸ“§' : c.contactMethod === 'phone' ? 'ðŸ“±' : 'ðŸŽ®';
                const statusColor = c.status === 'resolved' ? '#39ff14' : c.status === 'escalate' ? '#ff3366' : '#ffaa00';
                
                return `
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #888; font-size: 12px;">${dateStr}</span>
                            <span style="color: ${statusColor}; font-size: 11px; text-transform: capitalize;">${c.status || 'pending'}</span>
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">${methodIcon} ${c.contactMethod || 'N/A'} â€¢ ${escapeHtml(c.reason || 'N/A')} â€¢ By: ${escapeHtml(c.contactedBy || 'Unknown')}</div>
                        <div style="color: #ccc; font-size: 13px;">${escapeHtml(c.notes || 'No notes')}</div>
                        ${c.resolution ? `<div style="color: #39ff14; font-size: 12px; margin-top: 8px;"><strong>Resolution:</strong> ${escapeHtml(c.resolution)}</div>` : ''}
                    </div>
                `;
            }).join('') : '<p style="color: #888; text-align: center; padding: 20px;">No contact history for this student.</p>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'studentHistoryModal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width: 550px; max-height: 80vh; overflow-y: auto;">
                    <button class="modal-close" onclick="document.getElementById('studentHistoryModal').remove()">âœ•</button>
                    <h3 class="modal-title">ðŸ“‹ Contact History</h3>
                    
                    <div style="background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <div style="font-size: 18px; font-weight: 600; color: #fff;">${escapeHtml(student.name)}</div>
                        <div style="font-size: 12px; color: #888;">${escapeHtml(student.email || 'No email')}</div>
                        <div style="font-size: 12px; color: #888; margin-top: 5px;">Total contacts: <strong style="color: #00ffff;">${contacts.length}</strong></div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${historyHtml}
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn" onclick="document.getElementById('studentHistoryModal').remove(); openAddContactModal('${studentId}', '${escapeAttr(student.name)}', '${escapeAttr(student.email)}')" style="flex: 1; background: linear-gradient(135deg, #667eea, #764ba2);">ðŸ“ Add Contact</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('studentHistoryModal').remove()" style="flex: 1;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function exportOutreachReport() {
            // Build CSV
            let csv = 'Student Name,Email,Phone,Discord,Total Contacts,Last Contact Date,Last Method,Last Status,Last Resolution\n';
            
            const studentContactMap = {};
            outreachAllStudents.forEach(s => {
                studentContactMap[s.id] = { student: s, contacts: [], totalContacts: 0, lastContact: null, lastStatus: null, lastMethod: null, lastResolution: null };
            });
            outreachAllContacts.forEach(c => {
                if (c.studentId && studentContactMap[c.studentId]) {
                    studentContactMap[c.studentId].contacts.push(c);
                    studentContactMap[c.studentId].totalContacts++;
                }
            });
            Object.values(studentContactMap).forEach(data => {
                if (data.contacts.length > 0) {
                    const last = data.contacts[0];
                    data.lastContact = last.contactDate?.toDate ? last.contactDate.toDate() : new Date(last.contactDate);
                    data.lastStatus = last.status;
                    data.lastMethod = last.contactMethod;
                    data.lastResolution = last.resolution;
                }
            });
            
            Object.values(studentContactMap).forEach(d => {
                const lastDateStr = d.lastContact ? d.lastContact.toISOString().split('T')[0] : '';
                csv += `"${d.student.name || ''}","${d.student.email || ''}","${d.student.phone || ''}","${d.student.discord || ''}",${d.totalContacts},"${lastDateStr}","${d.lastMethod || ''}","${d.lastStatus || ''}","${(d.lastResolution || '').replace(/"/g, '""')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `outreach-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        // ==================== END OUTREACH ANALYTICS ====================

        // Mark a student as attended
        async function markWeeklyAttendance(studentId, studentName) {
            try {
                // Check if already marked
                const existing = checkinRecords.find(r => r.studentId === studentId);
                if (existing) {
                    alert('Student already marked as attended.');
                    return;
                }
                
                // Create attendance record
                await db.collection('attendance_records').add({
                    studentId: studentId,
                    studentName: studentName,
                    weekOf: checkinCurrentWeek,
                    checkedInAt: firebase.firestore.FieldValue.serverTimestamp(),
                    source: 'manual'
                });
                
                loadCheckinData();
            } catch (error) {
                console.error('Error marking attendance:', error);
                alert('Error marking attendance');
            }
        }
        
        // Remove attendance
        async function removeAttendance(recordId) {
            if (!confirm('Remove this attendance record?')) return;
            
            try {
                await db.collection('attendance_records').doc(recordId).delete();
                loadCheckinData();
            } catch (error) {
                console.error('Error removing attendance:', error);
                alert('Error removing attendance');
            }
        }
        
        // Mark all students as present
        async function markAllPresent() {
            const unmarked = checkinStudents.filter(s => !checkinRecords.find(r => r.studentId === s.id));
            if (unmarked.length === 0) {
                alert('All students already marked as attended.');
                return;
            }
            
            if (!confirm('Mark all ' + unmarked.length + ' remaining students as present?')) return;
            
            try {
                const batch = db.batch();
                unmarked.forEach(s => {
                    const ref = db.collection('attendance_records').doc();
                    batch.set(ref, {
                        studentId: s.id,
                        studentName: s.name || s.email,
                        weekOf: checkinCurrentWeek,
                        checkedInAt: firebase.firestore.FieldValue.serverTimestamp(),
                        source: 'manual'
                    });
                });
                await batch.commit();
                loadCheckinData();
            } catch (error) {
                console.error('Error marking all present:', error);
                alert('Error marking all present');
            }
        }
        
        // Clear all attendance for the week
        async function clearAllAttendance() {
            if (checkinRecords.length === 0) {
                alert('No attendance records to clear.');
                return;
            }
            
            if (!confirm('Clear ALL attendance records for this week? This cannot be undone.')) return;
            
            try {
                const batch = db.batch();
                checkinRecords.forEach(r => {
                    const ref = db.collection('attendance_records').doc(r.id);
                    batch.delete(ref);
                });
                await batch.commit();
                loadCheckinData();
            } catch (error) {
                console.error('Error clearing attendance:', error);
                alert('Error clearing attendance');
            }
        }

        // ==================== TUESDAY READING CLASS ====================
        var trSets = [];
        var trInputMode = 'text';
        var trGeneratedCards = [];
        var TR_MAX_SETS = 10;

        // LEFT side (Absolute Beginner / Novice) - 2 webhooks in sequence
        var TR_LEFT_SCENARIO_1 = 'https://hook.us1.make.com/ll6xp5y344i236cycriyi2ru85yvh1po';
        var TR_LEFT_SCENARIO_2 = 'https://hook.us1.make.com/xdv7jd4rdg1d6etm4naj9w2cc4f1fynm';
        // RIGHT side (Beginner and Up) - 2 webhooks in sequence
        var TR_RIGHT_SCENARIO_1 = 'https://hook.us1.make.com/2bg4hojfj0sqvdu7cgpjfrpjlu3dy4jk';
        var TR_RIGHT_SCENARIO_2 = 'https://hook.us1.make.com/cci2q6g601th336qlnqgwls6ubkalxxh';
        // Leaderboard - 2 webhooks in parallel
        var TR_LEADERBOARD_NOVICE = 'https://hook.us1.make.com/k7v6ihd0q43ydubdu4fp3ggpsqko2aba';
        var TR_LEADERBOARD_ADVANCED = 'https://hook.us1.make.com/15ltmrk4f3mubtkyc5pt07h2cjkblrjo';

        function initTuesdayReadingTab() {
            // Auto-add first set if none exist
            if (trSets.length === 0) {
                trSets.push({
                    mode: trInputMode,
                    text: '',
                    imageUrl: '',
                    extractedText: '',
                    processing: false
                });
            }
            renderTRSets();
            updateTRSetCounter();
        }

        function setTRInputMode(mode) {
            if (trInputMode === mode) return;
            trInputMode = mode;
            var textBtn = document.getElementById('trModeTextBtn');
            var imageBtn = document.getElementById('trModeImageBtn');
            if (mode === 'text') {
                textBtn.classList.add('tr-mode-active');
                imageBtn.classList.remove('tr-mode-active');
            } else {
                imageBtn.classList.add('tr-mode-active');
                textBtn.classList.remove('tr-mode-active');
            }
            // Update all existing sets to the new mode
            for (var i = 0; i < trSets.length; i++) {
                trSets[i].mode = mode;
                trSets[i].text = '';
                trSets[i].imageUrl = '';
                trSets[i].extractedText = '';
                trSets[i].processing = false;
            }
            renderTRSets();
        }

        function updateTRSetCounter() {
            var el = document.getElementById('trSetCount');
            if (el) el.textContent = trSets.length + 1;
            var btn = document.getElementById('trAddSetBtn');
            if (btn) {
                if (trSets.length >= TR_MAX_SETS) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = '';
                    btn.disabled = false;
                }
            }
        }

        function addTRSet() {
            if (trSets.length >= TR_MAX_SETS) {
                alert('Maximum ' + TR_MAX_SETS + ' sets allowed.');
                return;
            }
            trSets.push({
                mode: trInputMode,
                text: '',
                imageUrl: '',
                extractedText: '',
                processing: false
            });
            renderTRSets();
            // Fade in only the newly added set
            var newSetEl = document.getElementById('trSetBlock' + (trSets.length - 1));
            if (newSetEl) {
                newSetEl.classList.add('tr-set-fadein');
            }
        }

        function removeTRSet(idx) {
            trSets.splice(idx, 1);
            renderTRSets();
        }

        function renderTRSets() {
            var container = document.getElementById('trSetsContainer');
            updateTRSetCounter();

            if (trSets.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px;">No sets added yet. Click "âž• Add Set" to begin.</p>';
                return;
            }

            var html = '';
            for (var i = 0; i < trSets.length; i++) {
                var s = trSets[i];
                html += '<div class="tr-set-block" id="trSetBlock' + i + '">';
                html += '<div class="tr-set-header">';
                html += '<span class="tr-set-label">ðŸ“„ Set ' + (i + 1) + ' &mdash; ' + s.mode.toUpperCase() + ' input</span>';
                html += '<button class="btn btn-sm" style="background: rgba(255,51,102,0.2); border: 1px solid #ff3366; color: #ff3366; padding: 3px 10px; font-size: 11px;" onclick="removeTRSet(' + i + ')">âœ• Remove</button>';
                html += '</div>';

                if (s.mode === 'text') {
                    html += '<p style="font-size: 11px; color: #888; margin-bottom: 5px;">Enter 2-3 Korean sentences (one per line):</p>';
                    html += '<textarea id="trTextarea' + i + '" onblur="saveTRText(' + i + ')" placeholder="Enter Korean sentences, one per line...&#10;&#10;Example:&#10;ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ì•„ìš”.&#10;ì €ëŠ” í•œêµ­ì–´ë¥¼ ê³µë¶€í•©ë‹ˆë‹¤.&#10;ë‚´ì¼ í•™êµì— ê°ˆ ê±°ì˜ˆìš”.">' + escapeHtml(s.text) + '</textarea>';
                    // Show sentence count
                    var lineCount = s.text ? s.text.split('\n').filter(function(l) { return l.trim().length > 0; }).length : 0;
                    html += '<p style="font-size: 10px; color: #666; margin-top: 4px;">Sentences detected: ' + Math.min(lineCount, 3) + '/3' + (lineCount > 3 ? ' (only first 3 will be used)' : '') + '</p>';
                } else {
                    // IMAGE mode
                    html += '<p style="font-size: 11px; color: #888; margin-bottom: 5px;">Upload an image with Korean text &mdash; OCR / ChatGPT will extract it:</p>';
                    html += '<div class="tr-image-drop" onclick="document.getElementById(&apos;trFileInput' + i + '&apos;).click()">';
                    if (s.imageUrl) {
                        html += '<img src="' + s.imageUrl + '" style="max-width: 100%; max-height: 200px; border-radius: 6px; margin-bottom: 8px;">';
                        html += '<p style="color: #39ff14; font-size: 11px;">âœ… Image uploaded &mdash; click to replace</p>';
                    } else {
                        html += '<p style="color: #888; font-size: 13px;">ðŸ“· Click to upload image</p>';
                        html += '<p style="color: #555; font-size: 10px;">Supports JPG, PNG, WEBP</p>';
                    }
                    html += '</div>';
                    html += '<input type="file" id="trFileInput' + i + '" accept="image/*" style="display:none;" onchange="handleTRImageSelect(' + i + ', event)">';

                    // Processing indicator
                    if (s.processing) {
                        html += '<div style="margin-top: 10px; padding: 12px; background: rgba(255,0,255,0.1); border: 1px solid #ff00ff; border-radius: 6px; text-align: center;">';
                        html += '<span style="color: #ff00ff; font-size: 12px;">â³ Extracting Korean text via OCR...</span>';
                        html += '</div>';
                    }

                    // Show extracted text if available
                    if (s.extractedText) {
                        html += '<div class="tr-extracted-text">';
                        html += '<p style="font-size: 11px; color: #39ff14; margin-bottom: 5px; font-weight: 600;">ðŸ“ Extracted Text:</p>';
                        html += '<pre style="font-size: 13px; color: #fff; white-space: pre-wrap; margin: 0; font-family: &apos;Noto Sans&apos;, sans-serif;">' + escapeHtml(s.extractedText) + '</pre>';
                        var extractedCount = s.extractedText.split('\n').filter(function(l) { return l.trim().length > 0; }).length;
                        html += '<p style="font-size: 10px; color: #666; margin-top: 5px;">Sentences detected: ' + Math.min(extractedCount, 3) + '/3</p>';
                        html += '</div>';
                    }
                }

                html += '</div>';
            }

            container.innerHTML = html;
        }

        function saveTRText(idx) {
            var el = document.getElementById('trTextarea' + idx);
            if (el && trSets[idx]) {
                trSets[idx].text = el.value;
            }
        }

        function handleTRImageSelect(idx, event) {
            var file = event.target.files[0];
            if (!file) return;

            // Read as data URL for preview
            var reader = new FileReader();
            reader.onload = function(e) {
                trSets[idx].imageUrl = e.target.result;
                trSets[idx].processing = true;
                trSets[idx].extractedText = '';
                renderTRSets();
                // Run OCR extraction
                extractTRKoreanFromImage(idx, e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function extractTRKoreanFromImage(idx, base64DataUrl) {
            // Use the same Cloud Function endpoint the rest of the app uses
            var aiUrl = 'https://generateflashcardai-386010826708.us-central1.run.app';

            fetch(aiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: [
                        {
                            role: 'user',
                            content: [
                                { type: 'text', text: 'Extract ALL Korean text from this image. Return ONLY the Korean sentences, one per line. Do not include any English, numbers, or explanations. Just the raw Korean text lines.' },
                                { type: 'image_url', image_url: { url: base64DataUrl } }
                            ]
                        }
                    ],
                    model: 'gpt-4o',
                    max_tokens: 1000,
                    temperature: 0.1
                })
            })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                trSets[idx].processing = false;
                // Handle multiple response formats from the Cloud Function
                var extracted = '';
                if (data.data) {
                    // Cloud function wraps in { success: true, data: "..." }
                    extracted = typeof data.data === 'string' ? data.data : JSON.stringify(data.data);
                } else if (data.choices && data.choices[0] && data.choices[0].message) {
                    // Direct OpenAI format
                    extracted = data.choices[0].message.content;
                } else if (data.text) {
                    extracted = data.text;
                } else if (data.result) {
                    extracted = data.result;
                } else if (data.response) {
                    extracted = data.response;
                }

                extracted = extracted.trim();
                if (extracted) {
                    trSets[idx].extractedText = extracted;
                    trSets[idx].text = extracted;
                } else {
                    console.error('OCR response format:', data);
                    alert('Could not extract text. Check console for details.');
                }
                renderTRSets();
            })
            .catch(function(err) {
                trSets[idx].processing = false;
                console.error('OCR extraction error:', err);
                alert('OCR error: ' + err.message);
                renderTRSets();
            });
        }

        function getTRSentencesFromSet(setObj) {
            var rawText = setObj.text || '';
            if (!rawText.trim()) return [];
            var lines = rawText.split('\n');
            var result = [];
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (line.length > 0) {
                    result.push(line);
                }
                if (result.length >= 3) break;
            }
            return result;
        }

        function generateTRCards() {
            // Save any unsaved textarea content first
            for (var i = 0; i < trSets.length; i++) {
                if (trSets[i].mode === 'text') {
                    var el = document.getElementById('trTextarea' + i);
                    if (el) trSets[i].text = el.value;
                }
            }

            if (trSets.length === 0) {
                alert('Please add at least one set first.');
                return;
            }

            // Collect valid sets with sentences
            var validCards = [];
            for (var i = 0; i < trSets.length; i++) {
                var sentences = getTRSentencesFromSet(trSets[i]);
                if (sentences.length > 0) {
                    validCards.push({ setIndex: i, koreanSentences: sentences, translations: [] });
                }
            }

            if (validCards.length === 0) {
                alert('No Korean sentences found in any set. Please enter text or upload images first.');
                return;
            }

            // Show processing indicator
            var procEl = document.getElementById('trAIProcessing');
            if (procEl) procEl.style.display = 'block';

            // Gather all Korean sentences for batch translation
            var allKorean = [];
            for (var c = 0; c < validCards.length; c++) {
                for (var s = 0; s < validCards[c].koreanSentences.length; s++) {
                    allKorean.push(validCards[c].koreanSentences[s]);
                }
            }

            var translationPrompt = 'Translate each Korean sentence below into natural, conversational English. Return ONLY a valid JSON array where each element is an object with "korean" and "english" keys. No markdown, no backticks, no explanation.\n\nSentences:\n' + allKorean.join('\n');

            // Use the same AI endpoint used by Yodafy
            var aiUrl = 'https://generateflashcardai-386010826708.us-central1.run.app';

            fetch(aiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: translationPrompt, max_tokens: 2000 })
            })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (procEl) procEl.style.display = 'none';

                var resultText = data.text || data.result || data.response || JSON.stringify(data);
                var translations = [];
                var jsonMatch = resultText.match(/\[[\s\S]*?\]/);
                if (jsonMatch) {
                    try { translations = JSON.parse(jsonMatch[0]); } catch(e) { console.error('Parse error:', e); }
                }

                // Map translations back to cards
                var tIdx = 0;
                for (var c = 0; c < validCards.length; c++) {
                    validCards[c].translations = [];
                    for (var s = 0; s < validCards[c].koreanSentences.length; s++) {
                        var korean = validCards[c].koreanSentences[s];
                        var english = '';
                        if (tIdx < translations.length && translations[tIdx]) {
                            english = translations[tIdx].english || '';
                        }
                        validCards[c].translations.push({ korean: korean, english: english });
                        tIdx++;
                    }
                }

                trGeneratedCards = validCards;
                renderTRReadingCards();
            })
            .catch(function(err) {
                if (procEl) procEl.style.display = 'none';
                console.error('Translation API error:', err);

                // Fallback: show cards without translations
                for (var c = 0; c < validCards.length; c++) {
                    validCards[c].translations = [];
                    for (var s = 0; s < validCards[c].koreanSentences.length; s++) {
                        validCards[c].translations.push({
                            korean: validCards[c].koreanSentences[s],
                            english: '(translation pending)'
                        });
                    }
                }
                trGeneratedCards = validCards;
                renderTRReadingCards();
                alert('AI translation failed (' + err.message + '). Cards shown without translations. You can edit them manually.');
            });
        }

        function renderTRReadingCards() {
            if (trGeneratedCards.length === 0) return;

            // Remove existing overlay if any
            closeTRCardsPopup();

            // Create fullscreen overlay
            var overlay = document.createElement('div');
            overlay.id = 'trCardsOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,10,21,0.92);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:10000;overflow-y:auto;animation:trOverlayFadeIn 0.35s ease-out both;';

            // Red X close button
            var closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'âœ•';
            closeBtn.style.cssText = 'position:fixed;top:14px;right:14px;z-index:10001;background:rgba(255,68,68,0.9);color:#fff;border:none;width:36px;height:36px;border-radius:50%;font-size:18px;cursor:pointer;box-shadow:0 2px 12px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;transition:all 0.2s;';
            closeBtn.onmouseover = function() { this.style.background = '#ff4444'; this.style.transform = 'scale(1.15)'; };
            closeBtn.onmouseout = function() { this.style.background = 'rgba(255,68,68,0.9)'; this.style.transform = 'scale(1)'; };
            closeBtn.onclick = closeTRCardsPopup;

            // Content container
            var content = document.createElement('div');
            content.style.cssText = 'max-width:1100px;margin:60px auto 40px auto;padding:0 20px;';

            // Header
            var html = '';
            html += '<div style="text-align:center;margin-bottom:25px;">';
            html += '<h2 style="color:#ff00ff;font-size:24px;margin:0 0 8px 0;">ðŸƒ Reading Cards</h2>';
            html += '<p style="font-size:13px;color:#888;">Left = Absolute Beginner/Novice (1st sentence only) | Right = Beginner and Up (all sentences)</p>';
            html += '</div>';

            // Cards
            for (var c = 0; c < trGeneratedCards.length; c++) {
                var card = trGeneratedCards[c];
                var t = card.translations;
                var cardNum = c + 1;

                html += '<div class="tr-reading-card" style="animation:trCardSlideIn 0.4s ease-out both;animation-delay:' + (c * 0.1) + 's;">';

                // Card Header
                html += '<div class="tr-card-header">';
                html += '<div class="tr-card-header-title">ðŸƒ Card ' + cardNum + '</div>';
                html += '<div class="tr-card-header-meta">' + t.length + ' sentence' + (t.length > 1 ? 's' : '') + ' &bull; Set ' + (card.setIndex + 1) + '</div>';
                html += '</div>';

                // Column Headers
                html += '<div class="tr-col-header">';
                html += '<div class="tr-col-header-cell novice-label">ðŸŒ± Absolute Beginner / Novice</div>';
                html += '<div class="tr-col-header-cell begup-label">ðŸŒŸ Beginner and Up</div>';
                html += '</div>';

                // Two-column body
                html += '<div class="tr-card-columns">';

                // LEFT COLUMN - Absolute Beginner / Novice (first sentence only)
                html += '<div class="tr-card-col tr-card-col-left">';
                if (t.length > 0) {
                    html += '<div class="tr-sentence-item">';
                    html += '<div class="tr-korean-text">' + escapeHtml(t[0].korean) + '</div>';
                    html += '<div class="tr-english-text">' + escapeHtml(t[0].english) + '</div>';
                    html += '</div>';
                }
                html += '<div class="tr-check-area">';
                html += '<button class="tr-check-btn" onclick="trSendCheck(&apos;novice&apos;, ' + c + ')">âœ… Check</button>';
                html += '<span class="tr-pts">+10 pts</span>';
                html += '</div>';
                html += '</div>';

                // RIGHT COLUMN - Beginner and Up (all sentences)
                html += '<div class="tr-card-col tr-card-col-right">';
                for (var s = 0; s < t.length; s++) {
                    html += '<div class="tr-sentence-item">';
                    html += '<div class="tr-korean-text">' + escapeHtml(t[s].korean) + '</div>';
                    html += '<div class="tr-english-text">' + escapeHtml(t[s].english) + '</div>';
                    html += '</div>';
                }
                html += '<div class="tr-check-area">';
                html += '<button class="tr-check-btn" onclick="trSendCheck(&apos;beginner&apos;, ' + c + ')">âœ… Check</button>';
                html += '<span class="tr-pts">+10 pts</span>';
                html += '</div>';
                html += '</div>';

                html += '</div>'; // close tr-card-columns
                html += '</div>'; // close tr-reading-card
            }

            // End Round button centered beneath all cards
            html += '<div style="text-align:center;margin-top:35px;padding-top:25px;border-top:2px solid #333;">';
            html += '<button class="btn" onclick="trEndRoundAndLeaderboard()" style="background:linear-gradient(135deg,#ff9800,#f44336);border-color:#ff9800;color:#fff;font-size:16px;padding:15px 40px;border-radius:12px;font-weight:600;">ðŸ† End Round & See Leaderboard</button>';
            html += '</div>';

            content.innerHTML = html;
            overlay.appendChild(closeBtn);
            overlay.appendChild(content);
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
        }

        function closeTRCardsPopup() {
            var overlay = document.getElementById('trCardsOverlay');
            if (overlay) overlay.remove();
            document.body.style.overflow = '';
        }

        function trSendCheck(side, cardIndex) {
            var card = trGeneratedCards[cardIndex];
            if (!card) return;

            var scenario1Url = (side === 'novice') ? TR_LEFT_SCENARIO_1 : TR_RIGHT_SCENARIO_1;
            var scenario2Url = (side === 'novice') ? TR_LEFT_SCENARIO_2 : TR_RIGHT_SCENARIO_2;

            var sentences = [];
            if (side === 'novice') {
                if (card.translations.length > 0) {
                    sentences.push(card.translations[0]);
                }
            } else {
                sentences = card.translations;
            }

            // Find the button
            var cardEls = document.querySelectorAll('.tr-reading-card');
            var cardEl = cardEls[cardIndex];
            var sideClass = (side === 'novice') ? 'tr-card-col-left' : 'tr-card-col-right';
            var btn = null;
            if (cardEl) {
                var colEl = cardEl.querySelector('.' + sideClass);
                if (colEl) btn = colEl.querySelector('.tr-check-btn');
            }

            if (btn) {
                btn.disabled = true;
                btn.classList.add('checking');
                btn.innerHTML = 'â³ Fetching transcripts...';
            }

            // Step 1: Fetch transcripts
            fetch(scenario1Url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'fetch_transcripts',
                    timestamp: new Date().toISOString()
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Fetch transcripts failed (' + response.status + ')');
                }
                return response.text().catch(function() { return ''; });
            })
            .then(function() {
                // Wait for Scenario 1 to finish processing on Make.com before calling Scenario 2
                if (btn) btn.innerHTML = 'â³ Processing transcripts...';
                return new Promise(function(resolve) { setTimeout(resolve, 5000); });
            })
            .then(function() {
                // Step 2: Grade students
                if (btn) btn.innerHTML = 'â³ Grading students...';

                var koreanText = sentences.map(function(s) { return s.korean; }).join('\n');
                var englishText = sentences.map(function(s) { return s.english; }).join('\n');

                var payload = {
                    action: 'check_answer',
                    korean_sentence: koreanText,
                    english_translation: englishText,
                    card_index: cardIndex,
                    side: side,
                    points: 10,
                    timestamp: new Date().toISOString()
                };

                return fetch(scenario2Url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json().catch(function() { return {}; });
                } else {
                    throw new Error('Grading failed (' + response.status + ')');
                }
            })
            .then(function(result) {
                if (btn) {
                    btn.classList.remove('checking');
                    btn.classList.add('success');
                    var matchCount = result.matched_count || result.matchedCount || 0;
                    btn.innerHTML = 'âœ… ' + matchCount + ' matched';
                }

                setTimeout(function() {
                    if (btn) {
                        btn.classList.remove('success');
                        btn.disabled = false;
                        btn.innerHTML = 'âœ… Check';
                    }
                }, 5000);
            })
            .catch(function(err) {
                console.error('TR webhook error (' + side + '):', err);
                if (btn) {
                    btn.classList.remove('checking');
                    btn.classList.add('error');
                    btn.innerHTML = 'âŒ Error';
                }

                setTimeout(function() {
                    if (btn) {
                        btn.classList.remove('error');
                        btn.disabled = false;
                        btn.innerHTML = 'âœ… Check';
                    }
                }, 3000);
            });
        }

        function trEndRoundAndLeaderboard() {
            // Find the leaderboard button
            var btns = document.querySelectorAll('#trCardsOverlay button');
            var btn = null;
            for (var i = 0; i < btns.length; i++) {
                if (btns[i].textContent.indexOf('Leaderboard') !== -1 || btns[i].textContent.indexOf('leaderboard') !== -1) {
                    btn = btns[i];
                    break;
                }
            }

            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.innerHTML = 'â³ Posting leaderboards...';
            }

            // Call both leaderboard webhooks in parallel
            Promise.all([
                fetch(TR_LEADERBOARD_NOVICE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'post_leaderboard',
                        timestamp: new Date().toISOString()
                    })
                }),
                fetch(TR_LEADERBOARD_ADVANCED, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'post_leaderboard',
                        timestamp: new Date().toISOString()
                    })
                })
            ])
            .then(function(responses) {
                var allOk = responses.every(function(r) { return r.ok; });
                if (!allOk) {
                    throw new Error('One or more leaderboard posts failed');
                }
                if (btn) {
                    btn.innerHTML = 'âœ… Leaderboards Posted!';
                    btn.style.background = 'linear-gradient(135deg, #39ff14, #00cc00)';
                    btn.style.borderColor = '#39ff14';
                }

                setTimeout(function() {
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.innerHTML = 'ðŸ† End Round & See Leaderboard';
                        btn.style.background = 'linear-gradient(135deg, #ff9800, #f44336)';
                        btn.style.borderColor = '#ff9800';
                    }
                }, 5000);
            })
            .catch(function(error) {
                console.error('TR leaderboard webhook error:', error);
                if (btn) {
                    btn.innerHTML = 'âŒ Error posting';
                    btn.style.background = '#ff4444';
                    btn.style.borderColor = '#ff4444';
                }

                setTimeout(function() {
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.innerHTML = 'ðŸ† End Round & See Leaderboard';
                        btn.style.background = 'linear-gradient(135deg, #ff9800, #f44336)';
                        btn.style.borderColor = '#ff9800';
                    }
                }, 3000);
            });
        }

        function showTRLeaderboard(data) {
            // Build leaderboard modal
            var overlay = document.createElement('div');
            overlay.id = 'trLeaderboardModal';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);z-index:10000;display:flex;align-items:center;justify-content:center;';

            var html = '';
            html += '<div style="background:#1a1a2e;border:3px solid #ff9800;border-radius:15px;padding:30px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">';
            html += '<h2 style="color:#ff9800;text-align:center;margin:0 0 20px 0;font-size:22px;">ðŸ† Leaderboard</h2>';

            if (data && data.leaderboard && data.leaderboard.length > 0) {
                for (var i = 0; i < data.leaderboard.length; i++) {
                    var entry = data.leaderboard[i];
                    var medal = '';
                    if (i === 0) medal = 'ðŸ¥‡';
                    else if (i === 1) medal = 'ðŸ¥ˆ';
                    else if (i === 2) medal = 'ðŸ¥‰';
                    else medal = (i + 1) + '.';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid #333;font-family:&apos;Noto Sans&apos;,sans-serif;">';
                    html += '<span style="color:#fff;font-size:15px;">' + medal + ' ' + escapeHtml(entry.name || 'Student') + '</span>';
                    html += '<span style="color:#ff9800;font-weight:700;font-size:15px;">' + (entry.score || 0) + ' pts</span>';
                    html += '</div>';
                }
            } else {
                html += '<div style="text-align:center;padding:25px;">';
                html += '<p style="color:#ff9800;font-size:16px;margin-bottom:8px;">ðŸ† Round Complete!</p>';
                html += '<p style="color:#888;font-size:12px;">Leaderboard data will appear here once the webhook endpoint is configured.</p>';
                html += '</div>';
            }

            html += '<div style="text-align:center;margin-top:20px;">';
            html += '<button onclick="closeTRLeaderboard()" style="background:rgba(255,255,255,0.1);border:2px solid #888;color:#fff;padding:10px 30px;border-radius:8px;font-size:13px;cursor:pointer;">âœ• Close</button>';
            html += '</div>';
            html += '</div>';

            overlay.innerHTML = html;
            document.body.appendChild(overlay);
        }

        function closeTRLeaderboard() {
            var modal = document.getElementById('trLeaderboardModal');
            if (modal) modal.remove();
        }

        function clearAllTR() {
            if (trSets.length > 0 || trGeneratedCards.length > 0) {
                if (!confirm('Clear all sets and generated cards?')) return;
            }
            trSets = [];
            trGeneratedCards = [];
            renderTRSets();
            var displayArea = document.getElementById('trCardsDisplayArea');
            if (displayArea) displayArea.style.display = 'none';
        }
        // ==================== END TUESDAY READING CLASS ====================

        // ==================== MATERIALS CREATOR ====================
        var matSlides = [];
        var matCurrentSlide = 0;
        var MAT_BG_URL = 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/background_for_reading_class.png?v=1770557568';

        function openMaterialsCreator() {
            var overlay = document.getElementById('materialsOverlay');
            if (overlay) {
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                matUpdateSlideCount();
            }
        }

        function closeMaterialsCreator() {
            var overlay = document.getElementById('materialsOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function matUpdateSlideCount() {
            var slides = matParseSlides();
            var el = document.getElementById('matSlideCount');
            if (el) el.textContent = slides.length;
        }

        (function() {
            var pollInterval = setInterval(function() {
                var ta = document.getElementById('matTextInput');
                if (ta) { ta.addEventListener('input', matUpdateSlideCount); clearInterval(pollInterval); }
            }, 500);
        })();

        function matParseSlides() {
            var textarea = document.getElementById('matTextInput');
            if (!textarea) return [];
            var raw = textarea.value;
            if (!raw.trim()) return [];
            var groups = raw.split(/\n\s*\n/);
            var slides = [];
            for (var g = 0; g < groups.length; g++) {
                var lines = groups[g].split('\n').filter(function(l) { return l.trim().length > 0; });
                if (lines.length === 0) continue;
                // Split each line further by sentence-ending punctuation
                var allSentences = [];
                for (var i = 0; i < lines.length; i++) {
                    // Don't split inside quotes - keep quoted blocks together
                    var line = lines[i].trim();
                    var quotedParts = [];
                    var remaining = line;
                    // Extract quoted blocks first
                    var quoteRegex = /[""\u201C]([^""\u201D]*?)[""\u201D]/g;
                    var lastIdx = 0;
                    var qm;
                    while ((qm = quoteRegex.exec(line)) !== null) {
                        // Add text before quote
                        var before = line.substring(lastIdx, qm.index).trim();
                        if (before) {
                            var bParts = before.split(/(?<=[.!?ã€‚])\s+/);
                            for (var bp = 0; bp < bParts.length; bp++) { if (bParts[bp].trim()) quotedParts.push(bParts[bp].trim()); }
                        }
                        // Add entire quoted block as one unit
                        quotedParts.push(qm[0].trim());
                        lastIdx = qm.index + qm[0].length;
                    }
                    // Add remaining text after last quote
                    var after = line.substring(lastIdx).trim();
                    if (after) {
                        var aParts = after.split(/(?<=[.!?ã€‚])\s+/);
                        for (var ap = 0; ap < aParts.length; ap++) { if (aParts[ap].trim()) quotedParts.push(aParts[ap].trim()); }
                    }
                    // If no quotes found, split normally
                    if (quotedParts.length === 0) {
                        var parts = line.split(/(?<=[.!?ã€‚]["'"ã€ã€\)]?)\s+/);
                        for (var p = 0; p < parts.length; p++) { if (parts[p].trim()) quotedParts.push(parts[p].trim()); }
                    }
                    for (var q = 0; q < quotedParts.length; q++) {
                        var s = quotedParts[q];
                        if (s.length > 0 && s !== '"' && s !== '\u201D' && s !== "'" && s !== '\u2019') allSentences.push(s);
                    }
                }
                // Group into slides of up to 3 sentences
                for (var k = 0; k < allSentences.length; k += 3) {
                    var chunk = allSentences.slice(k, k + 3);
                    slides.push({ sentences: chunk });
                }
            }
            return slides;
        }

        function matGenerateSlides() {
            var parsed = matParseSlides();
            if (parsed.length === 0) { alert('Please enter at least one Korean sentence.'); return; }
            matSlides = parsed;
            matCurrentSlide = 0;
            matRenderSlideshow();
            document.getElementById('matExportBtns').style.display = 'flex';
        }

        function matRegenerateSlides() {
            if (matSlides.length > 0) matRenderSlideshow();
        }

        function matRenderSlideshow() {
            var area = document.getElementById('matSlideshowArea');
            if (!area) return;
            var fs = (parseInt(document.getElementById('matFontSize').value) || 30) + 'px';
            var html = '<div class="mat-slideshow" onclick="matExpandPreview()">';
            for (var i = 0; i < matSlides.length; i++) {
                var s = matSlides[i];
                var ac = (i === matCurrentSlide) ? ' active' : '';
                html += '<div class="mat-slide' + ac + '" data-slide="' + i + '">';
                html += '<img class="mat-slide-bg" src="' + MAT_BG_URL + '" alt="" crossorigin="anonymous">';
                html += '<div class="mat-slide-content" style="font-size:' + fs + ';">';
                for (var j = 0; j < s.sentences.length; j++) {
                    html += '<div class="mat-slide-korean">' + escapeHtml(s.sentences[j]) + '</div>';
                }
                html += '</div>';
                html += '<div class="mat-slide-number">' + (i + 1) + ' / ' + matSlides.length + '</div>';
                html += '</div>';
            }
            html += '</div>';
            html += '<div class="mat-slide-nav" onclick="event.stopPropagation()">';
            html += '<button onclick="event.stopPropagation(); matPrevSlide()" id="matPrevBtn">&#9664; Prev</button>';
            html += '<span id="matSlideIndicator">' + (matCurrentSlide + 1) + ' / ' + matSlides.length + '</span>';
            html += '<button onclick="event.stopPropagation(); matNextSlide()" id="matNextBtn">Next &#9654;</button>';
            html += '</div>';
            html += '<div class="mat-slide-dots" onclick="event.stopPropagation()">';
            for (var d = 0; d < matSlides.length; d++) {
                html += '<div class="mat-slide-dot' + (d === matCurrentSlide ? ' active' : '') + '" onclick="event.stopPropagation(); matGoToSlide(' + d + ')"></div>';
            }
            html += '</div>';
            area.innerHTML = html;
            matUpdateNav();
        }

        function matGoToSlide(idx) {
            if (idx < 0 || idx >= matSlides.length) return;
            matCurrentSlide = idx;
            var slides = document.querySelectorAll('.mat-slide');
            for (var i = 0; i < slides.length; i++) slides[i].classList.toggle('active', i === idx);
            var dots = document.querySelectorAll('.mat-slide-dot');
            for (var i = 0; i < dots.length; i++) dots[i].classList.toggle('active', i === idx);
            matUpdateNav();
        }
        function matPrevSlide() { matGoToSlide(matCurrentSlide - 1); }
        function matNextSlide() { matGoToSlide(matCurrentSlide + 1); }
        function matUpdateNav() {
            var prev = document.getElementById('matPrevBtn');
            var next = document.getElementById('matNextBtn');
            var ind = document.getElementById('matSlideIndicator');
            if (prev) prev.disabled = matCurrentSlide <= 0;
            if (next) next.disabled = matCurrentSlide >= matSlides.length - 1;
            if (ind) ind.textContent = (matCurrentSlide + 1) + ' / ' + matSlides.length;
        }

        function matExportPDF() {
            if (matSlides.length === 0) { alert('No slides to export.'); return; }

            // Dynamically load html2canvas and jsPDF if not already loaded
            function loadScript(src) {
                return new Promise(function(resolve, reject) {
                    if (document.querySelector('script[src="' + src + '"]')) { resolve(); return; }
                    var s = document.createElement('script');
                    s.src = src;
                    s.onload = resolve;
                    s.onerror = reject;
                    document.head.appendChild(s);
                });
            }

            var btn = document.querySelector('.mat-btn-pdf');
            if (btn) { btn.textContent = 'â³ Generating...'; btn.disabled = true; }

            Promise.all([
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'),
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')
            ]).then(function() {
                var fs = (parseInt(document.getElementById('matFontSize').value) || 30);
                // Scale font: preview width to native 1920 canvas (same as expanded view)
                var previewWidth = document.querySelector('.mat-slideshow') ? document.querySelector('.mat-slideshow').offsetWidth : 760;
                var scaledFs = Math.round(fs * (1920 / previewWidth));

                // Create an offscreen container
                var offscreen = document.createElement('div');
                offscreen.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:1920px;height:1080px;z-index:-1;';
                document.body.appendChild(offscreen);

                // Build slide capture function (runs sequentially)
                function captureSlide(idx) {
                    return new Promise(function(resolve) {
                        var slide = document.createElement('div');
                        slide.style.cssText = 'width:1920px;height:1080px;position:relative;overflow:hidden;';

                        var img = document.createElement('img');
                        img.crossOrigin = 'anonymous';
                        img.src = MAT_BG_URL + (MAT_BG_URL.indexOf('?') >= 0 ? '&' : '?') + '_t=' + Date.now();
                        img.style.cssText = 'position:absolute;top:0;left:0;width:1920px;height:1080px;z-index:0;';

                        var content = document.createElement('div');
                        content.style.cssText = 'position:absolute;top:123px;left:155px;right:155px;bottom:123px;z-index:1;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;overflow:hidden;';

                        var s = matSlides[idx];
                        for (var j = 0; j < s.sentences.length; j++) {
                            var line = document.createElement('div');
                            line.style.cssText = 'font-size:' + scaledFs + 'px;font-weight:700;color:#000;line-height:1.6;word-break:keep-all;width:100%;text-align:center;font-family:"Noto Sans KR",sans-serif;';
                            line.textContent = s.sentences[j];
                            content.appendChild(line);
                        }

                        var num = document.createElement('div');
                        num.style.cssText = 'position:absolute;bottom:20px;right:30px;font-size:20px;color:#000;opacity:0.3;z-index:1;font-family:"Noto Sans KR",sans-serif;';
                        num.textContent = (idx + 1) + ' / ' + matSlides.length;

                        slide.appendChild(img);
                        slide.appendChild(content);
                        slide.appendChild(num);
                        offscreen.innerHTML = '';
                        offscreen.appendChild(slide);

                        function doCapture() {
                            // Timeout safety: resolve with blank after 10s
                            var timeout = setTimeout(function() {
                                console.warn('PDF capture timeout for slide', idx + 1);
                                resolve(null);
                            }, 10000);

                            html2canvas(slide, {
                                width: 1920,
                                height: 1080,
                                scale: 1,
                                useCORS: true,
                                allowTaint: true,
                                backgroundColor: '#ffffff'
                            }).then(function(canvas) {
                                clearTimeout(timeout);
                                resolve(canvas.toDataURL('image/jpeg', 0.95));
                            }).catch(function(err) {
                                clearTimeout(timeout);
                                console.error('PDF capture error slide', idx + 1, err);
                                resolve(null);
                            });
                        }

                        if (img.complete && img.naturalWidth > 0) {
                            doCapture();
                        } else {
                            img.onload = doCapture;
                            img.onerror = function() {
                                console.warn('BG image failed to load for slide', idx + 1);
                                doCapture(); // Capture anyway without image
                            };
                        }
                    });
                }

                // Process slides sequentially
                var results = [];
                var chain = Promise.resolve();
                for (var i = 0; i < matSlides.length; i++) {
                    (function(idx) {
                        chain = chain.then(function() {
                            if (btn) btn.textContent = 'â³ Slide ' + (idx + 1) + '/' + matSlides.length + '...';
                            return captureSlide(idx);
                        }).then(function(dataUrl) {
                            results[idx] = dataUrl;
                        });
                    })(i);
                }

                chain.then(function() {
                    // Custom 16:9 page: 340mm x 191.25mm
                    var pageW = 340;
                    var pageH = 191.25;
                    var pdf = new jspdf.jsPDF({ orientation: 'landscape', unit: 'mm', format: [pageH, pageW] });

                    for (var i = 0; i < results.length; i++) {
                        if (i > 0) pdf.addPage();
                        pdf.addImage(results[i], 'JPEG', 0, 0, pageW, pageH);
                    }

                    pdf.save('KoreanLearnin_Reading_Materials.pdf');
                    document.body.removeChild(offscreen);
                    if (btn) { btn.textContent = 'ðŸ“„ Export PDF'; btn.disabled = false; }
                });
            }).catch(function(err) {
                console.error('PDF export error:', err);
                alert('Failed to load PDF libraries. Please check your internet connection.');
                if (btn) { btn.textContent = 'ðŸ“„ Export PDF'; btn.disabled = false; }
            });
        }

        function matExportHTML() {
            if (matSlides.length === 0) { alert('No slides to export.'); return; }
            var fs = parseInt(document.getElementById('matFontSize').value) || 30;
            var totalSlides = matSlides.length;
            var cacheJSON = JSON.stringify(matWordCache || {});

            // Calculate native font size on 1920 canvas
            var previewWidth = document.querySelector('.mat-slideshow') ? document.querySelector('.mat-slideshow').offsetWidth : 760;
            var nativeFs = Math.round(fs * (1920 / previewWidth));

            // Build slides data as JSON for the exported file
            var slidesJSON = JSON.stringify(matSlides.map(function(s) { return { sentences: s.sentences }; }));

            var h = '';
            h += '<!DOCTYPE html>\n<html lang="ko">\n<head>\n';
            h += '<meta charset="UTF-8">\n';
            h += '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n';
            h += '<title>KoreanLearnin Reading Materials</title>\n';
            h += '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">\n';
            h += '<style>\n';

            // --- CSS - scoped to container ---
            h += '.kl-reader { font-family:"Noto Sans KR",sans-serif; width:100%; margin:0 auto; display:flex; flex-direction:column; align-items:center; gap:10px; padding:10px 0; -webkit-tap-highlight-color:transparent; }\n';

            // Slide wrapper - sized by JS
            h += '.kl-reader .slide-wrap { position:relative; overflow:hidden; flex-shrink:0; width:100%; }\n';

            // Inner canvas at native 1920x1080
            h += '.kl-reader .slide-inner { position:relative; width:1920px; height:1080px; transform-origin:top left; }\n';

            // Each slide
            h += '.kl-reader .slide { position:absolute; top:0; left:0; width:1920px; height:1080px; opacity:0; transition:opacity 0.5s ease; pointer-events:none; }\n';
            h += '.kl-reader .slide.active { opacity:1; pointer-events:auto; }\n';
            h += '.kl-reader .slide-bg { position:absolute; top:0; left:0; width:1920px; height:1080px; }\n';

            // Content area - positioned inside the white box
            h += '.kl-reader .content { position:absolute; top:123px; left:155px; right:155px; bottom:123px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; z-index:2; overflow:hidden; text-align:center; }\n';
            h += '.kl-reader .sentence { display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:12px; width:100%; }\n';

            // Interactive words
            h += '.kl-reader .word { font-size:' + nativeFs + 'px; font-weight:700; color:#000; cursor:pointer; padding:6px 8px; border-radius:6px; transition:all 0.15s; position:relative; user-select:none; line-height:1.5; }\n';
            h += '.kl-reader .word:hover { background:rgba(0,200,255,0.25); transform:scale(1.05); }\n';
            h += '.kl-reader .word.playing { background:rgba(255,0,255,0.25); transform:scale(1.08); }\n';

            // Tooltip
            h += '.kl-reader .word .tip { position:absolute; bottom:calc(100% + 14px); left:50%; transform:translateX(-50%); background:linear-gradient(135deg,#1a1a2e,#2d2748); color:#fff; padding:20px 24px; border-radius:12px; min-width:300px; max-width:420px; z-index:3000; box-shadow:0 8px 30px rgba(0,0,0,0.7); border:2px solid #00ffff; opacity:0; visibility:hidden; transition:all 0.2s ease; pointer-events:none; white-space:normal; text-align:left; font-size:16px; font-weight:400; }\n';
            h += '.kl-reader .word:hover .tip { opacity:1; visibility:visible; }\n';
            h += '.kl-reader .word .tip::after { content:""; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:8px solid transparent; border-top-color:#00ffff; }\n';
            h += '.kl-reader .word .tip.show { opacity:1; visibility:visible; }\n';
            h += '.kl-reader .word.tip-left .tip { left:0; transform:translateX(0); }\n';
            h += '.kl-reader .word.tip-left .tip::after { left:30px; transform:none; }\n';
            h += '.kl-reader .word.tip-right .tip { left:auto; right:0; transform:translateX(0); }\n';
            h += '.kl-reader .word.tip-right .tip::after { left:auto; right:30px; transform:none; }\n';

            // Slide number
            h += '.kl-reader .num { position:absolute; bottom:20px; right:30px; font-size:22px; color:#000; opacity:0.3; z-index:2; }\n';

            // Navigation bar
            h += '.kl-reader .nav { display:flex; gap:15px; align-items:center; z-index:100; background:rgba(30,30,30,0.85); backdrop-filter:blur(10px); padding:12px 24px; border-radius:50px; border:1px solid rgba(255,255,255,0.15); flex-shrink:0; }\n';
            h += '.kl-reader .nav button { padding:10px 22px; background:rgba(255,0,255,0.25); border:2px solid #ff00ff; border-radius:8px; color:#ff00ff; font-size:14px; cursor:pointer; transition:all 0.2s; font-family:inherit; }\n';
            h += '.kl-reader .nav button:hover { background:rgba(255,0,255,0.45); }\n';
            h += '.kl-reader .nav button:disabled { opacity:0.3; cursor:not-allowed; }\n';
            h += '.kl-reader .nav span { color:#888; font-size:14px; min-width:80px; text-align:center; }\n';

            // Dots
            h += '.kl-reader .dots { display:flex; gap:6px; z-index:100; flex-shrink:0; }\n';
            h += '.kl-reader .dot { width:10px; height:10px; border-radius:50%; background:rgba(255,0,255,0.25); border:1px solid rgba(255,0,255,0.4); cursor:pointer; transition:all 0.2s; }\n';
            h += '.kl-reader .dot.active { background:#ff00ff; box-shadow:0 0 8px rgba(255,0,255,0.5); }\n';

            // Mobile: disable CSS hover tooltips
            h += '@media (hover:none) {\n';
            h += '  .kl-reader .word:hover .tip { opacity:0; visibility:hidden; }\n';
            h += '  .kl-reader .word .tip.show { opacity:1 !important; visibility:visible !important; }\n';
            h += '}\n';

            h += '</style>\n</head>\n<body>\n';

            // --- HTML structure - self-contained container ---
            h += '<div class="kl-reader" id="klReader">\n';
            h += '  <div class="slide-wrap" id="slideWrap">\n';
            h += '    <div class="slide-inner" id="slideInner"></div>\n';
            h += '  </div>\n';
            h += '  <div class="nav">\n';
            h += '    <button id="pb" onclick="go(-1)">&#9664; Prev</button>\n';
            h += '    <span id="ind">1 / ' + totalSlides + '</span>\n';
            h += '    <button id="nb" onclick="go(1)">Next &#9654;</button>\n';
            h += '  </div>\n';
            h += '  <div class="dots" id="dots"></div>\n';
            h += '</div>\n';

            // --- JavaScript ---
            h += '<script>\n';

            // Embed data
            h += 'var slides = ' + slidesJSON + ';\n';
            h += 'var wordCache = ' + cacheJSON + ';\n';
            h += 'var totalSlides = ' + totalSlides + ';\n';
            h += 'var currentSlide = 0;\n';
            h += 'var currentAudio = null;\n';
            h += 'var activeTooltip = null;\n';
            h += 'var isMobile = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);\n';
            h += 'var BG_URL = "' + MAT_BG_URL + '";\n';
            h += 'var TTS_PROXY = "https://tts-proxy-386010826708.us-central1.run.app";\n';

            // Escape helper
            h += 'function esc(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML;}\n';

            // Scale function
            h += 'function scaleSlide() {\n';
            h += '  var reader = document.getElementById("klReader");\n';
            h += '  var wrap = document.getElementById("slideWrap");\n';
            h += '  var inner = document.getElementById("slideInner");\n';
            h += '  var availW = reader.offsetWidth;\n';
            h += '  var s = availW / 1920;\n';
            h += '  wrap.style.width = Math.round(1920 * s) + "px";\n';
            h += '  wrap.style.height = Math.round(1080 * s) + "px";\n';
            h += '  inner.style.transform = "scale(" + s + ")";\n';
            h += '}\n';

            // Build tooltip HTML from cache
            h += 'function buildTip(word) {\n';
            h += '  var info = wordCache[word];\n';
            h += '  if (!info) return "<div style=\\"color:#00ffff;font-size:22px;font-weight:700;\\">" + esc(word) + "</div><div style=\\"color:#888;font-size:14px;\\">No data available</div>";\n';
            h += '  var html = "";\n';
            h += '  html += "<div style=\\"color:#00ffff;font-size:22px;font-weight:700;margin-bottom:8px;\\">" + esc(word) + "</div>";\n';
            h += '  html += "<div style=\\"color:#fff;font-size:18px;margin-bottom:8px;\\">ðŸŒ " + esc(info.english || "") + "</div>";\n';
            h += '  if (info.pos) html += "<div style=\\"color:#ff00ff;font-size:15px;font-style:italic;margin-bottom:6px;\\">" + esc(info.pos) + "</div>";\n';
            h += '  if (info.particles) html += "<div style=\\"color:#39ff14;font-size:14px;line-height:1.5;\\">ðŸ”— " + esc(info.particles) + "</div>";\n';
            h += '  if (info.dictionary_form) html += "<div style=\\"color:#aaa;font-size:14px;line-height:1.5;\\">ðŸ“– Dictionary: " + esc(info.dictionary_form) + "</div>";\n';
            h += '  if (info.conjugation) html += "<div style=\\"color:#aaa;font-size:14px;line-height:1.5;\\">ðŸ”„ " + esc(info.conjugation) + "</div>";\n';
            h += '  if (info.contraction) html += "<div style=\\"color:#ffd700;font-size:14px;line-height:1.5;\\">âœ‚ï¸ " + esc(info.contraction) + "</div>";\n';
            h += '  return html;\n';
            h += '}\n';

            // Render slides
            h += 'function renderSlides() {\n';
            h += '  var inner = document.getElementById("slideInner");\n';
            h += '  var dotsEl = document.getElementById("dots");\n';
            h += '  var html = "";\n';
            h += '  var dotsHtml = "";\n';
            h += '  for (var i = 0; i < slides.length; i++) {\n';
            h += '    var ac = (i === 0) ? " active" : "";\n';
            h += '    html += "<div class=\\"slide" + ac + "\\">";\n';
            h += '    html += "<img class=\\"slide-bg\\" src=\\"" + BG_URL + "\\" alt=\\"\\">";\n';
            h += '    html += "<div class=\\"content\\">";\n';
            h += '    for (var j = 0; j < slides[i].sentences.length; j++) {\n';
            h += '      html += "<div class=\\"sentence\\">";\n';
            h += '      var words = slides[i].sentences[j].split(/\\s+/);\n';
            h += '      for (var w = 0; w < words.length; w++) {\n';
            h += '        if (!words[w]) continue;\n';
            h += '        html += "<span class=\\"word\\" data-word=\\"" + esc(words[w]) + "\\" onclick=\\"onWord(this)\\">";\n';
            h += '        html += esc(words[w]);\n';
            h += '        html += "<div class=\\"tip\\">" + buildTip(words[w]) + "</div>";\n';
            h += '        html += "</span>";\n';
            h += '      }\n';
            h += '      html += "</div>";\n';
            h += '    }\n';
            h += '    html += "</div>";\n';
            h += '    html += "<div class=\\"num\\">" + (i+1) + " / " + slides.length + "</div>";\n';
            h += '    html += "</div>";\n';
            h += '    dotsHtml += "<div class=\\"dot" + (i===0?" active":"") + "\\" onclick=\\"goTo(" + i + ")\\"></div>";\n';
            h += '  }\n';
            h += '  inner.innerHTML = html;\n';
            h += '  dotsEl.innerHTML = dotsHtml;\n';
            h += '}\n';

            // Word click/tap handler
            h += 'function onWord(el) {\n';
            h += '  event.stopPropagation();\n';
            h += '  var word = el.getAttribute("data-word");\n';
            h += '  playWord(el, word);\n';
            h += '  if (isMobile) {\n';
            h += '    var tip = el.querySelector(".tip");\n';
            h += '    if (activeTooltip && activeTooltip !== tip) activeTooltip.classList.remove("show");\n';
            h += '    if (tip) { tip.classList.toggle("show"); activeTooltip = tip.classList.contains("show") ? tip : null; }\n';
            h += '  }\n';
            h += '}\n';

            // TTS
            h += 'function playWord(el, word) {\n';
            h += '  document.querySelectorAll(".word.playing").forEach(function(w){w.classList.remove("playing");});\n';
            h += '  el.classList.add("playing");\n';
            h += '  if (currentAudio) { currentAudio.pause(); currentAudio = null; }\n';
            h += '  fetch(TTS_PROXY, {\n';
            h += '    method:"POST",\n';
            h += '    headers:{"Content-Type":"application/json"},\n';
            h += '    body:JSON.stringify({text:word})\n';
            h += '  }).then(function(r){if(!r.ok)throw new Error("TTS fail");return r.blob();})\n';
            h += '  .then(function(b){currentAudio=new Audio(URL.createObjectURL(b));currentAudio.onended=function(){el.classList.remove("playing");};currentAudio.play();})\n';
            h += '  .catch(function(e){\n';
            h += '    console.error("TTS error:",e);el.classList.remove("playing");\n';
            h += '    if(window.speechSynthesis){var u=new SpeechSynthesisUtterance(word);u.lang="ko-KR";u.rate=0.85;u.onend=function(){el.classList.remove("playing");};speechSynthesis.speak(u);}\n';
            h += '  });\n';
            h += '}\n';

            // Navigation
            h += 'function goTo(i) {\n';
            h += '  if (i<0||i>=totalSlides) return;\n';
            h += '  currentSlide = i;\n';
            h += '  var sl = document.querySelectorAll(".slide"), dt = document.querySelectorAll(".dot");\n';
            h += '  for (var j=0;j<sl.length;j++){sl[j].classList.toggle("active",j===i);if(dt[j])dt[j].classList.toggle("active",j===i);}\n';
            h += '  document.getElementById("ind").textContent = (i+1)+" / "+totalSlides;\n';
            h += '  document.getElementById("pb").disabled = i<=0;\n';
            h += '  document.getElementById("nb").disabled = i>=totalSlides-1;\n';
            h += '  if (activeTooltip) { activeTooltip.classList.remove("show"); activeTooltip = null; }\n';
            h += '}\n';
            h += 'function go(dir) { goTo(currentSlide+dir); }\n';

            // Keyboard navigation
            h += 'document.addEventListener("keydown",function(e){\n';
            h += '  if(e.key==="ArrowRight"){e.preventDefault();go(1);}\n';
            h += '  if(e.key==="ArrowLeft"){e.preventDefault();go(-1);}\n';
            h += '});\n';

            // Dismiss tooltip on tap outside (mobile)
            h += 'document.addEventListener("click",function(e){\n';
            h += '  if(!e.target.closest(".word") && activeTooltip){activeTooltip.classList.remove("show");activeTooltip=null;}\n';
            h += '});\n';

            // Resize handler
            h += 'window.addEventListener("resize", scaleSlide);\n';

            // Init
            h += 'renderSlides();\nscaleSlide();\ngoTo(0);\n';

            h += '<\/script>\n</body>\n</html>';

            // Download
            var blob = new Blob([h], { type: 'text/html;charset=utf-8' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'KoreanLearnin_Reading_Materials.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // ---- EXPANDED PREVIEW MODE ----
        var matExpCurrentSlide = 0;
        var matWordCache = {};
        var matCurrentAudio = null;

        function matExpandPreview() {
            if (matSlides.length === 0) return;
            matExpCurrentSlide = matCurrentSlide;
            document.getElementById('matExpandedOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
            matRenderExpandedSlide();
        }

        function matCloseExpanded() {
            document.getElementById('matExpandedOverlay').classList.remove('active');
            document.body.style.overflow = 'hidden';
            if (matCurrentAudio) { matCurrentAudio.pause(); matCurrentAudio = null; }
        }

        function matRenderExpandedSlide() {
            var wrap = document.getElementById('matExpandedSlideWrap');
            var s = matSlides[matExpCurrentSlide];
            var fs = parseInt(document.getElementById('matFontSize').value) || 30;

            // The slide is rendered at native 1920x1080, then scaled to fit viewport
            // Font size at 30px on preview (~760px wide) should be ~30 * (1920/760) â‰ˆ 76px on the 1920 canvas
            var previewWidth = document.querySelector('.mat-slideshow') ? document.querySelector('.mat-slideshow').offsetWidth : 760;
            var nativeFs = Math.round(fs * (1920 / previewWidth));

            // Calculate scale to fit viewport (leave room for nav + hint)
            var availW = window.innerWidth * 0.92;
            var availH = window.innerHeight - 120;
            var scaleW = availW / 1920;
            var scaleH = availH / 1080;
            var scale = Math.min(scaleW, scaleH);

            // Set wrapper size to the scaled dimensions so flexbox positions it correctly
            wrap.style.width = Math.round(1920 * scale) + 'px';
            wrap.style.height = Math.round(1080 * scale) + 'px';

            var html = '<div class="mat-expanded-slide-inner" style="transform: scale(' + scale + ');">';
            html += '<img class="mat-slide-bg" src="' + MAT_BG_URL + '" alt="">';
            html += '<div class="mat-expanded-content" style="font-size:' + nativeFs + 'px;">';
            for (var j = 0; j < s.sentences.length; j++) {
                html += '<div class="mat-expanded-sentence">';
                var words = s.sentences[j].split(/\s+/);
                for (var w = 0; w < words.length; w++) {
                    if (!words[w]) continue;
                    var wordId = 'matword_' + j + '_' + w;
                    html += '<span class="mat-word" id="' + wordId + '" data-word="' + escapeHtml(words[w]) + '" data-sentence="' + escapeHtml(s.sentences[j]) + '"';
                    html += ' onclick="event.stopPropagation(); matSpeakWord(this)"';
                    html += ' onmouseenter="matLoadTooltip(this)">';
                    html += escapeHtml(words[w]);
                    // Nested tooltip div - CSS handles show/hide
                    var cachedInfo = matWordCache[words[w]] || matWordCache[matStripPunc(words[w])];
                    if (cachedInfo) {
                        html += '<div class="mat-word-tip">' + matBuildTipHtml(words[w], cachedInfo) + '</div>';
                    } else {
                        html += '<div class="mat-word-tip"><div style="color:#00ffff;font-size:22px;font-weight:700;margin-bottom:4px;">' + escapeHtml(words[w]) + '</div><div class="tip-loading">â³ Loading...</div></div>';
                    }
                    html += '</span>';
                }
                html += '</div>';
            }
            html += '</div>';
            html += '<div class="mat-expanded-num">' + (matExpCurrentSlide + 1) + ' / ' + matSlides.length + '</div>';
            html += '</div>';
            wrap.innerHTML = html;

            document.getElementById('matExpIndicator').textContent = (matExpCurrentSlide + 1) + ' / ' + matSlides.length;
            document.getElementById('matExpPrevBtn').disabled = matExpCurrentSlide <= 0;
            document.getElementById('matExpNextBtn').disabled = matExpCurrentSlide >= matSlides.length - 1;

            // Detect edge words and shift tooltip alignment
            setTimeout(function() {
                var allWords = wrap.querySelectorAll('.mat-word');
                var contentEl = wrap.querySelector('.mat-expanded-content');
                if (!contentEl) return;
                var contentRect = contentEl.getBoundingClientRect();
                for (var i = 0; i < allWords.length; i++) {
                    var wordRect = allWords[i].getBoundingClientRect();
                    var wordCenter = wordRect.left + wordRect.width / 2;
                    allWords[i].classList.remove('mat-tip-left', 'mat-tip-right');
                    if (wordCenter - contentRect.left < 200) {
                        allWords[i].classList.add('mat-tip-left');
                    } else if (contentRect.right - wordCenter < 200) {
                        allWords[i].classList.add('mat-tip-right');
                    }
                }
            }, 50);
        }

        function matExpandedPrev() { if (matExpCurrentSlide > 0) { matExpCurrentSlide--; matRenderExpandedSlide(); } }
        function matExpandedNext() { if (matExpCurrentSlide < matSlides.length - 1) { matExpCurrentSlide++; matRenderExpandedSlide(); } }

        document.addEventListener('keydown', function(e) {
            var overlay = document.getElementById('matExpandedOverlay');
            if (!overlay || !overlay.classList.contains('active')) return;
            if (e.key === 'ArrowLeft') { e.preventDefault(); matExpandedPrev(); }
            if (e.key === 'ArrowRight') { e.preventDefault(); matExpandedNext(); }
            if (e.key === 'Escape') { e.preventDefault(); matCloseExpanded(); }
        });

        // ---- WORD TTS (ElevenLabs) ----
        function matSpeakWord(el) {
            var word = el.getAttribute('data-word');
            if (!word) return;
            document.querySelectorAll('.mat-word-playing').forEach(function(w) { w.classList.remove('mat-word-playing'); });
            el.classList.add('mat-word-playing');
            if (matCurrentAudio) { matCurrentAudio.pause(); matCurrentAudio = null; }

            fetch('https://tts-proxy-386010826708.us-central1.run.app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: word })
            }).then(function(resp) {
                if (!resp.ok) throw new Error('TTS failed');
                return resp.blob();
            }).then(function(blob) {
                matCurrentAudio = new Audio(URL.createObjectURL(blob));
                matCurrentAudio.onended = function() { el.classList.remove('mat-word-playing'); };
                matCurrentAudio.play();
            }).catch(function(err) {
                console.error('TTS error:', err);
                el.classList.remove('mat-word-playing');
                if (window.speechSynthesis) {
                    var utter = new SpeechSynthesisUtterance(word);
                    utter.lang = 'ko-KR';
                    utter.rate = 0.85;
                    utter.onend = function() { el.classList.remove('mat-word-playing'); };
                    speechSynthesis.speak(utter);
                }
            });
        }

        // ---- AI TOOLTIP (CSS hover, JS fetch) ----
        // Strip surrounding punctuation for cache lookup
        function matStripPunc(w) {
            return w.replace(/^["""''ã€Œã€ã€Žã€()\[\].,!?â€¦Â·~\-]+|["""''ã€Œã€ã€Žã€()\[\].,!?â€¦Â·~\-]+$/g, '');
        }

        function matLoadTooltip(el) {
            var word = el.getAttribute('data-word');
            var sentence = el.getAttribute('data-sentence');
            var tipEl = el.querySelector('.mat-word-tip');
            if (!tipEl) return;

            // Try exact match first, then stripped punctuation
            var stripped = matStripPunc(word);
            var cached = matWordCache[word] || matWordCache[stripped];
            if (cached) {
                if (!matWordCache[word]) matWordCache[word] = cached;
                matFillTip(tipEl, word, cached);
                return;
            }

            // Already fetching
            if (tipEl.dataset.fetching === 'true') return;
            tipEl.dataset.fetching = 'true';

            tipEl.innerHTML = '<div class="tip-label" style="color:#00ffff;font-size:22px;font-weight:700;margin-bottom:4px;">' + escapeHtml(word) + '</div><div class="tip-loading">â³ Loading translation...</div>';

            var prompt = 'You are a Korean language expert helping English-speaking learners. Analyze the Korean word "' + word + '" from the sentence "' + sentence + '". IMPORTANT: Always provide the actual English meaning/definition, NEVER just a romanization (e.g. ëˆ„ë‚˜ = "older sister (used by males)", NOT "Noona"). Break it into components (root + particles/grammar). If contracted, show derivation. Examples: "í”¼ìžë¥¼" = í”¼ìž (pizza, noun) + ë¥¼ (object particle). "ë¨¹ì—ˆì–´ìš”" = ë¨¹ë‹¤ (to eat, verb) + ì—ˆì–´ìš” (past tense polite). "ì œ" = contracted from ì € + ì˜ â†’ ì €ì˜ â†’ ì œ (my). "ê±”" = contracted from ê·¸ + ì•„ì´ â†’ ê·¸ì•„ì´ â†’ ê±” (that kid). Reply ONLY with JSON: {"english":"actual English meaning/definition","pos":"part of speech","particles":"attached particles/endings with function, or empty string","dictionary_form":"base form if different","conjugation":"conjugation pattern if verb/adjective, or empty string","contraction":"if contracted, show the derivation like ì € + ì˜ â†’ ì €ì˜ â†’ ì œ, otherwise empty string"}';

            fetch('https://generateflashcardai-386010826708.us-central1.run.app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: [{ role: 'user', content: prompt }], max_tokens: 300 })
            }).then(function(resp) { return resp.json(); })
            .then(function(data) {
                console.log('Tooltip AI raw response:', data);
                var resultText = '';
                if (typeof data === 'string') { resultText = data; }
                else if (data.text) { resultText = data.text; }
                else if (data.result) { resultText = data.result; }
                else if (data.response) { resultText = data.response; }
                else if (data.content) { resultText = typeof data.content === 'string' ? data.content : JSON.stringify(data.content); }
                else if (data.choices && data.choices[0]) { resultText = data.choices[0].message ? data.choices[0].message.content : (data.choices[0].text || ''); }
                else { resultText = JSON.stringify(data); }

                console.log('Tooltip resultText:', resultText);

                var info = { english: '', pos: '', particles: '', dictionary_form: '', conjugation: '', contraction: '' };
                // Try to find JSON object - use greedy match
                var jsonMatch = resultText.match(/\{[^{}]*"english"[^{}]*\}/);
                if (!jsonMatch) jsonMatch = resultText.match(/\{[\s\S]+\}/);
                console.log('Tooltip jsonMatch:', jsonMatch);

                if (jsonMatch) {
                    try {
                        var parsed = JSON.parse(jsonMatch[0]);
                        info.english = parsed.english || parsed.meaning || parsed.translation || '';
                        info.pos = parsed.pos || parsed.part_of_speech || '';
                        info.particles = parsed.particles || parsed.particle || parsed.grammar || '';
                        info.dictionary_form = parsed.dictionary_form || parsed.base_form || '';
                        info.conjugation = parsed.conjugation || parsed.conjugation_type || parsed.conjugation_pattern || '';
                        info.contraction = parsed.contraction || parsed.contracted_form || '';
                    } catch(e) {
                        console.error('Tooltip JSON parse error:', e, jsonMatch[0]);
                    }
                }

                if (!info.english) info.english = '(translation pending)';
                matWordCache[word] = info;
                matFillTip(tipEl, word, info);
            }).catch(function(err) {
                console.error('AI tooltip fetch error:', err);
                tipEl.innerHTML = '<div class="tip-label" style="color:#00ffff;font-size:16px;font-weight:700;margin-bottom:4px;">' + escapeHtml(word) + '</div><div class="tip-loading">âŒ Could not load translation</div>';
                tipEl.dataset.fetching = 'false';
            });
        }

        function matBuildTipHtml(word, info) {
            var html = '';
            html += '<div style="color:#00ffff;font-size:22px;font-weight:700;margin-bottom:8px;">' + escapeHtml(word) + '</div>';
            html += '<div style="color:#fff;font-size:18px;margin-bottom:8px;">ðŸŒ ' + escapeHtml(info.english || '') + '</div>';
            if (info.pos) html += '<div style="color:#ff00ff;font-size:15px;font-style:italic;margin-bottom:6px;">' + escapeHtml(info.pos) + '</div>';
            if (info.particles) html += '<div style="color:#39ff14;font-size:14px;line-height:1.5;">ðŸ”— ' + escapeHtml(info.particles) + '</div>';
            if (info.dictionary_form) html += '<div style="color:#aaa;font-size:14px;line-height:1.5;">ðŸ“– Dictionary: ' + escapeHtml(info.dictionary_form) + '</div>';
            if (info.conjugation) html += '<div style="color:#aaa;font-size:14px;line-height:1.5;">ðŸ”„ ' + escapeHtml(info.conjugation) + '</div>';
            if (info.contraction) html += '<div style="color:#ffd700;font-size:14px;line-height:1.5;">âœ‚ï¸ ' + escapeHtml(info.contraction) + '</div>';
            return html;
        }

        function matFillTip(tipEl, word, info) {
            var html = '';
            html += '<div class="tip-label" style="color:#00ffff;font-size:22px;font-weight:700;margin-bottom:8px;">' + escapeHtml(word) + '</div>';
            html += '<div class="tip-english" style="color:#fff;font-size:18px;margin-bottom:8px;">ðŸŒ ' + escapeHtml(info.english || '') + '</div>';
            if (info.pos) html += '<div class="tip-pos" style="color:#ff00ff;font-size:15px;font-style:italic;margin-bottom:6px;">' + escapeHtml(info.pos) + '</div>';
            if (info.particles) html += '<div class="tip-detail" style="color:#39ff14;font-size:14px;line-height:1.5;">ðŸ”— ' + escapeHtml(info.particles) + '</div>';
            if (info.dictionary_form) html += '<div class="tip-detail" style="color:#aaa;font-size:14px;line-height:1.5;">ðŸ“– Dictionary: ' + escapeHtml(info.dictionary_form) + '</div>';
            if (info.conjugation) html += '<div class="tip-detail" style="color:#aaa;font-size:14px;line-height:1.5;">ðŸ”„ ' + escapeHtml(info.conjugation) + '</div>';
            if (info.contraction) html += '<div class="tip-detail" style="color:#ffd700;font-size:14px;line-height:1.5;">âœ‚ï¸ ' + escapeHtml(info.contraction) + '</div>';
            tipEl.innerHTML = html;
        }

        // Show expand hint after generating slides
        var _origMatGenerate = matGenerateSlides;
        matGenerateSlides = function() {
            _origMatGenerate();
            var hint = document.getElementById('matExpandHint');
            if (hint && matSlides.length > 0) hint.style.display = 'block';
            // Prefetch all word analyses
            if (matSlides.length > 0) matPrefetchTooltips();
        };

        function matPrefetchTooltips() {
            // Collect all unique words and their sentence context
            var wordMap = {};
            for (var i = 0; i < matSlides.length; i++) {
                for (var j = 0; j < matSlides[i].sentences.length; j++) {
                    var sentence = matSlides[i].sentences[j];
                    var words = sentence.split(/\s+/);
                    for (var w = 0; w < words.length; w++) {
                        var word = words[w].trim();
                        if (word && !matWordCache[word] && !wordMap[word]) {
                            wordMap[word] = sentence;
                        }
                    }
                }
            }

            var wordList = Object.keys(wordMap);
            if (wordList.length === 0) return;

            // Show progress UI
            var statusEl = document.getElementById('matPrefetchStatus');
            var textEl = document.getElementById('matPrefetchText');
            var countEl = document.getElementById('matPrefetchCount');
            var barEl = document.getElementById('matPrefetchBar');
            if (statusEl) statusEl.style.display = 'block';

            var totalWords = wordList.length;
            var loadedWords = 0;
            var batchSize = 15;
            var totalBatches = Math.ceil(wordList.length / batchSize);
            var completedBatches = 0;

            function updateProgress(batchCount) {
                loadedWords += batchCount;
                completedBatches++;
                var pct = Math.round((loadedWords / totalWords) * 100);
                if (countEl) countEl.textContent = loadedWords + ' / ' + totalWords;
                if (barEl) barEl.style.width = pct + '%';
                if (textEl) textEl.textContent = 'Loading word data... ' + pct + '%';

                if (completedBatches >= totalBatches) {
                    // All done
                    if (textEl) textEl.textContent = 'âœ… All ' + totalWords + ' words loaded!';
                    if (barEl) barEl.style.width = '100%';
                    if (barEl) barEl.style.background = 'linear-gradient(90deg, #39ff14, #00ccff)';
                    var spinner = document.getElementById('matPrefetchSpinner');
                    if (spinner) spinner.style.display = 'none';
                    // Fade out after 3 seconds
                    setTimeout(function() {
                        if (statusEl) statusEl.style.transition = 'opacity 0.5s';
                        if (statusEl) statusEl.style.opacity = '0';
                        setTimeout(function() { if (statusEl) statusEl.style.display = 'none'; statusEl.style.opacity = '1'; }, 500);
                    }, 3000);
                }
            }

            if (countEl) countEl.textContent = '0 / ' + totalWords;

            // Split into batches of 15 words
            for (var b = 0; b < wordList.length; b += batchSize) {
                (function(batch) {
                    var examples = batch.map(function(w) { return '"' + w + '" (sentence: "' + wordMap[w] + '")'; }).join('\n');

                    var prompt = 'You are a Korean language expert. Analyze each Korean word below for English-speaking learners. IMPORTANT: Always provide the actual English meaning/definition, NEVER just a romanization. For example: ëˆ„ë‚˜ = "older sister (used by males)", NOT "Noona". ì—„ë§ˆ = "mom/mother", NOT "Eomma". Break words into components (root + particles/grammar). If contracted, show derivation. Examples: "í”¼ìžë¥¼" = í”¼ìž (pizza, noun) + ë¥¼ (object particle). "ë¨¹ì—ˆì–´ìš”" = ë¨¹ë‹¤ (to eat, verb) + ì—ˆì–´ìš” (past tense polite). "ì œ" = contracted from ì € + ì˜ â†’ ì €ì˜ â†’ ì œ (my).\n\nWords to analyze:\n' + examples + '\n\nReply ONLY with a JSON array where each element is: {"word":"the original word","english":"actual English meaning/definition","pos":"part of speech","particles":"attached particles/endings, or empty","dictionary_form":"base form if different, or empty","conjugation":"conjugation pattern if verb/adj, or empty","contraction":"derivation if contracted, or empty"}\nNo markdown, no backticks.';

                    fetch('https://generateflashcardai-386010826708.us-central1.run.app', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: [{ role: 'user', content: prompt }], max_tokens: 4000 })
                    }).then(function(resp) { return resp.json(); })
                    .then(function(data) {
                        var resultText = '';
                        if (typeof data === 'string') { resultText = data; }
                        else if (data.text) { resultText = data.text; }
                        else if (data.result) { resultText = data.result; }
                        else if (data.response) { resultText = data.response; }
                        else if (data.content) { resultText = typeof data.content === 'string' ? data.content : JSON.stringify(data.content); }
                        else if (data.choices && data.choices[0]) { resultText = data.choices[0].message ? data.choices[0].message.content : (data.choices[0].text || ''); }
                        else { resultText = JSON.stringify(data); }

                        console.log('Prefetch batch raw:', resultText.substring(0, 200));

                        var arrMatch = resultText.match(/\[[\s\S]*\]/);
                        var batchCached = 0;
                        if (arrMatch) {
                            try {
                                var arr = JSON.parse(arrMatch[0]);
                                for (var i = 0; i < arr.length; i++) {
                                    var item = arr[i];
                                    var w = item.word || '';
                                    if (w && !matWordCache[w]) {
                                        var info = {
                                            english: item.english || item.meaning || '',
                                            pos: item.pos || item.part_of_speech || '',
                                            particles: item.particles || item.particle || '',
                                            dictionary_form: item.dictionary_form || item.base_form || '',
                                            conjugation: item.conjugation || '',
                                            contraction: item.contraction || ''
                                        };
                                        matWordCache[w] = info;
                                        // Also store under stripped punctuation key
                                        var sw = matStripPunc(w);
                                        if (sw && sw !== w && !matWordCache[sw]) matWordCache[sw] = info;
                                        batchCached++;
                                    }
                                }
                                console.log('Prefetch cached ' + arr.length + ' words');
                            } catch(e) { console.error('Prefetch parse error:', e); }
                        }
                        updateProgress(batchCached || batch.length);
                    }).catch(function(err) {
                        console.error('Prefetch error:', err);
                        updateProgress(batch.length);
                    });
                })(wordList.slice(b, b + batchSize));
            }
        }
        // ==================== END MATERIALS CREATOR ====================

        // ==================== PERMUTATION GAME ====================
        function openPermutationGame() {
            // Create fullscreen overlay for the game
            const overlay = document.createElement('div');
            overlay.id = 'permutationGameOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: #1a1a2e;
                z-index: 10000;
                overflow: auto;
            `;
            
            // Create close button - small X button
            const closeBtn = document.createElement('button');
            closeBtn.id = 'permutationCloseBtn';
            closeBtn.innerHTML = 'âœ•';
            closeBtn.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 10001;
                background: rgba(255,68,68,0.9);
                color: white;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            closeBtn.onmouseover = function() { this.style.background = '#ff4444'; this.style.transform = 'scale(1.1)'; };
            closeBtn.onmouseout = function() { this.style.background = 'rgba(255,68,68,0.9)'; this.style.transform = 'scale(1)'; };
            closeBtn.onclick = closePermutationGame;
            
            // Create iframe for the game
            const iframe = document.createElement('iframe');
            iframe.id = 'permutationGameFrame';
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
            `;
            
            // Game HTML content
            iframe.srcdoc = getPermutationGameHTML();
            
            overlay.appendChild(closeBtn);
            overlay.appendChild(iframe);
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
        }
        
        function closePermutationGame() {
            const overlay = document.getElementById('permutationGameOverlay');
            if (overlay) overlay.remove();
            document.body.style.overflow = '';
        }
        
        function getPermutationGameHTML() {
            return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŒŸ Yodafy Game v2</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Noto Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a2a 100%);
      min-height: 100vh; 
      color: #e2e8f0; 
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { text-align: center; font-size: 2rem; margin-bottom: 10px; background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { text-align: center; color: #888; margin-bottom: 25px; font-size: 13px; }
    
    /* Panel */
    .panel { background: rgba(0,0,0,0.6); border: 2px solid #00ffff; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
    .panel h2 { color: #00ffff; font-size: 18px; margin-bottom: 15px; }
    
    /* Level Selector */
    .level-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .level-btn { padding: 15px 10px; border: 2px solid rgba(0,255,255,0.3); border-radius: 10px; background: rgba(0,0,0,0.5); color: #e2e8f0; cursor: pointer; transition: all 0.3s; text-align: center; }
    .level-btn:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
    .level-btn.active { border-color: #00ffff; background: linear-gradient(135deg, rgba(0,255,255,0.2), rgba(255,0,255,0.2)); box-shadow: 0 0 20px rgba(0,255,255,0.3); }
    .level-btn .num { font-size: 22px; font-weight: bold; display: block; color: #00ffff; }
    .level-btn .desc { font-size: 10px; color: #888; }
    
    /* Form */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
    input, textarea, select { width: 100%; padding: 12px; border: 2px solid rgba(0,255,255,0.3); border-radius: 8px; background: rgba(0,0,0,0.5); color: #fff; font-size: 14px; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #00ffff; }
    
    /* Buttons */
    .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #00ffff, #ff00ff); color: #000; }
    .btn-success { background: linear-gradient(135deg, #39ff14, #00cc00); color: #000; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); }
    .btn-danger { background: #ff4444; color: #fff; }
    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-sm { padding: 8px 15px; font-size: 12px; }
    .button-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    
    /* Level Description */
    .level-desc-box { background: rgba(255,0,255,0.1); border-left: 3px solid #ff00ff; padding: 12px 15px; margin-bottom: 20px; font-size: 13px; }
    
    /* Answer List */
    .answer-list { max-height: 250px; overflow-y: auto; margin: 15px 0; }
    .answer-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(0,0,0,0.4); border-radius: 8px; margin-bottom: 8px; }
    .answer-item .text { flex: 1; font-size: 14px; }
    .answer-item .remove { background: #ff4444; border: none; color: #fff; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 14px; }
    
    /* Config Row */
    .config-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; margin: 15px 0; }
    .config-item { display: flex; align-items: center; gap: 8px; }
    .config-item label { font-size: 13px; color: #888; }
    .config-item input, .config-item select { width: auto; padding: 8px 12px; }
    
    /* Progress */
    .progress-section { text-align: center; padding: 20px; display: none; }
    .progress-bar { background: rgba(0,0,0,0.5); border-radius: 10px; height: 20px; overflow: hidden; margin: 15px 0; }
    .progress-fill { background: linear-gradient(135deg, #00ffff, #ff00ff); height: 100%; transition: width 0.3s; width: 0%; }
    
    /* Results Preview */
    .results-section { display: none; }
    .result-card { background: rgba(0,0,0,0.4); border: 1px solid rgba(0,255,255,0.2); border-radius: 10px; padding: 15px; margin-bottom: 12px; }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .result-num { background: #ff00ff; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .result-question { font-size: 18px; color: #fff; margin-bottom: 5px; }
    .result-english { font-size: 13px; color: #888; margin-bottom: 10px; }
    .result-answers { display: flex; flex-wrap: wrap; gap: 8px; }
    .answer-pill { padding: 6px 12px; border-radius: 15px; font-size: 12px; }
    .answer-pill.green { background: rgba(57,255,20,0.2); color: #39ff14; border: 1px solid rgba(57,255,20,0.4); }
    .answer-pill.blue { background: rgba(0,170,255,0.2); color: #00aaff; border: 1px solid rgba(0,170,255,0.4); }
    .answer-pill.yellow { background: rgba(255,200,0,0.2); color: #ffcc00; border: 1px solid rgba(255,200,0,0.4); }
    .answer-pill.red { background: rgba(255,100,100,0.2); color: #ff6666; border: 1px solid rgba(255,100,100,0.4); }
    
    /* 3D Flashcard - Landscape optimized, centered */
    .flashcard-game { display: none; padding: 20px; padding-top: 50px; min-height: 100vh; flex-direction: column; align-items: center; justify-content: flex-start; width: 100%; }
    .flashcard-container { perspective: 1000px; max-width: 95vw; width: 1100px; position: relative; z-index: 1; }
    .flashcard-3d { position: relative; width: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
    .flashcard-3d.flipped { transform: rotateY(180deg); }
    .flashcard-front, .flashcard-back { width: 100%; min-height: 450px; backface-visibility: hidden; border-radius: 15px; padding: 25px; display: flex; flex-direction: column; }
    .flashcard-front { position: absolute; top: 0; left: 0; background: linear-gradient(135deg, rgba(20,0,40,0.95), rgba(40,0,60,0.95)); border: 3px solid #ff00ff; justify-content: center; align-items: center; cursor: pointer; height: 100%; }
    .flashcard-back { position: relative; background: linear-gradient(135deg, rgba(0,30,20,0.95), rgba(0,40,30,0.95)); border: 3px solid #39ff14; transform: rotateY(180deg); backface-visibility: hidden; }
    
    .flashcard-question { font-size: 26px; color: #ff00ff; text-align: center; margin-bottom: 20px; }
    .english-blur { background: rgba(255,255,255,0.1); padding: 15px 20px; border-radius: 10px; text-align: center; cursor: pointer; }
    .english-blur .blur { filter: blur(8px); color: #fff; font-size: 16px; transition: filter 0.3s; }
    .english-blur.revealed .blur { filter: none; }
    .english-blur .hint { font-size: 11px; color: #666; margin-top: 5px; }
    .english-blur.revealed .hint { display: none; }
    
    /* Audio Button */
    .audio-btn { background: linear-gradient(135deg, #00ffff, #00aaff); border: none; color: #000; padding: 15px 30px; border-radius: 30px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 20px; transition: all 0.3s; }
    .audio-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,255,0.5); }
    .audio-btn:disabled { opacity: 0.5; cursor: wait; }
    .audio-btn.playing { animation: pulse-audio 1s infinite; }
    @keyframes pulse-audio { 0%, 100% { box-shadow: 0 0 10px rgba(0,255,255,0.5); } 50% { box-shadow: 0 0 25px rgba(0,255,255,0.8); } }
    
    /* Question Blur (Korean) */
    .question-blur { background: rgba(255,0,255,0.1); padding: 20px 30px; border-radius: 15px; cursor: pointer; text-align: center; margin-bottom: 15px; transition: all 0.3s; }
    .question-blur:hover { background: rgba(255,0,255,0.2); }
    .question-blur .blur-content { font-size: 26px; color: #ff00ff; filter: blur(10px); transition: filter 0.3s; user-select: none; }
    .question-blur.revealed .blur-content { filter: none; user-select: auto; }
    .question-blur .reveal-hint { font-size: 12px; color: #888; margin-top: 8px; }
    .question-blur.revealed .reveal-hint { display: none; }
    
    /* English Blur - updated */
    .english-blur { background: rgba(0,255,255,0.1); padding: 15px 25px; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s; }
    .english-blur:hover { background: rgba(0,255,255,0.15); }
    .english-blur .blur-content { font-size: 16px; color: #00ffff; filter: blur(8px); transition: filter 0.3s; user-select: none; }
    .english-blur.revealed .blur-content { filter: none; user-select: auto; }
    .english-blur .keywords { font-size: 13px; color: #ffcc00; margin-top: 8px; display: none; }
    .english-blur.revealed .keywords { display: block; }
    .english-blur .reveal-hint { font-size: 11px; color: #666; margin-top: 5px; }
    .english-blur.revealed .reveal-hint { display: none; }
    
    /* Back Answer - Progressive reveal (English first, then Korean) */
    .back-answer { padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid; cursor: pointer; transition: all 0.3s; }
    .back-answer.green { background: rgba(57,255,20,0.1); border-color: #39ff14; }
    .back-answer.blue { background: rgba(0,170,255,0.1); border-color: #00aaff; }
    .back-answer.yellow { background: rgba(255,200,0,0.1); border-color: #ffcc00; }
    .back-answer.red { background: rgba(255,100,100,0.1); border-color: #ff6666; }
    
    .back-answer .answer-english { font-size: 14px; color: #fff; margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px; }
    .back-answer .answer-korean { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
    .back-answer.green .answer-korean { color: #39ff14; }
    .back-answer.blue .answer-korean { color: #00aaff; }
    .back-answer.yellow .answer-korean { color: #ffcc00; }
    .back-answer.red .answer-korean { color: #ff6666; }
    .back-answer .label { font-size: 10px; color: #666; margin-top: 3px; }
    
    /* Connected horizontal answer rows */
    .answers-table { width: 100%; }
    .answer-row { display: flex; gap: 20px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); align-items: stretch; }
    .answer-row:last-child { border-bottom: none; }
    .answer-cell { flex: 1; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
    .answer-cell.beginner { background: rgba(136,255,136,0.1); border-left: 4px solid #88ff88; }
    .answer-cell.advanced { background: rgba(255,170,0,0.1); border-left: 4px solid #ffaa00; }
    .answer-cell .cell-label { font-size: 10px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
    .answer-cell .answer-english { font-size: 13px; color: #fff; margin-bottom: 8px; padding: 6px 10px; background: rgba(0,0,0,0.3); border-radius: 5px; }
    .answer-cell .answer-korean { font-size: 15px; font-weight: 600; }
    .answer-cell.beginner .answer-korean { color: #88ff88; }
    .answer-cell.advanced .answer-korean { color: #ffaa00; }
    .answer-cell .color-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
    .color-indicator.green { background: #39ff14; }
    .color-indicator.blue { background: #00aaff; }
    .color-indicator.yellow { background: #ffcc00; }
    .color-indicator.red { background: #ff6666; }
    
    /* Header row */
    .answers-header { display: flex; gap: 20px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.2); }
    .header-cell { flex: 1; text-align: center; font-weight: 600; font-size: 14px; }
    .header-cell.beginner { color: #88ff88; }
    .header-cell.advanced { color: #ffaa00; }
    .beginner-column .back-answer { font-size: 14px; }
    .beginner-column .answer-korean { font-size: 15px; }
    .beginner-column .answer-english { font-size: 12px; }
    
    /* Back prompt reminder */
    .back-prompt-reminder { background: rgba(255,0,255,0.15); border: 1px solid rgba(255,0,255,0.4); border-radius: 10px; padding: 12px 15px; margin-bottom: 10px; text-align: center; }
    .prompt-type-badge { display: inline-block; background: linear-gradient(135deg, #ff00ff, #cc00cc); color: #fff; padding: 3px 12px; border-radius: 15px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
    .prompt-type-badge.question { background: linear-gradient(135deg, #ff00ff, #cc00cc); }
    .prompt-type-badge.situational { background: linear-gradient(135deg, #00aaff, #0066cc); }
    .prompt-type-badge.statement { background: linear-gradient(135deg, #ffaa00, #cc8800); }
    .back-prompt-reminder .prompt-text { font-size: 18px; color: #ff00ff; font-weight: 600; margin-bottom: 5px; }
    .back-prompt-reminder .prompt-english { font-size: 13px; color: #aaa; }
    
    /* Hidden text state */
    .back-answer .hidden-text, .answer-cell .hidden-text { filter: blur(8px); user-select: none; }
    .back-answer .answer-english.hidden-text, .answer-cell .answer-english.hidden-text { background: rgba(255,255,255,0.1); }
    .back-answer .reveal-hint { font-size: 11px; color: #888; margin-top: 5px; display: block; }
    .back-answer .answer-english:not(.hidden-text) .reveal-hint { color: #00ffff; }
    
    /* Clickable Korean words */
    .korean-word { display: inline-block; padding: 2px 6px; margin: 2px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
    .korean-word.hidden-word { background: rgba(255,255,255,0.2); color: #888; border: 1px dashed #666; }
    .korean-word.hidden-word:hover { background: rgba(255,255,255,0.3); border-color: #00ffff; }
    .korean-word:not(.hidden-word) { background: rgba(0,255,255,0.1); }
    
    .back-title { color: #39ff14; font-size: 14px; text-align: center; margin-bottom: 15px; }
    
    /* Carousel Nav */
    .carousel-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 20px; position: relative; z-index: 10; }
    .carousel-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(0,255,255,0.2); border: 2px solid #00ffff; color: #00ffff; font-size: 20px; cursor: pointer; }
    .carousel-btn:hover { background: rgba(0,255,255,0.4); }
    .carousel-counter { font-size: 18px; font-weight: bold; }
    .flip-btn { display: block; margin: 15px auto 0; background: linear-gradient(135deg, #ff00ff, #cc00cc); border: none; color: #fff; padding: 12px 30px; border-radius: 25px; font-size: 14px; cursor: pointer; position: relative; z-index: 10; }
    
    /* ì¤€ë¹„ (Preparation) Sheet - Paper Layout */
    .junbi-screen { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7); 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1000; 
      overflow-y: auto; 
      padding: 20px;
      box-sizing: border-box;
    }
    .junbi-sheet { background: #fff; color: #000; border-radius: 8px; padding: 40px; max-width: 800px; margin: 0 auto; box-shadow: 0 5px 30px rgba(0,0,0,0.5); }
    .junbi-sheet-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 25px; }
    .junbi-sheet-header h3 { font-size: 24px; color: #000; margin: 0; }
    .junbi-sheet-header p { font-size: 17px; color: #666; margin-top: 5px; }
    .junbi-table { width: 100%; border-collapse: collapse; }
    .junbi-table th { background: #f0f0f0; padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600; border: 1px solid #ccc; }
    .junbi-table td { padding: 12px 15px; border: 1px solid #ccc; vertical-align: top; }
    .junbi-table tr:nth-child(even) { background: #fafafa; }
    .junbi-table .num { width: 40px; text-align: center; font-weight: bold; color: #666; }
    .junbi-table .korean-col { font-size: 16px; color: #000; }
    .junbi-table .korean-col .spoiler-block { background: #333; }
    .junbi-table .korean-col .spoiler-block .word-hover { color: transparent !important; }
    .junbi-table .korean-col .spoiler-block.revealed { background: transparent !important; }
    .junbi-table .korean-col .spoiler-block.revealed .word-hover { color: inherit !important; }
    .junbi-table .english-col { font-size: 14px; color: #555; }
    .junbi-table .color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
    .junbi-table .color-dot.green { background: #22c55e; }
    .junbi-table .color-dot.blue { background: #3b82f6; }
    .junbi-table .color-dot.yellow { background: #eab308; }
    .junbi-table .color-dot.red { background: #ef4444; }
    /* Covered text - click to reveal */
    .covered-text { background: #333; color: #333; padding: 2px 5px; border-radius: 3px; cursor: pointer; user-select: none; }
    .covered-text:hover { background: #555; }
    .covered-text .color-dot { opacity: 0; }
    /* Spoiler block - Reddit-style click to reveal */
    .spoiler-block { 
      background: #333; 
      padding: 4px 8px; 
      border-radius: 4px; 
      cursor: pointer; 
      user-select: none; 
      display: inline-block;
      min-width: 100px;
      transition: background 0.3s ease;
    }
    .spoiler-block .word-hover { color: transparent !important; transition: color 0.3s ease; }
    .spoiler-block .color-dot { opacity: 0; transition: opacity 0.3s ease; }
    .spoiler-block.revealed { 
      background: transparent !important; 
      cursor: default;
    }
    .spoiler-block.revealed .word-hover { color: inherit !important; }
    .spoiler-block.revealed .color-dot { opacity: 1; }
    /* Blank word for fill-in mode */
    .blank-word { background: #e0e0e0; color: #1e40af; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-weight: 600; border: 1px dashed #999; }
    .blank-word:hover { background: #c0c0c0; }
    /* Question/Situation row */
    .junbi-situation-row { background: #e8f4fc !important; }
    .junbi-situation-row td { font-weight: 600; color: #1e40af; border-bottom: 2px solid #3b82f6; }
    
    /* Difficult card marker */
    .result-card.difficult { border-color: #ff4444 !important; background: rgba(255,68,68,0.1) !important; }
    .result-card.difficult::before { content: 'âš ï¸ Difficult'; position: absolute; top: -10px; right: 10px; background: #ff4444; color: #fff; padding: 2px 8px; border-radius: 3px; font-size: 10px; }
    .result-card { position: relative; }
    
    /* Word tooltip */
    .word-hover { position: relative; cursor: help; border-bottom: 1px dotted #999; display: inline-block; }
    .word-hover:hover { background: #fff3cd; }
    .word-hover.word-no-def { border-bottom-style: dashed; border-color: #ccc; }
    .word-hover.word-no-def:hover { background: #f0f0f0; }
    .word-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1a1a2e; color: #fff; padding: 12px 15px; border-radius: 8px; font-size: 12px; white-space: nowrap; z-index: 100; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.3); border: 1px solid #00ffff; min-width: 200px; max-width: 300px; white-space: normal; }
    .word-hover:hover .word-tooltip { display: block; }
    .word-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 8px solid transparent; border-top-color: #1a1a2e; }
    .word-tooltip .wt-word { font-size: 16px; font-weight: bold; color: #00ffff; margin-bottom: 5px; }
    
    /* Spoiler overrides - MUST come after word-tooltip rules */
    .spoiler-block .word-hover { pointer-events: none !important; border-bottom: none !important; cursor: default !important; }
    .spoiler-block .word-hover:hover { background: transparent !important; }
    .spoiler-block .word-tooltip { display: none !important; }
    .spoiler-block.revealed .word-hover { pointer-events: auto !important; border-bottom: 1px dotted #999 !important; cursor: help !important; }
    .spoiler-block.revealed .word-hover:hover { background: #fff3cd !important; }
    .spoiler-block.revealed .word-hover:hover .word-tooltip { display: block !important; }
    .word-tooltip .wt-pos { font-size: 10px; color: #ff00ff; text-transform: uppercase; margin-bottom: 8px; }
    .word-tooltip .wt-def { color: #fff; margin-bottom: 8px; }
    .word-tooltip .wt-grammar { font-size: 11px; color: #39ff14; background: rgba(57,255,20,0.1); padding: 6px 8px; border-radius: 4px; margin-bottom: 8px; font-family: monospace; }
    .word-tooltip .wt-example { font-size: 11px; color: #888; font-style: italic; border-top: 1px solid #333; padding-top: 8px; margin-top: 8px; }
    .word-tooltip .wt-example-ko { color: #00ffff; }
    
    /* Print styles */
    @media print {
      body { background: #fff !important; }
      .junbi-screen .button-row, .junbi-screen > p { display: none !important; }
      .junbi-sheet { box-shadow: none; padding: 20px; }
      .word-tooltip { display: none !important; }
      .covered-text { background: #fff; color: #000; }
    }
    
    /* Floating Cover Button */
    .floating-cover-btn { position: fixed; bottom: 30px; right: 30px; z-index: 150; }
    .cover-toggle-btn { background: linear-gradient(135deg, #ff00ff, #cc00cc); border: none; color: #fff; padding: 15px 25px; border-radius: 30px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 5px 20px rgba(255,0,255,0.4); transition: all 0.3s; }
    .cover-toggle-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(255,0,255,0.6); }
    .cover-toggle-btn.covered { background: linear-gradient(135deg, #39ff14, #00cc00); box-shadow: 0 5px 20px rgba(57,255,20,0.4); }
    .cover-toggle-btn.covered:hover { box-shadow: 0 8px 30px rgba(57,255,20,0.6); }
    @media print { .floating-cover-btn { display: none !important; } }
    
    /* Minimal Spacebar Timer */
    .spacebar-timer { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 2px solid #00ffff; border-radius: 25px; padding: 8px 25px; z-index: 100; display: none; }
    .spacebar-timer .timer-display { font-size: 24px; font-weight: bold; text-align: center; background: linear-gradient(135deg, #00ffff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .spacebar-timer.warning { border-color: #ffaa00; }
    .spacebar-timer.danger { border-color: #ff4444; animation: pulse-danger 0.5s infinite; }
    @keyframes pulse-danger { 0%, 100% { box-shadow: 0 0 10px rgba(255,68,68,0.5); } 50% { box-shadow: 0 0 20px rgba(255,68,68,0.8); } }
    
    /* Fixed Close Button - Top Right */
    .fixed-close-btn { position: fixed; top: 15px; right: 15px; z-index: 200; background: rgba(255,68,68,0.9); border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; display: none; transition: all 0.2s; }
    .fixed-close-btn:hover { background: #ff4444; transform: scale(1.1); }
    .junbi-open .fixed-close-btn, .junbi-open .floating-cover-btn { display: none !important; }
    
    /* Reveal All Korean Button */
    .reveal-all-btn { background: linear-gradient(135deg, #39ff14, #00cc00); border: none; color: #000; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .reveal-all-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(57,255,20,0.5); }
    
    /* Edit Modal */
    .edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
    .edit-content { background: #1a1a2e; border: 2px solid #00ffff; border-radius: 15px; padding: 25px; max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto; }
    .edit-content h3 { color: #00ffff; margin-bottom: 20px; }
    .edit-answer { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .edit-answer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .edit-all-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(0,255,255,0.1), rgba(255,0,255,0.1)); border-radius: 10px; }
    .color-picker { display: flex; gap: 8px; }
    .color-opt { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .color-opt.selected { border-color: #fff; }
    .color-opt.green { background: rgba(57,255,20,0.3); }
    .color-opt.blue { background: rgba(0,170,255,0.3); }
    .color-opt.yellow { background: rgba(255,200,0,0.3); }
    .color-opt.red { background: rgba(255,100,100,0.3); }
    
    /* Import Modal */
    .import-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
    .import-content { background: linear-gradient(135deg, #1a1a2e 0%, #2d1f3d 100%); border: 2px solid #667eea; border-radius: 20px; padding: 30px; max-width: 550px; width: 100%; max-height: 85vh; overflow-y: auto; }
    .import-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .import-header h3 { color: #667eea; font-size: 20px; margin: 0; }
    .import-header .close-btn { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
    .import-header .close-btn:hover { color: #fff; }
    .import-user-info { background: rgba(102,126,234,0.2); padding: 12px 15px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .import-user-info .user-avatar { width: 35px; height: 35px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .date-range-section { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-top: 15px; }
    .date-range-section h4 { color: #00ffff; margin-bottom: 10px; font-size: 14px; }
    .date-range-section input[type="date"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff; margin-top: 5px; }
    .activity-card { background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 10px; padding: 15px; margin-bottom: 10px; }
    .activity-card .date { color: #667eea; font-size: 12px; margin-bottom: 5px; }
    .activity-card .preview { color: #888; font-size: 13px; line-height: 1.5; }
    .activity-card .sentence-count { color: #39ff14; font-size: 11px; margin-top: 8px; }
    .btn-success { background: linear-gradient(135deg, #48bb78, #38a169) !important; }
    
    /* Load Games Modal */
    .load-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
    .load-content { background: linear-gradient(135deg, #1a1a2e 0%, #1f2d3d 100%); border: 2px solid #00ffff; border-radius: 20px; padding: 30px; max-width: 900px; width: 100%; max-height: 85vh; overflow-y: auto; }
    .load-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .load-header h3 { color: #00ffff; font-size: 22px; margin: 0; }
    .load-header .close-btn { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
    .load-header .close-btn:hover { color: #fff; }
    .load-controls { display: flex; gap: 15px; margin-bottom: 20px; }
    .load-controls input { flex: 1; padding: 12px 15px; border-radius: 10px; border: 1px solid #444; background: #0d1117; color: #fff; font-size: 14px; }
    .load-controls input:focus { outline: none; border-color: #00ffff; }
    .load-controls select { padding: 12px 15px; border-radius: 10px; border: 1px solid #444; background: #0d1117; color: #fff; font-size: 14px; cursor: pointer; }
    .load-status { text-align: center; color: #888; padding: 20px; }
    .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
    .game-card { background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 12px; padding: 18px; transition: all 0.2s; }
    .game-card:hover { border-color: #00ffff; transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,255,255,0.15); }
    .game-card-title { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .game-card-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .game-card-tag { font-size: 11px; padding: 4px 10px; border-radius: 20px; background: rgba(255,255,255,0.1); color: #aaa; }
    .game-card-tag.level { background: rgba(255,0,255,0.2); color: #ff88ff; }
    .game-card-tag.cards { background: rgba(57,255,20,0.2); color: #88ff88; }
    .game-card-tag.date { background: rgba(0,170,255,0.2); color: #88ccff; }
    .game-card-actions { display: flex; gap: 10px; margin-top: 12px; }
    .game-card-actions button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .game-card-actions .load-btn { background: linear-gradient(135deg, #00ffff, #00aaff); color: #000; }
    .game-card-actions .load-btn:hover { transform: scale(1.02); box-shadow: 0 3px 15px rgba(0,255,255,0.3); }
    .game-card-actions .delete-btn { background: rgba(255,68,68,0.2); color: #ff6666; border: 1px solid rgba(255,68,68,0.3); }
    .game-card-actions .delete-btn:hover { background: rgba(255,68,68,0.4); }
    .no-games-msg { text-align: center; color: #666; padding: 40px; font-size: 16px; }
    

    /* Discord Integration Styles */
    .discord-config-panel {
      background: rgba(88, 101, 242, 0.2);
      border: 2px solid #5865F2;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      transition: opacity 0.4s ease, max-height 0.4s ease;
      opacity: 1;
    }
    .discord-config-panel.hiding {
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      padding: 0 15px;
      margin-bottom: 0;
      border-width: 0;
    }
    .discord-config-panel.hidden {
      display: none;
    }
    .discord-reopen-btn {
      background: rgba(88, 101, 242, 0.3);
      border: 2px solid #5865F2;
      border-radius: 8px;
      padding: 8px 16px;
      color: #5865F2;
      cursor: pointer;
      font-family: 'Press Start 2P', monospace;
      font-size: 11px;
      margin-bottom: 15px;
      transition: opacity 0.4s ease, background 0.2s ease;
      opacity: 1;
    }
    .discord-reopen-btn:hover {
      background: rgba(88, 101, 242, 0.5);
    }
    .discord-reopen-btn.hidden {
      display: none;
    }
    .discord-config-panel h3 {
      color: #5865F2;
      font-size: 14px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .discord-config-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    .discord-config-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .discord-config-item label {
      font-size: 11px;
      color: #888;
    }
    .discord-config-item input {
      padding: 8px 12px;
      font-size: 13px;
    }
    .discord-webhook-input {
      width: 350px;
    }
    .round-start-input {
      width: 200px;
    }
    .check-answer-btn {
      background: linear-gradient(135deg, #5865F2, #7289DA);
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .check-answer-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(88, 101, 242, 0.5);
    }
    .check-answer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .check-answer-btn.checking {
      background: #FFA500;
    }
    .check-answer-btn.success {
      background: #39ff14;
      color: #000;
    }
    .check-answer-btn.error {
      background: #ff4444;
    }
    .answer-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      justify-content: flex-end;
      align-items: center;
    }
    .points-badge {
      background: #39ff14;
      color: #000;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: bold;
    }

    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 25px; border-radius: 8px; display: none; z-index: 300; }
    
    /* Loading spinner */
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŒŸ Yodafy Game v2</h1>
    
    <!-- Setup Panel -->
    <div class="panel" id="setupPanel">
      <h2>ðŸŽ® Setup Your Game</h2>
      
      <div class="level-selector">
        <button class="level-btn active" onclick="selectLevel(1)" data-level="1">
          <span class="num">1</span>
          <span class="desc">Word Order</span>
        </button>
        <button class="level-btn" onclick="selectLevel(2)" data-level="2">
          <span class="num">2</span>
          <span class="desc">Word Swap</span>
        </button>
        <button class="level-btn" onclick="selectLevel(3)" data-level="3">
          <span class="num">3</span>
          <span class="desc">Endings</span>
        </button>
        <button class="level-btn" onclick="selectLevel(4)" data-level="4">
          <span class="num">4</span>
          <span class="desc">Roleplay Q&A</span>
        </button>
      </div>
      
      <div class="level-desc-box" id="levelDesc">
        <strong>Level 1:</strong> AI generates grammatically correct word order variations.
      </div>
      
      <!-- Level 1-3 Input -->
      <div id="input123">
        <div class="form-group">
          <label>Korean Sentences (paste multiple lines or type one per line)</label>
          <textarea id="sentenceKorean" placeholder="Paste sentences here - each line becomes a separate entry

Example:
ì €ëŠ” í•™êµì— ê°€ìš”.
ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ì•„ìš”.
ì¹œêµ¬ëž‘ ë°¥ ë¨¹ì—ˆì–´ìš”." rows="5" style="resize: vertical;"></textarea>
          <p style="color: #666; font-size: 11px; margin-top: 8px;">ðŸ’¡ Lines are automatically parsed</p>
        </div>
        <div class="answer-list" id="sentenceList"></div>
        <p style="color: #666; font-size: 12px;">Sentences: <span id="sentenceCount">0</span></p>
      </div>
      
      <!-- Level 4 Input -->
      <div id="input4" style="display: none;">
        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label>Korean Answer Sentences (paste multiple lines or type one per line)</label>
            <button class="btn btn-sm" onclick="openImportModal()" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 8px 15px; font-size: 12px;">
              ðŸ“¥ Import from Daily Activities
            </button>
          </div>
          <textarea id="answerKorean" placeholder="Paste sentences here - each line becomes a separate entry

Example:
ì¹´íŽ˜ì— ì™”ì–´ìš”.
ë©”ë‰´ ì¢€ ë³¼ê²Œìš”.
ì•„ë©”ë¦¬ì¹´ë…¸ í•˜ë‚˜ ì£¼ì„¸ìš”." rows="5" style="resize: vertical;"></textarea>
          <p style="color: #666; font-size: 11px; margin-top: 8px;">ðŸ’¡ Lines are automatically parsed. Remove the * or bullet points if any.</p>
        </div>
        <div class="answer-list" id="answerList"></div>
        <p style="color: #666; font-size: 12px;">Sentences: <span id="answerCount">0</span> <span style="color: #ce93d8; margin-left: 10px;">ðŸ“¹ Click video icon to attach Loom link to each sentence</span></p>
        
        <div class="config-row">
          <div class="config-item">
            <label>Prompts:</label>
            <input type="number" id="questionCount" value="5" min="1" max="20" style="width: 60px;">
          </div>
          <div class="config-item">
            <label>Answers per prompt:</label>
            <select id="answersPerQ">
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div class="config-item">
            <label>Mode:</label>
            <select id="answerMode">
              <option value="flexible" selected>Flexible (2-3 if needed)</option>
              <option value="strict">Strict (exactly N answers)</option>
            </select>
          </div>
        </div>
        
        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
          <label style="display: block; margin-bottom: 10px; color: #00ffff; font-size: 13px;">Prompt Type Mix (must total 100%)</label>
          <div class="config-row" style="margin: 0;">
            <div class="config-item">
              <label>Questions:</label>
              <input type="number" id="pctQuestions" value="40" min="0" max="100" style="width: 55px;">
              <span style="color: #888;">%</span>
            </div>
            <div class="config-item">
              <label>Situational:</label>
              <input type="number" id="pctSituational" value="30" min="0" max="100" style="width: 55px;">
              <span style="color: #888;">%</span>
            </div>
            <div class="config-item">
              <label>Statements:</label>
              <input type="number" id="pctStatements" value="30" min="0" max="100" style="width: 55px;">
              <span style="color: #888;">%</span>
            </div>
          </div>
          <p style="font-size: 11px; color: #666; margin-top: 8px;">
            Questions: "ì•¼, ë­ ë¨¹ì—ˆì–´?" â€¢ Situational: "Your friend asks what you ate" â€¢ Statements: "Tell your friend what you ate"
          </p>
        </div>
        
        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
          <label style="display: block; margin-bottom: 10px; color: #ff00ff; font-size: 13px;">Difficulty Tier Mix (must total 100%)</label>
          <div class="config-row" style="margin: 0;">
            <div class="config-item">
              <label>Tier 1 (Simple):</label>
              <input type="number" id="pctTier1" value="60" min="0" max="100" style="width: 55px;">
              <span style="color: #888;">%</span>
            </div>
            <div class="config-item">
              <label>Tier 2 (Complex):</label>
              <input type="number" id="pctTier2" value="40" min="0" max="100" style="width: 55px;">
              <span style="color: #888;">%</span>
            </div>
          </div>
          <p style="font-size: 11px; color: #666; margin-top: 8px;">
            Tier 1: "ë­ ë¨¹ì—ˆì–´?" (single clause) â€¢ Tier 2: "ì–´ì œ ì¹œêµ¬ ë§Œë‚¬ì„ ë•Œ ë­ ë¨¹ì—ˆì–´?" (multiple clauses, complex grammar)
          </p>
        </div>
        
        <!-- Question Variety Options -->
        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
          <label style="display: block; margin-bottom: 10px; color: #ffcc00; font-size: 13px;">ðŸŽ­ Question Variety (for more diverse prompts)</label>
          <div class="config-row" style="margin: 0;">
            <div class="config-item">
              <label>Speech Level:</label>
              <select id="speechLevel" style="width: 120px;">
                <option value="mixed" selected>Mixed</option>
                <option value="formal">Formal (ì¡´ëŒ“ë§)</option>
                <option value="casual">Casual (ë°˜ë§)</option>
              </select>
            </div>
            <div class="config-item">
              <label>Speakers:</label>
              <select id="speakerTypes" style="width: 140px;">
                <option value="mixed" selected>Mixed</option>
                <option value="friends">Friends only</option>
                <option value="formal">Formal (teacher, boss)</option>
                <option value="strangers">Strangers</option>
                <option value="family">Family</option>
              </select>
            </div>
            <div class="config-item">
              <label>Settings:</label>
              <select id="settingTypes" style="width: 140px;">
                <option value="mixed" selected>Mixed</option>
                <option value="cafe">Cafe/Restaurant</option>
                <option value="school">School</option>
                <option value="work">Work/Office</option>
                <option value="home">Home</option>
                <option value="street">Street/Public</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Game Options -->
        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
          <label style="display: block; margin-bottom: 10px; color: #00ffff; font-size: 13px;">âš™ï¸ Game Options</label>
          <div class="config-row" style="margin: 0;">
            <div class="config-item">
              <label>Timer per card:</label>
              <select id="timerPerCard">
                <option value="0">No timer</option>
                <option value="30">30 seconds</option>
                <option value="60" selected>1 minute</option>
                <option value="90">1.5 minutes</option>
                <option value="120">2 minutes</option>
              </select>
            </div>
            <div class="config-item">
              <label>
                <input type="checkbox" id="shuffleCards" checked> Shuffle cards
              </label>
            </div>
            <div class="config-item">
              <label>
                <input type="checkbox" id="trackDifficulty"> Track difficult cards
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <div class="button-row">
        <button class="btn btn-primary" id="generateBtn" onclick="generate()">âœ¨ Generate with AI</button>
        <button class="btn btn-secondary" onclick="clearAll()">ðŸ—‘ï¸ Clear</button>
        <button class="btn btn-secondary" onclick="loadSavedGame()">ðŸ“‚ Load Saved</button>
      </div>
      
      <div class="progress-section" id="progressSection">
        <p id="progressText">Generating...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
    </div>
    
    <!-- Results Preview -->
    <div class="panel results-section" id="resultsSection">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <h2>ðŸ“‹ Generated Cards</h2>
        <div class="button-row" style="margin: 0;">
          <button class="btn btn-sm btn-warning" onclick="editAllCards()">âœï¸ Edit All</button>
          <button class="btn btn-sm btn-success" onclick="saveGame()">ðŸ’¾ Save</button>
          <button class="btn btn-sm btn-primary" onclick="startJunbi()">ðŸ“– ì¤€ë¹„ (Prep)</button>
          <button class="btn btn-sm btn-secondary" onclick="regenerate()">ðŸ”„ Regenerate All</button>
        </div>
      </div>
      <p style="color: #888; font-size: 12px; margin-bottom: 15px;">ðŸ’¡ Tip: Click âœï¸ on any card to edit the question/situation, or use "Edit All" to review all cards before starting the game.</p>
      <div id="resultsContainer"></div>
    </div>
    
    <!-- ì¤€ë¹„ (Preparation) Sheet -->
    <div class="junbi-screen" id="junbiScreen" style="display: none;">
      <button onclick="exitJunbi()" style="position: fixed; top: 20px; right: 20px; background: #ff4444; border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 1001; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">âœ•</button>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2>ðŸ“– ì¤€ë¹„ (Preparation Sheet)</h2>
        <div class="button-row" style="margin: 0;">
          <select id="junbiSortMode" onchange="renderJunbi()" style="padding: 8px; border-radius: 5px; background: #333; color: #fff; border: 1px solid #00ffff;">
            <option value="default">Default Order</option>
            <option value="tier">Sort by Tier</option>
            <option value="shuffle">Shuffle</option>
          </select>
          <button class="btn btn-sm btn-secondary" onclick="window.print()">ðŸ–¨ï¸ Print</button>
          <button class="btn btn-sm btn-success" onclick="exportPDF()">ðŸ“„ Export PDF</button>
          <button class="btn btn-sm btn-primary" onclick="startGameFromJunbi()">ðŸŽ® Start Game</button>
          <button class="btn btn-sm btn-secondary" onclick="exitJunbi()">â† Back</button>
        </div>
      </div>
      <p style="color: #888; font-size: 13px; margin-bottom: 20px;">Click each Korean sentence to reveal. Then hover over words for definitions.</p>
      <div id="junbiContainer"></div>
    </div>
    
    <!-- Floating Cover Button for ì¤€ë¹„ -->
    <div class="floating-cover-btn" id="floatingCoverBtn" style="display: none;">
      <button class="cover-toggle-btn" id="coverBtn" onclick="toggleCover()">ðŸ™ˆ Cover Korean</button>
    </div>
    
    <!-- Flashcard Game -->
    <div class="flashcard-game" id="flashcardGame">

      <!-- Discord Integration Panel removed - using message ID tracking instead -->
      
      <button onclick="exitGame()" style="position: fixed; top: 20px; right: 20px; background: #ff4444; border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 500; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">âœ•</button>
      <div class="flashcard-container">
        <div class="flashcard-3d" id="flashcard">
          <div class="flashcard-front" onclick="flipCard()">
            <!-- Audio Button -->
            <button class="audio-btn" id="audioBtn" onclick="event.stopPropagation(); playQuestionAudio()">
              ðŸ”Š Play Audio
            </button>
            
            <!-- Korean Question - Hidden initially -->
            <div class="question-blur" id="fcQuestionBlur" onclick="event.stopPropagation(); revealKorean()">
              <div class="blur-content" id="fcQuestion">ì§ˆë¬¸</div>
              <div class="reveal-hint">ðŸ‘† Click to reveal Korean</div>
            </div>
            
            <!-- English Translation - Hidden initially -->
            <div class="english-blur" id="fcEnglishBlur" onclick="event.stopPropagation(); revealEnglish()">
              <div class="blur-content" id="fcEnglish">English here</div>
              <div class="keywords" id="fcKeywords"></div>
              <div class="reveal-hint">ðŸ‘† Click to reveal English</div>
            </div>
          </div>
          <div class="flashcard-back" onclick="revealAllKorean(event)">
            <!-- Prompt reminder at top -->
            <div class="back-prompt-reminder" id="backPromptReminder">
              <div class="prompt-type-badge" id="backPromptType">QUESTION</div>
              <div class="prompt-text" id="backPromptText">ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
              <div class="prompt-english" id="backPromptEnglish">English translation here</div>
            </div>
            
            <!-- Control buttons row -->
            <div style="display: flex; justify-content: center; gap: 10px; margin: 10px 0;">
              <button class="audio-btn" id="audioBtnBack" onclick="event.stopPropagation(); playQuestionAudio()" style="margin: 0; padding: 10px 20px; font-size: 14px;">
                ðŸ”Š Audio
              </button>
              <button class="reveal-all-btn" onclick="event.stopPropagation(); revealAllKoreanBtn()">
                ðŸ‘ï¸ Show All Korean
              </button>
              <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editCard()" style="padding: 10px 20px; font-size: 14px;">âœï¸ Edit Card</button>
            </div>
            
            <div class="answers-header">
              <div class="header-cell beginner">ðŸŒ± Beginner (1-2 clauses)</div>
              <div class="header-cell advanced">ðŸŒŸ Advanced Beginner</div>
            </div>
            <div class="answers-table" id="fcAnswersTable"></div>
          </div>
        </div>
        <button class="flip-btn" onclick="flipCard()">ðŸ”„ Flip Card</button>
      </div>
      
      <div class="carousel-nav">
        <button class="carousel-btn" onclick="prevCard()">â—€</button>
        <span class="carousel-counter"><span id="currentCard">1</span> / <span id="totalCards">1</span></span>>
        <button class="carousel-btn" onclick="nextCard()">â–¶</button>
      </div>
      
      <div style="text-align: center; margin-top: 25px;">
        <button id="leaderboardBtn" onclick="endRoundAndPostLeaderboard()" style="background: linear-gradient(135deg, #FFD700, #FFA500); border: 2px solid #FFD700; color: #000; padding: 14px 30px; border-radius: 25px; font-size: 13px; font-weight: bold; cursor: pointer; font-family: 'Press Start 2P', monospace; transition: all 0.2s; box-shadow: 0 0 20px rgba(255,215,0,0.3);">ðŸ† End Round & Post Leaderboard</button>
      </div>
    </div>
  </div>
  
  <!-- Spacebar Timer -->
  <div class="spacebar-timer" id="spacebarTimer">
    <div class="timer-display" id="timerDisplay">0:40</div>
  </div>
  
  <!-- Edit Modal -->
  <div class="edit-modal" id="editModal">
    <div class="edit-content">
      <h3>âœï¸ Edit Flashcard</h3>
      
      <!-- Level 4 Type/Tier Section (hidden for Level 1-3) -->
      <div id="editTypeSection" style="display: none; margin-bottom: 15px; padding: 10px; background: rgba(255,0,255,0.1); border-radius: 8px;">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label>Type</label>
            <select id="editType" onchange="updateEditPromptVisibility()">
              <option value="question">â“ Question</option>
              <option value="situational">ðŸ“ Situational</option>
              <option value="statement">ðŸ’¬ Statement</option>
            </select>
          </div>
          <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label>Tier</label>
            <select id="editTier">
              <option value="1">T1 - Simple</option>
              <option value="2">T2 - Complex</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Prompt field for Situational/Statement types -->
      <div id="editPromptSection" class="form-group" style="display: none;">
        <label>Prompt (English scenario/instruction)</label>
        <textarea id="editPrompt" rows="2" placeholder="Describe the situation or instruction..."></textarea>
      </div>
      
      <div class="form-group">
        <label id="editQuestionLabel">Question/Prompt (Korean)</label>
        <input type="text" id="editQuestion" placeholder="Korean question or prompt">
      </div>
      <div class="form-group">
        <label>English Translation</label>
        <input type="text" id="editQuestionEng" placeholder="English translation">
      </div>
      <div id="editAnswersContainer"></div>
      <button class="btn btn-sm btn-success" onclick="addEditAnswer()" style="margin: 10px 0;">âž• Add Answer</button>
      <div class="button-row">
        <button class="btn btn-secondary" onclick="closeEdit()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEdit()">ðŸ’¾ Save</button>
      </div>
    </div>
  </div>
  
  <!-- Edit All Cards Modal -->
  <div class="edit-modal" id="editAllModal" style="display: none;">
    <div class="edit-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #00ffff;">
        <h3 style="margin: 0;">âœï¸ Edit All Cards</h3>
        <button class="btn btn-sm btn-danger" onclick="closeEditAll()" style="padding: 5px 10px;">âœ•</button>
      </div>
      <div id="editAllContent">
        <!-- Content rendered dynamically -->
      </div>
      <div class="button-row" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
        <button class="btn btn-secondary" onclick="closeEditAll()">Cancel</button>
        <button class="btn btn-success" onclick="saveAndCloseEditAll()">ðŸ’¾ Save All & Close</button>
      </div>
    </div>
  </div>
  
  <!-- Import from Daily Activities Modal -->
  <div class="import-modal" id="importModal">
    <div class="import-content">
      <div class="import-header">
        <h3>ðŸ“¥ Import from Daily Activities</h3>
        <button class="close-btn" onclick="closeImportModal()">âœ•</button>
      </div>
      
      <!-- Activities Section (no login needed - uses parent auth) -->
      <div id="importActivitiesSection">
        <div class="import-user-info" id="importUserInfo">
          <div class="user-avatar">ðŸ‘¤</div>
          <div>
            <div style="font-weight: 600; color: #fff;">Admin Account</div>
            <div style="font-size: 11px; color: #888;">Using scheduler authentication</div>
          </div>
        </div>
        
        <div class="date-range-section">
          <h4>ðŸ“… Select Date Range</h4>
          <div style="display: flex; gap: 15px; margin-top: 10px;">
            <div style="flex: 1;">
              <label>From:</label>
              <input type="date" id="importDateFrom">
            </div>
            <div style="flex: 1;">
              <label>To:</label>
              <input type="date" id="importDateTo">
            </div>
          </div>
          <div style="margin-top: 10px;">
            <button class="btn btn-sm btn-secondary" onclick="setDateRange('week')">Last Week</button>
            <button class="btn btn-sm btn-secondary" onclick="setDateRange('2weeks')">Last 2 Weeks</button>
            <button class="btn btn-sm btn-secondary" onclick="setDateRange('month')">Last Month</button>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="fetchDailyActivities()" style="width: 100%; margin-top: 15px;">ðŸ” Find Activities</button>
        
        <div id="activitiesPreview" style="margin-top: 20px;"></div>
        
        <div id="importActions" style="display: none; margin-top: 20px;">
          <p style="color: #39ff14; margin-bottom: 10px;" id="sentenceCount"></p>
          <button class="btn btn-success" onclick="importSelectedSentences()" style="width: 100%;">âœ… Import All Sentences</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Load Saved Games Modal -->
  <div class="load-modal" id="loadModal">
    <div class="load-content">
      <div class="load-header">
        <h3>ðŸ“‚ Load Saved Game</h3>
        <button class="close-btn" onclick="closeLoadModal()">âœ•</button>
      </div>
      
      <div class="load-controls">
        <input type="text" id="gameSearchInput" placeholder="ðŸ” Search games..." oninput="filterGames()">
        <select id="gameSortSelect" onchange="sortGames()">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="name-az">Name A-Z</option>
          <option value="name-za">Name Z-A</option>
        </select>
      </div>
      
      <div class="load-status" id="loadStatus">Loading games...</div>
      
      <div class="games-grid" id="gamesGrid"></div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    // ==================== FIREBASE SETUP (Use Parent's Authenticated DB) ====================
    let fbDb;
    let importedActivities = [];
    
    // Get parent's authenticated Firestore instance
    function initParentFirebase() {
      try {
        if (window.parent && window.parent.schedulerDb) {
          fbDb = window.parent.schedulerDb;
          console.log('Using parent authenticated Firestore');
          return true;
        } else {
          console.log('Parent schedulerDb not found');
        }
      } catch(e) {
        console.error('Error accessing parent Firebase:', e);
      }
      return false;
    }
    
    // Initialize on load
    initParentFirebase();

    // ==================== DISCORD INTEGRATION ====================
    var discordConfig = {
      webhookUrl: '', // kept for compatibility but no longer used
      roundStartTime: null
    };

    // Load saved config on init
    function loadDiscordConfig() {
      try {
        var saved = localStorage.getItem('yodafyDiscordConfig');
        if (saved) {
          discordConfig = JSON.parse(saved);
          var webhookEl = document.getElementById('discordWebhookUrl');
          var timeEl = document.getElementById('roundStartTime');
          if (webhookEl) webhookEl.value = discordConfig.webhookUrl || '';
          if (timeEl && discordConfig.roundStartTime) {
            timeEl.value = discordConfig.roundStartTime;
          }
        }
      } catch (e) {
        console.error('Error loading Discord config:', e);
      }
    }

    // Save config to localStorage
    function saveDiscordConfig() {
      var webhookEl = document.getElementById('discordWebhookUrl');
      var timeEl = document.getElementById('roundStartTime');
      if (webhookEl) discordConfig.webhookUrl = webhookEl.value;
      if (timeEl) discordConfig.roundStartTime = timeEl.value;
      localStorage.setItem('yodafyDiscordConfig', JSON.stringify(discordConfig));
      showToast('âœ… Discord config saved');
    }

    // Set round start time to now
    // Fetch Transcripts is now handled automatically by the Check button

    function setRoundStartNow() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');
      var day = String(now.getDate()).padStart(2, '0');
      var hours = String(now.getHours()).padStart(2, '0');
      var minutes = String(now.getMinutes()).padStart(2, '0');
      var formatted = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
      
      var timeEl = document.getElementById('roundStartTime');
      if (timeEl) {
        timeEl.value = formatted;
        saveDiscordConfig();
        showToast('â±ï¸ Round started at ' + now.toLocaleTimeString());
      }
    }

    // Toggle Discord panel visibility with fade
    function toggleDiscordPanel() {
      var panel = document.getElementById('discordConfigPanel');
      var reopenBtn = document.getElementById('discordReopenBtn');
      if (!panel) return;

      if (panel.classList.contains('hidden') || panel.classList.contains('hiding')) {
        // Show panel with fade in
        panel.classList.remove('hidden');
        panel.classList.remove('hiding');
        reopenBtn.classList.add('hidden');
        // Force reflow then fade in
        panel.offsetHeight;
        panel.style.opacity = '0';
        panel.style.maxHeight = '0';
        panel.style.overflow = 'hidden';
        panel.style.padding = '0 15px';
        panel.style.marginBottom = '0';
        panel.style.borderWidth = '0';
        setTimeout(function() {
          panel.style.opacity = '1';
          panel.style.maxHeight = '500px';
          panel.style.padding = '15px';
          panel.style.marginBottom = '20px';
          panel.style.borderWidth = '2px';
          setTimeout(function() {
            panel.style.overflow = '';
            panel.style.maxHeight = '';
          }, 400);
        }, 10);
      } else {
        // Hide panel with fade out
        panel.style.opacity = '0';
        panel.style.maxHeight = '0';
        panel.style.overflow = 'hidden';
        panel.style.padding = '0 15px';
        panel.style.marginBottom = '0';
        panel.style.borderWidth = '0';
        setTimeout(function() {
          panel.classList.add('hidden');
          reopenBtn.classList.remove('hidden');
        }, 400);
      }
    }

    // Check answer â€” calls Scenario 1 (fetch transcripts) then Scenario 2 (grade students)
    function checkAnswerViaWebhook(koreanSentence, answerIndex, btnElement, englishTranslation) {
      var SCENARIO_1_URL = 'https://hook.us1.make.com/fpoxgq3wd40hbpg2mi3yzv17dyqz9n1r';
      var SCENARIO_2_URL = 'https://hook.us1.make.com/gmht3b3d2e7hvdrx6wk12z6qkkmr2g8i';
      
      // Disable button and show checking state
      btnElement.disabled = true;
      btnElement.classList.add('checking');
      btnElement.innerHTML = 'â³ Fetching transcripts...';
      
      // Step 1: Call Scenario 1 to fetch and transcribe Discord messages
      fetch(SCENARIO_1_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'fetch_transcripts',
          timestamp: new Date().toISOString()
        })
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Fetch transcripts failed (' + response.status + ')');
        }
        return response.text().catch(function() { return ''; });
      })
      .then(function() {
        // Wait for Scenario 1 to finish processing on Make.com before calling Scenario 2
        btnElement.innerHTML = 'â³ Processing transcripts...';
        return new Promise(function(resolve) { setTimeout(resolve, 5000); });
      })
      .then(function() {
        // Step 2: Call Scenario 2 to grade students
        btnElement.innerHTML = 'â³ Grading students...';
        
        var payload = {
          action: 'check_answer',
          korean_sentence: koreanSentence,
          english_translation: englishTranslation || '',
          card_index: currentCardIndex,
          answer_index: answerIndex,
          points: 10,
          timestamp: new Date().toISOString()
        };
        
        console.log('Sending to grading webhook:', payload);
        
        return fetch(SCENARIO_2_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      })
      .then(function(response) {
        if (response.ok) {
          return response.json().catch(function() { return {}; });
        } else {
          throw new Error('Grading failed (' + response.status + ')');
        }
      })
      .then(function(result) {
        btnElement.classList.remove('checking');
        btnElement.classList.add('success');
        var matchCount = result.matched_count || result.matchedCount || 0;
        btnElement.innerHTML = 'âœ… ' + matchCount + ' matched';
        showToast('âœ… Checked! ' + matchCount + ' students matched');
        
        setTimeout(function() {
          btnElement.classList.remove('success');
          btnElement.disabled = false;
          btnElement.innerHTML = 'âœ… Check';
        }, 5000);
      })
      .catch(function(error) {
        console.error('Webhook error:', error);
        btnElement.classList.remove('checking');
        btnElement.classList.add('error');
        btnElement.innerHTML = 'âŒ Error';
        showToast('âŒ Error: ' + error.message);
        
        setTimeout(function() {
          btnElement.classList.remove('error');
          btnElement.disabled = false;
          btnElement.innerHTML = 'âœ… Check';
        }, 3000);
      });
    }

    // Check ADVANCED BEGINNER answer â€” calls Advanced Scenario 1 (fetch transcripts) then Advanced Scenario 2 (grade students)
    function checkAdvancedAnswerViaWebhook(koreanSentence, answerIndex, btnElement, englishTranslation) {
      var ADV_SCENARIO_1_URL = 'https://hook.us1.make.com/bl754ty4uj0lbmbp9m2j6gou69k3fnj1';
      var ADV_SCENARIO_2_URL = 'https://hook.us1.make.com/hk4mpu7pogu54jhk7kxeuf4nbd6esxm6';
      
      // Disable button and show checking state
      btnElement.disabled = true;
      btnElement.classList.add('checking');
      btnElement.innerHTML = 'â³ Fetching transcripts...';
      
      // Step 1: Call Advanced Scenario 1 to fetch and transcribe Discord messages
      fetch(ADV_SCENARIO_1_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'fetch_transcripts',
          timestamp: new Date().toISOString()
        })
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Fetch transcripts failed (' + response.status + ')');
        }
        return response.text().catch(function() { return ''; });
      })
      .then(function() {
        // Wait for Advanced Scenario 1 to finish processing on Make.com before calling Scenario 2
        btnElement.innerHTML = 'â³ Processing transcripts...';
        return new Promise(function(resolve) { setTimeout(resolve, 5000); });
      })
      .then(function() {
        // Step 2: Call Advanced Scenario 2 to grade students
        btnElement.innerHTML = 'â³ Grading students...';
        
        var payload = {
          action: 'check_answer',
          korean_sentence: koreanSentence,
          english_translation: englishTranslation || '',
          card_index: currentCardIndex,
          answer_index: answerIndex,
          points: 10,
          timestamp: new Date().toISOString()
        };
        
        console.log('Sending to advanced grading webhook:', payload);
        
        return fetch(ADV_SCENARIO_2_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      })
      .then(function(response) {
        if (response.ok) {
          return response.json().catch(function() { return {}; });
        } else {
          throw new Error('Grading failed (' + response.status + ')');
        }
      })
      .then(function(result) {
        btnElement.classList.remove('checking');
        btnElement.classList.add('success');
        var matchCount = result.matched_count || result.matchedCount || 0;
        btnElement.innerHTML = 'âœ… ' + matchCount + ' matched';
        showToast('âœ… Checked! ' + matchCount + ' advanced students matched');
        
        setTimeout(function() {
          btnElement.classList.remove('success');
          btnElement.disabled = false;
          btnElement.innerHTML = 'âœ… Check';
        }, 5000);
      })
      .catch(function(error) {
        console.error('Advanced webhook error:', error);
        btnElement.classList.remove('checking');
        btnElement.classList.add('error');
        btnElement.innerHTML = 'âŒ Error';
        showToast('âŒ Error: ' + error.message);
        
        setTimeout(function() {
          btnElement.classList.remove('error');
          btnElement.disabled = false;
          btnElement.innerHTML = 'âœ… Check';
        }, 3000);
      });
    }

    // End Round & Post Leaderboard â€” calls BOTH beginner and advanced Scenario 3
    function endRoundAndPostLeaderboard() {
      var SCENARIO_3_URL = 'https://hook.us1.make.com/723z943wbt83mpwy3r821g0x7atp858v';
      var ADV_SCENARIO_3_URL = 'https://hook.us1.make.com/nak1ovnmi1s7pogrw84hgqtw96gi31h9';
      var btn = document.getElementById('leaderboardBtn');
      
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.innerHTML = 'â³ Posting leaderboards...';
      
      // Call both leaderboard webhooks in parallel
      Promise.all([
        fetch(SCENARIO_3_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'post_leaderboard',
            timestamp: new Date().toISOString()
          })
        }),
        fetch(ADV_SCENARIO_3_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'post_leaderboard',
            timestamp: new Date().toISOString()
          })
        })
      ])
      .then(function(responses) {
        var allOk = responses.every(function(r) { return r.ok; });
        if (!allOk) {
          throw new Error('One or more leaderboard posts failed');
        }
        btn.innerHTML = 'âœ… Leaderboards Posted!';
        btn.style.background = 'linear-gradient(135deg, #39ff14, #00cc00)';
        btn.style.borderColor = '#39ff14';
        showToast('ðŸ† Both leaderboards posted to Discord!');
        
        setTimeout(function() {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.innerHTML = 'ðŸ† End Round & Post Leaderboard';
          btn.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
          btn.style.borderColor = '#FFD700';
        }, 5000);
      })
      .catch(function(error) {
        console.error('Leaderboard webhook error:', error);
        btn.innerHTML = 'âŒ Error posting';
        btn.style.background = '#ff4444';
        btn.style.borderColor = '#ff4444';
        showToast('âŒ Error: ' + error.message);
        
        setTimeout(function() {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.innerHTML = 'ðŸ† End Round & Post Leaderboard';
          btn.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
          btn.style.borderColor = '#FFD700';
        }, 3000);
      });
    }
    // ==================== END DISCORD INTEGRATION ====================


    // ==================== IMPORT MODAL FUNCTIONS ====================
    function openImportModal() {
      // Re-check parent Firebase in case it wasn't ready
      if (!fbDb) initParentFirebase();
      
      if (!fbDb) {
        showToast('âš ï¸ Firebase not connected. Please refresh the page.');
        return;
      }
      
      document.getElementById('importModal').style.display = 'flex';
      // Reset state
      document.getElementById('activitiesPreview').innerHTML = '';
      document.getElementById('importActions').style.display = 'none';
      importedActivities = [];
      
      // Set default date range
      setDateRange('week');
    }
    
    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
    }
    
    function setDateRange(range) {
      const today = new Date();
      const toDate = new Date(today);
      let fromDate = new Date(today);
      
      if (range === 'week') {
        fromDate.setDate(today.getDate() - 7);
      } else if (range === '2weeks') {
        fromDate.setDate(today.getDate() - 14);
      } else if (range === 'month') {
        fromDate.setMonth(today.getMonth() - 1);
      }
      
      document.getElementById('importDateFrom').value = fromDate.toISOString().split('T')[0];
      document.getElementById('importDateTo').value = toDate.toISOString().split('T')[0];
    }
    
    async function fetchDailyActivities() {
      const fromDateStr = document.getElementById('importDateFrom').value;
      const toDateStr = document.getElementById('importDateTo').value;
      
      if (!fromDateStr || !toDateStr) {
        showToast('âš ï¸ Please select date range');
        return;
      }
      
      const fromDate = new Date(fromDateStr);
      const toDate = new Date(toDateStr);
      toDate.setHours(23, 59, 59); // Include entire end day
      
      const previewEl = document.getElementById('activitiesPreview');
      previewEl.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading" style="width: 30px; height: 30px; border: 3px solid #667eea; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="color: #888; margin-top: 10px;">Loading activities...</p></div>';
      
      try {
        // Simple query without composite index requirement (filter client-side)
        const snapshot = await fbDb.collection('dailyActivities')
          .orderBy('createdAt', 'desc')
          .get();
        
        importedActivities = [];
        let totalSentences = 0;
        
        snapshot.forEach(doc => {
          const data = doc.data();
          
          // Filter by type client-side
          if (data.type !== 'pronunciation') return;
          
          const createdAt = data.createdAt?.toDate() || new Date();
          
          // Filter by date range
          if (createdAt >= fromDate && createdAt <= toDate) {
            // Parse sentences from script
            const sentences = parseScriptToSentences(data.script || '');
            totalSentences += sentences.length;
            
            importedActivities.push({
              id: doc.id,
              date: createdAt,
              script: data.script,
              sentences: sentences,
              formality: data.formality || 'haeyo'
            });
          }
        });
        
        if (importedActivities.length === 0) {
          previewEl.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No activities found in this date range.</p>';
          document.getElementById('importActions').style.display = 'none';
          return;
        }
        
        // Render preview
        let html = '';
        importedActivities.forEach((activity, idx) => {
          const dateStr = activity.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          const preview = activity.sentences.slice(0, 3).join(' / ') + (activity.sentences.length > 3 ? '...' : '');
          
          html += \`
            <div class="activity-card">
              <div class="date">ðŸ“… \${dateStr}</div>
              <div class="preview">\${escapeHtml(preview)}</div>
              <div class="sentence-count">ðŸ“ \${activity.sentences.length} sentences</div>
            </div>
          \`;
        });
        
        previewEl.innerHTML = html;
        
        // Show import button
        document.getElementById('sentenceCount').textContent = \`Found \${importedActivities.length} activities with \${totalSentences} total sentences\`;
        document.getElementById('importActions').style.display = 'block';
        
      } catch (error) {
        console.error('Fetch error:', error);
        previewEl.innerHTML = \`<p style="color: #ff6666; text-align: center; padding: 20px;">Error: \${error.message}</p>\`;
      }
    }
    
    function parseScriptToSentences(script) {
      if (!script) return [];
      
      const sentences = [];
      const lines = script.split('\\n');
      
      lines.forEach(line => {
        // Remove A: or B: prefix
        let cleaned = line.replace(/^[AB]:\\s*/i, '').trim();
        
        // Skip empty lines
        if (cleaned.length > 0) {
          sentences.push(cleaned);
        }
      });
      
      return sentences;
    }
    
    function importSelectedSentences() {
      if (importedActivities.length === 0) {
        showToast('âš ï¸ No activities to import');
        return;
      }
      
      // Collect all sentences
      const allSentences = [];
      importedActivities.forEach(activity => {
        activity.sentences.forEach(sentence => {
          if (!allSentences.includes(sentence)) {
            allSentences.push(sentence);
          }
        });
      });
      
      // Add to textarea
      const textarea = document.getElementById('answerKorean');
      const existingText = textarea.value.trim();
      
      if (existingText) {
        textarea.value = existingText + '\\n' + allSentences.join('\\n');
      } else {
        textarea.value = allSentences.join('\\n');
      }
      
      // Trigger parsing
      parseAnswersFromTextarea();
      
      // Close modal
      closeImportModal();
      showToast(\`âœ… Imported \${allSentences.length} sentences!\`);
    }
    // ==================== END FIREBASE/IMPORT ====================
    
    // API URLs
    const AI_URL = 'https://generateflashcardai-386010826708.us-central1.run.app';
    const TTS_PROXY_URL = 'https://tts-proxy-386010826708.us-central1.run.app';
    
    // State
    let currentLevel = 1;
    let sentences = [];
    let answers = [];
    let gameData = [];
    let currentCardIndex = 0;
    let timerInterval = null;
    let timerSeconds = 40;
    let timerRunning = false;
    let currentAudio = null;
    
    const levelDescs = {
      1: '<strong>Level 1:</strong> AI generates grammatically correct word order variations.',
      2: '<strong>Level 2:</strong> Same grammar, different words (swap nouns/verbs).',
      3: '<strong>Level 3:</strong> Same sentence, different ending grammar points.',
      4: '<strong>Level 4 - Roleplay:</strong> AI creates conversational questions for your answers. Just enter Korean - AI translates!'
    };
    
    // Level selection
    function selectLevel(level) {
      currentLevel = level;
      document.querySelectorAll('.level-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.level) === level);
      });
      document.getElementById('levelDesc').innerHTML = levelDescs[level];
      
      // Show/hide inputs
      document.getElementById('input123').style.display = level === 4 ? 'none' : 'block';
      document.getElementById('input4').style.display = level === 4 ? 'block' : 'none';
      
      // Hide results when switching
      document.getElementById('resultsSection').style.display = 'none';
    }
    
    // Auto-parse textarea content into sentences (Level 1-3)
    function parseSentencesFromTextarea() {
      const rawText = document.getElementById('sentenceKorean').value;
      
      if (!rawText.trim()) {
        sentences = [];
        renderSentences();
        return;
      }
      
      // Split by newlines and clean up each line
      const lines = rawText
        .split(/\\r?\\n|\\r/)
        .map(line => {
          // Remove bullet points, asterisks, numbers, dashes at start
          return line
            .replace(/^[\\s]*[\\*\\-\\â€¢\\â—¦\\â–ª\\â–¸\\â–º\\â†’\\Â·\\â—\\â—‹\\â˜†\\â˜…\\âœ“\\âœ”\\âœ—\\âœ˜\\>\\Â»\\]\\)\\}]+[\\s]*/g, '')
            .replace(/^[\\s]*\\d+[\\.\\)\\]:][\\s]*/g, '')
            .trim();
        })
        .filter(line => line.length > 0);
      
      // Update sentences array (avoid duplicates)
      sentences = [];
      const seen = new Set();
      lines.forEach(korean => {
        if (!seen.has(korean)) {
          seen.add(korean);
          sentences.push({ korean });
        }
      });
      
      renderSentences();
    }
    
    // Legacy function
    function addSentence() {
      parseSentencesFromTextarea();
    }
    
    function renderSentences() {
      const container = document.getElementById('sentenceList');
      container.innerHTML = sentences.map((s, i) => 
        '<div class="answer-item">' +
          '<span class="text">' + escapeHtml(s.korean) + '</span>' +
          '<button class="remove" onclick="removeSentence(' + i + ')">âœ•</button>' +
        '</div>'
      ).join('');
      document.getElementById('sentenceCount').textContent = sentences.length;
    }
    
    function removeSentence(i) {
      sentences.splice(i, 1);
      renderSentences();
    }
    
    // Auto-parse textarea content into answers (Level 4)
    function parseAnswersFromTextarea() {
      const rawText = document.getElementById('answerKorean').value;
      
      if (!rawText.trim()) {
        answers = [];
        renderAnswers();
        return;
      }
      
      // Split by newlines and clean up each line
      const lines = rawText
        .split(/\\r?\\n|\\r/)
        .map(line => {
          // Remove bullet points, asterisks, numbers, dashes at start
          return line
            .replace(/^[\\s]*[\\*\\-\\â€¢\\â—¦\\â–ª\\â–¸\\â–º\\â†’\\Â·\\â—\\â—‹\\â˜†\\â˜…\\âœ“\\âœ”\\âœ—\\âœ˜\\>\\Â»\\]\\)\\}]+[\\s]*/g, '')
            .replace(/^[\\s]*\\d+[\\.\\)\\]:][\\s]*/g, '')
            .trim();
        })
        .filter(line => line.length > 0);
      
      // Update answers array (avoid duplicates)
      answers = [];
      const seen = new Set();
      lines.forEach(korean => {
        if (!seen.has(korean)) {
          seen.add(korean);
          answers.push({ korean });
        }
      });
      
      renderAnswers();
    }
    
    // Set up auto-parsing when textareas change
    document.addEventListener('DOMContentLoaded', function() {
      // Load Discord config
      loadDiscordConfig();
      
      // Level 1-3 textarea
      const sentenceTextarea = document.getElementById('sentenceKorean');
      if (sentenceTextarea) {
        sentenceTextarea.addEventListener('input', parseSentencesFromTextarea);
        sentenceTextarea.addEventListener('paste', function() {
          setTimeout(parseSentencesFromTextarea, 10);
        });
      }
      
      // Level 4 textarea
      const answerTextarea = document.getElementById('answerKorean');
      if (answerTextarea) {
        answerTextarea.addEventListener('input', parseAnswersFromTextarea);
        answerTextarea.addEventListener('paste', function() {
          setTimeout(parseAnswersFromTextarea, 10);
        });
      }
    });
    
    // Legacy function for backwards compatibility
    function addAnswers() {
      parseAnswersFromTextarea();
    }
    
    function addAnswer() {
      parseAnswersFromTextarea();
    }
    
    function clearAnswerInput() {
      document.getElementById('answerKorean').value = '';
      answers = [];
      renderAnswers();
    }
    
    function renderAnswers() {
      const container = document.getElementById('answerList');
      container.innerHTML = answers.map((a, i) => 
        '<div class="answer-item" style="flex-direction: column; align-items: stretch;">' +
          '<div style="display: flex; justify-content: space-between; align-items: center;">' +
            '<span class="text">' + escapeHtml(a.korean) + '</span>' +
            '<div>' +
              '<button class="btn btn-sm" onclick="toggleVideoInput(' + i + ')" style="padding: 4px 8px; font-size: 11px; background: rgba(156,39,176,0.3); margin-right: 5px;">' + (a.videoUrl ? 'ðŸŽ¬' : 'ðŸ“¹') + '</button>' +
              '<button class="remove" onclick="removeAnswer(' + i + ')">âœ•</button>' +
            '</div>' +
          '</div>' +
          '<div id="videoInput' + i + '" class="video-input-row" style="display: ' + (a.showVideoInput ? 'block' : 'none') + '; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(156,39,176,0.3);">' +
            '<input type="text" placeholder="Loom URL (optional)" value="' + escapeHtml(a.videoUrl || '') + '" onchange="updateAnswerVideo(' + i + ', this.value)" style="font-size: 12px; padding: 6px; margin-bottom: 5px; border-color: rgba(156,39,176,0.5);">' +
            '<input type="text" placeholder="Video title" value="' + escapeHtml(a.videoTitle || '') + '" onchange="updateAnswerVideoTitle(' + i + ', this.value)" style="font-size: 12px; padding: 6px; border-color: rgba(156,39,176,0.5);">' +
          '</div>' +
        '</div>'
      ).join('');
      document.getElementById('answerCount').textContent = answers.length;
    }
    
    function toggleVideoInput(i) {
      answers[i].showVideoInput = !answers[i].showVideoInput;
      renderAnswers();
    }
    
    function updateAnswerVideo(i, url) {
      answers[i].videoUrl = url;
    }
    
    function updateAnswerVideoTitle(i, title) {
      answers[i].videoTitle = title;
    }
    
    function removeAnswer(i) {
      answers.splice(i, 1);
      renderAnswers();
    }
    
    // Clear all
    function clearAll() {
      sentences = [];
      answers = [];
      gameData = [];
      renderSentences();
      renderAnswers();
      document.getElementById('resultsSection').style.display = 'none';
    }
    
    // Generate
    async function generate() {
      if (currentLevel === 4) {
        if (answers.length === 0) {
          showToast('Add at least one answer sentence');
          return;
        }
        await generateLevel4();
      } else {
        if (sentences.length === 0) {
          showToast('Add at least one sentence');
          return;
        }
        await generateLevel123();
      }
    }
    
    function regenerate() {
      generate();
    }
    
    // Show/hide progress
    function showProgress(show) {
      document.getElementById('progressSection').style.display = show ? 'block' : 'none';
      document.getElementById('generateBtn').disabled = show;
    }
    
    function updateProgress(text, pct) {
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressFill').style.width = pct + '%';
    }
    
    // Generate Level 4
    async function generateLevel4() {
      showProgress(true);
      updateProgress('Validating settings...', 5);
      
      // Get config values
      const promptCount = parseInt(document.getElementById('questionCount').value) || 5;
      const aPerQ = parseInt(document.getElementById('answersPerQ').value) || 3;
      const mode = document.getElementById('answerMode').value;
      
      // Get prompt type percentages
      const pctQ = parseInt(document.getElementById('pctQuestions').value) || 0;
      const pctS = parseInt(document.getElementById('pctSituational').value) || 0;
      const pctSt = parseInt(document.getElementById('pctStatements').value) || 0;
      
      // Get difficulty tier percentages
      const pctTier1 = parseInt(document.getElementById('pctTier1').value) || 60;
      const pctTier2 = parseInt(document.getElementById('pctTier2').value) || 40;
      
      // Validate prompt type percentages
      if (pctQ + pctS + pctSt !== 100) {
        showProgress(false);
        showToast('âŒ Prompt type percentages must total 100%');
        return;
      }
      
      // Validate difficulty tier percentages
      if (pctTier1 + pctTier2 !== 100) {
        showProgress(false);
        showToast('âŒ Difficulty tier percentages must total 100%');
        return;
      }
      
      // Get variety options
      const speechLevel = document.getElementById('speechLevel').value;
      const speakerTypes = document.getElementById('speakerTypes').value;
      const settingTypes = document.getElementById('settingTypes').value;
      
      // Calculate counts
      const numQuestions = Math.round(promptCount * pctQ / 100);
      const numSituational = Math.round(promptCount * pctS / 100);
      const numStatements = promptCount - numQuestions - numSituational;
      
      const numTier1 = Math.round(promptCount * pctTier1 / 100);
      const numTier2 = promptCount - numTier1;
      
      const answersList = answers.map((a, i) => (i+1) + '. ' + a.korean).join('\\n');
      
      const modeInstruction = mode === 'strict' 
        ? \`You MUST include exactly \${aPerQ} answers for each prompt.\`
        : \`Aim for \${aPerQ} answers per prompt (minimum 2). Only use fewer if absolutely necessary. Each prompt should fit at least 2-3 sentences from the list.\`;
      
      // Build variety instructions
      let varietyInstructions = '\\nVARIETY REQUIREMENTS (IMPORTANT - Make each prompt DISTINCTLY DIFFERENT):\\n';
      varietyInstructions += '- NEVER create similar or repetitive prompts. Each must have a unique context.\\n';
      varietyInstructions += '- Vary the scenario, relationship, and situation for each prompt.\\n';
      
      if (speechLevel !== 'mixed') {
        varietyInstructions += \`- Use \${speechLevel === 'formal' ? 'ì¡´ëŒ“ë§ (formal speech)' : 'ë°˜ë§ (casual speech)'} for all Korean questions.\\n\`;
      } else {
        varietyInstructions += '- Mix ì¡´ëŒ“ë§ and ë°˜ë§ naturally based on the speaker relationship.\\n';
      }
      
      if (speakerTypes !== 'mixed') {
        const speakerMap = {
          'friends': 'friends talking casually',
          'formal': 'formal relationships (teacher-student, boss-employee)',
          'strangers': 'strangers or first-time meetings',
          'family': 'family members'
        };
        varietyInstructions += \`- All prompts should involve \${speakerMap[speakerTypes]}.\\n\`;
      } else {
        varietyInstructions += '- Use different speaker relationships: friends, family, coworkers, strangers, teachers, etc.\\n';
      }
      
      if (settingTypes !== 'mixed') {
        const settingMap = {
          'cafe': 'cafe or restaurant',
          'school': 'school or classroom',
          'work': 'office or workplace',
          'home': 'home or apartment',
          'street': 'street, public places, or transit'
        };
        varietyInstructions += \`- All prompts should take place in: \${settingMap[settingTypes]}.\\n\`;
      } else {
        varietyInstructions += '- Use different settings: cafe, school, home, office, street, store, etc.\\n';
      }
      
      // FIRST AI CALL: Generate prompts only (no vocabulary)
      const prompt = \`You are a Korean language teacher creating a conversation practice exercise.

HERE ARE THE KOREAN ANSWER SENTENCES (students will respond with these - DO NOT MODIFY THEM):
\${answersList}

CRITICAL RULE - NATURAL MATCHING:
The prompt you create MUST be something that the answer sentence would NATURALLY respond to.
- First, understand what each answer sentence MEANS
- Then create a prompt (question/situation/statement) that would NATURALLY elicit that answer
- The student should be able to say the answer and it makes perfect conversational sense

EXAMPLES OF GOOD MATCHING:
- Answer: "ì €ë„ìš”. ìš´ë™ ì•ˆ í•´ìš”" (Me neither. I don't exercise)
  â†’ Question: "ì € ìš”ì¦˜ ìš´ë™ ì•ˆ í•˜ëŠ”ë°, ë„ˆëŠ”?" (I haven't been exercising lately, how about you?)
  â†’ Situational: "Your friend complains they've been too lazy to exercise. Respond agreeing with them."
  â†’ Statement: "Your friend just said they don't exercise. Express that you're the same."

- Answer: "ì•„ë‹ˆìš”, ë°° ì•ˆ ê³ íŒŒìš”" (No, I'm not hungry)
  â†’ Question: "ë°°ê³ íŒŒìš”?" (Are you hungry?)
  â†’ Situational: "Your mom asks if you want dinner. You're not hungry."
  â†’ Statement: "Someone offers you food. Decline politely."

- Answer: "í•™êµì— ê°€ìš”" (I'm going to school)
  â†’ Question: "ì–´ë”” ê°€ìš”?" (Where are you going?)
  â†’ Situational: "Your roommate asks where you're headed."
  â†’ Statement: "Tell your friend where you're going."

BAD MATCHING (AVOID):
- Answer: "ì €ë„ìš”" (Me too) with Question: "ë­ í•´ìš”?" (What are you doing?) âŒ
  â†’ "ì €ë„ìš”" is an AGREEMENT, not an activity description
- Answer: "ì•„ë‹ˆìš”" (No) with Question: "ë­ ë¨¹ì—ˆì–´ìš”?" (What did you eat?) âŒ
  â†’ "ì•„ë‹ˆìš”" answers YES/NO questions, not "what" questions

\${varietyInstructions}

Generate prompts in this EXACT distribution:
TYPE DISTRIBUTION:
- \${numQuestions} QUESTIONS (direct Korean questions - the answer should naturally respond to this question)
- \${numSituational} SITUATIONAL (English scenario descriptions - describe a situation where saying the answer makes sense)
- \${numStatements} STATEMENTS (commands/requests in English - tell the student to express something that matches the answer)

DIFFICULTY DISTRIBUTION:
- \${numTier1} TIER 1 (Simple): Single clause, basic grammar. Examples: "ë­ ë¨¹ì—ˆì–´?", "ì–´ë”” ê°€?"
- \${numTier2} TIER 2 (Complex): Multiple clauses, advanced grammar (-ã„¹ ë•Œ, -ë©´, -ì„œ, -ê³ , etc.). Examples: "ì–´ì œ ì¹œêµ¬ ë§Œë‚¬ì„ ë•Œ ë­ ë¨¹ì—ˆì–´?", "ì‹œê°„ ìžˆìœ¼ë©´ ë­ í•˜ê³  ì‹¶ì–´?"

\${modeInstruction}

Each prompt should fit 2-3 answers that would ALL be natural responses to it.
Every sentence from the list should be used at least once across all prompts.

For EACH prompt, provide promptKeywords (key vocabulary from the Korean prompt itself).

Return ONLY valid JSON array:
[
  {
    "type": "question" | "situational" | "statement",
    "tier": 1 | 2,
    "prompt": "The prompt text (Korean for questions, English for situational/statement)",
    "promptKorean": "Korean version (same as prompt for questions, translation for others)",
    "promptEnglish": "English version (translation for questions, same as prompt for others)",
    "promptKeywords": [{"word": "ë­", "definition": "what"}],
    "answers": [
      {
        "korean": "EXACT sentence from the provided list",
        "english": "English translation",
        "color": "green|blue|yellow|red",
        "beginnerKorean": "Simplified 1-2 clause version for beginners",
        "beginnerEnglish": "English translation of beginner version"
      }
    ]
  }
]

IMPORTANT FOR BEGINNER SENTENCES:
- "beginnerKorean" must be a SIMPLIFIED version with maximum 1-2 clauses
- Remove complex grammar patterns (-ë©´, -ì„œ, -ã„¹ ë•Œ, -ëŠ”ë°, etc.) but can keep ONE simple connector like -ê³ 
- Keep the core meaning but make it simpler
- Use basic grammar only (present, past, future with ìš” ending)
- CRITICAL: Each beginnerKorean in the same card MUST BE UNIQUE - no duplicate beginner sentences within the same prompt
- Example:
  - Original: "ì¹´íŽ˜ì—ì„œ ì¹œêµ¬ëž‘ ì»¤í”¼ ë§ˆì‹œê³  ìžˆì–´ìš”" â†’ Beginner: "ì»¤í”¼ ë§ˆì‹œê³  ìžˆì–´ìš”" (2 clauses max)
  - Original: "ë‚ ì”¨ê°€ ì¢‹ìœ¼ë©´ ì‚°ì±…í•˜ê³  ì‹¶ì–´ìš”" â†’ Beginner: "ì‚°ì±…í•˜ê³  ì‹¶ì–´ìš”"
  - Original: "ì–´ì œ í•™êµì— ê°€ì„œ ê³µë¶€í–ˆì–´ìš”" â†’ Beginner: "í•™êµì—ì„œ ê³µë¶€í–ˆì–´ìš”"
  - If multiple answers would have same beginner version, vary them:
    - Answer 1: "ë°¥ ë¨¹ì—ˆì–´ìš”"
    - Answer 2: "ì ì‹¬ ë¨¹ì—ˆì–´ìš”" (different noun)
    - Answer 3: "ë°¥ì„ ë¨¹ê³  ìžˆì–´ìš”" (different tense)\`;

      try {
        updateProgress('Generating prompts...', 10);
        console.log('Starting Level 4 AI call 1 (prompts)...');
        console.log('Distribution:', numQuestions, 'questions,', numSituational, 'situational,', numStatements, 'statements');
        console.log('Difficulty:', numTier1, 'tier 1,', numTier2, 'tier 2');
        
        const response = await callAI(prompt);
        
        updateProgress('Processing prompts...', 40);
        console.log('=== LEVEL 4 RESPONSE (Prompts) ===');
        console.log('Type:', typeof response);
        console.log('Is Array:', Array.isArray(response));
        console.log('Content:', JSON.stringify(response).substring(0, 500));
        
        const parsed = parseJSON(response);
        console.log('After parseJSON:', parsed);
        
        if (!parsed || parsed.length === 0) {
          throw new Error('AI returned empty or invalid data');
        }
        
        gameData = parsed;
        
        // SECOND AI CALL: Generate vocabulary for all unique WORDS (not sentences)
        updateProgress('Generating vocabulary definitions...', 50);
        
        // Collect all unique Korean words by splitting sentences
        const allWords = new Set();
        const sentenceWordMap = {}; // Track which words belong to which sentence
        
        gameData.forEach(card => {
          card.answers.forEach(a => {
            const words = a.korean.split(' ').filter(w => w.trim());
            sentenceWordMap[a.korean] = words;
            words.forEach(word => allWords.add(word));
          });
        });
        
        const wordList = Array.from(allWords);
        console.log('Words for vocabulary:', wordList);
        console.log('Total unique words:', wordList.length);
        
        const vocabPrompt = \`You are a Korean language expert. Define EVERY word in this list.

WORDS TO DEFINE (you MUST define ALL of these):
\${wordList.map((w, i) => (i+1) + '. ' + w).join('\\n')}

For EACH word, provide:
- word: the exact Korean word from the list
- definition: English meaning (for conjugated verbs, explain the full meaning including tense/politeness)
- pos: part of speech (noun, verb, adjective, particle, adverb, etc.)
- example: a simple example sentence
- exampleEng: English translation
- grammar: (IMPORTANT) If the word contains a grammar pattern, show the conjugation formula for ALL parts of speech:
  * Format: "PATTERN: Nounì´/ê°€, AVì•„/ì–´, DVì€/ã„´" where AV=Action Verb, DV=Descriptive Verb
  * For ì•„/ì–´ patterns: show the vowel harmony rule
  * For ã„¹ patterns: show when ã„¹ drops
  * For ì€/ã„´ patterns: show consonant vs vowel endings
  
Examples of grammar field:
- "ê°”ì–´ìš”" â†’ grammar: "-ì•˜/ì—ˆì–´ìš” (past polite): AVì•„/ì–´+ã…†ì–´ìš” (ê°€ë‹¤â†’ê°”ì–´ìš”)"
- "ë¨¹ëŠ”ë°" â†’ grammar: "-ëŠ”ë° (background): AVëŠ”ë°, DVì€/ã„´ë°, Nì¸ë°"
- "ì˜ˆìœ" â†’ grammar: "-ì€/ã„´ (adj modifier): DVì€/ã„´ (ë°›ì¹¨Oâ†’ì€, ë°›ì¹¨Xâ†’ã„´)"
- "ë”°ëœ»í•´ì ¸ì„œ" â†’ grammar: "-ì•„/ì–´ì§€ë‹¤ (become) + -ì•„/ì–´ì„œ (because): DVì•„/ì–´ì ¸ì„œ"
- "ì¢‹ì•„ì¡Œì–´ìš”" â†’ grammar: "-ì•„/ì–´ì§€ë‹¤ (become) + -ì•˜/ì—ˆì–´ìš” (past): DVì•„/ì–´ì¡Œì–´ìš”"

For conjugated verbs like "ì¢‹ì•„ì¡Œì–´ìš”" or "ë”°ëœ»í•´ì ¸ì„œ", explain the root verb + grammar pattern in the definition.

Return ONLY valid JSON object with the EXACT word as key:
{
  "\${wordList[0] || 'ì¹´íŽ˜ì—'}": {"word": "\${wordList[0] || 'ì¹´íŽ˜ì—'}", "definition": "to the cafe", "pos": "noun+particle", "example": "ì¹´íŽ˜ì— ê°€ìš”", "exampleEng": "I go to the cafe", "grammar": "Nì— (location particle)"},
  "\${wordList[1] || 'ì™”ì–´ìš”'}": {"word": "\${wordList[1] || 'ì™”ì–´ìš”'}", "definition": "came (past tense, polite)", "pos": "verb", "example": "ì¹œêµ¬ê°€ ì™”ì–´ìš”", "exampleEng": "My friend came", "grammar": "-ì•˜/ì—ˆì–´ìš” (past polite): AVì•„/ì–´+ã…†ì–´ìš”"}
}

IMPORTANT: Return a definition for EVERY word in the list above. Do not skip any.\`;

        const vocabResponse = await callAI(vocabPrompt);
        updateProgress('Processing vocabulary...', 80);
        
        console.log('=== VOCABULARY RESPONSE ===');
        console.log('Type:', typeof vocabResponse);
        
        // Parse vocabulary response
        let vocabData = vocabResponse;
        if (typeof vocabResponse === 'string') {
          try {
            // Try to extract JSON object
            const match = vocabResponse.match(/\\{[\\s\\S]*\\}/);
            if (match) {
              vocabData = JSON.parse(match[0]);
            } else {
              vocabData = JSON.parse(vocabResponse);
            }
          } catch (e) {
            console.error('Failed to parse vocab response:', e);
            vocabData = {};
          }
        }
        
        console.log('Parsed vocab data keys:', Object.keys(vocabData));
        console.log('Words defined:', Object.keys(vocabData).length, '/', wordList.length);
        
        // Merge vocabulary into gameData - now using word-level lookup
        gameData.forEach(card => {
          card.answers.forEach(answer => {
            const words = sentenceWordMap[answer.korean] || answer.korean.split(' ');
            const vocabArray = [];
            
            words.forEach(word => {
              if (vocabData[word]) {
                vocabArray.push(vocabData[word]);
              } else {
                // Try to find partial match (in case of slight differences)
                let found = false;
                for (const key of Object.keys(vocabData)) {
                  if (key === word || word.includes(key) || key.includes(word)) {
                    vocabArray.push(vocabData[key]);
                    found = true;
                    break;
                  }
                }
                if (!found) {
                  console.log('No vocab found for word:', word);
                }
              }
            });
            
            answer.vocabulary = vocabArray;
          });
        });
        
        updateProgress('Done! Generated ' + gameData.length + ' cards with vocabulary', 100);
        
        setTimeout(() => {
          showProgress(false);
          showResults();
          showToast('âœ… Generated ' + gameData.length + ' flashcards!');
        }, 800);
        
      } catch (err) {
        console.error('Generation error:', err);
        showProgress(false);
        showToast('âŒ Error: ' + err.message);
        alert('AI Error: ' + err.message + '\\n\\nCheck browser console (F12) for details.');
      }
    }
    
    // Generate Level 1-3 with AI
    async function generateLevel123() {
      showProgress(true);
      updateProgress('Connecting to AI...', 5);
      
      let prompt = '';
      
      if (currentLevel === 1) {
        // Level 1: Word Order Permutations
        const sentencesList = sentences.map((s, i) => (i+1) + '. ' + s.korean).join('\\n');
        prompt = \`You are a Korean language expert.

Here are Korean sentences:
\${sentencesList}

For each sentence, generate ALL grammatically correct word order permutations.
Only include orders that native Korean speakers would actually use.
The meaning should stay the same, just different word arrangements.

Return ONLY valid JSON array:
[
  {
    "question": "original Korean sentence",
    "questionEnglish": "English translation",
    "answers": [
      {"korean": "permutation 1", "english": "same meaning", "color": "green"},
      {"korean": "permutation 2", "english": "same meaning", "color": "blue"}
    ]
  }
]\`;
      } else if (currentLevel === 2) {
        // Level 2: Word Substitution
        const sentencesList = sentences.map((s, i) => (i+1) + '. ' + s.korean).join('\\n');
        prompt = \`You are a Korean language expert.

Here are Korean sentences:
\${sentencesList}

For each sentence, generate variations by SUBSTITUTING words while keeping the SAME grammar structure.
Keep all particles and grammar endings the same.
Only change nouns, verbs, adjectives, or adverbs.

Example: "ë‚¨ìžì¹œêµ¬ëž‘ ì¹´íŽ˜ì—ì„œ ìžì£¼ ë§Œë‚˜ìš”" â†’ "ì—„ë§ˆëž‘ ì§‘ì—ì„œ ê°€ë” ë§Œë‚˜ìš”"

Return ONLY valid JSON array:
[
  {
    "question": "original Korean sentence",
    "questionEnglish": "English translation",
    "answers": [
      {"korean": "variation with substituted words", "english": "English translation", "color": "green"},
      {"korean": "another variation", "english": "English translation", "color": "blue"}
    ]
  }
]

Generate 4-6 variations per sentence.\`;
      } else if (currentLevel === 3) {
        // Level 3: Grammar Endings
        const sentencesList = sentences.map((s, i) => (i+1) + '. ' + s.korean).join('\\n');
        prompt = \`You are a Korean language expert.

Here are Korean sentences:
\${sentencesList}

For each sentence, generate variations with DIFFERENT ENDING GRAMMAR POINTS.
Keep the base sentence the same, only change the final grammar ending.
Show how the meaning/nuance changes with different endings.

Examples of endings: -ë„¤ìš”, -ì§€ìš”, -ê±°ë“ ìš”, -ìž–ì•„ìš”, -ë”ë¼ê³ ìš”, -ëŠ”ë°ìš”

Return ONLY valid JSON array:
[
  {
    "question": "original Korean sentence",
    "questionEnglish": "English translation",
    "answers": [
      {"korean": "sentence with -ë„¤ìš” ending", "english": "expressing surprise", "color": "green"},
      {"korean": "sentence with -ì§€ìš” ending", "english": "seeking confirmation", "color": "blue"},
      {"korean": "sentence with -ê±°ë“ ìš” ending", "english": "giving reason", "color": "yellow"}
    ]
  }
]

Generate 4-6 ending variations per sentence.\`;
      }

      try {
        updateProgress('Generating with AI...', 20);
        console.log('Starting AI call for Level ' + currentLevel);
        
        const response = await callAI(prompt);
        
        updateProgress('Processing response...', 80);
        console.log('Raw AI response:', response);
        
        const parsed = parseJSON(response);
        console.log('Parsed data:', parsed);
        
        if (!parsed || parsed.length === 0) {
          throw new Error('AI returned empty or invalid data');
        }
        
        gameData = parsed;
        updateProgress('Done! Generated ' + gameData.length + ' cards', 100);
        
        setTimeout(() => {
          showProgress(false);
          showResults();
          showToast('âœ… Generated ' + gameData.length + ' cards!');
        }, 800);
        
      } catch (err) {
        console.error('Generation error:', err);
        showProgress(false);
        showToast('âŒ Error: ' + err.message);
        alert('AI Error: ' + err.message + '\\n\\nCheck browser console (F12) for details.');
      }
    }
    
    // Call AI
    async function callAI(prompt) {
      console.log('Calling AI with prompt:', prompt.substring(0, 200) + '...');
      
      try {
        const response = await fetch(AI_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role: 'system', content: 'You are a Korean language expert. Respond only with valid JSON.' },
              { role: 'user', content: prompt }
            ],
            temperature: 0.7
          })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Response error:', errorText);
          throw new Error('AI call failed: ' + response.status + ' - ' + errorText);
        }
        
        const result = await response.json();
        console.log('AI Result:', result);
        
        if (!result.success) {
          throw new Error(result.error || 'AI call failed');
        }
        
        console.log('AI Data:', result.data);
        return result.data;
        
      } catch (err) {
        console.error('AI call error:', err);
        throw err;
      }
    }
    
    // Parse JSON from AI response
    function parseJSON(data) {
      try {
        // If it's already an array, return it
        if (Array.isArray(data)) {
          console.log('Data is already an array');
          return data;
        }
        
        // If it's an object but not array, check if it has the data we need
        if (typeof data === 'object' && data !== null) {
          console.log('Data is an object:', data);
          // Maybe the array is inside a property
          if (Array.isArray(data.questions)) return data.questions;
          if (Array.isArray(data.data)) return data.data;
          if (Array.isArray(data.results)) return data.results;
          return null;
        }
        
        // If it's a string, try to extract JSON
        if (typeof data === 'string') {
          console.log('Data is a string, parsing...');
          const match = data.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/);
          if (match) return JSON.parse(match[0]);
          return JSON.parse(data);
        }
        
        console.log('Unknown data type:', typeof data);
        return null;
      } catch (e) {
        console.error('Parse error:', e);
        return null;
      }
    }
    
    // Show results
    function showResults() {
      const container = document.getElementById('resultsContainer');
      
      container.innerHTML = gameData.map((item, i) => {
        const typeLabel = item.type === 'question' ? 'â“' : item.type === 'statement' ? 'ðŸ’¬' : 'ðŸ“';
        const tierLabel = item.tier === 2 ? '<span style="background: #ff00ff; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">T2</span>' : '<span style="background: #39ff14; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">T1</span>';
        const promptDisplay = item.type === 'question' ? (item.promptKorean || item.prompt) : item.prompt;
        
        return '<div class="result-card" data-index="' + i + '">' +
          '<div class="result-header">' +
            '<span class="result-num">' + typeLabel + ' ' + (i+1) + tierLabel + '</span>' +
            '<div>' +
              '<button class="btn btn-sm btn-secondary" onclick="regenerateSingleCard(' + i + ')" title="Regenerate this card">ðŸ”„</button>' +
              '<button class="btn btn-sm btn-secondary" onclick="editCardAt(' + i + ')" title="Edit">âœï¸</button>' +
              '<button class="btn btn-sm btn-secondary" onclick="markDifficult(' + i + ')" title="Mark as difficult">âš ï¸</button>' +
            '</div>' +
          '</div>' +
          '<div class="result-question">' + escapeHtml(promptDisplay) + '</div>' +
          '<div class="result-english">' + escapeHtml(item.promptEnglish || '') + '</div>' +
          '<div class="result-answers">' +
            item.answers.map(a => 
              '<span class="answer-pill ' + a.color + '">' + escapeHtml(a.korean) + '</span>'
            ).join('') +
          '</div>' +
        '</div>';
      }).join('');
      
      document.getElementById('resultsSection').style.display = 'block';
    }
    
    // Regenerate a single card
    async function regenerateSingleCard(index) {
      const card = gameData[index];
      showToast('ðŸ”„ Regenerating card ' + (index + 1) + '...');
      
      const answersList = answers.map((a, i) => (i+1) + '. ' + a.korean).join('\\n');
      const prompt = \`Regenerate ONE new prompt for this Korean practice exercise. Make it DIFFERENT from: "\${card.prompt}"

Available answer sentences:
\${answersList}

Create a completely different scenario/question that could use 2-3 of these answers.
Type: \${card.type}, Tier: \${card.tier}

Return ONLY valid JSON (single object, not array):
{
  "type": "\${card.type}",
  "tier": \${card.tier},
  "prompt": "New prompt text",
  "promptKorean": "Korean version",
  "promptEnglish": "English version",
  "promptKeywords": [{"word": "ë‹¨ì–´", "definition": "meaning"}],
  "answers": [{"korean": "exact sentence", "english": "translation", "color": "green", "vocabulary": []}]
}\`;

      try {
        const response = await callAI(prompt);
        let newCard = response;
        if (typeof response === 'string') {
          newCard = JSON.parse(response);
        }
        if (Array.isArray(newCard)) newCard = newCard[0];
        
        gameData[index] = newCard;
        showResults();
        showToast('âœ… Card ' + (index + 1) + ' regenerated!');
      } catch (err) {
        console.error('Regenerate error:', err);
        showToast('âŒ Failed to regenerate');
      }
    }
    
    // Mark card as difficult
    let difficultCards = new Set();
    function markDifficult(index) {
      const cardEl = document.querySelector('.result-card[data-index="' + index + '"]');
      if (difficultCards.has(index)) {
        difficultCards.delete(index);
        cardEl?.classList.remove('difficult');
        showToast('Card unmarked');
      } else {
        difficultCards.add(index);
        cardEl?.classList.add('difficult');
        showToast('âš ï¸ Marked as difficult');
      }
    }
    
    // Save game - use parent Firebase if available, else localStorage
    async function saveGame() {
      const gameName = prompt('Enter a name for this game:');
      if (!gameName) return;
      
      const gameDataToSave = {
        title: gameName,
        level: currentLevel,
        gameData: gameData,
        answers: answers,
        sentences: sentences,
        videoUrl: document.getElementById('level4VideoUrl')?.value || '',
        videoTitle: document.getElementById('level4VideoTitle')?.value || '',
        videoDesc: document.getElementById('level4VideoDesc')?.value || '',
        savedAt: new Date().toISOString()
      };
      
      // Try parent Firebase first
      if (window.parent && window.parent.saveYodafyGame) {
        try {
          await window.parent.saveYodafyGame(JSON.stringify(gameDataToSave));
          showToast('ðŸ’¾ Game saved to cloud: ' + gameName);
          return;
        } catch(e) {
          console.log('Parent save failed, using localStorage:', e);
        }
      }
      
      // Fallback to localStorage
      const savedGames = JSON.parse(localStorage.getItem('yodafyGames') || '{}');
      savedGames[gameName] = gameDataToSave;
      localStorage.setItem('yodafyGames', JSON.stringify(savedGames));
      showToast('ðŸ’¾ Game saved locally: ' + gameName);
    }
    
    // Load saved game - Modal approach
    let allSavedGames = [];
    let filteredGames = [];
    
    async function loadSavedGame() {
      document.getElementById('loadModal').style.display = 'flex';
      document.getElementById('loadStatus').textContent = 'Loading games...';
      document.getElementById('gamesGrid').innerHTML = '';
      document.getElementById('gameSearchInput').value = '';
      
      allSavedGames = [];
      
      // Try parent Firebase first
      if (window.parent && window.parent.loadYodafyGames) {
        try {
          const result = await window.parent.loadYodafyGames();
          console.log('Load result:', result);
          if (result && result.success && result.games) {
            allSavedGames = result.games;
          }
        } catch(e) {
          console.log('Parent load failed:', e);
        }
      }
      
      // Also check localStorage
      const localGames = JSON.parse(localStorage.getItem('yodafyGames') || '{}');
      Object.keys(localGames).forEach(name => {
        const game = localGames[name];
        game.title = game.title || name;
        game.isLocal = true;
        allSavedGames.push(game);
      });
      
      filteredGames = [...allSavedGames];
      sortGames();
      renderGamesGrid();
    }
    
    function closeLoadModal() {
      document.getElementById('loadModal').style.display = 'none';
    }
    
    function filterGames() {
      const searchTerm = document.getElementById('gameSearchInput').value.toLowerCase();
      filteredGames = allSavedGames.filter(g => 
        (g.title || 'Untitled').toLowerCase().includes(searchTerm)
      );
      sortGames();
      renderGamesGrid();
    }
    
    function sortGames() {
      const sortBy = document.getElementById('gameSortSelect').value;
      filteredGames.sort((a, b) => {
        switch(sortBy) {
          case 'newest':
            return new Date(b.savedAt || b.createdAt?.toDate?.() || 0) - new Date(a.savedAt || a.createdAt?.toDate?.() || 0);
          case 'oldest':
            return new Date(a.savedAt || a.createdAt?.toDate?.() || 0) - new Date(b.savedAt || b.createdAt?.toDate?.() || 0);
          case 'name-az':
            return (a.title || '').localeCompare(b.title || '');
          case 'name-za':
            return (b.title || '').localeCompare(a.title || '');
          default:
            return 0;
        }
      });
      renderGamesGrid();
    }
    
    function renderGamesGrid() {
      const grid = document.getElementById('gamesGrid');
      const status = document.getElementById('loadStatus');
      
      if (filteredGames.length === 0) {
        status.style.display = 'block';
        status.textContent = allSavedGames.length === 0 ? 'No saved games found' : 'No games match your search';
        grid.innerHTML = '';
        return;
      }
      
      status.style.display = 'none';
      
      grid.innerHTML = filteredGames.map((game, i) => {
        const title = game.title || 'Untitled';
        const level = game.level || 4;
        const cardCount = game.gameData?.length || 0;
        const date = formatGameDate(game.savedAt || game.createdAt);
        const isLocal = game.isLocal;
        const gameId = game.id || i;
        
        return '<div class="game-card" data-index="' + i + '">' +
          '<div class="game-card-title">' + escapeHtml(title) + '</div>' +
          '<div class="game-card-meta">' +
            '<span class="game-card-tag level">Level ' + level + '</span>' +
            '<span class="game-card-tag cards">' + cardCount + ' cards</span>' +
            '<span class="game-card-tag date">' + date + '</span>' +
            (isLocal ? '<span class="game-card-tag">ðŸ’¾ Local</span>' : '<span class="game-card-tag">â˜ï¸ Cloud</span>') +
          '</div>' +
          '<div class="game-card-actions">' +
            '<button class="load-btn" onclick="loadGameByIndex(' + i + ')">â–¶ Load</button>' +
            '<button class="delete-btn" onclick="confirmDeleteGame(' + i + ', \\'' + escapeAttr(gameId) + '\\', ' + isLocal + ')">ðŸ—‘ï¸</button>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    
    function formatGameDate(dateVal) {
      if (!dateVal) return 'Unknown';
      try {
        // Handle Firestore timestamp
        const date = dateVal.toDate ? dateVal.toDate() : new Date(dateVal);
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        
        if (days === 0) return 'Today';
        if (days === 1) return 'Yesterday';
        if (days < 7) return days + ' days ago';
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
      } catch(e) {
        return 'Unknown';
      }
    }
    
    function loadGameByIndex(index) {
      const game = filteredGames[index];
      if (!game) return;
      
      loadGameData(game);
      closeLoadModal();
      showToast('âœ… Loaded: ' + (game.title || 'Untitled'));
    }
    
    async function confirmDeleteGame(index, gameId, isLocal) {
      const game = filteredGames[index];
      if (!game) return;
      
      if (!confirm('Delete "' + (game.title || 'Untitled') + '"?\\n\\nThis cannot be undone.')) return;
      
      if (isLocal) {
        // Delete from localStorage
        const localGames = JSON.parse(localStorage.getItem('yodafyGames') || '{}');
        delete localGames[game.title];
        localStorage.setItem('yodafyGames', JSON.stringify(localGames));
        showToast('ðŸ—‘ï¸ Deleted from local storage');
      } else {
        // Delete from Firebase
        if (window.parent && window.parent.deleteYodafyGame) {
          try {
            await window.parent.deleteYodafyGame(gameId);
            showToast('ðŸ—‘ï¸ Deleted from cloud');
          } catch(e) {
            showToast('âŒ Failed to delete');
            return;
          }
        }
      }
      
      // Refresh the list
      loadSavedGame();
    }
    
    function loadGameData(game) {
      currentLevel = game.level || 4;
      gameData = game.gameData || [];
      answers = game.answers || [];
      sentences = game.sentences || [];
      
      // Load video fields if present
      if (game.videoUrl) document.getElementById('level4VideoUrl').value = game.videoUrl;
      if (game.videoTitle) document.getElementById('level4VideoTitle').value = game.videoTitle;
      if (game.videoDesc) document.getElementById('level4VideoDesc').value = game.videoDesc;
      
      // Update UI
      document.querySelectorAll('.level-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i + 1 === currentLevel);
      });
      selectLevel(currentLevel);
      
      if (gameData.length > 0) {
        showResults();
      }
      renderAnswers();
      renderSentences();
    }
    
    // ==================== ì¤€ë¹„ (Preparation) Screen ====================
    let isCovered = false;
    
    function startJunbi() {
      document.getElementById('junbiScreen').style.display = 'block';
      document.body.classList.add('junbi-open');
      // Hide the permutation game close button if it exists (in parent frame)
      const permCloseBtn = window.parent.document.getElementById('permutationCloseBtn');
      if (permCloseBtn) permCloseBtn.style.display = 'none';
      renderJunbi();
    }
    
    // Create hoverable word with tooltip
    function createWordWithTooltip(word, vocab) {
      if (!vocab) {
        // No vocab data - just show word with minimal tooltip
        return '<span class="word-hover">' + escapeHtml(word) + 
          '<span class="word-tooltip"><div class="wt-word">' + escapeHtml(word) + '</div><div class="wt-def" style="color:#888;">No definition available</div></span></span>';
      }
      
      const tooltip = '<span class="word-tooltip">' +
        '<div class="wt-word">' + escapeHtml(vocab.word) + '</div>' +
        '<div class="wt-pos">' + escapeHtml(vocab.pos || 'word') + '</div>' +
        '<div class="wt-def">' + escapeHtml(vocab.definition) + '</div>' +
        (vocab.example ? '<div class="wt-example"><span class="wt-example-ko">' + escapeHtml(vocab.example) + '</span><br>' + escapeHtml(vocab.exampleEng || '') + '</div>' : '') +
      '</span>';
      
      return '<span class="word-hover">' + escapeHtml(word) + tooltip + '</span>';
    }
    
    // Render Korean text with vocabulary tooltips - ALL words are hoverable
    function renderKoreanWithTooltips(korean, vocabulary) {
      // Build vocab map from provided vocabulary
      const vocabMap = {};
      if (vocabulary && vocabulary.length > 0) {
        vocabulary.forEach(v => {
          vocabMap[v.word] = v;
        });
      }
      
      // Split Korean into words/particles
      // Korean can have particles attached, so we split by spaces first
      const segments = korean.split(' ');
      
      const result = segments.map(segment => {
        // Check if this segment (or part of it) has vocab data
        let foundVocab = vocabMap[segment];
        
        // If not found directly, check if any vocab word is contained in this segment
        if (!foundVocab) {
          for (const vocabWord of Object.keys(vocabMap)) {
            if (segment.includes(vocabWord)) {
              foundVocab = vocabMap[vocabWord];
              break;
            }
          }
        }
        
        // Create hoverable span for every word
        if (foundVocab) {
          return '<span class="word-hover">' + escapeHtml(segment) +
            '<span class="word-tooltip">' +
              '<div class="wt-word">' + escapeHtml(foundVocab.word) + '</div>' +
              '<div class="wt-pos">' + escapeHtml(foundVocab.pos || '') + '</div>' +
              '<div class="wt-def">' + escapeHtml(foundVocab.definition) + '</div>' +
              (foundVocab.grammar ? '<div class="wt-grammar">ðŸ“ ' + escapeHtml(foundVocab.grammar) + '</div>' : '') +
              (foundVocab.example ? '<div class="wt-example"><span class="wt-example-ko">' + escapeHtml(foundVocab.example) + '</span><br>' + escapeHtml(foundVocab.exampleEng || '') + '</div>' : '') +
            '</span></span>';
        } else {
          // No vocab - still make hoverable but show "tap to look up" or similar
          return '<span class="word-hover word-no-def">' + escapeHtml(segment) +
            '<span class="word-tooltip">' +
              '<div class="wt-word">' + escapeHtml(segment) + '</div>' +
              '<div class="wt-def" style="color:#888;font-style:italic;">Definition not loaded</div>' +
            '</span></span>';
        }
      }).join(' ');
      
      return result;
    }
    
    function escapeRegex(str) {
      return str.replace(/[.*+?^\${}()|[\\]\\\\]/g, '\\\\$&');
    }
    
    function renderJunbi() {
      const container = document.getElementById('junbiContainer');
      const sortMode = document.getElementById('junbiSortMode')?.value || 'default';
      
      // Collect all unique answers across all prompts
      let allAnswers = [];
      let answerNum = 1;
      gameData.forEach((item) => {
        item.answers.forEach((a) => {
          // Check if this answer is already in the list (avoid duplicates)
          if (!allAnswers.some(existing => existing.korean === a.korean)) {
            allAnswers.push({
              num: answerNum++,
              korean: a.korean,
              english: a.english,
              color: a.color,
              vocabulary: a.vocabulary,
              tier: item.tier || 1
            });
          }
        });
      });
      
      // Sort based on mode
      if (sortMode === 'tier') {
        allAnswers.sort((a, b) => a.tier - b.tier);
        // Renumber after sort
        allAnswers.forEach((a, i) => a.num = i + 1);
      } else if (sortMode === 'shuffle') {
        // Fisher-Yates shuffle
        for (let i = allAnswers.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [allAnswers[i], allAnswers[j]] = [allAnswers[j], allAnswers[i]];
        }
        allAnswers.forEach((a, i) => a.num = i + 1);
      }
      
      let tableRows = '';
      allAnswers.forEach((a) => {
        // Korean is always covered with spoiler until clicked
        const koreanContent = '<span class="spoiler-block" onclick="this.classList.add(\\'revealed\\')">' + 
          '<span class="color-dot ' + a.color + '"></span>' +
          renderKoreanWithTooltips(a.korean, a.vocabulary) + '</span>';
        // English is always visible
        const englishContent = escapeHtml(a.english || '');
        
        const tierBadge = a.tier === 2 ? ' <span style="background:#ff00ff;color:#fff;padding:1px 4px;border-radius:3px;font-size:9px;">T2</span>' : '';
        
        tableRows += '<tr>' +
          '<td class="num">' + a.num + tierBadge + '</td>' +
          '<td class="korean-col">' + koreanContent + '</td>' +
          '<td class="english-col">' + englishContent + '</td>' +
        '</tr>';
      });
      
      container.innerHTML = '<div class="junbi-sheet">' +
        '<div class="junbi-sheet-header">' +
          '<h3>Korean Practice Sheet</h3>' +
          '<p>Level ' + currentLevel + ' â€¢ ' + allAnswers.length + ' Sentences â€¢ ' + new Date().toLocaleDateString() + '</p>' +
          '<p style="font-size: 10px; color: #999; margin-top: 5px;">Click each Korean sentence to reveal. Then hover for definitions.</p>' +
        '</div>' +
        '<table class="junbi-table">' +
          '<thead><tr>' +
            '<th class="num">#</th>' +
            '<th>Korean (í•œêµ­ì–´)</th>' +
            '<th>English</th>' +
          '</tr></thead>' +
          '<tbody>' + tableRows + '</tbody>' +
        '</table>' +
      '</div>';
    }
    
    function toggleCover() {
      const dropdown = document.getElementById('junbiCoverMode');
      if (!dropdown) return;
      
      // Toggle between 'none' and 'korean'
      if (dropdown.value === 'korean') {
        dropdown.value = 'none';
        document.getElementById('coverBtn').textContent = 'ðŸ™ˆ Cover Korean';
        document.getElementById('coverBtn').classList.remove('covered');
      } else {
        dropdown.value = 'korean';
        document.getElementById('coverBtn').textContent = 'ðŸ‘ï¸ Reveal Korean';
        document.getElementById('coverBtn').classList.add('covered');
      }
      renderJunbi();
    }
    
    function startGameFromJunbi() {
      document.getElementById('junbiScreen').style.display = 'none';
      document.getElementById('floatingCoverBtn').style.display = 'none';
      startGame();
    }
    
    function exitJunbi() {
      document.getElementById('junbiScreen').style.display = 'none';
      document.body.classList.remove('junbi-open');
      // Show the permutation game close button again if it exists (in parent frame)
      const permCloseBtn = window.parent.document.getElementById('permutationCloseBtn');
      if (permCloseBtn) permCloseBtn.style.display = 'flex';
    }
    
    // Export PDF for students
    function exportPDF() {
      // Collect all unique answers with vocabulary
      let allAnswers = [];
      let allVocab = new Map(); // Use Map to avoid duplicate words
      
      gameData.forEach((item) => {
        item.answers.forEach((a) => {
          if (!allAnswers.some(existing => existing.korean === a.korean)) {
            allAnswers.push({
              korean: a.korean,
              english: a.english
            });
            
            // Collect vocabulary
            if (a.vocabulary) {
              a.vocabulary.forEach(v => {
                if (!allVocab.has(v.word)) {
                  allVocab.set(v.word, v);
                }
              });
            }
          }
        });
      });
      
      // Create PDF HTML content
      const vocabArray = Array.from(allVocab.values());
      
      const pdfContent = \`
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Korean Practice Sheet</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600&display=swap');
    body { font-family: 'Noto Sans KR', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; color: #333; }
    h1 { text-align: center; color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 10px; }
    h2 { color: #1e40af; margin-top: 30px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    .date { text-align: center; color: #666; margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th { background: #f0f4f8; padding: 12px; text-align: left; border: 1px solid #ddd; }
    td { padding: 12px; border: 1px solid #ddd; vertical-align: top; }
    tr:nth-child(even) { background: #fafafa; }
    .korean { font-size: 16px; font-weight: 600; }
    .english { font-size: 14px; color: #555; }
    .vocab-word { font-weight: 600; color: #1e40af; }
    .vocab-pos { font-size: 11px; color: #888; text-transform: uppercase; margin-left: 5px; }
    .vocab-def { color: #333; }
    .vocab-example { font-size: 12px; color: #666; font-style: italic; margin-top: 5px; }
    @media print { body { padding: 20px; } }
  </style>
</head>
<body>
  <h1>ðŸ“– Korean Practice Sheet</h1>
  <p class="date">Level \${currentLevel} â€¢ \${allAnswers.length} Sentences â€¢ \${new Date().toLocaleDateString()}</p>
  
  <h2>ðŸ“ Sentences</h2>
  <table>
    <thead>
      <tr>
        <th style="width: 40px;">#</th>
        <th>Korean (í•œêµ­ì–´)</th>
        <th>English</th>
      </tr>
    </thead>
    <tbody>
      \${allAnswers.map((a, i) => \`
        <tr>
          <td>\${i + 1}</td>
          <td class="korean">\${escapeHtml(a.korean)}</td>
          <td class="english">\${escapeHtml(a.english || '')}</td>
        </tr>
      \`).join('')}
    </tbody>
  </table>
  
  <h2>ðŸ“š Vocabulary</h2>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Word</th>
        <th style="width: 80px;">Type</th>
        <th>Definition</th>
        <th>Example</th>
      </tr>
    </thead>
    <tbody>
      \${vocabArray.map(v => \`
        <tr>
          <td class="vocab-word">\${escapeHtml(v.word)}</td>
          <td class="vocab-pos">\${escapeHtml(v.pos || '')}</td>
          <td class="vocab-def">\${escapeHtml(v.definition || '')}</td>
          <td class="vocab-example">\${v.example ? escapeHtml(v.example) + '<br><span style="color: #888;">' + escapeHtml(v.exampleEng || '') + '</span>' : ''}</td>
        </tr>
      \`).join('')}
    </tbody>
  </table>
</body>
</html>\`;
      
      // Open in new window for printing/saving as PDF
      const printWindow = window.open('', '_blank');
      printWindow.document.write(pdfContent);
      printWindow.document.close();
      
      // Auto-trigger print dialog
      setTimeout(() => {
        printWindow.print();
      }, 500);
      
      showToast('ðŸ“„ PDF opened in new tab - use Print > Save as PDF');
    }
    // ==================== END ì¤€ë¹„ Screen ====================
    
    // Start game
    function startGame() {
      if (gameData.length === 0) return;
      
      document.getElementById('setupPanel').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'none';
      document.getElementById('flashcardGame').style.display = 'flex';
      
      currentCardIndex = 0;
      timerRunning = false;
      renderCard();
    }
    
    // Render current card
    function renderCard() {
      const card = gameData[currentCardIndex];
      
      // Determine what to show based on type
      const isQuestion = card.type === 'question';
      const promptToShow = isQuestion ? (card.promptKorean || card.prompt) : card.prompt;
      const englishToShow = isQuestion ? (card.promptEnglish || '') : (card.promptKorean || '');
      
      // Set question/prompt text (hidden initially)
      document.getElementById('fcQuestion').textContent = promptToShow;
      document.getElementById('fcQuestionBlur').classList.remove('revealed');
      
      // Set English text (hidden initially)
      document.getElementById('fcEnglish').textContent = englishToShow || 'Translation not available';
      document.getElementById('fcEnglishBlur').classList.remove('revealed');
      
      // Set keywords from the PROMPT (not answers)
      let keywords = card.promptKeywords || [];
      const keywordsHtml = keywords.map(k => 
        '(' + escapeHtml(k.word) + ', ' + escapeHtml(k.definition) + ')'
      ).join(' ');
      document.getElementById('fcKeywords').innerHTML = keywordsHtml || '';
      
      // Set back prompt reminder (always visible on back)
      const typeLabels = { question: 'Question', situational: 'Situational', statement: 'Statement' };
      const typeBadge = document.getElementById('backPromptType');
      typeBadge.textContent = typeLabels[card.type] || 'Prompt';
      typeBadge.className = 'prompt-type-badge ' + (card.type || '');
      
      document.getElementById('backPromptText').textContent = promptToShow;
      document.getElementById('backPromptEnglish').textContent = englishToShow || '';
      
      // Render answers in connected horizontal rows
      const tableHtml = card.answers.map((a, i) => {
        const beginnerKorean = a.beginnerKorean || a.korean;
        const beginnerEnglish = a.beginnerEnglish || a.english;
        
        // Split Korean into clickable words - beginner
        const beginnerWords = beginnerKorean.split(' ').map((word, wi) => 
          '<span class="korean-word hidden-word" data-word="' + escapeAttr(word) + '" onclick="event.stopPropagation(); revealWord(this)">[___]</span>'
        ).join(' ');
        
        // Split Korean into clickable words - advanced
        const advancedWords = a.korean.split(' ').map((word, wi) => 
          '<span class="korean-word hidden-word" data-word="' + escapeAttr(word) + '" onclick="event.stopPropagation(); revealWord(this)">[___]</span>'
        ).join(' ');
        
        return '<div class="answer-row" data-row="' + i + '">' +
          '<div class="answer-cell beginner" data-index="b' + i + '" data-state="hidden" onclick="event.stopPropagation(); revealAnswerEnglish(\\'b' + i + '\\')">' +
            '<div class="answer-english hidden-text">' + escapeHtml(beginnerEnglish || '') + '</div>' +
            '<div class="answer-korean">' + beginnerWords + '</div>' +
            '<div class="answer-actions">' +
              '<button class="check-answer-btn" data-korean="' + escapeAttr(beginnerKorean) + '" data-english="' + escapeAttr(beginnerEnglish || '') + '" data-idx="' + i + '" onclick="event.stopPropagation(); checkAnswerViaWebhook(this.dataset.korean, this.dataset.idx, this, this.dataset.english)">âœ… Check</button>' +
              '<span class="points-badge">+10 pts</span>' +
            '</div>' +
          '</div>' +
          '<div class="answer-cell advanced" data-index="a' + i + '" data-state="hidden" onclick="event.stopPropagation(); revealAnswerEnglish(\\'a' + i + '\\')">' +
            '<div class="answer-english hidden-text">' + escapeHtml(a.english || '') + '</div>' +
            '<div class="answer-korean">' + advancedWords + '</div>' +
            '<div style="font-size: 10px; color: #666; margin-top: 5px;"><span class="color-indicator ' + a.color + '"></span>' + getColorLabel(a.color) + '</div>' +
            '<div class="answer-actions">' +
              '<button class="check-answer-btn" data-korean="' + escapeAttr(a.korean) + '" data-english="' + escapeAttr(a.english || '') + '" data-idx="' + i + '" onclick="event.stopPropagation(); checkAdvancedAnswerViaWebhook(this.dataset.korean, this.dataset.idx, this, this.dataset.english)">âœ… Check</button>' +
              '<span class="points-badge">+10 pts</span>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
      document.getElementById('fcAnswersTable').innerHTML = tableHtml;
      
      // Update counter
      document.getElementById('currentCard').textContent = currentCardIndex + 1;
      document.getElementById('totalCards').textContent = gameData.length;
      
      // Reset flip
      document.getElementById('flashcard').classList.remove('flipped');
    }
    
    function getColorLabel(color) {
      const labels = { green: 'ðŸŸ¢ Most Acceptable', blue: 'ðŸ”µ Acceptable', yellow: 'ðŸŸ¡ Context Needed', red: 'ðŸ”´ Very Specific' };
      return labels[color] || '';
    }
    
    // Reveal ALL Korean words on the card (when clicking card background)
    function revealAllKorean(event) {
      // Only trigger if clicking the card background, not a specific element
      // Check if clicking on a non-interactive area of the card back
      // Don't trigger if clicking on buttons, answer cells, or korean words
      const clickedEl = event.target;
      const isInteractive = clickedEl.closest('.answer-cell') || 
                           clickedEl.closest('.korean-word') ||
                           clickedEl.closest('button') ||
                           clickedEl.closest('.audio-btn') ||
                           clickedEl.closest('.reveal-all-btn') ||
                           clickedEl.closest('.check-answer-btn');
      
      if (!isInteractive) {
        // Flip the card back to front when clicking background
        flipCard();
      }
    }
    
    // Reveal ALL Korean - called by button or card click
    function revealAllKoreanBtn() {
      const allWords = document.querySelectorAll('.flashcard-back .korean-word.hidden-word');
      allWords.forEach(el => {
        const word = el.getAttribute('data-word');
        el.textContent = word;
        el.classList.remove('hidden-word');
        el.style.cursor = 'default';
        el.onclick = null;
      });
      // Also reveal all English
      const allEnglish = document.querySelectorAll('.flashcard-back .answer-english.hidden-text');
      allEnglish.forEach(el => el.classList.remove('hidden-text'));
    }
    
    // Reveal individual Korean word
    function revealWord(el) {
      if (event) event.stopPropagation();
      const word = el.getAttribute('data-word');
      el.textContent = word;
      el.classList.remove('hidden-word');
      el.style.cursor = 'default';
      el.onclick = null;
    }
    
    // Reveal answer English first, then Korean words become clickable
    function revealAnswerEnglish(index) {
      const answer = document.querySelector('[data-index="' + index + '"]');
      if (!answer) return;
      
      const state = answer.getAttribute('data-state');
      const englishEl = answer.querySelector('.answer-english');
      
      if (state === 'hidden') {
        // First click - reveal English
        englishEl.classList.remove('hidden-text');
        answer.setAttribute('data-state', 'english-shown');
      }
    }
    
    function revealAnswerKorean(index) {
      // This function is now deprecated - Korean is revealed word-by-word
      const answer = document.querySelector('[data-index="' + index + '"]');
      if (!answer) return;
      
      // Reveal all words at once
      const words = answer.querySelectorAll('.korean-word.hidden-word');
      words.forEach(w => {
        w.textContent = w.getAttribute('data-word');
        w.classList.remove('hidden-word');
      });
      answer.setAttribute('data-state', 'fully-shown');
    }
    
    // Play audio for a specific answer
    async function playAnswerAudio(index) {
      const card = gameData[currentCardIndex];
      if (!card || !card.answers[index]) return;
      
      const text = card.answers[index].korean;
      await playKoreanAudio(text);
    }
    
    // Generic Korean audio player
    async function playKoreanAudio(text) {
      if (!text) {
        showToast('âŒ No text to play');
        return;
      }
      
      // Stop any currently playing audio
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      
      try {
        const response = await fetch(TTS_PROXY_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            text: text
          })
        });
        
        if (!response.ok) throw new Error('Audio failed');
        
        const audioBlob = await response.blob();
        currentAudio = new Audio(URL.createObjectURL(audioBlob));
        await currentAudio.play();
      } catch (err) {
        console.error('Audio error:', err);
        showToast('âŒ Audio error');
      }
    }
    
    // Legacy function
    function revealAnswer(index) {
      revealAnswerEnglish(index);
    }
    
    // Card actions
    function flipCard() {
      document.getElementById('flashcard').classList.toggle('flipped');
    }
    
    function revealKorean() {
      document.getElementById('fcQuestionBlur').classList.add('revealed');
    }
    
    function revealEnglish() {
      document.getElementById('fcEnglishBlur').classList.add('revealed');
    }
    
    function revealAnswer(index) {
      const answers = document.querySelectorAll('#fcAnswers .back-answer');
      if (answers[index]) {
        answers[index].classList.remove('hidden-answer');
      }
    }
    
    // ElevenLabs Audio Playback
    async function playQuestionAudio() {
      const card = gameData[currentCardIndex];
      if (!card) return;
      
      // Get the Korean text to speak - handle both old and new data structures
      const textToSpeak = card.promptKorean || card.prompt || card.question || card.questionKorean;
      if (!textToSpeak) {
        showToast('âŒ No Korean text to play');
        return;
      }
      
      const audioBtn = document.getElementById('audioBtn');
      audioBtn.disabled = true;
      audioBtn.textContent = 'â³ Loading...';
      audioBtn.classList.add('playing');
      
      // Stop any currently playing audio
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      
      try {
        const response = await fetch(TTS_PROXY_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            text: textToSpeak
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('ElevenLabs error:', errorText);
          throw new Error('Audio generation failed: ' + response.status);
        }
        
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        currentAudio = new Audio(audioUrl);
        currentAudio.onended = () => {
          audioBtn.textContent = 'ðŸ”Š Play Audio';
          audioBtn.classList.remove('playing');
          audioBtn.disabled = false;
        };
        currentAudio.onerror = () => {
          audioBtn.textContent = 'ðŸ”Š Play Audio';
          audioBtn.classList.remove('playing');
          audioBtn.disabled = false;
          showToast('âŒ Audio playback error');
        };
        
        audioBtn.textContent = 'ðŸ”Š Playing...';
        await currentAudio.play();
        
      } catch (err) {
        console.error('Audio error:', err);
        audioBtn.textContent = 'ðŸ”Š Play Audio';
        audioBtn.classList.remove('playing');
        audioBtn.disabled = false;
        showToast('âŒ Audio error: ' + err.message);
      }
    }
    
    function prevCard() {
      if (currentCardIndex > 0) {
        currentCardIndex--;
        renderCard();
      }
    }
    
    function nextCard() {
      if (currentCardIndex < gameData.length - 1) {
        currentCardIndex++;
        renderCard();
      }
    }
    
    function exitGame() {
      document.getElementById('flashcardGame').style.display = 'none';
      document.getElementById('spacebarTimer').style.display = 'none';
      document.getElementById('setupPanel').style.display = 'block';
      document.getElementById('resultsSection').style.display = 'block';
      stopTimer();
    }
    
    // Spacebar Timer - 40s â†’ 30s â†’ 20s cycle
    function handleSpacebarTimer() {
      const timerEl = document.getElementById('spacebarTimer');
      
      if (!timerRunning) {
        // First press - start at 40 seconds
        timerSeconds = 40;
        timerRunning = true;
        timerEl.style.display = 'block';
        updateTimerDisplay();
        startTimerCountdown();
      } else {
        // Subsequent presses - decrease time
        if (timerSeconds > 30) {
          timerSeconds = 30;
        } else if (timerSeconds > 20) {
          timerSeconds = 20;
        } else if (timerSeconds > 10) {
          timerSeconds = 10;
        }
        updateTimerDisplay();
      }
    }
    
    function startTimerCountdown() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerDisplay();
        
        // Update visual warning
        const timerEl = document.getElementById('spacebarTimer');
        timerEl.classList.remove('warning', 'danger');
        if (timerSeconds <= 5) {
          timerEl.classList.add('danger');
        } else if (timerSeconds <= 10) {
          timerEl.classList.add('warning');
        }
        
        if (timerSeconds <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          timerRunning = false;
          // Play a beep or flash
          timerEl.style.display = 'none';
        }
      }, 1000);
    }
    
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerRunning = false;
      document.getElementById('spacebarTimer').style.display = 'none';
    }
    
    function updateTimerDisplay() {
      const s = timerSeconds;
      document.getElementById('timerDisplay').textContent = '0:' + (s < 10 ? '0' : '') + s;
    }
    
    // Edit card
    function editCard() {
      editCardAt(currentCardIndex);
    }
    
    function editCardAt(index) {
      const card = gameData[index];
      currentCardIndex = index;
      
      // Handle both Level 1-3 (question/questionEnglish) and Level 4 (prompt/promptKorean/promptEnglish) structures
      // Use explicit checks for undefined/null/empty to avoid "undefined" string issues
      let koreanText = '';
      let englishText = '';
      let labelText = 'Question (Korean)';
      
      // For Level 4 (has type property), prioritize prompt fields
      if (card.type !== undefined) {
        // Level 4: For questions, use promptKorean; for situational/statement, promptKorean is the Korean translation
        if (card.type === 'question') {
          koreanText = card.promptKorean || card.prompt || '';
          labelText = 'Question (Korean)';
        } else {
          // For situational/statement, the Korean is in promptKorean
          koreanText = card.promptKorean || '';
          labelText = 'Korean Translation of Prompt';
        }
        englishText = card.promptEnglish || '';
      } else {
        // Level 1-3: use question/questionEnglish
        koreanText = card.question || '';
        englishText = card.questionEnglish || '';
        labelText = 'Question (Korean)';
      }
      
      document.getElementById('editQuestion').value = koreanText;
      document.getElementById('editQuestionEng').value = englishText;
      document.getElementById('editQuestionLabel').textContent = labelText;
      
      // For Level 4, also handle the prompt type and tier
      if (card.type !== undefined || card.tier !== undefined) {
        document.getElementById('editTypeSection').style.display = 'block';
        document.getElementById('editType').value = card.type || 'question';
        document.getElementById('editTier').value = card.tier || 1;
        // If it's a situational or statement, show the original prompt too (the English scenario)
        if ((card.type === 'situational' || card.type === 'statement') && card.prompt) {
          document.getElementById('editPromptSection').style.display = 'block';
          document.getElementById('editPrompt').value = card.prompt || '';
        } else {
          document.getElementById('editPromptSection').style.display = 'none';
        }
      } else {
        document.getElementById('editTypeSection').style.display = 'none';
        document.getElementById('editPromptSection').style.display = 'none';
      }
      
      renderEditAnswers();
      document.getElementById('editModal').style.display = 'flex';
    }
    
    function renderEditAnswers() {
      const card = gameData[currentCardIndex];
      const container = document.getElementById('editAnswersContainer');
      const isLevel4 = card.type !== undefined || card.prompt !== undefined;
      
      container.innerHTML = card.answers.map((a, i) => {
        let html = '<div class="edit-answer">' +
          '<div class="edit-answer-header">' +
            '<span style="color: #888; font-size: 12px;">Answer ' + (i+1) + '</span>' +
            '<button class="btn btn-sm btn-danger" onclick="removeEditAnswer(' + i + ')">âœ•</button>' +
          '</div>' +
          '<div class="form-group">' +
            '<label style="font-size: 11px; color: #00ffff;">Korean</label>' +
            '<input type="text" id="editAnsK' + i + '" value="' + escapeAttr(a.korean) + '" placeholder="Korean">' +
          '</div>' +
          '<div class="form-group">' +
            '<label style="font-size: 11px; color: #888;">English</label>' +
            '<input type="text" id="editAnsE' + i + '" value="' + escapeAttr(a.english || '') + '" placeholder="English">' +
          '</div>';
        
        // Add beginner Korean/English fields for Level 4
        if (isLevel4 && (a.beginnerKorean !== undefined || card.answers.some(ans => ans.beginnerKorean))) {
          html += '<div class="form-group" style="background: rgba(136,255,136,0.1); padding: 8px; border-radius: 5px; margin-top: 5px;">' +
            '<label style="font-size: 11px; color: #88ff88;">Beginner Korean (Simplified)</label>' +
            '<input type="text" id="editAnsBK' + i + '" value="' + escapeAttr(a.beginnerKorean || '') + '" placeholder="Simplified Korean version">' +
          '</div>' +
          '<div class="form-group">' +
            '<label style="font-size: 11px; color: #88ff88;">Beginner English</label>' +
            '<input type="text" id="editAnsBE' + i + '" value="' + escapeAttr(a.beginnerEnglish || '') + '" placeholder="Beginner English translation">' +
          '</div>';
        }
        
        html += '<div class="color-picker">' +
            '<div class="color-opt green ' + (a.color === 'green' ? 'selected' : '') + '" onclick="setEditColor(' + i + ', \\'green\\')">ðŸŸ¢</div>' +
            '<div class="color-opt blue ' + (a.color === 'blue' ? 'selected' : '') + '" onclick="setEditColor(' + i + ', \\'blue\\')">ðŸ”µ</div>' +
            '<div class="color-opt yellow ' + (a.color === 'yellow' ? 'selected' : '') + '" onclick="setEditColor(' + i + ', \\'yellow\\')">ðŸŸ¡</div>' +
            '<div class="color-opt red ' + (a.color === 'red' ? 'selected' : '') + '" onclick="setEditColor(' + i + ', \\'red\\')">ðŸ”´</div>' +
          '</div>' +
        '</div>';
        
        return html;
      }).join('');
    }
    
    function updateEditPromptVisibility() {
      const type = document.getElementById('editType').value;
      const promptSection = document.getElementById('editPromptSection');
      if (type === 'situational' || type === 'statement') {
        promptSection.style.display = 'block';
      } else {
        promptSection.style.display = 'none';
      }
    }
    
    function setEditColor(answerIndex, color) {
      gameData[currentCardIndex].answers[answerIndex].color = color;
      renderEditAnswers();
    }
    
    function removeEditAnswer(index) {
      gameData[currentCardIndex].answers.splice(index, 1);
      renderEditAnswers();
    }
    
    function addEditAnswer() {
      gameData[currentCardIndex].answers.push({ korean: '', english: '', color: 'blue' });
      renderEditAnswers();
    }
    
    function closeEdit() {
      document.getElementById('editModal').style.display = 'none';
    }
    
    function saveEdit() {
      const card = gameData[currentCardIndex];
      const newKorean = document.getElementById('editQuestion').value;
      const newEnglish = document.getElementById('editQuestionEng').value;
      
      // Handle both Level 1-3 and Level 4 structures
      if (card.question !== undefined) {
        // Level 1-3 structure
        card.question = newKorean;
        card.questionEnglish = newEnglish;
      } else {
        // Level 4 structure
        card.promptKorean = newKorean;
        card.promptEnglish = newEnglish;
        
        // Update type and tier if applicable
        const typeSection = document.getElementById('editTypeSection');
        if (typeSection && typeSection.style.display !== 'none') {
          card.type = document.getElementById('editType').value;
          card.tier = parseInt(document.getElementById('editTier').value) || 1;
        }
        
        // Update main prompt based on type
        const promptSection = document.getElementById('editPromptSection');
        if (promptSection && promptSection.style.display !== 'none') {
          card.prompt = document.getElementById('editPrompt').value;
        } else if (card.type === 'question') {
          card.prompt = newKorean;
        }
      }
      
      // Collect answers
      const newAnswers = [];
      let i = 0;
      while (document.getElementById('editAnsK' + i)) {
        const answerObj = {
          korean: document.getElementById('editAnsK' + i).value,
          english: document.getElementById('editAnsE' + i).value,
          color: card.answers[i]?.color || 'blue'
        };
        
        // Preserve beginner versions if they exist (Level 4)
        if (card.answers[i]?.beginnerKorean) {
          answerObj.beginnerKorean = document.getElementById('editAnsBK' + i)?.value || card.answers[i].beginnerKorean;
          answerObj.beginnerEnglish = document.getElementById('editAnsBE' + i)?.value || card.answers[i].beginnerEnglish;
        }
        
        // Preserve vocabulary if it exists
        if (card.answers[i]?.vocabulary) {
          answerObj.vocabulary = card.answers[i].vocabulary;
        }
        
        newAnswers.push(answerObj);
        i++;
      }
      card.answers = newAnswers;
      
      closeEdit();
      showResults();
      
      // If in game mode, re-render
      if (document.getElementById('flashcardGame').style.display !== 'none') {
        renderCard();
      }
      
      showToast('âœ… Saved!');
    }
    
    // Edit All Cards - Bulk editor
    let editAllCurrentIndex = 0;
    
    function editAllCards() {
      if (!gameData || gameData.length === 0) {
        showToast('âŒ No cards to edit');
        return;
      }
      
      editAllCurrentIndex = 0;
      renderEditAllModal();
      document.getElementById('editAllModal').style.display = 'flex';
    }
    
    function renderEditAllModal() {
      const card = gameData[editAllCurrentIndex];
      const total = gameData.length;
      const isLevel4 = card.type !== undefined || card.prompt !== undefined;
      
      // Get the correct question/prompt values based on card type
      let koreanText = '';
      let englishText = '';
      let promptText = '';
      
      // For Level 4 (has type property), prioritize prompt fields
      if (card.type !== undefined) {
        // Level 4: For questions, use promptKorean; for situational/statement, promptKorean is the Korean translation
        if (card.type === 'question') {
          koreanText = card.promptKorean || card.prompt || '';
        } else {
          // For situational/statement, the Korean is in promptKorean, the English scenario is in prompt
          koreanText = card.promptKorean || '';
          promptText = card.prompt || '';
        }
        englishText = card.promptEnglish || '';
      } else {
        // Level 1-3: use question/questionEnglish
        koreanText = card.question || '';
        englishText = card.questionEnglish || '';
      }
      
      const typeIcon = card.type === 'question' ? 'â“' : card.type === 'situational' ? 'ðŸ“' : card.type === 'statement' ? 'ðŸ’¬' : 'ðŸ“';
      const tierBadge = card.tier === 2 ? '<span style="background: #ff00ff; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px;">T2</span>' : card.tier === 1 ? '<span style="background: #39ff14; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px;">T1</span>' : '';
      
      let html = '<div class="edit-all-header">' +
        '<div style="display: flex; align-items: center; gap: 10px;">' +
          '<span style="font-size: 24px;">' + typeIcon + '</span>' +
          '<span style="color: #00ffff; font-weight: bold;">Card ' + (editAllCurrentIndex + 1) + ' of ' + total + '</span>' +
          tierBadge +
        '</div>' +
        '<div style="display: flex; gap: 5px;">' +
          '<button class="btn btn-sm btn-secondary" onclick="editAllPrev()" ' + (editAllCurrentIndex === 0 ? 'disabled' : '') + '>â† Prev</button>' +
          '<button class="btn btn-sm btn-secondary" onclick="editAllNext()" ' + (editAllCurrentIndex === total - 1 ? 'disabled' : '') + '>Next â†’</button>' +
        '</div>' +
      '</div>';
      
      // Type/Tier selectors for Level 4
      if (isLevel4) {
        html += '<div style="display: flex; gap: 15px; margin-bottom: 15px; padding: 10px; background: rgba(255,0,255,0.1); border-radius: 8px;">' +
          '<div style="flex: 1;">' +
            '<label style="font-size: 11px; color: #888;">Type</label>' +
            '<select id="editAllType" onchange="updateEditAllPromptVisibility()" style="width: 100%; padding: 8px;">' +
              '<option value="question" ' + (card.type === 'question' ? 'selected' : '') + '>â“ Question</option>' +
              '<option value="situational" ' + (card.type === 'situational' ? 'selected' : '') + '>ðŸ“ Situational</option>' +
              '<option value="statement" ' + (card.type === 'statement' ? 'selected' : '') + '>ðŸ’¬ Statement</option>' +
            '</select>' +
          '</div>' +
          '<div style="flex: 1;">' +
            '<label style="font-size: 11px; color: #888;">Tier</label>' +
            '<select id="editAllTier" style="width: 100%; padding: 8px;">' +
              '<option value="1" ' + (card.tier === 1 ? 'selected' : '') + '>T1 - Simple</option>' +
              '<option value="2" ' + (card.tier === 2 ? 'selected' : '') + '>T2 - Complex</option>' +
            '</select>' +
          '</div>' +
        '</div>';
        
        // Prompt field for situational/statement
        const showPrompt = (card.type === 'situational' || card.type === 'statement');
        html += '<div id="editAllPromptSection" style="display: ' + (showPrompt ? 'block' : 'none') + '; margin-bottom: 15px;">' +
          '<label style="font-size: 12px; color: #ff9800;">Prompt/Scenario (English)</label>' +
          '<textarea id="editAllPrompt" rows="2" style="width: 100%;">' + escapeHtml(promptText) + '</textarea>' +
        '</div>';
      }
      
      // Korean question/prompt
      html += '<div style="margin-bottom: 15px;">' +
        '<label style="font-size: 12px; color: #00ffff;">Question/Prompt (Korean)</label>' +
        '<input type="text" id="editAllKorean" value="' + escapeAttr(koreanText) + '" style="width: 100%; padding: 12px; font-size: 16px;">' +
      '</div>';
      
      // English translation
      html += '<div style="margin-bottom: 20px;">' +
        '<label style="font-size: 12px; color: #888;">English Translation</label>' +
        '<input type="text" id="editAllEnglish" value="' + escapeAttr(englishText) + '" style="width: 100%;">' +
      '</div>';
      
      // Answers section
      html += '<div style="border-top: 1px solid #333; padding-top: 15px;">' +
        '<label style="font-size: 13px; color: #39ff14; margin-bottom: 10px; display: block;">Answers (' + card.answers.length + ')</label>' +
        '<div style="max-height: 200px; overflow-y: auto;">';
      
      card.answers.forEach((a, i) => {
        const colorClass = a.color || 'blue';
        html += '<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px; border-left: 3px solid ' + getColorHex(colorClass) + ';">' +
          '<div style="flex: 1;">' +
            '<input type="text" id="editAllAnsK' + i + '" value="' + escapeAttr(a.korean) + '" placeholder="Korean" style="width: 100%; margin-bottom: 4px; font-size: 13px;">' +
            '<input type="text" id="editAllAnsE' + i + '" value="' + escapeAttr(a.english || '') + '" placeholder="English" style="width: 100%; font-size: 12px;">' +
          '</div>' +
          '<div class="color-picker" style="display: flex; flex-direction: column; gap: 2px;">' +
            '<div class="color-opt green ' + (colorClass === 'green' ? 'selected' : '') + '" onclick="setEditAllColor(' + i + ', \\'green\\')" style="width: 20px; height: 20px; font-size: 12px;">ðŸŸ¢</div>' +
            '<div class="color-opt blue ' + (colorClass === 'blue' ? 'selected' : '') + '" onclick="setEditAllColor(' + i + ', \\'blue\\')" style="width: 20px; height: 20px; font-size: 12px;">ðŸ”µ</div>' +
          '</div>' +
        '</div>';
      });
      
      html += '</div></div>';
      
      // Navigation info
      html += '<div style="margin-top: 15px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 5px; font-size: 11px; color: #888; text-align: center;">' +
        'Use â† â†’ buttons or save & continue to review all cards. Changes are saved when you click Save.' +
      '</div>';
      
      document.getElementById('editAllContent').innerHTML = html;
    }
    
    function getColorHex(color) {
      const colors = { green: '#39ff14', blue: '#00aaff', yellow: '#ffcc00', red: '#ff6666' };
      return colors[color] || '#00aaff';
    }
    
    function updateEditAllPromptVisibility() {
      const type = document.getElementById('editAllType')?.value;
      const section = document.getElementById('editAllPromptSection');
      if (section) {
        section.style.display = (type === 'situational' || type === 'statement') ? 'block' : 'none';
      }
    }
    
    function setEditAllColor(answerIndex, color) {
      gameData[editAllCurrentIndex].answers[answerIndex].color = color;
      renderEditAllModal();
    }
    
    function saveEditAllCurrent() {
      const card = gameData[editAllCurrentIndex];
      const newKorean = document.getElementById('editAllKorean').value;
      const newEnglish = document.getElementById('editAllEnglish').value;
      
      // Handle both Level 1-3 and Level 4 structures
      if (card.question !== undefined) {
        card.question = newKorean;
        card.questionEnglish = newEnglish;
      } else {
        card.promptKorean = newKorean;
        card.promptEnglish = newEnglish;
        
        const typeEl = document.getElementById('editAllType');
        const tierEl = document.getElementById('editAllTier');
        if (typeEl) card.type = typeEl.value;
        if (tierEl) card.tier = parseInt(tierEl.value) || 1;
        
        const promptEl = document.getElementById('editAllPrompt');
        if (promptEl && (card.type === 'situational' || card.type === 'statement')) {
          card.prompt = promptEl.value;
        } else if (card.type === 'question') {
          card.prompt = newKorean;
        }
      }
      
      // Save answers
      card.answers.forEach((a, i) => {
        const kEl = document.getElementById('editAllAnsK' + i);
        const eEl = document.getElementById('editAllAnsE' + i);
        if (kEl) a.korean = kEl.value;
        if (eEl) a.english = eEl.value;
      });
    }
    
    function editAllPrev() {
      saveEditAllCurrent();
      if (editAllCurrentIndex > 0) {
        editAllCurrentIndex--;
        renderEditAllModal();
      }
    }
    
    function editAllNext() {
      saveEditAllCurrent();
      if (editAllCurrentIndex < gameData.length - 1) {
        editAllCurrentIndex++;
        renderEditAllModal();
      }
    }
    
    function closeEditAll() {
      document.getElementById('editAllModal').style.display = 'none';
    }
    
    function saveAndCloseEditAll() {
      saveEditAllCurrent();
      closeEditAll();
      showResults();
      showToast('âœ… All changes saved!');
    }
    
    // Helpers
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    
    function escapeAttr(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
    
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      const active = document.activeElement;
      const isTyping = active.tagName === 'INPUT' || active.tagName === 'TEXTAREA';
      
      // Enter for single-line inputs, Ctrl+Enter for textarea
      if (e.key === 'Enter' && !e.shiftKey) {
        if (active.id === 'sentenceKorean') {
          e.preventDefault();
          addSentence();
        }
        // For answerKorean textarea, use Ctrl+Enter
        if (active.id === 'answerKorean' && e.ctrlKey) {
          e.preventDefault();
          addAnswers();
        }
      }
      
      // Arrow keys and spacebar for carousel - only when NOT typing
      if (document.getElementById('flashcardGame').style.display !== 'none' && !isTyping) {
        if (e.key === 'ArrowLeft') prevCard();
        if (e.key === 'ArrowRight') nextCard();
        if (e.key === ' ') { 
          e.preventDefault(); 
          handleSpacebarTimer(); // Spacebar now controls timer
        }
      }
    });
  <\/script>
</body>
</html>
`;
        }
        // ==================== END PERMUTATION GAME ====================

        function addMaterialBlock(type) {
            document.getElementById('editingMaterialId').value = '';
            document.getElementById('editingMaterialType').value = type;
            document.getElementById('materialModalTitle').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const form = document.getElementById('materialFormContainer');

            if (type === 'text') {
                form.innerHTML = `
                    <div class="form-group">
                        <label>Content</label>
                        <div class="rich-text-toolbar">
                            <button type="button" onclick="execRichCmd('bold')" title="Bold"><b>B</b></button>
                            <button type="button" onclick="execRichCmd('italic')" title="Italic"><i>I</i></button>
                            <button type="button" onclick="execRichCmd('underline')" title="Underline"><u>U</u></button>
                            <div class="toolbar-divider"></div>
                            <input type="color" id="textColorPicker" value="#ffffff" onchange="execRichCmd('foreColor', this.value)" title="Text Color">
                            <input type="color" id="bgColorPicker" value="#000000" onchange="execRichCmd('hiliteColor', this.value)" title="Highlight Color">
                            <div class="toolbar-divider"></div>
                            <button type="button" onclick="execRichCmd('insertUnorderedList')" title="Bullet List">â€¢ List</button>
                            <button type="button" onclick="execRichCmd('insertOrderedList')" title="Numbered List">1. List</button>
                            <div class="toolbar-divider"></div>
                            <button type="button" onclick="execRichCmd('fontSize', '3')" title="Normal Size">A</button>
                            <button type="button" onclick="execRichCmd('fontSize', '5')" title="Large Size" style="font-size: 16px;">A</button>
                            <div class="toolbar-divider"></div>
                            <button type="button" onclick="triggerEditorFileUpload('image')" title="Insert Image">ðŸ–¼ï¸</button>
                            <button type="button" onclick="triggerEditorFileUpload('audio')" title="Insert Audio">ðŸ”Š</button>
                            <button type="button" onclick="triggerEditorFileUpload('file')" title="Insert File">ðŸ“Ž</button>
                            <div class="toolbar-divider"></div>
                            <button type="button" onclick="execRichCmd('removeFormat')" title="Clear Formatting">âœ•</button>
                        </div>
                        <div id="richTextEditor" class="rich-text-editor" contenteditable="true" 
                            ondragover="handleEditorDragOver(event)" 
                            ondrop="handleEditorDrop(event)"
                            ondragleave="handleEditorDragLeave(event)"></div>
                        <input type="file" id="editorFileInput" style="display: none;" onchange="handleEditorFileSelect(event)">
                        <p style="font-size: 11px; color: #888; margin-top: 5px;">ðŸ’¡ Tip: You can drag & drop images directly into the editor</p>
                    </div>
                `;
            }
            else if (type === 'link') form.innerHTML = `
                <div class="form-group"><label>URL</label><input type="url" id="materialUrl" placeholder="https://..."></div>
                <div class="form-group"><label>Title</label><input type="text" id="materialTitle" placeholder="Link title"></div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="materialDrawpad" style="width: 18px; height: 18px;">
                        <span>ðŸŽ¨ Enable Drawpad Mode</span>
                    </label>
                    <p style="font-size: 11px; color: #888; margin-top: 5px;">When enabled, teachers can draw on this link when presenting. Otherwise, it opens as a regular clickable link.</p>
                </div>
            `;
            else if (type === 'image') form.innerHTML = `
                <div class="form-group">
                    <label>Upload Image or Enter URL</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-sm btn-info" onclick="document.getElementById('imageFileInput').click()">ðŸ“¤ Upload Image</button>
                        <span style="color: #888; font-size: 12px; align-self: center;">or paste URL below</span>
                    </div>
                    <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleMaterialFileUpload(event, 'image')">
                    <input type="url" id="materialUrl" placeholder="https://...">
                    <div id="imagePreview" style="margin-top: 10px;"></div>
                </div>
                <div class="form-group"><label>Caption</label><input type="text" id="materialCaption" placeholder="Caption"></div>`;
            else if (type === 'file') form.innerHTML = `
                <div class="form-group">
                    <label>Upload File or Enter URL</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-sm btn-info" onclick="document.getElementById('fileFileInput').click()">ðŸ“¤ Upload File</button>
                        <span style="color: #888; font-size: 12px; align-self: center;">or paste URL below</span>
                    </div>
                    <input type="file" id="fileFileInput" style="display: none;" onchange="handleMaterialFileUpload(event, 'file')">
                    <input type="url" id="materialUrl" placeholder="https://...">
                    <div id="uploadProgress" style="margin-top: 10px;"></div>
                </div>
                <div class="form-group"><label>Display Name</label><input type="text" id="materialFilename" placeholder="document.pdf"></div>`;
            else if (type === 'permutation-game') form.innerHTML = `
                <div class="form-group">
                    <label>Yodafy Game Title</label>
                    <input type="text" id="materialTitle" placeholder="e.g., Level 1 Yodafy Practice" value="ðŸŒŸ Yodafy Game">
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="materialDescription" placeholder="Description of this Yodafy game activity..." style="height: 80px;"></textarea>
                </div>
                <div style="background: rgba(156,39,176,0.2); border: 2px solid #9c27b0; border-radius: 8px; padding: 15px; margin-top: 10px;">
                    <p style="color: #ce93d8; font-size: 13px; margin: 0;">
                        <strong>ðŸŒŸ Yodafy Game</strong><br><br>
                        This interactive game helps students practice Korean sentence variations through 4 levels:<br>
                        â€¢ <strong>Level 1:</strong> Tuesday Reading Class<br>
                        â€¢ <strong>Level 2:</strong> Single word substitutions<br>
                        â€¢ <strong>Level 3:</strong> Multiple word substitutions<br>
                        â€¢ <strong>Level 4:</strong> Situational responses<br><br>
                        <em>Uses AI (GPT) to generate sentences and permutations.</em>
                    </p>
                </div>`;

            // Show/hide Test button based on material type
            const testBtn = document.getElementById('testYodafyBtn');
            if (testBtn) {
                testBtn.style.display = type === 'permutation-game' ? 'inline-block' : 'none';
            }

            document.getElementById('materialModal').classList.add('active');
        }
        
        let currentEditorUploadType = 'image';
        
        function triggerEditorFileUpload(type) {
            currentEditorUploadType = type;
            const input = document.getElementById('editorFileInput');
            if (type === 'image') input.accept = 'image/*';
            else if (type === 'audio') input.accept = 'audio/*';
            else input.accept = '*/*';
            input.click();
        }
        
        async function handleEditorFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            await uploadAndInsertFile(file, currentEditorUploadType);
            event.target.value = '';
        }
        
        function handleEditorDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#39ff14';
            event.currentTarget.style.background = 'rgba(57, 255, 20, 0.1)';
        }
        
        function handleEditorDragLeave(event) {
            event.currentTarget.style.borderColor = '#333';
            event.currentTarget.style.background = '#0a0a15';
        }
        
        async function handleEditorDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#333';
            event.currentTarget.style.background = '#0a0a15';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const type = file.type.startsWith('image/') ? 'image' : 
                             file.type.startsWith('audio/') ? 'audio' : 'file';
                await uploadAndInsertFile(file, type);
            }
        }
        
        async function uploadAndInsertFile(file, type) {
            const editor = document.getElementById('richTextEditor');
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'color: #ffff00; font-size: 14px; padding: 5px;';
            statusDiv.textContent = `Uploading ${file.name}...`;
            editor.appendChild(statusDiv);
            
            try {
                const filename = `materials/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const storageRef = firebase.storage().ref().child(filename);
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                
                statusDiv.remove();
                
                if (type === 'image') {
                    const img = document.createElement('img');
                    img.src = url;
                    img.style.cssText = 'max-width: 100%; border-radius: 4px; margin: 10px 0;';
                    editor.appendChild(img);
                } else if (type === 'audio') {
                    const audio = document.createElement('audio');
                    audio.src = url;
                    audio.controls = true;
                    audio.style.cssText = 'width: 100%; margin: 10px 0;';
                    editor.appendChild(audio);
                } else {
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = file.name;
                    link.textContent = `ðŸ“ ${file.name}`;
                    link.style.cssText = 'color: #00ffff; display: block; margin: 10px 0;';
                    editor.appendChild(link);
                }
                
                editor.appendChild(document.createElement('br'));
                editor.focus();
            } catch (e) {
                statusDiv.textContent = `Error: ${e.message}`;
                statusDiv.style.color = '#ff3366';
                console.error('Upload error:', e);
            }
        }
        
        async function handleMaterialFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const progressDiv = document.getElementById(type === 'image' ? 'imagePreview' : 'uploadProgress');
            progressDiv.innerHTML = `<p style="color: #ffff00; font-size: 12px;">Uploading ${file.name}...</p>`;
            
            try {
                const filename = `materials/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const storageRef = firebase.storage().ref().child(filename);
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                
                document.getElementById('materialUrl').value = url;
                
                if (type === 'image') {
                    progressDiv.innerHTML = `<img src="${url}" style="max-width: 200px; border-radius: 4px; border: 2px solid #39ff14;"><p style="color: #39ff14; font-size: 12px;">âœ“ Image uploaded!</p>`;
                } else {
                    document.getElementById('materialFilename').value = file.name;
                    progressDiv.innerHTML = `<p style="color: #39ff14; font-size: 12px;">âœ“ File uploaded: ${file.name}</p>`;
                }
            } catch (e) {
                progressDiv.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
                console.error('Upload error:', e);
            }
        }
        
        function execRichCmd(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('richTextEditor').focus();
        }

        function closeMaterialModal() { document.getElementById('materialModal').classList.remove('active'); }
        
        function testYodafyFromMaterial() {
            // Open the Yodafy game in test mode
            const title = document.getElementById('materialTitle')?.value || 'ðŸŒŸ Yodafy Game';
            const description = document.getElementById('materialDescription')?.value || '';
            
            // Open the permutation game overlay
            openPermutationGame();
        }

        async function saveMaterial() {
            const type = document.getElementById('editingMaterialType').value;
            const level = document.getElementById('materialLevelSelect').value;
            const week = document.getElementById('materialWeekSelect').value;
            const id = document.getElementById('editingMaterialId').value;

            const data = { type, level, week: parseInt(week) };
            
            // Only set order for new materials, preserve existing order for edits
            if (!id) {
                data.order = Date.now();
            }
            
            if (type === 'text') {
                const editor = document.getElementById('richTextEditor');
                data.content = editor ? editor.innerHTML : '';
            }
            else if (type === 'link') { 
                data.url = document.getElementById('materialUrl').value; 
                data.title = document.getElementById('materialTitle').value;
                data.isDrawpad = document.getElementById('materialDrawpad')?.checked || false;
            }
            else if (type === 'image') { data.url = document.getElementById('materialUrl').value; data.caption = document.getElementById('materialCaption')?.value; }
            else if (type === 'file') { data.url = document.getElementById('materialUrl').value; data.filename = document.getElementById('materialFilename').value; }
            else if (type === 'permutation-game') {
                data.title = document.getElementById('materialTitle')?.value || 'ðŸŒŸ Yodafy Game';
                data.description = document.getElementById('materialDescription')?.value || '';
                data.gameType = 'permutation';
            }

            try {
                if (id) {
                    await db.collection('scheduler_materials').doc(id).update(data);
                } else {
                    await db.collection('scheduler_materials').add(data);
                }
                closeMaterialModal();
                loadMaterialsForLevel();
                alert(`âœ… Material ${id ? 'updated' : 'saved'} successfully!`);
            } catch (e) { showMessage('materialModalMessage', 'Error: ' + e.message, 'error'); }
        }

        async function editMaterial(id) {
            const doc = await db.collection('scheduler_materials').doc(id).get();
            if (!doc.exists) return;
            const m = doc.data();
            addMaterialBlock(m.type);
            // Set the ID AFTER addMaterialBlock (which clears it)
            document.getElementById('editingMaterialId').value = id;
            document.getElementById('materialModalTitle').textContent = `Edit ${m.type.charAt(0).toUpperCase() + m.type.slice(1)}`;
            setTimeout(() => {
                if (m.type === 'text') {
                    const editor = document.getElementById('richTextEditor');
                    if (editor) editor.innerHTML = m.content || '';
                }
                else if (m.type === 'link') { 
                    document.getElementById('materialUrl').value = m.url || ''; 
                    document.getElementById('materialTitle').value = m.title || '';
                    if (document.getElementById('materialDrawpad')) document.getElementById('materialDrawpad').checked = m.isDrawpad || false;
                }
                else if (m.type === 'image') { document.getElementById('materialUrl').value = m.url || ''; if (document.getElementById('materialCaption')) document.getElementById('materialCaption').value = m.caption || ''; }
                else if (m.type === 'file') { document.getElementById('materialUrl').value = m.url || ''; document.getElementById('materialFilename').value = m.filename || ''; }
                else if (m.type === 'permutation-game') {
                    if (document.getElementById('materialTitle')) document.getElementById('materialTitle').value = m.title || 'ðŸŒŸ Yodafy Game';
                    if (document.getElementById('materialDescription')) document.getElementById('materialDescription').value = m.description || '';
                }
            }, 100);
        }

        async function deleteMaterial(id) {
            if (!confirm('Delete this material?')) return;
            await db.collection('scheduler_materials').doc(id).delete();
            loadMaterialsForLevel();
        }

        // Teacher Materials
        async function loadTeacherMaterials() {
            const level = document.getElementById('teacherMaterialLevel').value;
            const week = document.getElementById('teacherMaterialWeek').value;
            try {
                let snap = await db.collection('scheduler_materials').get();
                let materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Filter by level and week
                materials = materials.filter(m => m.level === level && (m.week == week || m.week === parseInt(week)));
                
                materials.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                const container = document.getElementById('teacherMaterialsDisplay');
                
                if (materials.length === 0) { 
                    container.innerHTML = '<p style="color: #888; font-size: 14px; font-family: Noto Sans, sans-serif;">No materials for this selection.</p>'; 
                    return; 
                }
                container.innerHTML = materials.map(m => `
                    <div class="material-block">
                        <div class="material-header">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span class="material-type">${m.type}</span>
                            </div>
                        </div>
                        <div class="material-content">${renderMaterialContent(m, false)}</div>
                    </div>
                `).join('');
            } catch (e) { 
                console.error('Error loading teacher materials:', e);
                document.getElementById('teacherMaterialsDisplay').innerHTML = `<p style="color: #ff3366; font-size: 14px; font-family: Noto Sans, sans-serif;">Error loading materials: ${e.message}</p>`; 
            }
        }
        
        async function showClassMaterial(level, week) {
            try {
                const snap = await db.collection('scheduler_materials').get();
                let materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Filter by level and week, show links and Yodafy games
                materials = materials.filter(m => 
                    m.level === level && 
                    (m.week === week || m.week === parseInt(week)) &&
                    (m.type === 'link' || m.type === 'permutation-game')
                );
                materials.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                const levelName = LEVELS[level] || level; // Fallback to level ID if not found
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'classMaterialModal';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <button class="modal-close" onclick="closeClassMaterialModal()">âœ•</button>
                        <h3 class="modal-title">ðŸ“– ${levelName} - Week ${week} Materials</h3>
                        <p style="font-size: 11px; color: #888; margin-top: 5px;">ðŸ’¡ Click on a link to present with drawing tools, or launch games</p>
                        <div style="margin-top: 15px;">
                            ${materials.length === 0 ? 
                                '<p style="color: #888; font-size: 12px; font-family: Noto Sans, sans-serif; text-align: center; padding: 20px;">No materials available for this level and week.</p>' :
                                materials.map(m => {
                                    const content = renderTeacherMaterialContent(m);
                                    if (!content) return '';
                                    return `
                                        <div class="material-block" style="margin-bottom: 15px;">
                                            <div class="material-content">${content}</div>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add click handlers for images after modal is added
                setTimeout(() => {
                    const modalEl = document.getElementById('classMaterialModal');
                    if (modalEl) {
                        modalEl.querySelectorAll('.clickable-media').forEach(el => {
                            el.onclick = (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                // Get URL from multiple possible sources
                                let url = el.dataset.src || el.src || el.getAttribute('src');
                                let type = el.dataset.type || 'image';
                                
                                // If it's an img element, use src
                                if (el.tagName === 'IMG' && el.src) {
                                    url = el.src;
                                }
                                
                                console.log('Opening presentation:', url, type);
                                if (url) {
                                    openPresentationMode(url, type);
                                } else {
                                    alert('Could not get file URL');
                                }
                            };
                        });
                    }
                }, 100);
            } catch (e) {
                console.error('Error loading class materials:', e);
                alert('Error loading materials: ' + e.message);
            }
        }
        
        // Helper function to get week from dropdown and show material
        // Can accept either a classId (will prepend 'materialWeekSelect_') or a full element ID
        function showClassMaterialFromDropdown(level, idOrClassId) {
            // Check if it's a full element ID (contains 'materialWeekSelect' or 'adminMaterialWeekSelect')
            let selectId = idOrClassId;
            if (!idOrClassId.includes('materialWeekSelect') && !idOrClassId.includes('MaterialWeekSelect')) {
                selectId = 'materialWeekSelect_' + idOrClassId;
            }
            const select = document.getElementById(selectId);
            const week = select ? parseInt(select.value) : 1;
            showClassMaterial(level, week);
        }
        
        function renderTeacherMaterialContent(m) {
            const fontStyle = "font-family: 'Noto Sans', sans-serif; font-size: 12px; line-height: 1.6;";
            
            // Links
            if (m.type === 'link') {
                // Check if drawpad mode is enabled
                if (m.isDrawpad) {
                    // Drawpad mode - click to present with drawing tools
                    return `<div class="clickable-media" data-src="${m.url}" data-type="link" style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer;">
                        <span style="font-size: 24px;">ðŸŽ¨</span>
                        <p style="${fontStyle} color: #00ffff; margin-top: 8px;">${m.title || m.url}</p>
                        <p style="font-size: 11px; color: #888;">Click to present with drawing tools</p>
                    </div>`;
                } else {
                    // Regular link - just opens in new tab
                    return `<div style="background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 15px; text-align: center;">
                        <span style="font-size: 24px;">ðŸ”—</span>
                        <p style="${fontStyle} margin-top: 8px;">
                            <a href="${m.url}" target="_blank" style="color: #ffff00; text-decoration: none;">${m.title || m.url}</a>
                        </p>
                        <p style="font-size: 11px; color: #888;">Click to open in new tab</p>
                    </div>`;
                }
            }
            
            // Yodafy Game
            if (m.type === 'permutation-game') {
                return `<div style="background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(103,58,183,0.2)); border: 2px solid #9c27b0; border-radius: 8px; padding: 15px; text-align: center;">
                    <span style="font-size: 24px;">ðŸ”„</span>
                    <p style="${fontStyle} color: #ce93d8; margin-top: 8px; font-weight: 600;">${m.title || 'Yodafy Game'}</p>
                    ${m.description ? `<p style="font-size: 11px; color: #888; margin: 5px 0;">${m.description}</p>` : ''}
                    <button class="btn btn-sm" style="background: linear-gradient(135deg, #9c27b0, #673ab7); border-color: #9c27b0; color: #fff; margin-top: 10px;" onclick="closeClassMaterialModal(); openPermutationGame();">
                        ðŸŽ® Launch Game
                    </button>
                    <p style="font-size: 10px; color: #888; margin-top: 5px;">Uses AI (GPT)</p>
                </div>`;
            }
            
            return '';
        }
        
        // Presentation Mode Variables
        let presentationCanvas = null;
        let presentationCtx = null;
        let isDrawing = false;
        let currentTool = 'rainbow';
        let brushSize = 5;
        let brushColor = '#ff0000';
        let rainbowHue = 0;
        let lastX = 0;
        let lastY = 0;
        
        function openPresentationMode(src, type = 'image') {
            if (!src) {
                alert('No file URL available');
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'presentation-overlay';
            overlay.id = 'presentationMode';
            
            // Determine content type
            const srcLower = src.toLowerCase();
            const isIframe = type === 'pdf' || type === 'link' || srcLower.includes('.pdf');
            
            // For iframes, we don't put canvas on top (so scrolling works)
            // For images, canvas goes on top for drawing
            
            overlay.innerHTML = `
                <div class="presentation-toolbar">
                    <div class="tool-group">
                        <button id="toolRainbow" class="active" onclick="setDrawTool('rainbow')" title="Rainbow Pen">ðŸŒˆ Draw</button>
                        <button id="toolPen" onclick="setDrawTool('pen')" title="Pen">âœï¸ Pen</button>
                        <button id="toolHighlight" onclick="setDrawTool('highlight')" title="Highlighter">ðŸ–ï¸ Highlight</button>
                        <button id="toolEraser" onclick="setDrawTool('eraser')" title="Eraser">ðŸ§¹ Erase</button>
                    </div>
                    <div class="tool-group">
                        <label style="color: #fff; font-size: 12px;">Size:</label>
                        <input type="range" id="brushSizeSlider" min="2" max="50" value="${brushSize}" oninput="updateBrushSize(this.value)">
                        <span id="brushSizeDisplay" style="color: #fff; font-size: 14px; min-width: 25px;">${brushSize}px</span>
                        <input type="color" id="penColorPicker" value="${brushColor}" oninput="brushColor = this.value" title="Pen Color">
                    </div>
                    <div class="tool-group">
                        <button onclick="clearCanvas()" title="Clear All">ðŸ—‘ï¸ Clear</button>
                        <button onclick="undoCanvas()" title="Undo">â†©ï¸ Undo</button>
                    </div>
                </div>
                <button class="presentation-close" onclick="closePresentationMode()">âœ• Close</button>
                <div class="presentation-content" id="presentationContent">
                    ${isIframe ? `
                        <div style="position: relative; width: 95vw; height: calc(100vh - 80px);">
                            <iframe id="presentationIframe" src="${src}" style="width: 100%; height: 100%; border: none; border-radius: 8px;"></iframe>
                            <canvas id="presentationCanvas" class="presentation-canvas" style="pointer-events: none;"></canvas>
                            <div id="drawingToggle" style="position: absolute; top: 10px; left: 10px; z-index: 100;">
                                <button onclick="toggleDrawingMode()" id="drawModeBtn" style="background: #333; border: 2px solid #00ffff; color: #00ffff; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">âœï¸ Enable Drawing</button>
                            </div>
                        </div>
                    ` : `
                        <div class="presentation-wrapper" id="presentationWrapper">
                            <img id="presentationImage" class="presentation-image" src="${src}" draggable="false" />
                            <canvas id="presentationCanvas" class="presentation-canvas"></canvas>
                        </div>
                    `}
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            
            // Initialize after content loads
            if (isIframe) {
                const iframe = document.getElementById('presentationIframe');
                iframe.onload = () => {
                    initIframeCanvas();
                };
                setTimeout(initIframeCanvas, 1000);
            } else {
                const img = document.getElementById('presentationImage');
                img.onload = () => {
                    initPresentationCanvas();
                };
                img.onerror = () => {
                    document.getElementById('presentationWrapper').innerHTML = `
                        <div style="color: #fff; text-align: center; padding: 50px;">
                            <p style="font-size: 40px;">âŒ</p>
                            <p>Failed to load content</p>
                            <a href="${src}" target="_blank" style="color: #00ffff;">Open in new tab</a>
                        </div>
                    `;
                };
                // If image already loaded (cached)
                if (img.complete && img.naturalWidth > 0) {
                    initPresentationCanvas();
                }
            }
        }
        
        let drawingModeEnabled = false;
        
        function toggleDrawingMode() {
            drawingModeEnabled = !drawingModeEnabled;
            const canvas = document.getElementById('presentationCanvas');
            const btn = document.getElementById('drawModeBtn');
            if (drawingModeEnabled) {
                canvas.style.pointerEvents = 'auto';
                btn.textContent = 'ðŸ–±ï¸ Disable Drawing (Enable Scroll)';
                btn.style.background = '#00ffff';
                btn.style.color = '#000';
            } else {
                canvas.style.pointerEvents = 'none';
                btn.textContent = 'âœï¸ Enable Drawing';
                btn.style.background = '#333';
                btn.style.color = '#00ffff';
            }
        }
        
        function initIframeCanvas() {
            presentationCanvas = document.getElementById('presentationCanvas');
            const iframe = document.getElementById('presentationIframe');
            if (!presentationCanvas || !iframe) return;
            
            presentationCanvas.width = iframe.offsetWidth;
            presentationCanvas.height = iframe.offsetHeight;
            presentationCanvas.style.width = iframe.offsetWidth + 'px';
            presentationCanvas.style.height = iframe.offsetHeight + 'px';
            presentationCanvas.style.top = '0';
            presentationCanvas.style.left = '0';
            
            presentationCtx = presentationCanvas.getContext('2d');
            presentationCtx.lineCap = 'round';
            presentationCtx.lineJoin = 'round';
            
            window.canvasStates = [];
            saveCanvasState();
            
            // Mouse events
            presentationCanvas.addEventListener('mousedown', startDrawing);
            presentationCanvas.addEventListener('mousemove', draw);
            presentationCanvas.addEventListener('mouseup', stopDrawing);
            presentationCanvas.addEventListener('mouseleave', stopDrawing);
            
            // Touch events
            presentationCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            presentationCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            presentationCanvas.addEventListener('touchend', stopDrawing);
        }
        
        function updateBrushSize(value) {
            brushSize = parseInt(value);
            const display = document.getElementById('brushSizeDisplay');
            if (display) display.textContent = brushSize + 'px';
        }
        
        function initPresentationCanvas() {
            presentationCanvas = document.getElementById('presentationCanvas');
            const wrapper = document.getElementById('presentationWrapper');
            const img = document.getElementById('presentationImage');
            
            if (!presentationCanvas || !wrapper || !img) return;
            
            // Wait a tiny bit for image to render
            setTimeout(() => {
                const width = img.offsetWidth;
                const height = img.offsetHeight;
                
                presentationCanvas.width = width;
                presentationCanvas.height = height;
                presentationCanvas.style.width = width + 'px';
                presentationCanvas.style.height = height + 'px';
                
                presentationCtx = presentationCanvas.getContext('2d');
                presentationCtx.lineCap = 'round';
                presentationCtx.lineJoin = 'round';
                
                // Store states for undo
                window.canvasStates = [];
                saveCanvasState();
                
                // Mouse events
                presentationCanvas.addEventListener('mousedown', startDrawing);
                presentationCanvas.addEventListener('mousemove', draw);
                presentationCanvas.addEventListener('mouseup', stopDrawing);
                presentationCanvas.addEventListener('mouseleave', stopDrawing);
                
                // Touch events for tablet
                presentationCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
                presentationCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
                presentationCanvas.addEventListener('touchend', stopDrawing);
                
                // Resize handler
                window.addEventListener('resize', resizeCanvas);
            }, 50);
        }
        
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getPosition(e);
            saveCanvasState();
        }
        
        function draw(e) {
            if (!isDrawing || !presentationCtx) return;
            
            const [x, y] = getPosition(e);
            
            presentationCtx.beginPath();
            presentationCtx.moveTo(lastX, lastY);
            presentationCtx.lineTo(x, y);
            
            if (currentTool === 'rainbow') {
                rainbowHue = (rainbowHue + 2) % 360;
                presentationCtx.strokeStyle = `hsl(${rainbowHue}, 100%, 50%)`;
                presentationCtx.lineWidth = brushSize;
                presentationCtx.globalAlpha = 1;
                presentationCtx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'pen') {
                presentationCtx.strokeStyle = brushColor;
                presentationCtx.lineWidth = brushSize;
                presentationCtx.globalAlpha = 1;
                presentationCtx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'highlight') {
                presentationCtx.strokeStyle = brushColor;
                presentationCtx.lineWidth = brushSize * 3;
                presentationCtx.globalAlpha = 0.3;
                presentationCtx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'eraser') {
                presentationCtx.globalCompositeOperation = 'destination-out';
                presentationCtx.lineWidth = brushSize * 2;
                presentationCtx.globalAlpha = 1;
            }
            
            presentationCtx.stroke();
            [lastX, lastY] = [x, y];
        }
        
        function stopDrawing() {
            isDrawing = false;
            if (presentationCtx) {
                presentationCtx.globalAlpha = 1;
                presentationCtx.globalCompositeOperation = 'source-over';
            }
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            startDrawing(mouseEvent);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            draw(mouseEvent);
        }
        
        function getPosition(e) {
            const rect = presentationCanvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left;
            const y = (e.clientY || e.pageY) - rect.top;
            return [x, y];
        }
        
        function setDrawTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.presentation-toolbar button').forEach(btn => {
                if (btn.id && btn.id.startsWith('tool')) {
                    btn.classList.remove('active');
                }
            });
            const toolBtn = document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1));
            if (toolBtn) toolBtn.classList.add('active');
        }
        
        function saveCanvasState() {
            if (!presentationCanvas) return;
            if (window.canvasStates.length > 20) window.canvasStates.shift();
            window.canvasStates.push(presentationCanvas.toDataURL());
        }
        
        function undoCanvas() {
            if (!window.canvasStates || window.canvasStates.length <= 1) return;
            window.canvasStates.pop();
            const img = new Image();
            img.onload = () => {
                presentationCtx.clearRect(0, 0, presentationCanvas.width, presentationCanvas.height);
                presentationCtx.drawImage(img, 0, 0);
            };
            img.src = window.canvasStates[window.canvasStates.length - 1];
        }
        
        function clearCanvas() {
            if (!presentationCtx || !presentationCanvas) return;
            saveCanvasState();
            presentationCtx.clearRect(0, 0, presentationCanvas.width, presentationCanvas.height);
        }
        
        function resizeCanvas() {
            if (!presentationCanvas) return;
            const wrapper = document.getElementById('presentationWrapper');
            const img = document.getElementById('presentationImage');
            const iframe = document.getElementById('presentationIframe');
            if (!wrapper) return;
            
            let width, height;
            if (img && img.complete && img.naturalWidth > 0) {
                width = img.offsetWidth;
                height = img.offsetHeight;
            } else if (iframe) {
                width = iframe.offsetWidth;
                height = iframe.offsetHeight;
            } else {
                width = wrapper.offsetWidth;
                height = wrapper.offsetHeight;
            }
            
            const imageData = presentationCtx.getImageData(0, 0, presentationCanvas.width, presentationCanvas.height);
            presentationCanvas.width = width;
            presentationCanvas.height = height;
            presentationCanvas.style.width = width + 'px';
            presentationCanvas.style.height = height + 'px';
            presentationCtx.putImageData(imageData, 0, 0);
            presentationCtx.lineCap = 'round';
            presentationCtx.lineJoin = 'round';
        }
        
        function closePresentationMode() {
            const overlay = document.getElementById('presentationMode');
            if (overlay) {
                overlay.remove();
                document.body.style.overflow = '';
                window.removeEventListener('resize', resizeCanvas);
            }
        }
        
        function closeClassMaterialModal() {
            const modal = document.getElementById('classMaterialModal');
            if (modal) modal.remove();
        }

        // Teacher Classes - New design with per-class week tracking
        async function loadTeacherClasses() {
            if (!currentUser) return;
            try {
                const snap = await db.collection('scheduler_classes').where('teacherId', '==', currentUser.odId).get();
                const allClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const activeClasses = allClasses.filter(c => c.status !== 'completed');
                
                // Also load prescheduled slots for this teacher
                const prescheduledSnap = await db.collection('prescheduled_slots').where('teacherId', '==', currentUser.odId).get();
                const prescheduledSlots = prescheduledSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const container = document.getElementById('teacherClassesContainer');
                
                if (activeClasses.length === 0 && prescheduledSlots.length === 0) { 
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No classes assigned.</p>'; 
                    return; 
                }
                
                // Load ALL attendance data for all classes
                const allAttendanceData = {};
                for (const cls of activeClasses) {
                    try {
                        const attendanceSnap = await db.collection('scheduler_attendance')
                            .where('classId', '==', cls.id)
                            .get();
                        
                        allAttendanceData[cls.id] = {};
                        attendanceSnap.docs.forEach(doc => {
                            const data = doc.data();
                            const key = `${data.studentId}_${data.week}`;
                            allAttendanceData[cls.id][key] = data.status;
                        });
                    } catch (err) {
                        console.error('Error loading attendance for class:', cls.id, err);
                        allAttendanceData[cls.id] = {};
                    }
                }
                
                // Helper function to calculate class week dates based on its start date
                function getClassWeekDates(cls, weekNum) {
                    if (!cls.startDate) return null;
                    const startDate = parseESTDate(cls.startDate);
                    const weekStart = new Date(startDate);
                    weekStart.setDate(startDate.getDate() + (weekNum - 1) * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    return { start: weekStart, end: weekEnd };
                }
                
                // Helper function to get current week number for a class (using EST)
                function getClassCurrentWeek(cls) {
                    if (!cls.startDate) return null;
                    const startDate = parseESTDate(cls.startDate);
                    const todayDate = getESTToday();
                    
                    if (todayDate < startDate) return 0; // Not started yet
                    
                    const daysSinceStart = getDaysBetween(todayDate, startDate);
                    const weekNum = Math.floor(daysSinceStart / 7) + 1;
                    return Math.min(weekNum, 7); // Cap at 7 (meaning past week 6)
                }
                
                // Helper function to check if all students have attendance for a week
                function isWeekAttendanceComplete(cls, weekNum) {
                    const students = cls.students || [];
                    if (students.length === 0) return false;
                    
                    const classAttendance = allAttendanceData[cls.id] || {};
                    return students.every(s => {
                        const key = `${s.id}_${weekNum}`;
                        return classAttendance[key] && ['present', 'late', 'absent'].includes(classAttendance[key]);
                    });
                }
                
                // Helper function to format date range
                function formatDateRange(start, end) {
                    const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                    return `${formatDate(start)}-${formatDate(end)}`;
                }
                
                // Helper function to get attendance status
                function getAttendanceStatusForClass(classId, studentId, week) {
                    const classAttendance = allAttendanceData[classId] || {};
                    return classAttendance[`${studentId}_${week}`] || '';
                }
                
                // Render active classes first, then prescheduled
                let html = '';
                
                // Active classes section
                if (activeClasses.length > 0) {
                    html += activeClasses.map(c => renderClassCard(c)).join('');
                }
                
                // Prescheduled section at the bottom
                if (prescheduledSlots.length > 0) {
                    html += '<div style="margin-top: 20px;"><h4 style="color: #ff9800; margin-bottom: 10px;">â³ Upcoming Pre-scheduled Classes</h4>';
                    html += prescheduledSlots.map(ps => renderPrescheduledCard(ps)).join('');
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
                // Populate attendance dropdown
                const select = document.getElementById('attendanceClassSelect');
                if (select) {
                    select.innerHTML = '<option value="">-- Select --</option>' + allClasses.map(c => `<option value="${c.id}">${c.day} ${c.time} - ${LEVELS[c.level]}</option>`).join('');
                }
                
                // Helper function to render a prescheduled card
                function renderPrescheduledCard(ps) {
                    const startDate = parseLocalDate(ps.startDate);
                    const startDateDisplay = ps.startDate ? formatDateInEST(ps.startDate, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const classTypeName = LEVELS[ps.classType] || ps.classType || 'Class';
                    const enrolledStudents = ps.enrolledStudents || [];
                    const linkedCount = enrolledStudents.filter(s => s.odId || s.id).length;
                    
                    // Calculate days until start
                    let daysUntilStart = '';
                    let startingSoon = false;
                    if (startDate) {
                        const now = new Date();
                        const diffTime = startDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysUntilStart = `(in ${diffDays} day${diffDays > 1 ? 's' : ''})`;
                        } else if (diffDays <= 0) {
                            daysUntilStart = '(Starting!)';
                            startingSoon = true;
                        }
                    }
                    
                    return `
                        <div class="class-card" style="border: 2px solid ${startingSoon ? '#39ff14' : '#ff9800'}; background: rgba(${startingSoon ? '57,255,20' : '255,152,0'},0.1);">
                            <div class="class-header">
                                <div>
                                    <div class="class-day" style="color: ${startingSoon ? '#39ff14' : '#ff9800'};">${ps.day}</div>
                                    <div class="class-time">${ps.time} EST</div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="level-badge level-${ps.classType}" style="border-color: ${startingSoon ? '#39ff14' : '#ff9800'};">${classTypeName}</span>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(${startingSoon ? '57,255,20' : '255,152,0'},0.1); border-radius: 8px; margin-top: 10px;">
                                <div style="font-size: 24px; margin-bottom: 5px;">${startingSoon ? 'ðŸš€' : 'â³'}</div>
                                <p style="color: ${startingSoon ? '#39ff14' : '#ff9800'}; font-size: 14px; margin: 0; font-weight: bold;">${startingSoon ? 'Starting!' : 'Pre-scheduled'}</p>
                                <p style="color: #fff; font-size: 13px; margin: 5px 0;">Starts: ${startDateDisplay}</p>
                                <p style="color: #ffff00; font-size: 12px; margin: 0;">${daysUntilStart}</p>
                            </div>
                            ${enrolledStudents.length > 0 ? `
                                <div style="margin-top: 15px;">
                                    <h4 style="color: #00ffff; font-size: 12px; margin-bottom: 8px;">ðŸ‘¥ Enrolled Students (${enrolledStudents.length})</h4>
                                    <div style="display: grid; gap: 6px;">
                                        ${enrolledStudents.map(s => {
                                            const isLinked = s.odId || s.id;
                                            const studentName = s.name || s.linkedName || 'Unknown';
                                            const studentEmail = s.email || s.linkedEmail || '';
                                            const studentDiscord = s.discord || '';
                                            return `
                                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                                    <div>
                                                        <span style="color: ${isLinked ? '#39ff14' : '#ff9800'}; font-size: 11px;">${isLinked ? 'âœ…' : 'âš ï¸'}</span>
                                                        <span style="color: #fff; font-size: 12px; margin-left: 5px;">${studentName}</span>
                                                        ${studentDiscord ? `<span style="color: #7289da; font-size: 10px; margin-left: 8px;">ðŸ’¬ ${studentDiscord}</span>` : ''}
                                                    </div>
                                                    ${studentEmail ? `<span style="color: #888; font-size: 10px;">${studentEmail}</span>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ${linkedCount < enrolledStudents.length ? `<p style="color: #ff9800; font-size: 10px; margin-top: 8px;">âš ï¸ ${enrolledStudents.length - linkedCount} student(s) not linked to accounts</p>` : ''}
                                </div>
                            ` : `
                                <div style="margin-top: 15px; text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                    <p style="color: #888; font-size: 12px; margin: 0;">No students enrolled yet</p>
                                </div>
                            `}
                            ${startingSoon ? `
                                <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: center;">
                                    <p style="color: #888; font-size: 11px; margin: 0;">âš ï¸ This is a pre-scheduled class. Ask your admin to convert it to start taking attendance.</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Helper function to render a class card
                function renderClassCard(c) {
                    const currentWeek = getClassCurrentWeek(c);
                    const startDateDisplay = c.startDate ? formatDateInEST(c.startDate, { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const students = c.students || [];
                    
                    // Check if class starts today or in the future
                    const startDate = c.startDate ? parseLocalDate(c.startDate) : null;
                    const now = new Date();
                    const isUpcoming = startDate && startDate > now;
                    const startsToday = startDate && startDate.toDateString() === now.toDateString();
                    
                    // Build week tracker
                    let weekTrackerHtml = '<div class="class-week-tracker">';
                    for (let w = 1; w <= 6; w++) {
                        const weekDates = getClassWeekDates(c, w);
                        const dateRange = weekDates ? formatDateRange(weekDates.start, weekDates.end) : '';
                        const isCompleted = isWeekAttendanceComplete(c, w) && currentWeek > w;
                        const isCurrent = currentWeek === w;
                        const isFuture = currentWeek < w;
                        
                        let weekClass = 'class-week-box';
                        if (isCompleted) weekClass += ' completed';
                        else if (isCurrent) weekClass += ' current';
                        else if (isFuture) weekClass += ' future';
                        
                        weekTrackerHtml += `
                            <div class="${weekClass}" onclick="showClassMaterial('${c.level}', ${w})" style="cursor: pointer;" title="Click to view Week ${w} materials">
                                <span class="week-label">Week ${w}</span>
                                <span class="week-dates">${dateRange}</span>
                                <span style="font-size: 9px; color: #9c27b0;">ðŸ“–</span>
                            </div>
                        `;
                    }
                    weekTrackerHtml += '</div>';
                    
                    // Determine which week to show attendance for
                    const attendanceWeek = currentWeek > 0 && currentWeek <= 6 ? currentWeek : 1;
                    
                    return `
                        <div class="class-card" style="${isUpcoming || startsToday ? 'border: 2px solid #ff9800;' : ''}">
                            <div class="class-header">
                                <div>
                                    <div class="class-day">${c.day}</div>
                                    <div class="class-time">${c.time} EST</div>
                                    <div style="font-size: 11px; color: #00ffff; margin-top: 3px;">ðŸ“… ${isUpcoming ? 'Starts' : 'Started'}: ${startDateDisplay}</div>
                                    ${startsToday ? '<div style="font-size: 11px; color: #39ff14; margin-top: 2px;">ðŸš€ Starting Today!</div>' : ''}
                                    ${isUpcoming && !startsToday ? '<div style="font-size: 11px; color: #ff9800; margin-top: 2px;">â³ Upcoming</div>' : ''}
                                </div>
                                <div style="text-align: right;">
                                    <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                </div>
                            </div>
                            
                            ${weekTrackerHtml}
                            <p style="font-size: 10px; color: #888; text-align: center; margin: 5px 0;">ðŸ‘† Click any week to view materials</p>
                            
                            ${currentWeek >= 1 && currentWeek <= 6 ? `
                                <h4 style="color: #ffff00; font-size: 13px; margin: 10px 0;">Attendance - Week ${attendanceWeek}</h4>
                                <div style="display: grid; gap: 10px;">
                                    ${students.map(s => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                            <span style="cursor: pointer; text-decoration: underline; color: #00ffff;" onclick="openStudentAnalyticsMenu('${s.id}', '${(s.name || 'Unknown').replace(/'/g, "\\'")}', '${(s.email || '').replace(/'/g, "\\'")}')">${s.name || 'Unknown'}</span>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="attendance-btn present ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'present' ? 'active' : ''}" onclick="markAttendanceWithWeek('${c.id}', '${s.id}', 'present', ${attendanceWeek})">P</button>
                                                <button class="attendance-btn late ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'late' ? 'active' : ''}" onclick="markAttendanceWithWeek('${c.id}', '${s.id}', 'late', ${attendanceWeek})">L</button>
                                                <button class="attendance-btn absent ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'absent' ? 'active' : ''}" onclick="handleAbsentClickWithWeek('${c.id}', '${s.id}', '${(s.name || 'Unknown').replace(/'/g, "\\'")}', ${attendanceWeek})">A</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : currentWeek > 6 ? `
                                <div style="text-align: center; padding: 15px; background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px;">
                                    <p style="color: #39ff14; font-size: 13px; margin: 0;">ðŸŽ“ Course Complete!</p>
                                    <p style="color: #888; font-size: 11px; margin-top: 5px;">This class has finished all 6 weeks.</p>
                                    <button class="btn btn-sm btn-success" onclick="markClassAsCompleted('${c.id}')" style="margin-top: 10px;">Move to Completed</button>
                                </div>
                            ` : `
                                <div style="margin-top: 15px;">
                                    <h4 style="color: #00ffff; font-size: 12px; margin-bottom: 8px;">ðŸ‘¥ Enrolled Students (${students.length})</h4>
                                    ${students.length > 0 ? `
                                        <div style="display: grid; gap: 6px;">
                                            ${students.map(s => {
                                                const studentName = s.name || 'Unknown';
                                                const studentEmail = s.email || '';
                                                return `
                                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                                    <div>
                                                        <span style="color: ${s.isLinked !== false ? '#39ff14' : '#ff9800'}; font-size: 11px;">${s.isLinked !== false ? 'âœ…' : 'âš ï¸'}</span>
                                                        <span style="color: #00ffff; font-size: 12px; margin-left: 5px; cursor: pointer; text-decoration: underline;" onclick="openStudentAnalyticsMenu('${s.id}', '${studentName.replace(/'/g, "\\'")}', '${studentEmail.replace(/'/g, "\\'")}')">${studentName}</span>
                                                        ${s.discord ? `<span style="color: #7289da; font-size: 10px; margin-left: 8px;">ðŸ’¬ ${s.discord}</span>` : ''}
                                                    </div>
                                                    ${studentEmail ? `<span style="color: #888; font-size: 10px;">${studentEmail}</span>` : ''}
                                                </div>
                                            `;}).join('')}
                                        </div>
                                    ` : `
                                        <p style="color: #888; font-size: 12px; text-align: center;">No students enrolled yet.</p>
                                    `}
                                    <div style="margin-top: 10px; padding: 10px; background: rgba(255,152,0,0.1); border: 1px solid #ff9800; border-radius: 6px; text-align: center;">
                                        <p style="color: #ff9800; font-size: 11px; margin: 0;">â³ Attendance will be available when the class starts on ${startDateDisplay}.</p>
                                    </div>
                                </div>
                            `}
                        </div>
                    `;
                }
                
            } catch (e) { console.error(e); }
        }
        
        // Mark attendance with specific week
        async function markAttendanceWithWeek(classId, studentId, status, week) {
            const key = `${classId}_${studentId}_${week}`;
            attendanceCache[key] = status;
            
            // Immediately update button states visually
            const buttons = document.querySelectorAll(`button[onclick*="markAttendanceWithWeek('${classId}', '${studentId}'"]`);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === 'P' && status === 'present') btn.classList.add('active');
                if (btn.textContent === 'L' && status === 'late') btn.classList.add('active');
                if (btn.textContent === 'A' && status === 'absent') btn.classList.add('active');
            });

            try {
                await db.collection('scheduler_attendance').doc(key).set({ 
                    classId, 
                    studentId, 
                    week, 
                    status, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                }, { merge: true });
                
                // Show success toast notification
                showToast(`âœ… Marked ${status.charAt(0).toUpperCase() + status.slice(1)}`, 'success');
                
                // Check if this completes Week 6 attendance
                if (week === 6) {
                    await checkWeek6Complete(classId);
                }
                
            } catch (e) { 
                console.error('Error saving attendance:', e); 
                showToast('âŒ Error saving attendance', 'error');
                // Reload to revert on error
                loadTeacherClasses();
            }
        }
        
        // Handle absent click with specific week
        function handleAbsentClickWithWeek(classId, studentId, studentName, week) {
            window.currentAbsenceWeek = week;
            openAbsenceModal(classId, studentId, studentName);
        }
        
        // Admin attendance functions
        async function markAttendanceAsAdmin(classId, studentId, status, week) {
            const key = `${classId}_${studentId}_${week}`;
            
            // Immediately update button states visually
            const buttons = document.querySelectorAll(`button[onclick*="markAttendanceAsAdmin('${classId}', '${studentId}'"]`);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === 'P' && status === 'present') btn.classList.add('active');
                if (btn.textContent === 'L' && status === 'late') btn.classList.add('active');
                if (btn.textContent === 'A' && status === 'absent') btn.classList.add('active');
            });
            
            // Update the admin's attendance data cache
            if (!window.adminTeacherAttendanceData) {
                window.adminTeacherAttendanceData = {};
            }
            if (!window.adminTeacherAttendanceData[classId]) {
                window.adminTeacherAttendanceData[classId] = {};
            }
            window.adminTeacherAttendanceData[classId][`${studentId}_${week}`] = status;

            try {
                await db.collection('scheduler_attendance').doc(key).set({ 
                    classId, 
                    studentId, 
                    week, 
                    status, 
                    markedBy: 'admin',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                }, { merge: true });
                
                // Show success toast notification
                showToast(`âœ… Marked ${status.charAt(0).toUpperCase() + status.slice(1)}`, 'success');
                
                // Check if this completes Week 6 attendance
                if (week === 6) {
                    await checkWeek6CompleteAdmin(classId);
                }
                
            } catch (e) { 
                console.error('Error saving attendance:', e); 
                showToast('âŒ Error saving attendance', 'error');
                // Revert button states on error - reload view
                if (typeof loadAdminTeacherView === 'function' && adminViewingTeacherId) {
                    loadAdminTeacherView(adminViewingTeacherId);
                }
            }
        }
        
        // Toast notification function
        function showToast(message, type = 'success') {
            // Remove existing toast if any
            const existingToast = document.getElementById('attendanceToast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.id = 'attendanceToast';
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                padding: 12px 24px;
                background: ${type === 'success' ? 'rgba(57, 255, 20, 0.95)' : 'rgba(255, 51, 102, 0.95)'};
                color: ${type === 'success' ? '#000' : '#fff'};
                border-radius: 8px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            
            // Add animation styles if not exists
            if (!document.getElementById('toastStyles')) {
                const style = document.createElement('style');
                style.id = 'toastStyles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100px); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100px); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Auto-remove after 2 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        function handleAbsentClickAsAdmin(classId, studentId, studentName, week) {
            window.currentAbsenceWeek = week;
            window.isAdminMarkingAttendance = true;
            openAbsenceModal(classId, studentId, studentName);
        }
        
        // Check if Week 6 is complete for admin view
        async function checkWeek6CompleteAdmin(classId) {
            try {
                const classDoc = await db.collection('scheduler_classes').doc(classId).get();
                if (!classDoc.exists) return;
                
                const classData = classDoc.data();
                const students = classData.students || [];
                
                const attendanceSnap = await db.collection('scheduler_attendance')
                    .where('classId', '==', classId)
                    .where('week', '==', 6)
                    .get();
                
                const markedStudents = new Set();
                attendanceSnap.docs.forEach(doc => {
                    markedStudents.add(doc.data().studentId);
                });
                
                const allMarked = students.every(s => markedStudents.has(s.id));
                
                if (allMarked) {
                    showWeek6ReminderModal(classId, classData);
                }
            } catch (e) {
                console.error('Error checking Week 6 completion:', e);
            }
        }
        
        // Check if Week 6 is complete and show reminder
        async function checkWeek6Complete(classId) {
            try {
                const classDoc = await db.collection('scheduler_classes').doc(classId).get();
                if (!classDoc.exists) return;
                
                const classData = classDoc.data();
                const students = classData.students || [];
                
                // Check if all students have Week 6 attendance
                const attendanceSnap = await db.collection('scheduler_attendance')
                    .where('classId', '==', classId)
                    .where('week', '==', 6)
                    .get();
                
                const markedStudents = new Set();
                attendanceSnap.docs.forEach(doc => {
                    markedStudents.add(doc.data().studentId);
                });
                
                const allMarked = students.every(s => markedStudents.has(s.id));
                
                if (allMarked) {
                    // Show reminder modal
                    showWeek6ReminderModal(classId, classData);
                }
            } catch (e) {
                console.error('Error checking Week 6 completion:', e);
            }
        }
        
        // Show Week 6 completion reminder
        function showWeek6ReminderModal(classId, classData) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'week6ReminderModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 450px;">
                    <button class="modal-close" onclick="closeWeek6ReminderModal()">Ã—</button>
                    <div style="text-align: center;">
                        <div style="font-size: 50px; margin-bottom: 15px;">ðŸŽ‰</div>
                        <h3 style="color: #39ff14; font-size: 12px; margin-bottom: 15px;">Week 6 Complete!</h3>
                        <p style="color: #fff; font-size: 13px; margin-bottom: 20px;">
                            ${classData.day} @ ${classData.time} - ${LEVELS[classData.level]}
                        </p>
                        <div style="background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <p style="color: #ffff00; font-size: 14px; margin-bottom: 10px;">ðŸ“¢ REMINDER</p>
                            <p style="color: #fff; font-size: 12px; line-height: 1.6;">
                                Please inform your students about:<br><br>
                                1ï¸âƒ£ <strong style="color: #39ff14;">Discount for next course</strong><br>
                                2ï¸âƒ£ <strong style="color: #00ffff;">1-Year Academy Program</strong>
                            </p>
                        </div>
                        <button class="btn btn-success" onclick="markClassAsCompleted('${classId}'); closeWeek6ReminderModal();" style="width: 100%;">
                            âœ… Move to Completed
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeWeek6ReminderModal() {
            const modal = document.getElementById('week6ReminderModal');
            if (modal) modal.remove();
        }
        
        // Mark class as completed
        async function markClassAsCompleted(classId) {
            try {
                await db.collection('scheduler_classes').doc(classId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadTeacherClasses();
                loadTodayClasses();
                loadTeacherCompletedClasses();
            } catch (e) {
                console.error('Error marking class as completed:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Set 1-Year Academy status for a student
        async function setAcademyStatus(classId, studentId, status) {
            try {
                const classDoc = await db.collection('scheduler_classes').doc(classId).get();
                const currentData = classDoc.data();
                const academyStatus = currentData.academyStatus || {};
                academyStatus[studentId] = status;
                
                await db.collection('scheduler_classes').doc(classId).update({
                    academyStatus: academyStatus
                });
                
                // Update local data and re-render without reloading from Firebase
                const classIndex = allCompletedClasses.findIndex(c => c.id === classId);
                if (classIndex !== -1) {
                    allCompletedClasses[classIndex].academyStatus = academyStatus;
                }
                renderFilteredCompletedClasses();
            } catch (e) {
                console.error('Error setting academy status:', e);
                alert('Error: ' + e.message);
            }
        }
        
        // Load Today's Classes Tab
        async function loadTodayClasses() {
            if (!currentUser) return;
            const container = document.getElementById('todayClassesContainer');
            if (!container) return;
            
            try {
                const snap = await db.collection('scheduler_classes').where('teacherId', '==', currentUser.odId).get();
                const fetchedClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                const activeClasses = fetchedClasses.filter(c => c.status !== 'completed');
                
                // Update allClassesForTeacher so analytics can find student emails
                allClassesForTeacher = fetchedClasses;
                
                // Also load prescheduled slots for this teacher
                const prescheduledSnap = await db.collection('prescheduled_slots').where('teacherId', '==', currentUser.odId).get();
                const prescheduledSlots = prescheduledSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Use EST timezone for "today" determination
                const todayEST = getESTToday();
                const todayDayName = getESTDayName();
                
                // Filter classes that have started AND are scheduled for today (EST)
                const todaysClasses = activeClasses.filter(c => {
                    if (!c.startDate) return false;
                    const startDate = parseESTDate(c.startDate);
                    return isDateOnOrAfter(todayEST, startDate) && c.day === todayDayName;
                });
                
                // Filter prescheduled classes starting today
                const todaysPreschedules = prescheduledSlots.filter(ps => {
                    if (ps.day !== todayDayName) return false;
                    if (!ps.startDate) return false;
                    const startDate = parseLocalDate(ps.startDate);
                    if (!startDate) return false;
                    // Check if start date is today or before
                    const todayStart = new Date(todayEST);
                    todayStart.setHours(0, 0, 0, 0);
                    const startDateOnly = new Date(startDate);
                    startDateOnly.setHours(0, 0, 0, 0);
                    return startDateOnly <= todayStart;
                });
                
                if (todaysClasses.length === 0 && todaysPreschedules.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 40px; margin-bottom: 15px;">ðŸ“…</div>
                            <p style="color: #888; font-size: 13px;">No classes scheduled for today (${todayDayName} EST).</p>
                            <p style="color: #666; font-size: 12px; margin-top: 10px;">Check the Calendar or My Classes tab for your schedule.</p>
                        </div>
                    `;
                    return;
                }
                
                // Load attendance data for today's classes
                const allAttendanceData = {};
                for (const cls of todaysClasses) {
                    const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', cls.id).get();
                    allAttendanceData[cls.id] = {};
                    attendanceSnap.docs.forEach(doc => {
                        const data = doc.data();
                        allAttendanceData[cls.id][`${data.studentId}_${data.week}`] = data.status;
                    });
                }
                
                let html = '';
                
                // Render active classes
                if (todaysClasses.length > 0) {
                    html += todaysClasses.map(c => renderClassCardForToday(c, allAttendanceData)).join('');
                }
                
                // Render prescheduled classes starting today
                if (todaysPreschedules.length > 0) {
                    html += '<div style="margin-top: 20px;"><h4 style="color: #ff9800; margin-bottom: 10px; font-size: 13px;">â³ Pre-scheduled Classes (Starting Today)</h4>';
                    html += todaysPreschedules.map(ps => renderTeacherPrescheduleCardForToday(ps)).join('');
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
            } catch (e) { 
                console.error(e); 
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">Error loading today\'s classes.</p>';
            }
        }
        
        function renderTeacherPrescheduleCardForToday(ps) {
            const classTypeName = LEVELS[ps.classType] || ps.classType || 'Class';
            const enrolledStudents = ps.enrolledStudents || [];
            const linkedCount = enrolledStudents.filter(s => s.odId || s.id).length;
            
            return `
                <div class="class-card" style="border: 2px solid #ff9800; background: rgba(255,152,0,0.15);">
                    <div class="class-header">
                        <div>
                            <div class="class-day" style="color: #ff9800;">${ps.day}</div>
                            <div class="class-time">${ps.time} EST</div>
                        </div>
                        <div style="text-align: right;">
                            <span class="level-badge level-${ps.classType}" style="border-color: #ff9800;">${classTypeName}</span>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 8px; margin-top: 10px;">
                        <div style="font-size: 24px; margin-bottom: 5px;">ðŸš€</div>
                        <p style="color: #39ff14; font-size: 14px; margin: 0; font-weight: bold;">Starting Today!</p>
                        <p style="color: #fff; font-size: 13px; margin: 5px 0;">${enrolledStudents.length} students enrolled</p>
                        ${linkedCount < enrolledStudents.length ? `<p style="color: #ff9800; font-size: 11px; margin: 0;">âš ï¸ ${enrolledStudents.length - linkedCount} not linked to accounts</p>` : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        <p style="color: #888; font-size: 11px; margin-bottom: 5px;">Students:</p>
                        ${enrolledStudents.map(s => `
                            <div style="display: flex; align-items: center; gap: 5px; padding: 3px 0;">
                                <span style="color: ${s.odId || s.id ? '#39ff14' : '#ff9800'}; font-size: 11px;">${s.odId || s.id ? 'âœ…' : 'âš ï¸'}</span>
                                <span style="color: #fff; font-size: 12px;">${s.name || s.linkedName || 'Unknown'}</span>
                                ${s.discord ? `<span style="color: #7289da; font-size: 10px; margin-left: 5px;">ðŸ’¬ ${s.discord}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: center;">
                        <p style="color: #888; font-size: 11px; margin: 0;">âš ï¸ This is a pre-scheduled class. Ask your admin to convert it to start taking attendance.</p>
                    </div>
                </div>
            `;
        }
        
        // Load Completed Classes Tab
        let completedClassesFilterDays = '7'; // Default to 7 days
        let allCompletedClasses = []; // Store all completed classes for filtering
        
        async function loadTeacherCompletedClasses() {
            if (!currentUser) return;
            const container = document.getElementById('teacherCompletedClassesContainer');
            if (!container) return;
            
            try {
                const snap = await db.collection('scheduler_classes')
                    .where('teacherId', '==', currentUser.odId)
                    .where('status', '==', 'completed')
                    .get();
                    
                allCompletedClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Apply the current filter
                renderFilteredCompletedClasses();
                
            } catch (e) { 
                console.error(e); 
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">Error loading completed classes.</p>';
            }
        }
        
        function filterCompletedClasses(days) {
            completedClassesFilterDays = days;
            
            // Update active button
            document.querySelectorAll('.completed-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.days === days) {
                    btn.classList.add('active');
                }
            });
            
            renderFilteredCompletedClasses();
        }
        
        function renderFilteredCompletedClasses() {
            const container = document.getElementById('teacherCompletedClassesContainer');
            if (!container) return;
            
            let filteredClasses = allCompletedClasses;
            
            // Apply date filter based on completedAt timestamp
            if (completedClassesFilterDays !== 'all') {
                const daysAgo = parseInt(completedClassesFilterDays);
                const cutoffDate = getESTDate();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                cutoffDate.setHours(0, 0, 0, 0);
                
                filteredClasses = allCompletedClasses.filter(c => {
                    if (!c.completedAt) return false;
                    const completedDate = c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt);
                    return completedDate >= cutoffDate;
                });
            }
            
            if (filteredClasses.length === 0) {
                const filterLabel = completedClassesFilterDays === 'all' ? '' : ` in the last ${completedClassesFilterDays} days`;
                container.innerHTML = `<p style="color: #888; font-size: 12px;">No completed classes${filterLabel}.</p>`;
                return;
            }
            
            // Sort by completedAt (most recent first)
            filteredClasses.sort((a, b) => {
                const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt || 0);
                const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt || 0);
                return dateB - dateA;
            });
            
            container.innerHTML = filteredClasses.map(c => {
                const startDateDisplay = c.startDate ? formatDateInEST(c.startDate, { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                const completedDateDisplay = c.completedAt ? 
                    (c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt)).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 
                    'Unknown';
                
                return `
                    <div class="class-card completed-class">
                        <div class="class-header">
                            <div>
                                <div class="class-day">${c.day}</div>
                                <div class="class-time">${c.time} EST</div>
                                <div style="font-size: 11px; color: #888; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                                <div style="font-size: 11px; color: #39ff14; margin-top: 2px;">âœ… Completed: ${completedDateDisplay}</div>
                            </div>
                            <div style="text-align: right;">
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            </div>
                        </div>
                        
                        <h4 style="color: #ffff00; font-size: 13px; margin: 15px 0 10px 0;">1-Year Academy Status</h4>
                        <div style="display: grid; gap: 8px;">
                            ${(c.students || []).map(s => {
                                const academyStatus = c.academyStatus?.[s.id] || 'pending';
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                        <span style="color: #fff; font-size: 12px;">${s.name}</span>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-sm ${academyStatus === 'yes' ? 'btn-success' : ''}" onclick="setAcademyStatus('${c.id}', '${s.id}', 'yes')" style="font-size: 10px; padding: 4px 8px; ${academyStatus === 'yes' ? '' : 'opacity: 0.5;'}">âœ… Yes</button>
                                            <button class="btn btn-sm ${academyStatus === 'no' ? 'btn-danger' : ''}" onclick="setAcademyStatus('${c.id}', '${s.id}', 'no')" style="font-size: 10px; padding: 4px 8px; ${academyStatus === 'no' ? '' : 'opacity: 0.5;'}">âŒ No</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Helper function to render class card for Today tab
        function renderClassCardForToday(c, allAttendanceData) {
            // Helper functions
            function getClassWeekDates(cls, weekNum) {
                if (!cls.startDate) return null;
                const startDate = parseLocalDate(cls.startDate);
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + (weekNum - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                return { start: weekStart, end: weekEnd };
            }
            
            function getClassCurrentWeek(cls) {
                if (!cls.startDate) return 1; // Default to week 1 if no start date
                const startDate = parseLocalDate(cls.startDate);
                const todayDate = getESTToday();
                if (todayDate < startDate) return 1; // If class is in Today view but hasn't technically started, treat as week 1
                const daysSinceStart = getDaysBetween(todayDate, startDate);
                return Math.min(Math.floor(daysSinceStart / 7) + 1, 7);
            }
            
            function formatDateRange(start, end) {
                const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                return `${formatDate(start)}-${formatDate(end)}`;
            }
            
            function isWeekAttendanceComplete(cls, weekNum) {
                const students = cls.students || [];
                if (students.length === 0) return false;
                const classAttendance = allAttendanceData[cls.id] || {};
                return students.every(s => {
                    const key = `${s.id}_${weekNum}`;
                    return classAttendance[key] && ['present', 'late', 'absent'].includes(classAttendance[key]);
                });
            }
            
            function getAttendanceStatusForClass(classId, studentId, week) {
                const classAttendance = allAttendanceData[classId] || {};
                return classAttendance[`${studentId}_${week}`] || '';
            }
            
            const currentWeek = getClassCurrentWeek(c);
            const startDateDisplay = c.startDate ? formatDateInEST(c.startDate, { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
            const students = c.students || [];
            
            // Build week tracker
            let weekTrackerHtml = '<div class="class-week-tracker">';
            for (let w = 1; w <= 6; w++) {
                const weekDates = getClassWeekDates(c, w);
                const dateRange = weekDates ? formatDateRange(weekDates.start, weekDates.end) : '';
                const isCompleted = isWeekAttendanceComplete(c, w) && currentWeek > w;
                const isCurrent = currentWeek === w;
                const isFuture = currentWeek < w;
                
                let weekClass = 'class-week-box';
                if (isCompleted) weekClass += ' completed';
                else if (isCurrent) weekClass += ' current';
                else if (isFuture) weekClass += ' future';
                
                weekTrackerHtml += `
                    <div class="${weekClass}">
                        <span class="week-label">Week ${w}</span>
                        <span class="week-dates">${dateRange}</span>
                    </div>
                `;
            }
            weekTrackerHtml += '</div>';
            
            const attendanceWeek = currentWeek > 0 && currentWeek <= 6 ? currentWeek : 1;
            
            return `
                <div class="class-card today-class">
                    <div class="class-header">
                        <div>
                            <div class="class-day">${c.day}</div>
                            <div class="class-time">${c.time} EST</div>
                            <div style="font-size: 11px; color: #00ffff; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                        </div>
                        <div style="text-align: right;">
                            <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            <div style="font-size: 11px; color: #39ff14; margin-top: 5px;">ðŸ“ TODAY</div>
                        </div>
                    </div>
                    
                    ${weekTrackerHtml}
                    
                    <div style="margin: 10px 0;">
                        <button class="btn btn-sm btn-info" onclick="showClassMaterial('${c.level}', ${attendanceWeek})" style="width: 100%;">ðŸ“– Show Material (Week ${attendanceWeek})</button>
                    </div>
                    
                    ${students.length > 0 ? `
                        <h4 style="color: #ffff00; font-size: 13px; margin: 10px 0;">Attendance - Week ${attendanceWeek}</h4>
                        <div style="display: grid; gap: 10px;">
                            ${students.map(s => {
                                const studentName = s.name || 'Unknown';
                                const studentEmail = s.email || '';
                                return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                    <span style="cursor: pointer; text-decoration: underline; color: #00ffff;" onclick="openStudentAnalyticsMenu('${s.id}', '${studentName.replace(/'/g, "\\'")}', '${studentEmail.replace(/'/g, "\\'")}')">${studentName}</span>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="attendance-btn present ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'present' ? 'active' : ''}" onclick="markAttendanceWithWeek('${c.id}', '${s.id}', 'present', ${attendanceWeek})">P</button>
                                        <button class="attendance-btn late ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'late' ? 'active' : ''}" onclick="markAttendanceWithWeek('${c.id}', '${s.id}', 'late', ${attendanceWeek})">L</button>
                                        <button class="attendance-btn absent ${getAttendanceStatusForClass(c.id, s.id, attendanceWeek) === 'absent' ? 'active' : ''}" onclick="handleAbsentClickWithWeek('${c.id}', '${s.id}', '${studentName.replace(/'/g, "\\'")}', ${attendanceWeek})">A</button>
                                    </div>
                                </div>
                            `;}).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <p style="color: #888; font-size: 12px;">No students enrolled in this class.</p>
                        </div>
                    `}
                    ${currentWeek > 6 ? `
                        <div style="text-align: center; padding: 15px; margin-top: 10px; background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px;">
                            <p style="color: #39ff14; font-size: 13px; margin: 0;">ðŸŽ“ Course Complete!</p>
                            <button class="btn btn-sm btn-success" onclick="markClassAsCompleted('${c.id}')" style="margin-top: 10px;">Move to Completed</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        let attendanceCache = {};

        function getAttendanceStatus(classId, studentId, week) {
            const key = `${classId}_${studentId}_${week}`;
            return attendanceCache[key] || '';
        }
        
        // Handle absent button click - show modal
        function handleAbsentClick(classId, studentId, studentName) {
            openAbsenceModal(classId, studentId, studentName);
        }

        async function markAttendance(classId, studentId, status) {
            const week = schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            attendanceCache[key] = status;

            try {
                console.log('Saving attendance:', { classId, studentId, week, status, key });
                await db.collection('scheduler_attendance').doc(key).set({ 
                    classId, 
                    studentId, 
                    week, 
                    status, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                }, { merge: true });
                console.log('Attendance saved successfully');
                loadTeacherClasses();
                
                // Check if all students marked in Week 6 (for reminder)
                if (week === 6 && currentUser?.role === 'teacher') {
                    checkClassAttendanceComplete(classId);
                }
            } catch (e) { 
                console.error('Error saving attendance:', e); 
                alert('Error saving attendance: ' + e.message);
            }
        }

        async function loadAttendanceHistory() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const tbody = document.getElementById('attendanceHistoryBody');
            if (!classId) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">Select a class</td></tr>'; return; }

            try {
                const classDoc = await db.collection('scheduler_classes').doc(classId).get();
                if (!classDoc.exists) return;
                const classData = classDoc.data();
                const students = classData.students || [];

                const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                const attendanceMap = {};
                attendanceSnap.docs.forEach(d => { const data = d.data(); attendanceMap[`${data.studentId}_${data.week}`] = data.status; });

                tbody.innerHTML = students.map(s => `
                    <tr>
                        <td>${s.name}</td>
                        ${[1,2,3,4,5,6].map(w => {
                            const status = attendanceMap[`${s.id}_${w}`] || '-';
                            const cls = status === 'present' ? 'history-present' : status === 'late' ? 'history-late' : status === 'absent' ? 'history-absent' : '';
                            return `<td class="${cls}" style="text-align: center;">${status === 'present' ? 'P' : status === 'late' ? 'L' : status === 'absent' ? 'A' : '-'}</td>`;
                        }).join('')}
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        // ==================== SCHEDULE RENDERING ====================
        
        function renderAdminSchedule() {
            const grid = document.getElementById('adminScheduleGrid');
            const totalSlots = TIME_SLOTS.length * DAYS.length;
            
            // Filter to only active classes (not completed)
            const activeClassList = allClasses.filter(c => c.status !== 'completed');
            
            // Build a map of classes by day and time
            const classMap = {};
            DAYS.forEach(day => {
                classMap[day] = {};
                TIME_SLOTS.forEach(time => {
                    classMap[day][time] = [];
                });
            });
            
            // Populate the map with active classes only
            activeClassList.forEach(cls => {
                if (classMap[cls.day] && classMap[cls.day][cls.time]) {
                    classMap[cls.day][cls.time].push(cls);
                }
            });
            
            // Calculate stats (only for active classes)
            let activeClasses = 0;
            let needsTeacher = 0;
            let fullClasses = 0;
            let emptySlots = 0;
            let totalAvailableSpots = 0;
            
            activeClassList.forEach(cls => {
                const studentCount = (cls.students || []).length;
                const spotsLeft = schedulerSettings.maxStudents - studentCount;
                
                if (cls.teacherId) {
                    activeClasses++;
                } else {
                    needsTeacher++;
                }
                
                if (studentCount >= schedulerSettings.maxStudents) {
                    fullClasses++;
                } else {
                    totalAvailableSpots += spotsLeft;
                }
            });
            
            // Count empty slots
            DAYS.forEach(day => {
                TIME_SLOTS.forEach(time => {
                    if (classMap[day][time].length === 0) {
                        emptySlots++;
                    }
                });
            });
            
            // Update summary stats
            document.getElementById('schedTotalSlots').textContent = totalSlots;
            document.getElementById('schedActiveClasses').textContent = activeClasses;
            document.getElementById('schedNeedsTeacher').textContent = needsTeacher;
            document.getElementById('schedFullClasses').textContent = fullClasses;
            document.getElementById('schedEmptySlots').textContent = emptySlots;
            document.getElementById('schedAvailableSpots').textContent = totalAvailableSpots;
            
            // Get current week dates for schedule header
            const weekDates = getWeekDates(schedulerSettings.currentWeek);
            let satDate = '', sunDate = '';
            if (weekDates) {
                const start = weekDates.start;
                const satOffset = (6 - start.getDay() + 7) % 7;
                const sat = new Date(start);
                sat.setDate(start.getDate() + satOffset);
                const sun = new Date(sat);
                sun.setDate(sat.getDate() + 1);
                satDate = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                sunDate = sun.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            // Build the grid HTML
            let html = '';
            
            // Header row with dates
            html += '<div class="schedule-header">TIME (EST)</div>';
            DAYS.forEach(day => {
                const dateStr = day === 'Saturday' ? satDate : sunDate;
                html += `<div class="schedule-header">${day.toUpperCase()}${dateStr ? `<br><span style="font-size: 11px; color: #ffff00;">${dateStr}</span>` : ''}</div>`;
            });
            
            // Time rows
            TIME_SLOTS.forEach(time => {
                html += `<div class="schedule-time">${time}</div>`;
                
                DAYS.forEach(day => {
                    const classes = classMap[day][time];
                    let cellClass = 'schedule-cell';
                    
                    if (classes.length === 0) {
                        cellClass += ' empty';
                        html += `<div class="${cellClass}"><div style="color: #666; font-size: 11px; text-align: center;">No class</div></div>`;
                    } else {
                        html += `<div class="${cellClass} has-class">`;
                        
                        classes.forEach(cls => {
                            const teacher = allTeachers.find(t => t.id === cls.teacherId);
                            const studentCount = (cls.students || []).length;
                            const isFull = studentCount >= schedulerSettings.maxStudents;
                            const needsTeacherFlag = !cls.teacherId;
                            
                            let blockClass = 'schedule-class-block clickable';
                            if (isFull) blockClass += ' full';
                            else if (needsTeacherFlag) blockClass += ' no-teacher';
                            
                            html += `
                                <div class="${blockClass}" onclick="openClassDetails('${cls.id}')">
                                    <div class="schedule-class-level">${LEVELS[cls.level]}</div>
                                    <div class="schedule-class-students">ðŸ‘¥ ${studentCount}/${schedulerSettings.maxStudents}</div>
                                    <div class="schedule-class-info">${isFull ? 'ðŸ”´ FULL' : `ðŸŸ¢ ${schedulerSettings.maxStudents - studentCount} spots`}</div>
                                    ${teacher 
                                        ? `<div class="schedule-class-teacher">ðŸ‘¨â€ðŸ« ${teacher.name}</div>` 
                                        : `<div style="color: #ffff00; font-size: 11px;">âš ï¸ No teacher</div>`
                                    }
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    }
                });
            });
            
            grid.innerHTML = html;
        }
        
        function renderTeacherSchedule() {
            const grid = document.getElementById('teacherScheduleGrid');
            const classes = allClassesForTeacher || [];
            
            // Build a map of classes by day and time
            const classMap = {};
            DAYS.forEach(day => {
                classMap[day] = {};
                TIME_SLOTS.forEach(time => {
                    classMap[day][time] = null;
                });
            });
            
            // Find teacher's active classes (not completed)
            const myClasses = classes.filter(c => c.teacherId === currentUser.odId && c.status !== 'completed');
            
            myClasses.forEach(cls => {
                if (classMap[cls.day]) {
                    classMap[cls.day][cls.time] = cls;
                }
            });
            
            // Calculate stats
            let totalStudents = 0;
            let fullClasses = 0;
            let availableSpots = 0;
            
            myClasses.forEach(cls => {
                const studentCount = (cls.students || []).length;
                totalStudents += studentCount;
                
                if (studentCount >= schedulerSettings.maxStudents) {
                    fullClasses++;
                } else {
                    availableSpots += (schedulerSettings.maxStudents - studentCount);
                }
            });
            
            // Update summary stats
            document.getElementById('teacherTotalClasses').textContent = myClasses.length;
            document.getElementById('teacherTotalStudents').textContent = totalStudents;
            document.getElementById('teacherFullClasses').textContent = fullClasses;
            document.getElementById('teacherAvailableSpots').textContent = availableSpots;
            
            // Get current week dates for schedule header
            const weekDates = getWeekDates(schedulerSettings.currentWeek);
            let satDate = '', sunDate = '';
            if (weekDates) {
                const start = weekDates.start;
                const satOffset = (6 - start.getDay() + 7) % 7;
                const sat = new Date(start);
                sat.setDate(start.getDate() + satOffset);
                const sun = new Date(sat);
                sun.setDate(sat.getDate() + 1);
                satDate = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                sunDate = sun.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            // Build the grid HTML
            let html = '';
            
            // Header row with dates
            html += '<div class="schedule-header">TIME (EST)</div>';
            DAYS.forEach(day => {
                const dateStr = day === 'Saturday' ? satDate : sunDate;
                html += `<div class="schedule-header">${day.toUpperCase()}${dateStr ? `<br><span style="font-size: 11px; color: #ffff00;">${dateStr}</span>` : ''}</div>`;
            });
            
            // Time rows
            TIME_SLOTS.forEach(time => {
                html += `<div class="schedule-time">${time}</div>`;
                
                DAYS.forEach(day => {
                    const cls = classMap[day][time];
                    let cellClass = 'schedule-cell';
                    
                    if (!cls) {
                        cellClass += ' empty';
                        html += `<div class="${cellClass}"><div style="color: #666; font-size: 11px; text-align: center;">-</div></div>`;
                    } else {
                        const studentCount = (cls.students || []).length;
                        const isFull = studentCount >= schedulerSettings.maxStudents;
                        
                        cellClass += isFull ? ' full' : ' has-class';
                        
                        html += `
                            <div class="${cellClass}">
                                <div class="schedule-class-block clickable ${isFull ? 'full' : ''}" onclick="openClassDetails('${cls.id}')">
                                    <div class="schedule-class-level">${LEVELS[cls.level]}</div>
                                    <div class="schedule-class-students">ðŸ‘¥ ${studentCount}/${schedulerSettings.maxStudents}</div>
                                    <div class="schedule-class-info">${isFull ? 'ðŸ”´ FULL' : `ðŸŸ¢ ${schedulerSettings.maxStudents - studentCount} spots left`}</div>
                                </div>
                            </div>
                        `;
                    }
                });
            });
            
            grid.innerHTML = html;
        }

        // ==================== CLASS DETAILS MODAL ====================
        
        async function openClassDetails(classId) {
            const cls = allClasses.find(c => c.id === classId) || allClassesForTeacher.find(c => c.id === classId);
            if (!cls) return;
            
            const teacher = allTeachers.find(t => t.id === cls.teacherId);
            
            // Load attendance data for this class
            let attendanceMap = {};
            let contactedMap = {};
            try {
                const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                attendanceSnap.docs.forEach(d => {
                    const data = d.data();
                    attendanceMap[`${data.studentId}_${data.week}`] = { status: data.status, reason: data.reason || null };
                });
                
                // Load contacted status
                const contactedSnap = await db.collection('scheduler_contacted').where('classId', '==', classId).get();
                contactedSnap.docs.forEach(d => {
                    const data = d.data();
                    contactedMap[data.studentId] = data.contacted;
                });
            } catch (e) { console.error(e); }
            
            // Get full student data - for teachers, load directly from Firebase if allStudents is empty
            const studentIds = (cls.students || []).map(s => s.id);
            const fullStudentData = {};
            
            // First try to get from allStudents (admin/support)
            for (const sid of studentIds) {
                const studentDoc = allStudents.find(s => s.id === sid);
                if (studentDoc) {
                    fullStudentData[sid] = studentDoc;
                }
            }
            
            // For teachers or if allStudents is empty, load directly from Firebase
            if (Object.keys(fullStudentData).length < studentIds.length) {
                try {
                    for (const sid of studentIds) {
                        if (!fullStudentData[sid]) {
                            const studentDoc = await db.collection('scheduler_students').doc(sid).get();
                            if (studentDoc.exists) {
                                fullStudentData[sid] = { id: studentDoc.id, ...studentDoc.data() };
                            } else {
                                // Fallback to embedded student data from class
                                const embeddedStudent = cls.students.find(s => s.id === sid);
                                if (embeddedStudent) {
                                    fullStudentData[sid] = embeddedStudent;
                                }
                            }
                        }
                    }
                } catch (e) { 
                    console.error('Error loading student data:', e);
                    // Use embedded student data as fallback
                    for (const student of (cls.students || [])) {
                        if (!fullStudentData[student.id]) {
                            fullStudentData[student.id] = student;
                        }
                    }
                }
            }
            
            // Format start date for display
            const startDateDisplay = cls.startDate ? formatDateInEST(cls.startDate, { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
            
            // Header
            document.getElementById('classDetailsHeader').innerHTML = `
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="color: #ffff00; font-size: 14px;">${cls.day} @ ${cls.time} EST</div>
                        <div style="color: #00ffff; font-size: 12px; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                        <span class="level-badge level-${cls.level}">${LEVELS[cls.level]}</span>
                    </div>
                    <div style="text-align: right;">
                        ${teacher ? `<div style="color: #39ff14; font-size: 13px;">ðŸ‘¨â€ðŸ« ${teacher.name}</div>` : '<div style="color: #ff3366; font-size: 13px;">âš ï¸ No teacher assigned</div>'}
                        <div style="color: #888; font-size: 12px;">ðŸ‘¥ ${(cls.students || []).length} students</div>
                    </div>
                </div>
            `;
            
            // Students list
            let studentsHtml = '';
            for (const student of (cls.students || [])) {
                const fullData = fullStudentData[student.id] || {};
                const phone = fullData.phone || '';
                
                // Check if student has any absences
                let hasAbsence = false;
                let absenceWeeks = [];
                for (let w = 1; w <= 6; w++) {
                    const att = attendanceMap[`${student.id}_${w}`];
                    if (att && att.status === 'absent') {
                        hasAbsence = true;
                        absenceWeeks.push(w);
                    }
                }
                
                const isContacted = contactedMap[student.id] || false;
                
                studentsHtml += `
                    <div class="student-detail-row ${hasAbsence ? 'absent-student' : ''}">
                        <div class="student-detail-header">
                            <div class="student-detail-name" style="cursor: pointer; text-decoration: underline;" onclick="closeClassDetailsModal(); openStudentAnalyticsMenu('${student.id}', '${student.name.replace(/'/g, "\\'")}', '${(fullData.email || '').replace(/'/g, "\\'")}')">${student.name}</div>
                            <div class="rank-dot rank-${student.rank}" style="width: 12px; height: 12px;" title="Preference #${student.rank}"></div>
                        </div>
                        <div class="student-detail-info">ðŸ“§ ${fullData.email || 'N/A'} | ðŸŒ ${fullData.timezone || 'N/A'}</div>
                        
                        <div class="student-detail-attendance">
                            ${[1,2,3,4,5,6].map(w => {
                                const att = attendanceMap[`${student.id}_${w}`];
                                const status = att?.status || '';
                                const reason = att?.reason || '';
                                let cls = 'attendance-week';
                                let text = `W${w}: -`;
                                if (status === 'present') { cls += ' present'; text = `W${w}: P`; }
                                else if (status === 'late') { cls += ' late'; text = `W${w}: L`; }
                                else if (status === 'absent') { cls += ' absent'; text = `W${w}: A`; }
                                return `<span class="${cls}" title="${reason ? 'Reason: ' + reason : 'No reason'}">${text}</span>`;
                            }).join('')}
                        </div>
                        
                        ${hasAbsence ? `
                            <div class="student-detail-phone ${hasAbsence ? 'visible' : ''}">
                                ðŸ“ž ${phone ? `<a href="tel:${phone}">${phone}</a>` : 'No phone number'}
                            </div>
                            ${absenceWeeks.map(w => {
                                const att = attendanceMap[`${student.id}_${w}`];
                                return att?.reason ? `<div class="absence-reason-display">Week ${w} reason: ${att.reason}</div>` : `<div class="absence-reason-display" style="color: #ff3366;">Week ${w}: No reason given</div>`;
                            }).join('')}
                            <div class="contacted-row ${hasAbsence ? 'visible' : ''}">
                                <label class="contacted-checkbox">
                                    <input type="checkbox" ${isContacted ? 'checked' : ''} onchange="markStudentContacted('${classId}', '${student.id}', this.checked)">
                                    <span>âœ… Student has been contacted</span>
                                </label>
                            </div>
                        ` : ''}
                        
                        ${(currentUser?.role === 'admin' || currentUser?.role === 'support') ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                <button class="btn btn-sm btn-warning" onclick="closeClassDetailsModal(); openMoveStudentModal('${student.id}', '${student.name.replace(/'/g, "\\'")}', '${classId}')">ðŸ”„ Move Student</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmRemoveStudentFromClass('${student.id}', '${student.name.replace(/'/g, "\\'")}', '${classId}')" style="margin-left: 5px;">ðŸ—‘ï¸ Remove</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            document.getElementById('classStudentsList').innerHTML = studentsHtml || '<p style="color: #888; font-size: 12px;">No students in this class.</p>';
            document.getElementById('classDetailsModal').classList.add('active');
        }
        
        function closeClassDetailsModal() {
            document.getElementById('classDetailsModal').classList.remove('active');
        }
        
        async function markStudentContacted(classId, studentId, contacted) {
            try {
                await db.collection('scheduler_contacted').doc(`${classId}_${studentId}`).set({
                    classId,
                    studentId,
                    contacted,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (e) { console.error(e); }
        }

        // ==================== ABSENCE REASON MODAL ====================
        
        function openAbsenceModal(classId, studentId, studentName) {
            document.getElementById('absenceClassId').value = classId;
            document.getElementById('absenceStudentId').value = studentId;
            document.getElementById('absenceStudentName').textContent = studentName;
            document.getElementById('absenceReasonForm').style.display = 'none';
            document.getElementById('absenceSubmitBtn').style.display = 'none';
            document.getElementById('absenceReasonText').value = '';
            document.getElementById('absenceModal').classList.add('active');
        }
        
        function closeAbsenceModal() {
            document.getElementById('absenceModal').classList.remove('active');
            window.currentAbsenceWeek = null;
            window.isAdminMarkingAttendance = false;
        }
        
        // Edit Start Date Modal Functions
        function openEditStartDateModal(classId, currentStartDate, day, time, level) {
            document.getElementById('editStartDateClassId').value = classId;
            document.getElementById('editStartDateInput').value = currentStartDate || '';
            document.getElementById('editStartDateClassInfo').innerHTML = `
                <div style="color: #ffff00; font-size: 13px; margin-bottom: 5px;">${day} @ ${time} EST</div>
                <span class="level-badge level-${level}">${LEVELS[level]}</span>
            `;
            document.getElementById('editStartDateMessage').innerHTML = '';
            document.getElementById('editStartDateModal').classList.add('active');
        }
        
        function closeEditStartDateModal() {
            document.getElementById('editStartDateModal').classList.remove('active');
        }
        
        async function saveClassStartDate() {
            const classId = document.getElementById('editStartDateClassId').value;
            const newStartDate = document.getElementById('editStartDateInput').value;
            
            if (!newStartDate) {
                document.getElementById('editStartDateMessage').innerHTML = '<p class="message error">Please select a date.</p>';
                return;
            }
            
            try {
                await db.collection('scheduler_classes').doc(classId).update({
                    startDate: newStartDate
                });
                
                // Update local data
                const classIndex = allClasses.findIndex(c => c.id === classId);
                if (classIndex !== -1) {
                    allClasses[classIndex].startDate = newStartDate;
                }
                
                closeEditStartDateModal();
                renderClasses();
                renderMonthlyCalendar();
                renderTeacherCalendar();
                
                // Show success message briefly
                alert('Start date updated successfully!');
            } catch (e) {
                console.error('Error saving start date:', e);
                document.getElementById('editStartDateMessage').innerHTML = `<p class="message error">Error: ${e.message}</p>`;
            }
        }
        
        function showAbsenceReasonForm() {
            document.getElementById('absenceReasonForm').style.display = 'block';
            document.getElementById('absenceSubmitBtn').style.display = 'block';
        }
        
        async function markAbsentNoReason() {
            const classId = document.getElementById('absenceClassId').value;
            const studentId = document.getElementById('absenceStudentId').value;
            const week = window.currentAbsenceWeek || schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            const isAdmin = window.isAdminMarkingAttendance;
            
            // Immediately update button states visually
            const btnSelector = isAdmin ? 
                `button[onclick*="markAttendanceAsAdmin('${classId}', '${studentId}'"]` :
                `button[onclick*="markAttendanceWithWeek('${classId}', '${studentId}'"]`;
            const buttons = document.querySelectorAll(btnSelector);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === 'A') btn.classList.add('active');
            });
            
            try {
                await db.collection('scheduler_attendance').doc(key).set({
                    classId,
                    studentId,
                    week,
                    status: 'absent',
                    reason: null,
                    markedBy: isAdmin ? 'admin' : 'teacher',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                attendanceCache[key] = 'absent';
                
                // Update admin cache if marking as admin
                if (isAdmin && window.adminTeacherAttendanceData) {
                    if (!window.adminTeacherAttendanceData[classId]) {
                        window.adminTeacherAttendanceData[classId] = {};
                    }
                    window.adminTeacherAttendanceData[classId][`${studentId}_${week}`] = 'absent';
                }
                
                closeAbsenceModal();
                
                // Show success toast
                showToast('âœ… Marked Absent', 'success');
                
                // Check if Week 6 is complete
                if (week === 6) {
                    if (isAdmin) {
                        await checkWeek6CompleteAdmin(classId);
                    } else {
                        await checkWeek6Complete(classId);
                    }
                }
                
            } catch (e) { 
                console.error(e);
                showToast('âŒ Error saving attendance', 'error');
            }
        }
        
        async function submitAbsenceWithReason() {
            const classId = document.getElementById('absenceClassId').value;
            const studentId = document.getElementById('absenceStudentId').value;
            const reason = document.getElementById('absenceReasonText').value.trim();
            const week = window.currentAbsenceWeek || schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            const isAdmin = window.isAdminMarkingAttendance;
            
            if (!reason) {
                alert('Please enter the reason for absence.');
                return;
            }
            
            // Immediately update button states visually
            const btnSelector = isAdmin ? 
                `button[onclick*="markAttendanceAsAdmin('${classId}', '${studentId}'"]` :
                `button[onclick*="markAttendanceWithWeek('${classId}', '${studentId}'"]`;
            const buttons = document.querySelectorAll(btnSelector);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === 'A') btn.classList.add('active');
            });
            
            try {
                await db.collection('scheduler_attendance').doc(key).set({
                    classId,
                    studentId,
                    week,
                    status: 'absent',
                    reason: reason,
                    markedBy: isAdmin ? 'admin' : 'teacher',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                attendanceCache[key] = 'absent';
                
                // Update admin cache if marking as admin
                if (isAdmin && window.adminTeacherAttendanceData) {
                    if (!window.adminTeacherAttendanceData[classId]) {
                        window.adminTeacherAttendanceData[classId] = {};
                    }
                    window.adminTeacherAttendanceData[classId][`${studentId}_${week}`] = 'absent';
                }
                
                closeAbsenceModal();
                
                // Show success toast
                showToast('âœ… Marked Absent (with reason)', 'success');
                
                // Check if Week 6 is complete
                if (week === 6) {
                    if (isAdmin) {
                        await checkWeek6CompleteAdmin(classId);
                    } else {
                        await checkWeek6Complete(classId);
                    }
                }
                
            } catch (e) { 
                console.error(e);
                showToast('âŒ Error saving attendance', 'error');
            }
        }

        // ==================== ABSENCES LIST ====================
        
        let allAbsencesData = [];
        
        async function loadAbsencesList() {
            const container = document.getElementById('absencesListContainer');
            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading absences...</p>';
            
            const weekFilter = document.getElementById('absenceWeekFilter').value;
            
            try {
                // Get all attendance records marked as absent
                let query = db.collection('scheduler_attendance').where('status', '==', 'absent');
                
                if (weekFilter !== 'all') {
                    query = query.where('week', '==', parseInt(weekFilter));
                }
                
                const attendanceSnap = await query.get();
                
                if (attendanceSnap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No absences found.</p>';
                    updateAbsenceStats(0, 0, 0);
                    return;
                }
                
                // Get contacted statuses
                const contactedSnap = await db.collection('scheduler_contacted').get();
                const contactedMap = {};
                contactedSnap.docs.forEach(d => {
                    const data = d.data();
                    contactedMap[data.studentId] = data.contacted;
                });
                
                // Build the absences data
                allAbsencesData = [];
                
                for (const doc of attendanceSnap.docs) {
                    const data = doc.data();
                    
                    // Get student info from allStudents
                    const student = allStudents.find(s => s.id === data.studentId);
                    
                    // Get class info
                    const cls = allClasses.find(c => c.id === data.classId);
                    
                    // Also check for student info directly in the class's students array
                    const classStudent = cls?.students?.find(s => s.id === data.studentId);
                    
                    if (cls) {
                        // Use student from allStudents if available, otherwise from class
                        const studentName = student?.name || classStudent?.name || 'Unknown';
                        const studentEmail = student?.email || classStudent?.email || '';
                        const studentPhone = student?.phone || classStudent?.phone || '';
                        const studentDiscord = student?.discord || classStudent?.discord || '';
                        
                        allAbsencesData.push({
                            id: doc.id,
                            studentId: data.studentId,
                            classId: data.classId,
                            week: data.week,
                            reason: data.reason || null,
                            studentName: studentName,
                            studentEmail: studentEmail,
                            studentPhone: studentPhone,
                            studentDiscord: studentDiscord,
                            classDay: cls.day,
                            classTime: cls.time,
                            classLevel: cls.level,
                            contacted: contactedMap[data.studentId] || false,
                            timestamp: data.timestamp
                        });
                    }
                }
                
                // Sort by week (descending), then by student name
                allAbsencesData.sort((a, b) => {
                    if (b.week !== a.week) return b.week - a.week;
                    return a.studentName.localeCompare(b.studentName);
                });
                
                renderAbsencesList();
                
            } catch (e) { 
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
            }
        }
        
        function renderAbsencesList() {
            const container = document.getElementById('absencesListContainer');
            const contactFilter = document.getElementById('absenceContactFilter').value;
            
            let filteredData = allAbsencesData;
            
            if (contactFilter === 'contacted') {
                filteredData = allAbsencesData.filter(a => a.contacted);
            } else if (contactFilter === 'not-contacted') {
                filteredData = allAbsencesData.filter(a => !a.contacted);
            }
            
            // Update stats
            const totalAbsences = allAbsencesData.length;
            const contactedCount = allAbsencesData.filter(a => a.contacted).length;
            const notContactedCount = allAbsencesData.filter(a => !a.contacted).length;
            updateAbsenceStats(totalAbsences, contactedCount, notContactedCount);
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No absences match the current filter.</p>';
                return;
            }
            
            container.innerHTML = filteredData.map(a => `
                <div class="absence-item ${a.contacted ? 'contacted' : 'not-contacted'}">
                    <div class="absence-item-info">
                        <div class="absence-item-name">${a.studentName}</div>
                        <div class="absence-item-details">ðŸ“§ ${a.studentEmail}</div>
                        <div class="absence-item-class">ðŸ“š ${a.classDay} @ ${a.classTime} EST - ${LEVELS[a.classLevel]}</div>
                        ${a.reason ? `<div class="absence-item-reason">ðŸ’¬ "${a.reason}"</div>` : '<div class="absence-item-reason" style="color: #ff3366;">âš ï¸ No reason given</div>'}
                        ${a.studentPhone ? `<div class="absence-item-phone">ðŸ“ž <a href="tel:${a.studentPhone}">${a.studentPhone}</a></div>` : '<div class="absence-item-phone" style="color: #888;">ðŸ“ž No phone</div>'}
                        ${a.studentDiscord ? `<div class="absence-item-phone" style="color: #7289da;">ðŸŽ® ${a.studentDiscord}</div>` : '<div class="absence-item-phone" style="color: #888;">ðŸŽ® No Discord</div>'}
                    </div>
                    <div class="absence-item-status">
                        <div class="absence-week-badge">Week ${a.week}</div>
                        <div class="absence-status-badge ${a.contacted ? 'contacted' : 'not-contacted'}">
                            ${a.contacted ? 'âœ… CONTACTED' : 'âŒ NOT CONTACTED'}
                        </div>
                        <label class="contacted-checkbox" style="margin-top: 5px;">
                            <input type="checkbox" ${a.contacted ? 'checked' : ''} onchange="updateAbsenceContacted('${a.classId}', '${a.studentId}', this.checked)">
                            <span style="font-size: 11px;">Mark contacted</span>
                        </label>
                    </div>
                </div>
            `).join('');
        }
        
        function filterAbsencesList() {
            renderAbsencesList();
        }
        
        function updateAbsenceStats(total, contacted, notContacted) {
            document.getElementById('absenceTotalCount').textContent = total;
            document.getElementById('absenceContactedCount').textContent = contacted;
            document.getElementById('absenceNotContactedCount').textContent = notContacted;
        }
        
        async function updateAbsenceContacted(classId, studentId, contacted) {
            try {
                await db.collection('scheduler_contacted').doc(`${classId}_${studentId}`).set({
                    classId,
                    studentId,
                    contacted,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Update local data
                allAbsencesData.forEach(a => {
                    if (a.studentId === studentId) {
                        a.contacted = contacted;
                    }
                });
                
                renderAbsencesList();
            } catch (e) { console.error(e); }
        }

        // ==================== MONTHLY CALENDAR ====================
        
        let calendarMonth = getESTMonth();
        let calendarYear = getESTYear();
        
        function changeCalendarMonth(delta) {
            calendarMonth += delta;
            if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
            if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
            renderMonthlyCalendar();
            renderTeacherCalendar();
        }
        
        function renderMonthlyCalendar() {
            const grid = document.getElementById('monthlyCalendarGrid');
            const label = document.getElementById('calendarMonthLabel');
            if (!grid || !label) return;
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[calendarMonth]} ${calendarYear} (EST)`;
            
            const today = getESTToday();
            
            // Course dates
            let courseStart = null, courseEnd = null;
            if (schedulerSettings.startDate) {
                courseStart = parseESTDate(schedulerSettings.startDate);
                courseEnd = getCourseEndDate();
            }
            
            // Get first day of month and number of days
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Build class schedule map for quick lookup
            const classDays = {};
            allClasses.filter(c => c.status !== 'completed').forEach(cls => {
                // For each week of the course, calculate the actual date
                for (let week = 1; week <= 6; week++) {
                    const weekDates = getWeekDates(week);
                    if (!weekDates) continue;
                    
                    const dayOffset = cls.day === 'Saturday' ? 6 : 0;
                    const classDate = new Date(weekDates.start);
                    classDate.setDate(weekDates.start.getDate() + ((dayOffset - weekDates.start.getDay() + 7) % 7));
                    
                    const dateKey = `${classDate.getFullYear()}-${classDate.getMonth()}-${classDate.getDate()}`;
                    if (!classDays[dateKey]) classDays[dateKey] = [];
                    classDays[dateKey].push({ ...cls, week });
                }
            });
            
            // Store in global map for click handling
            calendarClassMap = { ...calendarClassMap, ...classDays };
            
            let html = '';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            // Previous month days
            const prevMonth = new Date(calendarYear, calendarMonth, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(calendarYear, calendarMonth, day);
                const dateKey = `${calendarYear}-${calendarMonth}-${day}`;
                const dayClasses = classDays[dateKey] || [];
                
                let classes = ['calendar-day'];
                if (currentDate.getTime() === today.getTime()) classes.push('today');
                if (courseStart && currentDate.getTime() === courseStart.getTime()) classes.push('course-start');
                if (courseEnd && currentDate.getTime() === courseEnd.getTime()) classes.push('course-end');
                if (dayClasses.length > 0) classes.push('has-class');
                
                // Find which week this falls in
                let weekNum = '';
                if (courseStart && currentDate >= courseStart && currentDate <= courseEnd) {
                    const diffDays = Math.floor((currentDate - courseStart) / (1000 * 60 * 60 * 24));
                    weekNum = `W${Math.floor(diffDays / 7) + 1}`;
                }
                
                // Make clickable if has classes
                const clickHandler = dayClasses.length > 0 ? `onclick="openCalendarDayClasses('${dateKey}')"` : '';
                
                html += `<div class="${classes.join(' ')}" ${clickHandler}>
                    <div class="calendar-day-number">${day}</div>
                    ${weekNum ? `<div class="calendar-week-label">${weekNum}</div>` : ''}
                    ${dayClasses.length > 0 ? `
                        <div>
                            ${dayClasses.map(c => `<span class="calendar-class-dot" style="background: ${getLevelColor(c.level)};" title="${LEVELS[c.level]} - ${c.time}" onclick="event.stopPropagation(); openClassDetails('${c.id}')"></span>`).join('')}
                        </div>
                        <div class="calendar-class-info">${dayClasses.length} class${dayClasses.length > 1 ? 'es' : ''}</div>
                    ` : ''}
                </div>`;
            }
            
            // Next month days
            const remainingCells = 42 - (startDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function getLevelColor(level) {
            const colors = { absolute: '#ff3366', novice: '#ff9900', beginner: '#ffff00', advanced: '#39ff14' };
            return colors[level] || '#888';
        }
        
        // Store calendar class data for click handling
        let calendarClassMap = {};
        
        function openCalendarDayClasses(dateKey) {
            // If only one class on this day, open its details directly
            const dayClasses = calendarClassMap[dateKey] || [];
            if (dayClasses.length === 1) {
                openClassDetails(dayClasses[0].id);
            } else if (dayClasses.length > 1) {
                // Show modal with clickable class options
                const container = document.getElementById('calendarClassPickerList');
                container.innerHTML = dayClasses.map(c => {
                    const teacher = allTeachers.find(t => t.id === c.teacherId);
                    return `
                        <div class="calendar-class-option" onclick="closeCalendarClassPicker(); openClassDetails('${c.id}');" style="padding: 12px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #00ffff; font-size: 14px; margin-bottom: 5px;">${c.time}</div>
                                    <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: #888;">Week ${c.week || '-'}</div>
                                    ${teacher ? `<div style="font-size: 11px; color: #39ff14;">ðŸ‘¨â€ðŸ« ${teacher.name}</div>` : ''}
                                    <div style="font-size: 11px; color: #ffff00;">${(c.students || []).length} students</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('calendarClassPickerModal').classList.add('active');
            }
        }
        
        function closeCalendarClassPicker() {
            document.getElementById('calendarClassPickerModal').classList.remove('active');
        }

        // ==================== COMPLETED STUDENTS ====================
        
        async function loadCompletedStudents() {
            const container = document.getElementById('completedStudentsContainer');
            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading completed students...</p>';
            
            try {
                const completedStudents = allStudents.filter(s => s.status === 'completed');
                
                if (completedStudents.length === 0) {
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No completed students yet.</p>';
                    updateCompletedStats(0, 0, 0, 0);
                    return;
                }
                
                // Get community status for each student
                const communitySnap = await db.collection('scheduler_community').get();
                const communityMap = {};
                communitySnap.docs.forEach(d => {
                    communityMap[d.id] = d.data().status;
                });
                
                const total = completedStudents.length;
                const joined = completedStudents.filter(s => communityMap[s.id] === 'joined').length;
                const notInterested = completedStudents.filter(s => communityMap[s.id] === 'not-interested').length;
                const pending = total - joined - notInterested;
                
                updateCompletedStats(total, joined, notInterested, pending);
                
                const isAdmin = currentUser?.role === 'admin';
                
                container.innerHTML = completedStudents.map(s => {
                    const status = communityMap[s.id] || 'pending';
                    const cls = allClasses.find(c => c.id === s.classId);
                    
                    return `
                        <div class="completed-item ${status}">
                            <div class="completed-item-info">
                                <div class="completed-item-name">${s.name}</div>
                                <div class="completed-item-details">ðŸ“§ ${s.email} | ðŸ“ž ${s.phone || 'No phone'}</div>
                                ${cls ? `<div class="completed-item-class">ðŸ“š ${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}</div>` : ''}
                            </div>
                            <div class="completed-item-actions">
                                ${status === 'pending' ? `
                                    <button class="community-btn join" onclick="setCommunityStatus('${s.id}', 'joined')">âœ“ Joined</button>
                                    <button class="community-btn not-interested" onclick="setCommunityStatus('${s.id}', 'not-interested')">âœ— Not Interested</button>
                                ` : `
                                    <div class="community-status ${status}">${status === 'joined' ? 'âœ… JOINED COMMUNITY' : 'âŒ NOT INTERESTED'}</div>
                                    <button class="btn btn-sm btn-secondary" onclick="setCommunityStatus('${s.id}', 'pending')">Reset</button>
                                `}
                                ${canDelete() ? `<button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteCompletedStudent('${s.id}')" style="margin-left: 5px;">ðŸ—‘ï¸</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) { 
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
            }
        }
        
        function updateCompletedStats(total, joined, notInterested, pending) {
            document.getElementById('completedTotalCount').textContent = total;
            document.getElementById('completedJoinedCount').textContent = joined;
            document.getElementById('completedNotInterestedCount').textContent = notInterested;
            document.getElementById('completedPendingCount').textContent = pending;
        }
        
        async function setCommunityStatus(studentId, status) {
            try {
                await db.collection('scheduler_community').doc(studentId).set({
                    studentId,
                    status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadCompletedStudents();
            } catch (e) { console.error(e); }
        }
        
        async function deleteCompletedStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) return;
            
            try {
                // Delete from scheduler_students
                await db.collection('scheduler_students').doc(studentId).delete();
                
                // Delete from scheduler_community
                await db.collection('scheduler_community').doc(studentId).delete();
                
                // Remove from local array
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) allStudents.splice(idx, 1);
                
                loadCompletedStudents();
                updateDashboardStats();
                alert('Student deleted successfully.');
            } catch (e) { 
                console.error(e);
                alert('Error deleting student: ' + e.message);
            }
        }
        
        // ==================== ADMIN COMPLETED CLASSES ====================
        
        let adminCompletedFilterDays = '7';
        let allAdminCompletedClasses = [];
        
        async function loadAdminCompletedClasses() {
            const container = document.getElementById('adminCompletedClassesContainer');
            if (!container) return;
            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading completed classes...</p>';
            
            try {
                // Get ALL completed classes (from all teachers)
                const snap = await db.collection('scheduler_classes')
                    .where('status', '==', 'completed')
                    .get();
                
                allAdminCompletedClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                renderAdminFilteredCompletedClasses();
            } catch (e) {
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
            }
        }
        
        function filterAdminCompletedClasses(days) {
            adminCompletedFilterDays = days;
            
            document.querySelectorAll('.admin-completed-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.days === days) {
                    btn.classList.add('active');
                }
            });
            
            renderAdminFilteredCompletedClasses();
        }
        
        function renderAdminFilteredCompletedClasses() {
            const container = document.getElementById('adminCompletedClassesContainer');
            if (!container) return;
            
            let filteredClasses = allAdminCompletedClasses;
            
            // Apply date filter
            if (adminCompletedFilterDays !== 'all') {
                const daysAgo = parseInt(adminCompletedFilterDays);
                const cutoffDate = getESTDate();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                cutoffDate.setHours(0, 0, 0, 0);
                
                filteredClasses = allAdminCompletedClasses.filter(c => {
                    if (!c.completedAt) return false;
                    const completedDate = c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt);
                    return completedDate >= cutoffDate;
                });
            }
            
            // Calculate stats
            let totalStudents = 0;
            let joinedCount = 0;
            let declinedCount = 0;
            let pendingCount = 0;
            
            filteredClasses.forEach(c => {
                const students = c.students || [];
                const academyStatus = c.academyStatus || {};
                students.forEach(s => {
                    totalStudents++;
                    const status = academyStatus[s.id];
                    if (status === 'yes') joinedCount++;
                    else if (status === 'no') declinedCount++;
                    else pendingCount++;
                });
            });
            
            updateCompletedStats(totalStudents, joinedCount, declinedCount, pendingCount);
            
            if (filteredClasses.length === 0) {
                const filterLabel = adminCompletedFilterDays === 'all' ? '' : ` in the last ${adminCompletedFilterDays} days`;
                container.innerHTML = `<p style="color: #888; font-size: 12px;">No completed classes${filterLabel}.</p>`;
                return;
            }
            
            // Sort by completedAt (most recent first)
            filteredClasses.sort((a, b) => {
                const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt || 0);
                const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt || 0);
                return dateB - dateA;
            });
            
            container.innerHTML = filteredClasses.map(c => {
                const teacher = allTeachers.find(t => t.id === c.teacherId);
                const teacherName = teacher ? teacher.name : 'Unknown Teacher';
                const startDateDisplay = c.startDate ? formatDateInEST(c.startDate, { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                const completedDateDisplay = c.completedAt ? 
                    (c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt)).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 
                    'Unknown';
                
                return `
                    <div class="class-card completed-class" style="margin-bottom: 15px;">
                        <div class="class-header">
                            <div>
                                <div class="class-day">${c.day}</div>
                                <div class="class-time">${c.time} EST</div>
                                <div style="font-size: 11px; color: #39ff14; margin-top: 3px;">ðŸ‘¨â€ðŸ« ${teacherName}</div>
                                <div style="font-size: 11px; color: #888; margin-top: 2px;">ðŸ“… Started: ${startDateDisplay}</div>
                                <div style="font-size: 11px; color: #00ffff; margin-top: 2px;">âœ… Completed: ${completedDateDisplay}</div>
                            </div>
                            <div style="text-align: right;">
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            </div>
                        </div>
                        
                        <h4 style="color: #ffff00; font-size: 13px; margin: 15px 0 10px 0;">1-Year Academy Status</h4>
                        <div style="display: grid; gap: 8px;">
                            ${(c.students || []).map(s => {
                                const academyStatus = c.academyStatus?.[s.id] || 'pending';
                                const statusDisplay = academyStatus === 'yes' ? 
                                    '<span style="color: #39ff14; font-size: 11px;">âœ… YES - Joined</span>' :
                                    academyStatus === 'no' ? 
                                    '<span style="color: #ff3366; font-size: 11px;">âŒ NO - Declined</span>' :
                                    '<span style="color: #ffff00; font-size: 11px;">â³ Pending</span>';
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                        <span style="cursor: pointer; text-decoration: underline; color: #00ffff; font-size: 12px;" onclick="openStudentAnalyticsMenu('${s.id}', '${s.name.replace(/'/g, "\\'")}', '${(s.email || '').replace(/'/g, "\\'")}')">${s.name}</span>
                                        ${statusDisplay}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== ADMIN TEACHER VIEW ====================
        
        let adminViewingTeacherId = null;
        let adminViewingTeacherClasses = [];
        
        function loadTeacherButtonsForAdmin() {
            const container = document.getElementById('teacherButtonsContainer');
            if (!container) return;
            
            if (allTeachers.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No teachers found. Add teachers in the Teachers tab.</p>';
                return;
            }
            
            container.innerHTML = allTeachers.map(t => `
                <button class="btn btn-sm teacher-select-btn ${adminViewingTeacherId === t.id ? 'active' : ''}" onclick="loadAdminTeacherView('${t.id}', '${t.name.replace(/'/g, "\\'")}')">${t.name}</button>
            `).join('');
        }
        
        async function loadAdminTeacherView(teacherId, teacherName) {
            adminViewingTeacherId = teacherId;
            
            // Update button states
            document.querySelectorAll('.teacher-select-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('adminViewingTeacherName').textContent = teacherName;
            document.getElementById('adminTeacherViewContainer').style.display = 'block';
            
            // Load teacher's classes
            try {
                const snap = await db.collection('scheduler_classes')
                    .where('teacherId', '==', teacherId)
                    .get();
                
                adminViewingTeacherClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Also store in allClassesForTeacher so openStudentAnalyticsMenu can find student emails
                allClassesForTeacher = adminViewingTeacherClasses;
                
                // Load attendance data
                const attendanceData = {};
                for (const cls of adminViewingTeacherClasses) {
                    const attendanceSnap = await db.collection('scheduler_attendance')
                        .where('classId', '==', cls.id)
                        .get();
                    attendanceData[cls.id] = {};
                    attendanceSnap.docs.forEach(doc => {
                        const data = doc.data();
                        attendanceData[cls.id][`${data.studentId}_${data.week}`] = data.status;
                    });
                }
                
                // Store attendance data for rendering
                window.adminTeacherAttendanceData = attendanceData;
                
                // Default to Today view
                switchAdminTeacherViewTab('today');
                
            } catch (e) {
                console.error(e);
                document.getElementById('adminTeacherTodayView').innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error loading classes: ${e.message}</p>`;
            }
        }
        
        function closeAdminTeacherView() {
            adminViewingTeacherId = null;
            document.getElementById('adminTeacherViewContainer').style.display = 'none';
            document.querySelectorAll('.teacher-select-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        function switchAdminTeacherViewTab(tab) {
            document.querySelectorAll('.admin-teacher-view-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) btn.classList.add('active');
            });
            
            document.getElementById('adminTeacherTodayView').style.display = tab === 'today' ? 'block' : 'none';
            document.getElementById('adminTeacherClassesView').style.display = tab === 'classes' ? 'block' : 'none';
            
            if (tab === 'today') {
                renderAdminTeacherTodayView();
            } else {
                renderAdminTeacherClassesView();
            }
        }
        
        function renderAdminTeacherTodayView() {
            const container = document.getElementById('adminTeacherTodayView');
            const activeClasses = adminViewingTeacherClasses.filter(c => c.status !== 'completed');
            
            const todayEST = getESTToday();
            const todayDayName = getESTDayName();
            
            // Get active classes for today
            const todaysClasses = activeClasses.filter(c => {
                if (!c.startDate) return false;
                const startDate = parseESTDate(c.startDate);
                return isDateOnOrAfter(todayEST, startDate) && c.day === todayDayName;
            });
            
            // Get prescheduled classes starting today
            const todaysPreschedules = allPrescheduledSlots.filter(ps => {
                if (ps.teacherId !== adminViewingTeacherId) return false;
                if (ps.day !== todayDayName) return false;
                if (!ps.startDate) return false;
                const startDate = parseLocalDate(ps.startDate);
                if (!startDate) return false;
                // Check if start date is today or before today
                const todayStart = new Date(todayEST);
                todayStart.setHours(0, 0, 0, 0);
                const startDateOnly = new Date(startDate);
                startDateOnly.setHours(0, 0, 0, 0);
                return startDateOnly <= todayStart;
            });
            
            if (todaysClasses.length === 0 && todaysPreschedules.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 40px; margin-bottom: 15px;">ðŸ“…</div>
                        <p style="color: #888; font-size: 13px;">No classes scheduled for today (${todayDayName} EST).</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Render active classes
            if (todaysClasses.length > 0) {
                html += todaysClasses.map(c => renderAdminTeacherClassCard(c, true)).join('');
            }
            
            // Render prescheduled classes starting today
            if (todaysPreschedules.length > 0) {
                html += '<div style="margin-top: 15px;"><h4 style="color: #ff9800; margin-bottom: 10px; font-size: 12px;">â³ Pre-scheduled (Starting Today)</h4>';
                html += todaysPreschedules.map(ps => renderPrescheduleCardForToday(ps)).join('');
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function renderPrescheduleCardForToday(ps) {
            const classTypeName = LEVELS[ps.classType] || ps.classType || 'Class';
            const enrolledStudents = ps.enrolledStudents || [];
            const linkedCount = enrolledStudents.filter(s => s.odId || s.id).length;
            
            return `
                <div class="class-card" style="border: 2px solid #ff9800; background: rgba(255,152,0,0.15);">
                    <div class="class-header">
                        <div>
                            <div class="class-day" style="color: #ff9800;">${ps.day}</div>
                            <div class="class-time">${ps.time} EST</div>
                        </div>
                        <div style="text-align: right;">
                            <span class="level-badge level-${ps.classType}" style="border-color: #ff9800;">${classTypeName}</span>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 8px; margin-top: 10px;">
                        <div style="font-size: 24px; margin-bottom: 5px;">ðŸš€</div>
                        <p style="color: #39ff14; font-size: 14px; margin: 0; font-weight: bold;">Starting Today!</p>
                        <p style="color: #fff; font-size: 13px; margin: 5px 0;">${enrolledStudents.length} students enrolled</p>
                        ${linkedCount < enrolledStudents.length ? `<p style="color: #ff9800; font-size: 11px; margin: 0;">âš ï¸ ${enrolledStudents.length - linkedCount} not linked to accounts</p>` : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        <p style="color: #888; font-size: 11px; margin-bottom: 5px;">Students:</p>
                        ${enrolledStudents.map(s => `
                            <div style="display: flex; align-items: center; gap: 5px; padding: 3px 0;">
                                <span style="color: ${s.odId || s.id ? '#39ff14' : '#ff9800'}; font-size: 11px;">${s.odId || s.id ? 'âœ…' : 'âš ï¸'}</span>
                                <span style="color: #fff; font-size: 12px;">${s.name || s.linkedName || 'Unknown'}</span>
                                ${s.discord ? `<span style="color: #7289da; font-size: 10px; margin-left: 5px;">ðŸ’¬ ${s.discord}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderAdminTeacherClassesView() {
            const container = document.getElementById('adminTeacherClassesView');
            const activeClasses = adminViewingTeacherClasses.filter(c => c.status !== 'completed');
            
            // Get prescheduled slots for this teacher
            const teacherPreschedules = allPrescheduledSlots.filter(ps => ps.teacherId === adminViewingTeacherId);
            
            if (activeClasses.length === 0 && teacherPreschedules.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No active classes for this teacher.</p>';
                return;
            }
            
            let html = '';
            
            // Show active classes first
            if (activeClasses.length > 0) {
                html += activeClasses.map(c => renderAdminTeacherClassCard(c, false)).join('');
            }
            
            // Show prescheduled classes at the bottom
            if (teacherPreschedules.length > 0) {
                html += '<div style="margin-top: 20px;"><h4 style="color: #ff9800; margin-bottom: 10px; font-size: 13px;">â³ Pre-scheduled Classes</h4>';
                html += teacherPreschedules.map(ps => {
                    const startDate = parseLocalDate(ps.startDate);
                    const startDateStr = startDate ? startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
                    const classTypeName = LEVELS[ps.classType] || ps.classType || 'Class';
                    const enrolledStudents = ps.enrolledStudents || [];
                    const linkedCount = enrolledStudents.filter(s => s.odId || s.id).length;
                    
                    // Calculate days until start
                    let daysUntilStart = '';
                    let startingSoon = false;
                    if (startDate) {
                        const now = new Date();
                        const diffTime = startDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysUntilStart = `(in ${diffDays} day${diffDays > 1 ? 's' : ''})`;
                        } else if (diffDays <= 0) {
                            daysUntilStart = '(Starting!)';
                            startingSoon = true;
                        }
                    }
                    
                    return `
                        <div class="class-card" style="border: 2px solid ${startingSoon ? '#39ff14' : '#ff9800'}; background: rgba(${startingSoon ? '57,255,20' : '255,152,0'},0.1);">
                            <div class="class-header">
                                <div>
                                    <div class="class-day" style="color: ${startingSoon ? '#39ff14' : '#ff9800'};">${ps.day}</div>
                                    <div class="class-time">${ps.time} EST</div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="level-badge level-${ps.classType}" style="border-color: ${startingSoon ? '#39ff14' : '#ff9800'};">${classTypeName}</span>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(${startingSoon ? '57,255,20' : '255,152,0'},0.1); border-radius: 8px; margin-top: 10px;">
                                <div style="font-size: 24px; margin-bottom: 5px;">${startingSoon ? 'ðŸš€' : 'â³'}</div>
                                <p style="color: ${startingSoon ? '#39ff14' : '#ff9800'}; font-size: 14px; margin: 0; font-weight: bold;">${startingSoon ? 'Starting!' : 'Pre-scheduled'}</p>
                                <p style="color: #fff; font-size: 13px; margin: 5px 0;">Starts: ${startDateStr}</p>
                                <p style="color: #ffff00; font-size: 12px; margin: 0;">${daysUntilStart}</p>
                            </div>
                            ${enrolledStudents.length > 0 ? `
                                <div style="margin-top: 15px;">
                                    <h4 style="color: #00ffff; font-size: 12px; margin-bottom: 8px;">ðŸ‘¥ Enrolled Students (${enrolledStudents.length})</h4>
                                    <div style="display: grid; gap: 6px;">
                                        ${enrolledStudents.map(s => {
                                            const isLinked = s.odId || s.id;
                                            const studentName = s.name || s.linkedName || 'Unknown';
                                            const studentEmail = s.email || s.linkedEmail || '';
                                            const studentDiscord = s.discord || '';
                                            return `
                                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                                    <div>
                                                        <span style="color: ${isLinked ? '#39ff14' : '#ff9800'}; font-size: 11px;">${isLinked ? 'âœ…' : 'âš ï¸'}</span>
                                                        <span style="color: #fff; font-size: 12px; margin-left: 5px;">${studentName}</span>
                                                        ${studentDiscord ? `<span style="color: #7289da; font-size: 10px; margin-left: 8px;">ðŸ’¬ ${studentDiscord}</span>` : ''}
                                                    </div>
                                                    ${studentEmail ? `<span style="color: #888; font-size: 10px;">${studentEmail}</span>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ${linkedCount < enrolledStudents.length ? `<p style="color: #ff9800; font-size: 10px; margin-top: 8px;">âš ï¸ ${enrolledStudents.length - linkedCount} student(s) not linked to accounts</p>` : ''}
                                </div>
                            ` : `
                                <div style="margin-top: 15px; text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                    <p style="color: #888; font-size: 12px; margin: 0;">No students enrolled yet</p>
                                </div>
                            `}
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function renderAdminTeacherClassCard(c, isToday) {
            const attendanceData = window.adminTeacherAttendanceData || {};
            
            function getClassWeekDates(cls, weekNum) {
                if (!cls.startDate) return null;
                const startDate = parseESTDate(cls.startDate);
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + (weekNum - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                return { start: weekStart, end: weekEnd };
            }
            
            function getClassCurrentWeek(cls) {
                if (!cls.startDate) return null;
                const startDate = parseESTDate(cls.startDate);
                const todayDate = getESTToday();
                if (todayDate < startDate) return 0;
                const daysSinceStart = getDaysBetween(todayDate, startDate);
                return Math.min(Math.floor(daysSinceStart / 7) + 1, 7);
            }
            
            function formatDateRange(start, end) {
                const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                return `${formatDate(start)}-${formatDate(end)}`;
            }
            
            function isWeekAttendanceComplete(cls, weekNum) {
                const students = cls.students || [];
                if (students.length === 0) return false;
                const classAttendance = attendanceData[cls.id] || {};
                return students.every(s => {
                    const key = `${s.id}_${weekNum}`;
                    return classAttendance[key] && ['present', 'late', 'absent'].includes(classAttendance[key]);
                });
            }
            
            function getAttendanceStatus(classId, studentId, week) {
                const classAttendance = attendanceData[classId] || {};
                return classAttendance[`${studentId}_${week}`] || '';
            }
            
            const currentWeek = getClassCurrentWeek(c);
            const startDateDisplay = c.startDate ? formatDateInEST(c.startDate, { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set';
            
            // Build week tracker
            let weekTrackerHtml = '<div class="class-week-tracker">';
            for (let w = 1; w <= 6; w++) {
                const weekDates = getClassWeekDates(c, w);
                const dateRange = weekDates ? formatDateRange(weekDates.start, weekDates.end) : '';
                const isCompleted = isWeekAttendanceComplete(c, w) && currentWeek > w;
                const isCurrent = currentWeek === w;
                const isFuture = currentWeek < w;
                
                let weekClass = 'class-week-box';
                if (isCompleted) weekClass += ' completed';
                else if (isCurrent) weekClass += ' current';
                else if (isFuture) weekClass += ' future';
                
                weekTrackerHtml += `
                    <div class="${weekClass}" onclick="showClassMaterial('${c.level}', ${w})" style="cursor: pointer;" title="Click to view Week ${w} materials">
                        <span class="week-label">Week ${w}</span>
                        <span class="week-dates">${dateRange}</span>
                        <span style="font-size: 9px; color: #9c27b0;">ðŸ“–</span>
                    </div>
                `;
            }
            weekTrackerHtml += '</div>';
            
            const attendanceWeek = currentWeek > 0 && currentWeek <= 6 ? currentWeek : 1;
            
            return `
                <div class="class-card ${isToday ? 'today-class' : ''}" style="margin-bottom: 15px;">
                    <div class="class-header">
                        <div>
                            <div class="class-day">${c.day}</div>
                            <div class="class-time">${c.time} EST</div>
                            <div style="font-size: 11px; color: #00ffff; margin-top: 3px;">ðŸ“… Started: ${startDateDisplay}</div>
                        </div>
                        <div style="text-align: right;">
                            <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                            ${isToday ? '<div style="font-size: 11px; color: #39ff14; margin-top: 5px;">ðŸ“ TODAY</div>' : ''}
                        </div>
                    </div>
                    
                    ${weekTrackerHtml}
                    <p style="font-size: 10px; color: #888; text-align: center; margin: 5px 0;">ðŸ‘† Click any week to view materials</p>
                    
                    ${currentWeek >= 1 && currentWeek <= 6 ? `
                        <h4 style="color: #ffff00; font-size: 13px; margin: 10px 0;">Attendance - Week ${attendanceWeek}</h4>
                        <div style="display: grid; gap: 10px;">
                            ${(c.students || []).map(s => {
                                const studentName = s.name || 'Unknown';
                                const studentEmail = s.email || '';
                                const status = getAttendanceStatus(c.id, s.id, attendanceWeek);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                        <span style="cursor: pointer; text-decoration: underline; color: #00ffff; font-size: 12px;" onclick="openStudentAnalyticsMenu('${s.id}', '${studentName.replace(/'/g, "\\'")}', '${studentEmail.replace(/'/g, "\\'")}')">${studentName}</span>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="attendance-btn present ${status === 'present' ? 'active' : ''}" onclick="markAttendanceAsAdmin('${c.id}', '${s.id}', 'present', ${attendanceWeek})">P</button>
                                            <button class="attendance-btn late ${status === 'late' ? 'active' : ''}" onclick="markAttendanceAsAdmin('${c.id}', '${s.id}', 'late', ${attendanceWeek})">L</button>
                                            <button class="attendance-btn absent ${status === 'absent' ? 'active' : ''}" onclick="handleAbsentClickAsAdmin('${c.id}', '${s.id}', '${studentName.replace(/'/g, "\\'")}', ${attendanceWeek})">A</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : currentWeek > 6 ? `
                        <div style="text-align: center; padding: 15px; background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 8px;">
                            <p style="color: #39ff14; font-size: 13px; margin: 0;">ðŸŽ“ Course Complete!</p>
                        </div>
                    ` : `
                        <div style="margin-top: 15px;">
                            <h4 style="color: #00ffff; font-size: 12px; margin-bottom: 8px;">ðŸ‘¥ Enrolled Students (${(c.students || []).length})</h4>
                            ${(c.students || []).length > 0 ? `
                                <div style="display: grid; gap: 6px;">
                                    ${(c.students || []).map(s => {
                                        const studentName = s.name || 'Unknown';
                                        const studentEmail = s.email || '';
                                        return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                            <div>
                                                <span style="color: ${s.isLinked !== false ? '#39ff14' : '#ff9800'}; font-size: 11px;">${s.isLinked !== false ? 'âœ…' : 'âš ï¸'}</span>
                                                <span style="color: #00ffff; font-size: 12px; margin-left: 5px; cursor: pointer; text-decoration: underline;" onclick="openStudentAnalyticsMenu('${s.id}', '${studentName.replace(/'/g, "\\'")}', '${studentEmail.replace(/'/g, "\\'")}')">${studentName}</span>
                                                ${s.discord ? `<span style="color: #7289da; font-size: 10px; margin-left: 8px;">ðŸ’¬ ${s.discord}</span>` : ''}
                                            </div>
                                            ${studentEmail ? `<span style="color: #888; font-size: 10px;">${studentEmail}</span>` : ''}
                                        </div>
                                    `;}).join('')}
                                </div>
                            ` : `
                                <p style="color: #888; font-size: 12px; text-align: center;">No students enrolled yet.</p>
                            `}
                            <div style="margin-top: 10px; padding: 10px; background: rgba(255,152,0,0.1); border: 1px solid #ff9800; border-radius: 6px; text-align: center;">
                                <p style="color: #ff9800; font-size: 11px; margin: 0;">â³ Attendance will be available when the class starts.</p>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }
        
        // ==================== MOVE STUDENT ====================
        
        let selectedMoveClassId = null;
        
        function openMoveStudentModal(studentId, studentName, fromClassId) {
            document.getElementById('moveStudentId').value = studentId;
            document.getElementById('moveFromClassId').value = fromClassId;
            document.getElementById('moveStudentName').textContent = studentName;
            document.getElementById('returnToPoolCheckbox').checked = false;
            selectedMoveClassId = null;
            
            renderMoveClassOptions(studentId, fromClassId);
            document.getElementById('moveToClassSection').style.display = 'block';
            document.getElementById('moveStudentModal').classList.add('active');
        }
        
        function closeMoveStudentModal() {
            document.getElementById('moveStudentModal').classList.remove('active');
        }
        
        function toggleMoveOptions() {
            const returnToPool = document.getElementById('returnToPoolCheckbox').checked;
            document.getElementById('moveToClassSection').style.display = returnToPool ? 'none' : 'block';
        }
        
        function renderMoveClassOptions(studentId, fromClassId) {
            const container = document.getElementById('moveClassOptions');
            const student = allStudents.find(s => s.id === studentId);
            
            // Show all active classes except the current one
            const availableClasses = allClasses.filter(c => c.id !== fromClassId && c.status !== 'completed');
            
            if (availableClasses.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No other classes available.</p>';
                return;
            }
            
            container.innerHTML = availableClasses.map(c => {
                const teacher = allTeachers.find(t => t.id === c.teacherId);
                const studentCount = (c.students || []).length;
                const isFull = studentCount >= schedulerSettings.maxStudents;
                const levelMatch = student && student.level === c.level;
                
                return `
                    <div class="move-student-class ${selectedMoveClassId === c.id ? 'selected' : ''}" onclick="selectMoveClass('${c.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #00ffff; font-size: 13px;">${c.day} @ ${c.time}</div>
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                ${!levelMatch ? '<span style="color: #ff9900; font-size: 11px;"> âš ï¸ Level mismatch</span>' : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: ${isFull ? '#ff9800' : '#39ff14'};">
                                    ðŸ‘¥ ${studentCount}/${schedulerSettings.maxStudents} ${isFull ? 'âš ï¸ FULL' : ''}
                                </div>
                                <div style="font-size: 11px; color: #888;">${teacher ? teacher.name : 'No teacher'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectMoveClass(classId) {
            selectedMoveClassId = classId;
            document.querySelectorAll('.move-student-class').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
        
        async function confirmMoveStudent() {
            const studentId = document.getElementById('moveStudentId').value;
            const fromClassId = document.getElementById('moveFromClassId').value;
            const returnToPool = document.getElementById('returnToPoolCheckbox').checked;
            
            if (returnToPool) {
                // Return student to pool for reassignment
                await returnStudentToPool(studentId, fromClassId);
            } else if (selectedMoveClassId) {
                // Move to selected class
                await moveStudentToClass(studentId, fromClassId, selectedMoveClassId);
            } else {
                alert('Please select a destination class or check "Return to pool".');
                return;
            }
            
            closeMoveStudentModal();
        }
        
        async function returnStudentToPool(studentId, fromClassId) {
            try {
                // Remove from current class
                const fromClass = allClasses.find(c => c.id === fromClassId);
                const student = allStudents.find(s => s.id === studentId);
                
                if (fromClass) {
                    const updatedStudents = (fromClass.students || []).filter(s => s.id !== studentId);
                    await db.collection('scheduler_classes').doc(fromClassId).update({ students: updatedStudents });
                    fromClass.students = updatedStudents;
                }
                
                // Update student status back to pending/limbo
                await db.collection('scheduler_students').doc(studentId).update({ 
                    status: 'pending', 
                    classId: null 
                });
                
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) {
                    allStudents[idx].status = 'pending';
                    allStudents[idx].classId = null;
                }
                
                // Log the action
                await db.collection('scheduler_move_history').add({
                    studentId: studentId,
                    studentName: student?.name || 'Unknown',
                    fromClassId: fromClassId,
                    fromClassInfo: fromClass ? `${fromClass.day} @ ${fromClass.time} - ${LEVELS[fromClass.level]}` : 'Unknown',
                    toClassId: null,
                    toClassInfo: 'Returned to Pool',
                    movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                    movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reason: 'Schedule changed - returned to pool for reassignment'
                });
                
                renderStudentsTable();
                renderClasses();
                updateDashboardStats();
                alert('Student returned to pool for reassignment.');
            } catch (e) { 
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        async function moveStudentToClass(studentId, fromClassId, toClassId) {
            try {
                const student = allStudents.find(s => s.id === studentId);
                
                // Remove from current class
                const fromClass = allClasses.find(c => c.id === fromClassId);
                if (fromClass) {
                    const updatedStudents = (fromClass.students || []).filter(s => s.id !== studentId);
                    await db.collection('scheduler_classes').doc(fromClassId).update({ students: updatedStudents });
                    fromClass.students = updatedStudents;
                }
                
                // Add to new class
                const toClass = allClasses.find(c => c.id === toClassId);
                if (toClass && student) {
                    const slot = `${toClass.day}-${toClass.time}`;
                    let rank = 3; // Default to 3rd preference
                    if (student.availabilities) {
                        for (let r = 1; r <= 3; r++) {
                            if (student.availabilities[r] === slot) { rank = r; break; }
                        }
                    }
                    
                    const newStudent = { id: student.id, name: student.name, rank, timezone: student.timezone };
                    const updatedStudents = [...(toClass.students || []), newStudent];
                    await db.collection('scheduler_classes').doc(toClassId).update({ students: updatedStudents });
                    toClass.students = updatedStudents;
                    
                    // Update student record
                    await db.collection('scheduler_students').doc(studentId).update({ classId: toClassId });
                    student.classId = toClassId;
                }
                
                // Log the move action
                await db.collection('scheduler_move_history').add({
                    studentId: studentId,
                    studentName: student?.name || 'Unknown',
                    fromClassId: fromClassId,
                    fromClassInfo: fromClass ? `${fromClass.day} @ ${fromClass.time} - ${LEVELS[fromClass.level]}` : 'Unknown',
                    toClassId: toClassId,
                    toClassInfo: toClass ? `${toClass.day} @ ${toClass.time} - ${LEVELS[toClass.level]}` : 'Unknown',
                    movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                    movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reason: 'Manual move'
                });
                
                renderClasses();
                updateDashboardStats();
                alert('Student moved successfully!');
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        // ==================== REMOVE STUDENT FROM CLASS ====================
        
        async function confirmRemoveStudentFromClass(studentId, studentName, classId) {
            const action = await showRemoveStudentDialog(studentName);
            if (!action) return;
            
            try {
                const cls = allClasses.find(c => c.id === classId);
                if (!cls) {
                    alert('Class not found.');
                    return;
                }
                
                // Remove student from class
                const updatedStudents = (cls.students || []).filter(s => s.id !== studentId);
                await db.collection('scheduler_classes').doc(classId).update({ students: updatedStudents });
                cls.students = updatedStudents;
                
                if (action === 'pool') {
                    // Return to pool for reassignment
                    await db.collection('scheduler_students').doc(studentId).update({ 
                        status: 'pending', 
                        classId: null 
                    });
                    
                    const idx = allStudents.findIndex(s => s.id === studentId);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].classId = null;
                    }
                    
                    // Log the action
                    await db.collection('scheduler_move_history').add({
                        studentId: studentId,
                        studentName: studentName,
                        fromClassId: classId,
                        fromClassInfo: `${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}`,
                        toClassId: null,
                        toClassInfo: 'Returned to Pool',
                        movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                        movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reason: 'Removed from class - returned to pool'
                    });
                    
                    alert(`${studentName} has been removed and returned to the student pool.`);
                } else if (action === 'drop') {
                    // Mark as dropped/inactive
                    await db.collection('scheduler_students').doc(studentId).update({ 
                        status: 'dropped', 
                        classId: null,
                        droppedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        droppedFrom: classId
                    });
                    
                    const idx = allStudents.findIndex(s => s.id === studentId);
                    if (idx !== -1) {
                        allStudents[idx].status = 'dropped';
                        allStudents[idx].classId = null;
                    }
                    
                    // Log the action
                    await db.collection('scheduler_move_history').add({
                        studentId: studentId,
                        studentName: studentName,
                        fromClassId: classId,
                        fromClassInfo: `${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}`,
                        toClassId: null,
                        toClassInfo: 'Dropped',
                        movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                        movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reason: 'Dropped from class'
                    });
                    
                    alert(`${studentName} has been marked as dropped.`);
                }
                
                closeClassDetailsModal();
                renderClasses();
                renderStudentsTable();
                updateDashboardStats();
                
            } catch (e) {
                console.error(e);
                alert('Error removing student: ' + e.message);
            }
        }
        
        function showRemoveStudentDialog(studentName) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'removeStudentDialog';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <h3 class="modal-title">ðŸ—‘ï¸ Remove Student</h3>
                        <p style="font-size: 13px; margin-bottom: 20px;">
                            Remove <strong style="color: #00ffff;">${studentName}</strong> from this class?
                        </p>
                        <p style="font-size: 12px; color: #888; margin-bottom: 20px;">Choose what happens to the student:</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-warning" onclick="document.getElementById('removeStudentDialog').remove(); window.removeStudentResolve('pool');" style="width: 100%; padding: 12px;">
                                ðŸ“‹ Return to Student Pool
                                <div style="font-size: 10px; color: #888; margin-top: 3px;">Student can be reassigned to another class</div>
                            </button>
                            <button class="btn btn-danger" onclick="document.getElementById('removeStudentDialog').remove(); window.removeStudentResolve('drop');" style="width: 100%; padding: 12px;">
                                âŒ Mark as Dropped
                                <div style="font-size: 10px; color: #888; margin-top: 3px;">Student left the program</div>
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('removeStudentDialog').remove(); window.removeStudentResolve(null);" style="width: 100%; padding: 10px;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                window.removeStudentResolve = resolve;
            });
        }
        
        // ==================== MOVE HISTORY ====================
        
        let allMoveHistory = [];
        
        async function loadMoveHistory() {
            const container = document.getElementById('moveHistoryList');
            container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Loading move history...</p>';
            
            try {
                const snap = await db.collection('scheduler_move_history')
                    .orderBy('movedAt', 'desc')
                    .limit(100)
                    .get();
                
                allMoveHistory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Update stats
                const totalMoves = allMoveHistory.length;
                const movedToClass = allMoveHistory.filter(m => m.toClassId && m.toClassInfo !== 'Returned to Pool' && m.toClassInfo !== 'Dropped').length;
                const returnedToPool = allMoveHistory.filter(m => m.toClassInfo === 'Returned to Pool').length;
                const dropped = allMoveHistory.filter(m => m.toClassInfo === 'Dropped').length;
                
                document.getElementById('moveHistoryTotal').textContent = totalMoves;
                document.getElementById('moveHistoryMoved').textContent = movedToClass;
                document.getElementById('moveHistoryPool').textContent = returnedToPool;
                document.getElementById('moveHistoryDropped').textContent = dropped;
                
                renderMoveHistoryList();
                
            } catch (e) {
                console.error('Error loading move history:', e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error loading move history: ${e.message}</p>`;
            }
        }
        
        function filterMoveHistory() {
            renderMoveHistoryList();
        }
        
        function renderMoveHistoryList() {
            const container = document.getElementById('moveHistoryList');
            const searchTerm = document.getElementById('moveHistorySearch').value.toLowerCase();
            const filterType = document.getElementById('moveHistoryFilter').value;
            
            let filtered = allMoveHistory;
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(m => 
                    (m.studentName || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply type filter
            if (filterType === 'moved') {
                filtered = filtered.filter(m => m.toClassId && m.toClassInfo !== 'Returned to Pool' && m.toClassInfo !== 'Dropped');
            } else if (filterType === 'pool') {
                filtered = filtered.filter(m => m.toClassInfo === 'Returned to Pool');
            } else if (filterType === 'dropped') {
                filtered = filtered.filter(m => m.toClassInfo === 'Dropped');
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">No move history found.</p>';
                return;
            }
            
            container.innerHTML = filtered.map(m => {
                const date = m.movedAt?.toDate ? m.movedAt.toDate() : new Date(m.movedAt);
                const dateStr = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
                
                let actionType = 'moved';
                let actionColor = '#00ffff';
                let actionIcon = 'ðŸ”„';
                let actionLabel = 'Moved';
                
                if (m.toClassInfo === 'Returned to Pool') {
                    actionType = 'pool';
                    actionColor = '#ffaa00';
                    actionIcon = 'ðŸ“‹';
                    actionLabel = 'Returned to Pool';
                } else if (m.toClassInfo === 'Dropped') {
                    actionType = 'dropped';
                    actionColor = '#ff3366';
                    actionIcon = 'âŒ';
                    actionLabel = 'Dropped';
                }
                
                return `
                    <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${actionColor};">
                        <div style="font-size: 24px;">${actionIcon}</div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: #fff; font-size: 14px;">${escapeHtml(m.studentName || 'Unknown')}</div>
                                    <div style="font-size: 12px; color: #888; margin-top: 3px;">
                                        From: <span style="color: #ff9800;">${escapeHtml(m.fromClassInfo || 'Unknown')}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #888;">
                                        To: <span style="color: ${actionColor};">${escapeHtml(m.toClassInfo || 'Unknown')}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 11px; color: #888;">${dateStr}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">by ${escapeHtml(m.movedBy || 'Unknown')}</div>
                                    <span style="display: inline-block; margin-top: 5px; padding: 3px 8px; border-radius: 12px; font-size: 10px; background: ${actionColor}22; color: ${actionColor}; border: 1px solid ${actionColor}44;">${actionLabel}</span>
                                </div>
                            </div>
                            ${m.reason ? `<div style="font-size: 11px; color: #aaa; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 5px;">ðŸ’¬ ${escapeHtml(m.reason)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== MARK COURSE COMPLETE ====================
        
        async function markCourseComplete(classId) {
            if (!confirm('Mark this class as completed? This will move all students to the Completed section and free up the time slot.')) return;
            
            try {
                const cls = allClasses.find(c => c.id === classId);
                if (!cls) return;
                
                // Update class status
                await db.collection('scheduler_classes').doc(classId).update({ status: 'completed' });
                cls.status = 'completed';
                
                // Update all students in this class to completed
                for (const student of (cls.students || [])) {
                    await db.collection('scheduler_students').doc(student.id).update({ status: 'completed' });
                    const idx = allStudents.findIndex(s => s.id === student.id);
                    if (idx !== -1) allStudents[idx].status = 'completed';
                }
                
                renderClasses();
                renderStudentsTable();
                updateDashboardStats();
                alert('Class marked as completed! Students moved to Completed section.');
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteClass(classId) {
            const cls = allClasses.find(c => c.id === classId);
            if (!cls) return;
            
            const studentCount = (cls.students || []).length;
            let confirmMsg = `Are you sure you want to DELETE this class?\n\n${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}`;
            
            if (studentCount > 0) {
                confirmMsg += `\n\nâš ï¸ This class has ${studentCount} student(s). They will be returned to the student pool for reassignment.`;
            }
            
            confirmMsg += '\n\nThis action cannot be undone.';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Return students to pool (handle missing documents gracefully)
                for (const student of (cls.students || [])) {
                    try {
                        // Check if student document exists first
                        const studentDoc = await db.collection('scheduler_students').doc(student.id).get();
                        if (studentDoc.exists) {
                            await db.collection('scheduler_students').doc(student.id).update({ 
                                status: 'pending', 
                                classId: null 
                            });
                        }
                        const idx = allStudents.findIndex(s => s.id === student.id);
                        if (idx !== -1) {
                            allStudents[idx].status = 'pending';
                            allStudents[idx].classId = null;
                        }
                    } catch (studentErr) {
                        console.warn(`Could not update student ${student.id}, may have been deleted:`, studentErr.message);
                        // Continue with other students
                    }
                }
                
                // Delete the class
                await db.collection('scheduler_classes').doc(classId).delete();
                
                // Remove from local array
                const classIdx = allClasses.findIndex(c => c.id === classId);
                if (classIdx !== -1) allClasses.splice(classIdx, 1);
                
                // Delete associated attendance records
                try {
                    const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                    for (const doc of attendanceSnap.docs) {
                        await doc.ref.delete();
                    }
                } catch (attendanceErr) {
                    console.warn('Could not delete some attendance records:', attendanceErr.message);
                }
                
                renderClasses();
                renderStudentsTable();
                renderAdminSchedule();
                updateDashboardStats();
                alert('Class deleted successfully.' + (studentCount > 0 ? ` ${studentCount} student(s) returned to pool.` : ''));
            } catch (e) {
                console.error(e);
                alert('Error deleting class: ' + e.message);
            }
        }
        
        // ==================== COMMUNITY REMINDER (Week 6) ====================
        
        let communityReminderShown = false;
        
        async function checkWeek6Reminder() {
            if (!currentUser || currentUser.role !== 'teacher') return;
            if (communityReminderShown) return;
            
            // Check if there are any completed classes with pending academy status
            try {
                const completedSnap = await db.collection('scheduler_classes')
                    .where('teacherId', '==', currentUser.odId)
                    .where('status', '==', 'completed')
                    .get();
                
                let hasPendingAcademyStatus = false;
                
                for (const doc of completedSnap.docs) {
                    const classData = doc.data();
                    const students = classData.students || [];
                    const academyStatus = classData.academyStatus || {};
                    
                    // Check if any student has pending (or no) academy status
                    for (const student of students) {
                        const status = academyStatus[student.id];
                        if (!status || status === 'pending') {
                            hasPendingAcademyStatus = true;
                            break;
                        }
                    }
                    if (hasPendingAcademyStatus) break;
                }
                
                // Also show reminder if it's Week 6 and no completed classes yet
                const isWeek6 = schedulerSettings.currentWeek === 6;
                
                // Show reminder if: (Week 6 OR has completed classes) AND has pending academy statuses
                if (hasPendingAcademyStatus || (isWeek6 && completedSnap.empty)) {
                    communityReminderShown = true;
                    document.getElementById('communityReminderModal').classList.add('active');
                }
            } catch (e) {
                console.error('Error checking Week 6 reminder:', e);
                // Fallback to old behavior
                if (schedulerSettings.currentWeek === 6) {
                    communityReminderShown = true;
                    document.getElementById('communityReminderModal').classList.add('active');
                }
            }
        }
        
        function closeCommunityReminderModal() {
            document.getElementById('communityReminderModal').classList.remove('active');
        }

        // ==================== ADMIN ATTENDANCE ====================
        
        async function loadAdminAttendance() {
            const container = document.getElementById('adminAttendanceContainer');
            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading attendance...</p>';
            
            // Populate class filter dropdown
            const classFilter = document.getElementById('adminAttendanceClassFilter');
            const activeClasses = allClasses.filter(c => c.status !== 'completed');
            classFilter.innerHTML = '<option value="all">All Classes</option>' + 
                activeClasses.map(c => `<option value="${c.id}">${c.day} ${c.time} - ${LEVELS[c.level]}</option>`).join('');
            
            const selectedClass = classFilter.value;
            
            try {
                // Get all attendance records
                const attendanceSnap = await db.collection('scheduler_attendance').get();
                const attendanceMap = {};
                attendanceSnap.docs.forEach(d => {
                    const data = d.data();
                    if (!attendanceMap[data.classId]) attendanceMap[data.classId] = {};
                    if (!attendanceMap[data.classId][data.studentId]) attendanceMap[data.classId][data.studentId] = {};
                    attendanceMap[data.classId][data.studentId][data.week] = data.status;
                });
                
                // Filter classes
                let classesToShow = activeClasses;
                if (selectedClass !== 'all') {
                    classesToShow = activeClasses.filter(c => c.id === selectedClass);
                }
                
                // Count stats
                let presentCount = 0, lateCount = 0, absentCount = 0, notMarkedCount = 0;
                
                let html = '';
                
                for (const cls of classesToShow) {
                    const teacher = allTeachers.find(t => t.id === cls.teacherId);
                    
                    html += `
                        <div class="card" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="color: #00ffff; margin: 0;">${cls.day} @ ${cls.time}</h4>
                                    <span class="level-badge level-${cls.level}">${LEVELS[cls.level]}</span>
                                    ${teacher ? `<span style="color: #39ff14; font-size: 12px; margin-left: 10px;">ðŸ‘¨â€ðŸ« ${teacher.name}</span>` : ''}
                                </div>
                                <button class="btn btn-sm btn-info" onclick="openClassDetails('${cls.id}')">View Details</button>
                            </div>
                            
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>W1</th>
                                        <th>W2</th>
                                        <th>W3</th>
                                        <th>W4</th>
                                        <th>W5</th>
                                        <th>W6</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const student of (cls.students || [])) {
                        html += `<tr><td><span style="color: #00ffff; cursor: pointer; text-decoration: underline;" onclick="openStudentAnalyticsMenu('${student.id}', '${student.name.replace(/'/g, "\\'")}', '${(student.email || '').replace(/'/g, "\\'")}')">${student.name}</span></td>`;
                        
                        for (let w = 1; w <= 6; w++) {
                            const status = attendanceMap[cls.id]?.[student.id]?.[w];
                            let badge = '-';
                            let color = '#888';
                            
                            if (status === 'present') { badge = 'âœ“'; color = '#39ff14'; presentCount++; }
                            else if (status === 'late') { badge = 'L'; color = '#ffff00'; lateCount++; }
                            else if (status === 'absent') { badge = 'A'; color = '#ff3366'; absentCount++; }
                            else { notMarkedCount++; }
                            
                            html += `<td style="text-align: center; color: ${color}; font-weight: bold;">${badge}</td>`;
                        }
                        
                        html += '</tr>';
                    }
                    
                    html += '</tbody></table></div>';
                }
                
                if (classesToShow.length === 0) {
                    html = '<p style="color: #888; font-size: 12px;">No active classes found.</p>';
                }
                
                // Update stats
                document.getElementById('adminAttendancePresent').textContent = presentCount;
                document.getElementById('adminAttendanceLate').textContent = lateCount;
                document.getElementById('adminAttendanceAbsent').textContent = absentCount;
                document.getElementById('adminAttendanceNotMarked').textContent = notMarkedCount;
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 12px;">Error: ${e.message}</p>`;
            }
        }
        
        // ==================== STUDENT DETAILS MODAL ====================
        
        function openStudentDetailsModal(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('Student not found');
                return;
            }
            
            const cls = allClasses.find(c => c.id === student.classId);
            
            const content = document.getElementById('studentDetailsContent');
            content.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    <div style="background: rgba(0,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffff;">
                        <h4 style="color: #00ffff; margin: 0 0 10px 0; font-size: 12px;">${student.name}</h4>
                        <p style="font-size: 13px; color: #888; margin: 0;">Student ID: ${student.id}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“§ EMAIL</p>
                            <p style="font-size: 13px; color: #fff; margin: 0; word-break: break-all;">${student.email || 'Not provided'}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“ž PHONE</p>
                            <p style="font-size: 13px; color: #fff; margin: 0;">${student.phone || 'Not provided'}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“š LEVEL</p>
                            <p style="font-size: 13px; margin: 0;"><span class="level-badge level-${student.level || 'none'}">${student.level ? LEVELS[student.level] : 'Not assigned'}</span></p>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“‹ STATUS</p>
                            <p style="font-size: 13px; color: ${student.status === 'assigned' ? '#39ff14' : student.status === 'completed' ? '#ff00ff' : '#ffff00'}; margin: 0;">${(student.status || 'pending').toUpperCase()}</p>
                        </div>
                    </div>
                    
                    ${cls ? `
                        <div style="background: rgba(57,255,20,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #39ff14;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸŽ“ CURRENT CLASS</p>
                            <p style="font-size: 13px; color: #39ff14; margin: 0;">${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}</p>
                        </div>
                    ` : ''}
                    
                    ${student.availabilities && student.availabilities.length > 0 ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 8px 0;">ðŸ“… AVAILABILITY</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${student.availabilities.map(a => `<span style="background: rgba(0,255,255,0.2); color: #00ffff; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${a}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${student.registeredAt ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ðŸ“† REGISTERED</p>
                            <p style="font-size: 12px; color: #fff; margin: 0;">${new Date(student.registeredAt.seconds ? student.registeredAt.seconds * 1000 : student.registeredAt).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('studentDetailsModal').classList.add('active');
        }
        
        function closeStudentDetailsModal() {
            document.getElementById('studentDetailsModal').classList.remove('active');
        }
        
        // ==================== STUDENT ANALYTICS FUNCTIONS ====================
        
        let currentAnalyticsStudentId = null;
        let currentAnalyticsStudentName = null;
        let currentAnalyticsStudentEmail = null;
        let currentAnalyticsType = null;
        
        async function openStudentAnalyticsMenu(studentId, studentName, studentEmail = null) {
            // Try to find student email from multiple sources
            let email = studentEmail;
            
            if (!email || email === 'undefined' || email === '') {
                // First try allStudents (scheduler_students collection) - admin only
                const student = allStudents.find(s => s.id === studentId);
                if (student && student.email) {
                    email = student.email;
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Try to find in class students (embedded in allClasses - admin)
                for (const cls of allClasses) {
                    const classStudent = (cls.students || []).find(s => s.id === studentId);
                    if (classStudent && classStudent.email) {
                        email = classStudent.email;
                        break;
                    }
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Try to find in teacher's classes (allClassesForTeacher)
                for (const cls of (allClassesForTeacher || [])) {
                    const classStudent = (cls.students || []).find(s => s.id === studentId);
                    if (classStudent && classStudent.email) {
                        email = classStudent.email;
                        break;
                    }
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Try to find in admin's viewed teacher classes (adminViewingTeacherClasses)
                for (const cls of (adminViewingTeacherClasses || [])) {
                    const classStudent = (cls.students || []).find(s => s.id === studentId);
                    if (classStudent && classStudent.email) {
                        email = classStudent.email;
                        break;
                    }
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Try to find in admin completed classes (allAdminCompletedClasses)
                for (const cls of (allAdminCompletedClasses || [])) {
                    const classStudent = (cls.students || []).find(s => s.id === studentId);
                    if (classStudent && classStudent.email) {
                        email = classStudent.email;
                        break;
                    }
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                // Last resort - look up directly from scheduler_students collection
                try {
                    const studentDoc = await db.collection('scheduler_students').doc(studentId).get();
                    if (studentDoc.exists && studentDoc.data().email) {
                        email = studentDoc.data().email;
                    }
                } catch (e) {
                    console.error('Error looking up student:', e);
                }
            }
            
            if (!email || email === 'undefined' || email === '') {
                alert('Could not find student email. Please ensure the student has an email address on record.');
                return;
            }
            
            currentAnalyticsStudentId = studentId;
            currentAnalyticsStudentName = studentName;
            currentAnalyticsStudentEmail = email;
            
            document.getElementById('analyticsStudentName').textContent = studentName;
            document.getElementById('studentAnalyticsMenuModal').classList.add('active');
        }
        
        function closeStudentAnalyticsMenu() {
            document.getElementById('studentAnalyticsMenuModal').classList.remove('active');
        }
        
        async function openAnalyticsDatePicker(type) {
            currentAnalyticsType = type;
            const typeLabels = {
                pronunciation: 'ðŸŽ¤ Pronunciation',
                grammar: 'ðŸ“– Grammar',
                vocabulary: 'ðŸ“š Vocabulary'
            };
            
            document.getElementById('analyticsDatePickerTitle').textContent = `${typeLabels[type]} Analytics`;
            document.getElementById('analyticsDatePickerModal').classList.add('active');
            document.getElementById('studentAnalyticsMenuModal').classList.remove('active');
            
            const datesList = document.getElementById('analyticsDatesList');
            datesList.innerHTML = '<p style="color: #00ffff; font-size: 12px; text-align: center;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading...</p>';
            
            try {
                let dates = [];
                let hasData = false;
                
                if (type === 'pronunciation') {
                    const submissions = await db.collection('submissions2')
                        .where('studentEmail', '==', currentAnalyticsStudentEmail)
                        .where('status', '==', 'graded')
                        .get();
                    hasData = !submissions.empty;
                    
                    submissions.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.gradedAt) {
                            const date = data.gradedAt.toDate ? data.gradedAt.toDate() : new Date(data.gradedAt);
                            dates.push({
                                id: doc.id,
                                date: date,
                                testTitle: data.testTitle || 'Pronunciation Test',
                                overallScore: data.overallScore
                            });
                        }
                    });
                } else if (type === 'grammar') {
                    const submissions = await db.collection('submissions')
                        .where('studentEmail', '==', currentAnalyticsStudentEmail)
                        .where('status', '==', 'graded')
                        .get();
                    hasData = !submissions.empty;
                    
                    submissions.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.gradedAt) {
                            const date = data.gradedAt.toDate ? data.gradedAt.toDate() : new Date(data.gradedAt);
                            dates.push({
                                id: doc.id,
                                date: date,
                                testTitle: data.testTitle || 'Grammar Test',
                                overallScore: data.overallScore
                            });
                        }
                    });
                } else if (type === 'vocabulary') {
                    // For vocabulary, we need to check multiple data sources
                    // First, find the student's UID from users collection
                    let studentUid = null;
                    try {
                        const userQuery = await db.collection('users').where('email', '==', currentAnalyticsStudentEmail).limit(1).get();
                        if (!userQuery.empty) {
                            studentUid = userQuery.docs[0].id;
                        }
                    } catch (e) {
                        console.log('Could not find user by email:', e);
                    }
                    
                    // Check flashcardResults by email
                    try {
                        const results = await db.collection('flashcardResults')
                            .where('studentEmail', '==', currentAnalyticsStudentEmail)
                            .get();
                        
                        if (!results.empty) {
                            hasData = true;
                            results.docs.forEach(doc => {
                                const data = doc.data();
                                if (data.completedAt) {
                                    const date = data.completedAt.toDate ? data.completedAt.toDate() : new Date(data.completedAt);
                                    dates.push({
                                        id: doc.id,
                                        date: date,
                                        testTitle: data.setTitle || 'Vocabulary Set',
                                        overallScore: data.score
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.log('Error checking flashcardResults:', e);
                    }
                    
                    // Check leitnerProgress by studentId (UID)
                    if (studentUid) {
                        try {
                            const leitnerSnap = await db.collection('leitnerProgress').where('studentId', '==', studentUid).limit(1).get();
                            if (!leitnerSnap.empty) {
                                hasData = true;
                            }
                        } catch (e) {
                            console.log('Error checking leitnerProgress:', e);
                        }
                        
                        // Also check leitnerStats
                        try {
                            const statsDoc = await db.collection('leitnerStats').doc(studentUid).get();
                            if (statsDoc.exists && statsDoc.data().totalReviews > 0) {
                                hasData = true;
                            }
                        } catch (e) {
                            console.log('Error checking leitnerStats:', e);
                        }
                        
                        // Also check masteryDeck
                        try {
                            const masterySnap = await db.collection('masteryDeck').where('studentId', '==', studentUid).limit(1).get();
                            if (!masterySnap.empty) {
                                hasData = true;
                            }
                        } catch (e) {
                            console.log('Error checking masteryDeck:', e);
                        }
                    }
                }
                
                // Sort by date descending
                dates.sort((a, b) => b.date - a.date);
                
                if (!hasData && dates.length === 0) {
                    datesList.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 40px; margin-bottom: 15px;">ðŸ“­</div>
                            <p style="color: #888; font-size: 13px;">No ${type} analytics found for this student.</p>
                            <p style="color: #666; font-size: 12px; margin-top: 10px;">Analytics will appear here once the student completes ${type} evaluations.</p>
                        </div>
                    `;
                    return;
                }
                
                // Show "View All Analytics" button at top
                let html = `
                    <div onclick="loadAnalyticsForDate('all')" style="cursor: pointer; background: linear-gradient(135deg, rgba(0,255,255,0.2), rgba(255,0,255,0.2)); border: 3px solid #00ffff; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <p style="font-size: 12px; color: #00ffff; margin: 0 0 5px 0; font-weight: bold;">ðŸ“Š View All Analytics</p>
                        <p style="font-size: 12px; color: #888; margin: 0;">Comprehensive overview with charts & improvement stats</p>
                    </div>
                `;
                
                if (dates.length > 0) {
                    html += `<p style="font-size: 12px; color: #888; margin-bottom: 10px; text-align: center;">Or view individual sessions (${dates.length} total):</p>`;
                    html += `<div style="max-height: 300px; overflow-y: auto;">`;
                    html += dates.slice(0, 10).map(d => {
                        const dateStr = d.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                        const timeStr = d.date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        const scoreColor = d.overallScore >= 80 ? '#39ff14' : d.overallScore >= 60 ? '#ffff00' : '#ff3366';
                        
                        return `
                            <div onclick="loadAnalyticsForDate('${d.id}')" style="cursor: pointer; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#00ffff'" onmouseout="this.style.borderColor='#333'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-size: 13px; color: #00ffff; margin: 0 0 3px 0;">${d.testTitle}</p>
                                        <p style="font-size: 11px; color: #888; margin: 0;">ðŸ“… ${dateStr}</p>
                                    </div>
                                    ${d.overallScore !== undefined ? `
                                        <div style="background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 6px; border: 2px solid ${scoreColor};">
                                            <span style="font-size: 14px; color: ${scoreColor}; font-weight: bold;">${d.overallScore}%</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                    html += `</div>`;
                    
                    if (dates.length > 10) {
                        html += `<p style="font-size: 11px; color: #666; text-align: center; margin-top: 10px;">Showing 10 of ${dates.length} sessions</p>`;
                    }
                }
                
                datesList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading analytics dates:', error);
                datesList.innerHTML = `<p style="color: #ff3366; font-size: 12px; text-align: center;">Error loading dates: ${error.message}</p>`;
            }
        }
        
        function closeAnalyticsDatePicker() {
            document.getElementById('analyticsDatePickerModal').classList.remove('active');
            document.getElementById('studentAnalyticsMenuModal').classList.add('active');
        }
        
        async function loadAnalyticsForDate(submissionId) {
            document.getElementById('analyticsDatePickerModal').classList.remove('active');
            document.getElementById('analyticsDisplayModal').classList.add('active');
            
            const typeLabels = {
                pronunciation: 'ðŸŽ¤ Pronunciation Analytics',
                grammar: 'ðŸ“– Grammar Analytics',
                vocabulary: 'ðŸ“š Vocabulary Analytics'
            };
            
            document.getElementById('analyticsDisplayTitle').textContent = `${typeLabels[currentAnalyticsType]} - ${currentAnalyticsStudentName}`;
            
            const content = document.getElementById('analyticsDisplayContent');
            content.innerHTML = '<p style="color: #00ffff; font-size: 12px; text-align: center;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading analytics...</p>';
            
            try {
                if (currentAnalyticsType === 'pronunciation') {
                    await renderPronunciationAnalytics(submissionId, content);
                } else if (currentAnalyticsType === 'grammar') {
                    await renderGrammarAnalytics(submissionId, content);
                } else if (currentAnalyticsType === 'vocabulary') {
                    await renderVocabularyAnalytics(submissionId, content);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                content.innerHTML = `<p style="color: #ff3366; font-size: 12px; text-align: center;">Error loading analytics: ${error.message}</p>`;
            }
        }
        
        async function renderPronunciationAnalytics(submissionId, container) {
            // Load ALL pronunciation submissions for this student to show comprehensive analytics
            const allSubmissions = await db.collection('submissions2')
                .where('studentEmail', '==', currentAnalyticsStudentEmail)
                .where('status', '==', 'graded')
                .get();
            
            if (allSubmissions.empty) {
                container.innerHTML = '<p style="color: #ff3366;">No pronunciation data found.</p>';
                return;
            }
            
            // Process all submissions
            const submissions = [];
            const topicScores = {};
            
            allSubmissions.docs.forEach(doc => {
                const data = doc.data();
                const gradedAt = data.gradedAt?.toDate ? data.gradedAt.toDate() : new Date();
                
                submissions.push({
                    id: doc.id,
                    date: gradedAt,
                    grades: data.grades || {},
                    overallScore: data.overallScore || 0,
                    testTitle: data.testTitle || 'Pronunciation Test'
                });
                
                // Organize scores by topic
                Object.entries(data.grades || {}).forEach(([key, grade]) => {
                    const topic = key.includes('_') ? key.split('_')[1] : key;
                    if (!topicScores[topic]) topicScores[topic] = [];
                    topicScores[topic].push({ grade, date: gradedAt });
                });
            });
            
            // Sort submissions by date
            submissions.sort((a, b) => a.date - b.date);
            
            // Calculate improvements
            let overallImprovement = 'N/A';
            let weeklyImprovement = 'N/A';
            let monthlyImprovement = 'N/A';
            
            if (submissions.length >= 2) {
                const firstAvg = submissions[0].overallScore;
                const lastAvg = submissions[submissions.length - 1].overallScore;
                if (firstAvg > 0) {
                    overallImprovement = ((lastAvg - firstAvg) / firstAvg * 100).toFixed(1);
                }
                
                // Weekly improvement
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const weekSubmissions = submissions.filter(s => s.date >= oneWeekAgo);
                if (weekSubmissions.length >= 2) {
                    const weekFirst = weekSubmissions[0].overallScore;
                    const weekLast = weekSubmissions[weekSubmissions.length - 1].overallScore;
                    if (weekFirst > 0) {
                        weeklyImprovement = ((weekLast - weekFirst) / weekFirst * 100).toFixed(1);
                    }
                }
                
                // Monthly improvement
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                const monthSubmissions = submissions.filter(s => s.date >= oneMonthAgo);
                if (monthSubmissions.length >= 2) {
                    const monthFirst = monthSubmissions[0].overallScore;
                    const monthLast = monthSubmissions[monthSubmissions.length - 1].overallScore;
                    if (monthFirst > 0) {
                        monthlyImprovement = ((monthLast - monthFirst) / monthFirst * 100).toFixed(1);
                    }
                }
            }
            
            const latestSubmission = submissions[submissions.length - 1];
            const improvementColor = val => parseFloat(val) >= 0 ? '#39ff14' : '#ff3366';
            const improvementSign = val => parseFloat(val) >= 0 ? '+' : '';
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.2) 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px; text-align: center;">
                        <p style="font-size: 14px; color: #00ffff; margin: 0 0 5px 0;">ðŸŽ¤ Pronunciation Analytics for ${currentAnalyticsStudentName}</p>
                        <p style="font-size: 12px; color: #888; margin: 0 0 10px 0;">${submissions.length} total evaluations</p>
                        <div style="font-size: 36px; font-weight: bold; color: ${latestSubmission.overallScore >= 80 ? '#39ff14' : latestSubmission.overallScore >= 60 ? '#ffff00' : '#ff3366'};">${latestSubmission.overallScore}%</div>
                        <p style="font-size: 13px; color: #888; margin-top: 5px;">Latest Score</p>
                    </div>
                </div>
                
                <!-- Improvement Stats -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${overallImprovement !== 'N/A' ? improvementColor(overallImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ALL-TIME</p>
                        <div style="font-size: 16px; font-weight: bold; color: ${overallImprovement !== 'N/A' ? improvementColor(overallImprovement) : '#888'};">${overallImprovement !== 'N/A' ? improvementSign(overallImprovement) + overallImprovement + '%' : 'N/A'}</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${monthlyImprovement !== 'N/A' ? improvementColor(monthlyImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">THIS MONTH</p>
                        <div style="font-size: 16px; font-weight: bold; color: ${monthlyImprovement !== 'N/A' ? improvementColor(monthlyImprovement) : '#888'};">${monthlyImprovement !== 'N/A' ? improvementSign(monthlyImprovement) + monthlyImprovement + '%' : 'N/A'}</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${weeklyImprovement !== 'N/A' ? improvementColor(weeklyImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">THIS WEEK</p>
                        <div style="font-size: 16px; font-weight: bold; color: ${weeklyImprovement !== 'N/A' ? improvementColor(weeklyImprovement) : '#888'};">${weeklyImprovement !== 'N/A' ? improvementSign(weeklyImprovement) + weeklyImprovement + '%' : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Progress Chart -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #00ffff; font-size: 14px; margin-bottom: 15px;">ðŸ“ˆ Progress Over Time</h4>
                    <div style="height: 200px;">
                        <canvas id="pronProgressChart"></canvas>
                    </div>
                </div>
                
                <!-- Topic Performance Chart -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #00ffff; font-size: 14px; margin-bottom: 15px;">ðŸ“Š Performance by Character</h4>
                    <div style="height: 200px;">
                        <canvas id="pronTopicChart"></canvas>
                    </div>
                </div>
                
                <!-- Character Scores Grid -->
                <h4 style="color: #00ffff; font-size: 14px; margin-bottom: 15px;">ðŸ”¤ Latest Character Scores</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; margin-bottom: 20px;">
                    ${Object.entries(topicScores).map(([topic, scores]) => {
                        scores.sort((a, b) => b.date - a.date);
                        const latestScore = scores[0].grade;
                        const color = latestScore >= 8 ? '#39ff14' : latestScore >= 5 ? '#ffff00' : '#ff3366';
                        return `
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid ${color}; border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-size: 18px; color: #fff; margin-bottom: 3px;">${topic}</div>
                                <div style="font-size: 12px; font-weight: bold; color: ${color};">${latestScore}/10</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Create Progress Chart
            setTimeout(() => {
                const progressCtx = document.getElementById('pronProgressChart');
                if (progressCtx) {
                    new Chart(progressCtx, {
                        type: 'line',
                        data: {
                            labels: submissions.map(s => s.date.toLocaleDateString()),
                            datasets: [{
                                label: 'Score %',
                                data: submissions.map(s => s.overallScore),
                                borderColor: '#00ffff',
                                backgroundColor: 'rgba(0,255,255,0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 100, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            },
                            plugins: { legend: { labels: { color: '#fff' } } }
                        }
                    });
                }
                
                // Create Topic Chart
                const topicCtx = document.getElementById('pronTopicChart');
                if (topicCtx) {
                    const topics = Object.keys(topicScores);
                    const latestScores = topics.map(t => {
                        const scores = topicScores[t];
                        scores.sort((a, b) => b.date - a.date);
                        return scores[0].grade;
                    });
                    
                    new Chart(topicCtx, {
                        type: 'bar',
                        data: {
                            labels: topics,
                            datasets: [{
                                label: 'Score',
                                data: latestScores,
                                backgroundColor: latestScores.map(s => s >= 8 ? 'rgba(57,255,20,0.7)' : s >= 5 ? 'rgba(255,255,0,0.7)' : 'rgba(255,51,102,0.7)'),
                                borderColor: latestScores.map(s => s >= 8 ? '#39ff14' : s >= 5 ? '#ffff00' : '#ff3366'),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 10, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }, 100);
        }
        
        async function renderGrammarAnalytics(submissionId, container) {
            // Load ALL grammar submissions for this student
            const allSubmissions = await db.collection('submissions')
                .where('studentEmail', '==', currentAnalyticsStudentEmail)
                .where('status', '==', 'graded')
                .get();
            
            if (allSubmissions.empty) {
                container.innerHTML = '<p style="color: #ff3366;">No grammar data found.</p>';
                return;
            }
            
            // Process all submissions
            const submissions = [];
            const topicScores = {};
            
            allSubmissions.docs.forEach(doc => {
                const data = doc.data();
                const gradedAt = data.gradedAt?.toDate ? data.gradedAt.toDate() : new Date();
                
                submissions.push({
                    id: doc.id,
                    date: gradedAt,
                    grades: data.grades || {},
                    overallScore: data.overallScore || 0,
                    testTitle: data.testTitle || 'Grammar Test'
                });
                
                Object.entries(data.grades || {}).forEach(([topic, grade]) => {
                    if (!topicScores[topic]) topicScores[topic] = [];
                    const scoreVal = typeof grade === 'number' ? grade * 10 : grade;
                    topicScores[topic].push({ grade: scoreVal, date: gradedAt });
                });
            });
            
            submissions.sort((a, b) => a.date - b.date);
            
            // Calculate improvements
            let overallImprovement = 'N/A';
            let weeklyImprovement = 'N/A';
            
            if (submissions.length >= 2) {
                const firstAvg = submissions[0].overallScore;
                const lastAvg = submissions[submissions.length - 1].overallScore;
                if (firstAvg > 0) {
                    overallImprovement = ((lastAvg - firstAvg) / firstAvg * 100).toFixed(1);
                }
                
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const weekSubmissions = submissions.filter(s => s.date >= oneWeekAgo);
                if (weekSubmissions.length >= 2) {
                    const weekFirst = weekSubmissions[0].overallScore;
                    const weekLast = weekSubmissions[weekSubmissions.length - 1].overallScore;
                    if (weekFirst > 0) {
                        weeklyImprovement = ((weekLast - weekFirst) / weekFirst * 100).toFixed(1);
                    }
                }
            }
            
            const latestSubmission = submissions[submissions.length - 1];
            const improvementColor = val => parseFloat(val) >= 0 ? '#39ff14' : '#ff3366';
            const improvementSign = val => parseFloat(val) >= 0 ? '+' : '';
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(72,187,120,0.2) 0%, rgba(56,178,172,0.2) 100%); border: 2px solid #48bb78; border-radius: 12px; padding: 20px; text-align: center;">
                        <p style="font-size: 14px; color: #48bb78; margin: 0 0 5px 0;">ðŸ“– Grammar Analytics for ${currentAnalyticsStudentName}</p>
                        <p style="font-size: 12px; color: #888; margin: 0 0 10px 0;">${submissions.length} total evaluations</p>
                        <div style="font-size: 36px; font-weight: bold; color: ${latestSubmission.overallScore >= 80 ? '#39ff14' : latestSubmission.overallScore >= 60 ? '#ffff00' : '#ff3366'};">${latestSubmission.overallScore}%</div>
                        <p style="font-size: 13px; color: #888; margin-top: 5px;">Latest Score</p>
                    </div>
                </div>
                
                <!-- Improvement Stats -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${overallImprovement !== 'N/A' ? improvementColor(overallImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">ALL-TIME IMPROVEMENT</p>
                        <div style="font-size: 18px; font-weight: bold; color: ${overallImprovement !== 'N/A' ? improvementColor(overallImprovement) : '#888'};">${overallImprovement !== 'N/A' ? improvementSign(overallImprovement) + overallImprovement + '%' : 'N/A'}</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid ${weeklyImprovement !== 'N/A' ? improvementColor(weeklyImprovement) : '#888'}; border-radius: 8px; padding: 15px; text-align: center;">
                        <p style="font-size: 11px; color: #888; margin: 0 0 5px 0;">WEEKLY IMPROVEMENT</p>
                        <div style="font-size: 18px; font-weight: bold; color: ${weeklyImprovement !== 'N/A' ? improvementColor(weeklyImprovement) : '#888'};">${weeklyImprovement !== 'N/A' ? improvementSign(weeklyImprovement) + weeklyImprovement + '%' : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Progress Chart -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #48bb78; font-size: 14px; margin-bottom: 15px;">ðŸ“ˆ Progress Over Time</h4>
                    <div style="height: 200px;">
                        <canvas id="grammarProgressChart"></canvas>
                    </div>
                </div>
                
                <!-- Topic Scores -->
                ${Object.keys(topicScores).length > 0 ? `
                    <h4 style="color: #48bb78; font-size: 14px; margin-bottom: 15px;">ðŸ“Š Topic Scores</h4>
                    <div style="display: grid; gap: 10px;">
                        ${Object.entries(topicScores).map(([topic, scores]) => {
                            scores.sort((a, b) => b.date - a.date);
                            const latest = scores[0].grade;
                            const color = latest >= 80 ? '#39ff14' : latest >= 60 ? '#ffff00' : '#ff3366';
                            return `
                                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 13px; color: #fff;">${topic}</span>
                                        <span style="font-size: 14px; font-weight: bold; color: ${color};">${latest}%</span>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                        <div style="background: ${color}; width: ${latest}%; height: 100%; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            `;
            
            // Create Progress Chart
            setTimeout(() => {
                const ctx = document.getElementById('grammarProgressChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: submissions.map(s => s.date.toLocaleDateString()),
                            datasets: [{
                                label: 'Score %',
                                data: submissions.map(s => s.overallScore),
                                borderColor: '#48bb78',
                                backgroundColor: 'rgba(72,187,120,0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 100, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            },
                            plugins: { legend: { labels: { color: '#fff' } } }
                        }
                    });
                }
            }, 100);
        }
        
        async function renderVocabularyAnalytics(submissionId, container) {
            container.innerHTML = '<p style="color: #00ffff; font-size: 12px; text-align: center;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading SRS Stats...</p>';
            
            // First, find the student's UID from users collection
            let studentUid = null;
            let studentDisplayName = currentAnalyticsStudentName;
            try {
                const userQuery = await db.collection('users').where('email', '==', currentAnalyticsStudentEmail).limit(1).get();
                if (!userQuery.empty) {
                    studentUid = userQuery.docs[0].id;
                    studentDisplayName = userQuery.docs[0].data().displayName || studentDisplayName;
                }
            } catch (e) {
                console.log('Could not find user by email:', e);
            }
            
            if (!studentUid) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 15px;">ðŸ”</div>
                        <p style="color: #ff9900; font-size: 14px;">Could not find student account</p>
                        <p style="color: #888; font-size: 12px; margin-top: 10px;">Email: ${currentAnalyticsStudentEmail}</p>
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">The student may not have created an account yet.</p>
                    </div>
                `;
                return;
            }
            
            // Load all data sources
            let leitnerCards = [];
            let leitnerStats = { 
                totalCorrect: 0, 
                totalReviews: 0, 
                currentStreak: 0, 
                longestStreak: 0,
                totalLapses: 0,
                totalMastered: 0,
                totalCardsLearning: 0,
                studyLog: {}
            };
            let masteryDeckCount = 0;
            
            try {
                // Load Leitner cards from leitnerProgress collection
                const leitnerSnap = await db.collection('leitnerProgress').where('studentId', '==', studentUid).get();
                leitnerCards = leitnerSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log('Loaded leitnerProgress:', leitnerCards.length, leitnerCards.slice(0, 3));
                
                // Load Leitner stats
                const statsDoc = await db.collection('leitnerStats').doc(studentUid).get();
                if (statsDoc.exists) {
                    leitnerStats = { ...leitnerStats, ...statsDoc.data() };
                }
                
                // Load Mastery Deck count (words mastered from games)
                const masterySnap = await db.collection('masteryDeck').where('studentId', '==', studentUid).get();
                masteryDeckCount = masterySnap.size;
            } catch (e) {
                console.error('Error loading vocabulary data:', e);
            }
            
            // Calculate metrics - use correct threshold of 5
            const LEITNER_LEECH_THRESHOLD = 5;
            const LEITNER_BOX_NAMES = {
                1: 'Day 1', 2: 'Day 2', 3: 'Day 3', 4: 'Semi-Mastery',
                5: 'Day 5', 6: 'Weekly', 7: 'Monthly', 8: 'Mastery'
            };
            
            const boxCounts = {};
            const boxLapses = {}; // Track lapses per box
            for (let i = 1; i <= 8; i++) {
                const cardsInBox = leitnerCards.filter(c => c.box === i);
                boxCounts[i] = cardsInBox.length;
                boxLapses[i] = cardsInBox.reduce((sum, c) => sum + (c.lapseCount || 0), 0);
            }
            
            // Semi-mastery count (Day 4+)
            const semiMasteredCount = (boxCounts[4] || 0) + (boxCounts[5] || 0) + (boxCounts[6] || 0) + (boxCounts[7] || 0);
            
            // Calculate Day 1 interval completion rates
            const day1Cards = leitnerCards.filter(c => c.box === 1 || c.day1Intervals);
            const day1IntervalStats = {
                first: { completed: 0, total: day1Cards.length },
                thirtyMin: { completed: 0, total: day1Cards.length },
                twoHours: { completed: 0, total: day1Cards.length },
                beforeSleep: { completed: 0, total: day1Cards.length }
            };
            
            day1Cards.forEach(card => {
                const intervals = card.day1Intervals || {};
                if (intervals.first) day1IntervalStats.first.completed++;
                if (intervals.thirtyMin) day1IntervalStats.thirtyMin.completed++;
                if (intervals.twoHours) day1IntervalStats.twoHours.completed++;
                if (intervals.beforeSleep) day1IntervalStats.beforeSleep.completed++;
            });
            
            const totalLearning = leitnerCards.filter(c => c.box < 8).length;
            const leitnerMastered = boxCounts[8] || 0;
            const totalMastered = leitnerMastered + masteryDeckCount;
            const totalCardsInSystem = leitnerCards.length + masteryDeckCount;
            const masteryRate = totalCardsInSystem > 0 ? (totalMastered / totalCardsInSystem * 100).toFixed(1) : 0;
            
            const accuracy = leitnerStats.totalReviews > 0 ?
                (leitnerStats.totalCorrect / leitnerStats.totalReviews * 100).toFixed(1) : 0;
            const resetRate = leitnerStats.totalReviews > 0 ?
                (leitnerStats.totalLapses / leitnerStats.totalReviews * 100).toFixed(1) : 0;
            
            // Calculate per-box reset rates
            const boxResetRates = {};
            const totalLapsesAllCards = leitnerCards.reduce((sum, c) => sum + (c.lapseCount || 0), 0);
            for (let i = 1; i <= 7; i++) {
                if (boxLapses[i] > 0 && totalLapsesAllCards > 0) {
                    boxResetRates[i] = ((boxLapses[i] / totalLapsesAllCards) * 100).toFixed(1);
                } else {
                    boxResetRates[i] = '0';
                }
            }
            
            // Find the box with highest reset contribution
            let highestResetBox = 0;
            let highestResetValue = 0;
            for (let i = 1; i <= 7; i++) {
                if (parseFloat(boxResetRates[i]) > highestResetValue) {
                    highestResetValue = parseFloat(boxResetRates[i]);
                    highestResetBox = i;
                }
            }
            
            // Get leech cards (cards that student struggles with) - threshold is 5
            const leechCards = leitnerCards
                .filter(c => (c.lapseCount || 0) >= LEITNER_LEECH_THRESHOLD)
                .sort((a, b) => (b.lapseCount || 0) - (a.lapseCount || 0))
                .slice(0, 10);
            
            // Also get cards with any lapses for debugging
            const cardsWithLapses = leitnerCards.filter(c => (c.lapseCount || 0) > 0);
            console.log('Cards with lapses:', cardsWithLapses.length, cardsWithLapses.slice(0, 5));
            
            // Calculate time to mastery
            const masteredCards = leitnerCards.filter(c => c.box === 8 && c.masteredDate && c.firstSeenDate);
            let avgTimeToMastery = 'N/A';
            if (masteredCards.length > 0) {
                const times = masteredCards.map(c => {
                    const first = c.firstSeenDate?.toDate ? c.firstSeenDate.toDate() : new Date(c.firstSeenDate);
                    const mastered = c.masteredDate?.toDate ? c.masteredDate.toDate() : new Date(c.masteredDate);
                    return Math.floor((mastered - first) / (1000 * 60 * 60 * 24));
                });
                avgTimeToMastery = (times.reduce((a, b) => a + b, 0) / times.length).toFixed(1);
            }
            
            // Calculate weekly consistency
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            const studyLog = leitnerStats.studyLog || {};
            
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push({ date: dateStr, count: studyLog[dateStr] || 0 });
            }
            const daysStudiedThisWeek = last7Days.filter(d => d.count > 0).length;
            const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            // Due cards count
            const leitnerDueCards = leitnerCards.filter(card => {
                if (card.box >= 8) return false;
                if (!card.nextReviewDate) return card.box === 1;
                const nextReview = card.nextReviewDate?.toDate ? card.nextReviewDate.toDate() : new Date(card.nextReviewDate);
                return nextReview <= new Date();
            });
            
            // Check if there's any data at all
            const hasData = leitnerCards.length > 0 || masteryDeckCount > 0 || leitnerStats.totalReviews > 0;
            
            if (!hasData) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 15px;">ðŸ“š</div>
                        <p style="color: #888; font-size: 14px;">No vocabulary data yet</p>
                        <p style="color: #666; font-size: 12px; margin-top: 10px;">This student hasn't started using the flashcard system yet.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(237,137,54,0.2) 0%, rgba(221,107,32,0.2) 100%); border: 2px solid #ed8936; border-radius: 12px; padding: 20px; text-align: center;">
                        <p style="font-size: 14px; color: #ed8936; margin: 0 0 5px 0;">ðŸ“ˆ SRS Stats for ${currentAnalyticsStudentName}</p>
                        <p style="font-size: 12px; color: #888; margin: 0;">Spaced Repetition Learning Analytics</p>
                    </div>
                </div>
                
                <!-- Core Progress Section -->
                <h4 style="color: #ed8936; font-size: 14px; margin-bottom: 15px;">ðŸ“ˆ Core Progress</h4>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(245,158,11,0.1); border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">â­ MASTERY DECK</p>
                        <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${masteryDeckCount}</div>
                        <p style="font-size: 10px; color: #888;">from games</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(72,187,120,0.2) 0%, rgba(56,178,172,0.2) 100%); border: 2px solid #48bb78; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ§  SEMI-MASTERED</p>
                        <div style="font-size: 20px; font-weight: bold; color: #48bb78;">${semiMasteredCount}</div>
                        <p style="font-size: 10px; color: #888;">Day 4+ cards</p>
                    </div>
                    <div style="background: rgba(159,122,234,0.1); border: 2px solid #9f7aea; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“¦ LEITNER GRAD</p>
                        <div style="font-size: 20px; font-weight: bold; color: #9f7aea;">${leitnerMastered}</div>
                        <p style="font-size: 10px; color: #888;">through SRS</p>
                    </div>
                    <div style="background: rgba(102,126,234,0.1); border: 2px solid #667eea; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“Š MASTERY RATE</p>
                        <div style="font-size: 20px; font-weight: bold; color: #667eea;">${masteryRate}%</div>
                        <p style="font-size: 10px; color: #888;">of all cards</p>
                    </div>
                    <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ”„ IN ROTATION</p>
                        <div style="font-size: 20px; font-weight: bold; color: #00ffff;">${totalLearning}</div>
                        <p style="font-size: 10px; color: #888;">learning</p>
                    </div>
                </div>
                
                <!-- Day 1 Practice Pattern Section -->
                ${day1IntervalStats.first.total > 0 ? `
                <div style="background: linear-gradient(135deg, rgba(245,101,101,0.1) 0%, rgba(237,137,54,0.1) 100%); border: 2px solid #fc8181; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #e53e3e; font-size: 14px; margin: 0 0 15px 0;">ðŸ”¥ Day 1 Practice Pattern (Spaced Intervals)</h4>
                    <p style="font-size: 11px; color: #888; margin: 0 0 12px 0;">Research shows 3-5 spaced recalls on Day 1 dramatically improve retention.</p>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                            <p style="font-size: 14px; margin: 0 0 5px 0;">1ï¸âƒ£</p>
                            <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">First Practice</p>
                            <div style="font-size: 14px; font-weight: bold; color: ${day1IntervalStats.first.completed === day1IntervalStats.first.total ? '#48bb78' : '#ed8936'};">
                                ${day1IntervalStats.first.completed}/${day1IntervalStats.first.total}
                            </div>
                            <p style="font-size: 10px; color: #888;">${day1IntervalStats.first.total > 0 ? Math.round(day1IntervalStats.first.completed / day1IntervalStats.first.total * 100) : 0}%</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                            <p style="font-size: 14px; margin: 0 0 5px 0;">â°</p>
                            <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">30 Min Later</p>
                            <div style="font-size: 14px; font-weight: bold; color: ${day1IntervalStats.thirtyMin.completed === day1IntervalStats.thirtyMin.total ? '#48bb78' : day1IntervalStats.thirtyMin.completed > 0 ? '#ed8936' : '#f56565'};">
                                ${day1IntervalStats.thirtyMin.completed}/${day1IntervalStats.thirtyMin.total}
                            </div>
                            <p style="font-size: 10px; color: #888;">${day1IntervalStats.thirtyMin.total > 0 ? Math.round(day1IntervalStats.thirtyMin.completed / day1IntervalStats.thirtyMin.total * 100) : 0}%</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                            <p style="font-size: 14px; margin: 0 0 5px 0;">ðŸ•</p>
                            <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">2 Hours Later</p>
                            <div style="font-size: 14px; font-weight: bold; color: ${day1IntervalStats.twoHours.completed === day1IntervalStats.twoHours.total ? '#48bb78' : day1IntervalStats.twoHours.completed > 0 ? '#ed8936' : '#f56565'};">
                                ${day1IntervalStats.twoHours.completed}/${day1IntervalStats.twoHours.total}
                            </div>
                            <p style="font-size: 10px; color: #888;">${day1IntervalStats.twoHours.total > 0 ? Math.round(day1IntervalStats.twoHours.completed / day1IntervalStats.twoHours.total * 100) : 0}%</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                            <p style="font-size: 14px; margin: 0 0 5px 0;">ðŸŒ™</p>
                            <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">Before Sleep</p>
                            <div style="font-size: 14px; font-weight: bold; color: ${day1IntervalStats.beforeSleep.completed === day1IntervalStats.beforeSleep.total ? '#48bb78' : day1IntervalStats.beforeSleep.completed > 0 ? '#ed8936' : '#f56565'};">
                                ${day1IntervalStats.beforeSleep.completed}/${day1IntervalStats.beforeSleep.total}
                            </div>
                            <p style="font-size: 10px; color: #888;">${day1IntervalStats.beforeSleep.total > 0 ? Math.round(day1IntervalStats.beforeSleep.completed / day1IntervalStats.beforeSleep.total * 100) : 0}%</p>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Recall Quality Section -->
                <h4 style="color: #48bb78; font-size: 14px; margin-bottom: 15px;">ðŸŽ¯ Recall Quality</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(72,187,120,0.1); border: 2px solid #48bb78; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">âœ… ACCURACY</p>
                        <div style="font-size: 20px; font-weight: bold; color: #48bb78;">${accuracy}%</div>
                        <p style="font-size: 10px; color: #888;">${leitnerStats.totalCorrect || 0}/${leitnerStats.totalReviews || 0}</p>
                    </div>
                    <div style="background: rgba(66,153,225,0.1); border: 2px solid #4299e1; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">â±ï¸ AVG TO MASTER</p>
                        <div style="font-size: 20px; font-weight: bold; color: #4299e1;">${avgTimeToMastery}</div>
                        <p style="font-size: 10px; color: #888;">days</p>
                    </div>
                    <div style="background: rgba(56,178,172,0.1); border: 2px solid #38b2ac; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ’ª STRONG WORDS</p>
                        <div style="font-size: 20px; font-weight: bold; color: #38b2ac;">${(boxCounts[6] || 0) + (boxCounts[7] || 0)}</div>
                        <p style="font-size: 10px; color: #888;">Weekly+Monthly</p>
                    </div>
                </div>
                
                <!-- Struggle Analysis Section -->
                <h4 style="color: #f56565; font-size: 14px; margin-bottom: 15px;">âš ï¸ Struggle Analysis</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(245,101,101,0.1); border: 2px solid #f56565; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ”„ TOTAL RESETS</p>
                        <div style="font-size: 20px; font-weight: bold; color: #f56565;">${totalLapsesAllCards}</div>
                        <p style="font-size: 10px; color: #888;">across all cards</p>
                    </div>
                    <div style="background: rgba(237,137,54,0.1); border: 2px solid #ed8936; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“‰ OVERALL RESET RATE</p>
                        <div style="font-size: 20px; font-weight: bold; color: #ed8936;">${resetRate}%</div>
                        <p style="font-size: 10px; color: #888;">of reviews</p>
                    </div>
                </div>
                
                <!-- Per-Box Reset Rates -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <p style="font-size: 12px; color: #f56565; margin: 0 0 10px 0;">ðŸ“Š Reset Distribution by Box</p>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                        ${[1,2,3,4,5,6,7].map(box => {
                            const isHighest = box === highestResetBox && highestResetValue > 20;
                            const lapseCount = boxLapses[box] || 0;
                            const pct = boxResetRates[box];
                            const bgColor = isHighest ? 'rgba(245,101,101,0.3)' : 'rgba(0,0,0,0.3)';
                            const borderColor = isHighest ? '#f56565' : (parseFloat(pct) > 15 ? '#ed8936' : '#555');
                            const textColor = isHighest ? '#f56565' : (parseFloat(pct) > 15 ? '#ed8936' : '#888');
                            return `
                                <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 6px; padding: 8px; text-align: center; ${isHighest ? 'box-shadow: 0 0 10px rgba(245,101,101,0.5);' : ''}">
                                    <p style="font-size: 10px; color: #888; margin: 0 0 3px 0;">${LEITNER_BOX_NAMES[box]}</p>
                                    <div style="font-size: 12px; font-weight: bold; color: ${textColor};">${pct}%</div>
                                    <p style="font-size: 9px; color: #666; margin-top: 2px;">${lapseCount} resets</p>
                                    ${isHighest ? '<p style="font-size: 9px; color: #f56565; margin-top: 2px;">âš ï¸ HIGHEST</p>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Leech Cards -->
                ${leechCards.length > 0 ? `
                    <div style="background: rgba(245,101,101,0.1); border: 2px solid #f56565; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                        <p style="font-size: 12px; color: #f56565; margin: 0 0 10px 0;">ðŸ©¸ Leech Cards (${LEITNER_LEECH_THRESHOLD}+ resets) - ${leechCards.length} found</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${leechCards.map(c => `
                                <span style="background: rgba(0,0,0,0.3); padding: 6px 10px; border-radius: 5px; font-size: 12px; border: 1px solid #f56565;">
                                    <span style="color: #fff;">${c.english || c.korean || c.word || 'Card'}</span>
                                    <span style="color: #f56565; margin-left: 5px; font-weight: bold;">(${c.lapseCount}x)</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : cardsWithLapses.length > 0 ? `
                    <div style="background: rgba(237,137,54,0.1); border: 2px solid #ed8936; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                        <p style="font-size: 12px; color: #ed8936; margin: 0 0 5px 0;">âš ï¸ ${cardsWithLapses.length} cards have been reset (but less than ${LEITNER_LEECH_THRESHOLD}x each)</p>
                        <p style="font-size: 11px; color: #888;">Top struggling cards:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                            ${cardsWithLapses.sort((a,b) => (b.lapseCount||0) - (a.lapseCount||0)).slice(0,8).map(c => `
                                <span style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                    <span style="color: #fff;">${c.english || c.korean || c.word || 'Card'}</span>
                                    <span style="color: #ed8936; margin-left: 3px;">(${c.lapseCount}x)</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div style="background: rgba(72,187,120,0.1); border: 2px solid #48bb78; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                        <p style="font-size: 13px; color: #48bb78; margin: 0;">ðŸŽ‰ No struggling cards! Student hasn't reset any words.</p>
                    </div>
                `}
                
                <!-- Consistency Section -->
                <h4 style="color: #ed8936; font-size: 14px; margin-bottom: 15px;">ðŸ”¥ Consistency & Habits</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                    <div style="background: rgba(237,137,54,0.1); border: 2px solid #ed8936; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ”¥ CURRENT STREAK</p>
                        <div style="font-size: 20px; font-weight: bold; color: #ed8936;">${leitnerStats.currentStreak || 0}</div>
                        <p style="font-size: 10px; color: #888;">days (best: ${leitnerStats.longestStreak || 0})</p>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #888; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“… WEEKLY</p>
                        <div style="font-size: 20px; font-weight: bold; color: #fff;">${Math.round(daysStudiedThisWeek / 7 * 100)}%</div>
                        <div style="display: flex; justify-content: center; gap: 3px; margin-top: 5px;">
                            ${last7Days.map((d, i) => {
                                const dayDate = new Date(d.date);
                                const dayIndex = dayDate.getDay();
                                const isToday = d.date === todayStr;
                                const bgColor = d.count > 0 ? '#39ff14' : '#333';
                                return `<div style="width: 14px; height: 14px; background: ${bgColor}; border-radius: 3px; font-size: 10px; display: flex; align-items: center; justify-content: center; color: ${d.count > 0 ? '#000' : '#666'}; ${isToday ? 'border: 1px solid #fff;' : ''}">${dayLabels[dayIndex]}</div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #888; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">ðŸ“ REVIEWS TODAY</p>
                        <div style="font-size: 20px; font-weight: bold; color: #fff;">${studyLog[todayStr] || 0}</div>
                        <p style="font-size: 10px; color: #888;">cards</p>
                    </div>
                    <div style="background: rgba(${leitnerDueCards.length > 0 ? '245,101,101' : '72,187,120'},0.1); border: 2px solid ${leitnerDueCards.length > 0 ? '#f56565' : '#48bb78'}; border-radius: 8px; padding: 12px; text-align: center;">
                        <p style="font-size: 10px; color: #888; margin: 0 0 5px 0;">â° OVERDUE</p>
                        <div style="font-size: 20px; font-weight: bold; color: ${leitnerDueCards.length > 0 ? '#f56565' : '#48bb78'};">${leitnerDueCards.length}</div>
                        <p style="font-size: 10px; color: #888;">need review</p>
                    </div>
                </div>
                
                <!-- Leitner Box Distribution -->
                ${totalLearning > 0 || leitnerMastered > 0 ? `
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="color: #9f7aea; font-size: 14px; margin-bottom: 15px;">ðŸ“¦ Leitner Box Distribution</h4>
                        <div style="display: flex; gap: 5px; align-items: end; height: 100px;">
                            ${[1,2,3,4,5,6,7,8].map(box => {
                                const count = boxCounts[box] || 0;
                                const maxCount = Math.max(...Object.values(boxCounts), 1);
                                const pct = maxCount > 0 ? (count / maxCount * 100) : 0;
                                const colors = ['#f56565', '#ed8936', '#ecc94b', '#48bb78', '#38b2ac', '#4299e1', '#9f7aea', '#d69e2e'];
                                const isDay4 = box === 4;
                                const brainIcon = isDay4 ? '<span style="font-size: 12px;">ðŸ§ </span>' : '';
                                const barGlow = isDay4 ? 'box-shadow: 0 0 10px #48bb78;' : '';
                                const labelStyle = isDay4 ? 'color: #48bb78; font-weight: bold;' : 'color: #888;';
                                const countStyle = isDay4 ? 'color: #48bb78; font-weight: bold;' : 'color: #fff;';
                                return `
                                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                        ${brainIcon}
                                        <span style="font-size: 12px; ${countStyle} margin-bottom: 3px;">${count}</span>
                                        <div style="width: 100%; background: ${colors[box-1]}; height: ${Math.max(pct, 8)}%; border-radius: 4px 4px 0 0; min-height: 8px; ${barGlow}"></div>
                                        <span style="font-size: 10px; ${labelStyle} margin-top: 5px;">${LEITNER_BOX_NAMES[box]}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: linear-gradient(135deg, rgba(72,187,120,0.15) 0%, rgba(56,178,172,0.15) 100%); border: 1px solid #48bb78; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">ðŸ§ </span>
                                <div>
                                    <p style="font-size: 11px; color: #48bb78; margin: 0; font-weight: bold;">Semi-Mastery = Halfway Point!</p>
                                    <p style="font-size: 10px; color: #888; margin: 2px 0 0 0;">Memory is now in the Neocortex. Recognition is fast and recall is reliable.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function closeAnalyticsDisplay() {
            document.getElementById('analyticsDisplayModal').classList.remove('active');
        }
        
        // ==================== EXISTING STUDENT SEARCH FUNCTIONS ====================
        
        let existingStudentsCache = [];
        
        function openExistingStudentSearch() {
            document.getElementById('existingStudentSearchInput').value = '';
            document.getElementById('existingStudentSearchResults').innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Enter a name or email to search...</p>';
            document.getElementById('existingStudentSearchModal').classList.add('active');
        }
        
        function closeExistingStudentSearch() {
            document.getElementById('existingStudentSearchModal').classList.remove('active');
        }
        
        async function searchExistingStudents() {
            const searchTerm = document.getElementById('existingStudentSearchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('existingStudentSearchResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Enter at least 2 characters to search...</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p style="color: #00ffff; font-size: 12px; text-align: center;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Searching...</p>';
            
            try {
                // Search in the users collection (students with accounts)
                const usersSnapshot = await db.collection('users').where('role', '==', 'student').get();
                
                const matchingUsers = [];
                const existingEmails = new Set(allStudents.map(s => s.email?.toLowerCase()));
                
                usersSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const email = (data.email || '').toLowerCase();
                    const displayName = (data.displayName || '').toLowerCase();
                    
                    // Check if matches search term
                    if (email.includes(searchTerm) || displayName.includes(searchTerm)) {
                        // Check if already in scheduler_students
                        const alreadyRegistered = existingEmails.has(email);
                        
                        matchingUsers.push({
                            uid: doc.id,
                            email: data.email,
                            displayName: data.displayName || email.split('@')[0],
                            phone: data.phoneNumber || data.phone || '',
                            discord: data.discord || '',
                            alreadyRegistered
                        });
                    }
                });
                
                if (matchingUsers.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 40px; margin-bottom: 15px;">ðŸ”</div>
                            <p style="color: #888; font-size: 13px;">No students found matching "${searchTerm}"</p>
                            <p style="color: #666; font-size: 12px; margin-top: 10px;">Try a different search term.</p>
                        </div>
                    `;
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <p style="font-size: 12px; color: #888; margin-bottom: 10px;">Found ${matchingUsers.length} student(s):</p>
                    <div style="display: grid; gap: 10px;">
                        ${matchingUsers.map(user => `
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid ${user.alreadyRegistered ? '#888' : '#00ffff'}; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-size: 14px; color: ${user.alreadyRegistered ? '#888' : '#00ffff'}; margin: 0 0 5px 0;">${user.displayName}</p>
                                        <p style="font-size: 12px; color: #888; margin: 0;">${user.email}</p>
                                    </div>
                                    ${user.alreadyRegistered ? `
                                        <span style="background: rgba(136,136,136,0.2); color: #888; padding: 6px 12px; border-radius: 5px; font-size: 12px;">Already Registered</span>
                                    ` : `
                                        <button class="btn btn-success btn-sm" onclick="openAddExistingStudentForm('${user.uid}', '${user.displayName.replace(/'/g, "\\'")}', '${user.email}', '${(user.phone || '').replace(/'/g, "\\'")}', '${(user.discord || '').replace(/'/g, "\\'")}')">âž• Add</button>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error searching students:', error);
                resultsDiv.innerHTML = `<p style="color: #ff3366; font-size: 12px; text-align: center;">Error searching: ${error.message}</p>`;
            }
        }
        
        function openAddExistingStudentForm(uid, name, email, phone, discord) {
            document.getElementById('addExistingStudentUid').value = uid;
            document.getElementById('addExistingStudentName').textContent = name;
            document.getElementById('addExistingStudentEmail').textContent = email;
            document.getElementById('addExistingStudentPhone').value = phone || '';
            document.getElementById('addExistingStudentDiscord').value = discord || '';
            document.getElementById('addExistingStudentCountry').value = 'US';
            document.getElementById('addExistingStudentTimezone').value = 'America/New_York';
            
            document.getElementById('existingStudentSearchModal').classList.remove('active');
            document.getElementById('addExistingStudentFormModal').classList.add('active');
        }
        
        function closeAddExistingStudentForm() {
            document.getElementById('addExistingStudentFormModal').classList.remove('active');
        }
        
        async function confirmAddExistingStudent() {
            const uid = document.getElementById('addExistingStudentUid').value;
            const name = document.getElementById('addExistingStudentName').textContent;
            const email = document.getElementById('addExistingStudentEmail').textContent;
            const phone = document.getElementById('addExistingStudentPhone').value.trim();
            const discord = document.getElementById('addExistingStudentDiscord').value.trim();
            const country = document.getElementById('addExistingStudentCountry').value;
            const timezone = document.getElementById('addExistingStudentTimezone').value;
            
            try {
                // Add to scheduler_students collection
                await db.collection('scheduler_students').add({
                    name: name,
                    email: email,
                    phone: phone,
                    discord: discord,
                    country: country,
                    timezone: timezone,
                    existingAccountUid: uid,
                    status: 'pending',
                    isReturningStudent: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`âœ… ${name} has been added to registered students!`);
                closeAddExistingStudentForm();
                loadAllStudents();
                
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student: ' + error.message);
            }
        }
        
        // ==================== CLASS COMPLETE REMINDER (Week 6 after all marked) ====================
        
        let classCompleteReminderShownFor = new Set(); // Track which classes we've shown reminder for
        
        async function checkClassAttendanceComplete(classId) {
            // Only check if it's week 6
            if (schedulerSettings.currentWeek !== 6) return;
            
            // Don't show again for same class in this session
            if (classCompleteReminderShownFor.has(classId)) return;
            
            const cls = allClasses.find(c => c.id === classId);
            if (!cls || !cls.students || cls.students.length === 0) return;
            
            try {
                // Get all attendance records for this class in week 6
                const attendanceSnap = await db.collection('scheduler_attendance')
                    .where('classId', '==', classId)
                    .where('week', '==', 6)
                    .get();
                
                const markedStudents = new Set(attendanceSnap.docs.map(d => d.data().studentId));
                const allMarked = cls.students.every(s => markedStudents.has(s.id));
                
                if (allMarked) {
                    classCompleteReminderShownFor.add(classId);
                    document.getElementById('classCompleteReminderModal').classList.add('active');
                }
            } catch (e) {
                console.error('Error checking class attendance complete:', e);
            }
        }
        
        function closeClassCompleteReminderModal() {
            document.getElementById('classCompleteReminderModal').classList.remove('active');
        }

        // ==================== DATABASE CLEANUP ====================
        
        let cleanupIssues = {
            orphanAssigned: [],      // Students marked 'assigned' but class doesn't exist
            orphanProposed: [],      // Students marked 'proposed' but proposal doesn't exist
            invalidClassRefs: [],    // Students with classId that doesn't exist
            invalidProposalRefs: []  // Students with proposalId that doesn't exist
        };
        
        async function scanForIssues() {
            const preview = document.getElementById('cleanupPreview');
            const issuesList = document.getElementById('cleanupIssuesList');
            const cleanBtn = document.getElementById('cleanOrphansBtn');
            
            issuesList.innerHTML = '<p style="font-size: 12px; color: #888;">Scanning...</p>';
            preview.style.display = 'block';
            
            // Reset issues
            cleanupIssues = {
                orphanAssigned: [],
                orphanProposed: [],
                invalidClassRefs: [],
                invalidProposalRefs: []
            };
            
            try {
                // Load fresh data from Firebase
                const [studentsSnap, classesSnap, proposalsSnap] = await Promise.all([
                    db.collection('scheduler_students').get(),
                    db.collection('scheduler_classes').get(),
                    db.collection('scheduler_proposals').get()
                ]);
                
                const students = studentsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                const classIds = new Set(classesSnap.docs.map(d => d.id));
                const proposalIds = new Set(proposalsSnap.docs.map(d => d.id));
                
                // Check each student
                for (const student of students) {
                    // Check for assigned status with non-existent class
                    if (student.status === 'assigned') {
                        if (!student.classId || !classIds.has(student.classId)) {
                            cleanupIssues.orphanAssigned.push(student);
                        }
                    }
                    
                    // Check for proposed status with non-existent proposal
                    if (student.status === 'proposed') {
                        if (!student.proposalId || !proposalIds.has(student.proposalId)) {
                            cleanupIssues.orphanProposed.push(student);
                        }
                    }
                    
                    // Check for classId reference to non-existent class
                    if (student.classId && !classIds.has(student.classId)) {
                        cleanupIssues.invalidClassRefs.push(student);
                    }
                    
                    // Check for proposalId reference to non-existent proposal
                    if (student.proposalId && !proposalIds.has(student.proposalId)) {
                        cleanupIssues.invalidProposalRefs.push(student);
                    }
                }
                
                // Build issues report
                const totalIssues = cleanupIssues.orphanAssigned.length + 
                                   cleanupIssues.orphanProposed.length;
                
                if (totalIssues === 0) {
                    issuesList.innerHTML = '<p style="font-size: 13px; color: #39ff14;">âœ… No issues found! Database is clean.</p>';
                    cleanBtn.disabled = true;
                } else {
                    let html = '';
                    
                    if (cleanupIssues.orphanAssigned.length > 0) {
                        html += `
                            <div style="margin-bottom: 10px;">
                                <p style="font-size: 12px; color: #ff3366;">âš ï¸ ${cleanupIssues.orphanAssigned.length} students marked "assigned" but class doesn't exist:</p>
                                <div style="margin-left: 10px;">
                                    ${cleanupIssues.orphanAssigned.map(s => `
                                        <span style="display: inline-block; padding: 3px 8px; margin: 2px; background: rgba(255,51,102,0.2); border-radius: 10px; font-size: 11px; color: #ff3366;">
                                            ${s.name} (classId: ${s.classId || 'null'})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (cleanupIssues.orphanProposed.length > 0) {
                        html += `
                            <div style="margin-bottom: 10px;">
                                <p style="font-size: 12px; color: #ffff00;">âš ï¸ ${cleanupIssues.orphanProposed.length} students marked "proposed" but proposal doesn't exist:</p>
                                <div style="margin-left: 10px;">
                                    ${cleanupIssues.orphanProposed.map(s => `
                                        <span style="display: inline-block; padding: 3px 8px; margin: 2px; background: rgba(255,255,0,0.2); border-radius: 10px; font-size: 11px; color: #ffff00;">
                                            ${s.name} (proposalId: ${s.proposalId || 'null'})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `<p style="font-size: 12px; color: #00ffff; margin-top: 10px;">Click "Clean Orphan Records" to fix these ${totalIssues} issue(s).</p>`;
                    
                    issuesList.innerHTML = html;
                    cleanBtn.disabled = false;
                }
                
            } catch (e) {
                console.error('Error scanning for issues:', e);
                issuesList.innerHTML = `<p style="font-size: 12px; color: #ff3366;">âŒ Error: ${e.message}</p>`;
                cleanBtn.disabled = true;
            }
        }
        
        async function cleanOrphanRecords() {
            const totalIssues = cleanupIssues.orphanAssigned.length + cleanupIssues.orphanProposed.length;
            
            if (totalIssues === 0) {
                alert('No issues to clean.');
                return;
            }
            
            if (!confirm(`This will reset ${totalIssues} orphan student record(s) to "pending" status. Continue?`)) return;
            
            try {
                let fixed = 0;
                
                // Fix orphan assigned students
                for (const student of cleanupIssues.orphanAssigned) {
                    await db.collection('scheduler_students').doc(student.id).update({
                        status: 'pending',
                        classId: null
                    });
                    fixed++;
                }
                
                // Fix orphan proposed students
                for (const student of cleanupIssues.orphanProposed) {
                    await db.collection('scheduler_students').doc(student.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    fixed++;
                }
                
                showMessage('cleanupMessage', `âœ… Fixed ${fixed} orphan record(s). Students reset to "pending" status.`, 'success');
                
                // Reload data
                await loadAllStudents();
                await loadAllClasses();
                await loadProposals();
                
                // Clear preview
                document.getElementById('cleanupPreview').style.display = 'none';
                document.getElementById('cleanOrphansBtn').disabled = true;
                
                // Reset issues
                cleanupIssues = {
                    orphanAssigned: [],
                    orphanProposed: [],
                    invalidClassRefs: [],
                    invalidProposalRefs: []
                };
                
            } catch (e) {
                console.error('Error cleaning orphan records:', e);
                showMessage('cleanupMessage', `âŒ Error: ${e.message}`, 'error');
            }
        }
        
        async function resetAllData() {
            if (!confirm('âš ï¸ WARNING: This will DELETE ALL students, classes, proposals, and attendance records. This cannot be undone!\n\nAre you absolutely sure?')) return;
            if (!confirm('âš ï¸ FINAL WARNING: All data will be permanently deleted. Type "DELETE" in the next prompt to confirm.')) return;
            
            const confirmation = prompt('Type "DELETE" to confirm:');
            if (confirmation !== 'DELETE') {
                alert('Reset cancelled.');
                return;
            }
            
            try {
                showMessage('cleanupMessage', 'ðŸ”„ Deleting all data...', 'info');
                
                // Delete all students
                const studentsSnap = await db.collection('scheduler_students').get();
                for (const doc of studentsSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all classes
                const classesSnap = await db.collection('scheduler_classes').get();
                for (const doc of classesSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all proposals
                const proposalsSnap = await db.collection('scheduler_proposals').get();
                for (const doc of proposalsSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all attendance records
                const attendanceSnap = await db.collection('scheduler_attendance').get();
                for (const doc of attendanceSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Reset local arrays
                allStudents = [];
                allClasses = [];
                allProposals = [];
                
                // Refresh UI
                renderStudentsTable();
                renderClasses();
                renderProposals();
                renderAvailableStudentsForProposals();
                updateDashboardStats();
                
                showMessage('cleanupMessage', 'âœ… All data has been deleted.', 'success');
                document.getElementById('cleanupPreview').style.display = 'none';
                
            } catch (e) {
                console.error('Error resetting data:', e);
                showMessage('cleanupMessage', `âŒ Error: ${e.message}`, 'error');
            }
        }

        // ==================== PROPOSALS ====================
        
        async function loadProposals() {
            try {
                const snap = await db.collection('scheduler_proposals').orderBy('createdAt', 'desc').get();
                allProposals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderProposals();
            } catch (e) {
                console.error('Error loading proposals:', e);
            }
        }
        
        function renderProposals() {
            const container = document.getElementById('proposalsContainer');
            if (!container) return;
            
            if (allProposals.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No proposals yet. Use "Auto-Generate Classes" to create proposals.</p>';
                return;
            }
            
            container.innerHTML = allProposals.map(p => {
                const teacher = allTeachers.find(t => t.id === p.teacherId);
                const statusLabel = {
                    'draft': 'Draft - Select Date',
                    'sent': 'Awaiting Responses',
                    'all_agreed': 'All Students Agreed! âœ“',
                    'has_rejections': 'Has Rejections'
                }[p.status] || p.status;
                
                const agreedCount = (p.students || []).filter(s => s.response === 'agreed').length;
                const rejectedCount = (p.students || []).filter(s => s.response === 'rejected').length;
                const pendingCount = (p.students || []).filter(s => s.response === 'pending').length;
                
                return `
                    <div class="proposal-card status-${p.status}" id="proposal-${p.id}">
                        <div class="proposal-header">
                            <div class="proposal-info">
                                <div class="proposal-day">${p.day} @ ${p.time}</div>
                                <div class="proposal-time">
                                    <span class="level-badge level-${p.level}">${LEVELS[p.level]}</span>
                                    ${teacher ? `<span style="margin-left: 10px;">ðŸ‘¨â€ðŸ« ${teacher.name}</span>` : '<span style="margin-left: 10px; color: #888;">No teacher assigned</span>'}
                                </div>
                            </div>
                            <span class="proposal-status ${p.status}">${statusLabel}</span>
                        </div>
                        
                        <div class="proposal-students" 
                            ondragover="handleProposalDragOver(event)" 
                            ondragleave="handleProposalDragLeave(event)" 
                            ondrop="handleProposalDrop(event, '${p.id}')"
                            data-proposal-id="${p.id}">
                            <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
                                Students: ${(p.students || []).length} 
                                ${p.status !== 'draft' ? `(âœ“ ${agreedCount} | âœ— ${rejectedCount} | â³ ${pendingCount})` : ''}
                            </div>
                            ${(p.students || []).map(s => `
                                <div class="proposal-student">
                                    <span class="proposal-student-name">${s.name}</span>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span class="proposal-student-response ${s.response}">${s.response === 'agreed' ? 'âœ“ Agreed' : s.response === 'rejected' ? 'âœ— Rejected' : 'â³ Pending'}</span>
                                        <button class="btn btn-sm btn-danger" onclick="removeStudentFromProposal('${p.id}', '${s.id}')" title="Remove from proposal" style="padding: 2px 5px; font-size: 10px;">âœ•</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${(p.students || []).length === 0 ? '<p style="color: #666; font-size: 11px; text-align: center;">Drop students here</p>' : ''}
                        </div>
                        
                        <div class="proposal-date-picker" style="${p.proposedStartDate ? 'background: rgba(57,255,20,0.1); border-color: #39ff14;' : ''}">
                            <label style="font-size: 12px; color: ${p.proposedStartDate ? '#39ff14' : '#ffff00'};">
                                ðŸ“… ${p.proposedStartDate ? 'Proposed Start Date:' : 'Select Proposed Start Date:'}
                            </label>
                            <input type="date" 
                                id="proposalDate-${p.id}" 
                                value="${p.proposedStartDate || ''}"
                                style="margin-left: 10px; font-family: 'Noto Sans', sans-serif; font-size: 12px; padding: 5px; background: #1a1a2e; color: ${p.proposedStartDate ? '#39ff14' : '#00ffff'}; border: 1px solid ${p.proposedStartDate ? '#39ff14' : '#00ffff'}; border-radius: 4px;" 
                                onchange="updateProposalDate('${p.id}', this.value)">
                            <div class="saturday-quick-btns" style="margin-top: 8px;">
                                ${getUpcomingSaturdaysHTML(p.id, p.proposedStartDate)}
                            </div>
                        </div>
                        
                        <div class="proposal-actions">
                            ${p.proposedStartDate ? `
                                <button class="btn btn-sm btn-success" onclick="initiateProposal('${p.id}')" style="background: linear-gradient(135deg, #39ff14, #00ff88);">ðŸš€ Initiate Class</button>
                            ` : ''}
                            ${p.status === 'draft' && p.proposedStartDate ? `
                                <button class="btn btn-sm btn-info" onclick="sendProposalToStudents('${p.id}')">ðŸ“§ Send to Students</button>
                            ` : ''}
                            <button class="btn btn-sm btn-warning" onclick="reclassProposal('${p.id}')">ðŸ”„ ReClass</button>
                            ${canDelete() ? `<button class="btn btn-sm btn-danger admin-delete-btn" onclick="deleteProposal('${p.id}')">ðŸ—‘ï¸ Delete</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderAvailableStudentsForProposals() {
            const container = document.getElementById('availableStudentsForProposals');
            if (!container) return;
            
            // Get students who are not assigned, not in proposals, and have a level
            const available = allStudents.filter(s => 
                s.level && 
                s.status !== 'assigned' && 
                s.status !== 'proposed' && 
                s.status !== 'completed'
            );
            
            if (available.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">No available students.</p>';
                return;
            }
            
            container.innerHTML = available.map(s => {
                // Check if student is a good fit for any proposal
                const isGoodFit = allProposals.some(p => {
                    if (p.level !== s.level) return false;
                    const slot = `${p.day}-${p.time}`;
                    return Object.values(s.availabilities || {}).includes(slot);
                });
                
                const availSlots = Object.entries(s.availabilities || {})
                    .map(([rank, slot]) => `${rank}: ${slot}`)
                    .join(', ');
                
                return `
                    <div class="available-student ${isGoodFit ? 'rainbow-fit' : ''}" 
                        draggable="true" 
                        ondragstart="handleAvailableStudentDragStart(event, '${s.id}')"
                        ondragend="handleAvailableStudentDragEnd(event)"
                        data-student-id="${s.id}">
                        <div class="available-student-name">${s.name} ${isGoodFit ? 'ðŸŒˆ' : ''}</div>
                        <div class="available-student-info">
                            <span class="level-badge level-${s.level}" style="font-size: 10px; padding: 2px 4px;">${LEVELS[s.level]}</span>
                            <span style="margin-left: 5px;">${s.status || 'pending'}</span>
                        </div>
                        <div class="available-student-info" style="margin-top: 3px; font-size: 10px; color: #666;">
                            ${availSlots || 'No availability set'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Drag and drop for proposals
        function handleAvailableStudentDragStart(event, studentId) {
            draggedProposalStudentId = studentId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleAvailableStudentDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedProposalStudentId = null;
        }
        
        function handleProposalDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleProposalDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        async function handleProposalDrop(event, proposalId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedProposalStudentId) return;
            
            const student = allStudents.find(s => s.id === draggedProposalStudentId);
            const proposal = allProposals.find(p => p.id === proposalId);
            
            if (!student || !proposal) return;
            
            // Check level match
            if (student.level !== proposal.level) {
                if (!confirm(`Level mismatch: Student is ${LEVELS[student.level]}, class is ${LEVELS[proposal.level]}. Add anyway?`)) {
                    return;
                }
            }
            
            // Check if already in this proposal
            if ((proposal.students || []).some(s => s.id === student.id)) {
                alert('Student is already in this proposal.');
                return;
            }
            
            // Check availability match
            const slot = `${proposal.day}-${proposal.time}`;
            const availRank = Object.entries(student.availabilities || {}).find(([r, s]) => s === slot)?.[0] || 3;
            
            try {
                // Add student to proposal
                const newStudent = {
                    id: student.id,
                    name: student.name,
                    email: student.email,
                    discord: student.discord || '',
                    rank: parseInt(availRank),
                    timezone: student.timezone,
                    response: proposal.status === 'draft' ? 'pending' : 'pending'
                };
                
                proposal.students = proposal.students || [];
                proposal.students.push(newStudent);
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                // Update student status
                await db.collection('scheduler_students').doc(student.id).update({
                    status: 'proposed',
                    proposalId: proposalId
                });
                
                const idx = allStudents.findIndex(s => s.id === student.id);
                if (idx !== -1) {
                    allStudents[idx].status = 'proposed';
                    allStudents[idx].proposalId = proposalId;
                }
                
                renderProposals();
                renderAvailableStudentsForProposals();
            } catch (e) {
                console.error('Error adding student to proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function removeStudentFromProposal(proposalId, studentId) {
            if (!confirm('Remove this student from the proposal? They will be returned to the available students list.')) return;
            
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                proposal.students = (proposal.students || []).filter(s => s.id !== studentId);
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                // Update student status back to pending/limbo
                await db.collection('scheduler_students').doc(studentId).update({
                    status: 'pending',
                    proposalId: null
                });
                
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) {
                    allStudents[idx].status = 'pending';
                    allStudents[idx].proposalId = null;
                }
                
                // Recalculate proposal status
                await updateProposalStatus(proposalId);
                
                renderProposals();
                renderAvailableStudentsForProposals();
            } catch (e) {
                console.error('Error removing student:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function updateProposalDate(proposalId, date) {
            try {
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    proposedStartDate: date
                });
                
                const proposal = allProposals.find(p => p.id === proposalId);
                if (proposal) proposal.proposedStartDate = date;
                
                renderProposals();
            } catch (e) {
                console.error('Error updating proposal date:', e);
            }
        }
        
        async function sendProposalToStudents(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal || !proposal.proposedStartDate) {
                alert('Please select a proposed start date first.');
                return;
            }
            
            if ((proposal.students || []).length === 0) {
                alert('No students in this proposal.');
                return;
            }
            
            // Show Discord names modal
            showDiscordNamesModal(proposal);
        }
        
        function showDiscordNamesModal(proposal) {
            const students = proposal.students || [];
            const discordNames = students.map(s => s.discord || `${s.name} (no Discord)`).join('\n');
            const startDate = new Date(proposal.proposedStartDate).toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'discordNamesModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <button class="modal-close" onclick="closeDiscordNamesModal()">âœ•</button>
                    <h3 class="modal-title">ðŸ“‹ Discord Names to Contact</h3>
                    <p style="font-size: 12px; color: #888; margin-bottom: 15px;">
                        Class: <span style="color: #00ffff;">${proposal.day} @ ${proposal.time}</span> | 
                        Level: <span class="level-badge level-${proposal.level}">${LEVELS[proposal.level]}</span> |
                        Start: <span style="color: #39ff14;">${startDate}</span>
                    </p>
                    
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <textarea id="discordNamesList" readonly style="width: 100%; height: 150px; background: transparent; border: none; color: #fff; font-family: 'Noto Sans', sans-serif; font-size: 12px; resize: none; outline: none;">${discordNames}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-success" onclick="copyDiscordNames()">ðŸ“‹ Copy All Names</button>
                        <button class="btn btn-info" onclick="confirmSendProposal('${proposal.id}')">ðŸ“§ Mark as Sent</button>
                        <button class="btn btn-secondary" onclick="closeDiscordNamesModal()">Close</button>
                    </div>
                    
                    <p id="copyConfirmation" style="font-size: 12px; color: #39ff14; text-align: center; margin-top: 10px; display: none;">âœ“ Copied to clipboard!</p>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyDiscordNames() {
            const textarea = document.getElementById('discordNamesList');
            textarea.select();
            document.execCommand('copy');
            
            // Also try modern clipboard API
            navigator.clipboard.writeText(textarea.value).catch(() => {});
            
            const confirmation = document.getElementById('copyConfirmation');
            confirmation.style.display = 'block';
            setTimeout(() => confirmation.style.display = 'none', 2000);
        }
        
        function closeDiscordNamesModal() {
            const modal = document.getElementById('discordNamesModal');
            if (modal) modal.remove();
        }
        
        async function confirmSendProposal(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            try {
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    status: 'sent'
                });
                
                proposal.status = 'sent';
                closeDiscordNamesModal();
                renderProposals();
                
                alert(`Proposal marked as sent to ${proposal.students.length} students!`);
            } catch (e) {
                console.error('Error sending proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function updateProposalStatus(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal || proposal.status === 'draft') return;
            
            const students = proposal.students || [];
            const allAgreed = students.length > 0 && students.every(s => s.response === 'agreed');
            const hasRejections = students.some(s => s.response === 'rejected');
            
            let newStatus = 'sent';
            if (allAgreed) newStatus = 'all_agreed';
            else if (hasRejections) newStatus = 'has_rejections';
            
            if (newStatus !== proposal.status) {
                await db.collection('scheduler_proposals').doc(proposalId).update({ status: newStatus });
                proposal.status = newStatus;
            }
        }
        
        // Simulate student response (for testing - in production this would be done by students)
        async function simulateStudentResponse(proposalId, studentId, response) {
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                const student = proposal.students.find(s => s.id === studentId);
                if (student) student.response = response;
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                await updateProposalStatus(proposalId);
                renderProposals();
            } catch (e) {
                console.error('Error updating response:', e);
            }
        }
        
        async function proceedWithClass(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            const agreedStudents = (proposal.students || []).filter(s => s.response === 'agreed' || proposal.status === 'draft');
            
            if (agreedStudents.length < schedulerSettings.minStudents) {
                if (!confirm(`Only ${agreedStudents.length} students agreed (minimum is ${schedulerSettings.minStudents}). Proceed anyway?`)) return;
            }
            
            if (!proposal.proposedStartDate) {
                alert('Please set a start date before proceeding.');
                return;
            }
            
            try {
                // Create actual class from proposal
                const classData = {
                    day: proposal.day,
                    time: proposal.time,
                    level: proposal.level,
                    students: agreedStudents.map(s => ({
                        id: s.id,
                        name: s.name,
                        rank: s.rank,
                        timezone: s.timezone
                    })),
                    teacherId: proposal.teacherId,
                    startDate: proposal.proposedStartDate,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const classRef = await db.collection('scheduler_classes').add(classData);
                
                // Update students to assigned status
                for (const s of agreedStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'assigned',
                        classId: classRef.id,
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'assigned';
                        allStudents[idx].classId = classRef.id;
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Handle rejected students - return to pending
                const rejectedStudents = (proposal.students || []).filter(s => s.response === 'rejected');
                for (const s of rejectedStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                // Add to classes list
                allClasses.push({ id: classRef.id, ...classData });
                
                // Update settings with start date
                schedulerSettings.startDate = proposal.proposedStartDate;
                await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderClasses();
                updateDashboardStats();
                
                alert(`Class created successfully with ${agreedStudents.length} students!`);
            } catch (e) {
                console.error('Error creating class:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function initiateProposal(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            if (!proposal.proposedStartDate) {
                alert('Please set a start date before initiating this class.');
                return;
            }
            
            const students = proposal.students || [];
            if (students.length === 0) {
                alert('No students in this proposal.');
                return;
            }
            
            const startDateFormatted = new Date(proposal.proposedStartDate).toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
            });
            
            if (!confirm(`Initiate class?\n\nðŸ“… ${proposal.day} @ ${proposal.time}\nðŸ“š ${LEVELS[proposal.level]}\nðŸ‘¥ ${students.length} students\nðŸ—“ï¸ Starting: ${startDateFormatted}\n\nThis will create the class and add it to the schedule.`)) return;
            
            try {
                // Create actual class from proposal
                const classData = {
                    day: proposal.day,
                    time: proposal.time,
                    level: proposal.level,
                    students: students.map(s => ({
                        id: s.id,
                        name: s.name,
                        rank: s.rank,
                        timezone: s.timezone
                    })),
                    teacherId: proposal.teacherId,
                    startDate: proposal.proposedStartDate,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const classRef = await db.collection('scheduler_classes').add(classData);
                
                // Update students to assigned status
                for (const s of students) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'assigned',
                        classId: classRef.id,
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'assigned';
                        allStudents[idx].classId = classRef.id;
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                // Add to classes list
                allClasses.push({ id: classRef.id, ...classData });
                
                // Update settings with start date if not already set
                if (!schedulerSettings.startDate || proposal.proposedStartDate < schedulerSettings.startDate) {
                    schedulerSettings.startDate = proposal.proposedStartDate;
                    await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
                }
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderClasses();
                renderCourseCalendar();
                updateDashboardStats();
                
                alert(`âœ… Class initiated successfully!\n\n${proposal.day} @ ${proposal.time} with ${students.length} students has been added to the schedule.`);
                
            } catch (e) {
                console.error('Error initiating proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function reclassProposal(proposalId) {
            if (!confirm('This will disband the group and return all students to the available list. Continue?')) return;
            
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                // Return all students to pending
                for (const s of (proposal.students || [])) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderStudentsTable();
                updateDashboardStats();
            } catch (e) {
                console.error('Error reclassing proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteProposal(proposalId) {
            if (!confirm('Delete this proposal? Students will be returned to the available list.')) return;
            await reclassProposal(proposalId);
        }

        // ==================== SUGGESTIONS ====================
        
        let selectedPriority = '';
        
        function selectPriority(priority) {
            selectedPriority = priority;
            document.getElementById('suggestionPriority').value = priority;
            
            // Update button styles
            ['priorityHigh', 'priorityMid', 'priorityLow'].forEach(id => {
                document.getElementById(id).classList.remove('selected');
            });
            
            const btnId = priority === 'high' ? 'priorityHigh' : priority === 'mid' ? 'priorityMid' : 'priorityLow';
            document.getElementById(btnId).classList.add('selected');
        }
        
        async function submitSuggestion() {
            const title = document.getElementById('suggestionTitle').value.trim();
            const description = document.getElementById('suggestionDescription').value.trim();
            const priority = document.getElementById('suggestionPriority').value;
            
            if (!title) { showMessage('suggestionFormMessage', 'Please enter a title', 'error'); return; }
            if (!description) { showMessage('suggestionFormMessage', 'Please enter a description', 'error'); return; }
            if (!priority) { showMessage('suggestionFormMessage', 'Please select a priority level', 'error'); return; }
            
            // Get teacher ID (stored as odId for teachers)
            const teacherId = currentUser.odId || currentUser.id || currentUser.uid;
            
            try {
                await db.collection('scheduler_suggestions').add({
                    title,
                    description,
                    priority,
                    status: 'pending',
                    teacherId: teacherId,
                    teacherName: currentUser.name,
                    adminResponse: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    respondedAt: null
                });
                
                showMessage('suggestionFormMessage', 'Suggestion submitted successfully!', 'success');
                
                // Reset form
                document.getElementById('suggestionTitle').value = '';
                document.getElementById('suggestionDescription').value = '';
                document.getElementById('suggestionPriority').value = '';
                selectedPriority = '';
                ['priorityHigh', 'priorityMid', 'priorityLow'].forEach(id => {
                    document.getElementById(id).classList.remove('selected');
                });
                
                // Reload suggestions list
                loadTeacherSuggestions();
            } catch (e) {
                showMessage('suggestionFormMessage', 'Error: ' + e.message, 'error');
            }
        }
        
        async function loadTeacherSuggestions() {
            const container = document.getElementById('teacherSuggestionsContainer');
            if (!container || !currentUser) return;
            
            // Get teacher ID (stored as odId for teachers)
            const teacherId = currentUser.odId || currentUser.id || currentUser.uid;
            
            try {
                const snap = await db.collection('scheduler_suggestions')
                    .where('teacherId', '==', teacherId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (snap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No suggestions submitted yet.</p>';
                    return;
                }
                
                container.innerHTML = snap.docs.map(doc => {
                    const s = doc.data();
                    const date = s.createdAt ? new Date(s.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    const priorityLabel = s.priority === 'high' ? 'ðŸ”´ High' : s.priority === 'mid' ? 'ðŸŸ¡ Mid' : 'ðŸŸ¢ Low';
                    const statusLabel = s.status === 'pending' ? 'Pending Review' : s.status === 'approved' ? 'Approved âœ“' : 'Declined';
                    
                    return `
                        <div class="suggestion-card priority-${s.priority}">
                            <div class="suggestion-header">
                                <div class="suggestion-title">${s.title}</div>
                                <span class="suggestion-priority ${s.priority}">${priorityLabel}</span>
                            </div>
                            <div class="suggestion-body">${s.description}</div>
                            <div class="suggestion-meta">
                                <span>Submitted: ${date}</span>
                                <span class="suggestion-status ${s.status}">${statusLabel}</span>
                            </div>
                            ${s.adminResponse ? `
                                <div style="margin-top: 10px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 5px;">
                                    <p style="font-size: 11px; color: #00ffff; margin-bottom: 5px;">ðŸ“¬ Admin Response:</p>
                                    <p style="font-size: 12px; color: #ccc;">${s.adminResponse}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading teacher suggestions:', e);
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">Error loading suggestions.</p>';
            }
        }
        
        async function loadAdminSuggestions() {
            const container = document.getElementById('adminSuggestionsContainer');
            if (!container) return;
            
            try {
                const snap = await db.collection('scheduler_suggestions')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (snap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 12px;">No suggestions yet.</p>';
                    return;
                }
                
                container.innerHTML = snap.docs.map(doc => {
                    const s = doc.data();
                    const date = s.createdAt ? new Date(s.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    const priorityLabel = s.priority === 'high' ? 'ðŸ”´ High' : s.priority === 'mid' ? 'ðŸŸ¡ Mid' : 'ðŸŸ¢ Low';
                    const statusLabel = s.status === 'pending' ? 'Pending Review' : s.status === 'approved' ? 'Approved âœ“' : 'Declined';
                    
                    return `
                        <div class="suggestion-card priority-${s.priority}">
                            <div class="suggestion-header">
                                <div class="suggestion-title">${s.title}</div>
                                <span class="suggestion-priority ${s.priority}">${priorityLabel}</span>
                            </div>
                            <div class="suggestion-body">${s.description}</div>
                            <div class="suggestion-meta">
                                <span>ðŸ‘¨â€ðŸ« ${s.teacherName} â€¢ ${date}</span>
                                <span class="suggestion-status ${s.status}">${statusLabel}</span>
                            </div>
                            ${s.status === 'pending' ? `
                                <div class="suggestion-actions">
                                    <button class="btn btn-sm btn-success" onclick="respondToSuggestion('${doc.id}', 'approved')">âœ“ Approve</button>
                                    <button class="btn btn-sm btn-danger" onclick="respondToSuggestion('${doc.id}', 'declined')">âœ— Decline</button>
                                </div>
                            ` : `
                                ${s.adminResponse ? `
                                    <div style="margin-top: 10px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 5px;">
                                        <p style="font-size: 11px; color: #00ffff; margin-bottom: 5px;">ðŸ“¬ Your Response:</p>
                                        <p style="font-size: 12px; color: #ccc;">${s.adminResponse}</p>
                                    </div>
                                ` : ''}
                            `}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading admin suggestions:', e);
                container.innerHTML = '<p style="color: #ff3366; font-size: 12px;">Error loading suggestions.</p>';
            }
        }
        
        async function respondToSuggestion(suggestionId, status) {
            let adminResponse = '';
            
            if (status === 'approved') {
                adminResponse = prompt('Add a message (optional):', 'Approved! We will work on this.');
                if (adminResponse === null) return; // Cancelled
                if (!adminResponse) adminResponse = 'Approved! We will work on this.';
            } else {
                adminResponse = prompt('Reason for declining:', 'After careful consideration, it would take too many resources for this.');
                if (adminResponse === null) return; // Cancelled
                if (!adminResponse) adminResponse = 'After careful consideration, it would take too many resources for this.';
            }
            
            try {
                await db.collection('scheduler_suggestions').doc(suggestionId).update({
                    status,
                    adminResponse,
                    respondedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                loadAdminSuggestions();
            } catch (e) {
                console.error('Error responding to suggestion:', e);
                alert('Error: ' + e.message);
            }
        }

        // ==================== VIDEO RECORDING ====================
        
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStream = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let isRecording = false;
        
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        async function startRecording() {
            if (isRecording) return;
            
            try {
                // Request camera and microphone access with 720p
                recordingStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: true
                });
                
                // Show preview
                const preview = document.getElementById('videoPreview');
                const playback = document.getElementById('videoPlayback');
                preview.srcObject = recordingStream;
                preview.style.display = 'block';
                playback.style.display = 'none';
                
                // Setup recorder
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(recordingStream, { mimeType: 'video/webm' });
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    await uploadRecording(blob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                const btn = document.getElementById('recordBtn');
                btn.className = 'record-btn recording';
                btn.textContent = 'â¹ï¸ STOP RECORDING';
                document.getElementById('recordingSection').classList.add('recording');
                document.getElementById('recordingStatus').textContent = 'Recording in progress... Click button to stop.';
                
                // Start timer with 1-minute limit
                recordingSeconds = 0;
                document.getElementById('recordingTimer').style.display = 'block';
                updateRecordingTimer();
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    updateRecordingTimer();
                    
                    // Auto-stop at 1 minute
                    if (recordingSeconds >= 60) {
                        stopRecording();
                    }
                }, 1000);
                
            } catch (err) {
                console.error('Error starting recording:', err);
                alert('Could not access camera/microphone. Please allow access and try again.');
            }
        }
        
        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            isRecording = false;
            mediaRecorder.stop();
            
            // Stop all tracks
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            
            // Stop timer
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            // Update UI
            const btn = document.getElementById('recordBtn');
            btn.className = 'record-btn start';
            btn.textContent = 'ðŸŽ¤ RE-RECORD';
            document.getElementById('recordingSection').classList.remove('recording');
            document.getElementById('videoPreview').style.display = 'none';
            document.getElementById('recordingStatus').textContent = 'Processing video...';
        }
        
        function updateRecordingTimer() {
            const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
            const secs = (recordingSeconds % 60).toString().padStart(2, '0');
            document.getElementById('recordingTimer').textContent = `${mins}:${secs} / 01:00`;
        }
        
        async function uploadRecording(blob) {
            try {
                document.getElementById('recordingStatus').textContent = 'Uploading video...';
                
                // Generate unique filename
                const filename = `recordings/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.webm`;
                const storageRef = firebase.storage().ref().child(filename);
                
                // Upload to Firebase Storage
                const snapshot = await storageRef.put(blob);
                const downloadUrl = await snapshot.ref.getDownloadURL();
                
                // Store URL in hidden field
                document.getElementById('studentVideoUrl').value = downloadUrl;
                
                // Show playback
                const playback = document.getElementById('videoPlayback');
                playback.src = downloadUrl;
                playback.style.display = 'block';
                
                document.getElementById('recordingStatus').innerHTML = '<span style="color: #39ff14;">âœ… Video uploaded successfully!</span>';
                document.getElementById('recordingTimer').style.display = 'none';
                
            } catch (err) {
                console.error('Error uploading recording:', err);
                document.getElementById('recordingStatus').innerHTML = '<span style="color: #ff3366;">âŒ Upload failed. Please try again.</span>';
            }
        }

        // ==================== READY TAB FUNCTIONS ====================
        
        let allReadyRequests = [];
        let filteredReadyRequests = [];

        async function loadReadyRequests() {
            const listDiv = document.getElementById('readyRequestsList');
            listDiv.innerHTML = '<p style="color: #00ffff; font-size: 13px;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading requests...</p>';

            try {
                const snapshot = await db.collection('account_ready_requests')
                    .orderBy('submittedAt', 'desc')
                    .get();
                
                allReadyRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filteredReadyRequests = [...allReadyRequests];
                
                updateReadyDashboard();
                renderReadyRequests();
                
            } catch (error) {
                console.error('Error loading ready requests:', error);
                listDiv.innerHTML = `<p style="color: #ff3366; font-size: 13px;">Error: ${error.message}</p>`;
            }
        }

        function updateReadyDashboard() {
            const total = allReadyRequests.length;
            const pending = allReadyRequests.filter(r => !r.checkedOff).length;
            const completed = allReadyRequests.filter(r => r.checkedOff).length;
            
            document.getElementById('statTotalReady').textContent = total;
            document.getElementById('statPendingReady').textContent = pending;
            document.getElementById('statCompletedReady').textContent = completed;
        }

        function filterReadyRequests() {
            const searchTerm = document.getElementById('readySearch').value.toLowerCase();
            const filter = document.getElementById('readyFilter').value;

            filteredReadyRequests = allReadyRequests.filter(r => {
                const matchesSearch = (r.fullName || '').toLowerCase().includes(searchTerm) || 
                                     (r.email || '').toLowerCase().includes(searchTerm);
                
                let matchesFilter = true;
                if (filter === 'pending') matchesFilter = !r.checkedOff;
                if (filter === 'completed') matchesFilter = r.checkedOff;

                return matchesSearch && matchesFilter;
            });

            renderReadyRequests();
        }

        function renderReadyRequests() {
            const listDiv = document.getElementById('readyRequestsList');

            if (filteredReadyRequests.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 13px; color: #888; grid-column: 1/-1;">No requests found.</p>';
                return;
            }

            let html = '';
            filteredReadyRequests.forEach(r => {
                const isChecked = r.checkedOff;
                const borderColor = isChecked ? '#39ff14' : '#ff9800';
                const statusBadge = isChecked 
                    ? '<span style="background: #39ff14; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">âœ… ACCOUNT CREATED</span>'
                    : '<span style="background: #ff9800; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">â³ PENDING</span>';
                
                const submittedDate = r.submittedAt ? new Date(r.submittedAt.toDate()).toLocaleString() : 'N/A';
                
                const checkboxChecked = isChecked ? 'checked' : '';
                
                html += `
                    <div style="background: rgba(0,0,0,0.5); border: 2px solid ${borderColor}; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" ${checkboxChecked} onchange="toggleReadyCheckbox('${r.id}', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="color: #00ffff; font-size: 14px;">${r.fullName || 'Unknown'}</span>
                            </div>
                            ${statusBadge}
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ðŸ“§ ${r.email || 'No email'}</div>
                        <div style="font-size: 11px; color: #666; margin-bottom: 10px;">ðŸ“… Submitted: ${submittedDate}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <button class="btn btn-info btn-sm" onclick="generatePasswordForReady('${r.id}')">
                                ðŸ”‘ PW GEN
                            </button>
                            <span id="pwDisplay_${r.id}" style="font-size: 13px; color: #39ff14; padding: 5px 10px; background: rgba(0,0,0,0.5); border-radius: 4px; display: none;"></span>
                            <button class="btn btn-sm" style="background: #666;" onclick="copyReadyInfo('${escapeHtmlForAcct(r.fullName || '')}', '${escapeHtmlForAcct(r.email || '')}')">
                                ðŸ“‹ COPY INFO
                            </button>
                            <button class="btn btn-success btn-sm" onclick="completeReadyRequest('${r.id}', '${escapeHtmlForAcct(r.fullName || '')}')">
                                âœ… COMPLETE
                            </button>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        async function completeReadyRequest(requestId, fullName) {
            if (!confirm(`Mark "${fullName}" as complete and remove from the list?\n\nThis means the account has been created and this request is no longer needed.`)) {
                return;
            }

            try {
                await db.collection('account_ready_requests').doc(requestId).delete();
                
                // Remove from local arrays
                allReadyRequests = allReadyRequests.filter(r => r.id !== requestId);
                filteredReadyRequests = filteredReadyRequests.filter(r => r.id !== requestId);
                
                updateReadyDashboard();
                renderReadyRequests();
                
                alert(`âœ… "${fullName}" has been removed from the Ready list.`);
                
            } catch (error) {
                console.error('Error completing request:', error);
                alert('Error: ' + error.message);
            }
        }

        async function toggleReadyCheckbox(requestId, isChecked) {
            try {
                await db.collection('account_ready_requests').doc(requestId).update({
                    checkedOff: isChecked,
                    accountCreated: isChecked,
                    accountCreatedAt: isChecked ? firebase.firestore.FieldValue.serverTimestamp() : null
                });
                
                // Update local data
                const request = allReadyRequests.find(r => r.id === requestId);
                if (request) {
                    request.checkedOff = isChecked;
                    request.accountCreated = isChecked;
                }
                
                updateReadyDashboard();
                renderReadyRequests();
                
            } catch (error) {
                console.error('Error updating checkbox:', error);
                alert('Error updating status: ' + error.message);
            }
        }

        function generatePasswordForReady(requestId) {
            // Generate a random password: 2 words + 2 numbers + 1 symbol
            const words = ['Blue', 'Red', 'Green', 'Star', 'Moon', 'Sun', 'Fire', 'Ice', 'Wind', 'Rain', 'Cloud', 'Wave', 'Rock', 'Tree', 'Bird', 'Fish', 'Bear', 'Wolf', 'Lion', 'Tiger', 'Eagle', 'Hawk', 'Swift', 'Brave', 'Bold', 'Cool', 'Fast', 'Bright', 'Dark', 'Light'];
            const symbols = ['!', '@', '#', '$', '%', '&', '*'];
            
            const word1 = words[Math.floor(Math.random() * words.length)];
            const word2 = words[Math.floor(Math.random() * words.length)];
            const num = Math.floor(Math.random() * 90) + 10; // 10-99
            const symbol = symbols[Math.floor(Math.random() * symbols.length)];
            
            const password = `${word1}${word2}${num}${symbol}`;
            
            // Display the password
            const pwDisplay = document.getElementById(`pwDisplay_${requestId}`);
            pwDisplay.textContent = password;
            pwDisplay.style.display = 'inline-block';
            
            // Copy to clipboard
            navigator.clipboard.writeText(password).then(() => {
                // Flash green to indicate copied
                pwDisplay.style.background = 'rgba(57,255,20,0.3)';
                setTimeout(() => {
                    pwDisplay.style.background = 'rgba(0,0,0,0.5)';
                }, 500);
            });
        }

        function copyReadyInfo(fullName, email) {
            const info = `Name: ${fullName}\nEmail: ${email}`;
            navigator.clipboard.writeText(info).then(() => {
                alert('âœ… Info copied to clipboard!');
            });
        }

        // ==================== END READY TAB FUNCTIONS ====================

        // ==================== SLOT MANAGER FUNCTIONS ====================
        
        let selectedSlotInfo = null;
        let templateUploadedImages = [];
        let classTemplates = {}; // Cache for loaded templates
        
        // Use existing TIME_SLOTS and DAYS variables from schedule
        
        async function initSlotManager() {
            // Populate teacher dropdown
            const teacherSelect = document.getElementById('slotManagerTeacher');
            if (teacherSelect) {
                teacherSelect.innerHTML = '<option value="">-- All Teachers --</option>' + 
                    allTeachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }
            
            // Load prescheduled slots from Firebase
            await loadPrescheduledSlots();
            
            // Load class template for first class type
            loadClassTemplate();
            
            renderSlotGrid();
        }
        
        async function loadPrescheduledSlots() {
            try {
                const snapshot = await db.collection('prescheduled_slots').get();
                allPrescheduledSlots = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Loaded prescheduled slots:', allPrescheduledSlots.length);
            } catch (e) {
                console.error('Error loading prescheduled slots:', e);
                allPrescheduledSlots = [];
            }
        }
        
        function renderSlotGrid() {
            const container = document.getElementById('slotGridContainer');
            const selectedTeacherId = document.getElementById('slotManagerTeacher')?.value || '';
            const weeksToShow = parseInt(document.getElementById('slotManagerView')?.value || '8');
            
            const relevantTeachers = selectedTeacherId 
                ? allTeachers.filter(t => t.id === selectedTeacherId)
                : allTeachers;
            
            if (relevantTeachers.length === 0) {
                container.innerHTML = '<p style="color: #888;">No teachers available. Add teachers first.</p>';
                return;
            }
            
            // Build slot status map
            const slotStatus = {}; // key: "day-time" -> { status, class, teacherId, availableDate, week, prescheduled }
            
            const now = new Date();
            
            // First, mark all prescheduled slots
            allPrescheduledSlots.forEach(ps => {
                const key = `${ps.day}-${ps.time}`;
                const startDate = parseLocalDate(ps.startDate);
                
                // Check if there's an active class that replaced this prescheduled slot
                const hasActiveClass = allClasses.some(cls => 
                    cls.day === ps.day && 
                    cls.time === ps.time && 
                    cls.status !== 'completed'
                );
                
                // Only skip prescheduled if an actual active class exists for this slot
                if (hasActiveClass) {
                    return; // An active class has replaced this prescheduled slot
                }
                
                if (!selectedTeacherId || ps.teacherId === selectedTeacherId) {
                    // Determine if slot is full (for coloring)
                    const enrolledCount = ps.enrolledStudents?.length || 0;
                    const maxSeats = ps.maxSeats || 5;
                    const isFull = enrolledCount >= maxSeats;
                    
                    // Calculate end date based on class type duration
                    const weeksTotal = getLevelWeeks(ps.classType) || 6;
                    let endDate = null;
                    if (startDate) {
                        endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + (weeksTotal * 7));
                    }
                    
                    slotStatus[key] = {
                        status: isFull ? 'prescheduled-full' : 'prescheduled',
                        prescheduled: ps,
                        teacherId: ps.teacherId,
                        teacherName: ps.teacherName || allTeachers.find(t => t.id === ps.teacherId)?.name || 'Unknown',
                        classType: ps.classType,
                        startDate: startDate,
                        endDate: endDate,
                        availableDate: endDate, // When the slot opens back up
                        enrolledCount: enrolledCount,
                        maxSeats: maxSeats,
                        weeksTotal: weeksTotal
                    };
                }
            });
            
            // Then check active classes
            allClasses.forEach(cls => {
                if (cls.status === 'completed') return;
                
                const key = `${cls.day}-${cls.time}`;
                
                // If there's a prescheduled entry, the class has started - keep the class info
                // (prescheduled was already skipped above if active class exists)
                
                const startDate = cls.startDate ? new Date(cls.startDate) : null;
                
                let currentWeek = 0;
                let weeksTotal = getLevelWeeks(cls.level) || 6;
                let endDate = null;
                
                if (startDate) {
                    const daysDiff = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                    currentWeek = Math.floor(daysDiff / 7) + 1;
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (weeksTotal * 7));
                }
                
                let status = 'occupied'; // red
                if (currentWeek >= weeksTotal) {
                    status = 'available'; // green - class has ended
                } else if (currentWeek >= weeksTotal - 1) {
                    status = 'ending'; // yellow - ending soon
                }
                
                // Only track if teacher matches filter (or no filter)
                if (!selectedTeacherId || cls.teacherId === selectedTeacherId) {
                    slotStatus[key] = {
                        status,
                        class: cls,
                        teacherId: cls.teacherId,
                        teacherName: allTeachers.find(t => t.id === cls.teacherId)?.name || 'Unassigned',
                        availableDate: endDate,
                        week: currentWeek,
                        weeksTotal
                    };
                }
            });
            
            // Build grid HTML
            let html = '';
            
            DAYS.forEach(day => {
                html += `<div style="margin-bottom: 20px;">`;
                html += `<h4 style="color: #00ffff; margin-bottom: 10px;">${day}</h4>`;
                html += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">`;
                
                TIME_SLOTS.forEach(time => {
                    const key = `${day}-${time}`;
                    const slot = slotStatus[key];
                    
                    let bgColor, borderColor, statusText, statusIcon, clickable = true, xBadge = '';
                    
                    if (slot?.status === 'prescheduled-full') {
                        // Full prescheduled slot - red/pink
                        bgColor = 'rgba(255,51,102,0.3)';
                        borderColor = '#ff3366';
                        statusText = 'Full';
                        statusIcon = 'ðŸ”´';
                        const classTypeName = LEVELS[slot.classType] || slot.classType || 'Class';
                        xBadge = `<div style="position: absolute; top: -8px; right: -8px; background: #ff3366; color: #fff; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px;">${slot.enrolledCount}/${slot.maxSeats}</div>`;
                        xBadge += `<div style="font-size: 9px; color: #ff3366; margin-top: 3px;">${classTypeName}</div>`;
                    } else if (slot?.status === 'prescheduled') {
                        bgColor = 'rgba(255,152,0,0.3)';
                        borderColor = '#ff9800';
                        statusText = 'Pre-scheduled';
                        statusIcon = 'â³';
                        const classTypeName = LEVELS[slot.classType] || slot.classType || 'Class';
                        const seatInfo = `${slot.enrolledCount || 0}/${slot.maxSeats || 5}`;
                        xBadge = `<div style="position: absolute; top: -8px; right: -8px; background: #ff9800; color: #000; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px;">${seatInfo}</div>`;
                        xBadge += `<div style="font-size: 9px; color: #ff9800; margin-top: 3px;">${classTypeName}</div>`;
                    } else if (!slot) {
                        // Check if any teacher is available for this day
                        const availableTeacher = relevantTeachers.find(t => (t.availableDays || []).includes(day));
                        if (availableTeacher) {
                            bgColor = 'rgba(57,255,20,0.2)';
                            borderColor = '#39ff14';
                            statusText = 'Available';
                            statusIcon = 'ðŸŸ¢';
                        } else {
                            bgColor = 'rgba(136,136,136,0.2)';
                            borderColor = '#888';
                            statusText = 'No Teacher';
                            statusIcon = 'âš«';
                            clickable = false;
                        }
                    } else if (slot.status === 'available') {
                        bgColor = 'rgba(57,255,20,0.2)';
                        borderColor = '#39ff14';
                        statusText = 'Available';
                        statusIcon = 'ðŸŸ¢';
                    } else if (slot.status === 'ending') {
                        bgColor = 'rgba(255,255,0,0.2)';
                        borderColor = '#ffff00';
                        statusText = `Week ${slot.week}/${slot.weeksTotal}`;
                        statusIcon = 'ðŸŸ¡';
                    } else {
                        bgColor = 'rgba(255,51,102,0.2)';
                        borderColor = '#ff3366';
                        statusText = `Week ${slot.week}/${slot.weeksTotal}`;
                        statusIcon = 'ðŸ”´';
                    }
                    
                    const availDateStr = slot?.availableDate 
                        ? `Opens: ${slot.availableDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                        : '';
                    
                    const classInfo = slot?.class 
                        ? `<div style="font-size: 10px; color: #888; margin-top: 3px;">${LEVELS[slot.class.level] || slot.class.level}</div>`
                        : '';
                    
                    // Teacher info - show for all statuses except available/no teacher
                    const teacherInfo = slot?.teacherName && (slot.status === 'prescheduled' || slot.status === 'prescheduled-full')
                        ? `<div style="font-size: 9px; color: ${slot.status === 'prescheduled-full' ? '#ff3366' : '#ff9800'}; margin-top: 2px;">ðŸ‘¨â€ðŸ« ${slot.teacherName}</div>`
                        : (slot?.teacherName && slot.status !== 'available' ? `<div style="font-size: 9px; color: #666; margin-top: 2px;">ðŸ‘¨â€ðŸ« ${slot.teacherName}</div>` : '');
                    
                    // Start date info for prescheduled slots
                    const startDateInfo = (slot?.status === 'prescheduled' || slot?.status === 'prescheduled-full') && slot.startDate
                        ? `<div style="font-size: 9px; color: ${slot.status === 'prescheduled-full' ? '#ff3366' : '#ff9800'};">Starts: ${slot.startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>`
                        : '';
                    
                    // End date / Opens info - show for occupied, ending, AND full prescheduled slots
                    const showOpensDate = slot?.status === 'ending' || slot?.status === 'occupied' || slot?.status === 'prescheduled-full';
                    
                    html += `
                        <div class="slot-card" onclick="${clickable ? `openSlotDetails('${day}', '${time}')` : ''}" 
                             style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 10px; 
                                    cursor: ${clickable ? 'pointer' : 'not-allowed'}; transition: all 0.2s; text-align: center; position: relative;">
                            ${xBadge}
                            <div style="font-size: 14px; font-weight: bold; color: #fff;">${time}</div>
                            <div style="font-size: 18px; margin: 5px 0;">${statusIcon}</div>
                            <div style="font-size: 11px; color: ${borderColor};">${statusText}</div>
                            ${classInfo}
                            ${teacherInfo}
                            ${startDateInfo}
                            ${showOpensDate && availDateStr ? `<div style="font-size: 9px; color: #39ff14; margin-top: 3px;">${availDateStr}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            
            // Update forecast and workload
            renderSlotForecast(slotStatus, weeksToShow);
            renderTeacherWorkload();
            renderSlotAnalytics();
        }
        
        function renderSlotForecast(slotStatus, weeksToShow) {
            const forecastDiv = document.getElementById('slotForecast');
            const now = new Date();
            
            // Group by weeks until available
            const weekBuckets = {};
            
            Object.entries(slotStatus).forEach(([key, slot]) => {
                if (slot.status === 'ending' || slot.status === 'occupied') {
                    if (slot.availableDate) {
                        const weeksUntil = Math.ceil((slot.availableDate - now) / (1000 * 60 * 60 * 24 * 7));
                        if (weeksUntil > 0 && weeksUntil <= weeksToShow) {
                            if (!weekBuckets[weeksUntil]) weekBuckets[weeksUntil] = [];
                            weekBuckets[weeksUntil].push({ key, slot });
                        }
                    }
                }
            });
            
            // Count currently available
            const availableNow = Object.values(slotStatus).filter(s => s.status === 'available').length;
            const totalSlots = DAYS.length * TIME_SLOTS.length;
            const occupiedSlots = Object.keys(slotStatus).length;
            const openSlots = totalSlots - occupiedSlots;
            
            let html = `<div style="margin-bottom: 10px;"><strong style="color: #39ff14;">${availableNow + openSlots} slots available now</strong></div>`;
            
            // Count prescheduled (both regular and full)
            const prescheduledCount = Object.values(slotStatus).filter(s => s.status === 'prescheduled' || s.status === 'prescheduled-full').length;
            const prescheduledFullCount = Object.values(slotStatus).filter(s => s.status === 'prescheduled-full').length;
            if (prescheduledCount > 0) {
                html += `<div style="margin-bottom: 10px; color: #ff9800;">${prescheduledCount} slots pre-scheduled`;
                if (prescheduledFullCount > 0) {
                    html += ` <span style="color: #ff3366;">(${prescheduledFullCount} full)</span>`;
                }
                html += `</div>`;
            }
            
            const sortedWeeks = Object.keys(weekBuckets).map(Number).sort((a, b) => a - b);
            
            if (sortedWeeks.length === 0) {
                html += `<p style="color: #888;">No upcoming slot openings in the next ${weeksToShow} weeks.</p>`;
            } else {
                sortedWeeks.forEach(week => {
                    const slots = weekBuckets[week];
                    html += `<div style="margin: 8px 0; padding: 8px; background: rgba(255,255,0,0.1); border-radius: 5px;">`;
                    html += `<strong style="color: #ffff00;">In ${week} week${week > 1 ? 's' : ''}:</strong> ${slots.length} slot${slots.length > 1 ? 's' : ''} opening`;
                    html += `<div style="font-size: 11px; color: #888; margin-top: 5px;">`;
                    html += slots.map(s => `${s.key.replace('-', ' @ ')}`).join(', ');
                    html += `</div></div>`;
                });
            }
            
            forecastDiv.innerHTML = html;
        }
        
        function renderTeacherWorkload() {
            const workloadDiv = document.getElementById('teacherWorkload');
            
            const teacherHours = {};
            allTeachers.forEach(t => {
                teacherHours[t.id] = { name: t.name, classes: 0, hours: 0, prescheduled: 0 };
            });
            
            allClasses.forEach(cls => {
                if (cls.status === 'completed') return;
                if (cls.teacherId && teacherHours[cls.teacherId]) {
                    teacherHours[cls.teacherId].classes++;
                    teacherHours[cls.teacherId].hours += 1; // Assuming 1 hour per class
                }
            });
            
            // Count prescheduled
            allPrescheduledSlots.forEach(ps => {
                if (ps.teacherId && teacherHours[ps.teacherId]) {
                    teacherHours[ps.teacherId].prescheduled++;
                }
            });
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">';
            
            Object.values(teacherHours).forEach(t => {
                const loadColor = t.classes > 6 ? '#ff3366' : (t.classes > 4 ? '#ffff00' : '#39ff14');
                html += `
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; border-left: 3px solid ${loadColor};">
                        <div style="font-weight: bold; color: #00ffff;">${t.name}</div>
                        <div style="font-size: 12px; color: #888;">${t.classes} active classes</div>
                        ${t.prescheduled > 0 ? `<div style="font-size: 11px; color: #ff9800;">${t.prescheduled} pre-scheduled</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            workloadDiv.innerHTML = html;
        }
        
        function renderSlotAnalytics() {
            const analyticsDiv = document.getElementById('slotAnalytics');
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="color: #39ff14; font-weight: bold; margin-bottom: 5px;">ðŸ“ˆ Highest Attendance Slots</div>
                        <div style="font-size: 11px; color: #888;">Based on student presence data</div>
                        <div style="margin-top: 5px; font-size: 12px;">
                            Requires attendance data...
                        </div>
                    </div>
                    <div>
                        <div style="color: #ff3366; font-weight: bold; margin-bottom: 5px;">ðŸ“‰ Highest Absence Slots</div>
                        <div style="font-size: 11px; color: #888;">Slots with most student absences</div>
                        <div style="margin-top: 5px; font-size: 12px;">
                            Requires attendance data...
                        </div>
                    </div>
                </div>
            `;
            
            analyticsDiv.innerHTML = html;
        }
        
        function openSlotDetails(day, time) {
            const key = `${day}-${time}`;
            const selectedTeacherId = document.getElementById('slotManagerTeacher')?.value || '';
            
            // Check for prescheduled slot first
            const prescheduled = allPrescheduledSlots.find(ps => ps.day === day && ps.time === time);
            
            // Find class info for this slot
            const cls = allClasses.find(c => c.day === day && c.time === time && c.status !== 'completed' && 
                (!selectedTeacherId || c.teacherId === selectedTeacherId));
            
            const teacher = cls ? allTeachers.find(t => t.id === cls.teacherId) : 
                (prescheduled ? allTeachers.find(t => t.id === prescheduled.teacherId) :
                allTeachers.find(t => (t.availableDays || []).includes(day)));
            
            selectedSlotInfo = { day, time, class: cls, teacher, prescheduled };
            
            document.getElementById('slotDetailsTitle').textContent = `ðŸ“… ${day} @ ${time} EST`;
            
            // Hide all sections initially
            document.getElementById('slotStudentRoster').style.display = 'none';
            document.getElementById('slotDateSelection').style.display = 'none';
            document.getElementById('slotPrescheduleInfo').style.display = 'none';
            document.getElementById('prescheduleForm').style.display = 'none';
            document.getElementById('slotEnrolledStudentsList').style.display = 'none';
            
            let html = '';
            
            if (prescheduled && !cls) {
                // Show prescheduled info
                const startDateDisplay = prescheduled.startDate ? formatDateInEST(prescheduled.startDate, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'Not set';
                const classTypeName = LEVELS[prescheduled.classType] || prescheduled.classType || 'Class';
                
                html = `
                    <div style="background: rgba(255,152,0,0.2); border: 2px solid #ff9800; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">â³</div>
                        <div style="color: #ff9800; font-weight: bold; font-size: 16px;">Pre-scheduled</div>
                        <div style="color: #fff; margin-top: 10px;">
                            <div><strong>Class:</strong> ${classTypeName}</div>
                            <div><strong>Teacher:</strong> ${prescheduled.teacherName || 'Unknown'}</div>
                            ${prescheduled.startDate ? `<div><strong>Starts:</strong> ${startDateDisplay}</div>` : ''}
                        </div>
                    </div>
                `;
                
                // Show preschedule info section with cancel button
                document.getElementById('slotPrescheduleInfo').style.display = 'block';
                document.getElementById('prescheduleDetails').innerHTML = `
                    <div style="font-size: 13px;">
                        <div><strong>Class Type:</strong> ${classTypeName}</div>
                        <div><strong>Teacher:</strong> ${prescheduled.teacherName}</div>
                        ${prescheduled.startDate ? `<div><strong>Start Date:</strong> ${startDateDisplay}</div>` : ''}
                        <div><strong>Seats:</strong> ${prescheduled.enrolledStudents?.length || 0}/${prescheduled.maxSeats || 5} filled</div>
                    </div>
                `;
                
                // Show enrolled students list
                updateSlotEnrolledStudentsList();
                
            } else if (cls) {
                // Show occupied class info with students
                const startDate = parseLocalDate(cls.startDate);
                const startDateDisplay = cls.startDate ? formatDateInEST(cls.startDate, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'Not set';
                const weeksTotal = getLevelWeeks(cls.level) || 6;
                let currentWeek = 0;
                let endDate = null;
                let endDateDisplay = '';
                
                if (startDate) {
                    const now = new Date();
                    const daysDiff = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                    currentWeek = Math.floor(daysDiff / 7) + 1;
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (weeksTotal * 7));
                    endDateDisplay = endDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', timeZone: 'America/New_York' });
                }
                
                const statusColor = currentWeek >= weeksTotal ? '#39ff14' : (currentWeek >= weeksTotal - 1 ? '#ffff00' : '#ff3366');
                const statusText = currentWeek >= weeksTotal ? 'Completed' : (currentWeek >= weeksTotal - 1 ? 'Ending Soon' : 'In Progress');
                
                html = `
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span class="level-badge level-${cls.level}">${LEVELS[cls.level] || cls.level}</span>
                            <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                        </div>
                        <div style="font-size: 13px; margin-bottom: 5px;">
                            <strong>Teacher:</strong> ${teacher?.name || 'Unassigned'}
                        </div>
                        <div style="font-size: 13px; margin-bottom: 5px;">
                            <strong>Progress:</strong> Week ${currentWeek} of ${weeksTotal}
                        </div>
                        ${cls.startDate ? `<div style="font-size: 13px; margin-bottom: 5px;"><strong>Started:</strong> ${startDateDisplay}</div>` : ''}
                        ${endDate ? `<div style="font-size: 13px; margin-bottom: 5px;"><strong>Ends:</strong> ${endDateDisplay}</div>` : ''}
                        <div style="font-size: 13px;">
                            <strong>Students:</strong> ${cls.students?.length || 0}
                        </div>
                    </div>
                `;
                
                // Show student roster
                if (cls.students && cls.students.length > 0) {
                    document.getElementById('slotStudentRoster').style.display = 'block';
                    
                    // Get full student info from allStudents
                    let rosterHtml = '';
                    cls.students.forEach((s, index) => {
                        const fullStudent = allStudents.find(st => st.id === s.id) || s;
                        const studentName = fullStudent.name || s.name || 'Unknown';
                        const escapedName = studentName.replace(/'/g, "\\'");
                        rosterHtml += `
                            <tr>
                                <td style="padding: 8px;">${studentName}</td>
                                <td style="padding: 8px;">${fullStudent.phoneNumber || fullStudent.phone || '-'}</td>
                                <td style="padding: 8px;">${fullStudent.discord || '-'}</td>
                                <td style="padding: 8px;">${fullStudent.email || s.email || '-'}</td>
                                <td style="padding: 8px; text-align: center;">
                                    <button class="btn btn-warning btn-sm" onclick="openMoveStudentFromClassModal('${s.id}', '${escapedName}', '${cls.id}')" style="padding: 2px 6px; font-size: 10px; margin-right: 3px;" title="Move to another class">ðŸ”„</button>
                                    <button class="btn btn-danger btn-sm" onclick="confirmRemoveStudentFromActiveClass('${s.id}', '${escapedName}', '${cls.id}')" style="padding: 2px 6px; font-size: 10px;" title="Remove from class">âœ•</button>
                                </td>
                            </tr>
                        `;
                    });
                    document.getElementById('slotStudentRosterBody').innerHTML = rosterHtml;
                }
                
                // Show date selection for next session
                showDateSelection(day, endDate, true);
                
            } else {
                // Empty slot - show available
                html = `
                    <div style="background: rgba(57,255,20,0.2); border: 2px solid #39ff14; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ðŸŸ¢</div>
                        <div style="color: #39ff14; font-weight: bold; font-size: 16px;">Slot Available!</div>
                        <div style="color: #888; font-size: 12px; margin-top: 5px;">
                            ${teacher ? `Teacher: ${teacher.name}` : 'No teacher assigned to this day'}
                        </div>
                    </div>
                `;
                
                // Show date selection (3 weeks from today as buffer)
                const bufferDate = new Date();
                bufferDate.setDate(bufferDate.getDate() + 21); // 3 weeks
                showDateSelection(day, bufferDate, false);
            }
            
            document.getElementById('slotDetailsContent').innerHTML = html;
            document.getElementById('slotDetailsModal').classList.add('active');
        }
        
        function showDateSelection(day, baseDate, hasExistingClass) {
            document.getElementById('slotDateSelection').style.display = 'block';
            
            const now = new Date();
            let startFrom;
            
            if (hasExistingClass && baseDate) {
                // For occupied slots: start from when class ends
                startFrom = new Date(baseDate);
            } else {
                // For empty slots: start from today
                startFrom = new Date();
            }
            
            // Find the first matching day (Saturday or Sunday) on or after startFrom
            const targetDayNum = day === 'Saturday' ? 6 : 0;
            while (startFrom.getDay() !== targetDayNum) {
                startFrom.setDate(startFrom.getDate() + 1);
            }
            
            // If the first date is in the past, move to next week
            if (startFrom < now) {
                startFrom.setDate(startFrom.getDate() + 7);
            }
            
            // Calculate end date (3 weeks from startFrom)
            const endDate = new Date(startFrom);
            endDate.setDate(endDate.getDate() + 21); // 3 weeks
            
            // Generate date options within the 3 week window
            let optionsHtml = '';
            let currentDate = new Date(startFrom);
            let count = 0;
            
            while (currentDate <= endDate && count < 5) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const label = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const dayLabel = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                optionsHtml += `
                    <button type="button" class="btn btn-sm date-option-btn" 
                            onclick="selectScheduleDate('${dateStr}')"
                            style="background: rgba(57,255,20,0.2); border: 1px solid #39ff14; color: #39ff14;">
                        ${dayLabel}, ${label}
                    </button>
                `;
                
                currentDate.setDate(currentDate.getDate() + 7); // Next week
                count++;
            }
            
            // Update the description text
            const descText = hasExistingClass 
                ? `Select a start date (available dates within 3 weeks after class ends):`
                : `Select a start date (available dates within the next 3 weeks):`;
            
            document.getElementById('slotDateOptions').innerHTML = optionsHtml;
            document.querySelector('#slotDateSelection p').textContent = descText;
            
            // Populate preschedule form dropdowns
            const classTypeSelect = document.getElementById('prescheduleClassType');
            const teacherSelect = document.getElementById('prescheduleTeacher');
            
            if (classTypeSelect) {
                // Get levels from existing LEVELS object or data-level-select elements
                let options = '<option value="">-- Select Class Type --</option>';
                Object.entries(LEVELS).forEach(([key, name]) => {
                    options += `<option value="${key}">${name}</option>`;
                });
                classTypeSelect.innerHTML = options;
            }
            
            if (teacherSelect) {
                let options = '<option value="">-- Select Teacher --</option>';
                allTeachers.forEach(t => {
                    if ((t.availableDays || []).includes(selectedSlotInfo.day)) {
                        options += `<option value="${t.id}">${t.name}</option>`;
                    }
                });
                teacherSelect.innerHTML = options;
                
                // Pre-select current teacher if available
                if (selectedSlotInfo.teacher) {
                    teacherSelect.value = selectedSlotInfo.teacher.id;
                }
            }
        }
        
        let selectedScheduleDateValue = null;
        
        function selectScheduleDate(dateStr) {
            selectedScheduleDateValue = dateStr;
            
            // Update button styles
            document.querySelectorAll('.date-option-btn').forEach(btn => {
                btn.style.background = 'rgba(57,255,20,0.2)';
                btn.style.borderColor = '#39ff14';
            });
            event.target.style.background = '#39ff14';
            event.target.style.borderColor = '#39ff14';
            event.target.style.color = '#000';
            
            // Show preschedule form
            document.getElementById('prescheduleForm').style.display = 'block';
        }
        
        async function confirmPreschedule() {
            if (!selectedScheduleDateValue) {
                alert('Please select a date first.');
                return;
            }
            
            const classType = document.getElementById('prescheduleClassType').value;
            const teacherId = document.getElementById('prescheduleTeacher').value;
            
            if (!classType) {
                alert('Please select a class type.');
                return;
            }
            
            if (!teacherId) {
                alert('Please select a teacher.');
                return;
            }
            
            const teacher = allTeachers.find(t => t.id === teacherId);
            
            try {
                const prescheduleData = {
                    day: selectedSlotInfo.day,
                    time: selectedSlotInfo.time,
                    startDate: selectedScheduleDateValue,
                    classType: classType,
                    teacherId: teacherId,
                    teacherName: teacher?.name || 'Unknown',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const ref = await db.collection('prescheduled_slots').add(prescheduleData);
                
                allPrescheduledSlots.push({ id: ref.id, ...prescheduleData });
                
                closeModal('slotDetailsModal');
                renderSlotGrid();
                
                alert(`âœ… Slot pre-scheduled!\n\n${selectedSlotInfo.day} @ ${selectedSlotInfo.time}\n${LEVELS[classType] || classType}\nTeacher: ${teacher?.name}\nStarts: ${new Date(selectedScheduleDateValue).toLocaleDateString()}`);
                
            } catch (e) {
                console.error('Error pre-scheduling slot:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function cancelPreschedule() {
            if (!selectedSlotInfo?.prescheduled) return;
            
            if (!confirm('Are you sure you want to cancel this pre-scheduled slot?')) return;
            
            try {
                await db.collection('prescheduled_slots').doc(selectedSlotInfo.prescheduled.id).delete();
                
                const idx = allPrescheduledSlots.findIndex(ps => ps.id === selectedSlotInfo.prescheduled.id);
                if (idx !== -1) allPrescheduledSlots.splice(idx, 1);
                
                closeModal('slotDetailsModal');
                renderSlotGrid();
                
                alert('âœ… Pre-schedule cancelled.');
                
            } catch (e) {
                console.error('Error cancelling preschedule:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        // ==================== DIRECT ADD STUDENT TO SLOT ====================
        async function addStudentToSlotDirectly() {
            const studentName = document.getElementById('directAddStudentName').value.trim();
            if (!studentName) {
                alert('Please enter a student name.');
                return;
            }
            
            if (!selectedSlotInfo?.prescheduled) {
                alert('No slot selected.');
                return;
            }
            
            const studentEmail = document.getElementById('directAddStudentEmail').value.trim();
            const studentPhone = document.getElementById('directAddStudentPhone').value.trim();
            const studentDiscord = document.getElementById('directAddStudentDiscord').value.trim();
            const studentNotes = document.getElementById('directAddStudentNotes').value.trim();
            
            try {
                const ps = selectedSlotInfo.prescheduled;
                const students = ps.enrolledStudents || [];
                
                // Check for duplicates
                if (students.some(s => s.name && s.name.toLowerCase() === studentName.toLowerCase())) {
                    if (!confirm(`A student named "${studentName}" is already enrolled. Add anyway?`)) return;
                }
                
                students.push({
                    name: studentName,
                    email: studentEmail || null,
                    phone: studentPhone || null,
                    discord: studentDiscord || null,
                    notes: studentNotes || null,
                    enrolledAt: new Date().toISOString(),
                    addedDirectly: true
                });
                
                await db.collection('prescheduled_slots').doc(ps.id).update({
                    enrolledStudents: students
                });
                
                // Update local cache
                const idx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (idx !== -1) {
                    allPrescheduledSlots[idx].enrolledStudents = students;
                }
                
                // Also update selectedSlotInfo
                selectedSlotInfo.prescheduled.enrolledStudents = students;
                
                closeAddStudentToSlotModal();
                
                // Refresh the slot details view
                updateSlotEnrolledStudentsList();
                renderSlotGrid();
                
                showToast(`âœ… ${studentName} added!`, 'success');
                
            } catch (e) {
                console.error('Error adding student:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        function openAddStudentToSlotModal() {
            if (!selectedSlotInfo?.prescheduled) return;
            
            const ps = selectedSlotInfo.prescheduled;
            const maxSeats = ps.maxSeats || salesChatSettings?.defaultMaxSeats || 5;
            const currentCount = ps.enrolledStudents?.length || 0;
            
            document.getElementById('addStudentSlotInfo').textContent = `${selectedSlotInfo.day} @ ${selectedSlotInfo.time} EST`;
            document.getElementById('addStudentSlotSeats').textContent = `${currentCount}/${maxSeats} seats filled`;
            
            // Clear form
            document.getElementById('directAddStudentName').value = '';
            document.getElementById('directAddStudentEmail').value = '';
            document.getElementById('directAddStudentPhone').value = '';
            document.getElementById('directAddStudentDiscord').value = '';
            document.getElementById('directAddStudentNotes').value = '';
            
            document.getElementById('addStudentToSlotModal').classList.add('active');
        }
        
        function closeAddStudentToSlotModal() {
            document.getElementById('addStudentToSlotModal').classList.remove('active');
        }
        
        function updateSlotEnrolledStudentsList() {
            if (!selectedSlotInfo?.prescheduled) return;
            
            const ps = selectedSlotInfo.prescheduled;
            const students = ps.enrolledStudents || [];
            const container = document.getElementById('slotEnrolledStudentsList');
            const content = document.getElementById('slotEnrolledStudentsContent');
            
            if (students.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            let html = '<div style="display: flex; flex-direction: column; gap: 6px;">';
            students.forEach((student, index) => {
                const isLinked = student.odId || student.id;
                const linkStatusIcon = isLinked ? 'âœ…' : 'âš ï¸';
                const linkStatusColor = isLinked ? '#39ff14' : '#ff9800';
                const linkStatusText = isLinked ? 'Linked' : 'Not linked';
                const studentName = student.name || student.linkedName || 'Unknown';
                const studentEmail = student.email || student.linkedEmail || '';
                const studentPhone = student.phone || '';
                const studentDiscord = student.discord || '';
                
                html += `
                    <div style="padding: 8px 10px; background: rgba(57,255,20,0.1); border: 1px solid rgba(57,255,20,0.3); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="color: #39ff14; font-weight: 600; font-size: 12px;">${escapeHtmlSales ? escapeHtmlSales(studentName) : studentName}</span>
                                    <span style="color: ${linkStatusColor}; font-size: 10px;" title="${linkStatusText}">${linkStatusIcon}</span>
                                </div>
                                ${studentEmail ? `<div style="color: #888; font-size: 10px;">ðŸ“§ ${studentEmail}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 4px;">
                                ${!isLinked ? `<button class="btn btn-info btn-sm" onclick="openLinkAccountModal(${index})" style="padding: 2px 6px; font-size: 9px;">ðŸ”— Link</button>` : `<button class="btn btn-secondary btn-sm" onclick="unlinkStudentAccount(${index})" style="padding: 2px 6px; font-size: 9px;">Unlink</button>`}
                                <button class="btn btn-warning btn-sm" onclick="openMoveStudentFromSlotModal(${index})" style="padding: 2px 6px; font-size: 9px;">ðŸ”„ Move</button>
                                <button class="btn btn-danger btn-sm" onclick="removeStudentFromSlot(${index})" style="padding: 2px 8px; font-size: 10px;">âœ•</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 6px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 4px; cursor: pointer;" onclick="editStudentPhone(${index})">
                                <span style="color: ${studentPhone ? '#39ff14' : '#666'}; font-size: 10px;">ðŸ“ž ${studentPhone || 'Add phone'}</span>
                                <span style="color: #888; font-size: 8px;">âœï¸</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px; cursor: pointer;" onclick="editStudentDiscord(${index})">
                                <span style="color: ${studentDiscord ? '#7289da' : '#666'}; font-size: 10px;">ðŸ’¬ ${studentDiscord || 'Add Discord'}</span>
                                <span style="color: #888; font-size: 8px;">âœï¸</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Show summary of linked vs unlinked
            const linkedCount = students.filter(s => s.odId || s.id).length;
            const unlinkedCount = students.length - linkedCount;
            if (unlinkedCount > 0) {
                html += `<div style="margin-top: 8px; padding: 8px; background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 6px; font-size: 11px; color: #ff9800;">
                    âš ï¸ ${unlinkedCount} student${unlinkedCount > 1 ? 's' : ''} not linked to accounts. Link them to enable attendance & analytics.
                </div>`;
            }
            
            // Update seat count in preschedule details
            const maxSeats = ps.maxSeats || salesChatSettings?.defaultMaxSeats || 5;
            const seatsHtml = `<div style="margin-top: 8px;"><strong>Seats:</strong> ${students.length}/${maxSeats} filled</div>`;
            
            const detailsEl = document.getElementById('prescheduleDetails');
            if (detailsEl && !detailsEl.innerHTML.includes('Seats:')) {
                detailsEl.innerHTML += seatsHtml;
            }
            
            content.innerHTML = html;
        }
        
        // Link account modal functions
        let linkingStudentIndex = null;
        
        function openLinkAccountModal(studentIndex) {
            linkingStudentIndex = studentIndex;
            const student = selectedSlotInfo?.prescheduled?.enrolledStudents?.[studentIndex];
            if (!student) return;
            
            const studentName = student.name || student.linkedName || 'Unknown';
            document.getElementById('linkAccountStudentName').textContent = studentName;
            document.getElementById('linkAccountSearchInput').value = student.email || student.linkedEmail || studentName || '';
            document.getElementById('linkAccountSearchResults').innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Enter a name or email to search...</p>';
            
            document.getElementById('linkAccountModal').classList.add('active');
            
            // Auto-search if we have email or name
            if (student.email || student.linkedEmail || studentName) {
                searchAccountsToLink();
            }
        }
        
        function closeLinkAccountModal() {
            document.getElementById('linkAccountModal').classList.remove('active');
            linkingStudentIndex = null;
        }
        
        async function searchAccountsToLink() {
            const searchTerm = document.getElementById('linkAccountSearchInput').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('linkAccountSearchResults');
            
            if (!searchTerm) {
                resultsContainer.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Enter a name or email to search...</p>';
                return;
            }
            
            resultsContainer.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">Searching...</p>';
            
            try {
                // Search in users collection for students
                const usersSnap = await db.collection('users').where('role', '==', 'student').get();
                const matchedUsers = usersSnap.docs
                    .map(doc => ({ odId: doc.id, ...doc.data() }))
                    .filter(u => 
                        (u.displayName || u.name || '').toLowerCase().includes(searchTerm) ||
                        (u.email || '').toLowerCase().includes(searchTerm)
                    );
                
                // Also search scheduler_students
                const schedulerSnap = await db.collection('scheduler_students').get();
                const matchedScheduler = schedulerSnap.docs
                    .map(doc => ({ odId: doc.id, source: 'scheduler', ...doc.data() }))
                    .filter(s => 
                        (s.name || '').toLowerCase().includes(searchTerm) ||
                        (s.email || '').toLowerCase().includes(searchTerm)
                    );
                
                // Combine and dedupe by email
                const seenEmails = new Set();
                const allMatches = [];
                
                matchedUsers.forEach(u => {
                    const email = (u.email || '').toLowerCase();
                    if (!seenEmails.has(email)) {
                        seenEmails.add(email);
                        allMatches.push({ ...u, source: 'users' });
                    }
                });
                
                matchedScheduler.forEach(s => {
                    const email = (s.email || '').toLowerCase();
                    if (!seenEmails.has(email)) {
                        seenEmails.add(email);
                        allMatches.push(s);
                    }
                });
                
                if (allMatches.length === 0) {
                    resultsContainer.innerHTML = `
                        <p style="color: #888; font-size: 12px; text-align: center;">No accounts found matching "${searchTerm}"</p>
                        <button class="btn btn-info" onclick="createNewAccountForStudent()" style="width: 100%; margin-top: 10px;">âž• Create New Student Account</button>
                    `;
                    return;
                }
                
                let html = '<div style="max-height: 300px; overflow-y: auto;">';
                allMatches.forEach(account => {
                    const name = account.displayName || account.name || 'Unknown';
                    const email = account.email || 'No email';
                    const sourceLabel = account.source === 'scheduler' ? 'ðŸ“š Scheduler' : 'ðŸ‘¤ Account';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); border-radius: 6px; margin-bottom: 8px; cursor: pointer;" 
                             onclick="linkStudentToAccount('${account.odId}', '${name.replace(/'/g, "\\'")}', '${email.replace(/'/g, "\\'")}')">
                            <div>
                                <div style="color: #00ffff; font-weight: 600; font-size: 13px;">${name}</div>
                                <div style="color: #888; font-size: 11px;">${email}</div>
                            </div>
                            <div style="font-size: 10px; color: #666;">${sourceLabel}</div>
                        </div>
                    `;
                });
                html += '</div>';
                html += '<button class="btn btn-info" onclick="createNewAccountForStudent()" style="width: 100%; margin-top: 10px;">âž• Create New Student Account</button>';
                
                resultsContainer.innerHTML = html;
                
            } catch (e) {
                console.error('Error searching accounts:', e);
                resultsContainer.innerHTML = '<p style="color: #ff3366; font-size: 12px; text-align: center;">Error searching accounts</p>';
            }
        }
        
        async function linkStudentToAccount(accountId, accountName, accountEmail) {
            if (linkingStudentIndex === null || !selectedSlotInfo?.prescheduled) return;
            
            try {
                const ps = selectedSlotInfo.prescheduled;
                const students = [...(ps.enrolledStudents || [])];
                const originalStudent = students[linkingStudentIndex] || {};
                const studentDisplayName = originalStudent.name || originalStudent.linkedName || accountName || 'Student';
                
                // Prompt for Discord username
                const discord = prompt(`Enter Discord username for ${studentDisplayName} (optional):`, originalStudent.discord || '');
                
                // Update the student with account info
                students[linkingStudentIndex] = {
                    ...originalStudent,
                    odId: accountId,
                    id: accountId,
                    linkedName: accountName,
                    linkedEmail: accountEmail,
                    linkedAt: new Date().toISOString(),
                    // Ensure name is set if it was missing
                    name: originalStudent.name || accountName,
                    // Add Discord if provided
                    discord: discord || originalStudent.discord || null
                };
                
                await db.collection('prescheduled_slots').doc(ps.id).update({
                    enrolledStudents: students
                });
                
                // Update local cache
                const idx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (idx !== -1) {
                    allPrescheduledSlots[idx].enrolledStudents = students;
                }
                selectedSlotInfo.prescheduled.enrolledStudents = students;
                
                closeLinkAccountModal();
                updateSlotEnrolledStudentsList();
                
                alert(`âœ… ${studentDisplayName} linked to account: ${accountName}`);
                
            } catch (e) {
                console.error('Error linking account:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function unlinkStudentAccount(studentIndex) {
            if (!selectedSlotInfo?.prescheduled) return;
            
            const ps = selectedSlotInfo.prescheduled;
            const student = ps.enrolledStudents?.[studentIndex];
            if (!student) return;
            
            const studentDisplayName = student.name || student.linkedName || 'this student';
            if (!confirm(`Unlink "${studentDisplayName}" from their account?`)) return;
            
            try {
                const students = [...(ps.enrolledStudents || [])];
                
                // Remove account link info
                delete students[studentIndex].odId;
                delete students[studentIndex].id;
                delete students[studentIndex].linkedName;
                delete students[studentIndex].linkedEmail;
                delete students[studentIndex].linkedAt;
                
                await db.collection('prescheduled_slots').doc(ps.id).update({
                    enrolledStudents: students
                });
                
                // Update local cache
                const idx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (idx !== -1) {
                    allPrescheduledSlots[idx].enrolledStudents = students;
                }
                selectedSlotInfo.prescheduled.enrolledStudents = students;
                
                updateSlotEnrolledStudentsList();
                alert(`âœ… Account unlinked from ${studentDisplayName}`);
                
            } catch (e) {
                console.error('Error unlinking account:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function editStudentDiscord(studentIndex) {
            if (!selectedSlotInfo?.prescheduled) return;
            
            const ps = selectedSlotInfo.prescheduled;
            const student = ps.enrolledStudents?.[studentIndex];
            if (!student) return;
            
            const studentDisplayName = student.name || student.linkedName || 'this student';
            const newDiscord = prompt(`Enter Discord username for ${studentDisplayName}:`, student.discord || '');
            
            if (newDiscord === null) return; // User cancelled
            
            try {
                const students = [...(ps.enrolledStudents || [])];
                students[studentIndex] = {
                    ...students[studentIndex],
                    discord: newDiscord || null
                };
                
                await db.collection('prescheduled_slots').doc(ps.id).update({
                    enrolledStudents: students
                });
                
                // Update local cache
                const idx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (idx !== -1) {
                    allPrescheduledSlots[idx].enrolledStudents = students;
                }
                selectedSlotInfo.prescheduled.enrolledStudents = students;
                
                updateSlotEnrolledStudentsList();
                
                if (newDiscord) {
                    showToast(`âœ… Discord updated: ${newDiscord}`, 'success');
                } else {
                    showToast(`âœ… Discord removed`, 'success');
                }
                
            } catch (e) {
                console.error('Error updating Discord:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function editStudentPhone(studentIndex) {
            if (!selectedSlotInfo?.prescheduled) return;
            
            const ps = selectedSlotInfo.prescheduled;
            const student = ps.enrolledStudents?.[studentIndex];
            if (!student) return;
            
            const studentDisplayName = student.name || student.linkedName || 'this student';
            const newPhone = prompt(`Enter phone number for ${studentDisplayName}:`, student.phone || '');
            
            if (newPhone === null) return; // User cancelled
            
            try {
                const students = [...(ps.enrolledStudents || [])];
                students[studentIndex] = {
                    ...students[studentIndex],
                    phone: newPhone || null
                };
                
                await db.collection('prescheduled_slots').doc(ps.id).update({
                    enrolledStudents: students
                });
                
                // Update local cache
                const idx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (idx !== -1) {
                    allPrescheduledSlots[idx].enrolledStudents = students;
                }
                selectedSlotInfo.prescheduled.enrolledStudents = students;
                
                updateSlotEnrolledStudentsList();
                
                if (newPhone) {
                    showToast(`âœ… Phone updated: ${newPhone}`, 'success');
                } else {
                    showToast(`âœ… Phone removed`, 'success');
                }
                
            } catch (e) {
                console.error('Error updating phone:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function createNewAccountForStudent() {
            const student = selectedSlotInfo?.prescheduled?.enrolledStudents?.[linkingStudentIndex];
            if (!student) return;
            
            const studentName = student.name || student.linkedName || 'Student';
            const email = prompt(`Enter email for ${studentName}:`, student.email || '');
            if (!email) return;
            
            try {
                // Create in scheduler_students collection
                const newStudentRef = await db.collection('scheduler_students').add({
                    name: studentName,
                    email: email,
                    phone: student.phone || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdFrom: 'prescheduled_slot'
                });
                
                // Link to this new account
                await linkStudentToAccount(newStudentRef.id, studentName, email);
                
            } catch (e) {
                console.error('Error creating account:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function convertPrescheduleToClass() {
            if (!selectedSlotInfo?.prescheduled) {
                alert('No pre-scheduled slot selected.');
                return;
            }
            
            const ps = selectedSlotInfo.prescheduled;
            const enrolledStudents = ps.enrolledStudents || [];
            
            if (enrolledStudents.length === 0) {
                alert('Please add at least one student before starting the class.');
                return;
            }
            
            // Check for unlinked students
            const unlinkedStudents = enrolledStudents.filter(s => !s.odId && !s.id);
            if (unlinkedStudents.length > 0) {
                const proceed = confirm(`âš ï¸ ${unlinkedStudents.length} student(s) are not linked to accounts:\n\n${unlinkedStudents.map(s => 'â€¢ ' + s.name).join('\n')}\n\nThese students won't have attendance tracking or analytics until linked.\n\nContinue anyway?`);
                if (!proceed) return;
            }
            
            if (!confirm(`ðŸš€ Create class from this pre-schedule?\n\nðŸ“… ${ps.day} @ ${ps.time}\nðŸ“š ${LEVELS[ps.classType] || ps.classType}\nðŸ‘¨â€ðŸ« ${ps.teacherName}\nðŸ‘¥ ${enrolledStudents.length} students\n\nThis will:\nâ€¢ Create the actual class\nâ€¢ Add all enrolled students\nâ€¢ Delete the pre-schedule entry`)) {
                return;
            }
            
            try {
                // Build students array for the class
                const classStudents = enrolledStudents.map(s => ({
                    id: s.odId || s.id || `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: s.name || s.linkedName || 'Unknown',
                    email: s.email || s.linkedEmail || null,
                    phone: s.phone || null,
                    discord: s.discord || null,
                    isLinked: !!(s.odId || s.id),
                    addedFrom: 'prescheduled'
                }));
                
                // Create the class
                const classData = {
                    day: ps.day,
                    time: ps.time,
                    level: ps.classType,
                    teacherId: ps.teacherId,
                    students: classStudents,
                    startDate: ps.startDate,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdFrom: 'prescheduled',
                    prescheduledId: ps.id
                };
                
                const classRef = await db.collection('scheduler_classes').add(classData);
                
                // Add to local cache
                allClasses.push({ id: classRef.id, ...classData, createdAt: new Date() });
                
                // Also add linked students to scheduler_students if they aren't already there
                for (const student of enrolledStudents) {
                    if (student.odId || student.id) {
                        // Check if student exists in scheduler_students
                        const existingDoc = await db.collection('scheduler_students').doc(student.odId || student.id).get();
                        if (!existingDoc.exists) {
                            // Create the student record
                            await db.collection('scheduler_students').doc(student.odId || student.id).set({
                                name: student.name,
                                email: student.email || student.linkedEmail || null,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                createdFrom: 'prescheduled_class_start'
                            });
                        }
                    }
                }
                
                // Delete the prescheduled slot
                await db.collection('prescheduled_slots').doc(ps.id).delete();
                
                // Remove from local cache
                const psIdx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (psIdx !== -1) {
                    allPrescheduledSlots.splice(psIdx, 1);
                }
                
                // Close modal and refresh
                closeModal('slotDetailsModal');
                renderSlotGrid();
                renderClasses();
                
                alert(`âœ… Class created successfully!\n\nðŸ“… ${ps.day} @ ${ps.time}\nðŸ‘¥ ${enrolledStudents.length} students enrolled\n\nThe class is now active and will appear in the Classes section.`);
                
            } catch (e) {
                console.error('Error converting prescheduled to class:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function removeStudentFromSlot(studentIndex) {
            if (!selectedSlotInfo?.prescheduled) return;
            
            const ps = selectedSlotInfo.prescheduled;
            const students = ps.enrolledStudents || [];
            
            if (studentIndex < 0 || studentIndex >= students.length) return;
            
            const student = students[studentIndex];
            if (!confirm(`Remove "${student.name}" from this slot?`)) return;
            
            try {
                students.splice(studentIndex, 1);
                
                await db.collection('prescheduled_slots').doc(ps.id).update({
                    enrolledStudents: students
                });
                
                // Update local cache
                const idx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (idx !== -1) {
                    allPrescheduledSlots[idx].enrolledStudents = students;
                }
                
                selectedSlotInfo.prescheduled.enrolledStudents = students;
                
                updateSlotEnrolledStudentsList();
                renderSlotGrid();
                
                alert(`âœ… ${student.name} has been removed.`);
                
            } catch (e) {
                console.error('Error removing student:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        // ==================== MOVE STUDENT FROM SLOT ====================
        let movingSlotStudentIndex = null;
        let selectedDestinationSlotId = null;
        
        function openMoveStudentFromSlotModal(studentIndex) {
            if (!selectedSlotInfo?.prescheduled) return;
            
            const ps = selectedSlotInfo.prescheduled;
            const students = ps.enrolledStudents || [];
            
            if (studentIndex < 0 || studentIndex >= students.length) return;
            
            const student = students[studentIndex];
            movingSlotStudentIndex = studentIndex;
            selectedDestinationSlotId = null;
            
            // Update modal info
            document.getElementById('moveSlotStudentName').textContent = student.name || 'Unknown';
            document.getElementById('moveSlotFromInfo').textContent = `From: ${ps.day} @ ${ps.time} EST - ${ps.level || 'No level'}`;
            
            // Load available destination slots
            renderMoveSlotDestinations(ps);
            
            // Disable confirm button until a slot is selected
            document.getElementById('confirmMoveSlotBtn').disabled = true;
            
            document.getElementById('moveStudentFromSlotModal').classList.add('active');
        }
        
        function closeMoveStudentFromSlotModal() {
            document.getElementById('moveStudentFromSlotModal').classList.remove('active');
            movingSlotStudentIndex = null;
            selectedDestinationSlotId = null;
        }
        
        function renderMoveSlotDestinations(currentSlot) {
            const container = document.getElementById('moveSlotDestinationList');
            
            // Get all prescheduled slots except the current one
            const availableSlots = allPrescheduledSlots.filter(ps => ps.id !== currentSlot.id);
            
            if (availableSlots.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">No other slots available. Create more prescheduled slots first.</p>';
                return;
            }
            
            // Sort by day then time
            const dayOrder = { 'Saturday': 0, 'Sunday': 1 };
            availableSlots.sort((a, b) => {
                const dayDiff = (dayOrder[a.day] || 0) - (dayOrder[b.day] || 0);
                if (dayDiff !== 0) return dayDiff;
                return (a.time || '').localeCompare(b.time || '');
            });
            
            container.innerHTML = availableSlots.map(ps => {
                const enrolledCount = (ps.enrolledStudents || []).length;
                const maxSeats = ps.maxSeats || 5;
                const isFull = enrolledCount >= maxSeats;
                const teacher = allTeachers.find(t => t.id === ps.teacherId);
                const levelMatch = currentSlot.level === ps.level;
                
                return `
                    <div class="move-slot-option ${selectedDestinationSlotId === ps.id ? 'selected' : ''}" 
                         onclick="selectDestinationSlot('${ps.id}')"
                         style="padding: 12px; margin-bottom: 8px; border: 2px solid ${selectedDestinationSlotId === ps.id ? '#39ff14' : '#444'}; border-radius: 8px; cursor: pointer; background: ${selectedDestinationSlotId === ps.id ? 'rgba(57,255,20,0.1)' : 'rgba(0,0,0,0.2)'}; transition: all 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #00ffff; font-size: 14px; font-weight: 600;">${ps.day} @ ${ps.time} EST</div>
                                <div style="font-size: 12px; color: #888; margin-top: 3px;">
                                    <span style="background: ${getLevelColor(ps.level)}; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #000;">${ps.level || 'No level'}</span>
                                    ${!levelMatch ? '<span style="color: #ff9800; margin-left: 5px;">âš ï¸ Level mismatch</span>' : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: ${isFull ? '#ff9800' : '#39ff14'};">
                                    ðŸ‘¥ ${enrolledCount}/${maxSeats} ${isFull ? 'âš ï¸ FULL' : ''}
                                </div>
                                <div style="font-size: 11px; color: #888;">${teacher ? teacher.name : 'No teacher'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectDestinationSlot(slotId) {
            selectedDestinationSlotId = slotId;
            
            // Update visual selection
            document.querySelectorAll('.move-slot-option').forEach(el => {
                el.style.borderColor = '#444';
                el.style.background = 'rgba(0,0,0,0.2)';
            });
            
            const selectedEl = event.currentTarget;
            selectedEl.style.borderColor = '#39ff14';
            selectedEl.style.background = 'rgba(57,255,20,0.1)';
            
            // Enable confirm button
            document.getElementById('confirmMoveSlotBtn').disabled = false;
        }
        
        async function confirmMoveStudentFromSlot() {
            if (!selectedSlotInfo?.prescheduled || movingSlotStudentIndex === null || !selectedDestinationSlotId) {
                alert('Please select a destination slot.');
                return;
            }
            
            const sourceSlot = selectedSlotInfo.prescheduled;
            const destSlot = allPrescheduledSlots.find(ps => ps.id === selectedDestinationSlotId);
            
            if (!destSlot) {
                alert('Destination slot not found.');
                return;
            }
            
            const sourceStudents = sourceSlot.enrolledStudents || [];
            const student = sourceStudents[movingSlotStudentIndex];
            
            if (!student) {
                alert('Student not found.');
                return;
            }
            
            const destStudents = destSlot.enrolledStudents || [];
            
            try {
                // Remove from source slot
                sourceStudents.splice(movingSlotStudentIndex, 1);
                await db.collection('prescheduled_slots').doc(sourceSlot.id).update({
                    enrolledStudents: sourceStudents
                });
                
                // Add to destination slot
                destStudents.push(student);
                await db.collection('prescheduled_slots').doc(destSlot.id).update({
                    enrolledStudents: destStudents
                });
                
                // Log the move
                await db.collection('scheduler_move_history').add({
                    studentId: student.odId || student.id || null,
                    studentName: student.name || 'Unknown',
                    fromClassId: sourceSlot.id,
                    fromClassInfo: `${sourceSlot.day} @ ${sourceSlot.time} - ${sourceSlot.level || 'No level'} (Slot)`,
                    toClassId: destSlot.id,
                    toClassInfo: `${destSlot.day} @ ${destSlot.time} - ${destSlot.level || 'No level'} (Slot)`,
                    movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                    movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reason: 'Moved via Slot Manager'
                });
                
                // Update local caches
                const sourceIdx = allPrescheduledSlots.findIndex(p => p.id === sourceSlot.id);
                if (sourceIdx !== -1) {
                    allPrescheduledSlots[sourceIdx].enrolledStudents = sourceStudents;
                }
                
                const destIdx = allPrescheduledSlots.findIndex(p => p.id === destSlot.id);
                if (destIdx !== -1) {
                    allPrescheduledSlots[destIdx].enrolledStudents = destStudents;
                }
                
                selectedSlotInfo.prescheduled.enrolledStudents = sourceStudents;
                
                closeMoveStudentFromSlotModal();
                updateSlotEnrolledStudentsList();
                renderSlotGrid();
                
                alert(`âœ… ${student.name} moved to ${destSlot.day} @ ${destSlot.time}!`);
                
            } catch (e) {
                console.error('Error moving student:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        // Helper function for level colors
        function getLevelColor(level) {
            const colors = {
                'Absolute Beginner': '#39ff14',
                'Novice': '#00ffff',
                'Beginner': '#ffff00',
                'Advanced Beginner': '#ff9800',
                'Intermediate': '#ff00ff'
            };
            return colors[level] || '#888';
        }
        // ==================== END MOVE STUDENT FROM SLOT ====================
        
        // ==================== MOVE STUDENT FROM ACTIVE CLASS (Slot Manager) ====================
        let movingClassStudentId = null;
        let movingClassStudentName = null;
        let movingFromClassId = null;
        let selectedDestinationClassId = null;
        
        function openMoveStudentFromClassModal(studentId, studentName, classId) {
            movingClassStudentId = studentId;
            movingClassStudentName = studentName;
            movingFromClassId = classId;
            selectedDestinationClassId = null;
            
            const cls = allClasses.find(c => c.id === classId);
            
            // Update modal info
            document.getElementById('moveClassStudentName').textContent = studentName;
            document.getElementById('moveClassFromInfo').textContent = cls ? `From: ${cls.day} @ ${cls.time} EST - ${LEVELS[cls.level] || cls.level}` : 'From: Unknown class';
            
            // Reset checkbox
            document.getElementById('returnToPoolFromClassCheckbox').checked = false;
            document.getElementById('moveClassDestinationSection').style.display = 'block';
            
            // Load available destination classes
            renderMoveClassDestinations(classId);
            
            document.getElementById('moveStudentFromClassModal').classList.add('active');
        }
        
        function closeMoveStudentFromClassModal() {
            document.getElementById('moveStudentFromClassModal').classList.remove('active');
            movingClassStudentId = null;
            movingClassStudentName = null;
            movingFromClassId = null;
            selectedDestinationClassId = null;
        }
        
        function toggleMoveFromClassOptions() {
            const returnToPool = document.getElementById('returnToPoolFromClassCheckbox').checked;
            document.getElementById('moveClassDestinationSection').style.display = returnToPool ? 'none' : 'block';
        }
        
        function renderMoveClassDestinations(currentClassId) {
            const container = document.getElementById('moveClassDestinationList');
            const currentClass = allClasses.find(c => c.id === currentClassId);
            
            // Get all active classes except the current one
            const availableClasses = allClasses.filter(c => c.id !== currentClassId && c.status !== 'completed');
            
            if (availableClasses.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center;">No other active classes available.</p>';
                return;
            }
            
            // Sort by day then time
            const dayOrder = { 'Saturday': 0, 'Sunday': 1 };
            availableClasses.sort((a, b) => {
                const dayDiff = (dayOrder[a.day] || 0) - (dayOrder[b.day] || 0);
                if (dayDiff !== 0) return dayDiff;
                return (a.time || '').localeCompare(b.time || '');
            });
            
            container.innerHTML = availableClasses.map(cls => {
                const studentCount = (cls.students || []).length;
                const maxStudents = schedulerSettings?.maxStudents || 10;
                const isFull = studentCount >= maxStudents;
                const teacher = allTeachers.find(t => t.id === cls.teacherId);
                const levelMatch = currentClass && currentClass.level === cls.level;
                const levelName = LEVELS[cls.level] || cls.level || 'No level';
                
                return `
                    <div class="move-class-option ${selectedDestinationClassId === cls.id ? 'selected' : ''}" 
                         onclick="selectDestinationClass('${cls.id}')"
                         style="padding: 12px; margin-bottom: 8px; border: 2px solid ${selectedDestinationClassId === cls.id ? '#39ff14' : '#444'}; border-radius: 8px; cursor: pointer; background: ${selectedDestinationClassId === cls.id ? 'rgba(57,255,20,0.1)' : 'rgba(0,0,0,0.2)'}; transition: all 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #00ffff; font-size: 14px; font-weight: 600;">${cls.day} @ ${cls.time} EST</div>
                                <div style="font-size: 12px; color: #888; margin-top: 3px;">
                                    <span class="level-badge level-${cls.level}" style="font-size: 10px; padding: 2px 6px;">${levelName}</span>
                                    ${!levelMatch ? '<span style="color: #ff9800; margin-left: 5px;">âš ï¸ Level mismatch</span>' : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: ${isFull ? '#ff9800' : '#39ff14'};">
                                    ðŸ‘¥ ${studentCount}/${maxStudents} ${isFull ? 'âš ï¸ FULL' : ''}
                                </div>
                                <div style="font-size: 11px; color: #888;">${teacher ? teacher.name : 'No teacher'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectDestinationClass(classId) {
            selectedDestinationClassId = classId;
            
            // Update visual selection
            document.querySelectorAll('.move-class-option').forEach(el => {
                el.style.borderColor = '#444';
                el.style.background = 'rgba(0,0,0,0.2)';
            });
            
            const selectedEl = event.currentTarget;
            selectedEl.style.borderColor = '#39ff14';
            selectedEl.style.background = 'rgba(57,255,20,0.1)';
        }
        
        async function confirmMoveStudentFromClass() {
            if (!movingClassStudentId || !movingFromClassId) {
                alert('Missing student or class information.');
                return;
            }
            
            const returnToPool = document.getElementById('returnToPoolFromClassCheckbox').checked;
            
            if (returnToPool) {
                // Return student to pool
                await returnStudentToPoolFromSlotManager(movingClassStudentId, movingFromClassId, movingClassStudentName);
            } else if (selectedDestinationClassId) {
                // Move to selected class
                await moveStudentBetweenClasses(movingClassStudentId, movingFromClassId, selectedDestinationClassId, movingClassStudentName);
            } else {
                alert('Please select a destination class or check "Return to pool".');
                return;
            }
            
            closeMoveStudentFromClassModal();
        }
        
        async function returnStudentToPoolFromSlotManager(studentId, fromClassId, studentName) {
            try {
                const fromClass = allClasses.find(c => c.id === fromClassId);
                
                // Remove from current class
                if (fromClass) {
                    const updatedStudents = (fromClass.students || []).filter(s => s.id !== studentId);
                    await db.collection('scheduler_classes').doc(fromClassId).update({ students: updatedStudents });
                    fromClass.students = updatedStudents;
                }
                
                // Update student status back to pending
                await db.collection('scheduler_students').doc(studentId).update({ 
                    status: 'pending', 
                    classId: null 
                });
                
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) {
                    allStudents[idx].status = 'pending';
                    allStudents[idx].classId = null;
                }
                
                // Log the action
                await db.collection('scheduler_move_history').add({
                    studentId: studentId,
                    studentName: studentName,
                    fromClassId: fromClassId,
                    fromClassInfo: fromClass ? `${fromClass.day} @ ${fromClass.time} - ${LEVELS[fromClass.level] || fromClass.level}` : 'Unknown',
                    toClassId: null,
                    toClassInfo: 'Returned to Pool',
                    movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                    movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reason: 'Returned to pool via Slot Manager'
                });
                
                // Refresh the slot details
                closeModal('slotDetailsModal');
                renderSlotGrid();
                
                alert(`âœ… ${studentName} has been returned to the student pool.`);
                
            } catch (e) {
                console.error('Error returning student to pool:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function moveStudentBetweenClasses(studentId, fromClassId, toClassId, studentName) {
            try {
                const student = allStudents.find(s => s.id === studentId);
                const fromClass = allClasses.find(c => c.id === fromClassId);
                const toClass = allClasses.find(c => c.id === toClassId);
                
                if (!toClass) {
                    alert('Destination class not found.');
                    return;
                }
                
                // Remove from source class
                if (fromClass) {
                    const updatedStudents = (fromClass.students || []).filter(s => s.id !== studentId);
                    await db.collection('scheduler_classes').doc(fromClassId).update({ students: updatedStudents });
                    fromClass.students = updatedStudents;
                }
                
                // Add to destination class
                const slot = `${toClass.day}-${toClass.time}`;
                let rank = 3; // Default to 3rd preference
                if (student?.availabilities) {
                    for (let r = 1; r <= 3; r++) {
                        if (student.availabilities[r] === slot) { rank = r; break; }
                    }
                }
                
                const newStudent = { 
                    id: studentId, 
                    name: studentName || student?.name || 'Unknown', 
                    rank, 
                    timezone: student?.timezone || 'Unknown' 
                };
                const updatedStudents = [...(toClass.students || []), newStudent];
                await db.collection('scheduler_classes').doc(toClassId).update({ students: updatedStudents });
                toClass.students = updatedStudents;
                
                // Update student record
                await db.collection('scheduler_students').doc(studentId).update({ classId: toClassId });
                if (student) student.classId = toClassId;
                
                // Log the move
                await db.collection('scheduler_move_history').add({
                    studentId: studentId,
                    studentName: studentName,
                    fromClassId: fromClassId,
                    fromClassInfo: fromClass ? `${fromClass.day} @ ${fromClass.time} - ${LEVELS[fromClass.level] || fromClass.level}` : 'Unknown',
                    toClassId: toClassId,
                    toClassInfo: `${toClass.day} @ ${toClass.time} - ${LEVELS[toClass.level] || toClass.level}`,
                    movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                    movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reason: 'Moved via Slot Manager'
                });
                
                // Refresh the slot details
                closeModal('slotDetailsModal');
                renderSlotGrid();
                
                alert(`âœ… ${studentName} moved to ${toClass.day} @ ${toClass.time}!`);
                
            } catch (e) {
                console.error('Error moving student:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function confirmRemoveStudentFromActiveClass(studentId, studentName, classId) {
            const action = await showRemoveStudentFromActiveClassDialog(studentName);
            if (!action) return;
            
            try {
                const cls = allClasses.find(c => c.id === classId);
                if (!cls) {
                    alert('Class not found.');
                    return;
                }
                
                // Remove student from class
                const updatedStudents = (cls.students || []).filter(s => s.id !== studentId);
                await db.collection('scheduler_classes').doc(classId).update({ students: updatedStudents });
                cls.students = updatedStudents;
                
                if (action === 'pool') {
                    // Return to pool for reassignment
                    await db.collection('scheduler_students').doc(studentId).update({ 
                        status: 'pending', 
                        classId: null 
                    });
                    
                    const idx = allStudents.findIndex(s => s.id === studentId);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].classId = null;
                    }
                    
                    // Log the action
                    await db.collection('scheduler_move_history').add({
                        studentId: studentId,
                        studentName: studentName,
                        fromClassId: classId,
                        fromClassInfo: `${cls.day} @ ${cls.time} - ${LEVELS[cls.level] || cls.level}`,
                        toClassId: null,
                        toClassInfo: 'Returned to Pool',
                        movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                        movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reason: 'Removed from class via Slot Manager - returned to pool'
                    });
                    
                    alert(`${studentName} has been removed and returned to the student pool.`);
                } else if (action === 'drop') {
                    // Mark as dropped/inactive
                    await db.collection('scheduler_students').doc(studentId).update({ 
                        status: 'dropped', 
                        classId: null,
                        droppedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        droppedFrom: classId
                    });
                    
                    const idx = allStudents.findIndex(s => s.id === studentId);
                    if (idx !== -1) {
                        allStudents[idx].status = 'dropped';
                        allStudents[idx].classId = null;
                    }
                    
                    // Log the action
                    await db.collection('scheduler_move_history').add({
                        studentId: studentId,
                        studentName: studentName,
                        fromClassId: classId,
                        fromClassInfo: `${cls.day} @ ${cls.time} - ${LEVELS[cls.level] || cls.level}`,
                        toClassId: null,
                        toClassInfo: 'Dropped',
                        movedBy: currentUser?.email || currentUser?.name || 'Unknown',
                        movedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reason: 'Dropped from class via Slot Manager'
                    });
                    
                    alert(`${studentName} has been marked as dropped.`);
                }
                
                // Refresh the view
                closeModal('slotDetailsModal');
                renderSlotGrid();
                
            } catch (e) {
                console.error('Error removing student:', e);
                alert('Error removing student: ' + e.message);
            }
        }
        
        function showRemoveStudentFromActiveClassDialog(studentName) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'removeStudentFromActiveClassDialog';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <h3 class="modal-title">ðŸ—‘ï¸ Remove Student</h3>
                        <p style="font-size: 13px; margin-bottom: 20px;">
                            Remove <strong style="color: #00ffff;">${studentName}</strong> from this class?
                        </p>
                        <p style="font-size: 12px; color: #888; margin-bottom: 20px;">Choose what happens to the student:</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-warning" onclick="document.getElementById('removeStudentFromActiveClassDialog').remove(); window.removeStudentActiveClassResolve('pool');" style="width: 100%; padding: 12px;">
                                ðŸ“‹ Return to Student Pool
                                <div style="font-size: 10px; color: #888; margin-top: 3px;">Student can be reassigned to another class</div>
                            </button>
                            <button class="btn btn-danger" onclick="document.getElementById('removeStudentFromActiveClassDialog').remove(); window.removeStudentActiveClassResolve('drop');" style="width: 100%; padding: 12px;">
                                âŒ Mark as Dropped
                                <div style="font-size: 10px; color: #888; margin-top: 3px;">Student left the program</div>
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('removeStudentFromActiveClassDialog').remove(); window.removeStudentActiveClassResolve(null);" style="width: 100%; padding: 10px;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                window.removeStudentActiveClassResolve = resolve;
            });
        }
        // ==================== END MOVE STUDENT FROM ACTIVE CLASS ====================
        
        // Student email functions
        function copyStudentEmails() {
            if (!selectedSlotInfo?.class?.students) return;
            
            const emails = selectedSlotInfo.class.students
                .map(s => {
                    const fullStudent = allStudents.find(st => st.id === s.id) || s;
                    return fullStudent.email || s.email;
                })
                .filter(e => e)
                .join(', ');
            
            navigator.clipboard.writeText(emails).then(() => {
                alert('âœ… Emails copied to clipboard!\n\n' + emails);
            }).catch(err => {
                console.error('Copy failed:', err);
                prompt('Copy these emails:', emails);
            });
        }
        
        async function copyClassInfoEmail() {
            if (!selectedSlotInfo?.class) return;
            
            const cls = selectedSlotInfo.class;
            const classType = cls.level;
            const template = await getClassTemplate(classType);
            
            const day = selectedSlotInfo.day;
            const time = selectedSlotInfo.time;
            const timeConversions = convertTimeToAllZones(time);
            const startDate = cls.startDate ? formatDateInEST(cls.startDate, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'TBD';
            
            const className = LEVELS[classType] || classType || 'Class';
            
            let emailContent = `Subject: ${className} - Class Information

Hello!

Welcome to ${className}! Here are your class details:

ðŸ“… SCHEDULE
Day: Every ${day}
Starting: ${startDate}

â° CLASS TIMES (All US Timezones)
â€¢ Eastern (EST): ${time}
â€¢ Central (CST): ${timeConversions.CST}
â€¢ Mountain (MST): ${timeConversions.MST}
â€¢ Pacific (PST): ${timeConversions.PST}

`;
            
            if (template?.classLink) {
                emailContent += `ðŸ”— CLASS LINK
${template.classLink}

`;
            }
            
            if (template?.preparation) {
                emailContent += `ðŸ“ BEFORE CLASS - PLEASE PREPARE
${template.preparation}

`;
            }
            
            if (template?.images?.length > 0) {
                emailContent += `ðŸ“· Note: Reference images are attached to this email.

`;
            }
            
            emailContent += `See you in class!
KoreanLearnin Team`;
            
            navigator.clipboard.writeText(emailContent).then(() => {
                alert('âœ… Email content copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                prompt('Copy this email content:', emailContent);
            });
        }
        
        // Class Templates Functions
        async function loadClassTemplate() {
            const classType = document.getElementById('templateClassType')?.value;
            if (!classType) {
                document.getElementById('templateStatus').innerHTML = '<span style="color: #888;">Select a class type</span>';
                return;
            }
            
            try {
                const doc = await db.collection('class_templates').doc(classType).get();
                
                if (doc.exists) {
                    const template = doc.data();
                    classTemplates[classType] = template;
                    
                    document.getElementById('templateClassLink').value = template.classLink || '';
                    document.getElementById('templatePreparation').value = template.preparation || '';
                    
                    // Show images
                    if (template.images && template.images.length > 0) {
                        templateUploadedImages = template.images;
                        renderTemplateImages();
                    } else {
                        templateUploadedImages = [];
                        document.getElementById('templateImagePreview').innerHTML = '<p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>';
                    }
                    
                    document.getElementById('templateStatus').innerHTML = '<span style="color: #39ff14;">âœ“ Template loaded</span>';
                } else {
                    // Clear fields
                    document.getElementById('templateClassLink').value = '';
                    document.getElementById('templatePreparation').value = '';
                    templateUploadedImages = [];
                    document.getElementById('templateImagePreview').innerHTML = '<p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>';
                    
                    document.getElementById('templateStatus').innerHTML = '<span style="color: #ffff00;">No template saved yet</span>';
                }
            } catch (e) {
                console.error('Error loading template:', e);
                document.getElementById('templateStatus').innerHTML = '<span style="color: #ff3366;">Error loading template</span>';
            }
        }
        
        async function getClassTemplate(classType) {
            if (classTemplates[classType]) {
                return classTemplates[classType];
            }
            
            try {
                const doc = await db.collection('class_templates').doc(classType).get();
                if (doc.exists) {
                    classTemplates[classType] = doc.data();
                    return classTemplates[classType];
                }
            } catch (e) {
                console.error('Error getting template:', e);
            }
            
            return null;
        }
        
        async function saveClassTemplate() {
            const classType = document.getElementById('templateClassType')?.value;
            if (!classType) {
                alert('Please select a class type.');
                return;
            }
            
            const classLink = document.getElementById('templateClassLink')?.value || '';
            const preparation = document.getElementById('templatePreparation')?.value || '';
            
            try {
                const templateData = {
                    classLink,
                    preparation,
                    images: templateUploadedImages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('class_templates').doc(classType).set(templateData, { merge: true });
                
                classTemplates[classType] = templateData;
                
                document.getElementById('templateStatus').innerHTML = '<span style="color: #39ff14;">âœ“ Template saved!</span>';
                alert('âœ… Template saved successfully!');
                
            } catch (e) {
                console.error('Error saving template:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function deleteClassTemplate() {
            const classType = document.getElementById('templateClassType')?.value;
            if (!classType) {
                alert('Please select a class type.');
                return;
            }
            
            if (!confirm(`Delete template for ${LEVELS[classType] || classType}?`)) return;
            
            try {
                await db.collection('class_templates').doc(classType).delete();
                
                delete classTemplates[classType];
                
                document.getElementById('templateClassLink').value = '';
                document.getElementById('templatePreparation').value = '';
                templateUploadedImages = [];
                document.getElementById('templateImagePreview').innerHTML = '<p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>';
                
                document.getElementById('templateStatus').innerHTML = '<span style="color: #ffff00;">Template deleted</span>';
                alert('âœ… Template deleted.');
                
            } catch (e) {
                console.error('Error deleting template:', e);
                alert('âŒ Error: ' + e.message);
            }
        }
        
        function handleTemplateImageUpload(event) {
            const files = event.target.files;
            
            Array.from(files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    templateUploadedImages.push({ name: file.name, data: e.target.result });
                    renderTemplateImages();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function renderTemplateImages() {
            const previewDiv = document.getElementById('templateImagePreview');
            
            if (templateUploadedImages.length === 0) {
                previewDiv.innerHTML = '<p style="color: #666; font-size: 11px; margin: auto;">No images uploaded</p>';
                return;
            }
            
            previewDiv.innerHTML = templateUploadedImages.map((img, idx) => `
                <div style="position: relative; display: inline-block;">
                    <img src="${img.data}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 2px solid #00ffff;">
                    <button onclick="removeTemplateImage(${idx})" style="position: absolute; top: -5px; right: -5px; background: #ff3366; color: #fff; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 10px;">âœ•</button>
                </div>
            `).join('');
        }
        
        function removeTemplateImage(idx) {
            templateUploadedImages.splice(idx, 1);
            renderTemplateImages();
        }
        
        function previewClassTemplate() {
            const classType = document.getElementById('templateClassType')?.value;
            const classLink = document.getElementById('templateClassLink')?.value || '';
            const preparation = document.getElementById('templatePreparation')?.value || '';
            
            const className = LEVELS[classType] || classType || '[Class Type]';
            
            let imagesHtml = '';
            if (templateUploadedImages.length > 0) {
                imagesHtml = `
                    <div style="margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px;">
                        <h3 style="color: #333; margin-bottom: 10px;">ðŸ“· Reference Images</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${templateUploadedImages.map(img => `<img src="${img.data}" style="max-width: 200px; max-height: 150px; border-radius: 5px; border: 1px solid #ddd;">`).join('')}
                        </div>
                    </div>
                `;
            }
            
            const previewHtml = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="color: #333; margin: 10px 0;">${className} Template</h1>
                </div>
                
                ${classLink ? `
                <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h2 style="color: #2e7d32; margin-bottom: 10px;">ðŸ”— Class Link</h2>
                    <p style="font-size: 14px; word-break: break-all;"><a href="${classLink}" style="color: #1976d2;">${classLink}</a></p>
                </div>
                ` : '<p style="color: #999;">No class link set</p>'}
                
                ${preparation ? `
                <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h2 style="color: #e65100; margin-bottom: 10px;">ðŸ“ Preparation Instructions</h2>
                    <p style="font-size: 14px; white-space: pre-wrap;">${preparation}</p>
                </div>
                ` : '<p style="color: #999;">No preparation instructions set</p>'}
                
                ${imagesHtml}
            `;
            
            document.getElementById('pdfPreviewContent').innerHTML = previewHtml;
            document.getElementById('pdfPreviewModal').classList.add('active');
        }
        
        // Shopify Listing Generator
        function openShopifyListingModal() {
            document.getElementById('shopifyListingModal').classList.add('active');
            generateShopifyListing();
        }
        
        function generateShopifyListing() {
            const classType = document.getElementById('shopifyClassType')?.value || '';
            const day = document.getElementById('shopifyClassDay')?.value || 'Saturday';
            const time = document.getElementById('shopifyClassTime')?.value || '6:30 PM';
            const startDate = document.getElementById('shopifyStartDate')?.value || '';
            const duration = document.getElementById('shopifyDuration')?.value || '6';
            const additionalText = document.getElementById('shopifyAdditionalText')?.value || '';
            const whatLearn = document.getElementById('shopifyWhatLearn')?.value || '';
            
            const className = LEVELS[classType] || classType || '[Class Type]';
            
            // Format date - use same approach as openSlotDetails
            const formattedDate = startDate ? formatDateInEST(startDate, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : '[Start Date]';
            
            // Convert EST to other timezones
            const timeConversions = convertTimeToAllZones(time);
            
            let listing = `ðŸ“š ${className} - ${duration}-Week Program

ðŸ“… SCHEDULE
${day}s starting ${formattedDate}

â° CLASS TIMES (All US Timezones)
â€¢ Eastern (EST): ${time}
â€¢ Central (CST): ${timeConversions.CST}
â€¢ Mountain (MST): ${timeConversions.MST}
â€¢ Pacific (PST): ${timeConversions.PST}

ðŸ“‹ PROGRAM DETAILS
â€¢ Duration: ${duration} weeks
â€¢ Day: Every ${day}
â€¢ Live interactive class via Zoom

`;
            
            if (whatLearn) {
                listing += `âœ¨ WHAT YOU'LL LEARN
${whatLearn}

`;
            }
            
            if (additionalText) {
                listing += `ðŸ“ ADDITIONAL INFORMATION
${additionalText}

`;
            }
            
            listing += `ðŸŽ“ Join us for an engaging Korean learning experience!`;
            
            document.getElementById('shopifyListingOutput').textContent = listing;
        }
        
        function convertTimeToAllZones(estTime) {
            // Parse EST time
            const [timePart, ampm] = estTime.split(' ');
            let [hours, minutes] = timePart.split(':').map(Number);
            
            if (ampm === 'PM' && hours !== 12) hours += 12;
            if (ampm === 'AM' && hours === 12) hours = 0;
            
            const formatTime = (h) => {
                if (h < 0) h += 24;
                if (h >= 24) h -= 24;
                const period = h >= 12 ? 'PM' : 'AM';
                const hour12 = h % 12 || 12;
                return `${hour12}:${String(minutes).padStart(2, '0')} ${period}`;
            };
            
            return {
                EST: estTime,
                CST: formatTime(hours - 1),
                MST: formatTime(hours - 2),
                PST: formatTime(hours - 3)
            };
        }
        
        function copyShopifyListing() {
            const text = document.getElementById('shopifyListingOutput').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                prompt('Copy this listing:', text);
            });
        }
        
        function useSlotForShopify() {
            if (!selectedSlotInfo) return;
            
            document.getElementById('shopifyClassDay').value = selectedSlotInfo.day;
            document.getElementById('shopifyClassTime').value = selectedSlotInfo.time;
            
            if (selectedSlotInfo.class?.level) {
                document.getElementById('shopifyClassType').value = selectedSlotInfo.class.level;
            } else if (selectedSlotInfo.prescheduled?.classType) {
                document.getElementById('shopifyClassType').value = selectedSlotInfo.prescheduled.classType;
            }
            
            closeModal('slotDetailsModal');
            openShopifyListingModal();
            
            // Generate date options based on slot status
            updateShopifyDateOptions();
        }
        
        function updateShopifyDateOptions() {
            const container = document.getElementById('shopifyDateOptions');
            const day = selectedSlotInfo?.day || document.getElementById('shopifyClassDay').value;
            
            // Check if this is a pre-scheduled slot - only show the one scheduled date
            if (selectedSlotInfo?.prescheduled?.startDate) {
                const dateStr = selectedSlotInfo.prescheduled.startDate;
                // Use same date parsing as openSlotDetails
                const scheduledDate = new Date(dateStr);
                const label = scheduledDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayLabel = scheduledDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                document.getElementById('shopifyStartDate').value = dateStr;
                
                container.innerHTML = `
                    <button type="button" class="btn btn-sm shopify-date-btn selected" 
                            style="background: #ff9800; border: 1px solid #ff9800; color: #000; font-size: 11px; cursor: default;">
                        ${dayLabel}, ${label} (Scheduled)
                    </button>
                `;
                generateShopifyListing();
                return;
            }
            
            // Check if this is an active class - only show the class start date
            if (selectedSlotInfo?.class?.startDate) {
                const dateStr = selectedSlotInfo.class.startDate;
                // Use same date parsing as openSlotDetails
                const classDate = new Date(dateStr);
                const label = classDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayLabel = classDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                document.getElementById('shopifyStartDate').value = dateStr;
                
                container.innerHTML = `
                    <button type="button" class="btn btn-sm shopify-date-btn selected" 
                            style="background: #39ff14; border: 1px solid #39ff14; color: #000; font-size: 11px; cursor: default;">
                        ${dayLabel}, ${label} (Current)
                    </button>
                `;
                generateShopifyListing();
                return;
            }
            
            // Empty slot - show multiple date options within 3 weeks
            const now = new Date();
            let startFrom = new Date();
            
            // Find the first matching day (Saturday or Sunday)
            const targetDayNum = day === 'Saturday' ? 6 : 0;
            while (startFrom.getDay() !== targetDayNum) {
                startFrom.setDate(startFrom.getDate() + 1);
            }
            
            // If the first date is in the past, move to next week
            if (startFrom < now) {
                startFrom.setDate(startFrom.getDate() + 7);
            }
            
            // Calculate end date (3 weeks from startFrom)
            const endDate = new Date(startFrom);
            endDate.setDate(endDate.getDate() + 21);
            
            // Generate date buttons
            let html = '';
            let currentDate = new Date(startFrom);
            let count = 0;
            let firstDateSelected = false;
            
            while (currentDate <= endDate && count < 5) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const label = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayLabel = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                const isSelected = !firstDateSelected;
                if (isSelected) {
                    firstDateSelected = true;
                    document.getElementById('shopifyStartDate').value = dateStr;
                }
                
                html += `
                    <button type="button" class="btn btn-sm shopify-date-btn ${isSelected ? 'selected' : ''}" 
                            onclick="selectShopifyDate('${dateStr}')"
                            style="background: ${isSelected ? '#39ff14' : 'rgba(57,255,20,0.2)'}; 
                                   border: 1px solid #39ff14; 
                                   color: ${isSelected ? '#000' : '#39ff14'}; 
                                   font-size: 11px;">
                        ${dayLabel}, ${label}
                    </button>
                `;
                
                currentDate.setDate(currentDate.getDate() + 7);
                count++;
            }
            
            container.innerHTML = html;
            generateShopifyListing();
        }
        
        function selectShopifyDate(dateStr) {
            document.getElementById('shopifyStartDate').value = dateStr;
            
            // Update button styles
            document.querySelectorAll('.shopify-date-btn').forEach(btn => {
                btn.style.background = 'rgba(57,255,20,0.2)';
                btn.style.color = '#39ff14';
                btn.classList.remove('selected');
            });
            event.target.style.background = '#39ff14';
            event.target.style.color = '#000';
            event.target.classList.add('selected');
            
            generateShopifyListing();
        }
        
        // ==================== END SLOT MANAGER FUNCTIONS ====================

        // ==================== ACCOUNT CREATION FUNCTIONS (SHOPIFY) ====================
        
        // Cloud Function URL for Shopify
        const SHOPIFY_FUNCTION_URL = 'https://us-central1-korean-ta-evaluator.cloudfunctions.net/getShopifyCustomersWithTag';
        
        // Global variables for account creation pagination
        let allShopifyCustomersForAccounts = [];
        let filteredShopifyCustomersForAccounts = [];
        let existingAccountEmails = new Set();
        let accountCurrentPage = 1;
        let accountPerPage = 25;

        // Get subscription status from tags (Inactive and Expired merged into Cancelled)
        function getSubscriptionStatus(tags) {
            if (!tags) return 'unknown';
            const tagLower = tags.toLowerCase();
            if (tagLower.includes('appstle_subscription_failed_payment') || tagLower.includes('appstle_subscription_dunning')) return 'failed';
            if (tagLower.includes('appstle_subscription_paused_customer')) return 'paused';
            if (tagLower.includes('appstle_subscription_inactive_customer')) return 'cancelled';
            if (tagLower.includes('appstle_subscription_cancelled_customer')) return 'cancelled';
            if (tagLower.includes('appstle_subscription_expired_customer')) return 'cancelled';
            if (tagLower.includes('appstle_subscription_active_customer')) return 'active';
            if (tagLower.includes('pronunciation')) return 'pronunciation';
            return 'unknown';
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'active': '#39ff14',
                'paused': '#ff9800',
                'failed': '#ff3366',
                'cancelled': '#e91e63',
                'pronunciation': '#9c27b0',
                'unknown': '#666'
            };
            return colors[status] || '#666';
        }

        // Get status label
        function getStatusLabel(status) {
            const labels = {
                'active': 'ACTIVE',
                'paused': 'PAUSED',
                'failed': 'FAILED PAYMENT',
                'cancelled': 'CANCELLED',
                'pronunciation': 'PRONUNCIATION',
                'unknown': 'UNKNOWN'
            };
            return labels[status] || 'UNKNOWN';
        }

        // Cache for Shopify customers
        let shopifyCustomersCache = null;
        let shopifyCustomersCacheTime = null;
        let shopifyCustomersCacheRange = null;

        async function loadShopifyCustomersForAccounts(forceRefresh = false) {
            const loadRange = document.getElementById('accountLoadRange').value;
            const listDiv = document.getElementById('accountCustomersList');
            
            // Check cache - use cached data if same range and less than 5 minutes old
            const cacheAge = shopifyCustomersCacheTime ? (Date.now() - shopifyCustomersCacheTime) / 1000 / 60 : Infinity;
            if (!forceRefresh && shopifyCustomersCache && shopifyCustomersCacheRange === loadRange && cacheAge < 5) {
                console.log('Using cached Shopify customers (age: ' + cacheAge.toFixed(1) + ' min)');
                allShopifyCustomersForAccounts = shopifyCustomersCache;
                filteredShopifyCustomersForAccounts = [...allShopifyCustomersForAccounts];
                accountCurrentPage = 1;
                
                document.getElementById('accountLoadControls').style.display = 'none';
                document.getElementById('accountRefreshBtn').style.display = 'inline-block';
                document.getElementById('accountControls').style.display = 'block';
                document.getElementById('accountPagination').style.display = 'block';
                
                updateAccountDashboard();
                renderShopifyCustomersForAccounts();
                updateAccountCacheStatus();
                return;
            }
            
            listDiv.innerHTML = '<p style="color: #00ffff; font-size: 13px;"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #00ffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Loading Shopify customers...</p>';
            
            document.getElementById('accountControls').style.display = 'none';
            document.getElementById('accountPagination').style.display = 'none';

            try {
                // First, get all existing Firebase accounts from 'users' collection
                const usersSnapshot = await db.collection('users').get();
                existingAccountEmails = new Set();
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.email) {
                        existingAccountEmails.add(userData.email.toLowerCase());
                    }
                });
                console.log('Found existing accounts:', existingAccountEmails.size);

                // Calculate date filter for Shopify API
                let createdAtMin = null;
                if (loadRange !== 'all') {
                    const days = parseInt(loadRange);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    createdAtMin = cutoffDate.toISOString();
                }

                // Fetch Shopify customers via Cloud Function with date filter
                // Request default_address to get location info
                const response = await fetch(SHOPIFY_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        data: {
                            updated_at_min: createdAtMin,
                            fields: 'id,email,first_name,last_name,phone,tags,created_at,updated_at,default_address,addresses'
                        }
                    })
                });

                const result = await response.json();
                const data = result.result;

                if (data.success && data.customers) {
                    allShopifyCustomersForAccounts = data.customers;
                    
                    // Sort by last name
                    allShopifyCustomersForAccounts.sort((a, b) => 
                        ((a.last_name || '') + (a.first_name || '')).localeCompare((b.last_name || '') + (b.first_name || ''))
                    );
                    
                    console.log('Loaded Shopify customers:', allShopifyCustomersForAccounts.length);

                    // Cache the results
                    shopifyCustomersCache = allShopifyCustomersForAccounts;
                    shopifyCustomersCacheTime = Date.now();
                    shopifyCustomersCacheRange = loadRange;

                    filteredShopifyCustomersForAccounts = [...allShopifyCustomersForAccounts];
                    accountCurrentPage = 1;
                    
                    document.getElementById('accountLoadControls').style.display = 'none';
                    document.getElementById('accountRefreshBtn').style.display = 'inline-block';
                    document.getElementById('accountControls').style.display = 'block';
                    document.getElementById('accountPagination').style.display = 'block';
                    
                    updateAccountDashboard();
                    renderShopifyCustomersForAccounts();
                    updateAccountCacheStatus();
                } else {
                    throw new Error(data.message || 'Failed to fetch customers');
                }

            } catch (error) {
                console.error('Error loading Shopify customers:', error);
                listDiv.innerHTML = `<p style="color: #ff3366; font-size: 13px;">Error: ${error.message}</p>`;
            }
        }

        function refreshShopifyCustomersForAccounts() {
            // Show load controls again so user can change range if needed
            document.getElementById('accountLoadControls').style.display = 'block';
            loadShopifyCustomersForAccounts(true);
        }

        function updateAccountCacheStatus() {
            const rangeLabels = {
                '7': 'Last 7 Days',
                '14': 'Last 14 Days',
                '30': 'Last 30 Days',
                '90': 'Last 3 Months',
                'all': 'All Time'
            };
            const rangeLabel = rangeLabels[shopifyCustomersCacheRange] || shopifyCustomersCacheRange;
            const loadedTime = shopifyCustomersCacheTime ? new Date(shopifyCustomersCacheTime).toLocaleTimeString() : '';
            
            document.getElementById('accountLastLoaded').innerHTML = `ðŸ“Š Showing: <strong>${rangeLabel}</strong> (${allShopifyCustomersForAccounts.length} customers) â€¢ Loaded at ${loadedTime}`;
        }

        function updateAccountDashboard() {
            const withAccount = allShopifyCustomersForAccounts.filter(c => existingAccountEmails.has((c.email || '').toLowerCase())).length;
            const withoutAccount = allShopifyCustomersForAccounts.length - withAccount;
            
            document.getElementById('statTotalCustomers').textContent = allShopifyCustomersForAccounts.length;
            document.getElementById('statWithAccount').textContent = withAccount;
            document.getElementById('statWithoutAccount').textContent = withoutAccount;
        }

        function filterShopifyCustomersForAccounts() {
            const searchTerm = document.getElementById('accountSearch').value.toLowerCase();
            const accountFilter = document.getElementById('accountFilter').value;
            const statusFilter = document.getElementById('accountStatusFilter').value;
            const tagFilter = document.getElementById('accountTagFilter').value;
            const dateFilter = document.getElementById('accountDateFilter').value;

            // Calculate date cutoff
            let dateCutoff = null;
            if (dateFilter !== 'all') {
                const days = parseInt(dateFilter);
                dateCutoff = new Date();
                dateCutoff.setDate(dateCutoff.getDate() - days);
            }

            filteredShopifyCustomersForAccounts = allShopifyCustomersForAccounts.filter(c => {
                const fullName = `${c.first_name || ''} ${c.last_name || ''}`.toLowerCase();
                const email = (c.email || '').toLowerCase();
                const matchesSearch = fullName.includes(searchTerm) || email.includes(searchTerm);
                
                const hasAccount = existingAccountEmails.has(email);
                let matchesAccountFilter = true;
                if (accountFilter === 'no-account') matchesAccountFilter = !hasAccount;
                if (accountFilter === 'has-account') matchesAccountFilter = hasAccount;

                // Subscription status filter
                let matchesStatusFilter = true;
                if (statusFilter !== 'all') {
                    const customerStatus = getSubscriptionStatus(c.tags);
                    matchesStatusFilter = customerStatus === statusFilter;
                }

                // Tag filter - check if customer has the selected tag
                let matchesTagFilter = true;
                if (tagFilter !== 'all') {
                    const customerTags = (c.tags || '').toUpperCase();
                    matchesTagFilter = customerTags.includes(tagFilter);
                }

                // Date filter (using updated_at from Shopify)
                let matchesDateFilter = true;
                if (dateCutoff && c.updated_at) {
                    const customerDate = new Date(c.updated_at);
                    matchesDateFilter = customerDate >= dateCutoff;
                }

                return matchesSearch && matchesAccountFilter && matchesStatusFilter && matchesTagFilter && matchesDateFilter;
            });

            accountCurrentPage = 1;
            renderShopifyCustomersForAccounts();
        }

        function changeAccountPerPage() {
            accountPerPage = parseInt(document.getElementById('accountPerPage').value);
            accountCurrentPage = 1;
            renderShopifyCustomersForAccounts();
        }

        function accountPrevPage() {
            if (accountCurrentPage > 1) {
                accountCurrentPage--;
                renderShopifyCustomersForAccounts();
            }
        }

        function accountNextPage() {
            const totalPages = Math.ceil(filteredShopifyCustomersForAccounts.length / accountPerPage);
            if (accountCurrentPage < totalPages) {
                accountCurrentPage++;
                renderShopifyCustomersForAccounts();
            }
        }

        function renderShopifyCustomersForAccounts() {
            const listDiv = document.getElementById('accountCustomersList');
            const totalPages = Math.ceil(filteredShopifyCustomersForAccounts.length / accountPerPage) || 1;
            const startIdx = (accountCurrentPage - 1) * accountPerPage;
            const endIdx = startIdx + accountPerPage;
            const pageCustomers = filteredShopifyCustomersForAccounts.slice(startIdx, endIdx);

            // Update pagination info
            document.getElementById('accountPageInfo').textContent = `Page ${accountCurrentPage} of ${totalPages} (${filteredShopifyCustomersForAccounts.length} customers)`;
            document.getElementById('accountPrevBtn').disabled = accountCurrentPage === 1;
            document.getElementById('accountNextBtn').disabled = accountCurrentPage === totalPages;

            if (pageCustomers.length === 0) {
                listDiv.innerHTML = '<p style="font-size: 13px; color: #888; grid-column: 1/-1;">No customers match your filter criteria.</p>';
                return;
            }

            let html = '';
            pageCustomers.forEach(c => {
                const hasAccount = existingAccountEmails.has((c.email || '').toLowerCase());
                const borderColor = hasAccount ? '#39ff14' : '#ff9800';
                const accountBadge = hasAccount 
                    ? '<span style="background: #39ff14; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">âœ… HAS ACCOUNT</span>'
                    : '<span style="background: #ff9800; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">âš ï¸ NO ACCOUNT</span>';
                
                // Subscription status
                const subStatus = getSubscriptionStatus(c.tags);
                const subColor = getStatusColor(subStatus);
                const subLabel = getStatusLabel(subStatus);
                const subBadge = `<span style="background: ${subColor}; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${subLabel}</span>`;
                
                const fullName = `${c.first_name || ''} ${c.last_name || ''}`.trim() || 'Unknown';
                
                // Get location from default_address or first address in addresses array
                let addr = c.default_address || null;
                if (!addr && c.addresses && c.addresses.length > 0) {
                    addr = c.addresses[0];
                }
                addr = addr || {};
                const city = addr.city || '';
                const state = addr.province || addr.province_code || '';
                const location = city && state ? `${city}, ${state}` : (city || state || 'N/A');
                
                // Get tags
                const tags = c.tags || '';
                const tagsList = tags.split(',').map(t => t.trim()).filter(t => t);
                const tagsDisplay = tagsList.length > 0 
                    ? tagsList.map(t => `<span style="background: rgba(255,0,255,0.3); color: #ff88ff; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 3px;">${t}</span>`).join('')
                    : '<span style="color: #666; font-size: 11px;">No tags</span>';
                
                // Format updated date
                const updatedDate = c.updated_at ? new Date(c.updated_at).toLocaleDateString() : 'N/A';
                
                // Buttons based on account status
                let actionButtons = '';
                if (hasAccount) {
                    // Has account - show Freeze and Delete buttons
                    actionButtons = `
                        <button class="btn btn-warning btn-sm" style="margin-top: 10px;" onclick="freezeCustomerAccount('${escapeHtmlForAcct(c.email || '')}', '${escapeHtmlForAcct(fullName)}')">
                            ðŸ”’ FREEZE
                        </button>
                        ${canDelete() ? `<button class="btn btn-danger btn-sm admin-delete-btn" style="margin-top: 10px; margin-left: 5px;" onclick="deleteCustomerAccount('${escapeHtmlForAcct(c.email || '')}', '${escapeHtmlForAcct(fullName)}')">
                            ðŸ—‘ï¸ DELETE
                        </button>` : ''}
                    `;
                } else {
                    // No account - show Create button (passing city, state, tags)
                    actionButtons = `
                        <button class="btn btn-success btn-sm" style="margin-top: 10px;" onclick="openCreateAccountModal('${c.id}', '${escapeHtmlForAcct(fullName)}', '${escapeHtmlForAcct(c.email || '')}', '${escapeHtmlForAcct(c.phone || '')}', '${escapeHtmlForAcct(city)}', '${escapeHtmlForAcct(state)}', '${escapeHtmlForAcct(tags)}')">
                            âž• CREATE ACCOUNT
                        </button>
                    `;
                }

                // Remove tag button (always shown)
                const removeTagBtn = `<button class="btn btn-info btn-sm" style="margin-top: 10px; margin-left: 5px;" onclick="removeCustomerTag('${c.id}', '${escapeHtmlForAcct(fullName)}')">
                    ðŸ·ï¸ REMOVE TAG
                </button>`;

                html += `
                    <div style="background: rgba(0,0,0,0.5); border: 2px solid ${borderColor}; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                            <span style="color: #00ffff; font-size: 14px;">${fullName}</span>
                            ${accountBadge}
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ðŸ“§ ${c.email || 'No email'}</div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ðŸ“ž ${c.phone || 'No phone'}</div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ðŸ“ ${location}</div>
                        <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Shopify ID: ${c.id}</div>
                        <div style="font-size: 11px; color: #888; margin-bottom: 8px;">ðŸ“… Updated: ${updatedDate}</div>
                        <div style="margin-bottom: 5px;">${subBadge}</div>
                        <div style="margin-bottom: 8px;">${tagsDisplay}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${actionButtons}
                            ${removeTagBtn}
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        function escapeHtmlForAcct(str) {
            if (!str) return '';
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function openCreateAccountModal(shopifyId, name, email, phone, city, state, tags) {
            document.getElementById('createAcctShopifyId').value = shopifyId;
            document.getElementById('createAcctName').value = name;
            document.getElementById('createAcctEmail').value = email;
            document.getElementById('createAcctPhone').value = phone || '';
            document.getElementById('createAcctCity').value = city || '';
            document.getElementById('createAcctState').value = state || '';
            document.getElementById('createAcctTags').value = tags || '';
            document.getElementById('createAcctPassword').value = '';
            document.getElementById('createAcctPasswordConfirm').value = '';
            document.getElementById('createAccountMessage').innerHTML = '';
            document.getElementById('submitCreateAcctBtn').disabled = false;
            document.getElementById('submitCreateAcctBtn').textContent = 'âœ… CREATE ACCOUNT';
            
            document.getElementById('createAccountModal').classList.add('active');
        }

        function closeCreateAccountModal() {
            document.getElementById('createAccountModal').classList.remove('active');
        }
        
        function generatePassword() {
            // Generate a random 8-character password with letters and numbers
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Fill both password fields
            document.getElementById('createAcctPassword').value = password;
            document.getElementById('createAcctPasswordConfirm').value = password;
        }

        async function submitCreateCustomerAccount() {
            const shopifyId = document.getElementById('createAcctShopifyId').value;
            const name = document.getElementById('createAcctName').value;
            const email = document.getElementById('createAcctEmail').value;
            const phone = document.getElementById('createAcctPhone').value;
            const city = document.getElementById('createAcctCity').value;
            const state = document.getElementById('createAcctState').value;
            const tags = document.getElementById('createAcctTags').value;
            const password = document.getElementById('createAcctPassword').value;
            const passwordConfirm = document.getElementById('createAcctPasswordConfirm').value;
            const messageDiv = document.getElementById('createAccountMessage');
            const btn = document.getElementById('submitCreateAcctBtn');

            // Validation
            if (!password || password.length < 6) {
                messageDiv.innerHTML = '<div style="background: rgba(255,51,102,0.2); border: 1px solid #ff3366; padding: 10px; border-radius: 5px; color: #ff3366; font-size: 12px; margin-bottom: 10px;">âš ï¸ Password must be at least 6 characters</div>';
                return;
            }

            if (password !== passwordConfirm) {
                messageDiv.innerHTML = '<div style="background: rgba(255,51,102,0.2); border: 1px solid #ff3366; padding: 10px; border-radius: 5px; color: #ff3366; font-size: 12px; margin-bottom: 10px;">âš ï¸ Passwords do not match</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creating...';
            messageDiv.innerHTML = '<div style="background: rgba(0,255,255,0.2); border: 1px solid #00ffff; padding: 10px; border-radius: 5px; color: #00ffff; font-size: 12px; margin-bottom: 10px;">â³ Creating account...</div>';

            try {
                // Use secondary auth to create account without logging out admin
                const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                
                // Sign out of secondary auth immediately
                await secondaryAuth.signOut();
                
                // Add to users collection with location and tags
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    displayName: name,
                    phoneNumber: phone || null,
                    city: city || null,
                    state: state || null,
                    shopifyTags: tags || null,
                    role: 'student',
                    shopifyCustomerId: shopifyId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local cache
                existingAccountEmails.add(email.toLowerCase());
                
                messageDiv.innerHTML = '<div style="background: rgba(57,255,20,0.2); border: 1px solid #39ff14; padding: 10px; border-radius: 5px; color: #39ff14; font-size: 12px; margin-bottom: 10px;">âœ… Account created successfully!</div>';
                
                // Close modal after delay and refresh
                setTimeout(() => {
                    closeCreateAccountModal();
                    updateAccountDashboard();
                    renderShopifyCustomersForAccounts();
                }, 1500);

            } catch (error) {
                console.error('Error creating account:', error);
                messageDiv.innerHTML = `<div style="background: rgba(255,51,102,0.2); border: 1px solid #ff3366; padding: 10px; border-radius: 5px; color: #ff3366; font-size: 12px; margin-bottom: 10px;">âŒ Error: ${error.message}</div>`;
                btn.disabled = false;
                btn.textContent = 'âœ… CREATE ACCOUNT';
            }
        }

        // Remove Tag Function - Opens Shopify admin to edit customer
        function removeCustomerTag(shopifyId, customerName) {
            if (confirm(`This will open Shopify admin to edit ${customerName}'s tags.\n\nYou'll need to manually remove the subscription tag from the customer.\n\nContinue?`)) {
                // Open Shopify admin customer page in new tab
                const shopifyAdminUrl = `https://admin.shopify.com/store/koreanlearnin/customers/${shopifyId}`;
                window.open(shopifyAdminUrl, '_blank');
            }
        }

        // Cloud Function URLs for account management
        const ACCOUNT_FUNCTIONS = {
            freezeStudentAccount: 'https://us-central1-korean-ta-evaluator.cloudfunctions.net/freezeStudentAccount',
            unfreezeStudentAccount: 'https://us-central1-korean-ta-evaluator.cloudfunctions.net/unfreezeStudentAccount',
            deleteStudentAccount: 'https://us-central1-korean-ta-evaluator.cloudfunctions.net/deleteStudentAccount'
        };

        // Freeze Customer Account
        async function freezeCustomerAccount(email, customerName) {
            if (!confirm(`Are you sure you want to FREEZE the account for ${customerName}?\n\nThis will disable their login.`)) {
                return;
            }

            try {
                const response = await fetch(ACCOUNT_FUNCTIONS.freezeStudentAccount, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { email: email } })
                });

                const result = await response.json();
                
                if (result.result && result.result.success) {
                    alert(`âœ… Account for ${customerName} has been frozen.`);
                } else {
                    throw new Error(result.result?.message || 'Failed to freeze account');
                }
            } catch (error) {
                console.error('Error freezing account:', error);
                alert(`âŒ Error: ${error.message}`);
            }
        }

        // Delete Customer Account
        async function deleteCustomerAccount(email, customerName) {
            if (!confirm(`âš ï¸ WARNING: Are you sure you want to DELETE the account for ${customerName}?\n\nThis action CANNOT be undone!`)) {
                return;
            }

            // Double confirmation
            if (!confirm(`FINAL CONFIRMATION:\n\nDelete account for ${customerName} (${email})?\n\nClick OK to permanently delete.`)) {
                return;
            }

            try {
                const response = await fetch(ACCOUNT_FUNCTIONS.deleteStudentAccount, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { email: email } })
                });

                const result = await response.json();
                
                if (result.result && result.result.success) {
                    // Remove from local cache
                    existingAccountEmails.delete(email.toLowerCase());
                    
                    alert(`âœ… Account for ${customerName} has been deleted.`);
                    
                    // Refresh the display
                    updateAccountDashboard();
                    renderShopifyCustomersForAccounts();
                } else {
                    throw new Error(result.result?.message || 'Failed to delete account');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert(`âŒ Error: ${error.message}`);
            }
        }

        // ==================== END ACCOUNT CREATION FUNCTIONS ====================

        // ==================== LIGHT/DARK MODE TOGGLE ====================
        function toggleLightMode() {
            const body = document.body;
            const toggle = document.getElementById('themeToggle');
            
            if (toggle.checked) {
                body.classList.remove('light-mode');
                localStorage.setItem('scheduler-theme', 'dark');
            } else {
                body.classList.add('light-mode');
                localStorage.setItem('scheduler-theme', 'light');
            }
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem('scheduler-theme');
            const toggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'light' && toggle) {
                document.body.classList.add('light-mode');
                toggle.checked = false;
            } else if (toggle) {
                document.body.classList.remove('light-mode');
                toggle.checked = true;
            }
        }
        // ==================== END LIGHT/DARK MODE TOGGLE ====================

        // ==================== STUDENT LOOKUP FUNCTIONS ====================
        let allLookupStudents = [];
        let openedFromStudentLookup = false; // Track if analytics was opened from student lookup
        
        async function openStudentLookupModal() {
            document.getElementById('studentLookupModal').classList.add('active');
            document.getElementById('studentLookupSearchInput').value = '';
            await loadAllStudentsForLookup();
        }
        
        function closeStudentLookupModal() {
            document.getElementById('studentLookupModal').classList.remove('active');
            openedFromStudentLookup = false;
        }
        
        async function loadAllStudentsForLookup() {
            const listContainer = document.getElementById('studentLookupList');
            listContainer.innerHTML = '<div class="student-lookup-empty"><p style="font-size: 36px; margin-bottom: 10px;">â³</p><p>Loading students...</p></div>';
            
            try {
                allLookupStudents = [];
                const seenEmails = new Set();
                
                // Load from users collection (all accounts)
                const usersSnap = await db.collection('users').where('role', '==', 'student').get();
                usersSnap.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.email && !seenEmails.has(data.email.toLowerCase())) {
                        seenEmails.add(data.email.toLowerCase());
                        allLookupStudents.push({
                            id: doc.id,
                            name: data.displayName || data.name || data.email,
                            email: data.email,
                            source: 'users',
                            createdAt: data.createdAt
                        });
                    }
                });
                
                // Load from scheduler_students collection
                const schedulerSnap = await db.collection('scheduler_students').get();
                schedulerSnap.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.email && !seenEmails.has(data.email.toLowerCase())) {
                        seenEmails.add(data.email.toLowerCase());
                        allLookupStudents.push({
                            id: doc.id,
                            name: data.name || data.email,
                            email: data.email,
                            source: 'scheduler',
                            createdAt: data.createdAt
                        });
                    } else if (data.email && seenEmails.has(data.email.toLowerCase())) {
                        // Mark existing entry as also in scheduler
                        const existing = allLookupStudents.find(s => s.email.toLowerCase() === data.email.toLowerCase());
                        if (existing) existing.source = 'both';
                    }
                });
                
                // Sort by name
                allLookupStudents.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                // Update stats
                const usersCount = allLookupStudents.filter(s => s.source === 'users' || s.source === 'both').length;
                const schedulerCount = allLookupStudents.filter(s => s.source === 'scheduler' || s.source === 'both').length;
                document.getElementById('studentLookupTotalCount').textContent = allLookupStudents.length;
                document.getElementById('studentLookupUsersCount').textContent = usersCount;
                document.getElementById('studentLookupSchedulerCount').textContent = schedulerCount;
                
                renderStudentLookupList(allLookupStudents);
                
            } catch (error) {
                console.error('Error loading students:', error);
                listContainer.innerHTML = '<div class="student-lookup-empty"><p style="color: #ff3366;">Error loading students</p></div>';
            }
        }
        
        function filterStudentLookup() {
            const searchTerm = document.getElementById('studentLookupSearchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderStudentLookupList(allLookupStudents);
                return;
            }
            
            const filtered = allLookupStudents.filter(s => 
                (s.name || '').toLowerCase().includes(searchTerm) ||
                (s.email || '').toLowerCase().includes(searchTerm)
            );
            
            renderStudentLookupList(filtered);
        }
        
        function renderStudentLookupList(students) {
            const listContainer = document.getElementById('studentLookupList');
            
            if (students.length === 0) {
                listContainer.innerHTML = '<div class="student-lookup-empty"><p style="font-size: 36px; margin-bottom: 10px;">ðŸ”</p><p>No students found</p></div>';
                return;
            }
            
            let html = '<div class="student-lookup-list">';
            students.forEach(student => {
                const sourceClass = student.source === 'both' ? 'users' : student.source;
                const sourceLabel = student.source === 'both' ? 'Account + Class' : (student.source === 'users' ? 'Account' : 'Class');
                html += `
                    <div class="student-lookup-item" onclick="openStudentAnalyticsFromLookup('${student.id}', '${(student.name || '').replace(/'/g, "\\'")}', '${(student.email || '').replace(/'/g, "\\'")}')">
                        <div class="student-lookup-item-info">
                            <div class="student-lookup-item-name">${student.name || 'Unknown'}</div>
                            <div class="student-lookup-item-email">${student.email || 'No email'}</div>
                        </div>
                        <span class="student-lookup-item-source ${sourceClass}">${sourceLabel}</span>
                    </div>
                `;
            });
            html += '</div>';
            listContainer.innerHTML = html;
        }
        
        function openStudentAnalyticsFromLookup(studentId, studentName, studentEmail) {
            openedFromStudentLookup = true; // Track that we came from student lookup
            closeStudentLookupModal();
            openStudentAnalyticsMenu(studentId, studentName, studentEmail);
            
            // Show back buttons after a small delay to ensure modal is open
            setTimeout(() => {
                const backBtn = document.getElementById('backToStudentLookupBtn');
                if (backBtn) backBtn.style.display = 'inline-block';
                const backBtnDisplay = document.getElementById('backToStudentLookupFromDisplayBtn');
                if (backBtnDisplay) backBtnDisplay.style.display = 'inline-block';
            }, 100);
        }
        
        function backToStudentLookup() {
            // Close all analytics modals
            document.getElementById('studentAnalyticsMenuModal').classList.remove('active');
            document.getElementById('analyticsDatePickerModal').classList.remove('active');
            document.getElementById('analyticsDisplayModal').classList.remove('active');
            
            // Hide back buttons
            const backBtn = document.getElementById('backToStudentLookupBtn');
            if (backBtn) backBtn.style.display = 'none';
            const backBtnDisplay = document.getElementById('backToStudentLookupFromDisplayBtn');
            if (backBtnDisplay) backBtnDisplay.style.display = 'none';
            
            // Reopen student lookup
            openedFromStudentLookup = false;
            openStudentLookupModal();
        }
        // ==================== END STUDENT LOOKUP FUNCTIONS ====================

        // ==================== SALES CHAT FUNCTIONS ====================
        let salesChats = [];
        let currentSalesChatId = null;
        let currentSalesSlot = null;
        let salesChatFilter = 'all';
        let salesChatProcessing = new Set();
        const SALES_FOX_IMAGE = 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Pixel_Fox_Character_remix_01k6575q5hfdc80wrh32w9qr8k.png?v=1766748246';
        
        let salesChatSettings = {
            firstMessageTemplate: 'ì•ˆë…•í•˜ì„¸ìš” {customerName}ë‹˜! This is {teacherName}, the Korean Teacher from TikTok! I have {seatsMessage} for {day}, {time} EST. Did you want to register for class?',
            defaultMaxSeats: 5,
            postSellMessage: '',
            agentName: 'Calvin',
            agentRole: 'Korean Teacher from TikTok',
            personalityTone: 'friendly',
            emojiLevel: 'moderate',
            responseLength: 'balanced',
            businessName: 'KoreanLearnin',
            businessWebsite: 'https://koreanlearnin.com',
            introCoursePrice: '$100',
            advancedProgramPrice: '$250/month',
            currentPromotion: ''
        };
        
        let salesKnowledgeBase = [];
        let salesTemplates = [];
        let salesObjectionHandlers = [];
        
        const SALES_AI_FUNCTION_URL = 'https://generateflashcardai-386010826708.us-central1.run.app';
        
        function escapeHtmlSales(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function initSalesChat() {
            await loadSalesChatSettings();
            await loadSalesKnowledgeBase();
            await loadSalesTemplates();
            await loadSalesObjectionHandlers();
            setupSalesChatListeners();
            renderSalesSuggestionsSidebar();
        }
        
        async function loadSalesChatSettings() {
            try {
                const doc = await db.collection('settings').doc('sales_chat').get();
                if (doc.exists) {
                    salesChatSettings = { ...salesChatSettings, ...doc.data() };
                }
            } catch (e) {
                console.error('Error loading sales settings:', e);
            }
        }
        
        async function loadSalesKnowledgeBase() {
            try {
                const snap = await db.collection('sales_knowledge').get();
                salesKnowledgeBase = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error loading knowledge base:', e);
            }
        }
        
        async function loadSalesTemplates() {
            try {
                const snap = await db.collection('sales_templates').get();
                salesTemplates = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error loading templates:', e);
            }
        }
        
        async function loadSalesObjectionHandlers() {
            try {
                const snap = await db.collection('sales_objections').get();
                salesObjectionHandlers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error loading objection handlers:', e);
            }
        }
        
        function setupSalesChatListeners() {
            db.collection('sales_chats').orderBy('updatedAt', 'desc').onSnapshot(snapshot => {
                salesChats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSalesChatList();
                updateSalesChatCounts();
            });
        }
        
        function updateSalesChatCounts() {
            const all = salesChats.filter(c => c.status !== 'closed').length;
            const red = salesChats.filter(c => c.urgency === 'red' && c.status !== 'closed').length;
            const yellow = salesChats.filter(c => c.urgency === 'yellow' && c.status !== 'closed').length;
            const grey = salesChats.filter(c => c.urgency === 'grey' && c.status !== 'closed').length;
            const downsell = salesChats.filter(c => c.downsellReady && c.status !== 'closed').length;
            
            document.getElementById('salesCountAll').textContent = all;
            document.getElementById('salesCountRed').textContent = red;
            document.getElementById('salesCountYellow').textContent = yellow;
            document.getElementById('salesCountGrey').textContent = grey;
            document.getElementById('salesCountDownsell').textContent = downsell;
        }
        
        function openSalesChatFromSlotModal() {
            if (!selectedSlotInfo?.prescheduled) {
                alert('No pre-scheduled slot selected.');
                return;
            }
            closeModal('slotDetailsModal');
            openSalesChatFromSlot(selectedSlotInfo.day, selectedSlotInfo.time, selectedSlotInfo.prescheduled);
        }
        
        function openSalesChatFromSlot(day, time, prescheduled) {
            currentSalesSlot = { day, time, prescheduled };
            currentSalesChatId = null;
            
            document.getElementById('salesChatModal').classList.add('active');
            updateSlotContextBanner(prescheduled);
            
            const slotChats = salesChats.filter(c => 
                c.slotDay === day && 
                c.slotTime === time && 
                c.prescheduledId === prescheduled?.id
            );
            
            if (slotChats.length > 0) {
                selectSalesChat(slotChats[0].id);
            } else {
                showSalesEmptyState();
            }
            
            renderSalesChatList();
            
            // Initialize sales chat if not already done
            if (salesChats.length === 0) {
                initSalesChat();
            }
        }
        
        function updateSlotContextBanner(prescheduled) {
            const banner = document.getElementById('salesSlotContext');
            if (!prescheduled || !currentSalesSlot) {
                banner.style.display = 'none';
                return;
            }
            
            banner.style.display = 'flex';
            
            const enrolledCount = prescheduled.enrolledStudents?.length || 0;
            const maxSeats = prescheduled.maxSeats || salesChatSettings.defaultMaxSeats || 5;
            const parsedStartDate = parseLocalDate(prescheduled.startDate);
            const startDate = parsedStartDate ? parsedStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'TBD';
            
            document.getElementById('salesSlotTitle').textContent = `${currentSalesSlot.day} @ ${currentSalesSlot.time} EST`;
            document.getElementById('salesSlotDetails').textContent = `${LEVELS[prescheduled.classType] || prescheduled.classType} â€¢ ${prescheduled.teacherName} â€¢ Starts ${startDate}`;
            
            const seatsContainer = document.getElementById('salesSlotSeats');
            let seatsHtml = '';
            for (let i = 0; i < maxSeats; i++) {
                seatsHtml += `<div class="sales-seat-dot ${i < enrolledCount ? 'filled' : 'empty'}"></div>`;
            }
            seatsHtml += `<span style="font-size: 11px; color: #aeb8de; margin-left: 8px;">${enrolledCount}/${maxSeats}</span>`;
            seatsContainer.innerHTML = seatsHtml;
            
            // Show/hide add to slot button
            const addBtn = document.getElementById('salesAddStudentBtn');
            if (addBtn) {
                addBtn.style.display = enrolledCount < maxSeats ? 'block' : 'none';
            }
        }
        
        function closeSalesChatModal() {
            document.getElementById('salesChatModal').classList.remove('active');
            currentSalesChatId = null;
            currentSalesSlot = null;
            renderSlotGrid();
        }
        
        function showSalesEmptyState() {
            document.getElementById('salesEmptyState').style.display = 'flex';
            document.getElementById('salesActiveChat').style.display = 'none';
            document.getElementById('salesNewChatInput').value = '';
        }
        
        function showSalesActiveChat() {
            document.getElementById('salesEmptyState').style.display = 'none';
            document.getElementById('salesActiveChat').style.display = 'flex';
        }
        
        function renderSalesChatList() {
            const listEl = document.getElementById('salesChatList');
            if (!listEl) return;
            
            let filteredChats = salesChats;
            if (currentSalesSlot?.prescheduled) {
                filteredChats = salesChats.filter(c => 
                    (c.slotDay === currentSalesSlot.day && c.slotTime === currentSalesSlot.time && c.prescheduledId === currentSalesSlot.prescheduled.id) ||
                    c.status !== 'closed'
                );
            }
            
            if (salesChatFilter === 'downsell') {
                filteredChats = filteredChats.filter(c => c.downsellReady && c.status !== 'closed');
            } else if (salesChatFilter !== 'all') {
                filteredChats = filteredChats.filter(c => c.urgency === salesChatFilter);
            }
            
            if (filteredChats.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-size: 12px;">No conversations yet</div>';
                return;
            }
            
            listEl.innerHTML = filteredChats.map(chat => {
                const initials = (chat.customerName || '?').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                const lastMsg = chat.messages?.[chat.messages.length - 1];
                const preview = lastMsg ? (lastMsg.content || '').substring(0, 60) + '...' : 'No messages';
                const isActive = chat.id === currentSalesChatId;
                const urgencyClass = chat.urgency ? `urgency-${chat.urgency}` : '';
                
                return `
                    <div class="sales-chat-card ${isActive ? 'active' : ''} ${urgencyClass}" onclick="selectSalesChat('${chat.id}')">
                        <div class="sales-chat-card-top">
                            <div class="sales-chat-card-avatar">${initials}</div>
                            <div class="sales-chat-card-info">
                                <div class="sales-chat-card-name">${escapeHtmlSales(chat.customerName || 'Unknown')}</div>
                                <div class="sales-chat-card-slot">${chat.slotDay || ''} @ ${chat.slotTime || ''}</div>
                            </div>
                        </div>
                        <div class="sales-chat-card-preview">${escapeHtmlSales(preview)}</div>
                        <div class="sales-chat-card-meta">
                            <span>${chat.messages?.length || 0} messages</span>
                            ${chat.urgency ? `<span class="sales-urgency-badge ${chat.urgency}">${getSalesUrgencyLabel(chat.urgency)}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getSalesUrgencyLabel(urgency) {
            const labels = { red: 'ðŸ”¥ Hot', yellow: 'ðŸ’› Warm', grey: 'â„ï¸ Cold' };
            return labels[urgency] || urgency;
        }
        
        function filterSalesChats(filter) {
            salesChatFilter = filter;
            document.querySelectorAll('.sales-filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });
            renderSalesChatList();
        }
        
        function selectSalesChat(chatId) {
            currentSalesChatId = chatId;
            const chat = salesChats.find(c => c.id === chatId);
            if (!chat) return;
            
            showSalesActiveChat();
            
            // Update header
            const initials = (chat.customerName || '?').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('salesChatAvatar').textContent = initials;
            document.getElementById('salesChatName').textContent = chat.customerName || 'Unknown';
            document.getElementById('salesChatDetails').innerHTML = `<span>ðŸ“ ${chat.state || 'Unknown'}</span><span>ðŸŽ¯ ${chat.reason || 'Unknown'}</span>`;
            
            // Render messages
            renderSalesMessages(chat.messages || []);
            renderSalesChatList();
        }
        
        function renderSalesMessages(messages) {
            const container = document.getElementById('salesMessagesContainer');
            container.innerHTML = messages.map(msg => {
                const roleClass = msg.role === 'customer' ? 'customer' : (msg.role === 'ai' ? 'ai' : 'admin');
                const label = msg.role === 'customer' ? 'Customer' : (msg.role === 'ai' ? 'âœ¨ AI Suggestion' : 'ðŸ“¤ You sent');
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
                
                return `
                    <div class="sales-message ${roleClass}">
                        <div class="sales-message-label">${label}</div>
                        <div class="sales-message-bubble" ${msg.role === 'ai' ? `onclick="copySalesAIMessage(this)"` : ''}>${escapeHtmlSales(msg.content)}</div>
                        <div class="sales-message-time">${time}</div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function copySalesAIMessage(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                element.style.background = 'rgba(57,255,20,0.3)';
                setTimeout(() => {
                    element.style.background = '';
                }, 500);
            });
        }
        
        async function createSalesChatFromMessage() {
            const message = document.getElementById('salesNewChatInput').value.trim();
            if (!message) return;
            
            if (!currentSalesSlot?.prescheduled) {
                alert('Please select a slot first.');
                return;
            }
            
            try {
                const ps = currentSalesSlot.prescheduled;
                const chatData = {
                    customerName: extractNameFromMessage(message) || 'New Lead',
                    slotDay: currentSalesSlot.day,
                    slotTime: currentSalesSlot.time,
                    prescheduledId: ps.id,
                    classType: ps.classType,
                    teacherName: ps.teacherName,
                    messages: [{
                        role: 'customer',
                        content: message,
                        timestamp: new Date().toISOString()
                    }],
                    urgency: 'yellow',
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('sales_chats').add(chatData);
                currentSalesChatId = docRef.id;
                
                // Generate AI response
                await generateSalesAIResponse(docRef.id, message);
                
            } catch (e) {
                console.error('Error creating chat:', e);
                alert('Error: ' + e.message);
            }
        }
        
        function extractNameFromMessage(message) {
            const patterns = [
                /(?:i'm|i am|my name is|this is|hey,? i'm)\s+([A-Z][a-z]+)/i,
                /^([A-Z][a-z]+)\s+here/i
            ];
            for (const pattern of patterns) {
                const match = message.match(pattern);
                if (match) return match[1];
            }
            return null;
        }
        
        async function sendSalesMessage() {
            const message = document.getElementById('salesMessageInput').value.trim();
            if (!message || !currentSalesChatId) return;
            
            const chat = salesChats.find(c => c.id === currentSalesChatId);
            if (!chat) return;
            
            try {
                const messages = [...(chat.messages || []), {
                    role: 'customer',
                    content: message,
                    timestamp: new Date().toISOString()
                }];
                
                await db.collection('sales_chats').doc(currentSalesChatId).update({
                    messages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('salesMessageInput').value = '';
                
                // Generate AI response
                await generateSalesAIResponse(currentSalesChatId, message);
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function generateSalesAIResponse(chatId, customerMessage) {
            if (salesChatProcessing.has(chatId)) return;
            salesChatProcessing.add(chatId);
            
            const chat = salesChats.find(c => c.id === chatId);
            if (!chat) {
                salesChatProcessing.delete(chatId);
                return;
            }
            
            try {
                // Build context
                const ps = currentSalesSlot?.prescheduled;
                const enrolledCount = ps?.enrolledStudents?.length || 0;
                const maxSeats = ps?.maxSeats || salesChatSettings.defaultMaxSeats || 5;
                const seatsLeft = maxSeats - enrolledCount;
                
                const systemPrompt = buildSalesSystemPrompt(chat, ps, seatsLeft);
                const conversationHistory = (chat.messages || []).map(m => ({
                    role: m.role === 'customer' ? 'user' : 'assistant',
                    content: m.content
                }));
                
                const response = await fetch(SALES_AI_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...conversationHistory
                        ],
                        model: 'gpt-4o-mini',
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                const data = await response.json();
                const aiMessage = data.choices?.[0]?.message?.content || getFallbackResponse(chat.messages || []);
                
                // Add AI response to chat
                const updatedMessages = [...(chat.messages || []), {
                    role: 'ai',
                    content: aiMessage,
                    timestamp: new Date().toISOString()
                }];
                
                // Determine urgency based on message content
                const urgency = determineUrgency(customerMessage);
                
                await db.collection('sales_chats').doc(chatId).update({
                    messages: updatedMessages,
                    urgency,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (e) {
                console.error('Error generating AI response:', e);
            } finally {
                salesChatProcessing.delete(chatId);
            }
        }
        
        function buildSalesSystemPrompt(chat, ps, seatsLeft) {
            const settings = salesChatSettings;
            return `You are ${settings.agentName}, a ${settings.agentRole} for ${settings.businessName}.

Your personality: ${settings.personalityTone}
Emoji usage: ${settings.emojiLevel}
Response length: ${settings.responseLength}

CURRENT SLOT INFO:
- Day/Time: ${chat.slotDay} @ ${chat.slotTime} EST
- Class Type: ${LEVELS[chat.classType] || chat.classType}
- Teacher: ${chat.teacherName}
- Seats Left: ${seatsLeft}
- Start Date: ${ps?.startDate ? parseLocalDate(ps.startDate).toLocaleDateString() : 'TBD'}

PRICING:
- Intro Course: ${settings.introCoursePrice}
- Advanced Program: ${settings.advancedProgramPrice}
${settings.currentPromotion ? `- Current Promo: ${settings.currentPromotion}` : ''}

GOAL: Help convert this lead into a registered student. Be helpful, address concerns, and guide them toward registration.

Keep responses concise and conversational. Don't be too pushy.`;
        }
        
        function determineUrgency(message) {
            const lower = message.toLowerCase();
            const hotKeywords = ['sign up', 'register', 'enroll', 'ready', 'let\'s do it', 'i\'m in'];
            const coldKeywords = ['not interested', 'too expensive', 'maybe later', 'no thanks'];
            
            if (hotKeywords.some(k => lower.includes(k))) return 'red';
            if (coldKeywords.some(k => lower.includes(k))) return 'grey';
            return 'yellow';
        }
        
        function getFallbackResponse(messages) {
            const lastMsg = messages[messages.length - 1]?.content.toLowerCase() || '';
            
            if (lastMsg.includes('price') || lastMsg.includes('cost')) {
                return "Great question! ðŸ’° Our 6-Week Intro Course is $100 total - that's less than $17/week! Would you like me to save you a spot?";
            }
            if (lastMsg.includes('schedule') || lastMsg.includes('time') || lastMsg.includes('when')) {
                return "ðŸ“… Our classes run Saturdays and Sundays from 6:30-11:10 PM EST. Each class is 40 minutes. What time works best for you?";
            }
            if (lastMsg.includes('sign up') || lastMsg.includes('register')) {
                return "Amazing! ðŸŽ‰ I'm so excited you're ready to start! What's the best email to send the registration link?";
            }
            return "Thanks for your interest! ðŸŒŸ Would you like to know more about our programs, or are you ready to get started?";
        }
        
        async function addStudentToSlotFromChat() {
            if (!currentSalesChatId || !currentSalesSlot?.prescheduled) {
                alert('No active chat or slot.');
                return;
            }
            
            const chat = salesChats.find(c => c.id === currentSalesChatId);
            if (!chat) return;
            
            const studentName = chat.customerName || 'Unknown Student';
            
            if (!confirm(`Add "${studentName}" to ${currentSalesSlot.day} @ ${currentSalesSlot.time}?`)) return;
            
            try {
                const ps = currentSalesSlot.prescheduled;
                const students = ps.enrolledStudents || [];
                
                students.push({
                    name: studentName,
                    chatId: currentSalesChatId,
                    enrolledAt: new Date().toISOString()
                });
                
                await db.collection('prescheduled_slots').doc(ps.id).update({
                    enrolledStudents: students
                });
                
                // Update local cache
                const idx = allPrescheduledSlots.findIndex(p => p.id === ps.id);
                if (idx !== -1) {
                    allPrescheduledSlots[idx].enrolledStudents = students;
                }
                
                // Mark chat as closed
                await db.collection('sales_chats').doc(currentSalesChatId).update({
                    status: 'closed',
                    closedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`âœ… ${studentName} has been added to ${currentSalesSlot.day} @ ${currentSalesSlot.time}!`);
                updateSlotContextBanner(ps);
                renderSalesChatList();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        function startNewSalesChat() {
            currentSalesChatId = null;
            showSalesEmptyState();
            renderSalesChatList();
        }
        
        async function deleteSalesChat() {
            if (!currentSalesChatId) return;
            if (!confirm('Delete this conversation?')) return;
            
            try {
                await db.collection('sales_chats').doc(currentSalesChatId).delete();
                currentSalesChatId = null;
                showSalesEmptyState();
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        function openSalesAddResponseModal() {
            if (!currentSalesChatId) return;
            document.getElementById('salesAddResponseModal').classList.add('active');
            document.getElementById('salesAdminResponseInput').value = '';
        }
        
        function closeSalesAddResponseModal() {
            document.getElementById('salesAddResponseModal').classList.remove('active');
        }
        
        async function saveSalesAdminResponse() {
            const message = document.getElementById('salesAdminResponseInput')?.value.trim();
            if (!message || !currentSalesChatId) return;
            
            try {
                const chat = salesChats.find(c => c.id === currentSalesChatId);
                if (!chat) return;
                
                const messages = [...(chat.messages || []), {
                    role: 'admin',
                    content: message,
                    timestamp: new Date().toISOString()
                }];
                
                await db.collection('sales_chats').doc(currentSalesChatId).update({
                    messages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeSalesAddResponseModal();
            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        }
        
        function generateSalesSummary() {
            if (!currentSalesChatId) return;
            const chat = salesChats.find(c => c.id === currentSalesChatId);
            if (!chat) return;
            
            const truncate = (str, len) => str && str.length > len ? str.substring(0, len) + '...' : str;
            
            const summary = `ðŸ“‹ CUSTOMER SUMMARY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ‘¤ Name: ${chat.customerName || 'Unknown'}
ðŸ“ Location: ${chat.state || 'Unknown'}
ðŸŽ¯ Interest: ${chat.reason || 'Unknown'}

ðŸ“Š Status: ${getSalesUrgencyLabel(chat.urgency).toUpperCase()}
ðŸ’¬ Messages: ${chat.messages?.length || 0}
ðŸ“… Slot: ${chat.slotDay} @ ${chat.slotTime}

ðŸ“ RECENT MESSAGES:
${chat.messages?.slice(-4).map(m => `â€¢ ${m.role === 'customer' ? 'Customer' : 'Us'}: "${truncate(m.content, 50)}"`).join('\n') || 'None'}`;
            
            document.getElementById('salesSummaryContent').textContent = summary;
            document.getElementById('salesSummaryModal').classList.add('active');
        }
        
        function copySalesSummary() {
            const summary = document.getElementById('salesSummaryContent').textContent;
            navigator.clipboard.writeText(summary).then(() => alert('Copied!'));
        }
        
        // Settings functions
        function openSalesSettingsModal() {
            populateSalesSettingsForm();
            document.getElementById('salesSettingsModal').classList.add('active');
        }
        
        function populateSalesSettingsForm() {
            document.getElementById('salesSettingTemplate').value = salesChatSettings.firstMessageTemplate || '';
            document.getElementById('salesSettingMaxSeats').value = salesChatSettings.defaultMaxSeats || 5;
            document.getElementById('salesSettingPostSellMessage').value = salesChatSettings.postSellMessage || '';
            document.getElementById('salesSettingAgentName').value = salesChatSettings.agentName || 'Calvin';
            document.getElementById('salesSettingAgentRole').value = salesChatSettings.agentRole || '';
            document.getElementById('salesSettingTone').value = salesChatSettings.personalityTone || 'friendly';
            document.getElementById('salesSettingEmojiLevel').value = salesChatSettings.emojiLevel || 'moderate';
            document.getElementById('salesSettingResponseLength').value = salesChatSettings.responseLength || 'balanced';
            document.getElementById('salesSettingBusinessName').value = salesChatSettings.businessName || '';
            document.getElementById('salesSettingWebsite').value = salesChatSettings.businessWebsite || '';
            document.getElementById('salesSettingIntroPrice').value = salesChatSettings.introCoursePrice || '';
            document.getElementById('salesSettingAdvancedPrice').value = salesChatSettings.advancedProgramPrice || '';
            document.getElementById('salesSettingPromotion').value = salesChatSettings.currentPromotion || '';
        }
        
        async function saveSalesChatSettings() {
            salesChatSettings.firstMessageTemplate = document.getElementById('salesSettingTemplate').value.trim();
            salesChatSettings.defaultMaxSeats = parseInt(document.getElementById('salesSettingMaxSeats').value) || 5;
            salesChatSettings.postSellMessage = document.getElementById('salesSettingPostSellMessage').value.trim();
            salesChatSettings.agentName = document.getElementById('salesSettingAgentName').value.trim() || 'Calvin';
            salesChatSettings.agentRole = document.getElementById('salesSettingAgentRole').value.trim();
            salesChatSettings.personalityTone = document.getElementById('salesSettingTone').value;
            salesChatSettings.emojiLevel = document.getElementById('salesSettingEmojiLevel').value;
            salesChatSettings.responseLength = document.getElementById('salesSettingResponseLength').value;
            salesChatSettings.businessName = document.getElementById('salesSettingBusinessName').value.trim();
            salesChatSettings.businessWebsite = document.getElementById('salesSettingWebsite').value.trim();
            salesChatSettings.introCoursePrice = document.getElementById('salesSettingIntroPrice').value.trim();
            salesChatSettings.advancedProgramPrice = document.getElementById('salesSettingAdvancedPrice').value.trim();
            salesChatSettings.currentPromotion = document.getElementById('salesSettingPromotion').value.trim();
            
            try {
                await db.collection('settings').doc('sales_chat').set(salesChatSettings, { merge: true });
                alert('âœ… Settings saved!');
                closeModal('salesSettingsModal');
            } catch (e) {
                console.error('Error:', e);
                alert('Error saving settings: ' + e.message);
            }
        }
        
        function switchSalesSettingsTab(tab) {
            document.querySelectorAll('.sales-settings-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sales-settings-panel').forEach(p => p.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('salesSettings' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }
        
        // Suggestions sidebar
        const defaultSuggestions = [
            { id: 'obj-1', type: 'objection', title: 'Too Expensive', content: "I understand budget is important! The $100 intro course is less than $17/week for 6 weeks of live instruction. That's cheaper than most apps, and you get real feedback! ðŸŽ¯" },
            { id: 'obj-2', type: 'objection', title: 'No Time', content: "Our classes are only 40 minutes on weekends! We have slots from 6:30 PM to 11:10 PM EST on Saturdays and Sundays. What time works best for you? ðŸ“…" },
            { id: 'obj-3', type: 'objection', title: 'Not Ready', content: "That's totally okay! Our beginner course starts from zero - we'll teach you Hangul first. Many of our students had no prior experience! ðŸ˜Š" },
            { id: 'tmp-1', type: 'template', title: 'Welcome', content: "ì•ˆë…•í•˜ì„¸ìš”! This is {agentName}, the Korean Teacher from TikTok! ðŸŽ® Thanks for reaching out! What made you interested in learning Korean?" },
            { id: 'tmp-2', type: 'template', title: 'Class Info', content: "Our 6-week intro course is {introPrice} total! Classes are Saturdays and Sundays, 40 minutes each. Small groups of 5-10 students. ðŸ“š" },
            { id: 'cls-1', type: 'closing', title: 'Ready to Start', content: "Perfect! I'll save your spot right now! ðŸŽ‰ Here's what happens next: I'll send you a registration link, and you'll get Discord access. Sound good?" },
            { id: 'cls-2', type: 'closing', title: 'Limited Seats', content: "Just a heads up - we only have a few spots left for this time! ðŸ”¥ Want me to hold one for you?" }
        ];
        
        function renderSalesSuggestionsSidebar() {
            const objections = defaultSuggestions.filter(s => s.type === 'objection');
            const templates = defaultSuggestions.filter(s => s.type === 'template');
            const closings = defaultSuggestions.filter(s => s.type === 'closing');
            
            document.getElementById('salesObjectionHandlersList').innerHTML = objections.map(s => renderSuggestionCard(s)).join('');
            document.getElementById('salesTemplatesList2').innerHTML = templates.map(s => renderSuggestionCard(s)).join('');
            document.getElementById('salesClosingScriptsList').innerHTML = closings.map(s => renderSuggestionCard(s)).join('');
        }
        
        function renderSuggestionCard(s) {
            return `
                <div class="sales-suggestion-card ${s.type}" onclick="copySuggestionToClipboard('${s.id}', event)">
                    <div class="sales-suggestion-card-header">
                        <div class="sales-suggestion-card-title">${escapeHtmlSales(s.title)}</div>
                    </div>
                    <div class="sales-suggestion-card-preview">${escapeHtmlSales(s.content.substring(0, 80))}...</div>
                </div>
            `;
        }
        
        function copySuggestionToClipboard(id, event) {
            event.stopPropagation();
            const suggestion = defaultSuggestions.find(s => s.id === id);
            if (!suggestion) return;
            
            let content = suggestion.content;
            content = content.replace(/{agentName}/g, salesChatSettings.agentName || 'Calvin');
            content = content.replace(/{introPrice}/g, salesChatSettings.introCoursePrice || '$100');
            
            navigator.clipboard.writeText(content).then(() => {
                const card = event.currentTarget;
                card.classList.add('copied');
                setTimeout(() => card.classList.remove('copied'), 500);
            });
        }
        
        function filterSalesSuggestions() {
            const term = document.getElementById('salesSuggestionSearch').value.toLowerCase();
            document.querySelectorAll('.sales-suggestion-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }
        
        function filterSuggestionsByTag(tag) {
            document.querySelectorAll('.sales-filter-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.sales-suggestion-section').forEach(section => {
                if (tag === 'all') {
                    section.style.display = 'block';
                } else {
                    section.style.display = section.dataset.category === tag ? 'block' : 'none';
                }
            });
        }
        
        function quickAddSuggestion(type) {
            alert('Custom suggestion editor coming soon!');
        }
        
        function insertQuickLink(type) {
            const links = {
                registration: salesChatSettings.businessWebsite || 'https://koreanlearnin.com/register',
                discord: 'https://discord.gg/koreanlearnin',
                promo: salesChatSettings.currentPromotion || ''
            };
            navigator.clipboard.writeText(links[type] || '').then(() => alert('Link copied!'));
        }
        
        // Google Voice
        let googleVoiceWindow = null;
        
        function toggleGoogleVoicePanel() {
            const panel = document.getElementById('salesVoicePanel');
            const expandBtn = document.getElementById('salesVoiceExpandBtn');
            
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                expandBtn.style.display = 'none';
            } else {
                panel.classList.add('collapsed');
                expandBtn.style.display = 'block';
            }
        }
        
        function openGoogleVoiceWindow() {
            if (googleVoiceWindow && !googleVoiceWindow.closed) {
                googleVoiceWindow.focus();
                return;
            }
            googleVoiceWindow = window.open('https://voice.google.com/u/0/messages', 'GoogleVoice', 'width=500,height=700');
        }
        
        // Feedback and drag overlay
        function openSalesFeedbackPanel() {
            document.getElementById('salesFeedbackPanel').classList.add('open');
        }
        
        function closeSalesFeedbackPanel() {
            document.getElementById('salesFeedbackPanel').classList.remove('open');
        }
        
        function openSalesDragOverlay() {
            const overlay = document.getElementById('salesDragOverlay');
            overlay.classList.add('active');
            
            const hot = salesChats.filter(c => c.urgency === 'red' && c.status !== 'closed').length;
            const warm = salesChats.filter(c => c.urgency === 'yellow' && c.status !== 'closed').length;
            const cold = salesChats.filter(c => c.urgency === 'grey' && c.status !== 'closed').length;
            
            document.getElementById('salesDragHotCount').textContent = hot;
            document.getElementById('salesDragWarmCount').textContent = warm;
            document.getElementById('salesDragColdCount').textContent = cold;
            
            const grid = document.getElementById('salesDragGrid');
            grid.innerHTML = salesChats.filter(c => c.status !== 'closed').map(chat => {
                const initials = (chat.customerName || '?').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                return `
                    <div class="sales-drag-overlay-card urgency-${chat.urgency || 'yellow'}" onclick="selectChatFromDrag('${chat.id}')">
                        <div class="sales-drag-overlay-avatar">${initials}</div>
                        <div class="sales-drag-overlay-name">${escapeHtmlSales(chat.customerName || 'Unknown')}</div>
                        <div class="sales-drag-overlay-meta">${chat.slotDay} @ ${chat.slotTime}</div>
                    </div>
                `;
            }).join('');
        }
        
        function closeSalesDragOverlay() {
            document.getElementById('salesDragOverlay').classList.remove('active');
        }
        
        function selectChatFromDrag(chatId) {
            closeSalesDragOverlay();
            selectSalesChat(chatId);
        }
        
        function analyzeSalesConversation() {
            alert('AI conversation analysis coming soon!');
        }
        
        function loadSalesFeedbackChat() {
            // Placeholder
        }
        // ==================== END SALES CHAT FUNCTIONS ====================

        // Init
        document.addEventListener('DOMContentLoaded', () => { 
            loadThemePreference();
            renderAvailabilityGrid();
            
            // Add event listener for split timezone select
            const splitTimezoneSelect = document.getElementById('splitTimezoneSelect');
            if (splitTimezoneSelect) {
                splitTimezoneSelect.addEventListener('change', renderAvailabilityGrid);
            }
            
            // Add event listener for manual timezone select
            const studentTimezone = document.getElementById('studentTimezone');
            if (studentTimezone) {
                studentTimezone.addEventListener('change', renderAvailabilityGrid);
            }
        });
    </script>
</body>
</html>
